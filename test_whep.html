<!DOCTYPE html>
<html>
 <head>
   <meta charset="UTF-8" />
   <meta name="viewport" content="width=device-width, initial-scale=1.0" />
   <title>Web Player</title>
 </head>
 <body style="height: 100%; margin:0 auto;">
   <button onclick="javascript:play();">play</button>
   <video id="video-box" style="background-color:#ccc" autoplay></video>
   </div>
   <p id="localsdp"></p>
 </body>
 <script>
   let pc = new RTCPeerConnection();
   const dc = pc.createDataChannel("whatever", {reliable: false});
   dc.onopen = onDCStateChange;
   dc.onclose = onDCStateChange;

   function onDCStateChange() {
       console.log('dc state changed to ' + dc.readyState);
   }

   function play() {
       pc.addEventListener('track', (e) => {
           let remoteVideo = document.getElementById('video-box');
           if (remoteVideo.srcObject !== e.streams[0]) {
               remoteVideo.srcObject = e.streams[0];
               console.log('pc received remote stream:', e);
           }
       });

       pc.createOffer({offerToReceiveAudio: true, offerToReceiveVideo: true })
           .then((offer) => {
               console.log(offer);
               document.getElementById("localsdp").innerHTML = offer.sdp.replaceAll('\r\n', '<br>');
               return pc.setLocalDescription(offer);
           })
           .then(() => {
               let req = new XMLHttpRequest();
               req.open('POST', 'http://183.131.160.209:19306/whep', true);
               req.setRequestHeader("Content-type","application/sdp");
               req.send(pc.localDescription.sdp);
               req.onreadystatechange = function () {
                   if (req.readyState == 4 && req.status == 200) {
                       var sdp = req.responseText;
                       pc.setRemoteDescription({sdp:sdp, type:"answer"});
                   }
               };
           })
           .catch((reason) => {
               console.error(reason);
           });

           // TODO

           document.addEventListener('keydown', (event) => {
               // Check which key was pressed
               switch (event.key) {
                   case 'ArrowUp':
                   case 'ArrowDown':
                   case 'ArrowLeft':
                   case 'ArrowRight':
                   case ' ':
                       // Send the key event via the DataChannel
                       console.log("dc state: " + dc.readyState)
                       dc.send(JSON.stringify({ type: 'keydown', key: event.key }));
                       break;
                   default:
                       // Handle other key presses
                       console.log(`Key pressed: ${event.key}`);
                       break;
               }
           });

           document.addEventListener('keyup', (event) => {
               // Check which key was released
               switch (event.key) {
                   case 'ArrowUp':
                   case 'ArrowDown':
                   case 'ArrowLeft':
                   case 'ArrowRight':
                   case ' ':
                       // Send the key event via the DataChannel
                       console.log("dc state: " + dc.readyState)
                       dc.send(JSON.stringify({ type: 'keyup', key: event.key }));
                       break;
                   default:
                       // Handle other key releases
                       console.log(`Key released: ${event.key}`);
                       break;
               }
           });
   }
 </script>
</html>
