<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WebRTC PCDN çº§è”ç›´æ’­ç³»ç»Ÿ</title>
<style>
:root { --bg: #0f0f1a; --panel: #161625; --border: #252540; --accent: #e94560; --accent2: #0f9; --text: #eee; --muted: #888; }
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; }

/* Header */
.header { text-align: center; padding: 16px; background: var(--panel); border-bottom: 2px solid var(--border); }
.header h1 { font-size: 22px; color: var(--accent); }
.header p { font-size: 13px; color: var(--muted); margin-top: 2px; }

/* Tabs */
.tabs { display: flex; justify-content: center; gap: 0; background: var(--panel); border-bottom: 1px solid var(--border); }
.tab { padding: 12px 24px; cursor: pointer; font-size: 14px; color: var(--muted); border-bottom: 2px solid transparent; transition: all 0.2s; }
.tab:hover { color: var(--text); }
.tab.active { color: var(--accent); border-bottom-color: var(--accent); }
.tab-content { display: none; }
.tab-content.active { display: block; }

/* Layout */
.container { display: flex; gap: 16px; padding: 16px; max-width: 1600px; margin: 0 auto; }
.container.col { flex-direction: column; }
.panel { background: var(--panel); border-radius: 10px; padding: 16px; flex: 1; border: 1px solid var(--border); }
.panel h2 { font-size: 16px; margin-bottom: 12px; color: var(--accent); }
.panel h3 { font-size: 14px; margin: 12px 0 8px; color: var(--muted); }

/* Form elements */
.btn { padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600; transition: all 0.2s; }
.btn-sm { padding: 5px 10px; font-size: 12px; }
.btn-primary { background: var(--accent); color: #fff; }
.btn-primary:hover { background: #c73652; }
.btn-primary:disabled { background: #444; cursor: not-allowed; }
.btn-secondary { background: #2a2a4a; color: var(--text); border: 1px solid var(--border); }
.btn-secondary:hover { background: #353560; }
.btn-danger { background: #c0392b; color: #fff; }
.btn-danger:hover { background: #a93226; }
.btn-success { background: #27ae60; color: #fff; }
.btn-success:hover { background: #219a52; }
.btn-warn { background: #e67e22; color: #fff; }
input[type="text"], input[type="password"], select {
  padding: 8px 12px; border-radius: 6px; border: 1px solid var(--border);
  background: var(--bg); color: var(--text); font-size: 13px; width: 100%;
}
select { cursor: pointer; }
.form-row { display: flex; gap: 8px; align-items: center; margin-bottom: 8px; }
.form-row label { font-size: 12px; color: var(--muted); min-width: 80px; white-space: nowrap; }
.form-row input, .form-row select { flex: 1; }
.controls { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; margin-bottom: 12px; }
</style>
</head>
<body>

<div class="header">
  <h1>ğŸŒ WebRTC PCDN çº§è”ç›´æ’­ç³»ç»Ÿ</h1>
  <p>å•ä¸»æ’­ + å¤šè§‚ä¼— Â· æ ‘çŠ¶çº§è”åˆ†å‘ Â· P2PåŠ é€Ÿ</p>
</div>

<!-- Additional styles -->
<style>
/* Collapsible */
.collapsible-header { cursor: pointer; display: flex; align-items: center; gap: 6px; font-size: 13px; color: var(--muted); margin: 8px 0; user-select: none; }
.collapsible-header:hover { color: var(--text); }
.collapsible-header::before { content: 'â–¶'; font-size: 10px; transition: transform 0.2s; }
.collapsible-header.open::before { transform: rotate(90deg); }
.collapsible-body { display: none; padding: 8px 0; }
.collapsible-body.open { display: block; }

/* Video */
video { width: 100%; border-radius: 6px; background: #000; }
#localVideo { max-width: 480px; margin-top: 8px; }
.screen-share-banner { background: var(--accent); color: #fff; padding: 6px 12px; border-radius: 6px; font-size: 12px; display: none; margin: 8px 0; }

/* Status badges */
.status { font-size: 12px; color: var(--muted); margin: 8px 0; }
.status span { color: var(--accent); font-weight: 600; }
.badge { display: inline-block; padding: 2px 8px; border-radius: 10px; font-size: 11px; font-weight: 600; }
.badge-green { background: #1a3a2a; color: #0f9; }
.badge-yellow { background: #3a3a1a; color: #ff0; }
.badge-red { background: #3a1a1a; color: #f33; }
.badge-blue { background: #1a2a3a; color: #39f; }

/* ICE status */
.ice-status { display: flex; gap: 6px; flex-wrap: wrap; margin: 8px 0; }
.ice-badge { padding: 4px 10px; border-radius: 12px; font-size: 11px; display: flex; align-items: center; gap: 4px; }
.ice-badge .dot { width: 6px; height: 6px; border-radius: 50%; }

/* Reconnecting overlay */
.reconnecting-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; border-radius: 8px; color: #ff0; font-size: 13px; display: none; }

/* Room list */
.room-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 12px; }
.room-card { background: var(--bg); border: 1px solid var(--border); border-radius: 8px; padding: 14px; cursor: pointer; transition: all 0.2s; }
.room-card:hover { border-color: var(--accent); }
.room-card .room-title { font-size: 15px; font-weight: 600; margin-bottom: 6px; }
.room-card .room-meta { font-size: 12px; color: var(--muted); }

/* Chat */
.chat-panel { display: flex; flex-direction: column; height: 400px; }
.chat-messages { flex: 1; overflow-y: auto; padding: 8px; background: var(--bg); border-radius: 6px; margin-bottom: 8px; }
.chat-msg { margin-bottom: 6px; font-size: 13px; }
.chat-msg .nick { color: var(--accent); font-weight: 600; }
.chat-msg .time { color: var(--muted); font-size: 11px; margin-left: 6px; }
.chat-input-row { display: flex; gap: 6px; }
.chat-input-row input { flex: 1; }
.emoji-bar { display: flex; gap: 4px; margin-bottom: 6px; }
.emoji-btn { background: none; border: 1px solid var(--border); border-radius: 6px; padding: 4px 8px; cursor: pointer; font-size: 16px; transition: all 0.15s; }
.emoji-btn:hover { background: var(--border); transform: scale(1.2); }

/* Danmaku */
.danmaku-container { position: absolute; top: 0; left: 0; right: 0; bottom: 40px; overflow: hidden; pointer-events: none; }
.danmaku { position: absolute; white-space: nowrap; font-size: 16px; font-weight: 600; color: #fff; text-shadow: 1px 1px 2px rgba(0,0,0,0.8); animation: danmaku-scroll 6s linear forwards; }
@keyframes danmaku-scroll { from { transform: translateX(100%); } to { transform: translateX(-100%); } }

/* Topology canvas */
#topoCanvas { width: 100%; height: 400px; background: var(--bg); border-radius: 6px; border: 1px solid var(--border); }
.topo-legend { display: flex; gap: 16px; margin-top: 8px; font-size: 12px; color: var(--muted); }
.topo-legend-item { display: flex; align-items: center; gap: 4px; }
.topo-legend-dot { width: 10px; height: 10px; border-radius: 50%; }

/* Stats bar */
.stats-bar { display: flex; gap: 20px; padding: 10px 16px; background: var(--panel); border-bottom: 1px solid var(--border); justify-content: center; flex-wrap: wrap; }
.stat-item { font-size: 13px; color: var(--muted); }
.stat-item span { color: var(--accent2); font-weight: 600; }

/* Log */
.log-panel { max-height: 180px; overflow-y: auto; }
#logArea { font-family: monospace; font-size: 11px; color: var(--muted); }
.log-entry { margin-bottom: 1px; }
.log-entry.info { color: var(--accent2); }
.log-entry.warn { color: #f90; }
.log-entry.error { color: #f33; }

/* Reactions float */
.reaction-float { position: fixed; bottom: 100px; right: 30px; pointer-events: none; }
.reaction-anim { position: absolute; bottom: 0; font-size: 28px; animation: float-up 2s ease-out forwards; }
@keyframes float-up { 0% { opacity: 1; transform: translateY(0) scale(1); } 100% { opacity: 0; transform: translateY(-120px) scale(1.5); } }

/* Node detail popup */
.node-detail { position: fixed; background: var(--panel); border: 1px solid var(--border); border-radius: 8px; padding: 14px; min-width: 240px; z-index: 100; box-shadow: 0 8px 32px rgba(0,0,0,0.5); display: none; }
.node-detail h4 { color: var(--accent); margin-bottom: 8px; font-size: 14px; }
.node-detail .detail-row { font-size: 12px; color: var(--muted); margin-bottom: 4px; }
.node-detail .detail-row span { color: var(--text); }

/* ========== Mobile Responsive ========== */
@media (max-width: 768px) {
  .header h1 { font-size: 17px; }
  .header p { font-size: 11px; }
  .header { padding: 10px; }

  .tabs { gap: 0; overflow-x: auto; justify-content: flex-start; -webkit-overflow-scrolling: touch; }
  .tab { padding: 10px 14px; font-size: 13px; white-space: nowrap; flex-shrink: 0; }

  .stats-bar { gap: 10px; padding: 8px 10px; flex-wrap: wrap; }
  .stat-item { font-size: 11px; }

  .container { flex-direction: column; padding: 8px; gap: 8px; }
  .container.col { padding: 8px; gap: 8px; }

  .panel { padding: 12px; border-radius: 8px; }
  .panel h2 { font-size: 14px; margin-bottom: 8px; }

  .form-row { flex-direction: column; align-items: stretch; gap: 4px; }
  .form-row label { min-width: unset; font-size: 11px; }
  .form-row input, .form-row select { font-size: 14px; padding: 10px 12px; }

  .btn { padding: 10px 16px; font-size: 14px; width: 100%; }
  .btn-sm { padding: 8px 12px; font-size: 12px; width: auto; }

  .controls { gap: 6px; }
  .controls select { width: 80px !important; font-size: 12px; }

  #localVideo { max-width: 100%; }
  #remoteVideo { max-width: 100% !important; }

  .chat-panel { height: 300px; }
  .chat-messages { font-size: 12px; }
  .chat-input-row input { font-size: 14px; padding: 10px; }
  .emoji-bar { flex-wrap: wrap; }
  .emoji-btn { padding: 6px 10px; font-size: 18px; }

  .room-list { grid-template-columns: 1fr; }
  .room-card { padding: 12px; }

  .ice-status { gap: 4px; }
  .ice-badge { font-size: 10px; padding: 3px 8px; }

  #topoCanvas { height: 280px; }
  .topo-legend { flex-wrap: wrap; gap: 8px; font-size: 11px; }

  .node-detail { min-width: 200px; max-width: 80vw; }

  .log-panel { max-height: 400px; }
  #logArea { font-size: 10px; }

  .collapsible-header { font-size: 12px; }
}

@media (max-width: 480px) {
  .header h1 { font-size: 15px; }
  .tab { padding: 8px 10px; font-size: 12px; }
  .panel { padding: 10px; }
  .controls { flex-direction: column; align-items: stretch; }
  .controls select { width: 100% !important; }
  .controls .btn-sm { width: 100%; }
}
</style>

<!-- Stats Bar -->
<div class="stats-bar" id="statsBar" style="display:none">
  <div class="stat-item">ğŸ‘¥ åœ¨çº¿è§‚ä¼—: <span id="statViewers">0</span></div>
  <div class="stat-item">ğŸŒ³ æ ‘æ·±åº¦: <span id="statDepth">0</span></div>
  <div class="stat-item">ğŸ’¾ å¸¦å®½èŠ‚çœ: <span id="statSaved">0%</span></div>
  <div class="stat-item">ğŸ“¡ ä¸»æ’­ä¸Šè¡Œ: <span id="statPcdn">0</span> è·¯</div>
</div>

<!-- Tabs -->
<div class="tabs">
  <div class="tab active" onclick="switchTab('lobby')">ğŸ  å¤§å…</div>
  <div class="tab" onclick="switchTab('live')">ğŸ“º ç›´æ’­</div>
  <div class="tab" onclick="switchTab('topology')">ğŸŒ³ æ‹“æ‰‘</div>
  <div class="tab" onclick="switchTab('log')">ğŸ“‹ æ—¥å¿—</div>
</div>

<!-- TAB: Lobby -->
<div class="tab-content active" id="tab-lobby">
  <div class="container col">
    <div class="panel">
      <h2>ğŸ“º æ­£åœ¨ç›´æ’­çš„æˆ¿é—´</h2>
      <div class="room-list" id="roomList"><div style="color:var(--muted);font-size:13px">æš‚æ— ç›´æ’­æˆ¿é—´</div></div>
    </div>
    <div class="container" style="padding:0">
      <div class="panel">
        <h2>ğŸ¥ åˆ›å»ºç›´æ’­</h2>
        <div class="form-row"><label>æˆ¿é—´å·</label><input type="text" id="roomIdInput" value="room1"></div>
        <div class="form-row"><label>æˆ¿é—´æ ‡é¢˜</label><input type="text" id="roomTitle" placeholder="æˆ‘çš„ç›´æ’­é—´"></div>
        <div class="form-row"><label>æˆ¿é—´å¯†ç </label><input type="password" id="roomPassword" placeholder="å¯é€‰"></div>
        <div class="form-row"><label>æ˜µç§°</label><input type="text" id="pubNickname" value="ä¸»æ’­"></div>
        <button class="btn btn-primary" id="btnPublish" onclick="startPublish()">ğŸ¥ å¼€å§‹ç›´æ’­</button>
      </div>
      <div class="panel">
        <h2>ğŸ‘€ åŠ å…¥è§‚çœ‹</h2>
        <div class="form-row"><label>æˆ¿é—´å·</label><input type="text" id="joinRoomInput" value="room1"></div>
        <div class="form-row"><label>å¯†ç </label><input type="password" id="joinPassword" placeholder="å¦‚éœ€è¦"></div>
        <div class="form-row"><label>æ˜µç§°</label><input type="text" id="viewerNickname" placeholder="è§‚ä¼—"></div>
        <button class="btn btn-primary" id="btnJoin" onclick="joinAsViewer()">ğŸ‘€ åŠ å…¥è§‚çœ‹</button>
      </div>
    </div>
    <!-- Network Settings (collapsible) -->
    <div class="panel">
      <div class="collapsible-header" onclick="toggleCollapsible(this)">âš™ï¸ ç½‘ç»œè®¾ç½® (STUN/TURN)</div>
      <div class="collapsible-body" id="networkSettings">
        <div class="form-row"><label>STUN æœåŠ¡å™¨</label><input type="text" id="stunInput" value="stun:stun.l.google.com:19302" placeholder="stun:host:port"></div>
        <div class="form-row"><label>TURN åœ°å€</label><input type="text" id="turnUrl" placeholder="turn:host:3478"></div>
        <div class="form-row"><label>TURN ç”¨æˆ·å</label><input type="text" id="turnUser" placeholder="username"></div>
        <div class="form-row"><label>TURN å¯†ç </label><input type="password" id="turnPass" placeholder="password"></div>
        <div class="form-row">
          <label>TURN å›é€€</label>
          <select id="turnFallback"><option value="auto">è‡ªåŠ¨ (P2På¤±è´¥æ—¶ä½¿ç”¨TURN)</option><option value="always">å§‹ç»ˆä½¿ç”¨TURN</option><option value="never">ä»…P2P</option></select>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- TAB: Live -->
<div class="tab-content" id="tab-live">
  <div class="container">
    <!-- Left: Video area -->
    <div class="panel" style="flex:2; position:relative;">
      <div id="publisherArea" style="display:none">
        <h2>ğŸ¥ ä¸»æ’­ç«¯</h2>
        <div class="controls">
          <button class="btn btn-danger btn-sm" onclick="stopPublish()">åœæ­¢ç›´æ’­</button>
          <button class="btn btn-secondary btn-sm" id="btnScreenShare" onclick="toggleScreenShare()">ğŸ–¥ï¸ å…±äº«å±å¹•</button>
          <select id="resolutionSelect" onchange="changeResolution()" style="width:100px">
            <option value="auto">è‡ªåŠ¨</option>
            <option value="720">720p</option>
            <option value="1080">1080p</option>
          </select>
          <select id="fpsSelect" onchange="changeResolution()" style="width:80px">
            <option value="30">30fps</option>
            <option value="15">15fps</option>
          </select>
        </div>
        <div class="screen-share-banner" id="screenShareBanner">ğŸ–¥ï¸ æ­£åœ¨å…±äº«å±å¹• <button class="btn btn-sm btn-danger" onclick="stopScreenShare()">åœæ­¢å…±äº«</button></div>
        <div class="status" id="publisherStatus"></div>
        <h3>ğŸ“¡ å­èŠ‚ç‚¹è¿æ¥çŠ¶æ€</h3>
        <div class="ice-status" id="hostIceStatus"><span style="color:var(--muted);font-size:12px">æš‚æ— å­èŠ‚ç‚¹</span></div>
        <video id="localVideo" autoplay muted playsinline></video>
      </div>
      <div id="viewerArea" style="display:none">
        <h2>ğŸ‘€ è§‚çœ‹ä¸­</h2>
        <div class="controls">
          <button class="btn btn-danger btn-sm" onclick="leaveRoom()">ç¦»å¼€æˆ¿é—´</button>
          <button class="btn btn-success btn-sm" id="btnUnmute" onclick="unmuteVideo()">ğŸ”Š å¼€å¯å£°éŸ³</button>
        </div>
        <div class="status" id="viewerStatus"></div>
        <div class="ice-status" id="iceStatus"></div>
        <div style="position:relative">
          <video id="remoteVideo" autoplay muted playsinline webkit-playsinline style="width:100%;max-width:640px;border-radius:6px;background:#000"></video>
          <div class="danmaku-container" id="danmakuContainer"></div>
        </div>
        <div class="label" id="remoteVideoLabel" style="font-size:11px;color:var(--muted);margin-top:4px"></div>
        <div class="reconnecting-overlay" id="reconnectOverlay">ğŸ”„ æ­£åœ¨é‡æ–°è¿æ¥...</div>
      </div>
      <div id="noLiveArea">
        <p style="color:var(--muted);text-align:center;padding:40px">è¯·å…ˆåœ¨å¤§å…åˆ›å»ºæˆ–åŠ å…¥ç›´æ’­</p>
      </div>
    </div>

    <!-- Right: Chat -->
    <div class="panel" style="flex:1; min-width: 280px;">
      <h2>ğŸ’¬ èŠå¤©</h2>
      <div class="chat-panel">
        <div class="chat-messages" id="chatMessages"></div>
        <div class="emoji-bar">
          <button class="emoji-btn" onclick="sendReaction('ğŸ‘')">ğŸ‘</button>
          <button class="emoji-btn" onclick="sendReaction('â¤ï¸')">â¤ï¸</button>
          <button class="emoji-btn" onclick="sendReaction('ğŸ‰')">ğŸ‰</button>
          <button class="emoji-btn" onclick="sendReaction('ğŸ˜‚')">ğŸ˜‚</button>
          <button class="emoji-btn" onclick="sendReaction('ğŸ”¥')">ğŸ”¥</button>
        </div>
        <div class="chat-input-row">
          <input type="text" id="chatInput" placeholder="å‘é€æ¶ˆæ¯..." onkeydown="if(event.key==='Enter')sendChat()">
          <button class="btn btn-primary btn-sm" onclick="sendChat()">å‘é€</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- TAB: Topology -->
<div class="tab-content" id="tab-topology">
  <div class="container col">
    <div class="panel">
      <h2>ğŸŒ³ ç½‘ç»œæ‹“æ‰‘å¯è§†åŒ–</h2>
      <canvas id="topoCanvas"></canvas>
      <div class="topo-legend">
        <div class="topo-legend-item"><div class="topo-legend-dot" style="background:#e94560"></div> ä¸»æ’­</div>
        <div class="topo-legend-item"><div class="topo-legend-dot" style="background:#27ae60"></div> ä¸­ç»§èŠ‚ç‚¹</div>
        <div class="topo-legend-item"><div class="topo-legend-dot" style="background:#3498db"></div> è§‚ä¼—</div>
        <div class="topo-legend-item"><div class="topo-legend-dot" style="background:#555"></div> ç¦»çº¿</div>
        <div class="topo-legend-item"><div class="topo-legend-dot" style="background:transparent;border:1px dashed #f90"></div> å¤‡ç”¨è¿æ¥</div>
      </div>
    </div>
    <div class="node-detail" id="nodeDetail">
      <h4 id="nodeDetailTitle">èŠ‚ç‚¹è¯¦æƒ…</h4>
      <div id="nodeDetailBody"></div>
    </div>
  </div>
</div>

<!-- TAB: Log -->
<div class="tab-content" id="tab-log">
  <div class="container col">
    <div class="panel log-panel" style="max-height:600px">
      <h2>ğŸ“‹ ç³»ç»Ÿæ—¥å¿—</h2>
      <div id="logArea"></div>
    </div>
  </div>
</div>

<!-- Reaction floats -->
<div class="reaction-float" id="reactionFloat"></div>

<script src="/socket.io.min.js"></script>
<script src="/app.js"></script>
</body>
</html>
