var G3=Object.defineProperty;var W3=(Qt,gt,ge)=>gt in Qt?G3(Qt,gt,{enumerable:!0,configurable:!0,writable:!0,value:ge}):Qt[gt]=ge;var rS=(Qt,gt,ge)=>(W3(Qt,typeof gt!="symbol"?gt+"":gt,ge),ge);const H3=function(){const gt=document.createElement("link").relList;if(gt&&gt.supports&&gt.supports("modulepreload"))return;for(const Dt of document.querySelectorAll('link[rel="modulepreload"]'))Ut(Dt);new MutationObserver(Dt=>{for(const Pt of Dt)if(Pt.type==="childList")for(const wi of Pt.addedNodes)wi.tagName==="LINK"&&wi.rel==="modulepreload"&&Ut(wi)}).observe(document,{childList:!0,subtree:!0});function ge(Dt){const Pt={};return Dt.integrity&&(Pt.integrity=Dt.integrity),Dt.referrerpolicy&&(Pt.referrerPolicy=Dt.referrerpolicy),Dt.crossorigin==="use-credentials"?Pt.credentials="include":Dt.crossorigin==="anonymous"?Pt.credentials="omit":Pt.credentials="same-origin",Pt}function Ut(Dt){if(Dt.ep)return;Dt.ep=!0;const Pt=ge(Dt);fetch(Dt.href,Pt)}};H3();var Fl=typeof globalThis!="undefined"?globalThis:typeof window!="undefined"?window:typeof global!="undefined"?global:typeof self!="undefined"?self:{};function K3(Qt){return Qt&&Qt.__esModule&&Object.prototype.hasOwnProperty.call(Qt,"default")?Qt.default:Qt}var aP={exports:{}};(function(Qt,gt){(function(ge,Ut){Qt.exports=Ut()})(Fl,function(){function ge(t,e){return e.forEach(function(n){n&&typeof n!="string"&&!Array.isArray(n)&&Object.keys(n).forEach(function(i){if(i!=="default"&&!(i in t)){var r=Object.getOwnPropertyDescriptor(n,i);Object.defineProperty(t,i,r.get?r:{enumerable:!0,get:function(){return n[i]}})}})}),Object.freeze(t)}var Ut=typeof globalThis!="undefined"?globalThis:typeof window!="undefined"?window:typeof Fl!="undefined"?Fl:typeof self!="undefined"?self:{};function Dt(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}var Pt=function(t){try{return!!t()}catch{return!0}},wi=!Pt(function(){var t=function(){}.bind();return typeof t!="function"||t.hasOwnProperty("prototype")}),ma=wi,vr=Function.prototype,bs=vr.call,Hl=ma&&vr.bind.bind(bs,bs),Ge=ma?Hl:function(t){return function(){return bs.apply(t,arguments)}},Jn=Ge({}.isPrototypeOf),uc=function(t){return t&&t.Math==Math&&t},Lt=uc(typeof globalThis=="object"&&globalThis)||uc(typeof window=="object"&&window)||uc(typeof self=="object"&&self)||uc(typeof Ut=="object"&&Ut)||function(){return this}()||Ut||Function("return this")(),_e=wi,Zo=Function.prototype,ce=Zo.apply,Kl=Zo.call,lc=typeof Reflect=="object"&&Reflect.apply||(_e?Kl.bind(ce):function(){return Kl.apply(ce,arguments)}),$o=Ge,ql=$o({}.toString),i_=$o("".slice),I=function(t){return i_(ql(t),8,-1)},Wd=I,Sn=Ge,ga=function(t){if(Wd(t)==="Function")return Sn(t)},Hd=typeof document=="object"&&document.all,hc={all:Hd,IS_HTMLDDA:Hd===void 0&&Hd!==void 0},tn=hc.all,pn=hc.IS_HTMLDDA?function(t){return typeof t=="function"||t===tn}:function(t){return typeof t=="function"},Ta={},Vi=!Pt(function(){return Object.defineProperty({},1,{get:function(){return 7}})[1]!=7}),Zr=wi,As=Function.prototype.call,cn=Zr?As.bind(As):function(){return As.apply(As,arguments)},Sa={},Kd={}.propertyIsEnumerable,qd=Object.getOwnPropertyDescriptor,Yd=qd&&!Kd.call({1:2},1);Sa.f=Yd?function(t){var e=qd(this,t);return!!e&&e.enumerable}:Kd;var $r,pc,Ro=function(t,e){return{enumerable:!(1&t),configurable:!(2&t),writable:!(4&t),value:e}},r_=Pt,o_=I,fc=Object,yr=Ge("".split),_c=r_(function(){return!fc("z").propertyIsEnumerable(0)})?function(t){return o_(t)=="String"?yr(t,""):fc(t)}:fc,dr=function(t){return t==null},Ec=dr,Yl=TypeError,ws=function(t){if(Ec(t))throw Yl("Can't call method on "+t);return t},zd=_c,mc=ws,li=function(t){return zd(mc(t))},zl=pn,s_=hc.all,Oi=hc.IS_HTMLDDA?function(t){return typeof t=="object"?t!==null:zl(t)||t===s_}:function(t){return typeof t=="object"?t!==null:zl(t)},Bn={},ts=Bn,es=Lt,jt=pn,Ri=function(t){return jt(t)?t:void 0},Ci=function(t,e){return arguments.length<2?Ri(ts[t])||Ri(es[t]):ts[t]&&ts[t][e]||es[t]&&es[t][e]},ns=typeof navigator!="undefined"&&String(navigator.userAgent)||"",Jl=Lt,gc=ns,Jd=Jl.process,Os=Jl.Deno,Ir=Jd&&Jd.versions||Os&&Os.version,Co=Ir&&Ir.v8;Co&&(pc=($r=Co.split("."))[0]>0&&$r[0]<4?1:+($r[0]+$r[1])),!pc&&gc&&(!($r=gc.match(/Edge\/(\d+)/))||$r[1]>=74)&&($r=gc.match(/Chrome\/(\d+)/))&&(pc=+$r[1]);var Yi=pc,Xl=Yi,Tc=Pt,Ql=Lt.String,is=!!Object.getOwnPropertySymbols&&!Tc(function(){var t=Symbol();return!Ql(t)||!(Object(t)instanceof Symbol)||!Symbol.sham&&Xl&&Xl<41}),Zl=is&&!Symbol.sham&&typeof Symbol.iterator=="symbol",Ns=Ci,Ra=pn,$l=Jn,th=Object,hi=Zl?function(t){return typeof t=="symbol"}:function(t){var e=Ns("Symbol");return Ra(e)&&$l(e.prototype,th(t))},Ni=String,vo=function(t){try{return Ni(t)}catch{return"Object"}},a_=pn,eh=vo,nh=TypeError,ii=function(t){if(a_(t))return t;throw nh(eh(t)+" is not a function")},Ds=ii,Xd=dr,rs=function(t,e){var n=t[e];return Xd(n)?void 0:Ds(n)},Qd=cn,Zd=pn,$d=Oi,ih=TypeError,rh={exports:{}},oh=Lt,sh=Object.defineProperty,c_=function(t,e){try{sh(oh,t,{value:e,configurable:!0,writable:!0})}catch{oh[t]=e}return e},os="__core-js_shared__",Sc=Lt[os]||c_(os,{}),Rc=Sc;(rh.exports=function(t,e){return Rc[t]||(Rc[t]=e!==void 0?e:{})})("versions",[]).push({version:"3.31.1",mode:"pure",copyright:"\xA9 2014-2023 Denis Pushkarev (zloirock.ru)",license:"https://github.com/zloirock/core-js/blob/v3.31.1/LICENSE",source:"https://github.com/zloirock/core-js"});var yo=rh.exports,Cc=ws,ah=Object,br=function(t){return ah(Cc(t))},Ca=br,ch=Ge({}.hasOwnProperty),Dn=Object.hasOwn||function(t,e){return ch(Ca(t),e)},dh=Ge,uh=0,d_=Math.random(),tu=dh(1 .toString),eu=function(t){return"Symbol("+(t===void 0?"":t)+")_"+tu(++uh+d_,36)},u_=yo,nu=Dn,lh=eu,iu=is,hh=Zl,Xn=Lt.Symbol,Io=u_("wks"),vc=hh?Xn.for||Xn:Xn&&Xn.withoutSetter||lh,Ze=function(t){return nu(Io,t)||(Io[t]=iu&&nu(Xn,t)?Xn[t]:vc("Symbol."+t)),Io[t]},l_=cn,yc=Oi,ru=hi,Ic=rs,ph=function(t,e){var n,i;if(e==="string"&&Zd(n=t.toString)&&!$d(i=Qd(n,t))||Zd(n=t.valueOf)&&!$d(i=Qd(n,t))||e!=="string"&&Zd(n=t.toString)&&!$d(i=Qd(n,t)))return i;throw ih("Can't convert object to primitive value")},h_=TypeError,p_=Ze("toPrimitive"),ur=function(t,e){if(!yc(t)||ru(t))return t;var n,i=Ic(t,p_);if(i){if(e===void 0&&(e="default"),n=l_(i,t,e),!yc(n)||ru(n))return n;throw h_("Can't convert object to primitive value")}return e===void 0&&(e="number"),ph(t,e)},fh=hi,bo=function(t){var e=ur(t,"string");return fh(e)?e:e+""},_h=Oi,ou=Lt.document,ss=_h(ou)&&_h(ou.createElement),to=function(t){return ss?ou.createElement(t):{}},su=to,Eh=!Vi&&!Pt(function(){return Object.defineProperty(su("div"),"a",{get:function(){return 7}}).a!=7}),va=Vi,mh=cn,au=Sa,gh=Ro,Th=li,f_=bo,Sh=Dn,__=Eh,Rh=Object.getOwnPropertyDescriptor;Ta.f=va?Rh:function(t,e){if(t=Th(t),e=f_(e),__)try{return Rh(t,e)}catch{}if(Sh(t,e))return gh(!mh(au.f,t,e),t[e])};var cu=Pt,E_=pn,m_=/#|\.prototype\./,ya=function(t,e){var n=T_[g_(t)];return n==R_||n!=S_&&(E_(e)?cu(e):!!e)},g_=ya.normalize=function(t){return String(t).replace(m_,".").toLowerCase()},T_=ya.data={},S_=ya.NATIVE="N",R_=ya.POLYFILL="P",du=ya,uu=ii,Ch=wi,lu=ga(ga.bind),eo=function(t,e){return uu(t),e===void 0?t:Ch?lu(t,e):function(){return t.apply(e,arguments)}},Fi={},bc=Vi&&Pt(function(){return Object.defineProperty(function(){},"prototype",{value:42,writable:!1}).prototype!=42}),C_=Oi,v_=String,y_=TypeError,Gn=function(t){if(C_(t))return t;throw y_(v_(t)+" is not an object")},vh=Vi,hu=Eh,I_=bc,Ac=Gn,yh=bo,h=TypeError,_=Object.defineProperty,S=Object.getOwnPropertyDescriptor,v="enumerable",w="configurable",O="writable";Fi.f=vh?I_?function(t,e,n){if(Ac(t),e=yh(e),Ac(n),typeof t=="function"&&e==="prototype"&&"value"in n&&O in n&&!n[O]){var i=S(t,e);i&&i[O]&&(t[e]=n.value,n={configurable:w in n?n[w]:i[w],enumerable:v in n?n[v]:i[v],writable:!1})}return _(t,e,n)}:_:function(t,e,n){if(Ac(t),e=yh(e),Ac(n),hu)try{return _(t,e,n)}catch{}if("get"in n||"set"in n)throw h("Accessors not supported");return"value"in n&&(t[e]=n.value),t};var P=Fi,j=Ro,F=Vi?function(t,e,n){return P.f(t,e,j(1,n))}:function(t,e,n){return t[e]=n,t},q=Lt,rt=lc,dt=ga,$=pn,St=Ta.f,ie=du,Ce=Bn,Te=eo,Pn=F,Wn=Dn,Ar=function(t){var e=function(n,i,r){if(this instanceof e){switch(arguments.length){case 0:return new t;case 1:return new t(n);case 2:return new t(n,i)}return new t(n,i,r)}return rt(t,this,arguments)};return e.prototype=t.prototype,e},$t=function(t,e){var n,i,r,o,s,a,c,d,u,l=t.target,p=t.global,f=t.stat,C=t.proto,m=p?q:f?q[l]:(q[l]||{}).prototype,g=p?Ce:Ce[l]||Pn(Ce,l,{})[l],y=g.prototype;for(o in e)i=!(n=ie(p?o:l+(f?".":"#")+o,t.forced))&&m&&Wn(m,o),a=g[o],i&&(c=t.dontCallGetSet?(u=St(m,o))&&u.value:m[o]),s=i&&c?c:e[o],i&&typeof a==typeof s||(d=t.bind&&i?Te(s,q):t.wrap&&i?Ar(s):C&&$(s)?dt(s):s,(t.sham||s&&s.sham||a&&a.sham)&&Pn(d,"sham",!0),Pn(g,o,d),C&&(Wn(Ce,r=l+"Prototype")||Pn(Ce,r,{}),Pn(Ce[r],o,s),t.real&&y&&(n||!y[o])&&Pn(y,o,s)))},Le=Math.ceil,as=Math.floor,xe=Math.trunc||function(t){var e=+t;return(e>0?as:Le)(e)},Ln=xe,cs=function(t){var e=+t;return e!=e||e===0?0:Ln(e)},pu=cs,wr=Math.max,Ia=Math.min,zi=function(t,e){var n=pu(t);return n<0?wr(n+e,0):Ia(n,e)},Ao=cs,wo=Math.min,ji=function(t){return t>0?wo(Ao(t),9007199254740991):0},fu=ji,ri=function(t){return fu(t.length)},no=li,b_=zi,A_=ri,Ih=function(t){return function(e,n,i){var r,o=no(e),s=A_(o),a=b_(i,s);if(t&&n!=n){for(;s>a;)if((r=o[a++])!=r)return!0}else for(;s>a;a++)if((t||a in o)&&o[a]===n)return t||a||0;return!t&&-1}},Ye={includes:Ih(!0),indexOf:Ih(!1)},wc=Ye.includes;$t({target:"Array",proto:!0,forced:Pt(function(){return!Array(1).includes()})},{includes:function(t){return wc(this,t,arguments.length>1?arguments[1]:void 0)}});var lr=Bn,oi=function(t){return lr[t+"Prototype"]},w_=oi("Array").includes,O_=Oi,bh=I,ds=Ze("match"),Oc=function(t){var e;return O_(t)&&((e=t[ds])!==void 0?!!e:bh(t)=="RegExp")},Oo=Oc,Ah=TypeError,Ps={};Ps[Ze("toStringTag")]="z";var Ls=String(Ps)==="[object z]",Nc=Ls,_u=pn,Dc=I,Pc=Ze("toStringTag"),Eu=Object,mu=Dc(function(){return arguments}())=="Arguments",Or=Nc?Dc:function(t){var e,n,i;return t===void 0?"Undefined":t===null?"Null":typeof(n=function(r,o){try{return r[o]}catch{}}(e=Eu(t),Pc))=="string"?n:mu?Dc(e):(i=Dc(e))=="Object"&&_u(e.callee)?"Arguments":i},gu=Or,wh=String,x=function(t){if(gu(t)==="Symbol")throw TypeError("Cannot convert a Symbol value to a string");return wh(t)},H=Ze("match"),Z=$t,et=function(t){if(Oo(t))throw Ah("The method doesn't accept regular expressions");return t},ct=ws,vt=x,bt=function(t){var e=/./;try{"/./"[t](e)}catch{try{return e[H]=!1,"/./"[t](e)}catch{}}return!1},xt=Ge("".indexOf);Z({target:"String",proto:!0,forced:!bt("includes")},{includes:function(t){return!!~xt(vt(ct(this)),vt(et(t)),arguments.length>1?arguments[1]:void 0)}});var At=oi("String").includes,Oe=Jn,te=w_,ae=At,ve=Array.prototype,Wt=String.prototype,fn=function(t){var e=t.includes;return t===ve||Oe(ve,t)&&e===ve.includes?te:typeof t=="string"||t===Wt||Oe(Wt,t)&&e===Wt.includes?ae:e},it=Dt(fn),pi=ii,Ji=br,Nr=_c,ks=ri,vi=TypeError,cS=function(t){return function(e,n,i,r){pi(n);var o=Ji(e),s=Nr(o),a=ks(o),c=t?a-1:0,d=t?-1:1;if(i<2)for(;;){if(c in s){r=s[c],c+=d;break}if(c+=d,t?c<0:a<=c)throw vi("Reduce of empty array with no initial value")}for(;t?c>=0:a>c;c+=d)c in s&&(r=n(r,s[c],c,o));return r}},hP={left:cS(!1),right:cS(!0)},pP=Pt,Oh=function(t,e){var n=[][t];return!!n&&pP(function(){n.call(null,e||function(){return 1},1)})},Tu=typeof process!="undefined"&&I(process)=="process",fP=hP.left;$t({target:"Array",proto:!0,forced:!Tu&&Yi>79&&Yi<83||!Oh("reduce")},{reduce:function(t){var e=arguments.length;return fP(this,t,e,e>1?arguments[1]:void 0)}});var _P=oi("Array").reduce,EP=Jn,mP=_P,N_=Array.prototype,gP=function(t){var e=t.reduce;return t===N_||EP(N_,t)&&e===N_.reduce?mP:e},dS=gP,io=Dt(dS);let uS=!0,lS=!0;function Nh(t,e,n){const i=t.match(e);return i&&i.length>=n&&parseInt(i[n],10)}function ba(t,e,n){if(!t.RTCPeerConnection)return;const i=t.RTCPeerConnection.prototype,r=i.addEventListener;i.addEventListener=function(s,a){if(s!==e)return r.apply(this,arguments);const c=d=>{const u=n(d);u&&(a.handleEvent?a.handleEvent(u):a(u))};return this._eventMap=this._eventMap||{},this._eventMap[e]||(this._eventMap[e]=new Map),this._eventMap[e].set(a,c),r.apply(this,[s,c])};const o=i.removeEventListener;i.removeEventListener=function(s,a){if(s!==e||!this._eventMap||!this._eventMap[e])return o.apply(this,arguments);if(!this._eventMap[e].has(a))return o.apply(this,arguments);const c=this._eventMap[e].get(a);return this._eventMap[e].delete(a),this._eventMap[e].size===0&&delete this._eventMap[e],Object.keys(this._eventMap).length===0&&delete this._eventMap,o.apply(this,[s,c])},Object.defineProperty(i,"on"+e,{get(){return this["_on"+e]},set(s){this["_on"+e]&&(this.removeEventListener(e,this["_on"+e]),delete this["_on"+e]),s&&this.addEventListener(e,this["_on"+e]=s)},enumerable:!0,configurable:!0})}function TP(t){return typeof t!="boolean"?new Error("Argument type: "+typeof t+". Please use a boolean."):(uS=t,t?"adapter.js logging disabled":"adapter.js logging enabled")}function SP(t){return typeof t!="boolean"?new Error("Argument type: "+typeof t+". Please use a boolean."):(lS=!t,"adapter.js deprecation warnings "+(t?"disabled":"enabled"))}function hS(){if(typeof window=="object"){if(uS)return;typeof console!="undefined"&&typeof console.log=="function"&&console.log.apply(console,arguments)}}function D_(t,e){lS&&console.warn(t+" is deprecated, please use "+e+" instead.")}function pS(t){return Object.prototype.toString.call(t)==="[object Object]"}function fS(t){var e;return pS(t)?io(e=Object.keys(t)).call(e,function(n,i){const r=pS(t[i]),o=r?fS(t[i]):t[i],s=r&&!Object.keys(o).length;return o===void 0||s?n:Object.assign(n,{[i]:o})},{}):t}function P_(t,e,n){e&&!n.has(e.id)&&(n.set(e.id,e),Object.keys(e).forEach(i=>{i.endsWith("Id")?P_(t,t.get(e[i]),n):i.endsWith("Ids")&&e[i].forEach(r=>{P_(t,t.get(r),n)})}))}function _S(t,e,n){const i=n?"outbound-rtp":"inbound-rtp",r=new Map;if(e===null)return r;const o=[];return t.forEach(s=>{s.type==="track"&&s.trackIdentifier===e.id&&o.push(s)}),o.forEach(s=>{t.forEach(a=>{a.type===i&&a.trackId===s.id&&P_(t,a,r)})}),r}var RP=eu,ES=yo("keys"),Dh=function(t){return ES[t]||(ES[t]=RP(t))},CP=!Pt(function(){function t(){}return t.prototype.constructor=null,Object.getPrototypeOf(new t)!==t.prototype}),vP=Dn,yP=pn,IP=br,bP=CP,mS=Dh("IE_PROTO"),L_=Object,AP=L_.prototype,k_=bP?L_.getPrototypeOf:function(t){var e=IP(t);if(vP(e,mS))return e[mS];var n=e.constructor;return yP(n)&&e instanceof n?n.prototype:e instanceof L_?AP:null},wP=Ge,OP=ii,NP=pn,DP=String,PP=TypeError,LP=function(t,e,n){try{return wP(OP(Object.getOwnPropertyDescriptor(t,e)[n]))}catch{}},kP=Gn,MP=function(t){if(typeof t=="object"||NP(t))return t;throw PP("Can't set "+DP(t)+" as a prototype")},UP=Object.setPrototypeOf||("__proto__"in{}?function(){var t,e=!1,n={};try{(t=LP(Object.prototype,"__proto__","set"))(n,[]),e=n instanceof Array}catch{}return function(i,r){return kP(i),MP(r),e?t(i,r):i.__proto__=r,i}}():void 0),Ph={},Lh={},M_=Dn,xP=li,VP=Ye.indexOf,FP=Lh,gS=Ge([].push),TS=function(t,e){var n,i=xP(t),r=0,o=[];for(n in i)!M_(FP,n)&&M_(i,n)&&gS(o,n);for(;e.length>r;)M_(i,n=e[r++])&&(~VP(o,n)||gS(o,n));return o},U_=["constructor","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","toLocaleString","toString","valueOf"],jP=TS,BP=U_.concat("length","prototype");Ph.f=Object.getOwnPropertyNames||function(t){return jP(t,BP)};var Su={};Su.f=Object.getOwnPropertySymbols;var GP=Ci,WP=Ph,HP=Su,KP=Gn,qP=Ge([].concat),YP=GP("Reflect","ownKeys")||function(t){var e=WP.f(KP(t)),n=HP.f;return n?qP(e,n(t)):e},SS=Dn,zP=YP,JP=Ta,XP=Fi,x_={},QP=TS,ZP=U_,kh=Object.keys||function(t){return QP(t,ZP)},$P=Vi,tL=bc,eL=Fi,nL=Gn,iL=li,rL=kh;x_.f=$P&&!tL?Object.defineProperties:function(t,e){nL(t);for(var n,i=iL(e),r=rL(e),o=r.length,s=0;o>s;)eL.f(t,n=r[s++],i[n]);return t};var Mh,RS=Ci("document","documentElement"),oL=Gn,sL=x_,CS=U_,aL=Lh,cL=RS,dL=to,V_="prototype",F_="script",vS=Dh("IE_PROTO"),j_=function(){},yS=function(t){return"<"+F_+">"+t+"</"+F_+">"},IS=function(t){t.write(yS("")),t.close();var e=t.parentWindow.Object;return t=null,e},Uh=function(){try{Mh=new ActiveXObject("htmlfile")}catch{}var t,e,n;Uh=typeof document!="undefined"?document.domain&&Mh?IS(Mh):(e=dL("iframe"),n="java"+F_+":",e.style.display="none",cL.appendChild(e),e.src=String(n),(t=e.contentWindow.document).open(),t.write(yS("document.F=Object")),t.close(),t.F):IS(Mh);for(var i=CS.length;i--;)delete Uh[V_][CS[i]];return Uh()};aL[vS]=!0;var Ru=Object.create||function(t,e){var n;return t!==null?(j_[V_]=oL(t),n=new j_,j_[V_]=null,n[vS]=t):n=Uh(),e===void 0?n:sL.f(n,e)},uL=Oi,lL=F,bS=Error,hL=Ge("".replace),pL=String(bS("zxcasd").stack),AS=/\n\s*at [^:]*:[^\n]*/,fL=AS.test(pL),_L=Ro,EL=!Pt(function(){var t=Error("a");return!("stack"in t)||(Object.defineProperty(t,"stack",_L(1,7)),t.stack!==7)}),mL=F,gL=function(t,e){if(fL&&typeof t=="string"&&!bS.prepareStackTrace)for(;e--;)t=hL(t,AS,"");return t},TL=EL,wS=Error.captureStackTrace,Aa={},SL=Aa,RL=Ze("iterator"),CL=Array.prototype,OS=function(t){return t!==void 0&&(SL.Array===t||CL[RL]===t)},vL=Or,NS=rs,yL=dr,IL=Aa,bL=Ze("iterator"),xh=function(t){if(!yL(t))return NS(t,bL)||NS(t,"@@iterator")||IL[vL(t)]},AL=cn,wL=ii,OL=Gn,NL=vo,DL=xh,PL=TypeError,B_=function(t,e){var n=arguments.length<2?DL(t):e;if(wL(n))return OL(AL(n,t));throw PL(NL(t)+" is not iterable")},LL=cn,DS=Gn,kL=rs,PS=function(t,e,n){var i,r;DS(t);try{if(!(i=kL(t,"return"))){if(e==="throw")throw n;return n}i=LL(i,t)}catch(o){r=!0,i=o}if(e==="throw")throw n;if(r)throw i;return DS(i),n},ML=eo,UL=cn,xL=Gn,VL=vo,FL=OS,jL=ri,LS=Jn,BL=B_,GL=xh,kS=PS,WL=TypeError,Vh=function(t,e){this.stopped=t,this.result=e},MS=Vh.prototype,Cu=function(t,e,n){var i,r,o,s,a,c,d,u=n&&n.that,l=!(!n||!n.AS_ENTRIES),p=!(!n||!n.IS_RECORD),f=!(!n||!n.IS_ITERATOR),C=!(!n||!n.INTERRUPTED),m=ML(e,u),g=function(A){return i&&kS(i,"normal",A),new Vh(!0,A)},y=function(A){return l?(xL(A),C?m(A[0],A[1],g):m(A[0],A[1])):C?m(A,g):m(A)};if(p)i=t.iterator;else if(f)i=t;else{if(!(r=GL(t)))throw WL(VL(t)+" is not iterable");if(FL(r)){for(o=0,s=jL(t);s>o;o++)if((a=y(t[o]))&&LS(MS,a))return a;return new Vh(!1)}i=BL(t,r)}for(c=p?t.next:i.next;!(d=UL(c,i)).done;){try{a=y(d.value)}catch(A){kS(i,"throw",A)}if(typeof a=="object"&&a&&LS(MS,a))return a}return new Vh(!1)},HL=x,KL=$t,qL=Jn,YL=k_,Fh=UP,zL=function(t,e,n){for(var i=zP(e),r=XP.f,o=JP.f,s=0;s<i.length;s++){var a=i[s];SS(t,a)||n&&SS(n,a)||r(t,a,o(e,a))}},US=Ru,G_=F,W_=Ro,JL=function(t,e){uL(e)&&"cause"in e&&lL(t,"cause",e.cause)},XL=function(t,e,n,i){TL&&(wS?wS(t,e):mL(t,"stack",gL(n,i)))},QL=Cu,ZL=function(t,e){return t===void 0?arguments.length<2?"":e:HL(t)},$L=Ze("toStringTag"),jh=Error,tk=[].push,Lc=function(t,e){var n,i=qL(H_,this);Fh?n=Fh(jh(),i?YL(this):H_):(n=i?this:US(H_),G_(n,$L,"Error")),e!==void 0&&G_(n,"message",ZL(e)),XL(n,Lc,n.stack,1),arguments.length>2&&JL(n,arguments[2]);var r=[];return QL(t,tk,{that:r}),G_(n,"errors",r),n};Fh?Fh(Lc,jh):zL(Lc,jh,{name:!0});var H_=Lc.prototype=US(jh.prototype,{constructor:W_(1,Lc),message:W_(1,""),name:W_(1,"AggregateError")});KL({global:!0,constructor:!0,arity:2},{AggregateError:Lc});var Bh,vu,Gh,ek=pn,xS=Lt.WeakMap,nk=ek(xS)&&/native code/.test(String(xS)),VS=Lt,ik=Oi,rk=F,K_=Dn,q_=Sc,ok=Dh,sk=Lh,FS="Object already initialized",Y_=VS.TypeError,ak=VS.WeakMap;if(nk||q_.state){var No=q_.state||(q_.state=new ak);No.get=No.get,No.has=No.has,No.set=No.set,Bh=function(t,e){if(No.has(t))throw Y_(FS);return e.facade=t,No.set(t,e),e},vu=function(t){return No.get(t)||{}},Gh=function(t){return No.has(t)}}else{var kc=ok("state");sk[kc]=!0,Bh=function(t,e){if(K_(t,kc))throw Y_(FS);return e.facade=t,rk(t,kc,e),e},vu=function(t){return K_(t,kc)?t[kc]:{}},Gh=function(t){return K_(t,kc)}}var wa,jS,BS,Oa={set:Bh,get:vu,has:Gh,enforce:function(t){return Gh(t)?vu(t):Bh(t,{})},getterFor:function(t){return function(e){var n;if(!ik(e)||(n=vu(e)).type!==t)throw Y_("Incompatible receiver, "+t+" required");return n}}},z_=Vi,ck=Dn,GS=Function.prototype,dk=z_&&Object.getOwnPropertyDescriptor,J_=ck(GS,"name"),WS={EXISTS:J_,PROPER:J_&&function(){}.name==="something",CONFIGURABLE:J_&&(!z_||z_&&dk(GS,"name").configurable)},uk=F,Ms=function(t,e,n,i){return i&&i.enumerable?t[e]=n:uk(t,e,n),t},lk=Pt,hk=pn,pk=Oi,fk=Ru,HS=k_,_k=Ms,X_=Ze("iterator"),KS=!1;[].keys&&("next"in(BS=[].keys())?(jS=HS(HS(BS)))!==Object.prototype&&(wa=jS):KS=!0);var Ek=!pk(wa)||lk(function(){var t={};return wa[X_].call(t)!==t});hk((wa=Ek?{}:fk(wa))[X_])||_k(wa,X_,function(){return this});var qS={IteratorPrototype:wa,BUGGY_SAFARI_ITERATORS:KS},mk=Or,gk=Ls?{}.toString:function(){return"[object "+mk(this)+"]"},Tk=Ls,Sk=Fi.f,Rk=F,Ck=Dn,vk=gk,YS=Ze("toStringTag"),Us=function(t,e,n,i){if(t){var r=n?t:t.prototype;Ck(r,YS)||Sk(r,YS,{configurable:!0,value:e}),i&&!Tk&&Rk(r,"toString",vk)}},yk=qS.IteratorPrototype,Ik=Ru,bk=Ro,Ak=Us,wk=Aa,Ok=function(){return this},Q_=function(t,e,n,i){var r=e+" Iterator";return t.prototype=Ik(yk,{next:bk(+!i,n)}),Ak(t,r,!1,!0),wk[r]=Ok,t},Nk=$t,Dk=cn,Pk=WS,Lk=Q_,kk=k_,Mk=Us,zS=Ms,JS=Aa,Uk=qS,xk=Pk.PROPER,Wh=Uk.BUGGY_SAFARI_ITERATORS,Z_=Ze("iterator"),XS="keys",Hh="values",QS="entries",Vk=function(){return this},ZS=function(t,e,n,i,r,o,s){Lk(n,e,i);var a,c,d,u=function(y){if(y===r&&m)return m;if(!Wh&&y in f)return f[y];switch(y){case XS:case Hh:case QS:return function(){return new n(this,y)}}return function(){return new n(this)}},l=e+" Iterator",p=!1,f=t.prototype,C=f[Z_]||f["@@iterator"]||r&&f[r],m=!Wh&&C||u(r),g=e=="Array"&&f.entries||C;if(g&&(a=kk(g.call(new t)))!==Object.prototype&&a.next&&(Mk(a,l,!0,!0),JS[l]=Vk),xk&&r==Hh&&C&&C.name!==Hh&&(p=!0,m=function(){return Dk(C,this)}),r)if(c={values:u(Hh),keys:o?m:u(XS),entries:u(QS)},s)for(d in c)(Wh||p||!(d in f))&&zS(f,d,c[d]);else Nk({target:e,proto:!0,forced:Wh||p},c);return s&&f[Z_]!==m&&zS(f,Z_,m,{name:r}),JS[e]=m,c},$_=function(t,e){return{value:t,done:e}},Fk=li,$S=Aa,tR=Oa;Fi.f;var jk=ZS,eR=$_,nR="Array Iterator",Bk=tR.set,Gk=tR.getterFor(nR);jk(Array,"Array",function(t,e){Bk(this,{type:nR,target:Fk(t),index:0,kind:e})},function(){var t=Gk(this),e=t.target,n=t.kind,i=t.index++;return!e||i>=e.length?(t.target=void 0,eR(void 0,!0)):eR(n=="keys"?i:n=="values"?e[i]:[i,e[i]],!1)},"values"),$S.Arguments=$S.Array;var Wk=Fi,Kh=function(t,e,n){return Wk.f(t,e,n)},Hk=Ci,Kk=Kh,qk=Vi,iR=Ze("species"),Yk=Jn,zk=TypeError,tE=function(t,e){if(Yk(e,t))return t;throw zk("Incorrect invocation")},Jk=pn,eE=Sc,Xk=Ge(Function.toString);Jk(eE.inspectSource)||(eE.inspectSource=function(t){return Xk(t)});var rR=eE.inspectSource,Qk=Ge,Zk=Pt,oR=pn,$k=Or,t1=rR,sR=function(){},e1=[],aR=Ci("Reflect","construct"),nE=/^\s*(?:class|function)\b/,n1=Qk(nE.exec),i1=!nE.exec(sR),yu=function(t){if(!oR(t))return!1;try{return aR(sR,e1,t),!0}catch{return!1}},cR=function(t){if(!oR(t))return!1;switch($k(t)){case"AsyncFunction":case"GeneratorFunction":case"AsyncGeneratorFunction":return!1}try{return i1||!!n1(nE,t1(t))}catch{return!0}};cR.sham=!0;var Iu,Mc,dR,iE,qh=!aR||Zk(function(){var t;return yu(yu.call)||!yu(Object)||!yu(function(){t=!0})||t})?cR:yu,r1=qh,o1=vo,s1=TypeError,uR=Gn,a1=function(t){if(r1(t))return t;throw s1(o1(t)+" is not a constructor")},c1=dr,d1=Ze("species"),rE=function(t,e){var n,i=uR(t).constructor;return i===void 0||c1(n=uR(i)[d1])?e:a1(n)},oE=Ge([].slice),u1=TypeError,Yh=function(t,e){if(t<e)throw u1("Not enough arguments");return t},lR=/(?:ipad|iphone|ipod).*applewebkit/i.test(ns),hr=Lt,l1=lc,h1=eo,hR=pn,p1=Dn,pR=Pt,fR=RS,f1=oE,_R=to,_1=Yh,E1=lR,m1=Tu,sE=hr.setImmediate,aE=hr.clearImmediate,g1=hr.process,cE=hr.Dispatch,T1=hr.Function,ER=hr.MessageChannel,S1=hr.String,dE=0,bu={},mR="onreadystatechange";pR(function(){Iu=hr.location});var uE=function(t){if(p1(bu,t)){var e=bu[t];delete bu[t],e()}},lE=function(t){return function(){uE(t)}},gR=function(t){uE(t.data)},TR=function(t){hr.postMessage(S1(t),Iu.protocol+"//"+Iu.host)};sE&&aE||(sE=function(t){_1(arguments.length,1);var e=hR(t)?t:T1(t),n=f1(arguments,1);return bu[++dE]=function(){l1(e,void 0,n)},Mc(dE),dE},aE=function(t){delete bu[t]},m1?Mc=function(t){g1.nextTick(lE(t))}:cE&&cE.now?Mc=function(t){cE.now(lE(t))}:ER&&!E1?(iE=(dR=new ER).port2,dR.port1.onmessage=gR,Mc=h1(iE.postMessage,iE)):hr.addEventListener&&hR(hr.postMessage)&&!hr.importScripts&&Iu&&Iu.protocol!=="file:"&&!pR(TR)?(Mc=TR,hr.addEventListener("message",gR,!1)):Mc=mR in _R("script")?function(t){fR.appendChild(_R("script"))[mR]=function(){fR.removeChild(this),uE(t)}}:function(t){setTimeout(lE(t),0)});var SR={set:sE,clear:aE},RR=function(){this.head=null,this.tail=null};RR.prototype={add:function(t){var e={item:t,next:null},n=this.tail;n?n.next=e:this.head=e,this.tail=e},get:function(){var t=this.head;if(t)return(this.head=t.next)===null&&(this.tail=null),t.item}};var Uc,hE,pE,fE,CR,vR=RR,R1=/ipad|iphone|ipod/i.test(ns)&&typeof Pebble!="undefined",C1=/web0s(?!.*chrome)/i.test(ns),Na=Lt,yR=eo,v1=Ta.f,_E=SR.set,y1=vR,I1=lR,b1=R1,A1=C1,EE=Tu,IR=Na.MutationObserver||Na.WebKitMutationObserver,bR=Na.document,AR=Na.process,zh=Na.Promise,wR=v1(Na,"queueMicrotask"),mE=wR&&wR.value;if(!mE){var Jh=new y1,Xh=function(){var t,e;for(EE&&(t=AR.domain)&&t.exit();e=Jh.get();)try{e()}catch(n){throw Jh.head&&Uc(),n}t&&t.enter()};I1||EE||A1||!IR||!bR?!b1&&zh&&zh.resolve?((fE=zh.resolve(void 0)).constructor=zh,CR=yR(fE.then,fE),Uc=function(){CR(Xh)}):EE?Uc=function(){AR.nextTick(Xh)}:(_E=yR(_E,Na),Uc=function(){_E(Xh)}):(hE=!0,pE=bR.createTextNode(""),new IR(Xh).observe(pE,{characterData:!0}),Uc=function(){pE.data=hE=!hE}),mE=function(t){Jh.head||Uc(),Jh.add(t)}}var w1=mE,xc=function(t){try{return{error:!1,value:t()}}catch(e){return{error:!0,value:e}}},Da=Lt.Promise,OR=typeof Deno=="object"&&Deno&&typeof Deno.version=="object",O1=!OR&&!Tu&&typeof window=="object"&&typeof document=="object",N1=Lt,Au=Da,D1=pn,P1=du,L1=rR,k1=Ze,M1=O1,U1=OR,gE=Yi,NR=Au&&Au.prototype,x1=k1("species"),DR=!1,PR=D1(N1.PromiseRejectionEvent),V1=P1("Promise",function(){var t=L1(Au),e=t!==String(Au);if(!e&&gE===66||!NR.catch||!NR.finally)return!0;if(!gE||gE<51||!/native code/.test(t)){var n=new Au(function(r){r(1)}),i=function(r){r(function(){},function(){})};if((n.constructor={})[x1]=i,!(DR=n.then(function(){})instanceof i))return!0}return!e&&(M1||U1)&&!PR}),wu={CONSTRUCTOR:V1,REJECTION_EVENT:PR,SUBCLASSING:DR},Do={},LR=ii,F1=TypeError,j1=function(t){var e,n;this.promise=new t(function(i,r){if(e!==void 0||n!==void 0)throw F1("Bad Promise constructor");e=i,n=r}),this.resolve=LR(e),this.reject=LR(n)};Do.f=function(t){return new j1(t)};var TE,kR,B1=$t,Qh=Tu,xs=Lt,Ou=cn,G1=Ms,W1=Us,H1=function(t){var e=Hk(t);qk&&e&&!e[iR]&&Kk(e,iR,{configurable:!0,get:function(){return this}})},K1=ii,SE=pn,q1=Oi,Y1=tE,z1=rE,MR=SR.set,RE=w1,J1=function(t,e){try{arguments.length==1?console.error(t):console.error(t,e)}catch{}},X1=xc,Q1=vR,UR=Oa,CE=Da,xR=wu,VR=Do,Zh="Promise",FR=xR.CONSTRUCTOR,Z1=xR.REJECTION_EVENT,vE=UR.getterFor(Zh),$1=UR.set,tM=CE&&CE.prototype,Nu=CE,yE=tM,jR=xs.TypeError,IE=xs.document,bE=xs.process,AE=VR.f,eM=AE,nM=!!(IE&&IE.createEvent&&xs.dispatchEvent),BR="unhandledrejection",GR=function(t){var e;return!(!q1(t)||!SE(e=t.then))&&e},WR=function(t,e){var n,i,r,o=e.value,s=e.state==1,a=s?t.ok:t.fail,c=t.resolve,d=t.reject,u=t.domain;try{a?(s||(e.rejection===2&&rM(e),e.rejection=1),a===!0?n=o:(u&&u.enter(),n=a(o),u&&(u.exit(),r=!0)),n===t.promise?d(jR("Promise-chain cycle")):(i=GR(n))?Ou(i,n,c,d):c(n)):d(o)}catch(l){u&&!r&&u.exit(),d(l)}},HR=function(t,e){t.notified||(t.notified=!0,RE(function(){for(var n,i=t.reactions;n=i.get();)WR(n,t);t.notified=!1,e&&!t.rejection&&iM(t)}))},KR=function(t,e,n){var i,r;nM?((i=IE.createEvent("Event")).promise=e,i.reason=n,i.initEvent(t,!1,!0),xs.dispatchEvent(i)):i={promise:e,reason:n},!Z1&&(r=xs["on"+t])?r(i):t===BR&&J1("Unhandled promise rejection",n)},iM=function(t){Ou(MR,xs,function(){var e,n=t.facade,i=t.value;if(qR(t)&&(e=X1(function(){Qh?bE.emit("unhandledRejection",i,n):KR(BR,n,i)}),t.rejection=Qh||qR(t)?2:1,e.error))throw e.value})},qR=function(t){return t.rejection!==1&&!t.parent},rM=function(t){Ou(MR,xs,function(){var e=t.facade;Qh?bE.emit("rejectionHandled",e):KR("rejectionhandled",e,t.value)})},Vc=function(t,e,n){return function(i){t(e,i,n)}},Fc=function(t,e,n){t.done||(t.done=!0,n&&(t=n),t.value=e,t.state=2,HR(t,!0))},wE=function(t,e,n){if(!t.done){t.done=!0,n&&(t=n);try{if(t.facade===e)throw jR("Promise can't be resolved itself");var i=GR(e);i?RE(function(){var r={done:!1};try{Ou(i,e,Vc(wE,r,t),Vc(Fc,r,t))}catch(o){Fc(r,o,t)}}):(t.value=e,t.state=1,HR(t,!1))}catch(r){Fc({done:!1},r,t)}}};FR&&(yE=(Nu=function(t){Y1(this,yE),K1(t),Ou(TE,this);var e=vE(this);try{t(Vc(wE,e),Vc(Fc,e))}catch(n){Fc(e,n)}}).prototype,(TE=function(t){$1(this,{type:Zh,done:!1,notified:!1,parent:!1,reactions:new Q1,rejection:!1,state:0,value:void 0})}).prototype=G1(yE,"then",function(t,e){var n=vE(this),i=AE(z1(this,Nu));return n.parent=!0,i.ok=!SE(t)||t,i.fail=SE(e)&&e,i.domain=Qh?bE.domain:void 0,n.state==0?n.reactions.add(i):RE(function(){WR(i,n)}),i.promise}),kR=function(){var t=new TE,e=vE(t);this.promise=t,this.resolve=Vc(wE,e),this.reject=Vc(Fc,e)},VR.f=AE=function(t){return t===Nu||t===void 0?new kR(t):eM(t)}),B1({global:!0,constructor:!0,wrap:!0,forced:FR},{Promise:Nu}),W1(Nu,Zh,!1,!0),H1(Zh);var YR=Ze("iterator"),zR=!1;try{var oM=0,JR={next:function(){return{done:!!oM++}},return:function(){zR=!0}};JR[YR]=function(){return this},Array.from(JR,function(){throw 2})}catch{}var sM=Da,aM=function(t,e){if(!e&&!zR)return!1;var n=!1;try{var i={};i[YR]=function(){return{next:function(){return{done:n=!0}}}},t(i)}catch{}return n},$h=wu.CONSTRUCTOR||!aM(function(t){sM.all(t).then(void 0,function(){})}),cM=cn,dM=ii,uM=Do,lM=xc,hM=Cu;$t({target:"Promise",stat:!0,forced:$h},{all:function(t){var e=this,n=uM.f(e),i=n.resolve,r=n.reject,o=lM(function(){var s=dM(e.resolve),a=[],c=0,d=1;hM(t,function(u){var l=c++,p=!1;d++,cM(s,e,u).then(function(f){p||(p=!0,a[l]=f,--d||i(a))},r)}),--d||i(a)});return o.error&&r(o.value),n.promise}});var pM=$t,fM=wu.CONSTRUCTOR;Da&&Da.prototype,pM({target:"Promise",proto:!0,forced:fM,real:!0},{catch:function(t){return this.then(void 0,t)}});var _M=cn,EM=ii,mM=Do,gM=xc,TM=Cu;$t({target:"Promise",stat:!0,forced:$h},{race:function(t){var e=this,n=mM.f(e),i=n.reject,r=gM(function(){var o=EM(e.resolve);TM(t,function(s){_M(o,e,s).then(n.resolve,i)})});return r.error&&i(r.value),n.promise}});var SM=cn,RM=Do;$t({target:"Promise",stat:!0,forced:wu.CONSTRUCTOR},{reject:function(t){var e=RM.f(this);return SM(e.reject,void 0,t),e.promise}});var CM=Gn,vM=Oi,yM=Do,XR=function(t,e){if(CM(t),vM(e)&&e.constructor===t)return e;var n=yM.f(t);return(0,n.resolve)(e),n.promise},IM=$t,bM=Da,AM=wu.CONSTRUCTOR,wM=XR,OM=Ci("Promise"),NM=!AM;IM({target:"Promise",stat:!0,forced:!0},{resolve:function(t){return wM(NM&&this===OM?bM:this,t)}});var DM=cn,PM=ii,LM=Do,kM=xc,MM=Cu;$t({target:"Promise",stat:!0,forced:$h},{allSettled:function(t){var e=this,n=LM.f(e),i=n.resolve,r=n.reject,o=kM(function(){var s=PM(e.resolve),a=[],c=0,d=1;MM(t,function(u){var l=c++,p=!1;d++,DM(s,e,u).then(function(f){p||(p=!0,a[l]={status:"fulfilled",value:f},--d||i(a))},function(f){p||(p=!0,a[l]={status:"rejected",reason:f},--d||i(a))})}),--d||i(a)});return o.error&&r(o.value),n.promise}});var UM=cn,xM=ii,VM=Ci,FM=Do,jM=xc,BM=Cu,QR="No one promise resolved";$t({target:"Promise",stat:!0,forced:$h},{any:function(t){var e=this,n=VM("AggregateError"),i=FM.f(e),r=i.resolve,o=i.reject,s=jM(function(){var a=xM(e.resolve),c=[],d=0,u=1,l=!1;BM(t,function(p){var f=d++,C=!1;u++,UM(a,e,p).then(function(m){C||l||(l=!0,r(m))},function(m){C||l||(C=!0,c[f]=m,--u||o(new n(c,QR)))})}),--u||o(new n(c,QR))});return s.error&&o(s.value),i.promise}});var GM=$t,OE=Da,WM=Pt,HM=Ci,KM=pn,qM=rE,ZR=XR,YM=OE&&OE.prototype;GM({target:"Promise",proto:!0,real:!0,forced:!!OE&&WM(function(){YM.finally.call({then:function(){}},function(){})})},{finally:function(t){var e=qM(this,HM("Promise")),n=KM(t);return this.then(n?function(i){return ZR(e,t()).then(function(){return i})}:t,n?function(i){return ZR(e,t()).then(function(){throw i})}:t)}});var NE=Ge,zM=cs,JM=x,XM=ws,QM=NE("".charAt),$R=NE("".charCodeAt),ZM=NE("".slice),tC=function(t){return function(e,n){var i,r,o=JM(XM(e)),s=zM(n),a=o.length;return s<0||s>=a?t?"":void 0:(i=$R(o,s))<55296||i>56319||s+1===a||(r=$R(o,s+1))<56320||r>57343?t?QM(o,s):i:t?ZM(o,s,s+2):r-56320+(i-55296<<10)+65536}},DE={codeAt:tC(!1),charAt:tC(!0)},$M=DE.charAt,tU=x,eC=Oa,eU=ZS,nC=$_,iC="String Iterator",nU=eC.set,iU=eC.getterFor(iC);eU(String,"String",function(t){nU(this,{type:iC,string:tU(t),index:0})},function(){var t,e=iU(this),n=e.string,i=e.index;return i>=n.length?nC(void 0,!0):(t=$M(n,i),e.index+=t.length,nC(t,!1))});var rU=Bn.Promise,oU={CSSRuleList:0,CSSStyleDeclaration:0,CSSValueList:0,ClientRectList:0,DOMRectList:0,DOMStringList:0,DOMTokenList:1,DataTransferItemList:0,FileList:0,HTMLAllCollection:0,HTMLCollection:0,HTMLFormElement:0,HTMLSelectElement:0,MediaList:0,MimeTypeArray:0,NamedNodeMap:0,NodeList:1,PaintRequestList:0,Plugin:0,PluginArray:0,SVGLengthList:0,SVGNumberList:0,SVGPathSegList:0,SVGPointList:0,SVGStringList:0,SVGTransformList:0,SourceBufferList:0,StyleSheetList:0,TextTrackCueList:0,TextTrackList:0,TouchList:0},sU=Lt,aU=Or,cU=F,rC=Aa,oC=Ze("toStringTag");for(var PE in oU){var sC=sU[PE],LE=sC&&sC.prototype;LE&&aU(LE)!==oC&&cU(LE,oC,PE),rC[PE]=rC.Array}var aC=rU,ot=Dt(aC);const cC=hS;function dC(t,e){const n=t&&t.navigator;if(!n.mediaDevices)return;const i=function(s){if(typeof s!="object"||s.mandatory||s.optional)return s;const a={};return Object.keys(s).forEach(c=>{if(c==="require"||c==="advanced"||c==="mediaSource")return;const d=typeof s[c]=="object"?s[c]:{ideal:s[c]};d.exact!==void 0&&typeof d.exact=="number"&&(d.min=d.max=d.exact);const u=function(l,p){return l?l+p.charAt(0).toUpperCase()+p.slice(1):p==="deviceId"?"sourceId":p};if(d.ideal!==void 0){a.optional=a.optional||[];let l={};typeof d.ideal=="number"?(l[u("min",c)]=d.ideal,a.optional.push(l),l={},l[u("max",c)]=d.ideal,a.optional.push(l)):(l[u("",c)]=d.ideal,a.optional.push(l))}d.exact!==void 0&&typeof d.exact!="number"?(a.mandatory=a.mandatory||{},a.mandatory[u("",c)]=d.exact):["min","max"].forEach(l=>{d[l]!==void 0&&(a.mandatory=a.mandatory||{},a.mandatory[u(l,c)]=d[l])})}),s.advanced&&(a.optional=(a.optional||[]).concat(s.advanced)),a},r=function(s,a){if(e.version>=61)return a(s);if((s=JSON.parse(JSON.stringify(s)))&&typeof s.audio=="object"){const c=function(d,u,l){u in d&&!(l in d)&&(d[l]=d[u],delete d[u])};c((s=JSON.parse(JSON.stringify(s))).audio,"autoGainControl","googAutoGainControl"),c(s.audio,"noiseSuppression","googNoiseSuppression"),s.audio=i(s.audio)}if(s&&typeof s.video=="object"){let c=s.video.facingMode;c=c&&(typeof c=="object"?c:{ideal:c});const d=e.version<66;if(c&&(c.exact==="user"||c.exact==="environment"||c.ideal==="user"||c.ideal==="environment")&&(!n.mediaDevices.getSupportedConstraints||!n.mediaDevices.getSupportedConstraints().facingMode||d)){let u;if(delete s.video.facingMode,c.exact==="environment"||c.ideal==="environment"?u=["back","rear"]:c.exact!=="user"&&c.ideal!=="user"||(u=["front"]),u)return n.mediaDevices.enumerateDevices().then(l=>{let p=(l=l.filter(f=>f.kind==="videoinput")).find(f=>u.some(C=>{var m;return it(m=f.label.toLowerCase()).call(m,C)}));return!p&&l.length&&it(u).call(u,"back")&&(p=l[l.length-1]),p&&(s.video.deviceId=c.exact?{exact:p.deviceId}:{ideal:p.deviceId}),s.video=i(s.video),cC("chrome: "+JSON.stringify(s)),a(s)})}s.video=i(s.video)}return cC("chrome: "+JSON.stringify(s)),a(s)},o=function(s){return e.version>=64?s:{name:{PermissionDeniedError:"NotAllowedError",PermissionDismissedError:"NotAllowedError",InvalidStateError:"NotAllowedError",DevicesNotFoundError:"NotFoundError",ConstraintNotSatisfiedError:"OverconstrainedError",TrackStartError:"NotReadableError",MediaDeviceFailedDueToShutdown:"NotAllowedError",MediaDeviceKillSwitchOn:"NotAllowedError",TabCaptureError:"AbortError",ScreenCaptureError:"AbortError",DeviceCaptureError:"AbortError"}[s.name]||s.name,message:s.message,constraint:s.constraint||s.constraintName,toString(){return this.name+(this.message&&": ")+this.message}}};if(n.getUserMedia=function(s,a,c){r(s,d=>{n.webkitGetUserMedia(d,a,u=>{c&&c(o(u))})})}.bind(n),n.mediaDevices.getUserMedia){const s=n.mediaDevices.getUserMedia.bind(n.mediaDevices);n.mediaDevices.getUserMedia=function(a){return r(a,c=>s(c).then(d=>{if(c.audio&&!d.getAudioTracks().length||c.video&&!d.getVideoTracks().length)throw d.getTracks().forEach(u=>{u.stop()}),new DOMException("","NotFoundError");return d},d=>ot.reject(o(d))))}}}function uC(t){t.MediaStream=t.MediaStream||t.webkitMediaStream}function lC(t){if(typeof t=="object"&&t.RTCPeerConnection&&!("ontrack"in t.RTCPeerConnection.prototype)){Object.defineProperty(t.RTCPeerConnection.prototype,"ontrack",{get(){return this._ontrack},set(n){this._ontrack&&this.removeEventListener("track",this._ontrack),this.addEventListener("track",this._ontrack=n)},enumerable:!0,configurable:!0});const e=t.RTCPeerConnection.prototype.setRemoteDescription;t.RTCPeerConnection.prototype.setRemoteDescription=function(){return this._ontrackpoly||(this._ontrackpoly=n=>{n.stream.addEventListener("addtrack",i=>{let r;r=t.RTCPeerConnection.prototype.getReceivers?this.getReceivers().find(s=>s.track&&s.track.id===i.track.id):{track:i.track};const o=new Event("track");o.track=i.track,o.receiver=r,o.transceiver={receiver:r},o.streams=[n.stream],this.dispatchEvent(o)}),n.stream.getTracks().forEach(i=>{let r;r=t.RTCPeerConnection.prototype.getReceivers?this.getReceivers().find(s=>s.track&&s.track.id===i.id):{track:i};const o=new Event("track");o.track=i,o.receiver=r,o.transceiver={receiver:r},o.streams=[n.stream],this.dispatchEvent(o)})},this.addEventListener("addstream",this._ontrackpoly)),e.apply(this,arguments)}}else ba(t,"track",e=>(e.transceiver||Object.defineProperty(e,"transceiver",{value:{receiver:e.receiver}}),e))}function hC(t){if(typeof t=="object"&&t.RTCPeerConnection&&!("getSenders"in t.RTCPeerConnection.prototype)&&"createDTMFSender"in t.RTCPeerConnection.prototype){const e=function(r,o){return{track:o,get dtmf(){return this._dtmf===void 0&&(o.kind==="audio"?this._dtmf=r.createDTMFSender(o):this._dtmf=null),this._dtmf},_pc:r}};if(!t.RTCPeerConnection.prototype.getSenders){t.RTCPeerConnection.prototype.getSenders=function(){return this._senders=this._senders||[],this._senders.slice()};const r=t.RTCPeerConnection.prototype.addTrack;t.RTCPeerConnection.prototype.addTrack=function(s,a){let c=r.apply(this,arguments);return c||(c=e(this,s),this._senders.push(c)),c};const o=t.RTCPeerConnection.prototype.removeTrack;t.RTCPeerConnection.prototype.removeTrack=function(s){o.apply(this,arguments);const a=this._senders.indexOf(s);a!==-1&&this._senders.splice(a,1)}}const n=t.RTCPeerConnection.prototype.addStream;t.RTCPeerConnection.prototype.addStream=function(r){this._senders=this._senders||[],n.apply(this,[r]),r.getTracks().forEach(o=>{this._senders.push(e(this,o))})};const i=t.RTCPeerConnection.prototype.removeStream;t.RTCPeerConnection.prototype.removeStream=function(r){this._senders=this._senders||[],i.apply(this,[r]),r.getTracks().forEach(o=>{const s=this._senders.find(a=>a.track===o);s&&this._senders.splice(this._senders.indexOf(s),1)})}}else if(typeof t=="object"&&t.RTCPeerConnection&&"getSenders"in t.RTCPeerConnection.prototype&&"createDTMFSender"in t.RTCPeerConnection.prototype&&t.RTCRtpSender&&!("dtmf"in t.RTCRtpSender.prototype)){const e=t.RTCPeerConnection.prototype.getSenders;t.RTCPeerConnection.prototype.getSenders=function(){const n=e.apply(this,[]);return n.forEach(i=>i._pc=this),n},Object.defineProperty(t.RTCRtpSender.prototype,"dtmf",{get(){return this._dtmf===void 0&&(this.track.kind==="audio"?this._dtmf=this._pc.createDTMFSender(this.track):this._dtmf=null),this._dtmf}})}}function pC(t){if(!t.RTCPeerConnection)return;const e=t.RTCPeerConnection.prototype.getStats;t.RTCPeerConnection.prototype.getStats=function(){const[n,i,r]=arguments;if(arguments.length>0&&typeof n=="function")return e.apply(this,arguments);if(e.length===0&&(arguments.length===0||typeof n!="function"))return e.apply(this,[]);const o=function(a){const c={};return a.result().forEach(d=>{const u={id:d.id,timestamp:d.timestamp,type:{localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[d.type]||d.type};d.names().forEach(l=>{u[l]=d.stat(l)}),c[u.id]=u}),c},s=function(a){return new Map(Object.keys(a).map(c=>[c,a[c]]))};if(arguments.length>=2){const a=function(c){i(s(o(c)))};return e.apply(this,[a,n])}return new ot((a,c)=>{e.apply(this,[function(d){a(s(o(d)))},c])}).then(i,r)}}function fC(t){if(!(typeof t=="object"&&t.RTCPeerConnection&&t.RTCRtpSender&&t.RTCRtpReceiver))return;if(!("getStats"in t.RTCRtpSender.prototype)){const n=t.RTCPeerConnection.prototype.getSenders;n&&(t.RTCPeerConnection.prototype.getSenders=function(){const r=n.apply(this,[]);return r.forEach(o=>o._pc=this),r});const i=t.RTCPeerConnection.prototype.addTrack;i&&(t.RTCPeerConnection.prototype.addTrack=function(){const r=i.apply(this,arguments);return r._pc=this,r}),t.RTCRtpSender.prototype.getStats=function(){const r=this;return this._pc.getStats().then(o=>_S(o,r.track,!0))}}if(!("getStats"in t.RTCRtpReceiver.prototype)){const n=t.RTCPeerConnection.prototype.getReceivers;n&&(t.RTCPeerConnection.prototype.getReceivers=function(){const i=n.apply(this,[]);return i.forEach(r=>r._pc=this),i}),ba(t,"track",i=>(i.receiver._pc=i.srcElement,i)),t.RTCRtpReceiver.prototype.getStats=function(){const i=this;return this._pc.getStats().then(r=>_S(r,i.track,!1))}}if(!("getStats"in t.RTCRtpSender.prototype)||!("getStats"in t.RTCRtpReceiver.prototype))return;const e=t.RTCPeerConnection.prototype.getStats;t.RTCPeerConnection.prototype.getStats=function(){if(arguments.length>0&&arguments[0]instanceof t.MediaStreamTrack){const n=arguments[0];let i,r,o;return this.getSenders().forEach(s=>{s.track===n&&(i?o=!0:i=s)}),this.getReceivers().forEach(s=>(s.track===n&&(r?o=!0:r=s),s.track===n)),o||i&&r?ot.reject(new DOMException("There are more than one sender or receiver for the track.","InvalidAccessError")):i?i.getStats():r?r.getStats():ot.reject(new DOMException("There is no sender or receiver for the track.","InvalidAccessError"))}return e.apply(this,arguments)}}function _C(t){t.RTCPeerConnection.prototype.getLocalStreams=function(){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},Object.keys(this._shimmedLocalStreams).map(o=>this._shimmedLocalStreams[o][0])};const e=t.RTCPeerConnection.prototype.addTrack;t.RTCPeerConnection.prototype.addTrack=function(o,s){if(!s)return e.apply(this,arguments);this._shimmedLocalStreams=this._shimmedLocalStreams||{};const a=e.apply(this,arguments);return this._shimmedLocalStreams[s.id]?this._shimmedLocalStreams[s.id].indexOf(a)===-1&&this._shimmedLocalStreams[s.id].push(a):this._shimmedLocalStreams[s.id]=[s,a],a};const n=t.RTCPeerConnection.prototype.addStream;t.RTCPeerConnection.prototype.addStream=function(o){this._shimmedLocalStreams=this._shimmedLocalStreams||{},o.getTracks().forEach(c=>{if(this.getSenders().find(u=>u.track===c))throw new DOMException("Track already exists.","InvalidAccessError")});const s=this.getSenders();n.apply(this,arguments);const a=this.getSenders().filter(c=>s.indexOf(c)===-1);this._shimmedLocalStreams[o.id]=[o].concat(a)};const i=t.RTCPeerConnection.prototype.removeStream;t.RTCPeerConnection.prototype.removeStream=function(o){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},delete this._shimmedLocalStreams[o.id],i.apply(this,arguments)};const r=t.RTCPeerConnection.prototype.removeTrack;t.RTCPeerConnection.prototype.removeTrack=function(o){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},o&&Object.keys(this._shimmedLocalStreams).forEach(s=>{const a=this._shimmedLocalStreams[s].indexOf(o);a!==-1&&this._shimmedLocalStreams[s].splice(a,1),this._shimmedLocalStreams[s].length===1&&delete this._shimmedLocalStreams[s]}),r.apply(this,arguments)}}function EC(t,e){if(!t.RTCPeerConnection)return;if(t.RTCPeerConnection.prototype.addTrack&&e.version>=65)return _C(t);const n=t.RTCPeerConnection.prototype.getLocalStreams;t.RTCPeerConnection.prototype.getLocalStreams=function(){const c=n.apply(this);return this._reverseStreams=this._reverseStreams||{},c.map(d=>this._reverseStreams[d.id])};const i=t.RTCPeerConnection.prototype.addStream;t.RTCPeerConnection.prototype.addStream=function(c){if(this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},c.getTracks().forEach(d=>{if(this.getSenders().find(l=>l.track===d))throw new DOMException("Track already exists.","InvalidAccessError")}),!this._reverseStreams[c.id]){const d=new t.MediaStream(c.getTracks());this._streams[c.id]=d,this._reverseStreams[d.id]=c,c=d}i.apply(this,[c])};const r=t.RTCPeerConnection.prototype.removeStream;function o(c,d){let u=d.sdp;return Object.keys(c._reverseStreams||[]).forEach(l=>{const p=c._reverseStreams[l],f=c._streams[p.id];u=u.replace(new RegExp(f.id,"g"),p.id)}),new RTCSessionDescription({type:d.type,sdp:u})}t.RTCPeerConnection.prototype.removeStream=function(c){this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},r.apply(this,[this._streams[c.id]||c]),delete this._reverseStreams[this._streams[c.id]?this._streams[c.id].id:c.id],delete this._streams[c.id]},t.RTCPeerConnection.prototype.addTrack=function(c,d){if(this.signalingState==="closed")throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");const u=[].slice.call(arguments,1);if(u.length!==1||!u[0].getTracks().find(f=>f===c))throw new DOMException("The adapter.js addTrack polyfill only supports a single  stream which is associated with the specified track.","NotSupportedError");if(this.getSenders().find(f=>f.track===c))throw new DOMException("Track already exists.","InvalidAccessError");this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{};const p=this._streams[d.id];if(p)p.addTrack(c),ot.resolve().then(()=>{this.dispatchEvent(new Event("negotiationneeded"))});else{const f=new t.MediaStream([c]);this._streams[d.id]=f,this._reverseStreams[f.id]=d,this.addStream(f)}return this.getSenders().find(f=>f.track===c)},["createOffer","createAnswer"].forEach(function(c){const d=t.RTCPeerConnection.prototype[c],u={[c](){const l=arguments;return arguments.length&&typeof arguments[0]=="function"?d.apply(this,[p=>{const f=o(this,p);l[0].apply(null,[f])},p=>{l[1]&&l[1].apply(null,p)},arguments[2]]):d.apply(this,arguments).then(p=>o(this,p))}};t.RTCPeerConnection.prototype[c]=u[c]});const s=t.RTCPeerConnection.prototype.setLocalDescription;t.RTCPeerConnection.prototype.setLocalDescription=function(){return arguments.length&&arguments[0].type?(arguments[0]=function(c,d){let u=d.sdp;return Object.keys(c._reverseStreams||[]).forEach(l=>{const p=c._reverseStreams[l],f=c._streams[p.id];u=u.replace(new RegExp(p.id,"g"),f.id)}),new RTCSessionDescription({type:d.type,sdp:u})}(this,arguments[0]),s.apply(this,arguments)):s.apply(this,arguments)};const a=Object.getOwnPropertyDescriptor(t.RTCPeerConnection.prototype,"localDescription");Object.defineProperty(t.RTCPeerConnection.prototype,"localDescription",{get(){const c=a.get.apply(this);return c.type===""?c:o(this,c)}}),t.RTCPeerConnection.prototype.removeTrack=function(c){if(this.signalingState==="closed")throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");if(!c._pc)throw new DOMException("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.","TypeError");if(c._pc!==this)throw new DOMException("Sender was not created by this connection.","InvalidAccessError");let d;this._streams=this._streams||{},Object.keys(this._streams).forEach(u=>{this._streams[u].getTracks().find(l=>c.track===l)&&(d=this._streams[u])}),d&&(d.getTracks().length===1?this.removeStream(this._reverseStreams[d.id]):d.removeTrack(c.track),this.dispatchEvent(new Event("negotiationneeded")))}}function kE(t,e){!t.RTCPeerConnection&&t.webkitRTCPeerConnection&&(t.RTCPeerConnection=t.webkitRTCPeerConnection),t.RTCPeerConnection&&e.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(n){const i=t.RTCPeerConnection.prototype[n],r={[n](){return arguments[0]=new(n==="addIceCandidate"?t.RTCIceCandidate:t.RTCSessionDescription)(arguments[0]),i.apply(this,arguments)}};t.RTCPeerConnection.prototype[n]=r[n]})}function mC(t,e){ba(t,"negotiationneeded",n=>{const i=n.target;if(!(e.version<72||i.getConfiguration&&i.getConfiguration().sdpSemantics==="plan-b")||i.signalingState==="stable")return n})}var gC=Object.freeze({__proto__:null,fixNegotiationNeeded:mC,shimAddTrackRemoveTrack:EC,shimAddTrackRemoveTrackWithNative:_C,shimGetDisplayMedia:function(t,e){t.navigator.mediaDevices&&"getDisplayMedia"in t.navigator.mediaDevices||t.navigator.mediaDevices&&(typeof e=="function"?t.navigator.mediaDevices.getDisplayMedia=function(n){return e(n).then(i=>{const r=n.video&&n.video.width,o=n.video&&n.video.height,s=n.video&&n.video.frameRate;return n.video={mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:i,maxFrameRate:s||3}},r&&(n.video.mandatory.maxWidth=r),o&&(n.video.mandatory.maxHeight=o),t.navigator.mediaDevices.getUserMedia(n)})}:console.error("shimGetDisplayMedia: getSourceId argument is not a function"))},shimGetSendersWithDtmf:hC,shimGetStats:pC,shimGetUserMedia:dC,shimMediaStream:uC,shimOnTrack:lC,shimPeerConnection:kE,shimSenderReceiverGetStats:fC});function TC(t,e){const n=t&&t.navigator,i=t&&t.MediaStreamTrack;if(n.getUserMedia=function(r,o,s){D_("navigator.getUserMedia","navigator.mediaDevices.getUserMedia"),n.mediaDevices.getUserMedia(r).then(o,s)},!(e.version>55&&"autoGainControl"in n.mediaDevices.getSupportedConstraints())){const r=function(s,a,c){a in s&&!(c in s)&&(s[c]=s[a],delete s[a])},o=n.mediaDevices.getUserMedia.bind(n.mediaDevices);if(n.mediaDevices.getUserMedia=function(s){return typeof s=="object"&&typeof s.audio=="object"&&(s=JSON.parse(JSON.stringify(s)),r(s.audio,"autoGainControl","mozAutoGainControl"),r(s.audio,"noiseSuppression","mozNoiseSuppression")),o(s)},i&&i.prototype.getSettings){const s=i.prototype.getSettings;i.prototype.getSettings=function(){const a=s.apply(this,arguments);return r(a,"mozAutoGainControl","autoGainControl"),r(a,"mozNoiseSuppression","noiseSuppression"),a}}if(i&&i.prototype.applyConstraints){const s=i.prototype.applyConstraints;i.prototype.applyConstraints=function(a){return this.kind==="audio"&&typeof a=="object"&&(a=JSON.parse(JSON.stringify(a)),r(a,"autoGainControl","mozAutoGainControl"),r(a,"noiseSuppression","mozNoiseSuppression")),s.apply(this,[a])}}}}function SC(t){typeof t=="object"&&t.RTCTrackEvent&&"receiver"in t.RTCTrackEvent.prototype&&!("transceiver"in t.RTCTrackEvent.prototype)&&Object.defineProperty(t.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function ME(t,e){if(typeof t!="object"||!t.RTCPeerConnection&&!t.mozRTCPeerConnection)return;!t.RTCPeerConnection&&t.mozRTCPeerConnection&&(t.RTCPeerConnection=t.mozRTCPeerConnection),e.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(r){const o=t.RTCPeerConnection.prototype[r],s={[r](){return arguments[0]=new(r==="addIceCandidate"?t.RTCIceCandidate:t.RTCSessionDescription)(arguments[0]),o.apply(this,arguments)}};t.RTCPeerConnection.prototype[r]=s[r]});const n={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"},i=t.RTCPeerConnection.prototype.getStats;t.RTCPeerConnection.prototype.getStats=function(){const[r,o,s]=arguments;return i.apply(this,[r||null]).then(a=>{if(e.version<53&&!o)try{a.forEach(c=>{c.type=n[c.type]||c.type})}catch(c){if(c.name!=="TypeError")throw c;a.forEach((d,u)=>{a.set(u,Object.assign({},d,{type:n[d.type]||d.type}))})}return a}).then(o,s)}}function RC(t){if(typeof t!="object"||!t.RTCPeerConnection||!t.RTCRtpSender||t.RTCRtpSender&&"getStats"in t.RTCRtpSender.prototype)return;const e=t.RTCPeerConnection.prototype.getSenders;e&&(t.RTCPeerConnection.prototype.getSenders=function(){const i=e.apply(this,[]);return i.forEach(r=>r._pc=this),i});const n=t.RTCPeerConnection.prototype.addTrack;n&&(t.RTCPeerConnection.prototype.addTrack=function(){const i=n.apply(this,arguments);return i._pc=this,i}),t.RTCRtpSender.prototype.getStats=function(){return this.track?this._pc.getStats(this.track):ot.resolve(new Map)}}function CC(t){if(typeof t!="object"||!t.RTCPeerConnection||!t.RTCRtpSender||t.RTCRtpSender&&"getStats"in t.RTCRtpReceiver.prototype)return;const e=t.RTCPeerConnection.prototype.getReceivers;e&&(t.RTCPeerConnection.prototype.getReceivers=function(){const n=e.apply(this,[]);return n.forEach(i=>i._pc=this),n}),ba(t,"track",n=>(n.receiver._pc=n.srcElement,n)),t.RTCRtpReceiver.prototype.getStats=function(){return this._pc.getStats(this.track)}}function vC(t){t.RTCPeerConnection&&!("removeStream"in t.RTCPeerConnection.prototype)&&(t.RTCPeerConnection.prototype.removeStream=function(e){D_("removeStream","removeTrack"),this.getSenders().forEach(n=>{var i;n.track&&it(i=e.getTracks()).call(i,n.track)&&this.removeTrack(n)})})}function yC(t){t.DataChannel&&!t.RTCDataChannel&&(t.RTCDataChannel=t.DataChannel)}function IC(t){if(typeof t!="object"||!t.RTCPeerConnection)return;const e=t.RTCPeerConnection.prototype.addTransceiver;e&&(t.RTCPeerConnection.prototype.addTransceiver=function(){this.setParametersPromises=[];let n=arguments[1]&&arguments[1].sendEncodings;n===void 0&&(n=[]),n=[...n];const i=n.length>0;i&&n.forEach(o=>{if("rid"in o&&!/^[a-z0-9]{0,16}$/i.test(o.rid))throw new TypeError("Invalid RID value provided.");if("scaleResolutionDownBy"in o&&!(parseFloat(o.scaleResolutionDownBy)>=1))throw new RangeError("scale_resolution_down_by must be >= 1.0");if("maxFramerate"in o&&!(parseFloat(o.maxFramerate)>=0))throw new RangeError("max_framerate must be >= 0.0")});const r=e.apply(this,arguments);if(i){const{sender:o}=r,s=o.getParameters();(!("encodings"in s)||s.encodings.length===1&&Object.keys(s.encodings[0]).length===0)&&(s.encodings=n,o.sendEncodings=n,this.setParametersPromises.push(o.setParameters(s).then(()=>{delete o.sendEncodings}).catch(()=>{delete o.sendEncodings})))}return r})}function bC(t){if(typeof t!="object"||!t.RTCRtpSender)return;const e=t.RTCRtpSender.prototype.getParameters;e&&(t.RTCRtpSender.prototype.getParameters=function(){const n=e.apply(this,arguments);return"encodings"in n||(n.encodings=[].concat(this.sendEncodings||[{}])),n})}function AC(t){if(typeof t!="object"||!t.RTCPeerConnection)return;const e=t.RTCPeerConnection.prototype.createOffer;t.RTCPeerConnection.prototype.createOffer=function(){return this.setParametersPromises&&this.setParametersPromises.length?ot.all(this.setParametersPromises).then(()=>e.apply(this,arguments)).finally(()=>{this.setParametersPromises=[]}):e.apply(this,arguments)}}function wC(t){if(typeof t!="object"||!t.RTCPeerConnection)return;const e=t.RTCPeerConnection.prototype.createAnswer;t.RTCPeerConnection.prototype.createAnswer=function(){return this.setParametersPromises&&this.setParametersPromises.length?ot.all(this.setParametersPromises).then(()=>e.apply(this,arguments)).finally(()=>{this.setParametersPromises=[]}):e.apply(this,arguments)}}var OC=Object.freeze({__proto__:null,shimAddTransceiver:IC,shimCreateAnswer:wC,shimCreateOffer:AC,shimGetDisplayMedia:function(t,e){t.navigator.mediaDevices&&"getDisplayMedia"in t.navigator.mediaDevices||t.navigator.mediaDevices&&(t.navigator.mediaDevices.getDisplayMedia=function(n){if(!n||!n.video){const i=new DOMException("getDisplayMedia without video constraints is undefined");return i.name="NotFoundError",i.code=8,ot.reject(i)}return n.video===!0?n.video={mediaSource:e}:n.video.mediaSource=e,t.navigator.mediaDevices.getUserMedia(n)})},shimGetParameters:bC,shimGetUserMedia:TC,shimOnTrack:SC,shimPeerConnection:ME,shimRTCDataChannel:yC,shimReceiverGetStats:CC,shimRemoveStream:vC,shimSenderGetStats:RC});function NC(t){if(typeof t=="object"&&t.RTCPeerConnection){if("getLocalStreams"in t.RTCPeerConnection.prototype||(t.RTCPeerConnection.prototype.getLocalStreams=function(){return this._localStreams||(this._localStreams=[]),this._localStreams}),!("addStream"in t.RTCPeerConnection.prototype)){const e=t.RTCPeerConnection.prototype.addTrack;t.RTCPeerConnection.prototype.addStream=function(n){var i;this._localStreams||(this._localStreams=[]),it(i=this._localStreams).call(i,n)||this._localStreams.push(n),n.getAudioTracks().forEach(r=>e.call(this,r,n)),n.getVideoTracks().forEach(r=>e.call(this,r,n))},t.RTCPeerConnection.prototype.addTrack=function(n){for(var i=arguments.length,r=new Array(i>1?i-1:0),o=1;o<i;o++)r[o-1]=arguments[o];return r&&r.forEach(s=>{var a;this._localStreams?it(a=this._localStreams).call(a,s)||this._localStreams.push(s):this._localStreams=[s]}),e.apply(this,arguments)}}"removeStream"in t.RTCPeerConnection.prototype||(t.RTCPeerConnection.prototype.removeStream=function(e){this._localStreams||(this._localStreams=[]);const n=this._localStreams.indexOf(e);if(n===-1)return;this._localStreams.splice(n,1);const i=e.getTracks();this.getSenders().forEach(r=>{it(i).call(i,r.track)&&this.removeTrack(r)})})}}function DC(t){if(typeof t=="object"&&t.RTCPeerConnection&&("getRemoteStreams"in t.RTCPeerConnection.prototype||(t.RTCPeerConnection.prototype.getRemoteStreams=function(){return this._remoteStreams?this._remoteStreams:[]}),!("onaddstream"in t.RTCPeerConnection.prototype))){Object.defineProperty(t.RTCPeerConnection.prototype,"onaddstream",{get(){return this._onaddstream},set(n){this._onaddstream&&(this.removeEventListener("addstream",this._onaddstream),this.removeEventListener("track",this._onaddstreampoly)),this.addEventListener("addstream",this._onaddstream=n),this.addEventListener("track",this._onaddstreampoly=i=>{i.streams.forEach(r=>{var o;if(this._remoteStreams||(this._remoteStreams=[]),it(o=this._remoteStreams).call(o,r))return;this._remoteStreams.push(r);const s=new Event("addstream");s.stream=r,this.dispatchEvent(s)})})}});const e=t.RTCPeerConnection.prototype.setRemoteDescription;t.RTCPeerConnection.prototype.setRemoteDescription=function(){const n=this;return this._onaddstreampoly||this.addEventListener("track",this._onaddstreampoly=function(i){i.streams.forEach(r=>{if(n._remoteStreams||(n._remoteStreams=[]),n._remoteStreams.indexOf(r)>=0)return;n._remoteStreams.push(r);const o=new Event("addstream");o.stream=r,n.dispatchEvent(o)})}),e.apply(n,arguments)}}}function PC(t){if(typeof t!="object"||!t.RTCPeerConnection)return;const e=t.RTCPeerConnection.prototype,n=e.createOffer,i=e.createAnswer,r=e.setLocalDescription,o=e.setRemoteDescription,s=e.addIceCandidate;e.createOffer=function(c,d){const u=arguments.length>=2?arguments[2]:arguments[0],l=n.apply(this,[u]);return d?(l.then(c,d),ot.resolve()):l},e.createAnswer=function(c,d){const u=arguments.length>=2?arguments[2]:arguments[0],l=i.apply(this,[u]);return d?(l.then(c,d),ot.resolve()):l};let a=function(c,d,u){const l=r.apply(this,[c]);return u?(l.then(d,u),ot.resolve()):l};e.setLocalDescription=a,a=function(c,d,u){const l=o.apply(this,[c]);return u?(l.then(d,u),ot.resolve()):l},e.setRemoteDescription=a,a=function(c,d,u){const l=s.apply(this,[c]);return u?(l.then(d,u),ot.resolve()):l},e.addIceCandidate=a}function LC(t){const e=t&&t.navigator;if(e.mediaDevices&&e.mediaDevices.getUserMedia){const n=e.mediaDevices,i=n.getUserMedia.bind(n);e.mediaDevices.getUserMedia=r=>i(kC(r))}!e.getUserMedia&&e.mediaDevices&&e.mediaDevices.getUserMedia&&(e.getUserMedia=function(n,i,r){e.mediaDevices.getUserMedia(n).then(i,r)}.bind(e))}function kC(t){return t&&t.video!==void 0?Object.assign({},t,{video:fS(t.video)}):t}function MC(t){if(!t.RTCPeerConnection)return;const e=t.RTCPeerConnection;t.RTCPeerConnection=function(n,i){if(n&&n.iceServers){const r=[];for(let o=0;o<n.iceServers.length;o++){let s=n.iceServers[o];!s.hasOwnProperty("urls")&&s.hasOwnProperty("url")?(D_("RTCIceServer.url","RTCIceServer.urls"),s=JSON.parse(JSON.stringify(s)),s.urls=s.url,delete s.url,r.push(s)):r.push(n.iceServers[o])}n.iceServers=r}return new e(n,i)},t.RTCPeerConnection.prototype=e.prototype,"generateCertificate"in e&&Object.defineProperty(t.RTCPeerConnection,"generateCertificate",{get:()=>e.generateCertificate})}function UC(t){typeof t=="object"&&t.RTCTrackEvent&&"receiver"in t.RTCTrackEvent.prototype&&!("transceiver"in t.RTCTrackEvent.prototype)&&Object.defineProperty(t.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function xC(t){const e=t.RTCPeerConnection.prototype.createOffer;t.RTCPeerConnection.prototype.createOffer=function(n){if(n){n.offerToReceiveAudio!==void 0&&(n.offerToReceiveAudio=!!n.offerToReceiveAudio);const i=this.getTransceivers().find(o=>o.receiver.track.kind==="audio");n.offerToReceiveAudio===!1&&i?i.direction==="sendrecv"?i.setDirection?i.setDirection("sendonly"):i.direction="sendonly":i.direction==="recvonly"&&(i.setDirection?i.setDirection("inactive"):i.direction="inactive"):n.offerToReceiveAudio!==!0||i||this.addTransceiver("audio",{direction:"recvonly"}),n.offerToReceiveVideo!==void 0&&(n.offerToReceiveVideo=!!n.offerToReceiveVideo);const r=this.getTransceivers().find(o=>o.receiver.track.kind==="video");n.offerToReceiveVideo===!1&&r?r.direction==="sendrecv"?r.setDirection?r.setDirection("sendonly"):r.direction="sendonly":r.direction==="recvonly"&&(r.setDirection?r.setDirection("inactive"):r.direction="inactive"):n.offerToReceiveVideo!==!0||r||this.addTransceiver("video",{direction:"recvonly"})}return e.apply(this,arguments)}}function VC(t){typeof t!="object"||t.AudioContext||(t.AudioContext=t.webkitAudioContext)}var FC=Object.freeze({__proto__:null,shimAudioContext:VC,shimCallbacksAPI:PC,shimConstraints:kC,shimCreateOfferLegacy:xC,shimGetUserMedia:LC,shimLocalStreamsAPI:NC,shimRTCIceServerUrls:MC,shimRemoteStreamsAPI:DC,shimTrackEventTransceiver:UC}),jC=`	
\v\f\r \xA0\u1680\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200A\u202F\u205F\u3000\u2028\u2029\uFEFF`,dU=ws,uU=x,UE=jC,BC=Ge("".replace),lU=RegExp("^["+UE+"]+"),hU=RegExp("(^|[^"+UE+"])["+UE+"]+$"),xE=function(t){return function(e){var n=uU(dU(e));return 1&t&&(n=BC(n,lU,"")),2&t&&(n=BC(n,hU,"$1")),n}},pU={start:xE(1),end:xE(2),trim:xE(3)},fU=WS.PROPER,_U=Pt,GC=jC,EU=pU.trim;$t({target:"String",proto:!0,forced:function(t){return _U(function(){return!!GC[t]()||"\u200B\x85\u180E"[t]()!=="\u200B\x85\u180E"||fU&&GC[t].name!==t})}("trim")},{trim:function(){return EU(this)}});var mU=oi("String").trim,gU=Jn,TU=mU,VE=String.prototype,SU=function(t){var e=t.trim;return typeof t=="string"||t===VE||gU(VE,t)&&e===VE.trim?TU:e},si=Dt(SU),WC={exports:{}};(function(t){const e={generateIdentifier:function(){return Math.random().toString(36).substring(2,12)}};e.localCName=e.generateIdentifier(),e.splitLines=function(n){return n.trim().split(`
`).map(i=>i.trim())},e.splitSections=function(n){return n.split(`
m=`).map((i,r)=>(r>0?"m="+i:i).trim()+`\r
`)},e.getDescription=function(n){const i=e.splitSections(n);return i&&i[0]},e.getMediaSections=function(n){const i=e.splitSections(n);return i.shift(),i},e.matchPrefix=function(n,i){return e.splitLines(n).filter(r=>r.indexOf(i)===0)},e.parseCandidate=function(n){let i;i=n.indexOf("a=candidate:")===0?n.substring(12).split(" "):n.substring(10).split(" ");const r={foundation:i[0],component:{1:"rtp",2:"rtcp"}[i[1]]||i[1],protocol:i[2].toLowerCase(),priority:parseInt(i[3],10),ip:i[4],address:i[4],port:parseInt(i[5],10),type:i[7]};for(let o=8;o<i.length;o+=2)switch(i[o]){case"raddr":r.relatedAddress=i[o+1];break;case"rport":r.relatedPort=parseInt(i[o+1],10);break;case"tcptype":r.tcpType=i[o+1];break;case"ufrag":r.ufrag=i[o+1],r.usernameFragment=i[o+1];break;default:r[i[o]]===void 0&&(r[i[o]]=i[o+1])}return r},e.writeCandidate=function(n){const i=[];i.push(n.foundation);const r=n.component;r==="rtp"?i.push(1):r==="rtcp"?i.push(2):i.push(r),i.push(n.protocol.toUpperCase()),i.push(n.priority),i.push(n.address||n.ip),i.push(n.port);const o=n.type;return i.push("typ"),i.push(o),o!=="host"&&n.relatedAddress&&n.relatedPort&&(i.push("raddr"),i.push(n.relatedAddress),i.push("rport"),i.push(n.relatedPort)),n.tcpType&&n.protocol.toLowerCase()==="tcp"&&(i.push("tcptype"),i.push(n.tcpType)),(n.usernameFragment||n.ufrag)&&(i.push("ufrag"),i.push(n.usernameFragment||n.ufrag)),"candidate:"+i.join(" ")},e.parseIceOptions=function(n){return n.substring(14).split(" ")},e.parseRtpMap=function(n){let i=n.substring(9).split(" ");const r={payloadType:parseInt(i.shift(),10)};return i=i[0].split("/"),r.name=i[0],r.clockRate=parseInt(i[1],10),r.channels=i.length===3?parseInt(i[2],10):1,r.numChannels=r.channels,r},e.writeRtpMap=function(n){let i=n.payloadType;n.preferredPayloadType!==void 0&&(i=n.preferredPayloadType);const r=n.channels||n.numChannels||1;return"a=rtpmap:"+i+" "+n.name+"/"+n.clockRate+(r!==1?"/"+r:"")+`\r
`},e.parseExtmap=function(n){const i=n.substring(9).split(" ");return{id:parseInt(i[0],10),direction:i[0].indexOf("/")>0?i[0].split("/")[1]:"sendrecv",uri:i[1],attributes:i.slice(2).join(" ")}},e.writeExtmap=function(n){return"a=extmap:"+(n.id||n.preferredId)+(n.direction&&n.direction!=="sendrecv"?"/"+n.direction:"")+" "+n.uri+(n.attributes?" "+n.attributes:"")+`\r
`},e.parseFmtp=function(n){const i={};let r;const o=n.substring(n.indexOf(" ")+1).split(";");for(let s=0;s<o.length;s++)r=o[s].trim().split("="),i[r[0].trim()]=r[1];return i},e.writeFmtp=function(n){let i="",r=n.payloadType;if(n.preferredPayloadType!==void 0&&(r=n.preferredPayloadType),n.parameters&&Object.keys(n.parameters).length){const o=[];Object.keys(n.parameters).forEach(s=>{n.parameters[s]!==void 0?o.push(s+"="+n.parameters[s]):o.push(s)}),i+="a=fmtp:"+r+" "+o.join(";")+`\r
`}return i},e.parseRtcpFb=function(n){const i=n.substring(n.indexOf(" ")+1).split(" ");return{type:i.shift(),parameter:i.join(" ")}},e.writeRtcpFb=function(n){let i="",r=n.payloadType;return n.preferredPayloadType!==void 0&&(r=n.preferredPayloadType),n.rtcpFeedback&&n.rtcpFeedback.length&&n.rtcpFeedback.forEach(o=>{i+="a=rtcp-fb:"+r+" "+o.type+(o.parameter&&o.parameter.length?" "+o.parameter:"")+`\r
`}),i},e.parseSsrcMedia=function(n){const i=n.indexOf(" "),r={ssrc:parseInt(n.substring(7,i),10)},o=n.indexOf(":",i);return o>-1?(r.attribute=n.substring(i+1,o),r.value=n.substring(o+1)):r.attribute=n.substring(i+1),r},e.parseSsrcGroup=function(n){const i=n.substring(13).split(" ");return{semantics:i.shift(),ssrcs:i.map(r=>parseInt(r,10))}},e.getMid=function(n){const i=e.matchPrefix(n,"a=mid:")[0];if(i)return i.substring(6)},e.parseFingerprint=function(n){const i=n.substring(14).split(" ");return{algorithm:i[0].toLowerCase(),value:i[1].toUpperCase()}},e.getDtlsParameters=function(n,i){return{role:"auto",fingerprints:e.matchPrefix(n+i,"a=fingerprint:").map(e.parseFingerprint)}},e.writeDtlsParameters=function(n,i){let r="a=setup:"+i+`\r
`;return n.fingerprints.forEach(o=>{r+="a=fingerprint:"+o.algorithm+" "+o.value+`\r
`}),r},e.parseCryptoLine=function(n){const i=n.substring(9).split(" ");return{tag:parseInt(i[0],10),cryptoSuite:i[1],keyParams:i[2],sessionParams:i.slice(3)}},e.writeCryptoLine=function(n){return"a=crypto:"+n.tag+" "+n.cryptoSuite+" "+(typeof n.keyParams=="object"?e.writeCryptoKeyParams(n.keyParams):n.keyParams)+(n.sessionParams?" "+n.sessionParams.join(" "):"")+`\r
`},e.parseCryptoKeyParams=function(n){if(n.indexOf("inline:")!==0)return null;const i=n.substring(7).split("|");return{keyMethod:"inline",keySalt:i[0],lifeTime:i[1],mkiValue:i[2]?i[2].split(":")[0]:void 0,mkiLength:i[2]?i[2].split(":")[1]:void 0}},e.writeCryptoKeyParams=function(n){return n.keyMethod+":"+n.keySalt+(n.lifeTime?"|"+n.lifeTime:"")+(n.mkiValue&&n.mkiLength?"|"+n.mkiValue+":"+n.mkiLength:"")},e.getCryptoParameters=function(n,i){return e.matchPrefix(n+i,"a=crypto:").map(e.parseCryptoLine)},e.getIceParameters=function(n,i){const r=e.matchPrefix(n+i,"a=ice-ufrag:")[0],o=e.matchPrefix(n+i,"a=ice-pwd:")[0];return r&&o?{usernameFragment:r.substring(12),password:o.substring(10)}:null},e.writeIceParameters=function(n){let i="a=ice-ufrag:"+n.usernameFragment+`\r
a=ice-pwd:`+n.password+`\r
`;return n.iceLite&&(i+=`a=ice-lite\r
`),i},e.parseRtpParameters=function(n){const i={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]},r=e.splitLines(n)[0].split(" ");i.profile=r[2];for(let s=3;s<r.length;s++){const a=r[s],c=e.matchPrefix(n,"a=rtpmap:"+a+" ")[0];if(c){const d=e.parseRtpMap(c),u=e.matchPrefix(n,"a=fmtp:"+a+" ");switch(d.parameters=u.length?e.parseFmtp(u[0]):{},d.rtcpFeedback=e.matchPrefix(n,"a=rtcp-fb:"+a+" ").map(e.parseRtcpFb),i.codecs.push(d),d.name.toUpperCase()){case"RED":case"ULPFEC":i.fecMechanisms.push(d.name.toUpperCase())}}}e.matchPrefix(n,"a=extmap:").forEach(s=>{i.headerExtensions.push(e.parseExtmap(s))});const o=e.matchPrefix(n,"a=rtcp-fb:* ").map(e.parseRtcpFb);return i.codecs.forEach(s=>{o.forEach(a=>{s.rtcpFeedback.find(c=>c.type===a.type&&c.parameter===a.parameter)||s.rtcpFeedback.push(a)})}),i},e.writeRtpDescription=function(n,i){let r="";r+="m="+n+" ",r+=i.codecs.length>0?"9":"0",r+=" "+(i.profile||"UDP/TLS/RTP/SAVPF")+" ",r+=i.codecs.map(s=>s.preferredPayloadType!==void 0?s.preferredPayloadType:s.payloadType).join(" ")+`\r
`,r+=`c=IN IP4 0.0.0.0\r
`,r+=`a=rtcp:9 IN IP4 0.0.0.0\r
`,i.codecs.forEach(s=>{r+=e.writeRtpMap(s),r+=e.writeFmtp(s),r+=e.writeRtcpFb(s)});let o=0;return i.codecs.forEach(s=>{s.maxptime>o&&(o=s.maxptime)}),o>0&&(r+="a=maxptime:"+o+`\r
`),i.headerExtensions&&i.headerExtensions.forEach(s=>{r+=e.writeExtmap(s)}),r},e.parseRtpEncodingParameters=function(n){const i=[],r=e.parseRtpParameters(n),o=r.fecMechanisms.indexOf("RED")!==-1,s=r.fecMechanisms.indexOf("ULPFEC")!==-1,a=e.matchPrefix(n,"a=ssrc:").map(p=>e.parseSsrcMedia(p)).filter(p=>p.attribute==="cname"),c=a.length>0&&a[0].ssrc;let d;const u=e.matchPrefix(n,"a=ssrc-group:FID").map(p=>p.substring(17).split(" ").map(f=>parseInt(f,10)));u.length>0&&u[0].length>1&&u[0][0]===c&&(d=u[0][1]),r.codecs.forEach(p=>{if(p.name.toUpperCase()==="RTX"&&p.parameters.apt){let f={ssrc:c,codecPayloadType:parseInt(p.parameters.apt,10)};c&&d&&(f.rtx={ssrc:d}),i.push(f),o&&(f=JSON.parse(JSON.stringify(f)),f.fec={ssrc:c,mechanism:s?"red+ulpfec":"red"},i.push(f))}}),i.length===0&&c&&i.push({ssrc:c});let l=e.matchPrefix(n,"b=");return l.length&&(l=l[0].indexOf("b=TIAS:")===0?parseInt(l[0].substring(7),10):l[0].indexOf("b=AS:")===0?1e3*parseInt(l[0].substring(5),10)*.95-16e3:void 0,i.forEach(p=>{p.maxBitrate=l})),i},e.parseRtcpParameters=function(n){const i={},r=e.matchPrefix(n,"a=ssrc:").map(a=>e.parseSsrcMedia(a)).filter(a=>a.attribute==="cname")[0];r&&(i.cname=r.value,i.ssrc=r.ssrc);const o=e.matchPrefix(n,"a=rtcp-rsize");i.reducedSize=o.length>0,i.compound=o.length===0;const s=e.matchPrefix(n,"a=rtcp-mux");return i.mux=s.length>0,i},e.writeRtcpParameters=function(n){let i="";return n.reducedSize&&(i+=`a=rtcp-rsize\r
`),n.mux&&(i+=`a=rtcp-mux\r
`),n.ssrc!==void 0&&n.cname&&(i+="a=ssrc:"+n.ssrc+" cname:"+n.cname+`\r
`),i},e.parseMsid=function(n){let i;const r=e.matchPrefix(n,"a=msid:");if(r.length===1)return i=r[0].substring(7).split(" "),{stream:i[0],track:i[1]};const o=e.matchPrefix(n,"a=ssrc:").map(s=>e.parseSsrcMedia(s)).filter(s=>s.attribute==="msid");return o.length>0?(i=o[0].value.split(" "),{stream:i[0],track:i[1]}):void 0},e.parseSctpDescription=function(n){const i=e.parseMLine(n),r=e.matchPrefix(n,"a=max-message-size:");let o;r.length>0&&(o=parseInt(r[0].substring(19),10)),isNaN(o)&&(o=65536);const s=e.matchPrefix(n,"a=sctp-port:");if(s.length>0)return{port:parseInt(s[0].substring(12),10),protocol:i.fmt,maxMessageSize:o};const a=e.matchPrefix(n,"a=sctpmap:");if(a.length>0){const c=a[0].substring(10).split(" ");return{port:parseInt(c[0],10),protocol:c[1],maxMessageSize:o}}},e.writeSctpDescription=function(n,i){let r=[];return r=n.protocol!=="DTLS/SCTP"?["m="+n.kind+" 9 "+n.protocol+" "+i.protocol+`\r
`,`c=IN IP4 0.0.0.0\r
`,"a=sctp-port:"+i.port+`\r
`]:["m="+n.kind+" 9 "+n.protocol+" "+i.port+`\r
`,`c=IN IP4 0.0.0.0\r
`,"a=sctpmap:"+i.port+" "+i.protocol+` 65535\r
`],i.maxMessageSize!==void 0&&r.push("a=max-message-size:"+i.maxMessageSize+`\r
`),r.join("")},e.generateSessionId=function(){return Math.random().toString().substr(2,22)},e.writeSessionBoilerplate=function(n,i,r){let o;const s=i!==void 0?i:2;return o=n||e.generateSessionId(),`v=0\r
o=`+(r||"thisisadapterortc")+" "+o+" "+s+` IN IP4 127.0.0.1\r
s=-\r
t=0 0\r
`},e.getDirection=function(n,i){const r=e.splitLines(n);for(let o=0;o<r.length;o++)switch(r[o]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return r[o].substring(2)}return i?e.getDirection(i):"sendrecv"},e.getKind=function(n){return e.splitLines(n)[0].split(" ")[0].substring(2)},e.isRejected=function(n){return n.split(" ",2)[1]==="0"},e.parseMLine=function(n){const i=e.splitLines(n)[0].substring(2).split(" ");return{kind:i[0],port:parseInt(i[1],10),protocol:i[2],fmt:i.slice(3).join(" ")}},e.parseOLine=function(n){const i=e.matchPrefix(n,"o=")[0].substring(2).split(" ");return{username:i[0],sessionId:i[1],sessionVersion:parseInt(i[2],10),netType:i[3],addressType:i[4],address:i[5]}},e.isValidSDP=function(n){if(typeof n!="string"||n.length===0)return!1;const i=e.splitLines(n);for(let r=0;r<i.length;r++)if(i[r].length<2||i[r].charAt(1)!=="=")return!1;return!0},t.exports=e})(WC);var HC=WC.exports,jc=Dt(HC),RU=ge({__proto__:null,default:jc},[HC]);function tp(t){if(!t.RTCIceCandidate||t.RTCIceCandidate&&"foundation"in t.RTCIceCandidate.prototype)return;const e=t.RTCIceCandidate;t.RTCIceCandidate=function(n){if(typeof n=="object"&&n.candidate&&n.candidate.indexOf("a=")===0&&((n=JSON.parse(JSON.stringify(n))).candidate=n.candidate.substr(2)),n.candidate&&n.candidate.length){const i=new e(n),r=jc.parseCandidate(n.candidate),o=Object.assign(i,r);return o.toJSON=function(){return{candidate:o.candidate,sdpMid:o.sdpMid,sdpMLineIndex:o.sdpMLineIndex,usernameFragment:o.usernameFragment}},o}return new e(n)},t.RTCIceCandidate.prototype=e.prototype,ba(t,"icecandidate",n=>(n.candidate&&Object.defineProperty(n,"candidate",{value:new t.RTCIceCandidate(n.candidate),writable:"false"}),n))}function FE(t){!t.RTCIceCandidate||t.RTCIceCandidate&&"relayProtocol"in t.RTCIceCandidate.prototype||ba(t,"icecandidate",e=>{if(e.candidate){const n=jc.parseCandidate(e.candidate.candidate);n.type==="relay"&&(e.candidate.relayProtocol={0:"tls",1:"tcp",2:"udp"}[n.priority>>24])}return e})}function ep(t,e){if(!t.RTCPeerConnection)return;"sctp"in t.RTCPeerConnection.prototype||Object.defineProperty(t.RTCPeerConnection.prototype,"sctp",{get(){return this._sctp===void 0?null:this._sctp}});const n=function(a){if(!a||!a.sdp)return!1;const c=jc.splitSections(a.sdp);return c.shift(),c.some(d=>{const u=jc.parseMLine(d);return u&&u.kind==="application"&&u.protocol.indexOf("SCTP")!==-1})},i=function(a){const c=a.sdp.match(/mozilla...THIS_IS_SDPARTA-(\d+)/);if(c===null||c.length<2)return-1;const d=parseInt(c[1],10);return d!=d?-1:d},r=function(a){let c=65536;return e.browser==="firefox"&&(c=e.version<57?a===-1?16384:2147483637:e.version<60?e.version===57?65535:65536:2147483637),c},o=function(a,c){let d=65536;e.browser==="firefox"&&e.version===57&&(d=65535);const u=jc.matchPrefix(a.sdp,"a=max-message-size:");return u.length>0?d=parseInt(u[0].substr(19),10):e.browser==="firefox"&&c!==-1&&(d=2147483637),d},s=t.RTCPeerConnection.prototype.setRemoteDescription;t.RTCPeerConnection.prototype.setRemoteDescription=function(){if(this._sctp=null,e.browser==="chrome"&&e.version>=76){const{sdpSemantics:a}=this.getConfiguration();a==="plan-b"&&Object.defineProperty(this,"sctp",{get(){return this._sctp===void 0?null:this._sctp},enumerable:!0,configurable:!0})}if(n(arguments[0])){const a=i(arguments[0]),c=r(a),d=o(arguments[0],a);let u;u=c===0&&d===0?Number.POSITIVE_INFINITY:c===0||d===0?Math.max(c,d):Math.min(c,d);const l={};Object.defineProperty(l,"maxMessageSize",{get:()=>u}),this._sctp=l}return s.apply(this,arguments)}}function np(t){if(!t.RTCPeerConnection||!("createDataChannel"in t.RTCPeerConnection.prototype))return;function e(i,r){const o=i.send;i.send=function(){const s=arguments[0],a=s.length||s.size||s.byteLength;if(i.readyState==="open"&&r.sctp&&a>r.sctp.maxMessageSize)throw new TypeError("Message too large (can send a maximum of "+r.sctp.maxMessageSize+" bytes)");return o.apply(i,arguments)}}const n=t.RTCPeerConnection.prototype.createDataChannel;t.RTCPeerConnection.prototype.createDataChannel=function(){const i=n.apply(this,arguments);return e(i,this),i},ba(t,"datachannel",i=>(e(i.channel,i.target),i))}function jE(t){if(!t.RTCPeerConnection||"connectionState"in t.RTCPeerConnection.prototype)return;const e=t.RTCPeerConnection.prototype;Object.defineProperty(e,"connectionState",{get(){return{completed:"connected",checking:"connecting"}[this.iceConnectionState]||this.iceConnectionState},enumerable:!0,configurable:!0}),Object.defineProperty(e,"onconnectionstatechange",{get(){return this._onconnectionstatechange||null},set(n){this._onconnectionstatechange&&(this.removeEventListener("connectionstatechange",this._onconnectionstatechange),delete this._onconnectionstatechange),n&&this.addEventListener("connectionstatechange",this._onconnectionstatechange=n)},enumerable:!0,configurable:!0}),["setLocalDescription","setRemoteDescription"].forEach(n=>{const i=e[n];e[n]=function(){return this._connectionstatechangepoly||(this._connectionstatechangepoly=r=>{const o=r.target;if(o._lastConnectionState!==o.connectionState){o._lastConnectionState=o.connectionState;const s=new Event("connectionstatechange",r);o.dispatchEvent(s)}return r},this.addEventListener("iceconnectionstatechange",this._connectionstatechangepoly)),i.apply(this,arguments)}})}function BE(t,e){if(!t.RTCPeerConnection||e.browser==="chrome"&&e.version>=71||e.browser==="safari"&&e.version>=605)return;const n=t.RTCPeerConnection.prototype.setRemoteDescription;t.RTCPeerConnection.prototype.setRemoteDescription=function(i){if(i&&i.sdp&&i.sdp.indexOf(`
a=extmap-allow-mixed`)!==-1){const r=i.sdp.split(`
`).filter(o=>si(o).call(o)!=="a=extmap-allow-mixed").join(`
`);t.RTCSessionDescription&&i instanceof t.RTCSessionDescription?arguments[0]=new t.RTCSessionDescription({type:i.type,sdp:r}):i.sdp=r}return n.apply(this,arguments)}}function ip(t,e){if(!t.RTCPeerConnection||!t.RTCPeerConnection.prototype)return;const n=t.RTCPeerConnection.prototype.addIceCandidate;n&&n.length!==0&&(t.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?(e.browser==="chrome"&&e.version<78||e.browser==="firefox"&&e.version<68||e.browser==="safari")&&arguments[0]&&arguments[0].candidate===""?ot.resolve():n.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),ot.resolve())})}function rp(t,e){if(!t.RTCPeerConnection||!t.RTCPeerConnection.prototype)return;const n=t.RTCPeerConnection.prototype.setLocalDescription;n&&n.length!==0&&(t.RTCPeerConnection.prototype.setLocalDescription=function(){let i=arguments[0]||{};if(typeof i!="object"||i.type&&i.sdp)return n.apply(this,arguments);if(i={type:i.type,sdp:i.sdp},!i.type)switch(this.signalingState){case"stable":case"have-local-offer":case"have-remote-pranswer":i.type="offer";break;default:i.type="answer"}return i.sdp||i.type!=="offer"&&i.type!=="answer"?n.apply(this,[i]):(i.type==="offer"?this.createOffer:this.createAnswer).apply(this).then(r=>n.apply(this,[r]))})}var CU=Object.freeze({__proto__:null,removeExtmapAllowMixed:BE,shimAddIceCandidateNullOrEmpty:ip,shimConnectionState:jE,shimMaxMessageSize:ep,shimParameterlessSetLocalDescription:rp,shimRTCIceCandidate:tp,shimRTCIceCandidateRelayProtocol:FE,shimSendThrowTypeError:np});(function(){let{window:t}=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{shimChrome:!0,shimFirefox:!0,shimSafari:!0};const n=hS,i=function(o){const s={browser:null,version:null};if(o===void 0||!o.navigator)return s.browser="Not a browser.",s;const{navigator:a}=o;if(a.mozGetUserMedia)s.browser="firefox",s.version=Nh(a.userAgent,/Firefox\/(\d+)\./,1);else if(a.webkitGetUserMedia||o.isSecureContext===!1&&o.webkitRTCPeerConnection)s.browser="chrome",s.version=Nh(a.userAgent,/Chrom(e|ium)\/(\d+)\./,2);else{if(!o.RTCPeerConnection||!a.userAgent.match(/AppleWebKit\/(\d+)\./))return s.browser="Not a supported browser.",s;s.browser="safari",s.version=Nh(a.userAgent,/AppleWebKit\/(\d+)\./,1),s.supportsUnifiedPlan=o.RTCRtpTransceiver&&"currentDirection"in o.RTCRtpTransceiver.prototype}return s}(t),r={browserDetails:i,commonShim:CU,extractVersion:Nh,disableLog:TP,disableWarnings:SP,sdp:RU};switch(i.browser){case"chrome":if(!gC||!kE||!e.shimChrome)return n("Chrome shim is not included in this adapter release."),r;if(i.version===null)return n("Chrome shim can not determine version, not shimming."),r;n("adapter.js shimming chrome."),r.browserShim=gC,ip(t,i),rp(t),dC(t,i),uC(t),kE(t,i),lC(t),EC(t,i),hC(t),pC(t),fC(t),mC(t,i),tp(t),FE(t),jE(t),ep(t,i),np(t),BE(t,i);break;case"firefox":if(!OC||!ME||!e.shimFirefox)return n("Firefox shim is not included in this adapter release."),r;n("adapter.js shimming firefox."),r.browserShim=OC,ip(t,i),rp(t),TC(t,i),ME(t,i),SC(t),vC(t),RC(t),CC(t),yC(t),IC(t),bC(t),AC(t),wC(t),tp(t),jE(t),ep(t,i),np(t);break;case"safari":if(!FC||!e.shimSafari)return n("Safari shim is not included in this adapter release."),r;n("adapter.js shimming safari."),r.browserShim=FC,ip(t,i),rp(t),MC(t),xC(t),PC(t),NC(t),DC(t),UC(t),LC(t),VC(t),tp(t),FE(t),ep(t,i),np(t),BE(t,i);break;default:n("Unsupported browser!")}})({window:typeof window=="undefined"?void 0:window});var vU=oi("Array").keys,yU=Or,IU=Dn,bU=Jn,AU=vU,GE=Array.prototype,wU={DOMTokenList:!0,NodeList:!0},OU=function(t){var e=t.keys;return t===GE||bU(GE,t)&&e===GE.keys||IU(wU,yU(t))?AU:e},Xi=Dt(OU),KC=vo,NU=TypeError,DU=bo,PU=Fi,LU=Ro,op=function(t,e,n){var i=DU(e);i in t?PU.f(t,i,LU(0,n)):t[i]=n},qC=zi,kU=ri,MU=op,UU=Array,xU=Math.max,WE=function(t,e,n){for(var i=kU(t),r=qC(e,i),o=qC(n===void 0?i:n,i),s=UU(xU(o-r,0)),a=0;r<o;r++,a++)MU(s,a,t[r]);return s.length=a,s},YC=WE,VU=Math.floor,HE=function(t,e){var n=t.length,i=VU(n/2);return n<8?FU(t,e):jU(t,HE(YC(t,0,i),e),HE(YC(t,i),e),e)},FU=function(t,e){for(var n,i,r=t.length,o=1;o<r;){for(i=o,n=t[o];i&&e(t[i-1],n)>0;)t[i]=t[--i];i!==o++&&(t[i]=n)}return t},jU=function(t,e,n,i){for(var r=e.length,o=n.length,s=0,a=0;s<r||a<o;)t[s+a]=s<r&&a<o?i(e[s],n[a])<=0?e[s++]:n[a++]:s<r?e[s++]:n[a++];return t},zC=HE,JC=ns.match(/firefox\/(\d+)/i),BU=!!JC&&+JC[1],GU=/MSIE|Trident/.test(ns),XC=ns.match(/AppleWebKit\/(\d+)\./),WU=!!XC&&+XC[1],HU=$t,QC=Ge,KU=ii,qU=br,ZC=ri,YU=function(t,e){if(!delete t[e])throw NU("Cannot delete property "+KC(e)+" of "+KC(t))},$C=x,KE=Pt,zU=zC,JU=Oh,tv=BU,XU=GU,ev=Yi,nv=WU,Vs=[],iv=QC(Vs.sort),QU=QC(Vs.push),ZU=KE(function(){Vs.sort(void 0)}),$U=KE(function(){Vs.sort(null)}),tx=JU("sort"),rv=!KE(function(){if(ev)return ev<70;if(!(tv&&tv>3)){if(XU)return!0;if(nv)return nv<603;var t,e,n,i,r="";for(t=65;t<76;t++){switch(e=String.fromCharCode(t),t){case 66:case 69:case 70:case 72:n=3;break;case 68:case 71:n=4;break;default:n=2}for(i=0;i<47;i++)Vs.push({k:e+i,v:n})}for(Vs.sort(function(o,s){return s.v-o.v}),i=0;i<Vs.length;i++)e=Vs[i].k.charAt(0),r.charAt(r.length-1)!==e&&(r+=e);return r!=="DGBEFHACIJK"}});HU({target:"Array",proto:!0,forced:ZU||!$U||!tx||!rv},{sort:function(t){t!==void 0&&KU(t);var e=qU(this);if(rv)return t===void 0?iv(e):iv(e,t);var n,i,r=[],o=ZC(e);for(i=0;i<o;i++)i in e&&QU(r,e[i]);for(zU(r,function(s){return function(a,c){return c===void 0?-1:a===void 0?1:s!==void 0?+s(a,c)||0:$C(a)>$C(c)?1:-1}}(t)),n=ZC(r),i=0;i<n;)e[i]=r[i++];for(;i<o;)YU(e,i++);return e}});var ex=oi("Array").sort,nx=Jn,ix=ex,qE=Array.prototype,rx=function(t){var e=t.sort;return t===qE||nx(qE,t)&&e===qE.sort?ix:e},Du=Dt(rx),YE={exports:{}};(function(t,e){(function(n,i){var r="function",o="undefined",s="object",a="string",c="major",d="model",u="name",l="type",p="vendor",f="version",C="architecture",m="console",g="mobile",y="tablet",A="smarttv",k="wearable",M="embedded",V="Amazon",B="Apple",K="ASUS",Y="BlackBerry",J="Browser",lt="Chrome",Yt="Firefox",de="Google",Pe="Huawei",hn="LG",qe="Microsoft",Qr="Motorola",z="Opera",tt="Samsung",ft="Sharp",wt="Sony",oe="Xiaomi",st="Zebra",T="Facebook",D="Chromium OS",L="Mac OS",Q=function(sn){for(var Tn={},Ue=0;Ue<sn.length;Ue++)Tn[sn[Ue].toUpperCase()]=sn[Ue];return Tn},Ot=function(sn,Tn){return typeof sn===a&&me(Tn).indexOf(me(sn))!==-1},me=function(sn){return sn.toLowerCase()},In=function(sn,Tn){if(typeof sn===a)return sn=sn.replace(/^\s\s*/,""),typeof Tn===o?sn:sn.substring(0,350)},Ui=function(sn,Tn){for(var Ue,qi,Qo,an,se,xi,_a=0;_a<Tn.length&&!se;){var To=Tn[_a],rP=Tn[_a+1];for(Ue=qi=0;Ue<To.length&&!se&&To[Ue];)if(se=To[Ue++].exec(sn))for(Qo=0;Qo<rP.length;Qo++)xi=se[++qi],typeof(an=rP[Qo])===s&&an.length>0?an.length===2?typeof an[1]==r?this[an[0]]=an[1].call(this,xi):this[an[0]]=an[1]:an.length===3?typeof an[1]!==r||an[1].exec&&an[1].test?this[an[0]]=xi?xi.replace(an[1],an[2]):i:this[an[0]]=xi?an[1].call(this,xi,an[2]):i:an.length===4&&(this[an[0]]=xi?an[3].call(this,xi.replace(an[1],an[2])):i):this[an]=xi||i;_a+=2}},Is=function(sn,Tn){for(var Ue in Tn)if(typeof Tn[Ue]===s&&Tn[Ue].length>0){for(var qi=0;qi<Tn[Ue].length;qi++)if(Ot(Tn[Ue][qi],sn))return Ue==="?"?i:Ue}else if(Ot(Tn[Ue],sn))return Ue==="?"?i:Ue;return sn},$f={ME:"4.90","NT 3.11":"NT3.51","NT 4.0":"NT4.0",2e3:"NT 5.0",XP:["NT 5.1","NT 5.2"],Vista:"NT 6.0",7:"NT 6.1",8:"NT 6.2",8.1:"NT 6.3",10:["NT 6.4","NT 10.0"],RT:"ARM"},t_={browser:[[/\b(?:crmo|crios)\/([\w\.]+)/i],[f,[u,"Chrome"]],[/edg(?:e|ios|a)?\/([\w\.]+)/i],[f,[u,"Edge"]],[/(opera mini)\/([-\w\.]+)/i,/(opera [mobiletab]{3,6})\b.+version\/([-\w\.]+)/i,/(opera)(?:.+version\/|[\/ ]+)([\w\.]+)/i],[u,f],[/opios[\/ ]+([\w\.]+)/i],[f,[u,z+" Mini"]],[/\bopr\/([\w\.]+)/i],[f,[u,z]],[/(kindle)\/([\w\.]+)/i,/(lunascape|maxthon|netfront|jasmine|blazer)[\/ ]?([\w\.]*)/i,/(avant |iemobile|slim)(?:browser)?[\/ ]?([\w\.]*)/i,/(ba?idubrowser)[\/ ]?([\w\.]+)/i,/(?:ms|\()(ie) ([\w\.]+)/i,/(flock|rockmelt|midori|epiphany|silk|skyfire|ovibrowser|bolt|iron|vivaldi|iridium|phantomjs|bowser|quark|qupzilla|falkon|rekonq|puffin|brave|whale(?!.+naver)|qqbrowserlite|qq|duckduckgo)\/([-\w\.]+)/i,/(weibo)__([\d\.]+)/i],[u,f],[/(?:\buc? ?browser|(?:juc.+)ucweb)[\/ ]?([\w\.]+)/i],[f,[u,"UC"+J]],[/microm.+\bqbcore\/([\w\.]+)/i,/\bqbcore\/([\w\.]+).+microm/i],[f,[u,"WeChat(Win) Desktop"]],[/micromessenger\/([\w\.]+)/i],[f,[u,"WeChat"]],[/konqueror\/([\w\.]+)/i],[f,[u,"Konqueror"]],[/trident.+rv[: ]([\w\.]{1,9})\b.+like gecko/i],[f,[u,"IE"]],[/yabrowser\/([\w\.]+)/i],[f,[u,"Yandex"]],[/(avast|avg)\/([\w\.]+)/i],[[u,/(.+)/,"$1 Secure "+J],f],[/\bfocus\/([\w\.]+)/i],[f,[u,Yt+" Focus"]],[/\bopt\/([\w\.]+)/i],[f,[u,z+" Touch"]],[/coc_coc\w+\/([\w\.]+)/i],[f,[u,"Coc Coc"]],[/dolfin\/([\w\.]+)/i],[f,[u,"Dolphin"]],[/coast\/([\w\.]+)/i],[f,[u,z+" Coast"]],[/miuibrowser\/([\w\.]+)/i],[f,[u,"MIUI "+J]],[/fxios\/([-\w\.]+)/i],[f,[u,Yt]],[/\bqihu|(qi?ho?o?|360)browser/i],[[u,"360 "+J]],[/(oculus|samsung|sailfish|huawei)browser\/([\w\.]+)/i],[[u,/(.+)/,"$1 "+J],f],[/(comodo_dragon)\/([\w\.]+)/i],[[u,/_/g," "],f],[/(electron)\/([\w\.]+) safari/i,/(tesla)(?: qtcarbrowser|\/(20\d\d\.[-\w\.]+))/i,/m?(qqbrowser|baiduboxapp|2345Explorer)[\/ ]?([\w\.]+)/i],[u,f],[/(metasr)[\/ ]?([\w\.]+)/i,/(lbbrowser)/i,/\[(linkedin)app\]/i],[u],[/((?:fban\/fbios|fb_iab\/fb4a)(?!.+fbav)|;fbav\/([\w\.]+);)/i],[[u,T],f],[/(kakao(?:talk|story))[\/ ]([\w\.]+)/i,/(naver)\(.*?(\d+\.[\w\.]+).*\)/i,/safari (line)\/([\w\.]+)/i,/\b(line)\/([\w\.]+)\/iab/i,/(chromium|instagram)[\/ ]([-\w\.]+)/i],[u,f],[/\bgsa\/([\w\.]+) .*safari\//i],[f,[u,"GSA"]],[/headlesschrome(?:\/([\w\.]+)| )/i],[f,[u,lt+" Headless"]],[/ wv\).+(chrome)\/([\w\.]+)/i],[[u,lt+" WebView"],f],[/droid.+ version\/([\w\.]+)\b.+(?:mobile safari|safari)/i],[f,[u,"Android "+J]],[/(chrome|omniweb|arora|[tizenoka]{5} ?browser)\/v?([\w\.]+)/i],[u,f],[/version\/([\w\.\,]+) .*mobile\/\w+ (safari)/i],[f,[u,"Mobile Safari"]],[/version\/([\w(\.|\,)]+) .*(mobile ?safari|safari)/i],[f,u],[/webkit.+?(mobile ?safari|safari)(\/[\w\.]+)/i],[u,[f,Is,{"1.0":"/8",1.2:"/1",1.3:"/3","2.0":"/412","2.0.2":"/416","2.0.3":"/417","2.0.4":"/419","?":"/"}]],[/(webkit|khtml)\/([\w\.]+)/i],[u,f],[/(navigator|netscape\d?)\/([-\w\.]+)/i],[[u,"Netscape"],f],[/mobile vr; rv:([\w\.]+)\).+firefox/i],[f,[u,Yt+" Reality"]],[/ekiohf.+(flow)\/([\w\.]+)/i,/(swiftfox)/i,/(icedragon|iceweasel|camino|chimera|fennec|maemo browser|minimo|conkeror|klar)[\/ ]?([\w\.\+]+)/i,/(seamonkey|k-meleon|icecat|iceape|firebird|phoenix|palemoon|basilisk|waterfox)\/([-\w\.]+)$/i,/(firefox)\/([\w\.]+)/i,/(mozilla)\/([\w\.]+) .+rv\:.+gecko\/\d+/i,/(polaris|lynx|dillo|icab|doris|amaya|w3m|netsurf|sleipnir|obigo|mosaic|(?:go|ice|up)[\. ]?browser)[-\/ ]?v?([\w\.]+)/i,/(links) \(([\w\.]+)/i,/panasonic;(viera)/i],[u,f],[/(cobalt)\/([\w\.]+)/i],[u,[f,/master.|lts./,""]]],cpu:[[/(?:(amd|x(?:(?:86|64)[-_])?|wow|win)64)[;\)]/i],[[C,"amd64"]],[/(ia32(?=;))/i],[[C,me]],[/((?:i[346]|x)86)[;\)]/i],[[C,"ia32"]],[/\b(aarch64|arm(v?8e?l?|_?64))\b/i],[[C,"arm64"]],[/\b(arm(?:v[67])?ht?n?[fl]p?)\b/i],[[C,"armhf"]],[/windows (ce|mobile); ppc;/i],[[C,"arm"]],[/((?:ppc|powerpc)(?:64)?)(?: mac|;|\))/i],[[C,/ower/,"",me]],[/(sun4\w)[;\)]/i],[[C,"sparc"]],[/((?:avr32|ia64(?=;))|68k(?=\))|\barm(?=v(?:[1-7]|[5-7]1)l?|;|eabi)|(?=atmel )avr|(?:irix|mips|sparc)(?:64)?\b|pa-risc)/i],[[C,me]]],device:[[/\b(sch-i[89]0\d|shw-m380s|sm-[ptx]\w{2,4}|gt-[pn]\d{2,4}|sgh-t8[56]9|nexus 10)/i],[d,[p,tt],[l,y]],[/\b((?:s[cgp]h|gt|sm)-\w+|sc[g-]?[\d]+a?|galaxy nexus)/i,/samsung[- ]([-\w]+)/i,/sec-(sgh\w+)/i],[d,[p,tt],[l,g]],[/\((ip(?:hone|od)[\w ]*);/i],[d,[p,B],[l,g]],[/\((ipad);[-\w\),; ]+apple/i,/applecoremedia\/[\w\.]+ \((ipad)/i,/\b(ipad)\d\d?,\d\d?[;\]].+ios/i],[d,[p,B],[l,y]],[/(macintosh);/i],[d,[p,B]],[/\b(sh-?[altvz]?\d\d[a-ekm]?)/i],[d,[p,ft],[l,g]],[/\b((?:ag[rs][23]?|bah2?|sht?|btv)-a?[lw]\d{2})\b(?!.+d\/s)/i],[d,[p,Pe],[l,y]],[/(?:huawei|honor)([-\w ]+)[;\)]/i,/\b(nexus 6p|\w{2,4}e?-[atu]?[ln][\dx][012359c][adn]?)\b(?!.+d\/s)/i],[d,[p,Pe],[l,g]],[/\b(poco[\w ]+)(?: bui|\))/i,/\b; (\w+) build\/hm\1/i,/\b(hm[-_ ]?note?[_ ]?(?:\d\w)?) bui/i,/\b(redmi[\-_ ]?(?:note|k)?[\w_ ]+)(?: bui|\))/i,/\b(mi[-_ ]?(?:a\d|one|one[_ ]plus|note lte|max|cc)?[_ ]?(?:\d?\w?)[_ ]?(?:plus|se|lite)?)(?: bui|\))/i],[[d,/_/g," "],[p,oe],[l,g]],[/\b(mi[-_ ]?(?:pad)(?:[\w_ ]+))(?: bui|\))/i],[[d,/_/g," "],[p,oe],[l,y]],[/; (\w+) bui.+ oppo/i,/\b(cph[12]\d{3}|p(?:af|c[al]|d\w|e[ar])[mt]\d0|x9007|a101op)\b/i],[d,[p,"OPPO"],[l,g]],[/vivo (\w+)(?: bui|\))/i,/\b(v[12]\d{3}\w?[at])(?: bui|;)/i],[d,[p,"Vivo"],[l,g]],[/\b(rmx[12]\d{3})(?: bui|;|\))/i],[d,[p,"Realme"],[l,g]],[/\b(milestone|droid(?:[2-4x]| (?:bionic|x2|pro|razr))?:?( 4g)?)\b[\w ]+build\//i,/\bmot(?:orola)?[- ](\w*)/i,/((?:moto[\w\(\) ]+|xt\d{3,4}|nexus 6)(?= bui|\)))/i],[d,[p,Qr],[l,g]],[/\b(mz60\d|xoom[2 ]{0,2}) build\//i],[d,[p,Qr],[l,y]],[/((?=lg)?[vl]k\-?\d{3}) bui| 3\.[-\w; ]{10}lg?-([06cv9]{3,4})/i],[d,[p,hn],[l,y]],[/(lm(?:-?f100[nv]?|-[\w\.]+)(?= bui|\))|nexus [45])/i,/\blg[-e;\/ ]+((?!browser|netcast|android tv)\w+)/i,/\blg-?([\d\w]+) bui/i],[d,[p,hn],[l,g]],[/(ideatab[-\w ]+)/i,/lenovo ?(s[56]000[-\w]+|tab(?:[\w ]+)|yt[-\d\w]{6}|tb[-\d\w]{6})/i],[d,[p,"Lenovo"],[l,y]],[/(?:maemo|nokia).*(n900|lumia \d+)/i,/nokia[-_ ]?([-\w\.]*)/i],[[d,/_/g," "],[p,"Nokia"],[l,g]],[/(pixel c)\b/i],[d,[p,de],[l,y]],[/droid.+; (pixel[\daxl ]{0,6})(?: bui|\))/i],[d,[p,de],[l,g]],[/droid.+ (a?\d[0-2]{2}so|[c-g]\d{4}|so[-gl]\w+|xq-a\w[4-7][12])(?= bui|\).+chrome\/(?![1-6]{0,1}\d\.))/i],[d,[p,wt],[l,g]],[/sony tablet [ps]/i,/\b(?:sony)?sgp\w+(?: bui|\))/i],[[d,"Xperia Tablet"],[p,wt],[l,y]],[/ (kb2005|in20[12]5|be20[12][59])\b/i,/(?:one)?(?:plus)? (a\d0\d\d)(?: b|\))/i],[d,[p,"OnePlus"],[l,g]],[/(alexa)webm/i,/(kf[a-z]{2}wi)( bui|\))/i,/(kf[a-z]+)( bui|\)).+silk\//i],[d,[p,V],[l,y]],[/((?:sd|kf)[0349hijorstuw]+)( bui|\)).+silk\//i],[[d,/(.+)/g,"Fire Phone $1"],[p,V],[l,g]],[/(playbook);[-\w\),; ]+(rim)/i],[d,p,[l,y]],[/\b((?:bb[a-f]|st[hv])100-\d)/i,/\(bb10; (\w+)/i],[d,[p,Y],[l,g]],[/(?:\b|asus_)(transfo[prime ]{4,10} \w+|eeepc|slider \w+|nexus 7|padfone|p00[cj])/i],[d,[p,K],[l,y]],[/ (z[bes]6[027][012][km][ls]|zenfone \d\w?)\b/i],[d,[p,K],[l,g]],[/(nexus 9)/i],[d,[p,"HTC"],[l,y]],[/(htc)[-;_ ]{1,2}([\w ]+(?=\)| bui)|\w+)/i,/(zte)[- ]([\w ]+?)(?: bui|\/|\))/i,/(alcatel|geeksphone|nexian|panasonic(?!(?:;|\.))|sony(?!-bra))[-_ ]?([-\w]*)/i],[p,[d,/_/g," "],[l,g]],[/droid.+; ([ab][1-7]-?[0178a]\d\d?)/i],[d,[p,"Acer"],[l,y]],[/droid.+; (m[1-5] note) bui/i,/\bmz-([-\w]{2,})/i],[d,[p,"Meizu"],[l,g]],[/(blackberry|benq|palm(?=\-)|sonyericsson|acer|asus|dell|meizu|motorola|polytron)[-_ ]?([-\w]*)/i,/(hp) ([\w ]+\w)/i,/(asus)-?(\w+)/i,/(microsoft); (lumia[\w ]+)/i,/(lenovo)[-_ ]?([-\w]+)/i,/(jolla)/i,/(oppo) ?([\w ]+) bui/i],[p,d,[l,g]],[/(kobo)\s(ereader|touch)/i,/(archos) (gamepad2?)/i,/(hp).+(touchpad(?!.+tablet)|tablet)/i,/(kindle)\/([\w\.]+)/i,/(nook)[\w ]+build\/(\w+)/i,/(dell) (strea[kpr\d ]*[\dko])/i,/(le[- ]+pan)[- ]+(\w{1,9}) bui/i,/(trinity)[- ]*(t\d{3}) bui/i,/(gigaset)[- ]+(q\w{1,9}) bui/i,/(vodafone) ([\w ]+)(?:\)| bui)/i],[p,d,[l,y]],[/(surface duo)/i],[d,[p,qe],[l,y]],[/droid [\d\.]+; (fp\du?)(?: b|\))/i],[d,[p,"Fairphone"],[l,g]],[/(u304aa)/i],[d,[p,"AT&T"],[l,g]],[/\bsie-(\w*)/i],[d,[p,"Siemens"],[l,g]],[/\b(rct\w+) b/i],[d,[p,"RCA"],[l,y]],[/\b(venue[\d ]{2,7}) b/i],[d,[p,"Dell"],[l,y]],[/\b(q(?:mv|ta)\w+) b/i],[d,[p,"Verizon"],[l,y]],[/\b(?:barnes[& ]+noble |bn[rt])([\w\+ ]*) b/i],[d,[p,"Barnes & Noble"],[l,y]],[/\b(tm\d{3}\w+) b/i],[d,[p,"NuVision"],[l,y]],[/\b(k88) b/i],[d,[p,"ZTE"],[l,y]],[/\b(nx\d{3}j) b/i],[d,[p,"ZTE"],[l,g]],[/\b(gen\d{3}) b.+49h/i],[d,[p,"Swiss"],[l,g]],[/\b(zur\d{3}) b/i],[d,[p,"Swiss"],[l,y]],[/\b((zeki)?tb.*\b) b/i],[d,[p,"Zeki"],[l,y]],[/\b([yr]\d{2}) b/i,/\b(dragon[- ]+touch |dt)(\w{5}) b/i],[[p,"Dragon Touch"],d,[l,y]],[/\b(ns-?\w{0,9}) b/i],[d,[p,"Insignia"],[l,y]],[/\b((nxa|next)-?\w{0,9}) b/i],[d,[p,"NextBook"],[l,y]],[/\b(xtreme\_)?(v(1[045]|2[015]|[3469]0|7[05])) b/i],[[p,"Voice"],d,[l,g]],[/\b(lvtel\-)?(v1[12]) b/i],[[p,"LvTel"],d,[l,g]],[/\b(ph-1) /i],[d,[p,"Essential"],[l,g]],[/\b(v(100md|700na|7011|917g).*\b) b/i],[d,[p,"Envizen"],[l,y]],[/\b(trio[-\w\. ]+) b/i],[d,[p,"MachSpeed"],[l,y]],[/\btu_(1491) b/i],[d,[p,"Rotor"],[l,y]],[/(shield[\w ]+) b/i],[d,[p,"Nvidia"],[l,y]],[/(sprint) (\w+)/i],[p,d,[l,g]],[/(kin\.[onetw]{3})/i],[[d,/\./g," "],[p,qe],[l,g]],[/droid.+; (cc6666?|et5[16]|mc[239][23]x?|vc8[03]x?)\)/i],[d,[p,st],[l,y]],[/droid.+; (ec30|ps20|tc[2-8]\d[kx])\)/i],[d,[p,st],[l,g]],[/smart-tv.+(samsung)/i],[p,[l,A]],[/hbbtv.+maple;(\d+)/i],[[d,/^/,"SmartTV"],[p,tt],[l,A]],[/(nux; netcast.+smarttv|lg (netcast\.tv-201\d|android tv))/i],[[p,hn],[l,A]],[/(apple) ?tv/i],[p,[d,B+" TV"],[l,A]],[/crkey/i],[[d,lt+"cast"],[p,de],[l,A]],[/droid.+aft(\w)( bui|\))/i],[d,[p,V],[l,A]],[/\(dtv[\);].+(aquos)/i,/(aquos-tv[\w ]+)\)/i],[d,[p,ft],[l,A]],[/(bravia[\w ]+)( bui|\))/i],[d,[p,wt],[l,A]],[/(mitv-\w{5}) bui/i],[d,[p,oe],[l,A]],[/Hbbtv.*(technisat) (.*);/i],[p,d,[l,A]],[/\b(roku)[\dx]*[\)\/]((?:dvp-)?[\d\.]*)/i,/hbbtv\/\d+\.\d+\.\d+ +\([\w\+ ]*; *([\w\d][^;]*);([^;]*)/i],[[p,In],[d,In],[l,A]],[/\b(android tv|smart[- ]?tv|opera tv|tv; rv:)\b/i],[[l,A]],[/(ouya)/i,/(nintendo) ([wids3utch]+)/i],[p,d,[l,m]],[/droid.+; (shield) bui/i],[d,[p,"Nvidia"],[l,m]],[/(playstation [345portablevi]+)/i],[d,[p,wt],[l,m]],[/\b(xbox(?: one)?(?!; xbox))[\); ]/i],[d,[p,qe],[l,m]],[/((pebble))app/i],[p,d,[l,k]],[/(watch)(?: ?os[,\/]|\d,\d\/)[\d\.]+/i],[d,[p,B],[l,k]],[/droid.+; (glass) \d/i],[d,[p,de],[l,k]],[/droid.+; (wt63?0{2,3})\)/i],[d,[p,st],[l,k]],[/(quest( 2| pro)?)/i],[d,[p,T],[l,k]],[/(tesla)(?: qtcarbrowser|\/[-\w\.]+)/i],[p,[l,M]],[/droid .+?; ([^;]+?)(?: bui|\) applew).+? mobile safari/i],[d,[l,g]],[/droid .+?; ([^;]+?)(?: bui|\) applew).+?(?! mobile) safari/i],[d,[l,y]],[/\b((tablet|tab)[;\/]|focus\/\d(?!.+mobile))/i],[[l,y]],[/(phone|mobile(?:[;\/]| [ \w\/\.]*safari)|pda(?=.+windows ce))/i],[[l,g]],[/(android[-\w\. ]{0,9});.+buil/i],[d,[p,"Generic"]]],engine:[[/windows.+ edge\/([\w\.]+)/i],[f,[u,"EdgeHTML"]],[/webkit\/537\.36.+chrome\/(?!27)([\w\.]+)/i],[f,[u,"Blink"]],[/(presto)\/([\w\.]+)/i,/(webkit|trident|netfront|netsurf|amaya|lynx|w3m|goanna)\/([\w\.]+)/i,/ekioh(flow)\/([\w\.]+)/i,/(khtml|tasman|links)[\/ ]\(?([\w\.]+)/i,/(icab)[\/ ]([23]\.[\d\.]+)/i],[u,f],[/rv\:([\w\.]{1,9})\b.+(gecko)/i],[f,u]],os:[[/microsoft (windows) (vista|xp)/i],[u,f],[/(windows) nt 6\.2; (arm)/i,/(windows (?:phone(?: os)?|mobile))[\/ ]?([\d\.\w ]*)/i,/(windows)[\/ ]?([ntce\d\. ]+\w)(?!.+xbox)/i],[u,[f,Is,$f]],[/(win(?=3|9|n)|win 9x )([nt\d\.]+)/i],[[u,"Windows"],[f,Is,$f]],[/ip[honead]{2,4}\b(?:.*os ([\w]+) like mac|; opera)/i,/cfnetwork\/.+darwin/i],[[f,/_/g,"."],[u,"iOS"]],[/(mac os x) ?([\w\. ]*)/i,/(macintosh|mac_powerpc\b)(?!.+haiku)/i],[[u,L],[f,/_/g,"."]],[/droid ([\w\.]+)\b.+(android[- ]x86|harmonyos)/i],[f,u],[/(android|webos|qnx|bada|rim tablet os|maemo|meego|sailfish)[-\/ ]?([\w\.]*)/i,/(blackberry)\w*\/([\w\.]*)/i,/(tizen|kaios)[\/ ]([\w\.]+)/i,/\((series40);/i],[u,f],[/\(bb(10);/i],[f,[u,Y]],[/(?:symbian ?os|symbos|s60(?=;)|series60)[-\/ ]?([\w\.]*)/i],[f,[u,"Symbian"]],[/mozilla\/[\d\.]+ \((?:mobile|tablet|tv|mobile; [\w ]+); rv:.+ gecko\/([\w\.]+)/i],[f,[u,Yt+" OS"]],[/web0s;.+rt(tv)/i,/\b(?:hp)?wos(?:browser)?\/([\w\.]+)/i],[f,[u,"webOS"]],[/watch(?: ?os[,\/]|\d,\d\/)([\d\.]+)/i],[f,[u,"watchOS"]],[/crkey\/([\d\.]+)/i],[f,[u,lt+"cast"]],[/(cros) [\w]+(?:\)| ([\w\.]+)\b)/i],[[u,D],f],[/panasonic;(viera)/i,/(netrange)mmh/i,/(nettv)\/(\d+\.[\w\.]+)/i,/(nintendo|playstation) ([wids345portablevuch]+)/i,/(xbox); +xbox ([^\);]+)/i,/\b(joli|palm)\b ?(?:os)?\/?([\w\.]*)/i,/(mint)[\/\(\) ]?(\w*)/i,/(mageia|vectorlinux)[; ]/i,/([kxln]?ubuntu|debian|suse|opensuse|gentoo|arch(?= linux)|slackware|fedora|mandriva|centos|pclinuxos|red ?hat|zenwalk|linpus|raspbian|plan 9|minix|risc os|contiki|deepin|manjaro|elementary os|sabayon|linspire)(?: gnu\/linux)?(?: enterprise)?(?:[- ]linux)?(?:-gnu)?[-\/ ]?(?!chrom|package)([-\w\.]*)/i,/(hurd|linux) ?([\w\.]*)/i,/(gnu) ?([\w\.]*)/i,/\b([-frentopcghs]{0,5}bsd|dragonfly)[\/ ]?(?!amd|[ix346]{1,2}86)([\w\.]*)/i,/(haiku) (\w+)/i],[u,f],[/(sunos) ?([\w\.\d]*)/i],[[u,"Solaris"],f],[/((?:open)?solaris)[-\/ ]?([\w\.]*)/i,/(aix) ((\d)(?=\.|\)| )[\w\.])*/i,/\b(beos|os\/2|amigaos|morphos|openvms|fuchsia|hp-ux)/i,/(unix) ?([\w\.]*)/i],[u,f]]},Cr=function(sn,Tn){if(typeof sn===s&&(Tn=sn,sn=i),!(this instanceof Cr))return new Cr(sn,Tn).getResult();var Ue=typeof n!==o&&n.navigator?n.navigator:i,qi=sn||(Ue&&Ue.userAgent?Ue.userAgent:""),Qo=Ue&&Ue.userAgentData?Ue.userAgentData:i,an=Tn?function(se,xi){var _a={};for(var To in se)xi[To]&&xi[To].length%2==0?_a[To]=xi[To].concat(se[To]):_a[To]=se[To];return _a}(t_,Tn):t_;return this.getBrowser=function(){var se={};return se[u]=i,se[f]=i,Ui.call(se,qi,an.browser),se[c]=function(xi){return typeof xi===a?xi.replace(/[^\d\.]/g,"").split(".")[0]:i}(se[f]),Ue&&Ue.brave&&typeof Ue.brave.isBrave==r&&(se[u]="Brave"),se},this.getCPU=function(){var se={};return se[C]=i,Ui.call(se,qi,an.cpu),se},this.getDevice=function(){var se={};return se[p]=i,se[d]=i,se[l]=i,Ui.call(se,qi,an.device),!se[l]&&Qo&&Qo.mobile&&(se[l]=g),se[d]=="Macintosh"&&Ue&&typeof Ue.standalone!==o&&Ue.maxTouchPoints&&Ue.maxTouchPoints>2&&(se[d]="iPad",se[l]=y),se},this.getEngine=function(){var se={};return se[u]=i,se[f]=i,Ui.call(se,qi,an.engine),se},this.getOS=function(){var se={};return se[u]=i,se[f]=i,Ui.call(se,qi,an.os),!se[u]&&Qo&&Qo.platform!="Unknown"&&(se[u]=Qo.platform.replace(/chrome os/i,D).replace(/macos/i,L)),se},this.getResult=function(){return{ua:this.getUA(),browser:this.getBrowser(),engine:this.getEngine(),os:this.getOS(),device:this.getDevice(),cpu:this.getCPU()}},this.getUA=function(){return qi},this.setUA=function(se){return qi=typeof se===a&&se.length>350?In(se,350):se,this},this.setUA(qi),this};Cr.VERSION="0.7.34",Cr.BROWSER=Q([u,f,c]),Cr.CPU=Q([C]),Cr.DEVICE=Q([d,p,l,m,g,A,y,k,M]),Cr.ENGINE=Cr.OS=Q([u,f]),t.exports&&(e=t.exports=Cr),e.UAParser=Cr;var fa=typeof n!==o&&(n.jQuery||n.Zepto);if(fa&&!fa.ua){var jd=new Cr;fa.ua=jd.getResult(),fa.ua.get=function(){return jd.getUA()},fa.ua.set=function(sn){jd.setUA(sn);var Tn=jd.getResult();for(var Ue in Tn)fa.ua[Ue]=Tn[Ue]}}})(typeof window=="object"?window:Ut)})(YE,YE.exports);var ox=Dt(YE.exports),sx=Or,ax=Dn,cx=dr,dx=Aa,ux=Ze("iterator"),lx=Object,hx=function(t){if(cx(t))return!1;var e=lx(t);return e[ux]!==void 0||"@@iterator"in e||ax(dx,sx(e))},px=Dt(hx),zE=Lt;$t({global:!0,forced:zE.globalThis!==zE},{globalThis:zE});var ov=Dt(Lt);function sv(t,e){return function(){return t.apply(e,arguments)}}const{toString:fx}=Object.prototype,{getPrototypeOf:JE}=Object,sp=(XE=Object.create(null),t=>{const e=fx.call(t);return XE[e]||(XE[e]=e.slice(8,-1).toLowerCase())});var XE;const Po=t=>(t=t.toLowerCase(),e=>sp(e)===t),ap=t=>e=>typeof e===t,{isArray:Bc}=Array,Pu=ap("undefined"),av=Po("ArrayBuffer"),_x=ap("string"),Dr=ap("function"),cv=ap("number"),cp=t=>t!==null&&typeof t=="object",dp=t=>{if(sp(t)!=="object")return!1;const e=JE(t);return!(e!==null&&e!==Object.prototype&&Object.getPrototypeOf(e)!==null||Symbol.toStringTag in t||px(t))},Ex=Po("Date"),mx=Po("File"),gx=Po("Blob"),Tx=Po("FileList"),Sx=Po("URLSearchParams");function Lu(t,e){let n,i,{allOwnKeys:r=!1}=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};if(t!=null)if(typeof t!="object"&&(t=[t]),Bc(t))for(n=0,i=t.length;n<i;n++)e.call(null,t[n],n,t);else{const o=r?Object.getOwnPropertyNames(t):Object.keys(t),s=o.length;let a;for(n=0;n<s;n++)a=o[n],e.call(null,t[a],a,t)}}function dv(t,e){e=e.toLowerCase();const n=Object.keys(t);let i,r=n.length;for(;r-- >0;)if(i=n[r],e===i.toLowerCase())return i;return null}const uv=ov!==void 0?ov:typeof self!="undefined"?self:typeof window!="undefined"?window:Fl,lv=t=>!Pu(t)&&t!==uv,Rx=(QE=typeof Uint8Array!="undefined"&&JE(Uint8Array),t=>QE&&t instanceof QE);var QE;const Cx=Po("HTMLFormElement"),hv=(t=>{let{hasOwnProperty:e}=t;return(n,i)=>e.call(n,i)})(Object.prototype),vx=Po("RegExp"),pv=(t,e)=>{const n=Object.getOwnPropertyDescriptors(t),i={};Lu(n,(r,o)=>{let s;(s=e(r,o,t))!==!1&&(i[o]=s||r)}),Object.defineProperties(t,i)},ZE="abcdefghijklmnopqrstuvwxyz",fv="0123456789",_v={DIGIT:fv,ALPHA:ZE,ALPHA_DIGIT:ZE+ZE.toUpperCase()+fv},yx=Po("AsyncFunction");var pt={isArray:Bc,isArrayBuffer:av,isBuffer:function(t){return t!==null&&!Pu(t)&&t.constructor!==null&&!Pu(t.constructor)&&Dr(t.constructor.isBuffer)&&t.constructor.isBuffer(t)},isFormData:t=>{let e;return t&&(typeof FormData=="function"&&t instanceof FormData||Dr(t.append)&&((e=sp(t))==="formdata"||e==="object"&&Dr(t.toString)&&t.toString()==="[object FormData]"))},isArrayBufferView:function(t){let e;return e=typeof ArrayBuffer!="undefined"&&ArrayBuffer.isView?ArrayBuffer.isView(t):t&&t.buffer&&av(t.buffer),e},isString:_x,isNumber:cv,isBoolean:t=>t===!0||t===!1,isObject:cp,isPlainObject:dp,isUndefined:Pu,isDate:Ex,isFile:mx,isBlob:gx,isRegExp:vx,isFunction:Dr,isStream:t=>cp(t)&&Dr(t.pipe),isURLSearchParams:Sx,isTypedArray:Rx,isFileList:Tx,forEach:Lu,merge:function t(){const{caseless:e}=lv(this)&&this||{},n={},i=(r,o)=>{const s=e&&dv(n,o)||o;dp(n[s])&&dp(r)?n[s]=t(n[s],r):dp(r)?n[s]=t({},r):Bc(r)?n[s]=r.slice():n[s]=r};for(let r=0,o=arguments.length;r<o;r++)arguments[r]&&Lu(arguments[r],i);return n},extend:function(t,e,n){let{allOwnKeys:i}=arguments.length>3&&arguments[3]!==void 0?arguments[3]:{};return Lu(e,(r,o)=>{n&&Dr(r)?t[o]=sv(r,n):t[o]=r},{allOwnKeys:i}),t},trim:t=>si(t)?si(t).call(t):t.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,""),stripBOM:t=>(t.charCodeAt(0)===65279&&(t=t.slice(1)),t),inherits:(t,e,n,i)=>{t.prototype=Object.create(e.prototype,i),t.prototype.constructor=t,Object.defineProperty(t,"super",{value:e.prototype}),n&&Object.assign(t.prototype,n)},toFlatObject:(t,e,n,i)=>{let r,o,s;const a={};if(e=e||{},t==null)return e;do{for(r=Object.getOwnPropertyNames(t),o=r.length;o-- >0;)s=r[o],i&&!i(s,t,e)||a[s]||(e[s]=t[s],a[s]=!0);t=n!==!1&&JE(t)}while(t&&(!n||n(t,e))&&t!==Object.prototype);return e},kindOf:sp,kindOfTest:Po,endsWith:(t,e,n)=>{t=String(t),(n===void 0||n>t.length)&&(n=t.length),n-=e.length;const i=t.indexOf(e,n);return i!==-1&&i===n},toArray:t=>{if(!t)return null;if(Bc(t))return t;let e=t.length;if(!cv(e))return null;const n=new Array(e);for(;e-- >0;)n[e]=t[e];return n},forEachEntry:(t,e)=>{const n=(t&&t[Symbol.iterator]).call(t);let i;for(;(i=n.next())&&!i.done;){const r=i.value;e.call(t,r[0],r[1])}},matchAll:(t,e)=>{let n;const i=[];for(;(n=t.exec(e))!==null;)i.push(n);return i},isHTMLForm:Cx,hasOwnProperty:hv,hasOwnProp:hv,reduceDescriptors:pv,freezeMethods:t=>{pv(t,(e,n)=>{if(Dr(t)&&["arguments","caller","callee"].indexOf(n)!==-1)return!1;const i=t[n];Dr(i)&&(e.enumerable=!1,"writable"in e?e.writable=!1:e.set||(e.set=()=>{throw Error("Can not rewrite read-only method '"+n+"'")}))})},toObjectSet:(t,e)=>{const n={},i=r=>{r.forEach(o=>{n[o]=!0})};return Bc(t)?i(t):i(String(t).split(e)),n},toCamelCase:t=>t.toLowerCase().replace(/[-_\s]([a-z\d])(\w*)/g,function(e,n,i){return n.toUpperCase()+i}),noop:()=>{},toFiniteNumber:(t,e)=>(t=+t,Number.isFinite(t)?t:e),findKey:dv,global:uv,isContextDefined:lv,ALPHABET:_v,generateString:function(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:16,e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:_v.ALPHA_DIGIT,n="";const{length:i}=e;for(;t--;)n+=e[Math.random()*i|0];return n},isSpecCompliantForm:function(t){return!!(t&&Dr(t.append)&&t[Symbol.toStringTag]==="FormData"&&t[Symbol.iterator])},toJSONObject:t=>{const e=new Array(10),n=(i,r)=>{if(cp(i)){if(e.indexOf(i)>=0)return;if(!("toJSON"in i)){e[r]=i;const o=Bc(i)?[]:{};return Lu(i,(s,a)=>{const c=n(s,r+1);!Pu(c)&&(o[a]=c)}),e[r]=void 0,o}}return i};return n(t,0)},isAsyncFn:yx,isThenable:t=>t&&(cp(t)||Dr(t))&&Dr(t.then)&&Dr(t.catch)};function We(t,e,n,i,r){Error.call(this),Error.captureStackTrace?Error.captureStackTrace(this,this.constructor):this.stack=new Error().stack,this.message=t,this.name="AxiosError",e&&(this.code=e),n&&(this.config=n),i&&(this.request=i),r&&(this.response=r)}pt.inherits(We,Error,{toJSON:function(){return{message:this.message,name:this.name,description:this.description,number:this.number,fileName:this.fileName,lineNumber:this.lineNumber,columnNumber:this.columnNumber,stack:this.stack,config:pt.toJSONObject(this.config),code:this.code,status:this.response&&this.response.status?this.response.status:null}}});const Ev=We.prototype,mv={};["ERR_BAD_OPTION_VALUE","ERR_BAD_OPTION","ECONNABORTED","ETIMEDOUT","ERR_NETWORK","ERR_FR_TOO_MANY_REDIRECTS","ERR_DEPRECATED","ERR_BAD_RESPONSE","ERR_BAD_REQUEST","ERR_CANCELED","ERR_NOT_SUPPORT","ERR_INVALID_URL"].forEach(t=>{mv[t]={value:t}}),Object.defineProperties(We,mv),Object.defineProperty(Ev,"isAxiosError",{value:!0}),We.from=(t,e,n,i,r,o)=>{const s=Object.create(Ev);return pt.toFlatObject(t,s,function(a){return a!==Error.prototype},a=>a!=="isAxiosError"),We.call(s,t.message,e,n,i,r),s.cause=t,s.name=t.name,o&&Object.assign(s,o),s};function $E(t){return pt.isPlainObject(t)||pt.isArray(t)}function gv(t){return pt.endsWith(t,"[]")?t.slice(0,-2):t}function Tv(t,e,n){return t?t.concat(e).map(function(i,r){return i=gv(i),!n&&r?"["+i+"]":i}).join(n?".":""):e}const Ix=pt.toFlatObject(pt,{},null,function(t){return/^is[A-Z]/.test(t)});function up(t,e,n){if(!pt.isObject(t))throw new TypeError("target must be an object");e=e||new FormData;const i=(n=pt.toFlatObject(n,{metaTokens:!0,dots:!1,indexes:!1},!1,function(p,f){return!pt.isUndefined(f[p])})).metaTokens,r=n.visitor||d,o=n.dots,s=n.indexes,a=(n.Blob||typeof Blob!="undefined"&&Blob)&&pt.isSpecCompliantForm(e);if(!pt.isFunction(r))throw new TypeError("visitor must be a function");function c(p){if(p===null)return"";if(pt.isDate(p))return p.toISOString();if(!a&&pt.isBlob(p))throw new We("Blob is not supported. Use a Buffer instead.");return pt.isArrayBuffer(p)||pt.isTypedArray(p)?a&&typeof Blob=="function"?new Blob([p]):Buffer.from(p):p}function d(p,f,C){let m=p;if(p&&!C&&typeof p=="object"){if(pt.endsWith(f,"{}"))f=i?f:f.slice(0,-2),p=JSON.stringify(p);else if(pt.isArray(p)&&function(g){return pt.isArray(g)&&!g.some($E)}(p)||(pt.isFileList(p)||pt.endsWith(f,"[]"))&&(m=pt.toArray(p)))return f=gv(f),m.forEach(function(g,y){!pt.isUndefined(g)&&g!==null&&e.append(s===!0?Tv([f],y,o):s===null?f:f+"[]",c(g))}),!1}return!!$E(p)||(e.append(Tv(C,f,o),c(p)),!1)}const u=[],l=Object.assign(Ix,{defaultVisitor:d,convertValue:c,isVisitable:$E});if(!pt.isObject(t))throw new TypeError("data must be an object");return function p(f,C){if(!pt.isUndefined(f)){if(u.indexOf(f)!==-1)throw Error("Circular reference detected in "+C.join("."));u.push(f),pt.forEach(f,function(m,g){(!(pt.isUndefined(m)||m===null)&&r.call(e,m,pt.isString(g)?si(g).call(g):g,C,l))===!0&&p(m,C?C.concat(g):[g])}),u.pop()}}(t),e}function Sv(t){const e={"!":"%21","'":"%27","(":"%28",")":"%29","~":"%7E","%20":"+","%00":"\0"};return encodeURIComponent(t).replace(/[!'()~]|%20|%00/g,function(n){return e[n]})}function tm(t,e){this._pairs=[],t&&up(t,this,e)}const Rv=tm.prototype;function bx(t){return encodeURIComponent(t).replace(/%3A/gi,":").replace(/%24/g,"$").replace(/%2C/gi,",").replace(/%20/g,"+").replace(/%5B/gi,"[").replace(/%5D/gi,"]")}function Cv(t,e,n){if(!e)return t;const i=n&&n.encode||bx,r=n&&n.serialize;let o;if(o=r?r(e,n):pt.isURLSearchParams(e)?e.toString():new tm(e,n).toString(i),o){const s=t.indexOf("#");s!==-1&&(t=t.slice(0,s)),t+=(t.indexOf("?")===-1?"?":"&")+o}return t}Rv.append=function(t,e){this._pairs.push([t,e])},Rv.toString=function(t){const e=t?function(n){return t.call(this,n,Sv)}:Sv;return this._pairs.map(function(n){return e(n[0])+"="+e(n[1])},"").join("&")};var vv=class{constructor(){this.handlers=[]}use(t,e,n){return this.handlers.push({fulfilled:t,rejected:e,synchronous:!!n&&n.synchronous,runWhen:n?n.runWhen:null}),this.handlers.length-1}eject(t){this.handlers[t]&&(this.handlers[t]=null)}clear(){this.handlers&&(this.handlers=[])}forEach(t){pt.forEach(this.handlers,function(e){e!==null&&t(e)})}},yv={silentJSONParsing:!0,forcedJSONParsing:!0,clarifyTimeoutError:!1},Iv={exports:{}},Ax=$t,wx=Vi,bv=Fi.f;Ax({target:"Object",stat:!0,forced:Object.defineProperty!==bv,sham:!wx},{defineProperty:bv});var Av=Bn.Object,Ox=Iv.exports=function(t,e,n){return Av.defineProperty(t,e,n)};Av.defineProperty.sham&&(Ox.sham=!0);var wv=Dt(Iv.exports),Nx=I,ku=Array.isArray||function(t){return Nx(t)=="Array"},Dx=TypeError,Ov=ku,Px=qh,Lx=Oi,kx=Ze("species"),Nv=Array,Mx=function(t){var e;return Ov(t)&&(e=t.constructor,(Px(e)&&(e===Nv||Ov(e.prototype))||Lx(e)&&(e=e[kx])===null)&&(e=void 0)),e===void 0?Nv:e},Dv=function(t,e){return new(Mx(t))(e===0?0:e)},Ux=Pt,xx=Yi,Vx=Ze("species"),Pv=function(t){return xx>=51||!Ux(function(){var e=[];return(e.constructor={})[Vx]=function(){return{foo:1}},e[t](Boolean).foo!==1})},Fx=$t,jx=Pt,Bx=ku,Gx=Oi,Wx=br,Hx=ri,Lv=function(t){if(t>9007199254740991)throw Dx("Maximum allowed index exceeded");return t},kv=op,Kx=Dv,qx=Pv,Yx=Yi,Mv=Ze("isConcatSpreadable"),zx=Yx>=51||!jx(function(){var t=[];return t[Mv]=!1,t.concat()[0]!==t}),Jx=function(t){if(!Gx(t))return!1;var e=t[Mv];return e!==void 0?!!e:Bx(t)};Fx({target:"Array",proto:!0,arity:1,forced:!zx||!qx("concat")},{concat:function(t){var e,n,i,r,o,s=Wx(this),a=Kx(s,0),c=0;for(e=-1,i=arguments.length;e<i;e++)if(Jx(o=e===-1?s:arguments[e]))for(r=Hx(o),Lv(c+r),n=0;n<r;n++,c++)n in o&&kv(a,c,o[n]);else Lv(c+1),kv(a,c++,o);return a.length=c,a}});var Uv={},Xx=I,Qx=li,xv=Ph.f,Zx=WE,Vv=typeof window=="object"&&window&&Object.getOwnPropertyNames?Object.getOwnPropertyNames(window):[];Uv.f=function(t){return Vv&&Xx(t)=="Window"?function(e){try{return xv(e)}catch{return Zx(Vv)}}(t):xv(Qx(t))};var Gc={},$x=Ze;Gc.f=$x;var Fv=Bn,t2=Dn,e2=Gc,n2=Fi.f,Hn=function(t){var e=Fv.Symbol||(Fv.Symbol={});t2(e,t)||n2(e,t,{value:e2.f(t)})},i2=cn,r2=Ci,o2=Ze,s2=Ms,jv=function(){var t=r2("Symbol"),e=t&&t.prototype,n=e&&e.valueOf,i=o2("toPrimitive");e&&!e[i]&&s2(e,i,function(r){return i2(n,this)},{arity:1})},a2=eo,c2=_c,d2=br,u2=ri,l2=Dv,Bv=Ge([].push),Fs=function(t){var e=t==1,n=t==2,i=t==3,r=t==4,o=t==6,s=t==7,a=t==5||o;return function(c,d,u,l){for(var p,f,C=d2(c),m=c2(C),g=a2(d,u),y=u2(m),A=0,k=l||l2,M=e?k(c,y):n||s?k(c,0):void 0;y>A;A++)if((a||A in m)&&(f=g(p=m[A],A,C),t))if(e)M[A]=f;else if(f)switch(t){case 3:return!0;case 5:return p;case 6:return A;case 2:Bv(M,p)}else switch(t){case 4:return!1;case 7:Bv(M,p)}return o?-1:i||r?r:M}},Gv={forEach:Fs(0),map:Fs(1),filter:Fs(2),some:Fs(3),every:Fs(4),find:Fs(5),findIndex:Fs(6),filterReject:Fs(7)},lp=$t,em=Lt,nm=cn,h2=Ge,Wc=Vi,Hc=is,p2=Pt,fi=Dn,f2=Jn,im=Gn,hp=li,rm=bo,_2=x,om=Ro,Mu=Ru,Wv=kh,E2=Ph,Hv=Uv,m2=Su,Kv=Ta,qv=Fi,g2=x_,Yv=Sa,zv=Ms,T2=Kh,sm=yo,Jv=Lh,Xv=eu,S2=Ze,R2=Gc,C2=Hn,v2=jv,y2=Us,Qv=Oa,pp=Gv.forEach,Qi=Dh("hidden"),fp="Symbol",Uu="prototype",I2=Qv.set,Zv=Qv.getterFor(fp),ro=Object[Uu],Pa=em.Symbol,_p=Pa&&Pa[Uu],b2=em.TypeError,am=em.QObject,$v=Kv.f,La=qv.f,ty=Hv.f,A2=Yv.f,ey=h2([].push),us=sm("symbols"),xu=sm("op-symbols"),w2=sm("wks"),cm=!am||!am[Uu]||!am[Uu].findChild,dm=Wc&&p2(function(){return Mu(La({},"a",{get:function(){return La(this,"a",{value:7}).a}})).a!=7})?function(t,e,n){var i=$v(ro,e);i&&delete ro[e],La(t,e,n),i&&t!==ro&&La(ro,e,i)}:La,um=function(t,e){var n=us[t]=Mu(_p);return I2(n,{type:fp,tag:t,description:e}),Wc||(n.description=e),n},Ep=function(t,e,n){t===ro&&Ep(xu,e,n),im(t);var i=rm(e);return im(n),fi(us,i)?(n.enumerable?(fi(t,Qi)&&t[Qi][i]&&(t[Qi][i]=!1),n=Mu(n,{enumerable:om(0,!1)})):(fi(t,Qi)||La(t,Qi,om(1,{})),t[Qi][i]=!0),dm(t,i,n)):La(t,i,n)},lm=function(t,e){im(t);var n=hp(e),i=Wv(n).concat(oy(n));return pp(i,function(r){Wc&&!nm(ny,n,r)||Ep(t,r,n[r])}),t},ny=function(t){var e=rm(t),n=nm(A2,this,e);return!(this===ro&&fi(us,e)&&!fi(xu,e))&&(!(n||!fi(this,e)||!fi(us,e)||fi(this,Qi)&&this[Qi][e])||n)},iy=function(t,e){var n=hp(t),i=rm(e);if(n!==ro||!fi(us,i)||fi(xu,i)){var r=$v(n,i);return!r||!fi(us,i)||fi(n,Qi)&&n[Qi][i]||(r.enumerable=!0),r}},ry=function(t){var e=ty(hp(t)),n=[];return pp(e,function(i){fi(us,i)||fi(Jv,i)||ey(n,i)}),n},oy=function(t){var e=t===ro,n=ty(e?xu:hp(t)),i=[];return pp(n,function(r){!fi(us,r)||e&&!fi(ro,r)||ey(i,us[r])}),i};Hc||(Pa=function(){if(f2(_p,this))throw b2("Symbol is not a constructor");var t=arguments.length&&arguments[0]!==void 0?_2(arguments[0]):void 0,e=Xv(t),n=function(i){this===ro&&nm(n,xu,i),fi(this,Qi)&&fi(this[Qi],e)&&(this[Qi][e]=!1),dm(this,e,om(1,i))};return Wc&&cm&&dm(ro,e,{configurable:!0,set:n}),um(e,t)},zv(_p=Pa[Uu],"toString",function(){return Zv(this).tag}),zv(Pa,"withoutSetter",function(t){return um(Xv(t),t)}),Yv.f=ny,qv.f=Ep,g2.f=lm,Kv.f=iy,E2.f=Hv.f=ry,m2.f=oy,R2.f=function(t){return um(S2(t),t)},Wc&&T2(_p,"description",{configurable:!0,get:function(){return Zv(this).description}})),lp({global:!0,constructor:!0,wrap:!0,forced:!Hc,sham:!Hc},{Symbol:Pa}),pp(Wv(w2),function(t){C2(t)}),lp({target:fp,stat:!0,forced:!Hc},{useSetter:function(){cm=!0},useSimple:function(){cm=!1}}),lp({target:"Object",stat:!0,forced:!Hc,sham:!Wc},{create:function(t,e){return e===void 0?Mu(t):lm(Mu(t),e)},defineProperty:Ep,defineProperties:lm,getOwnPropertyDescriptor:iy}),lp({target:"Object",stat:!0,forced:!Hc},{getOwnPropertyNames:ry}),v2(),y2(Pa,fp),Jv[Qi]=!0;var sy=is&&!!Symbol.for&&!!Symbol.keyFor,O2=$t,N2=Ci,D2=Dn,P2=x,ay=yo,L2=sy,hm=ay("string-to-symbol-registry"),k2=ay("symbol-to-string-registry");O2({target:"Symbol",stat:!0,forced:!L2},{for:function(t){var e=P2(t);if(D2(hm,e))return hm[e];var n=N2("Symbol")(e);return hm[e]=n,k2[n]=e,n}});var M2=$t,U2=Dn,x2=hi,V2=vo,F2=sy,cy=yo("symbol-to-string-registry");M2({target:"Symbol",stat:!0,forced:!F2},{keyFor:function(t){if(!x2(t))throw TypeError(V2(t)+" is not a symbol");if(U2(cy,t))return cy[t]}});var dy=ku,j2=pn,uy=I,B2=x,ly=Ge([].push),G2=$t,hy=Ci,py=lc,W2=cn,Vu=Ge,fy=Pt,_y=pn,Ey=hi,my=oE,H2=function(t){if(j2(t))return t;if(dy(t)){for(var e=t.length,n=[],i=0;i<e;i++){var r=t[i];typeof r=="string"?ly(n,r):typeof r!="number"&&uy(r)!="Number"&&uy(r)!="String"||ly(n,B2(r))}var o=n.length,s=!0;return function(a,c){if(s)return s=!1,c;if(dy(this))return c;for(var d=0;d<o;d++)if(n[d]===a)return c}}},K2=is,q2=String,js=hy("JSON","stringify"),mp=Vu(/./.exec),gy=Vu("".charAt),Y2=Vu("".charCodeAt),z2=Vu("".replace),J2=Vu(1 .toString),X2=/[\uD800-\uDFFF]/g,Ty=/^[\uD800-\uDBFF]$/,Sy=/^[\uDC00-\uDFFF]$/,Ry=!K2||fy(function(){var t=hy("Symbol")();return js([t])!="[null]"||js({a:t})!="{}"||js(Object(t))!="{}"}),Cy=fy(function(){return js("\uDF06\uD834")!=='"\\udf06\\ud834"'||js("\uDEAD")!=='"\\udead"'}),Q2=function(t,e){var n=my(arguments),i=H2(e);if(_y(i)||t!==void 0&&!Ey(t))return n[1]=function(r,o){if(_y(i)&&(o=W2(i,this,q2(r),o)),!Ey(o))return o},py(js,null,n)},Z2=function(t,e,n){var i=gy(n,e-1),r=gy(n,e+1);return mp(Ty,t)&&!mp(Sy,r)||mp(Sy,t)&&!mp(Ty,i)?"\\u"+J2(Y2(t,0),16):t};js&&G2({target:"JSON",stat:!0,arity:3,forced:Ry||Cy},{stringify:function(t,e,n){var i=my(arguments),r=py(Ry?Q2:js,null,i);return Cy&&typeof r=="string"?z2(r,X2,Z2):r}});var vy=Su,$2=br;$t({target:"Object",stat:!0,forced:!is||Pt(function(){vy.f(1)})},{getOwnPropertySymbols:function(t){var e=vy.f;return e?e($2(t)):[]}}),Hn("asyncIterator"),Hn("hasInstance"),Hn("isConcatSpreadable"),Hn("iterator"),Hn("match"),Hn("matchAll"),Hn("replace"),Hn("search"),Hn("species"),Hn("split");var tV=jv;Hn("toPrimitive"),tV();var eV=Ci,nV=Us;Hn("toStringTag"),nV(eV("Symbol"),"Symbol"),Hn("unscopables"),Us(Lt.JSON,"JSON",!0);var iV=Bn.Symbol,rV=Ze,oV=Fi.f,yy=rV("metadata"),Iy=Function.prototype;Iy[yy]===void 0&&oV(Iy,yy,{value:null}),Hn("dispose"),Hn("metadata");var sV=iV;Hn("asyncDispose");var aV=Ge,pm=Ci("Symbol"),cV=pm.keyFor,dV=aV(pm.prototype.valueOf),by=pm.isRegisteredSymbol||function(t){try{return cV(dV(t))!==void 0}catch{return!1}};$t({target:"Symbol",stat:!0},{isRegisteredSymbol:by});for(var uV=yo,Ay=Ci,lV=Ge,hV=hi,pV=Ze,gp=Ay("Symbol"),wy=gp.isWellKnownSymbol,Oy=Ay("Object","getOwnPropertyNames"),fV=lV(gp.prototype.valueOf),Ny=uV("wks"),fm=0,Dy=Oy(gp),_V=Dy.length;fm<_V;fm++)try{var Py=Dy[fm];hV(gp[Py])&&pV(Py)}catch{}var Ly=function(t){if(wy&&wy(t))return!0;try{for(var e=fV(t),n=0,i=Oy(Ny),r=i.length;n<r;n++)if(Ny[i[n]]==e)return!0}catch{}return!1};$t({target:"Symbol",stat:!0,forced:!0},{isWellKnownSymbol:Ly}),Hn("matcher"),Hn("observable"),$t({target:"Symbol",stat:!0,name:"isRegisteredSymbol"},{isRegistered:by}),$t({target:"Symbol",stat:!0,name:"isWellKnownSymbol",forced:!0},{isWellKnown:Ly}),Hn("metadataKey"),Hn("patternMatch"),Hn("replaceAll");var Kc=Dt(sV),ky=Dt(Gc.f("iterator"));function Fu(t){return Fu=typeof Kc=="function"&&typeof ky=="symbol"?function(e){return typeof e}:function(e){return e&&typeof Kc=="function"&&e.constructor===Kc&&e!==Kc.prototype?"symbol":typeof e},Fu(t)}var EV=Dt(Gc.f("toPrimitive"));function mV(t){var e=function(n,i){if(Fu(n)!=="object"||n===null)return n;var r=n[EV];if(r!==void 0){var o=r.call(n,i||"default");if(Fu(o)!=="object")return o;throw new TypeError("@@toPrimitive must return a primitive value.")}return(i==="string"?String:Number)(n)}(t,"string");return Fu(e)==="symbol"?e:String(e)}function R(t,e,n){return(e=mV(e))in t?wv(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}var gV=Pt,TV=Ze("iterator"),_m=!gV(function(){var t=new URL("b?a=1&b=2&c=3","http://a"),e=t.searchParams,n=new URLSearchParams("a=1&a=2"),i="";return t.pathname="c%20d",e.forEach(function(r,o){e.delete("b"),i+=o+r}),n.delete("a",2),!t.toJSON||!n.has("a",1)||n.has("a",2)||!e.size&&!0||!e.sort||t.href!=="http://a/c%20d?a=1&c=3"||e.get("c")!=="3"||String(new URLSearchParams("?a=1"))!=="a=1"||!e[TV]||new URL("https://a@b").username!=="a"||new URLSearchParams(new URLSearchParams("a=b")).get("a")!=="b"||new URL("http://\u0442\u0435\u0441\u0442").host!=="xn--e1aybc"||new URL("http://a#\u0431").hash!=="#%D0%B1"||i!=="a1c3"||new URL("http://x",void 0).host!=="x"}),SV=Ms,Em=$t,qc=Lt,Tp=cn,Lo=Ge,Yc=Vi,My=_m,Uy=Ms,RV=Kh,CV=function(t,e,n){for(var i in e)n&&n.unsafe&&t[i]?t[i]=e[i]:SV(t,i,e[i],n);return t},vV=Us,yV=Q_,mm=Oa,xy=tE,gm=pn,IV=Dn,bV=eo,AV=Or,wV=Gn,Vy=Oi,Bi=x,OV=Ru,Fy=Ro,Tm=B_,NV=xh,zc=Yh,DV=zC,PV=Ze("iterator"),ju="URLSearchParams",jy=ju+"Iterator",By=mm.set,Pr=mm.getterFor(ju),LV=mm.getterFor(jy),kV=Object.getOwnPropertyDescriptor,Sm=function(t){if(!Yc)return qc[t];var e=kV(qc,t);return e&&e.value},Gy=Sm("fetch"),Sp=Sm("Request"),Bu=Sm("Headers"),Rm=Sp&&Sp.prototype,Wy=Bu&&Bu.prototype,MV=qc.RegExp,UV=qc.TypeError,Hy=qc.decodeURIComponent,xV=qc.encodeURIComponent,VV=Lo("".charAt),Ky=Lo([].join),ka=Lo([].push),Cm=Lo("".replace),FV=Lo([].shift),qy=Lo([].splice),Yy=Lo("".split),jV=Lo("".slice),BV=/\+/g,zy=Array(4),GV=function(t){return zy[t-1]||(zy[t-1]=MV("((?:%[\\da-f]{2}){"+t+"})","gi"))},WV=function(t){try{return Hy(t)}catch{return t}},Jy=function(t){var e=Cm(t,BV," "),n=4;try{return Hy(e)}catch{for(;n;)e=Cm(e,GV(n--),WV);return e}},HV=/[!'()~]|%20/g,KV={"!":"%21","'":"%27","(":"%28",")":"%29","~":"%7E","%20":"+"},qV=function(t){return KV[t]},Xy=function(t){return Cm(xV(t),HV,qV)},vm=yV(function(t,e){By(this,{type:jy,iterator:Tm(Pr(t).entries),kind:e})},"Iterator",function(){var t=LV(this),e=t.kind,n=t.iterator.next(),i=n.value;return n.done||(n.value=e==="keys"?i.key:e==="values"?i.value:[i.key,i.value]),n},!0),Qy=function(t){this.entries=[],this.url=null,t!==void 0&&(Vy(t)?this.parseObject(t):this.parseQuery(typeof t=="string"?VV(t,0)==="?"?jV(t,1):t:Bi(t)))};Qy.prototype={type:ju,bindURL:function(t){this.url=t,this.update()},parseObject:function(t){var e,n,i,r,o,s,a,c=NV(t);if(c)for(n=(e=Tm(t,c)).next;!(i=Tp(n,e)).done;){if(o=(r=Tm(wV(i.value))).next,(s=Tp(o,r)).done||(a=Tp(o,r)).done||!Tp(o,r).done)throw UV("Expected sequence with length 2");ka(this.entries,{key:Bi(s.value),value:Bi(a.value)})}else for(var d in t)IV(t,d)&&ka(this.entries,{key:d,value:Bi(t[d])})},parseQuery:function(t){if(t)for(var e,n,i=Yy(t,"&"),r=0;r<i.length;)(e=i[r++]).length&&(n=Yy(e,"="),ka(this.entries,{key:Jy(FV(n)),value:Jy(Ky(n,"="))}))},serialize:function(){for(var t,e=this.entries,n=[],i=0;i<e.length;)t=e[i++],ka(n,Xy(t.key)+"="+Xy(t.value));return Ky(n,"&")},update:function(){this.entries.length=0,this.parseQuery(this.url.query)},updateURL:function(){this.url&&this.url.update()}};var Rp=function(){xy(this,Jc);var t=By(this,new Qy(arguments.length>0?arguments[0]:void 0));Yc||(this.size=t.entries.length)},Jc=Rp.prototype;if(CV(Jc,{append:function(t,e){var n=Pr(this);zc(arguments.length,2),ka(n.entries,{key:Bi(t),value:Bi(e)}),Yc||this.length++,n.updateURL()},delete:function(t){for(var e=Pr(this),n=zc(arguments.length,1),i=e.entries,r=Bi(t),o=n<2?void 0:arguments[1],s=o===void 0?o:Bi(o),a=0;a<i.length;){var c=i[a];if(c.key!==r||s!==void 0&&c.value!==s)a++;else if(qy(i,a,1),s!==void 0)break}Yc||(this.size=i.length),e.updateURL()},get:function(t){var e=Pr(this).entries;zc(arguments.length,1);for(var n=Bi(t),i=0;i<e.length;i++)if(e[i].key===n)return e[i].value;return null},getAll:function(t){var e=Pr(this).entries;zc(arguments.length,1);for(var n=Bi(t),i=[],r=0;r<e.length;r++)e[r].key===n&&ka(i,e[r].value);return i},has:function(t){for(var e=Pr(this).entries,n=zc(arguments.length,1),i=Bi(t),r=n<2?void 0:arguments[1],o=r===void 0?r:Bi(r),s=0;s<e.length;){var a=e[s++];if(a.key===i&&(o===void 0||a.value===o))return!0}return!1},set:function(t,e){var n=Pr(this);zc(arguments.length,1);for(var i,r=n.entries,o=!1,s=Bi(t),a=Bi(e),c=0;c<r.length;c++)(i=r[c]).key===s&&(o?qy(r,c--,1):(o=!0,i.value=a));o||ka(r,{key:s,value:a}),Yc||(this.size=r.length),n.updateURL()},sort:function(){var t=Pr(this);DV(t.entries,function(e,n){return e.key>n.key?1:-1}),t.updateURL()},forEach:function(t){for(var e,n=Pr(this).entries,i=bV(t,arguments.length>1?arguments[1]:void 0),r=0;r<n.length;)i((e=n[r++]).value,e.key,this)},keys:function(){return new vm(this,"keys")},values:function(){return new vm(this,"values")},entries:function(){return new vm(this,"entries")}},{enumerable:!0}),Uy(Jc,PV,Jc.entries,{name:"entries"}),Uy(Jc,"toString",function(){return Pr(this).serialize()},{enumerable:!0}),Yc&&RV(Jc,"size",{get:function(){return Pr(this).entries.length},configurable:!0,enumerable:!0}),vV(Rp,ju),Em({global:!0,constructor:!0,forced:!My},{URLSearchParams:Rp}),!My&&gm(Bu)){var YV=Lo(Wy.has),zV=Lo(Wy.set),Zy=function(t){if(Vy(t)){var e,n=t.body;if(AV(n)===ju)return e=t.headers?new Bu(t.headers):new Bu,YV(e,"content-type")||zV(e,"content-type","application/x-www-form-urlencoded;charset=UTF-8"),OV(t,{body:Fy(0,Bi(n)),headers:Fy(0,e)})}return t};if(gm(Gy)&&Em({global:!0,enumerable:!0,dontCallGetSet:!0,forced:!0},{fetch:function(t){return Gy(t,arguments.length>1?Zy(arguments[1]):{})}}),gm(Sp)){var ym=function(t){return xy(this,Rm),new Sp(t,arguments.length>1?Zy(arguments[1]):{})};Rm.constructor=ym,ym.prototype=Rm,Em({global:!0,constructor:!0,dontCallGetSet:!0,forced:!0},{Request:ym})}}var JV={URLSearchParams:Rp,getState:Pr},$y=Dt(Bn.URLSearchParams),XV={isBrowser:!0,classes:{URLSearchParams:$y!==void 0?$y:tm,FormData:typeof FormData!="undefined"?FormData:null,Blob:typeof Blob!="undefined"?Blob:null},protocols:["http","https","file","blob","url","data"]};const tI=typeof window!="undefined"&&typeof document!="undefined",QV=(eI=typeof navigator!="undefined"&&navigator.product,tI&&["ReactNative","NativeScript","NS"].indexOf(eI)<0);var eI;const ZV=typeof WorkerGlobalScope!="undefined"&&self instanceof WorkerGlobalScope&&typeof self.importScripts=="function";function nI(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),n.push.apply(n,i)}return n}function iI(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?nI(Object(n),!0).forEach(function(i){R(t,i,n[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):nI(Object(n)).forEach(function(i){Object.defineProperty(t,i,Object.getOwnPropertyDescriptor(n,i))})}return t}var ko=iI(iI({},Object.freeze({__proto__:null,hasBrowserEnv:tI,hasStandardBrowserEnv:QV,hasStandardBrowserWebWorkerEnv:ZV})),XV),$V=Gn,tF=cn,eF=Dn,nF=Jn,iF=function(){var t=$V(this),e="";return t.hasIndices&&(e+="d"),t.global&&(e+="g"),t.ignoreCase&&(e+="i"),t.multiline&&(e+="m"),t.dotAll&&(e+="s"),t.unicode&&(e+="u"),t.unicodeSets&&(e+="v"),t.sticky&&(e+="y"),e},rI=RegExp.prototype,oI=function(t){var e=t.flags;return e!==void 0||"flags"in rI||eF(t,"flags")||!nF(rI,t)?e:tF(iF,t)},rF=DE.charAt,sI=cn,oF=Gn,sF=pn,aF=I,cF=/./.exec,dF=TypeError,uF=$t,aI=cn,cI=ga,lF=Q_,Cp=$_,dI=ws,uI=ji,Gu=x,hF=Gn,pF=dr,fF=I,_F=Oc,lI=oI,EF=rs,mF=Pt,gF=rE,TF=function(t,e,n){return e+(n?rF(t,e).length:1)},SF=function(t,e){var n=t.exec;if(sF(n)){var i=sI(n,t,e);return i!==null&&oF(i),i}if(aF(t)==="RegExp")return sI(cF,t,e);throw dF("RegExp#exec called on incompatible receiver")},hI=Oa,RF=Ze("matchAll"),pI="RegExp String",fI=pI+" Iterator",CF=hI.set,vF=hI.getterFor(fI),yF=TypeError,Im=cI("".indexOf),vp=cI("".matchAll),bm=!!vp&&!mF(function(){vp("a",/./)}),IF=lF(function(t,e,n,i){CF(this,{type:fI,regexp:t,string:e,global:n,unicode:i,done:!1})},pI,function(){var t=vF(this);if(t.done)return Cp(void 0,!0);var e=t.regexp,n=t.string,i=SF(e,n);return i===null?(t.done=!0,Cp(void 0,!0)):t.global?(Gu(i[0])===""&&(e.lastIndex=TF(n,uI(e.lastIndex),t.unicode)),Cp(i,!1)):(t.done=!0,Cp(i,!1))}),_I=function(t){var e,n,i,r=hF(this),o=Gu(t),s=gF(r,RegExp),a=Gu(lI(r));return e=new s(s===RegExp?r.source:r,a),n=!!~Im(a,"g"),i=!!~Im(a,"u"),e.lastIndex=uI(r.lastIndex),new IF(e,o,n,i)};uF({target:"String",proto:!0,forced:bm},{matchAll:function(t){var e,n,i,r,o=dI(this);if(pF(t)){if(bm)return vp(o,t)}else{if(_F(t)&&(e=Gu(dI(lI(t))),!~Im(e,"g")))throw yF("`.matchAll` does not allow non-global regexes");if(bm)return vp(o,t);if((i=EF(t,RF))===void 0&&fF(t)=="RegExp"&&(i=_I),i)return aI(i,t,o)}return n=Gu(o),r=new RegExp(t,"g"),aI(_I,r,n)}});var bF=oi("String").matchAll,AF=Jn,wF=bF,Am=String.prototype,OF=function(t){var e=t.matchAll;return typeof t=="string"||t===Am||AF(Am,t)&&e===Am.matchAll?wF:e},NF=Dt(OF);function EI(t){function e(n,i,r,o){let s=n[o++];if(s==="__proto__")return!0;const a=Number.isFinite(+s),c=o>=n.length;return s=!s&&pt.isArray(r)?r.length:s,c?(pt.hasOwnProp(r,s)?r[s]=[r[s],i]:r[s]=i,!a):(r[s]&&pt.isObject(r[s])||(r[s]=[]),e(n,i,r[s],o)&&pt.isArray(r[s])&&(r[s]=function(d){const u={},l=Object.keys(d);let p;const f=l.length;let C;for(p=0;p<f;p++)C=l[p],u[C]=d[C];return u}(r[s])),!a)}if(pt.isFormData(t)&&pt.isFunction(t.entries)){const n={};return pt.forEachEntry(t,(i,r)=>{e(function(o){return NF(pt).call(pt,/\w+|\[(\w*)]/g,o).map(s=>s[0]==="[]"?"":s[1]||s[0])}(i),r,n,0)}),n}return null}const wm={transitional:yv,adapter:["xhr","http"],transformRequest:[function(t,e){const n=e.getContentType()||"",i=n.indexOf("application/json")>-1,r=pt.isObject(t);if(r&&pt.isHTMLForm(t)&&(t=new FormData(t)),pt.isFormData(t))return i?JSON.stringify(EI(t)):t;if(pt.isArrayBuffer(t)||pt.isBuffer(t)||pt.isStream(t)||pt.isFile(t)||pt.isBlob(t))return t;if(pt.isArrayBufferView(t))return t.buffer;if(pt.isURLSearchParams(t))return e.setContentType("application/x-www-form-urlencoded;charset=utf-8",!1),t.toString();let o;if(r){if(n.indexOf("application/x-www-form-urlencoded")>-1)return function(s,a){return up(s,new ko.classes.URLSearchParams,Object.assign({visitor:function(c,d,u,l){return ko.isNode&&pt.isBuffer(c)?(this.append(d,c.toString("base64")),!1):l.defaultVisitor.apply(this,arguments)}},a))}(t,this.formSerializer).toString();if((o=pt.isFileList(t))||n.indexOf("multipart/form-data")>-1){const s=this.env&&this.env.FormData;return up(o?{"files[]":t}:t,s&&new s,this.formSerializer)}}return r||i?(e.setContentType("application/json",!1),function(s,a,c){if(pt.isString(s))try{return(a||JSON.parse)(s),si(pt).call(pt,s)}catch(d){if(d.name!=="SyntaxError")throw d}return(c||JSON.stringify)(s)}(t)):t}],transformResponse:[function(t){const e=this.transitional||wm.transitional,n=e&&e.forcedJSONParsing,i=this.responseType==="json";if(t&&pt.isString(t)&&(n&&!this.responseType||i)){const r=!(e&&e.silentJSONParsing)&&i;try{return JSON.parse(t)}catch(o){if(r)throw o.name==="SyntaxError"?We.from(o,We.ERR_BAD_RESPONSE,this,null,this.response):o}}return t}],timeout:0,xsrfCookieName:"XSRF-TOKEN",xsrfHeaderName:"X-XSRF-TOKEN",maxContentLength:-1,maxBodyLength:-1,env:{FormData:ko.classes.FormData,Blob:ko.classes.Blob},validateStatus:function(t){return t>=200&&t<300},headers:{common:{Accept:"application/json, text/plain, */*","Content-Type":void 0}}};pt.forEach(["delete","get","head","post","put","patch"],t=>{wm.headers[t]={}});var Om=wm;const DF=pt.toObjectSet(["age","authorization","content-length","content-type","etag","expires","from","host","if-modified-since","if-unmodified-since","last-modified","location","max-forwards","proxy-authorization","referer","retry-after","user-agent"]),mI=Symbol("internals");function Wu(t){var e;return t&&si(e=String(t)).call(e).toLowerCase()}function yp(t){return t===!1||t==null?t:pt.isArray(t)?t.map(yp):String(t)}function Nm(t,e,n,i,r){return pt.isFunction(i)?i.call(this,e,n):(r&&(e=n),pt.isString(e)?pt.isString(i)?e.indexOf(i)!==-1:pt.isRegExp(i)?i.test(e):void 0:void 0)}class Ip{constructor(e){e&&this.set(e)}set(e,n,i){const r=this;function o(c,d,u){const l=Wu(d);if(!l)throw new Error("header name must be a non-empty string");const p=pt.findKey(r,l);(!p||r[p]===void 0||u===!0||u===void 0&&r[p]!==!1)&&(r[p||d]=yp(c))}const s=(c,d)=>pt.forEach(c,(u,l)=>o(u,l,d));var a;return pt.isPlainObject(e)||e instanceof this.constructor?s(e,n):pt.isString(e)&&(e=si(e).call(e))&&!/^[-_a-zA-Z0-9^`|~,!#$%&'*+.]+$/.test(si(a=e).call(a))?s((c=>{const d={};let u,l,p;return c&&c.split(`
`).forEach(function(f){var C,m;p=f.indexOf(":"),u=si(C=f.substring(0,p)).call(C).toLowerCase(),l=si(m=f.substring(p+1)).call(m),!u||d[u]&&DF[u]||(u==="set-cookie"?d[u]?d[u].push(l):d[u]=[l]:d[u]=d[u]?d[u]+", "+l:l)}),d})(e),n):e!=null&&o(n,e,i),this}get(e,n){if(e=Wu(e)){const i=pt.findKey(this,e);if(i){const r=this[i];if(!n)return r;if(n===!0)return function(o){const s=Object.create(null),a=/([^\s,;=]+)\s*(?:=\s*([^,;]+))?/g;let c;for(;c=a.exec(o);)s[c[1]]=c[2];return s}(r);if(pt.isFunction(n))return n.call(this,r,i);if(pt.isRegExp(n))return n.exec(r);throw new TypeError("parser must be boolean|regexp|function")}}}has(e,n){if(e=Wu(e)){const i=pt.findKey(this,e);return!(!i||this[i]===void 0||n&&!Nm(0,this[i],i,n))}return!1}delete(e,n){const i=this;let r=!1;function o(s){if(s=Wu(s)){const a=pt.findKey(i,s);!a||n&&!Nm(0,i[a],a,n)||(delete i[a],r=!0)}}return pt.isArray(e)?e.forEach(o):o(e),r}clear(e){const n=Object.keys(this);let i=n.length,r=!1;for(;i--;){const o=n[i];e&&!Nm(0,this[o],o,e,!0)||(delete this[o],r=!0)}return r}normalize(e){const n=this,i={};return pt.forEach(this,(r,o)=>{var s;const a=pt.findKey(i,o);if(a)return n[a]=yp(r),void delete n[o];const c=e?function(d){return si(d).call(d).toLowerCase().replace(/([a-z\d])(\w*)/g,(u,l,p)=>l.toUpperCase()+p)}(o):si(s=String(o)).call(s);c!==o&&delete n[o],n[c]=yp(r),i[c]=!0}),this}concat(){for(var e=arguments.length,n=new Array(e),i=0;i<e;i++)n[i]=arguments[i];return this.constructor.concat(this,...n)}toJSON(e){const n=Object.create(null);return pt.forEach(this,(i,r)=>{i!=null&&i!==!1&&(n[r]=e&&pt.isArray(i)?i.join(", "):i)}),n}[Symbol.iterator](){return Object.entries(this.toJSON())[Symbol.iterator]()}toString(){return Object.entries(this.toJSON()).map(e=>{let[n,i]=e;return n+": "+i}).join(`
`)}get[Symbol.toStringTag](){return"AxiosHeaders"}static from(e){return e instanceof this?e:new this(e)}static concat(e){const n=new this(e);for(var i=arguments.length,r=new Array(i>1?i-1:0),o=1;o<i;o++)r[o-1]=arguments[o];return r.forEach(s=>n.set(s)),n}static accessor(e){const n=(this[mI]=this[mI]={accessors:{}}).accessors,i=this.prototype;function r(o){const s=Wu(o);n[s]||(function(a,c){const d=pt.toCamelCase(" "+c);["get","set","has"].forEach(u=>{Object.defineProperty(a,u+d,{value:function(l,p,f){return this[u].call(this,c,l,p,f)},configurable:!0})})}(i,o),n[s]=!0)}return pt.isArray(e)?e.forEach(r):r(e),this}}Ip.accessor(["Content-Type","Content-Length","Accept","Accept-Encoding","User-Agent","Authorization"]),pt.reduceDescriptors(Ip.prototype,(t,e)=>{let{value:n}=t,i=e[0].toUpperCase()+e.slice(1);return{get:()=>n,set(r){this[i]=r}}}),pt.freezeMethods(Ip);var ls=Ip;function Dm(t,e){const n=this||Om,i=e||n,r=ls.from(i.headers);let o=i.data;return pt.forEach(t,function(s){o=s.call(n,o,r.normalize(),e?e.status:void 0)}),r.normalize(),o}function gI(t){return!(!t||!t.__CANCEL__)}function Hu(t,e,n){We.call(this,t==null?"canceled":t,We.ERR_CANCELED,e,n),this.name="CanceledError"}pt.inherits(Hu,We,{__CANCEL__:!0});var PF=ko.hasStandardBrowserEnv?{write(t,e,n,i,r,o){const s=[t+"="+encodeURIComponent(e)];pt.isNumber(n)&&s.push("expires="+new Date(n).toGMTString()),pt.isString(i)&&s.push("path="+i),pt.isString(r)&&s.push("domain="+r),o===!0&&s.push("secure"),document.cookie=s.join("; ")},read(t){const e=document.cookie.match(new RegExp("(^|;\\s*)("+t+")=([^;]*)"));return e?decodeURIComponent(e[3]):null},remove(t){this.write(t,"",Date.now()-864e5)}}:{write(){},read:()=>null,remove(){}};function TI(t,e){return t&&!function(n){return/^([a-z][a-z\d+\-.]*:)?\/\//i.test(n)}(e)?function(n,i){return i?n.replace(/\/?\/$/,"")+"/"+i.replace(/^\/+/,""):n}(t,e):e}var LF=ko.hasStandardBrowserEnv?function(){const t=/(msie|trident)/i.test(navigator.userAgent),e=document.createElement("a");let n;function i(r){let o=r;return t&&(e.setAttribute("href",o),o=e.href),e.setAttribute("href",o),{href:e.href,protocol:e.protocol?e.protocol.replace(/:$/,""):"",host:e.host,search:e.search?e.search.replace(/^\?/,""):"",hash:e.hash?e.hash.replace(/^#/,""):"",hostname:e.hostname,port:e.port,pathname:e.pathname.charAt(0)==="/"?e.pathname:"/"+e.pathname}}return n=i(window.location.href),function(r){const o=pt.isString(r)?i(r):r;return o.protocol===n.protocol&&o.host===n.host}}():function(){return!0};function SI(t,e){let n=0;const i=function(r,o){r=r||10;const s=new Array(r),a=new Array(r);let c,d=0,u=0;return o=o!==void 0?o:1e3,function(l){const p=Date.now(),f=a[u];c||(c=p),s[d]=l,a[d]=p;let C=u,m=0;for(;C!==d;)m+=s[C++],C%=r;if(d=(d+1)%r,d===u&&(u=(u+1)%r),p-c<o)return;const g=f&&p-f;return g?Math.round(1e3*m/g):void 0}}(50,250);return r=>{const o=r.loaded,s=r.lengthComputable?r.total:void 0,a=o-n,c=i(a);n=o;const d={loaded:o,total:s,progress:s?o/s:void 0,bytes:a,rate:c||void 0,estimated:c&&s&&o<=s?(s-o)/c:void 0,event:r};d[e?"download":"upload"]=!0,t(d)}}var kF=typeof XMLHttpRequest!="undefined"&&function(t){return new ot(function(e,n){let i=t.data;const r=ls.from(t.headers).normalize();let o,s,{responseType:a,withXSRFToken:c}=t;function d(){t.cancelToken&&t.cancelToken.unsubscribe(o),t.signal&&t.signal.removeEventListener("abort",o)}if(pt.isFormData(i)){if(ko.hasStandardBrowserEnv||ko.hasStandardBrowserWebWorkerEnv)r.setContentType(!1);else if((s=r.getContentType())!==!1){const[C,...m]=s?s.split(";").map(g=>si(g).call(g)).filter(Boolean):[];r.setContentType([C||"multipart/form-data",...m].join("; "))}}let u=new XMLHttpRequest;if(t.auth){const C=t.auth.username||"",m=t.auth.password?unescape(encodeURIComponent(t.auth.password)):"";r.set("Authorization","Basic "+btoa(C+":"+m))}const l=TI(t.baseURL,t.url);function p(){if(!u)return;const C=ls.from("getAllResponseHeaders"in u&&u.getAllResponseHeaders());(function(m,g,y){const A=y.config.validateStatus;y.status&&A&&!A(y.status)?g(new We("Request failed with status code "+y.status,[We.ERR_BAD_REQUEST,We.ERR_BAD_RESPONSE][Math.floor(y.status/100)-4],y.config,y.request,y)):m(y)})(function(m){e(m),d()},function(m){n(m),d()},{data:a&&a!=="text"&&a!=="json"?u.response:u.responseText,status:u.status,statusText:u.statusText,headers:C,config:t,request:u}),u=null}if(u.open(t.method.toUpperCase(),Cv(l,t.params,t.paramsSerializer),!0),u.timeout=t.timeout,"onloadend"in u?u.onloadend=p:u.onreadystatechange=function(){u&&u.readyState===4&&(u.status!==0||u.responseURL&&u.responseURL.indexOf("file:")===0)&&setTimeout(p)},u.onabort=function(){u&&(n(new We("Request aborted",We.ECONNABORTED,t,u)),u=null)},u.onerror=function(){n(new We("Network Error",We.ERR_NETWORK,t,u)),u=null},u.ontimeout=function(){let C=t.timeout?"timeout of "+t.timeout+"ms exceeded":"timeout exceeded";const m=t.transitional||yv;t.timeoutErrorMessage&&(C=t.timeoutErrorMessage),n(new We(C,m.clarifyTimeoutError?We.ETIMEDOUT:We.ECONNABORTED,t,u)),u=null},ko.hasStandardBrowserEnv&&(c&&pt.isFunction(c)&&(c=c(t)),c||c!==!1&&LF(l))){const C=t.xsrfHeaderName&&t.xsrfCookieName&&PF.read(t.xsrfCookieName);C&&r.set(t.xsrfHeaderName,C)}i===void 0&&r.setContentType(null),"setRequestHeader"in u&&pt.forEach(r.toJSON(),function(C,m){u.setRequestHeader(m,C)}),pt.isUndefined(t.withCredentials)||(u.withCredentials=!!t.withCredentials),a&&a!=="json"&&(u.responseType=t.responseType),typeof t.onDownloadProgress=="function"&&u.addEventListener("progress",SI(t.onDownloadProgress,!0)),typeof t.onUploadProgress=="function"&&u.upload&&u.upload.addEventListener("progress",SI(t.onUploadProgress)),(t.cancelToken||t.signal)&&(o=C=>{u&&(n(!C||C.type?new Hu(null,t,u):C),u.abort(),u=null)},t.cancelToken&&t.cancelToken.subscribe(o),t.signal&&(t.signal.aborted?o():t.signal.addEventListener("abort",o)));const f=function(C){const m=/^([-+\w]{1,25})(:?\/\/|:)/.exec(C);return m&&m[1]||""}(l);f&&ko.protocols.indexOf(f)===-1?n(new We("Unsupported protocol "+f+":",We.ERR_BAD_REQUEST,t)):u.send(i||null)})};const Pm={http:null,xhr:kF};pt.forEach(Pm,(t,e)=>{if(t){try{Object.defineProperty(t,"name",{value:e})}catch{}Object.defineProperty(t,"adapterName",{value:e})}});const RI=t=>"- ".concat(t),MF=t=>pt.isFunction(t)||t===null||t===!1;var CI={getAdapter:t=>{t=pt.isArray(t)?t:[t];const{length:e}=t;let n,i;const r={};for(let o=0;o<e;o++){let s;if(n=t[o],i=n,!MF(n)&&(i=Pm[(s=String(n)).toLowerCase()],i===void 0))throw new We("Unknown adapter '".concat(s,"'"));if(i)break;r[s||"#"+o]=i}if(!i){const o=Object.entries(r).map(s=>{let[a,c]=s;return"adapter ".concat(a," ")+(c===!1?"is not supported by the environment":"is not available in the build")});throw new We("There is no suitable adapter to dispatch the request "+(e?o.length>1?`since :
`+o.map(RI).join(`
`):" "+RI(o[0]):"as no adapter specified"),"ERR_NOT_SUPPORT")}return i},adapters:Pm};function Lm(t){if(t.cancelToken&&t.cancelToken.throwIfRequested(),t.signal&&t.signal.aborted)throw new Hu(null,t)}function vI(t){return Lm(t),t.headers=ls.from(t.headers),t.data=Dm.call(t,t.transformRequest),["post","put","patch"].indexOf(t.method)!==-1&&t.headers.setContentType("application/x-www-form-urlencoded",!1),CI.getAdapter(t.adapter||Om.adapter)(t).then(function(e){return Lm(t),e.data=Dm.call(t,t.transformResponse,e),e.headers=ls.from(e.headers),e},function(e){return gI(e)||(Lm(t),e&&e.response&&(e.response.data=Dm.call(t,t.transformResponse,e.response),e.response.headers=ls.from(e.response.headers))),ot.reject(e)})}function yI(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),n.push.apply(n,i)}return n}const II=t=>t instanceof ls?function(e){for(var n=1;n<arguments.length;n++){var i=arguments[n]!=null?arguments[n]:{};n%2?yI(Object(i),!0).forEach(function(r){R(e,r,i[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):yI(Object(i)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(i,r))})}return e}({},t):t;function Xc(t,e){e=e||{};const n={};function i(d,u,l){return pt.isPlainObject(d)&&pt.isPlainObject(u)?pt.merge.call({caseless:l},d,u):pt.isPlainObject(u)?pt.merge({},u):pt.isArray(u)?u.slice():u}function r(d,u,l){return pt.isUndefined(u)?pt.isUndefined(d)?void 0:i(void 0,d,l):i(d,u,l)}function o(d,u){if(!pt.isUndefined(u))return i(void 0,u)}function s(d,u){return pt.isUndefined(u)?pt.isUndefined(d)?void 0:i(void 0,d):i(void 0,u)}function a(d,u,l){return l in e?i(d,u):l in t?i(void 0,d):void 0}const c={url:o,method:o,data:o,baseURL:s,transformRequest:s,transformResponse:s,paramsSerializer:s,timeout:s,timeoutMessage:s,withCredentials:s,withXSRFToken:s,adapter:s,responseType:s,xsrfCookieName:s,xsrfHeaderName:s,onUploadProgress:s,onDownloadProgress:s,decompress:s,maxContentLength:s,maxBodyLength:s,beforeRedirect:s,transport:s,httpAgent:s,httpsAgent:s,cancelToken:s,socketPath:s,responseEncoding:s,validateStatus:a,headers:(d,u)=>r(II(d),II(u),!0)};return pt.forEach(Object.keys(Object.assign({},t,e)),function(d){const u=c[d]||r,l=u(t[d],e[d],d);pt.isUndefined(l)&&u!==a||(n[d]=l)}),n}const bI="1.6.8",km={};["object","boolean","number","function","string","symbol"].forEach((t,e)=>{km[t]=function(n){return typeof n===t||"a"+(e<1?"n ":" ")+t}});const AI={};km.transitional=function(t,e,n){function i(r,o){return"[Axios v"+bI+"] Transitional option '"+r+"'"+o+(n?". "+n:"")}return(r,o,s)=>{if(t===!1)throw new We(i(o," has been removed"+(e?" in "+e:"")),We.ERR_DEPRECATED);return e&&!AI[o]&&(AI[o]=!0,console.warn(i(o," has been deprecated since v"+e+" and will be removed in the near future"))),!t||t(r,o,s)}};var Mm={assertOptions:function(t,e,n){if(typeof t!="object")throw new We("options must be an object",We.ERR_BAD_OPTION_VALUE);const i=Object.keys(t);let r=i.length;for(;r-- >0;){const o=i[r],s=e[o];if(s){const a=t[o],c=a===void 0||s(a,o,t);if(c!==!0)throw new We("option "+o+" must be "+c,We.ERR_BAD_OPTION_VALUE)}else if(n!==!0)throw new We("Unknown option "+o,We.ERR_BAD_OPTION)}},validators:km};const Bs=Mm.validators;let bp=class{constructor(t){this.defaults=t,this.interceptors={request:new vv,response:new vv}}async request(t,e){try{return await this._request(t,e)}catch(n){if(n instanceof Error){let i;Error.captureStackTrace?Error.captureStackTrace(i={}):i=new Error;const r=i.stack?i.stack.replace(/^.+\n/,""):"";n.stack?r&&!String(n.stack).endsWith(r.replace(/^.+\n.+\n/,""))&&(n.stack+=`
`+r):n.stack=r}throw n}}_request(t,e){typeof t=="string"?(e=e||{}).url=t:e=t||{},e=Xc(this.defaults,e);const{transitional:n,paramsSerializer:i,headers:r}=e;n!==void 0&&Mm.assertOptions(n,{silentJSONParsing:Bs.transitional(Bs.boolean),forcedJSONParsing:Bs.transitional(Bs.boolean),clarifyTimeoutError:Bs.transitional(Bs.boolean)},!1),i!=null&&(pt.isFunction(i)?e.paramsSerializer={serialize:i}:Mm.assertOptions(i,{encode:Bs.function,serialize:Bs.function},!0)),e.method=(e.method||this.defaults.method||"get").toLowerCase();let o=r&&pt.merge(r.common,r[e.method]);r&&pt.forEach(["delete","get","head","post","put","patch","common"],f=>{delete r[f]}),e.headers=ls.concat(o,r);const s=[];let a=!0;this.interceptors.request.forEach(function(f){typeof f.runWhen=="function"&&f.runWhen(e)===!1||(a=a&&f.synchronous,s.unshift(f.fulfilled,f.rejected))});const c=[];let d;this.interceptors.response.forEach(function(f){c.push(f.fulfilled,f.rejected)});let u,l=0;if(!a){const f=[vI.bind(this),void 0];for(f.unshift.apply(f,s),f.push.apply(f,c),u=f.length,d=ot.resolve(e);l<u;)d=d.then(f[l++],f[l++]);return d}u=s.length;let p=e;for(l=0;l<u;){const f=s[l++],C=s[l++];try{p=f(p)}catch(m){C.call(this,m);break}}try{d=vI.call(this,p)}catch(f){return ot.reject(f)}for(l=0,u=c.length;l<u;)d=d.then(c[l++],c[l++]);return d}getUri(t){return Cv(TI((t=Xc(this.defaults,t)).baseURL,t.url),t.params,t.paramsSerializer)}};pt.forEach(["delete","get","head","options"],function(t){bp.prototype[t]=function(e,n){return this.request(Xc(n||{},{method:t,url:e,data:(n||{}).data}))}}),pt.forEach(["post","put","patch"],function(t){function e(n){return function(i,r,o){return this.request(Xc(o||{},{method:t,headers:n?{"Content-Type":"multipart/form-data"}:{},url:i,data:r}))}}bp.prototype[t]=e(),bp.prototype[t+"Form"]=e(!0)});var Ap=bp;class Um{constructor(e){if(typeof e!="function")throw new TypeError("executor must be a function.");let n;this.promise=new ot(function(r){n=r});const i=this;this.promise.then(r=>{if(!i._listeners)return;let o=i._listeners.length;for(;o-- >0;)i._listeners[o](r);i._listeners=null}),this.promise.then=r=>{let o;const s=new ot(a=>{i.subscribe(a),o=a}).then(r);return s.cancel=function(){i.unsubscribe(o)},s},e(function(r,o,s){i.reason||(i.reason=new Hu(r,o,s),n(i.reason))})}throwIfRequested(){if(this.reason)throw this.reason}subscribe(e){this.reason?e(this.reason):this._listeners?this._listeners.push(e):this._listeners=[e]}unsubscribe(e){if(!this._listeners)return;const n=this._listeners.indexOf(e);n!==-1&&this._listeners.splice(n,1)}static source(){let e;return{token:new Um(function(n){e=n}),cancel:e}}}var UF=Um;const xm={Continue:100,SwitchingProtocols:101,Processing:102,EarlyHints:103,Ok:200,Created:201,Accepted:202,NonAuthoritativeInformation:203,NoContent:204,ResetContent:205,PartialContent:206,MultiStatus:207,AlreadyReported:208,ImUsed:226,MultipleChoices:300,MovedPermanently:301,Found:302,SeeOther:303,NotModified:304,UseProxy:305,Unused:306,TemporaryRedirect:307,PermanentRedirect:308,BadRequest:400,Unauthorized:401,PaymentRequired:402,Forbidden:403,NotFound:404,MethodNotAllowed:405,NotAcceptable:406,ProxyAuthenticationRequired:407,RequestTimeout:408,Conflict:409,Gone:410,LengthRequired:411,PreconditionFailed:412,PayloadTooLarge:413,UriTooLong:414,UnsupportedMediaType:415,RangeNotSatisfiable:416,ExpectationFailed:417,ImATeapot:418,MisdirectedRequest:421,UnprocessableEntity:422,Locked:423,FailedDependency:424,TooEarly:425,UpgradeRequired:426,PreconditionRequired:428,TooManyRequests:429,RequestHeaderFieldsTooLarge:431,UnavailableForLegalReasons:451,InternalServerError:500,NotImplemented:501,BadGateway:502,ServiceUnavailable:503,GatewayTimeout:504,HttpVersionNotSupported:505,VariantAlsoNegotiates:506,InsufficientStorage:507,LoopDetected:508,NotExtended:510,NetworkAuthenticationRequired:511};Object.entries(xm).forEach(t=>{let[e,n]=t;xm[n]=e});var xF=xm;const ti=function t(e){const n=new Ap(e),i=sv(Ap.prototype.request,n);return pt.extend(i,Ap.prototype,n,{allOwnKeys:!0}),pt.extend(i,n,null,{allOwnKeys:!0}),i.create=function(r){return t(Xc(e,r))},i}(Om);ti.Axios=Ap,ti.CanceledError=Hu,ti.CancelToken=UF,ti.isCancel=gI,ti.VERSION=bI,ti.toFormData=up,ti.AxiosError=We,ti.Cancel=ti.CanceledError,ti.all=function(t){return ot.all(t)},ti.spread=function(t){return function(e){return t.apply(null,e)}},ti.isAxiosError=function(t){return pt.isObject(t)&&t.isAxiosError===!0},ti.mergeConfig=Xc,ti.AxiosHeaders=ls,ti.formToJSON=t=>EI(pt.isHTMLForm(t)?new FormData(t):t),ti.getAdapter=CI.getAdapter,ti.HttpStatusCode=xF,ti.default=ti;var yi=ti;const VF=()=>{};function Ku(){const t={promise:void 0,isResolved:!1,isRejected:!1,isFinished:!1,resolve:void 0,reject:void 0,cancel:VF};return t.promise=new ot((e,n)=>{t.resolve=i=>{t.isFinished||(t.isResolved=!0,t.isFinished=!0,e(i),t.value=i)},t.reject=i=>{t.isFinished||(t.isRejected=!0,t.isFinished=!0,n(i))}}),t}const wp=new Map,Op=new Map,Mo=new Map;let bn=function(t){return t.WIN_10="Windows 10",t.WIN_81="Windows 8.1",t.WIN_8="Windows 8",t.WIN_7="Windows 7",t.WIN_VISTA="Windows Vista",t.WIN_SERVER_2003="Windows Server 2003",t.WIN_XP="Windows XP",t.WIN_2000="Windows 2000",t.ANDROID="Android",t.HARMONY_OS="HarmonyOS",t.OPEN_BSD="Open BSD",t.SUN_OS="Sun OS",t.LINUX="Linux",t.IOS="iOS",t.MAC_OS="Mac OS",t.CHROMIUM_OS="Chromium OS",t.QNX="QNX",t.UNIX="UNIX",t.BEOS="BeOS",t.OS_2="OS/2",t.SEARCH_BOT="Search Bot",t}({}),ue=function(t){return t.CHROME="Chrome",t.SAFARI="Safari",t.EDGE="Edge",t.FIREFOX="Firefox",t.OPERA="OPR",t.QQ="QQBrowser",t.WECHAT="MicroMessenger",t}({});const Vm=new ox;let oo=Vm.getResult(),Fm=null;function Zt(t){if(!Fm){t&&Vm.setUA(t),oo=Vm.getResult();const e=function(a){if(a.engine.name==="Blink"&&a.browser.name!=="WeChat")return ue.CHROME;switch(a.browser.name){case"Chrome Headless":case"Chrome":case"Chromium":return ue.CHROME;case"Safari":case"Mobile Safari":return ue.SAFARI;case"Edge":return ue.EDGE;case"Firefox":return ue.FIREFOX;case"QQ":case"QQBrowser":return ue.QQ;case"Opera":return ue.OPERA;case"WeChat":return ue.WECHAT;default:return a.browser.name||""}}(oo),n=wI(oo),i=function(a){return a.os.name==="Windows"?a.os.version?a.os.name+" "+a.os.version:a.os.name:a.os.name||""}(oo),r=oo.os.version,o=wI(oo,!1),s=oo.device.type;if(!(e&&n&&i&&r))return{name:e,version:n,os:i,osVersion:r,browserVersion:o,deviceType:s};Fm={name:e,version:n,os:i,osVersion:r,browserVersion:o,deviceType:s}}return Fm}function wI(t){let e,n=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1];return e=t.engine.name==="Blink"?t.engine.version||"":t.browser.version||"",n?e.split(".")[0]:e}function Np(){return Zt().os}function OI(){const t=Zt();return"".concat(t.os," ").concat(t.osVersion)}function Dp(){const t=Zt();return!!(oo.engine.name==="WebKit"&&t.os===bn.MAC_OS&&navigator.maxTouchPoints&&navigator.maxTouchPoints>0&&t.name!==ue.SAFARI||Qn()&&t.name!==ue.SAFARI)}function Gs(){return Zt().name===ue.CHROME}function An(){return Zt().name===ue.SAFARI}function NI(){return Zt().name===ue.EDGE}function ye(){return Zt().name===ue.FIREFOX}function Qn(){return Zt().os===bn.IOS}function jm(t){const e=Zt();return!(e.name!==ue.CHROME||!e.osVersion)&&Number(e.version)>=t}function DI(t){const e=Zt();return!(e.name!==ue.EDGE||!e.osVersion)&&Number(e.version)>=t}function PI(t){const e=Zt();return!(e.name!==ue.SAFARI||!e.osVersion)&&Number(e.version)>=t}function LI(t,e,n){const i=Zt();if(i.os!==bn.IOS||!i.osVersion)return!1;const r=i.osVersion.split(".");return n?e&&Number(r[0])===t&&Number(r[1])<e||Number(r[0])<t:e?Number(r[0])===t&&Number(r[1])<=e||Number(r[0])<t:Number(r[0])<=t}function kI(t,e,n){const i=Zt();if(i.name!==ue.SAFARI||!i.osVersion||!i.browserVersion)return!1;const r=i.browserVersion.split(".");return n?e&&Number(r[0])===t&&Number(r[1])<e||Number(r[0])<t:e?Number(r[0])===t&&Number(r[1])<=e||Number(r[0])<t:Number(r[0])<=t}function MI(t){const e=Zt();return!(e.name!==ue.OPERA||!e.osVersion)&&Number(e.version)>=t}function UI(){const t=Zt();return!(t.name!==ue.CHROME||!t.osVersion)&&Number(t.version)<=90}function xI(){const t=Zt();if(t.os!==bn.IOS||!t.osVersion)return!1;const e=t.osVersion.split(".");return Number(e[0])<14||Number(e[0])===14&&Number(e[1])<=6}function Qc(){const t=Zt();if(t.os!==bn.IOS||!t.osVersion)return!1;const e=t.osVersion.split(".");return Number(e[0])===15}function Bm(){const t=Zt();if(t.os!==bn.IOS||!t.osVersion)return!1;const e=t.osVersion.split(".");return Number(e[0])===16}function VI(){const t=Zt();if(t.os!==bn.IOS||!t.osVersion)return!1;const e=t.osVersion.split(".");return Number(e[0])===15&&Number(e[1])>=1}function Lr(){return An()&&navigator.maxTouchPoints>0}function FI(){return Zt().name===ue.WECHAT}function jI(){return window.navigator.appVersion&&window.navigator.appVersion.match(/Chrome\/([\w\W]*?)\./)!==null&&window.navigator.appVersion.match(/Chrome\/([\w\W]*?)\./)[1]<=35}function Gm(){const t=Np();return function(){const{deviceType:e}=Zt();return e==="mobile"||e==="tablet"}()||t===bn.ANDROID||t===bn.IOS||t===bn.HARMONY_OS}function Ws(){const t=Zt();return t.name!==ue.EDGE&&t.name!==ue.SAFARI&&!!navigator.userAgent.toLocaleLowerCase().match(/chrome\/[\d]./i)}function Pp(){return Np()===bn.ANDROID}function qu(){const t=Zt();return Pp()&&(t.name===ue.CHROME||t.name===ue.WECHAT||/chrome|chromium/i.test(navigator.userAgent))}function BI(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),n.push.apply(n,i)}return n}function mt(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?BI(Object(n),!0).forEach(function(i){Me(t,i,n[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):BI(Object(n)).forEach(function(i){Object.defineProperty(t,i,Object.getOwnPropertyDescriptor(n,i))})}return t}function Me(t,e,n){return(e=function(i){var r=function(o,s){if(typeof o!="object"||o===null)return o;var a=o[Symbol.toPrimitive];if(a!==void 0){var c=a.call(o,"string");if(typeof c!="object")return c;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(o)}(i);return typeof r=="symbol"?r:String(r)}(e))in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}let b=function(t){return t.UNEXPECTED_ERROR="UNEXPECTED_ERROR",t.UNEXPECTED_RESPONSE="UNEXPECTED_RESPONSE",t.TIMEOUT="TIMEOUT",t.INVALID_PARAMS="INVALID_PARAMS",t.NOT_READABLE="NOT_READABLE",t.NOT_SUPPORTED="NOT_SUPPORTED",t.INVALID_OPERATION="INVALID_OPERATION",t.OPERATION_ABORTED="OPERATION_ABORTED",t.WEB_SECURITY_RESTRICT="WEB_SECURITY_RESTRICT",t.EXCHANGE_SDP_FAILED="EXCHANGE_SDP_FAILED",t.ADD_CANDIDATE_FAILED="ADD_CANDIDATE_FAILED",t.DATACHANNEL_FAILED="DATACHANNEL_FAILED",t.NETWORK_ERROR="NETWORK_ERROR",t.NETWORK_TIMEOUT="NETWORK_TIMEOUT",t.NETWORK_RESPONSE_ERROR="NETWORK_RESPONSE_ERROR",t.API_INVOKE_TIMEOUT="API_INVOKE_TIMEOUT",t.ENUMERATE_DEVICES_FAILED="ENUMERATE_DEVICES_FAILED",t.DEVICE_NOT_FOUND="DEVICE_NOT_FOUND",t.ELECTRON_IS_NULL="ELECTRON_IS_NULL",t.ELECTRON_DESKTOP_CAPTURER_GET_SOURCES_ERROR="ELECTRON_DESKTOP_CAPTURER_GET_SOURCES_ERROR",t.CHROME_PLUGIN_NO_RESPONSE="CHROME_PLUGIN_NO_RESPONSE",t.CHROME_PLUGIN_NOT_INSTALL="CHROME_PLUGIN_NOT_INSTALL",t.MEDIA_OPTION_INVALID="MEDIA_OPTION_INVALID",t.PERMISSION_DENIED="PERMISSION_DENIED",t.CONSTRAINT_NOT_SATISFIED="CONSTRAINT_NOT_SATISFIED",t.TRACK_IS_DISABLED="TRACK_IS_DISABLED",t.GET_VIDEO_ELEMENT_VISIBLE_ERROR="GET_VIDEO_ELEMENT_VISIBLE_ERROR",t.SHARE_AUDIO_NOT_ALLOWED="SHARE_AUDIO_NOT_ALLOWED",t.LOW_STREAM_ENCODING_ERROR="LOW_STREAM_ENCODING_ERROR",t.SET_ENCODING_PARAMETER_ERROR="SET_ENCODING_PARAMETER_ERROR",t.TRACK_STATE_UNREACHABLE="TRACK_STATE_UNREACHABLE",t.INVALID_UINT_UID_FROM_STRING_UID="INVALID_UINT_UID_FROM_STRING_UID",t.CAN_NOT_GET_PROXY_SERVER="CAN_NOT_GET_PROXY_SERVER",t.CAN_NOT_GET_GATEWAY_SERVER="CAN_NOT_GET_GATEWAY_SERVER",t.VOID_GATEWAY_ADDRESS="VOID_GATEWAY_ADDRESS",t.UID_CONFLICT="UID_CONFLICT",t.MULTI_UNILBS_RESPONSE_ERROR="MULTI_UNILBS_RESPONSE_ERROR",t.UPDATE_TICKET_FAILED="UPDATE_TICKET_FAILED",t.INVALID_LOCAL_TRACK="INVALID_LOCAL_TRACK",t.INVALID_TRACK="INVALID_TRACK",t.SENDER_NOT_FOUND="SENDER_NOT_FOUND",t.CREATE_OFFER_FAILED="CREATE_OFFER_FAILED",t.SET_ANSWER_FAILED="SET_ANSWER_FAILED",t.ICE_FAILED="ICE_FAILED",t.PC_CLOSED="PC_CLOSED",t.SENDER_REPLACE_FAILED="SENDER_REPLACE_FAILED",t.GET_LOCAL_CAPABILITIES_FAILED="GET_LOCAL_CAPABILITIES_FAILED",t.GET_LOCAL_CONNECTION_PARAMS_FAILED="GET_LOCAL_CONNECTION_PARAMS_FAILED",t.SUBSCRIBE_FAILED="SUBSCRIBE_FAILED",t.UNSUBSCRIBE_FAILED="UNSUBSCRIBE_FAILED",t.GATEWAY_P2P_LOST="GATEWAY_P2P_LOST",t.NO_ICE_CANDIDATE="NO_ICE_CANDIDATE",t.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS="CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS",t.EXIST_DISABLED_VIDEO_TRACK="EXIST_DISABLED_VIDEO_TRACK",t.INVALID_REMOTE_USER="INVALID_REMOTE_USER",t.REMOTE_USER_IS_NOT_PUBLISHED="REMOTE_USER_IS_NOT_PUBLISHED",t.CUSTOM_REPORT_SEND_FAILED="CUSTOM_REPORT_SEND_FAILED",t.CUSTOM_REPORT_FREQUENCY_TOO_HIGH="CUSTOM_REPORT_FREQUENCY_TOO_HIGH",t.FETCH_AUDIO_FILE_FAILED="FETCH_AUDIO_FILE_FAILED",t.READ_LOCAL_AUDIO_FILE_ERROR="READ_LOCAL_AUDIO_FILE_ERROR",t.DECODE_AUDIO_FILE_FAILED="DECODE_AUDIO_FILE_FAILED",t.WS_ABORT="WS_ABORT",t.WS_DISCONNECT="WS_DISCONNECT",t.WS_ERR="WS_ERR",t.EXTERNAL_SIGNAL_ABORT="EXTERNAL_SIGNAL_ABORT",t.LIVE_STREAMING_TASK_CONFLICT="LIVE_STREAMING_TASK_CONFLICT",t.LIVE_STREAMING_INVALID_ARGUMENT="LIVE_STREAMING_INVALID_ARGUMENT",t.LIVE_STREAMING_INTERNAL_SERVER_ERROR="LIVE_STREAMING_INTERNAL_SERVER_ERROR",t.LIVE_STREAMING_PUBLISH_STREAM_NOT_AUTHORIZED="LIVE_STREAMING_PUBLISH_STREAM_NOT_AUTHORIZED",t.LIVE_STREAMING_TRANSCODING_NOT_SUPPORTED="LIVE_STREAMING_TRANSCODING_NOT_SUPPORTED",t.LIVE_STREAMING_CDN_ERROR="LIVE_STREAMING_CDN_ERROR",t.LIVE_STREAMING_INVALID_RAW_STREAM="LIVE_STREAMING_INVALID_RAW_STREAM",t.LIVE_STREAMING_WARN_STREAM_NUM_REACH_LIMIT="LIVE_STREAMING_WARN_STREAM_NUM_REACH_LIMIT",t.LIVE_STREAMING_WARN_FAILED_LOAD_IMAGE="LIVE_STREAMING_WARN_FAILED_LOAD_IMAGE",t.LIVE_STREAMING_WARN_FREQUENT_REQUEST="LIVE_STREAMING_WARN_FREQUENT_REQUEST",t.WEBGL_INTERNAL_ERROR="WEBGL_INTERNAL_ERROR",t.BEAUTY_PROCESSOR_INTERNAL_ERROR="BEAUTY_PROCESSOR_INTERNAL_ERROR",t.CROSS_CHANNEL_WAIT_STATUS_ERROR="CROSS_CHANNEL_WAIT_STATUS_ERROR",t.CROSS_CHANNEL_FAILED_JOIN_SRC="CROSS_CHANNEL_FAILED_JOIN_SEC",t.CROSS_CHANNEL_FAILED_JOIN_DEST="CROSS_CHANNEL_FAILED_JOIN_DEST",t.CROSS_CHANNEL_FAILED_PACKET_SENT_TO_DEST="CROSS_CHANNEL_FAILED_PACKET_SENT_TO_DEST",t.CROSS_CHANNEL_SERVER_ERROR_RESPONSE="CROSS_CHANNEL_SERVER_ERROR_RESPONSE",t.METADATA_OUT_OF_RANGE="METADATA_OUT_OF_RANGE",t.LOCAL_AEC_ERROR="LOCAL_AEC_ERROR",t.INVALID_PLUGIN="INVALID_PLUGIN",t.DISCONNECT_P2P="DISCONNECT_P2P",t.INIT_WEBSOCKET_TIMEOUT="INIT_WEBSOCKET_TIMEOUT",t.CONVERTING_IMAGEDATA_TO_BLOB_FAILED="CONVERTING_IMAGEDATA_TO_BLOB_FAILED",t.CONVERTING_VIDEO_FRAME_TO_BLOB_FAILED="CONVERTING_VIDEO_FRAME_TO_BLOB_FAILED",t.INIT_DATACHANNEL_TIMEOUT="INIT_DATACHANNEL_TIMEOUT",t.CREATE_DATACHANNEL_ERROR="CREATE_DATACHANNEL_ERROR",t.DATACHANNEL_CONNECTION_TIMEOUT="DATACHANNEL_CONNECTION_TIMEOUT",t.PROHIBITED_OPERATION="PROHIBITED_OPERATION",t.IMAGE_MODERATION_UPLOAD_FAILED="IMAGE_MODERATION_UPLOAD_FAILED",t.P2P_MESSAGE_FAILED="P2P_MESSAGE_FAILED",t}({});class G extends Error{constructor(e){let n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"",i=arguments.length>2?arguments[2]:void 0;super(n),Me(this,"code",void 0),Me(this,"message",void 0),Me(this,"data",void 0),Me(this,"name","AgoraRTCException"),this.code=e,this.message="AgoraRTCError ".concat(this.code,": ").concat(n),this.data=i}toString(){return this.data?"data: ".concat(JSON.stringify(this.data),`
`).concat(this.stack):"".concat(this.stack)}print(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:"error",n=arguments.length>1?arguments[1]:void 0;return e==="error"&&(n||console).error(this.toString()),e==="warning"&&(n||console).warn(this.toString()),this}throw(e){throw this.print("error",e),this}}function hs(t,e){if(typeof t!="boolean")throw new G(b.INVALID_PARAMS,"Invalid ".concat(e,": The value is of the boolean type."))}function yn(t,e,n){if(!it(n).call(n,t))throw new G(b.INVALID_PARAMS,"".concat(e," can only be set as ").concat(JSON.stringify(n)))}function Se(t,e){let n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:1,i=arguments.length>3&&arguments[3]!==void 0?arguments[3]:1e4;if(t<n||t>i||(!(arguments.length>4&&arguments[4]!==void 0)||arguments[4])&&!function(r){return typeof r=="number"&&r%1==0}(t))throw new G(b.INVALID_PARAMS,"invalid ".concat(e,": the value range is [").concat(n,", ").concat(i,"]. integer only"))}function Wm(t,e){if(typeof t!="number"){if(!(t.min||t.max||t.ideal||t.exact))throw new G(b.INVALID_PARAMS,"".concat(e," is not a valid ConstrainLong"));t.min!==void 0&&Se(t.min,"".concat(e,".min"),0,1/0),t.max!==void 0&&Se(t.max,"".concat(e,".max"),1,1/0),t.exact!==void 0&&Se(t.exact,"".concat(e,".exact"),1,1/0),t.ideal!==void 0&&Se(t.ideal,"".concat(e,".ideal"),1,1/0)}else Se(t,e,1,1/0)}function Fn(t,e){let n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:1,i=arguments.length>3&&arguments[3]!==void 0?arguments[3]:255,r=!(arguments.length>4&&arguments[4]!==void 0)||arguments[4];if(t==null)throw new G(b.INVALID_PARAMS,"".concat(e||"param"," cannot be empty"));if(!GI(t,n,i,r))throw new G(b.INVALID_PARAMS,"Invalid ".concat(e||"string param",": Length of the string: [").concat(n,",").concat(i,"].").concat(r?" ASCII characters only.":""))}function ps(t,e){if(!Array.isArray(t))throw new G(b.INVALID_PARAMS,"".concat(e," should be an array"))}function ze(t){return t==null}function GI(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:1,n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:255,i=!(arguments.length>3&&arguments[3]!==void 0)||arguments[3];return typeof t=="string"&&t.length<=n&&t.length>=e&&(!i||function(r){if(typeof r!="string")return!1;for(let o=0;o<r.length;o+=1){const s=r.charCodeAt(o);if(s<0||s>255)return!1}return!0}(t))}function WI(t,e,n){if("getBigUint64"in DataView.prototype)return t.getBigUint64(e,n);const i=t.getUint32(e,n),r=t.getUint32(e+4,n),o=Number(!!n),s=Number(!n);return BigInt(i*s+r*o)<<BigInt(32)|BigInt(i*o+r*s)}function HI(t,e,n,i){if("setBigUint64"in DataView.prototype)return t.setBigUint64(e,n,i);const r=Number(n>>BigInt(32)),o=Number(n&BigInt(4294967295));i?(t.setUint32(e+4,r,i),t.setUint32(e,o,i)):(t.setUint32(e,r,i),t.setUint32(e+4,o,i))}var Yu=function(t){return t.COVERED="COVERED",t.POSITION="POSITION",t.SIZE="SIZE",t.STYLE="STYLE",t}(Yu||{}),Hm=function(t){return t.UNMOUNTED="UNMOUNTED",t.INVALID_HTML_ELEMENT="INVALID_HTML_ELEMENT",t}(Hm||{});const KI=new class{constructor(){Me(this,"_clientSize",null),Me(this,"getClientWidth",()=>document.documentElement?document.documentElement.clientWidth:document.body.clientWidth),Me(this,"getClientHeight",()=>document.documentElement?document.documentElement.clientHeight:document.body.clientHeight),Me(this,"getStyle",t=>window.getComputedStyle(t,null)),Me(this,"checkCssVisibleProperty",t=>{var e;let n=!0;const i=this.getStyle(t),{display:r,visibility:o,opacity:s,filter:a}=i;return(r==="none"||it(e=["hidden","collapse"]).call(e,o)||Number(s)<.1)&&(n=!1),!!n&&(a&&a.split(" ").filter(c=>{var d;const u=c.split("(")[0];return it(d=["brightness","blur","opacity"]).call(d,u)}).map(c=>{const[d,u]=c.split(/\(|\)/);return[d,Number(u.match(/^[0-9\.]+/))]}).forEach(c=>{const[d,u]=c;switch(d){case"brightness":(u<.1||u>3)&&(n=!1);break;case"blur":u>3&&(n=!1);break;case"opacity":u<.1&&(n=!1)}}),n)}),Me(this,"checkPropertyUpToAllParentNodes",(t,e)=>{let n=!0,i=!0;const r=s=>e(s);let o=t;for(;o&&i;)r(o)||(n=!1,i=!1),o=o.parentElement,o||(i=!1);return n}),Me(this,"checkActualCssVisibleIncludeInherit",t=>this.checkPropertyUpToAllParentNodes(t,this.checkCssVisibleProperty)),Me(this,"getSizeAboutClient",t=>{const{width:e,height:n,left:i,right:r,top:o,bottom:s}=t.getBoundingClientRect(),a=this.getClientWidth(),c=this.getClientHeight();return{width:e,height:n,left:i,right:r,top:o,bottom:s,clientWidth:a,clientHeight:c,clientMin:Math.min(a,c)}}),Me(this,"checkActualSize",()=>{const{width:t,height:e,clientMin:n}=this._clientSize;return this.checkSizeIsVisible(t,e,n)}),Me(this,"elementFromPoint",(t,e)=>document.elementFromPoint?document.elementFromPoint(t,e):null),Me(this,"checkCoverForAPoint",(t,e,n)=>{const i=this.elementFromPoint(t,e);return i!==null&&i!==n}),Me(this,"getPointPositionList",()=>{const{width:t,height:e,left:n,top:i}=this._clientSize,r=t/6,o=e/6,s=[],a=10**6;for(let c=0;c<5;c++)for(let d=0;d<5;d++){const u=(n*a+(c===0?.1:c===4?(r*c*a-1e5)/a:r*c)*a)/a,l=(i*a+(d===0?.1:d===4?(o*d*a-1e5)/a:o*d)*a)/a;s.push({x:u,y:l})}return[...s]}),Me(this,"checkElementCover",t=>this.getPointPositionList().map(e=>this.checkCoverForAPoint(e.x,e.y,t)).filter(e=>!!e).length>6),Me(this,"checkSizeIsVisible",(t,e,n)=>(t>50||n/t<=10)&&(e>50||n/e<=10)),Me(this,"checkSizeOfPartInClient",()=>{const{left:t,right:e,top:n,bottom:i,clientHeight:r,clientWidth:o,clientMin:s}=this._clientSize;let a,c,d,u;if(t<0)a=0;else{if(!(t<o))return!1;a=t}if(e<0)return!1;if(c=e<o?e:o,n<0)d=0;else{if(!(n<r))return!1;d=n}if(i<0)return!1;u=i<r?i:r;const l=c-a,p=u-d;return this.checkSizeIsVisible(l,p,s)}),Me(this,"returnHiddenResult",t=>(this._clientSize=null,{visible:!1,reason:t})),Me(this,"checkOneElementVisible",t=>{if(t instanceof HTMLElement){if(this.checkElementIsMountedOnDom(t)){if(this.checkActualCssVisibleIncludeInherit(t)){if(this._clientSize=this.getSizeAboutClient(t),this.checkElementCover(t))return this.returnHiddenResult(Yu.COVERED);{const e=this.checkActualSize(),n=this.checkSizeOfPartInClient();return e&&!n?this.returnHiddenResult(Yu.POSITION):e?(this._clientSize=null,{visible:!0}):this.returnHiddenResult(Yu.SIZE)}}return this.returnHiddenResult(Yu.STYLE)}return this.returnHiddenResult(Hm.UNMOUNTED)}return this.returnHiddenResult(Hm.INVALID_HTML_ELEMENT)}),Me(this,"checkElementIsMountedOnDom",t=>this.checkPropertyUpToAllParentNodes(t,e=>e.nodeName.toUpperCase()!=="HTML"?e.parentElement!==null:!!document.documentElement))}};function Km(t){return new TextEncoder().encode(t)}const qI=function(t,e){const n=new Uint8Array(t.byteLength+e.byteLength);return n.set(new Uint8Array(t),0),n.set(new Uint8Array(e),t.byteLength),n},qm=async t=>function(e,n){let i="";return new Uint8Array(e).forEach(r=>{i+=r.toString(n).padStart(2,"0")}),i}(await crypto.subtle.digest("SHA-256",Km(t)),16);let Ve=class{constructor(){Me(this,"_events",{}),Me(this,"addListener",this.on)}getListeners(t){return this._events[t]?this._events[t].map(e=>e.listener):[]}on(t,e){this._events[t]||(this._events[t]=[]);const n=this._events[t];this._indexOfListener(n,e)===-1&&n.push({listener:e,once:!1})}once(t,e){this._events[t]||(this._events[t]=[]);const n=this._events[t];this._indexOfListener(n,e)===-1&&n.push({listener:e,once:!0})}off(t,e){if(!this._events[t])return;const n=this._events[t],i=this._indexOfListener(n,e);i!==-1&&n.splice(i,1),this._events[t].length===0&&delete this._events[t]}removeAllListeners(t){t?delete this._events[t]:this._events={}}emit(t){this._events[t]||(this._events[t]=[]);const e=this._events[t].map(o=>o);for(var n=arguments.length,i=new Array(n>1?n-1:0),r=1;r<n;r++)i[r-1]=arguments[r];for(let o=0;o<e.length;o+=1){const s=e[o];s.once&&this.off(t,s.listener),s.listener.apply(this,i||[])}}safeEmit(t){for(var e=arguments.length,n=new Array(e>1?e-1:0),i=1;i<e;i++)n[i-1]=arguments[i];[...this._events[t]||[]].forEach(r=>{r.once&&this.off(t,r.listener);try{r.listener.apply(this,n)}catch(o){console.error("safeEmit event:".concat(t," error ").concat(o==null?void 0:o.toString()))}})}_indexOfListener(t,e){let n=t.length;for(;n--;)if(t[n].listener===e)return n;return-1}},zu=null;function YI(){if(zu)return zu;if(window.electron)return zu=window.electron;if(!window.require)return null;try{return zu=window.require("electron"),zu}catch{return null}}let _n=function(t){return t.CREATE_CLIENT="createClient",t.CHECK_SYSTEM_REQUIREMENTS="checkSystemRequirements",t.SET_AREA="setArea",t.PRELOAD="PRELOAD",t.CHECK_VIDEO_TRACK_IS_ACTIVE="checkVideoTrackIsActive",t.CHECK_AUDIO_TRACK_IS_ACTIVE="checkAudioTrackIsActive",t.CREATE_MIC_AUDIO_TRACK="createMicrophoneAudioTrack",t.CREATE_CUSTOM_AUDIO_TRACK="createCustomAudioTrack",t.CREATE_BUFFER_AUDIO_TRACK="createBufferSourceAudioTrack",t.CREATE_CAM_VIDEO_TRACK="createCameraVideoTrack",t.CREATE_CUSTOM_VIDEO_TRACK="createCustomVideoTrack",t.CREATE_MIC_AND_CAM_TRACKS="createMicrophoneAndCameraTracks",t.CREATE_SCREEN_VIDEO_TRACK="createScreenVideoTrack",t.SET_ENCRYPTION_CONFIG="Client.setEncryptionConfig",t.START_PROXY_SERVER="Client.startProxyServer",t.STOP_PROXY_SERVER="Client.stopProxyServer",t.SET_PROXY_SERVER="Client.setProxyServer",t.SET_TURN_SERVER="Client.setTurnServer",t.SET_CLIENT_ROLE="Client.setClientRole",t.SET_LOW_STREAM_PARAMETER="Client.setLowStreamParameter",t.ENABLE_DUAL_STREAM="Client.enableDualStream",t.DISABLE_DUAL_STREAM="Client.disableDualStream",t.JOIN="Client.join",t.LEAVE="Client.leave",t.PUBLISH="Client.publish",t.UNPUBLISH="Client.unpublish",t.SUBSCRIBE="Client.subscribe",t.MASS_SUBSCRIBE="Client.massSubscribe",t.MASS_UNSUBSCRIBE="Client.massUnsubscribe",t.UNSUBSCRIBE="Client.unsubscribe",t.RENEW_TOKEN="Client.renewToken",t.SET_REMOTE_VIDEO_STREAM_TYPE="Client.setRemoteVideoStreamType",t.SET_STREAM_FALLBACK_OPTION="Client.setStreamFallbackOption",t.ENABLE_AUDIO_VOLUME_INDICATOR="Client.enableAudioVolumeIndicator",t.SEND_CUSTOM_REPORT_MESSAGE="Client.sendCustomReportMessage",t.INSPECT_VIDEO_CONTENT="Client.inspectVideoContent",t.STOP_INSPECT_VIDEO_CONTENT="Client.stopInspectVideoContent",t.JOIN_FALLBACK_TO_PROXY="Client._joinFallbackToProxy",t.DATACHANNEL_FAILBACK="Client._datachannelFailback",t.ON_LIVE_STREAM_WARNING="Client.onLiveStreamWarning",t.ON_LIVE_STREAM_ERROR="Client.onLiveStreamingError",t.START_LIVE_STREAMING="Client.startLiveStreaming",t.SET_LIVE_TRANSCODING="Client.setLiveTranscoding",t.STOP_LIVE_STREAMING="Client.stopLiveStreaming",t.START_CHANNEL_MEDIA_RELAY="Client.startChannelMediaRelay",t.UPDATE_CHANNEL_MEDIA_RELAY="Client.updateChannelMediaRelay",t.STOP_CHANNEL_MEDIA_RELAY="Client.stopChannelMediaRelay",t.REQUEST_CONFIG_DISTRIBUTE="_config-distribute-request",t.SET_CONFIG_DISTRIBUTE="_configDistribute",t.LOCAL_TRACK_SET_MUTED="LocalTrack.setMute",t.LOCAL_AUDIO_TRACK_PLAY="LocalAudioTrack.play",t.LOCAL_AUDIO_TRACK_PLAY_IN_ELEMENT="LocalAudioTrack.playInElement",t.LOCAL_AUDIO_TRACK_STOP="LocalAudioTrack.stop",t.LOCAL_AUDIO_TRACK_SET_VOLUME="LocalAudioTrack.setVolume",t.MIC_AUDIO_TRACK_SET_DEVICE="MicrophoneAudioTrack.setDevice",t.BUFFER_AUDIO_TRACK_START="BufferSourceAudioTrack.startProcessAudioBuffer",t.BUFFER_AUDIO_TRACK_STOP="BufferSourceAudioTrack.stopProcessAudioBuffer",t.BUFFER_AUDIO_TRACK_PAUSE="BufferSourceAudioTrack.pauseProcessAudioBuffer",t.BUFFER_AUDIO_TRACK_RESUME="BufferSourceAudioTrack.resumeProcessAudioBuffer",t.BUFFER_AUDIO_TRACK_SEEK="BufferSourceAudioTrack.seekAudioBuffer",t.LOCAL_VIDEO_TRACK_PLAY="LocalVideoTrack.play",t.LOCAL_VIDEO_TRACK_STOP="LocalVideoTrack.stop",t.LOCAL_VIDEO_TRACK_GET_VIDEO_VISIBLE="LocalVideoTrack.getVideoElementVisibleStatus",t.LOCAL_VIDEO_TRACK_BEAUTY="LocalVideoTrack.setBeautyEffect",t.LOCAL_VIDEO_SEND_SEI_DATA="LocalVideoTrack.sendSeiData",t.CAM_VIDEO_TRACK_SET_DEVICE="CameraVideoTrack.setDevice",t.CAM_VIDEO_TRACK_SET_ENCODER_CONFIG="CameraVideoTrack.setEncoderConfiguration",t.REMOTE_VIDEO_TRACK_PLAY="RemoteVideoTrack.play",t.REMOTE_VIDEO_TRACK_STOP="RemoteVideoTrack.stop",t.REMOTE_VIDEO_TRACK_GET_VIDEO_VISIBLE="RemoteVideoTrack.getVideoElementVisibleStatus",t.REMOTE_AUDIO_TRACK_PLAY="RemoteAudioTrack.play",t.REMOTE_AUDIO_TRACK_STOP="RemoteAudioTrack.stop",t.REMOTE_AUDIO_SET_VOLUME="RemoteAudioTrack.setVolume",t.REMOTE_AUDIO_SET_OUTPUT_DEVICE="RemoteAudioTrack.setOutputDevice",t.GET_MEDIA_STREAM_TRACK="Track.getMediaStreamTrack",t.STREAM_TYPE_CHANGE="streamTypeChange",t.CONNECTION_STATE_CHANGE="connectionStateChange",t.LOAD_CONFIG_FROM_LOCALSTORAGE="loadConfigFromLocalStorage",t.IMAGE_MODERATION_UPLOAD="imageModerationUpload",t}({}),Je=function(t){return t.TRACER="tracer",t}({});function zI(t){return Se(t.timeout,"config.timeout",0,1e5),Se(t.timeoutFactor,"config.timeoutFactor",0,100,!1),Se(t.maxRetryCount,"config.maxRetryConfig",0,1/0),Se(t.maxRetryTimeout,"config.maxRetryTimeout",0,1/0),!0}let FF=function(t){return t[t.AUDIENCE_LEVEL_LOW_LATENCY=1]="AUDIENCE_LEVEL_LOW_LATENCY",t[t.AUDIENCE_LEVEL_ULTRA_LOW_LATENCY=2]="AUDIENCE_LEVEL_ULTRA_LOW_LATENCY",t[t.AUDIENCE_LEVEL_SYNC_LATENCY=3]="AUDIENCE_LEVEL_SYNC_LATENCY",t}({}),Ht=function(t){return t.LEAVE="LEAVE",t.NETWORK_ERROR="NETWORK_ERROR",t.SERVER_ERROR="SERVER_ERROR",t.UID_BANNED="UID_BANNED",t.IP_BANNED="IP_BANNED",t.CHANNEL_BANNED="CHANNEL_BANNED",t.FALLBACK="FALLBACK",t.LICENSE_MISSING="LICENSE_MISSING",t.LICENSE_EXPIRED="LICENSE_EXPIRED",t.LICENSE_MINUTES_EXCEEDED="LICENSE_MINUTES_EXCEEDED",t.LICENSE_PERIOD_INVALID="LICENSE_PERIOD_INVALID",t.LICENSE_MULTIPLE_SDK_SERVICE="LICENSE_MULTIPLE_SDK_SERVICE",t.LICENSE_ILLEGAL="LICENSE_ILLEGAL",t.TOKEN_EXPIRE="TOKEN_EXPIRE",t}({});function Zc(t){if(!Array.isArray(t)||t.length<1)return!1;try{t.forEach(e=>{if(!e.urls)throw Error()})}catch{return!1}return!0}function JI(t){return Fn(t.turnServerURL,"turnServerURL"),Fn(t.username,"username"),Fn(t.password,"password"),t.udpport&&Se(t.udpport,"udpport",1,99999,!0),t.forceturn&&hs(t.forceturn,"forceturn"),t.security&&hs(t.security,"security"),t.tcpport&&Se(t.tcpport,"tcpport",1,99999,!0),!0}function XI(t){return t.level!==void 0&&yn(t.level,"level",[1,2,3]),t.delay!==void 0&&Se(t.delay,"delay",0,3e3,!0),!0}let Kt=function(t){return t.CONNECTION_STATE_CHANGE="connection-state-change",t.MEDIA_RECONNECT_START="media-reconnect-start",t.MEDIA_RECONNECT_END="media-reconnect-end",t.IS_USING_CLOUD_PROXY="is-using-cloud-proxy",t.USER_JOINED="user-joined",t.USER_LEAVED="user-left",t.USER_PUBLISHED="user-published",t.USER_UNPUBLISHED="user-unpublished",t.USER_INFO_UPDATED="user-info-updated",t.CLIENT_BANNED="client-banned",t.CHANNEL_MEDIA_RELAY_STATE="channel-media-relay-state",t.CHANNEL_MEDIA_RELAY_EVENT="channel-media-relay-event",t.VOLUME_INDICATOR="volume-indicator",t.CRYPT_ERROR="crypt-error",t.ON_TOKEN_PRIVILEGE_WILL_EXPIRE="token-privilege-will-expire",t.ON_TOKEN_PRIVILEGE_DID_EXPIRE="token-privilege-did-expire",t.NETWORK_QUALITY="network-quality",t.STREAM_TYPE_CHANGED="stream-type-changed",t.STREAM_FALLBACK="stream-fallback",t.RECEIVE_METADATA="receive-metadata",t.STREAM_MESSAGE="stream-message",t.LIVE_STREAMING_ERROR="live-streaming-error",t.LIVE_STREAMING_WARNING="live-streaming-warning",t.INJECT_STREAM_STATUS="stream-inject-status",t.EXCEPTION="exception",t.ERROR="error",t.P2P_LOST="p2p_lost",t.JOIN_FALLBACK_TO_PROXY="join-fallback-to-proxy",t.CHANNEL_FALLBACK_TO_WEBSOCKET="channel-fallback-to-websocket",t.MEDIA_CONNECTION_TYPE_CHANGE="media-connection-type-change",t.PUBLISHED_USER_LIST="published-user-list",t.CONTENT_INSPECT_CONNECTION_STATE_CHANGE="content-inspect-connection-state-change",t.CONTENT_INSPECT_ERROR="content-inspect-error",t.CONTENT_INSPECT_RESULT="content-inspect-result",t.IMAGE_MODERATION_CONNECTION_STATE_CHANGE="image-moderation-connection-state-change",t}({}),Kn=function(t){return t.NETWORK_ERROR="NETWORK_ERROR",t.SERVER_ERROR="SERVER_ERROR",t.MULTI_IP="MULTI_IP",t.TIMEOUT="TIMEOUT",t.OFFLINE="OFFLINE",t.LEAVE="LEAVE",t.P2P_FAILED="P2P_FAILED",t.FALLBACK="FALLBACK",t}({}),_i=function(t){return t.ONLINE="ONLINE",t.OFFLINE="OFFLINE",t}({}),Ma=function(t){return t.NETWORK_STATE_CHANGE="NETWORK_STATE_CHANGE",t.ONLINE="ONLINE",t.OFFLINE="OFFLINE",t}({});function En(t,e){for(var n=arguments.length,i=new Array(n>2?n-2:0),r=2;r<n;r++)i[r-2]=arguments[r];return t.getListeners(e).length===0?ot.reject(new G(b.UNEXPECTED_ERROR,"can not emit promise")):new ot((o,s)=>{t.emit(e,...i,o,s)})}function Ie(t,e){if(t.getListeners(e).length===0)return ot.resolve();for(var n=arguments.length,i=new Array(n>2?n-2:0),r=2;r<n;r++)i[r-2]=arguments[r];return En(t,e,...i)}function Gi(t,e){if(t.getListeners(e).length===0)return null;for(var n=arguments.length,i=new Array(n>2?n-2:0),r=2;r<n;r++)i[r-2]=arguments[r];return Ua(t,e,...i)}function Ua(t,e){let n=null,i=null;for(var r=arguments.length,o=new Array(r>2?r-2:0),s=2;s<r;s++)o[s-2]=arguments[s];if(t.emit(e,...o,a=>{n=a},a=>{i=a}),i!==null)throw i;if(n===null)throw new G(b.UNEXPECTED_ERROR,"handler is not sync");return n}const Xe=new class extends Ve{set networkState(t){this.emit(Ma.NETWORK_STATE_CHANGE,t,this._networkState),t===_i.ONLINE?this.emit(Ma.ONLINE):t===_i.OFFLINE&&(this.onlineWaiter=new ot(e=>{this.once(Ma.ONLINE,()=>{this.onlineWaiter=void 0,e(_i.ONLINE)})}),this.emit(Ma.OFFLINE)),this._networkState=t}get networkState(){return this._networkState}get isOnline(){return this._networkState===_i.ONLINE}constructor(){super(),Me(this,"_moduleName","network-indicator"),Me(this,"_networkState",_i.ONLINE),Me(this,"onlineWaiter",void 0),window.addEventListener("online",()=>{this.networkState=_i.ONLINE}),window.addEventListener("offline",()=>{this.networkState=_i.OFFLINE})}};function Lp(t,e){const n=t.indexOf(e);n!==-1&&t.splice(n,1)}function $c(t){const e=[];return t.forEach(n=>{e.indexOf(n)===-1&&e.push(n)}),e}function kp(t){ot!==void 0?ot.resolve().then(t):setTimeout(t,0)}function Ne(t){return JSON.parse(JSON.stringify(t))}function xa(t){try{return Ne(t)}catch{return t}}const QI={};function Hs(t,e){QI[e]||(QI[e]=!0,t())}function Va(t){const e=window.atob(t),n=new Uint8Array(new ArrayBuffer(e.length));for(let i=0;i<e.length;i+=1)n[i]=e.charCodeAt(i);return n}function Ks(t){let e="";for(let n=0;n<t.length;n+=1)e+=String.fromCharCode(t[n]);return window.btoa(e)}function ZI(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:16,n=new TextEncoder().encode(t);if(n.length>e)n=n.slice(0,e);else if(n.length<e){const i=new Uint8Array(e);i.set(n),n=i}return n}function $I(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];const i=io(e).call(e,(s,a)=>s+a.length,0),r=new Uint8Array(new ArrayBuffer(i));let o=0;return e.forEach(s=>{r.set(s,o),o+=s.length}),r}function Uo(t){return window.TextEncoder?new TextEncoder().encode(t).length:t.length}function tb(t){let e=0;return(/DingTalk/i.test(navigator.userAgent)||/AliApp/i.test(navigator.userAgent))&&t.realFormData&&(t=t.realFormData),t.forEach(n=>{e+=typeof n=="string"?Uo(n):n.size}),e+138}function jF(t){const e=new G(b.TIMEOUT,"timeout");return new ot((n,i)=>{window.setTimeout(()=>i(e),t)})}function wn(t){return new ot(e=>{window.setTimeout(e,t)})}function be(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:7,e=arguments.length>1?arguments[1]:void 0;const n=Math.random().toString(16).substr(2,t).toLowerCase();return n.length===t?"".concat(e).concat(n):"".concat(e).concat(n)+be(t-n.length,"")}function Ju(){return be(32,"").toUpperCase()}const Mp=()=>{},eb=new class{constructor(){Me(this,"fnMap",new Map)}throttleByKey(t,e,n,i){for(var r=arguments.length,o=new Array(r>4?r-4:0),s=4;s<r;s++)o[s-4]=arguments[s];if(this.fnMap.has(e)){const a=this.fnMap.get(e);if(a.threshold!==n){a.fn(...a.args),clearTimeout(a.timer);const c=window.setTimeout(()=>{const d=this.fnMap.get(e);d&&d.fn(...d.args),this.fnMap.delete(e)},n);this.fnMap.set(e,{fn:t,threshold:n,timer:c,args:o,skipFn:i})}else a.skipFn&&a.skipFn(...a.args),this.fnMap.set(e,mt(mt({},a),{},{fn:t,args:o,skipFn:i}))}else{const a=window.setTimeout(()=>{const c=this.fnMap.get(e);c&&c.fn(...c.args),this.fnMap.delete(e)},n);this.fnMap.set(e,{fn:t,threshold:n,timer:a,args:o,skipFn:i})}}},nb=eb.throttleByKey.bind(eb);function ib(t){return typeof t=="object"&&t!==null&&!(t instanceof RegExp)}function Ym(t,e){if(!ib(t)||!ib(e)||Array.isArray(t)&&!Array.isArray(e)||!Array.isArray(t)&&Array.isArray(e))return e;if(Array.isArray(e)&&Array.isArray(t)){const n=[...t];for(let i=0;i<e.length;i++)n[i]=Ym(t[i],e[i]);return n}{const n=mt({},t);for(const i in e)Object.prototype.hasOwnProperty.call(e,i)&&(Object.prototype.hasOwnProperty.call(t,i)?n[i]=Ym(t[i],e[i]):n[i]=e[i]);return n}}function rb(t,e){let n=[0];if(e&&(n=new Array(e).fill(0)),t===0)return n;let i=0;for(;t>0&&(n[i]=255&t,t>>=8,i++,!e||i!==e););return n}function zm(t){return typeof t=="number"?t:t.exact||t.ideal||t.max||t.min||0}function ob(t){const e="0123456789abcdef";function n(k){let M,V="";for(M=0;M<=3;M++)V+=e.charAt(k>>8*M+4&15)+e.charAt(k>>8*M&15);return V}function i(k,M){const V=(65535&k)+(65535&M);return(k>>16)+(M>>16)+(V>>16)<<16|65535&V}function r(k,M,V,B,K,Y){return i(function(J,lt){return J<<lt|J>>>32-lt}(i(i(M,k),i(B,Y)),K),V)}function o(k,M,V,B,K,Y,J){return r(M&V|~M&B,k,M,K,Y,J)}function s(k,M,V,B,K,Y,J){return r(M&B|V&~B,k,M,K,Y,J)}function a(k,M,V,B,K,Y,J){return r(M^V^B,k,M,K,Y,J)}function c(k,M,V,B,K,Y,J){return r(V^(M|~B),k,M,K,Y,J)}const d=function(k){let M;const V=1+(k.length+8>>6),B=new Array(16*V);for(M=0;M<16*V;M++)B[M]=0;for(M=0;M<k.length;M++)B[M>>2]|=k.charCodeAt(M)<<M%4*8;return B[M>>2]|=128<<M%4*8,B[16*V-2]=8*k.length,B}(t);let u,l,p,f,C,m=1732584193,g=-271733879,y=-1732584194,A=271733878;for(u=0;u<d.length;u+=16)l=m,p=g,f=y,C=A,m=o(m,g,y,A,d[u+0],7,-680876936),A=o(A,m,g,y,d[u+1],12,-389564586),y=o(y,A,m,g,d[u+2],17,606105819),g=o(g,y,A,m,d[u+3],22,-1044525330),m=o(m,g,y,A,d[u+4],7,-176418897),A=o(A,m,g,y,d[u+5],12,1200080426),y=o(y,A,m,g,d[u+6],17,-1473231341),g=o(g,y,A,m,d[u+7],22,-45705983),m=o(m,g,y,A,d[u+8],7,1770035416),A=o(A,m,g,y,d[u+9],12,-1958414417),y=o(y,A,m,g,d[u+10],17,-42063),g=o(g,y,A,m,d[u+11],22,-1990404162),m=o(m,g,y,A,d[u+12],7,1804603682),A=o(A,m,g,y,d[u+13],12,-40341101),y=o(y,A,m,g,d[u+14],17,-1502002290),g=o(g,y,A,m,d[u+15],22,1236535329),m=s(m,g,y,A,d[u+1],5,-165796510),A=s(A,m,g,y,d[u+6],9,-1069501632),y=s(y,A,m,g,d[u+11],14,643717713),g=s(g,y,A,m,d[u+0],20,-373897302),m=s(m,g,y,A,d[u+5],5,-701558691),A=s(A,m,g,y,d[u+10],9,38016083),y=s(y,A,m,g,d[u+15],14,-660478335),g=s(g,y,A,m,d[u+4],20,-405537848),m=s(m,g,y,A,d[u+9],5,568446438),A=s(A,m,g,y,d[u+14],9,-1019803690),y=s(y,A,m,g,d[u+3],14,-187363961),g=s(g,y,A,m,d[u+8],20,1163531501),m=s(m,g,y,A,d[u+13],5,-1444681467),A=s(A,m,g,y,d[u+2],9,-51403784),y=s(y,A,m,g,d[u+7],14,1735328473),g=s(g,y,A,m,d[u+12],20,-1926607734),m=a(m,g,y,A,d[u+5],4,-378558),A=a(A,m,g,y,d[u+8],11,-2022574463),y=a(y,A,m,g,d[u+11],16,1839030562),g=a(g,y,A,m,d[u+14],23,-35309556),m=a(m,g,y,A,d[u+1],4,-1530992060),A=a(A,m,g,y,d[u+4],11,1272893353),y=a(y,A,m,g,d[u+7],16,-155497632),g=a(g,y,A,m,d[u+10],23,-1094730640),m=a(m,g,y,A,d[u+13],4,681279174),A=a(A,m,g,y,d[u+0],11,-358537222),y=a(y,A,m,g,d[u+3],16,-722521979),g=a(g,y,A,m,d[u+6],23,76029189),m=a(m,g,y,A,d[u+9],4,-640364487),A=a(A,m,g,y,d[u+12],11,-421815835),y=a(y,A,m,g,d[u+15],16,530742520),g=a(g,y,A,m,d[u+2],23,-995338651),m=c(m,g,y,A,d[u+0],6,-198630844),A=c(A,m,g,y,d[u+7],10,1126891415),y=c(y,A,m,g,d[u+14],15,-1416354905),g=c(g,y,A,m,d[u+5],21,-57434055),m=c(m,g,y,A,d[u+12],6,1700485571),A=c(A,m,g,y,d[u+3],10,-1894986606),y=c(y,A,m,g,d[u+10],15,-1051523),g=c(g,y,A,m,d[u+1],21,-2054922799),m=c(m,g,y,A,d[u+8],6,1873313359),A=c(A,m,g,y,d[u+15],10,-30611744),y=c(y,A,m,g,d[u+6],15,-1560198380),g=c(g,y,A,m,d[u+13],21,1309151649),m=c(m,g,y,A,d[u+4],6,-145523070),A=c(A,m,g,y,d[u+11],10,-1120210379),y=c(y,A,m,g,d[u+2],15,718787259),g=c(g,y,A,m,d[u+9],21,-343485551),m=i(m,l),g=i(g,p),y=i(y,f),A=i(A,C);return n(m)+n(g)+n(y)+n(A)}let BF=1,Up=console,kn=class{static setLogger(t){Up=t}constructor(t){Me(this,"lockingPromise",ot.resolve()),Me(this,"locks",0),Me(this,"name",""),Me(this,"lockId",void 0),this.lockId=BF++,t&&(this.name=t),Up.debug("[lock-".concat(this.name,"-").concat(this.lockId,"] is created."))}get isLocked(){return this.locks>0}lock(t){let e;this.locks+=1,Up.debug("[lock-".concat(this.name,"-").concat(this.lockId,"] is locked, current queue ").concat(this.locks,". ").concat(typeof t=="string"?t:""));const n=new ot(r=>{e=()=>{this.locks-=1,Up.debug("[lock-".concat(this.name,"-").concat(this.lockId,"] is not locked, current queue ").concat(this.locks,". ").concat(typeof t=="string"?t:"")),r()}}),i=this.lockingPromise.then(()=>e);return this.lockingPromise=this.lockingPromise.then(()=>n),i}};function td(t,e){return function(n,i,r){const o=r.value;if(typeof o!="function")throw new Error("Cannot use mutex on object property.");return r.value=async function(){const s=this[e];if(!s)throw new Error("mutex property key ".concat(e," doesn't exist on ").concat(t));const a=await s.lock("From ".concat(t,".").concat(i));try{for(var c=arguments.length,d=new Array(c),u=0;u<c;u++)d[u]=arguments[u];return await o.apply(this,d)}finally{a()}},r}}const dn={timeout:500,timeoutFactor:1.5,maxRetryCount:1/0,maxRetryTimeout:1e4};function xp(t,e){const n=Math.floor(e.timeout*Math.pow(e.timeoutFactor,t));return Math.min(e.maxRetryTimeout,n)}function so(t,e,n,i){const r=Object.assign({},dn,i);let o=r.timeout;const s=async()=>{await function(d){return new ot(u=>{window.setTimeout(u,d)})}(o),o*=r.timeoutFactor,o=Math.min(r.maxRetryTimeout,o)};let a=!1;const c=new ot(async(d,u)=>{e=e||(()=>!1),n=n||(()=>!0);for(let l=0;l<r.maxRetryCount;l+=1){if(a)return u(new G(b.OPERATION_ABORTED));try{const p=await t();if(!e(p,l)||l+1===r.maxRetryCount)return d(p);await s()}catch(p){if(!n(p,l)||l+1===r.maxRetryCount)return u(p);await s()}}});return c.cancel=()=>a=!0,c}class Jm{constructor(e){Me(this,"input",[]),Me(this,"size",void 0),this.size=e}add(e){this.input.push(e),this.input.length>this.size&&this.input.splice(0,1)}mean(){var e;return this.input.length===0?0:io(e=this.input).call(e,(n,i)=>n+i)/this.input.length}}let Vp,Fp=0,Xm=0;function Qm(t,e,n,i){return new ot((r,o)=>{e.responseType=e.responseType||"json",e.data&&!n?(e.data=JSON.stringify(e.data),Fp+=Uo(e.data)):n&&(e.data.size?Fp+=e.data.size:e.data instanceof FormData?Fp+=tb(e.data):Fp+=Uo(JSON.stringify(e.data))),e.headers=e.headers||{},e.headers["Content-Type"]=e.headers["Content-Type"]||"application/json",e.method="POST",e.url=t,yi.request(e).then(s=>{typeof s.data=="string"?Xm+=Uo(s.data):s.data instanceof ArrayBuffer||s.data instanceof Uint8Array?Xm+=s.data.byteLength:Xm+=Uo(JSON.stringify(s.data)),i&&r({data:s.data,headers:s.headers}),r(s.data)}).catch(s=>{yi.isCancel(s)?o(new G(b.OPERATION_ABORTED,"cancel token canceled")):s.code==="ECONNABORTED"?o(new G(b.NETWORK_TIMEOUT,s.message)):s.response?o(new G(b.NETWORK_RESPONSE_ERROR,s.response.status)):o(new G(b.NETWORK_ERROR,s.message))})})}async function GF(t,e){const n=new Blob([e.data],{type:"buffer"});return await Qm(t,mt(mt({},e),{},{data:n,headers:{"Content-Type":"application/octet-stream"}}),!0)}const sb=()=>window.isSecureContext!==void 0,pr=function(t){if(t.match(/[0-9]+\.[0-9]+\.[0-9]+$/))return t;const e=t.match(/([0-9]+\.[0-9]+\.[0-9]+)\-alpha\.([0-9]+)/);if(e&&e[1]&&e[2]){const i=e[1],r=e[2];return"".concat(i,".").concat(r)}const n=t.match(/([0-9]+\.[0-9]+\.[0-9]+)\-special\.([0-9]+)/);if(n&&n[1]&&n[2]){const i=n[1],r=n[2];return"".concat(i,".").concat(100*(Number(r)+1))}return"4.0.0.999"}("4.21.0"),Zm=function(){try{return JSON.parse("true")===!0}catch{return!0}}();let Fa=function(t){return t.Default="default",t.Auto="auto",t.Relay="relay",t.SdRtn="sd-rtn",t}({});const $m={MIN_FRAME_RATE:1,MAX_FRAME_RATE:30,MAX_THRESHOLD_FRAMERATE:30,BITRATE_MIN_THRESHOLD:100,BITRATE_MAX_THRESHOLD:100,MAX_SCALE:5,BWE_SCALE_UP_THRESHOLD:.6,BWE_SCALE_DOWN_THRESHOLD:.6,PERF_SCALE_UP_THRESHOLD:.7,PERF_SCALE_DOWN_THRESHOLD:.6,MOTION_RESOLUTION_FACTOR:.8,MOTION_BITRATE_FACTOR:.6,DETAIL_FRAMERATE_FACTOR:.8,DETAIL_BITRATE_FACTOR:.6,BALANCE_RESOLUTION_FACTOR:.9,BALANCE_FRAMERATE_FACTOR:.9,BALANCE_BITRATE_FACTOR:.6,OVERUSE_TIMES_THRESHOLD:10,UNDERUSE_TIMES_THRESHOLD:40},tg="v4.21.0-0-g16fdae2c-dirty(6/3/2024, 2:55:18 PM)",Rn={PROCESS_ID:"",ENCRYPT_AES:!0,AREAS:["CHINA","GLOBAL"],WEBCS_DOMAIN:["webrtc2-ap-web-1.agora.io","webrtc2-2.ap.sd-rtn.com"],WEBCS_DOMAIN_BACKUP_LIST:["webrtc2-ap-web-3.agora.io","webrtc2-4.ap.sd-rtn.com"],PROXY_CS:["ap-proxy-1.agora.io","ap-proxy-2.agora.io"],CDS_AP:["cds-ap-web-1.agora.io","cds-web-2.ap.sd-rtn.com","cds-ap-web-3.agora.io","cds-web-4.ap.sd-rtn.com"],ACCOUNT_REGISTER:["sua-ap-web-1.agora.io","sua-web-2.ap.sd-rtn.com","sua-ap-web-3.agora.io","sua-web-4.ap.sd-rtn.com"],UAP_AP:["uap-ap-web-1.agora.io","uap-web-2.ap.sd-rtn.com","uap-ap-web-3.agora.io","uap-web-4.ap.sd-rtn.com"],LOG_UPLOAD_SERVER:"logservice.agora.io",EVENT_REPORT_DOMAIN:"statscollector-1.agora.io",EVENT_REPORT_BACKUP_DOMAIN:"web-2.statscollector.sd-rtn.com",ENABLE_EVENT_REPORT:!0,GATEWAY_ADDRESS:[],GATEWAY_WSS_ADDRESS:"",LIVE_STREAMING_ADDRESS:"",HTTP_CONNECT_TIMEOUT:5e3,SIGNAL_REQUEST_TIMEOUT:1e4,REPORT_STATS:!0,UPLOAD_LOG:!1,NOT_REPORT_EVENT:[],SUBSCRIBE_TWCC:!0,PUBLISH_TWCC:!1,PING_PONG_TIME_OUT:10,WEBSOCKET_TIMEOUT_MIN:1e4,EVENT_REPORT_SEND_INTERVAL:3e3,CONFIG_DISTRIBUTE_INTERVAL:3e5,ENABLE_CONFIG_DISTRIBUTE:!0,CANDIDATE_TIMEOUT:5e3,SHOW_REPORT_INVOKER_LOG:!1,JOIN_EXTEND:"",PUB_EXTEND:"",SUB_EXTEND:"",FORCE_TURN:!1,TURN_ENABLE_TCP:!0,TURN_ENABLE_UDP:!0,MAX_UPLOAD_CACHE:50,UPLOAD_CACHE_INTERVAL:2e3,AJAX_REQUEST_CONCURRENT:3,REPORT_APP_SCENARIO:void 0,GATEWAY_DOMAINS:["edge.agora.io","edge.sd-rtn.com"],CONNECT_GATEWAY_WITHOUT_DOMAIN:!1,WORKER_DOMAIN:"edge.agora.io",TURN_DOMAIN:"edge.agora.io",EVENT_REPORT_RETRY:!0,CHROME_FORCE_PLAN_B:!1,AUDIO_SOURCE_VOLUME_UPDATE_INTERVAL:400,AUDIO_SOURCE_AVG_VOLUME_DURATION:3e3,AUDIO_VOLUME_INDICATION_INTERVAL:2e3,VOLUME_VOICE_WEIGHT:10,GET_VOLUME_OF_MUTED_AUDIO_TRACK:!1,STATS_UPDATE_INTERVAL:250,NORMAL_EVENT_QUEUE_CAPACITY:100,CUSTOM_REPORT:!0,CUSTOM_REPORT_LIMIT:20,PROXY_SERVER_TYPE2:"webnginx-proxy.agora.io",PROXY_SERVER_TYPE3:["webrtc-cloud-proxy.sd-rtn.com","webrtc-cloud-proxy.agora.io"],CUSTOM_PUB_ANSWER_MODIFIER:null,CUSTOM_SUB_ANSWER_MODIFIER:null,CUSTOM_PUB_OFFER_MODIFIER:null,CUSTOM_SUB_OFFER_MODIFIER:null,DSCP_TYPE:"high",REMOVE_NEW_CODECS:!0,FRAGEMENT_LENGTH:3,WEBSOCKET_COMPRESS:!1,SIMULCAST:!1,PRELOAD_MEDIA_COUNT:0,USE_PUB_RTX:!0,USE_SUB_RTX:!0,USE_XR:!0,ENABLE_LOSSBASED_BWE:!0,ENABLE_AUT_CC:void 0,ENABLE_CC_FALLBACK:void 0,CHECK_VIDEO_VISIBLE_INTERVAL:3e4,CHECK_LOCAL_STATS_INTERVAL:250,PROFILE_SWITCH_INTERVAL:2e3,UNSUPPORTED_VIDEO_CODEC:[],ENUMERATE_DEVICES_INTERVAL:!1,ENUMERATE_DEVICES_INTERVAL_TIME:1e4,USE_NEW_TOKEN:!1,CLOSE_AFB_FOR_LOCAL_AP:!0,JOIN_MAX_CONCURRENCY:6,JOIN_WITH_FALLBACK_SIGNAL_PROXY:!0,JOIN_WITH_FALLBACK_MEDIA_PROXY:!0,JOIN_WITH_FALLBACK_MEDIA_PROXY_FORCE:!1,JOIN_GATEWAY_TRY_443PORT_DURATION:2e3,JOIN_GATEWAY_USE_443PORT_ONLY:!1,JOIN_GATEWAY_USE_DUAL_DOMAIN:!0,JOIN_GATEWAY_FALLBACK_PORT:443,USE_TURN_SERVER_OF_GATEWAY:!1,H264_PROFILE_LEVEL_ID:"",USE_NEW_LOG:!1,LOG_VERSION:3,MEDIA_DEVICE_CONSTRAINTS:null,ENCRYPT_PROXY_USERNAME_AND_PSW:!0,SDP_LOGGING:!1,CSP_DETECTED_HOSTNAME_LIST:["agora.io","sd-rtn.com"],REMOTE_AUDIO_TRACK_USES_WEB_AUDIO:!1,LOCAL_AUDIO_TRACK_USES_WEB_AUDIO:!1,BITRATE_ADAPTER_TYPE:"STANDARD_BITRATE",AI_DENOISER_PARAMETERS:{excludedLinks:[]},ADJUST_3A_FROM_PLUGINS:!0,RAISE_H264_BASELINE_PRIORITY:!0,FILTER_SEND_H264_BASELINE:!1,ENABLE_PUBLISHED_USER_LIST:!0,MAX_SUBSCRIPTION:50,X_GOOGLE_START_BITRATE:void 0,NEW_REPORT_SERVER:!1,NEW_REPORT_SERVER_DOMAINS:["data-reporting.agora.io","data-reporting.agora.io"],VIDEO_INSPECT_WORKER_MESSAGE_LENGTH_LIMIT:3e5,VIDEO_INSPECT_INTERVAL_MINIMUM:1e3,VIDEO_INSPECT_QUALITY_RATIO:.9,VIDEO_INSPECT_WORKER_MANAGER_HOST:"edge.agora.io",VIDEO_INSPECT_WORKER_MANAGER_PORT:"",VIDEO_INSPECT_WORKER_PORT:"",SHOW_VIDEO_INSPECT_WORKER_MESSAGE:!1,STATS_COLLECTOR_PORT:443,FORCE_TURN_TCP:!1,SUBSCRIBE_AUDIO_FILTER_TOPN:void 0,ENABLE_PUBLISH_AUDIO_FILTER:void 0,DISABLE_FEC:void 0,WEBAUDIO_INIT_OPTIONS:void 0,FILTER_VIDEO_FEC:!0,FILTER_AUDIO_FEC:!1,CHROME_DUAL_STREAM_USE_ENCODING:!0,DISABLE_DUAL_STREAM_USE_ENCODING:!1,EXTENSION_USAGE_UPLOAD_INTERVAL:1e4,ICE_RESTART:!0,ICE_RESTART_INTERVAL:1e4,NEW_ICE_RESTART:!1,ENABLE_USER_LICENSE_CHECK:!0,SIGNAL_CHANNEL:0,TRANSMITTER_INITIAL_RTT:30,TRANSMITTER_INITIAL_RTO:30,TRANSMITTER_MAX_BATCH_ACK_COUNT:2,TRANSMITTER_MAX_RTO:500,DATACHANNEL_COMPRESS:!1,FINGERPRINT:null,DC_JOIN_WITH_FAILBACK:5e3,ENABLE_VIDEO_FRAME_CALLBACK:!0,VIDEO_FREEZE_DURATION:500,SPATIALIZER_PARAMETERS:{},UPLOAD_LOG_INTERVAL:3e3,UPLOAD_LOG_REQUEST_RETRY_INTERVAL:2e3,UPLOAD_LOG_REQUEST_MAX_RETRY_INTERVAL:2e4,UPLOAD_LOG_TRY_INTERVAL_WHILE_OFF:5e3,UPLOAD_LOG_RETRY_INTERVAL_V1:1e4,UPLOAD_LOG_TWICE_RETRY_INTERVAL_V1:200,UPLOAD_LOG_LENGTH_EACH_TIME:10,APP_TYPE:0,DISABLE_WEBAUDIO:!1,CHANNEL_MEDIA_RELAY_SERVERS:void 0,KEEP_LAST_FRAME:!0,FORWARD_P2P_CREATION:!0,SYNC_GROUP:!0,BLOCK_LOCAL_CLIENT:!1,AP_AREA:!0,SVC:[],ENABLE_ENCODED_TRANSFORM:!1,ENABLE_VIDEO_SEI:!1,IMAGE_MODERATION_WORKER_HOST:"edge.agora.io",IMAGE_MODERATION_WORKER_MESSAGE_LENGTH_LIMIT:3e5,IMAGE_MODERATION_INTERVAL_MINIMUM:1e3,SHOW_IMAGE_MODERATION_WORKER_MESSAGE:!1,IMAGE_MODERATION_QUALITY_RATIO:.9,IMAGE_MODERATION_UPLOAD_REPORT_INTERVAL:5e3,SHOW_GLOBAL_CLIENT_LIST:!1,ENABLE_DATASTREAM_2:!1,DATASTREAM_MAX_RETRANSMITS:10,ENABLE_USER_AUTO_REBALANCE_CHECK:!0,ENABLE_INSTANT_VIDEO:!1,ENABLE_NTP_REPORT:!1,TCP_CANDIDATE_ONLY:!1,EXTERNAL_SIGNAL_REQUEST_TIMEOUT:3e3,SHOW_P2P_LOG:!1,MAX_P2P_TIMEOUT:3e4,P2P_TOKEN_INTERVAL:1e3,SHOW_DATASTREAM2_LOG:!1,RESTRICTION_SET_PLAYBACK_DEVICE:!0,USE_PURE_ENCRYPTION_MASTER_KEY:!1,ACCOUNT_REGISTER_RETRY_TIMEOUT:1,ACCOUNT_REGISTER_RETRY_RATIO:2,ACCOUNT_REGISTER_RETRY_TIMEOUT_MAX:6e4,ACCOUNT_REGISTER_RETRY_COUNT_MAX:1e5,AUDIO_CONTEXT:null,WEBCS_BACKUP_CONNECT_TIMEOUT:6e3,PLAYER_STATE_DEFER:2e3,SIGNAL_REQUEST_WATCH_INTERVAL:1e3,FILEPATH_LENMAX:255,DUALSTREAM_OPERATION_CHECK:!0,MEDIA_ELEMENT_EXISTS_DEPTH:3,SHIM_CANDIDATE:!1,LEAVE_MSG_TIMEOUT:2e3,STATS_FILTER:{transportId:!0,googTrackId:!0},FILTER_VIDEO_CODEC:[],USE_NEW_NETWORK_CONFIG:!1,AUTO_RESET_AUDIO_ROUTE:!1,PLUGIN_INFO:[],OVERUSE_DETECTOR_PARAMS:$m,ENABLE_AG_ADAPTATION:!0,FORCE_AG_HIGH_FRAMERATE:!1,FORCE_SUPPORT_AG_ADAPTATION:!1,CUSTOM_ADAPTATION_DEFAULT_MODE:"",ENCODER_CONFIG_LIMIT:{},CAMERA_CAPTURE_CONFIG:void 0,HIDE_NO_POSTER:!1,AP_CACHE_NUM:10,AP_UPDATE_INTERVAL:12e4,AP_CACHE_LIFETIME:12e4,MAX_PRELOAD_ASYNC_LENGTH:3,ENABLE_PRELOAD:!0};function Re(t,e,n){var i,r,o;it(i=Object.keys(Rn)).call(i,t)&&(!n&&it(r=Object.keys(qs)).call(r,t)||(Rn[t]=e,t==="ENABLE_VIDEO_SEI"&&e===!0&&(Rn.ENABLE_ENCODED_TRANSFORM=!0),t==="USE_NEW_NETWORK_CONFIG"&&e&&(o=!!e,Rn.USE_NEW_NETWORK_CONFIG=o,o&&(Rn.WEBCS_DOMAIN=["webrtc2-2.ap.sd-rtn.com"],Rn.WEBCS_DOMAIN_BACKUP_LIST=["webrtc2-4.ap.sd-rtn.com"],Rn.CDS_AP=["cds-web-2.ap.sd-rtn.com","cds-web-4.ap.sd-rtn.com"],Rn.ACCOUNT_REGISTER=["sua-web-2.ap.sd-rtn.com","sua-web-4.ap.sd-rtn.com"],Rn.EVENT_REPORT_DOMAIN="web-2.statscollector.sd-rtn.com",Rn.EVENT_REPORT_BACKUP_DOMAIN="statscollector-1.agora.io",Rn.GATEWAY_DOMAINS=["edge.sd-rtn.com"]))))}function N(t){return Rn[t]}const qs={};var Bt=function(t){return t.SET_SESSION_ID="SET_SESSION_ID",t.SET_P2P_ID="SET_P2P_id",t.SET_DC_ID="SET_DC_id",t.SET_UID="SET_UID",t.SET_INT_UID="SET_INT_UID",t.SET_PUB_ID="SET_PUB_ID",t.SET_CLOUD_PROXY_SERVER_MODE="SET_CLOUD_PROXY_SERVER_MODE",t.KEY_METRIC_CLIENT_CREATED="KEY_METRIC_CLIENT_CREATED",t.KEY_METRIC_JOIN_START="KEY_METRIC_JOIN_START",t.AVOID_JOIN_START="AVOID_JOIN_START",t.KEY_METRIC_JOIN_END="KEY_METRIC_JOIN_END",t.KEY_METRIC_REQUEST_AP_START="KEY_METRIC_REQUEST_AP_START",t.KEY_METRIC_REQUEST_AP_END="KEY_METRIC_REQUEST_AP_END",t.KEY_METRIC_JOIN_GATEWAY_START="KEY_METRIC_JOIN_GATEWAY_START",t.KEY_METRIC_JOIN_GATEWAY_END="KEY_METRIC_JOIN_GATEWAY_END",t.KEY_METRIC_PEER_CONNECTION_START="KEY_METRIC_PEER_CONNECTION_START",t.KEY_METRIC_PEER_CONNECTION_END="KEY_METRIC_PEER_CONNECTION_END",t.KEY_METRIC_DESCRIPTION_START="KEY_METRIC_DESCRIPTION_START",t.KEY_METRIC_ICE_CONNECTION_END="KEY_METRIC_ICE_CONNECTION_END",t.KEY_METRIC_SIGNAL_CHANNEL_OPEN="KEY_METRIC_SIGNAL_CHANNEL_OPEN",t.KEY_METRIC_PUBLISH="KEY_METRIC_PUBLISH",t.KEY_METRIC_SUBSCRIBE="KEY_METRIC_SUBSCRIBE",t.RECORD_JOIN_CHANNEL_SERVICE="RECORD_JOIN_CHANNEL_SERVICE",t.RESET_JOIN_CHANNEL_SERVICE_RECORDS="RESET_JOIN_CHANNEL_SERVICE_RECORDS",t.RESET_KEY_METRICS="RESET_KEY_METRICS",t.SET_USE_DATACHANNEL="SET_USE_DATACHANNEL",t.SET_USE_P2P="SET_USE_P2P",t.SET_TRANSPORT_TYPE="SET_TRANSPORT_TYPE",t}(Bt||{});class WF{constructor(e,n,i,r){Me(this,"state",void 0),this.state={codec:e,audioCodec:n,mode:i,clientId:r,sessionId:null,p2pId:0,dcId:0,pubId:0,subId:0,avoidJoinStart:0,keyMetrics:{publish:[],subscribe:[]},joinChannelServiceRecords:[],cloudProxyServerMode:"disabled",useDataChannel:!1,useP2P:!1,p2pTransport:Fa.Default}}dispatch(e){this.state=function(n,i){switch(i.type){case Bt.SET_SESSION_ID:return mt(mt({},n),{},{sessionId:i.sessionId});case Bt.SET_P2P_ID:return mt(mt({},n),{},{p2pId:i.p2pId});case Bt.SET_UID:return mt(mt({},n),{},{uid:i.uid});case Bt.SET_INT_UID:return mt(mt({},n),{},{intUid:i.intUid});case Bt.SET_PUB_ID:return mt(mt({},n),{},{pubId:i.pubId});case Bt.KEY_METRIC_CLIENT_CREATED:return mt(mt({},n),{},{keyMetrics:mt(mt({},n.keyMetrics),{},{clientCreated:i.metric})});case Bt.KEY_METRIC_JOIN_START:return mt(mt({},n),{},{keyMetrics:mt(mt({},n.keyMetrics),{},{joinStart:i.metric})});case Bt.AVOID_JOIN_START:return mt(mt({},n),{},{avoidJoinStart:i.avoidJoinStart});case Bt.KEY_METRIC_JOIN_END:return mt(mt({},n),{},{keyMetrics:mt(mt({},n.keyMetrics),{},{joinEnd:i.metric})});case Bt.KEY_METRIC_REQUEST_AP_START:return mt(mt({},n),{},{keyMetrics:mt(mt({},n.keyMetrics),{},{requestAPStart:i.metric})});case Bt.KEY_METRIC_REQUEST_AP_END:return mt(mt({},n),{},{keyMetrics:mt(mt({},n.keyMetrics),{},{requestAPEnd:i.metric})});case Bt.KEY_METRIC_JOIN_GATEWAY_START:return mt(mt({},n),{},{keyMetrics:mt(mt({},n.keyMetrics),{},{joinGatewayStart:i.metric})});case Bt.KEY_METRIC_JOIN_GATEWAY_END:return mt(mt({},n),{},{keyMetrics:mt(mt({},n.keyMetrics),{},{joinGatewayEnd:i.metric})});case Bt.KEY_METRIC_PEER_CONNECTION_START:return mt(mt({},n),{},{keyMetrics:mt(mt({},n.keyMetrics),{},{peerConnectionStart:i.metric})});case Bt.KEY_METRIC_PEER_CONNECTION_END:return mt(mt({},n),{},{keyMetrics:mt(mt({},n.keyMetrics),{},{peerConnectionEnd:i.metric})});case Bt.KEY_METRIC_DESCRIPTION_START:return mt(mt({},n),{},{keyMetrics:mt(mt({},n.keyMetrics),{},{descriptionStart:i.metric})});case Bt.KEY_METRIC_SIGNAL_CHANNEL_OPEN:return mt(mt({},n),{},{keyMetrics:mt(mt({},n.keyMetrics),{},{signalChannelOpen:i.metric})});case Bt.KEY_METRIC_ICE_CONNECTION_END:return mt(mt({},n),{},{keyMetrics:mt(mt({},n.keyMetrics),{},{iceConnectionEnd:i.metric})});case Bt.KEY_METRIC_PUBLISH:{const r=n.keyMetrics.publish,o=r.findIndex(s=>s.trackId===i.metric.trackId);return o!==-1?(r[o]=mt(mt({},r[o]),i.metric),mt(mt({},n),{},{keyMetrics:mt(mt({},n.keyMetrics),{},{publish:[...r]})})):mt(mt({},n),{},{keyMetrics:mt(mt({},n.keyMetrics),{},{publish:[...n.keyMetrics.publish,i.metric]})})}case Bt.KEY_METRIC_SUBSCRIBE:{const r=n.keyMetrics.subscribe,o=r.findIndex(s=>s.userId===i.metric.userId&&s.type===i.metric.type);return o!==-1?(r[o]=mt(mt({},r[o]),i.metric),mt(mt({},n),{},{keyMetrics:mt(mt({},n.keyMetrics),{},{subscribe:[...r]})})):mt(mt({},n),{},{keyMetrics:mt(mt({},n.keyMetrics),{},{subscribe:[...n.keyMetrics.subscribe,i.metric]})})}case Bt.SET_CLOUD_PROXY_SERVER_MODE:return n.cloudProxyServerMode=i.mode,n;case Bt.RECORD_JOIN_CHANNEL_SERVICE:return typeof i.index!="number"?n.joinChannelServiceRecords=[...n.joinChannelServiceRecords,i.record]:(n.joinChannelServiceRecords[i.index]=mt(mt({},n.joinChannelServiceRecords[i.index]),i.record),n.joinChannelServiceRecords=[...n.joinChannelServiceRecords]),n;case Bt.RESET_JOIN_CHANNEL_SERVICE_RECORDS:return n.joinChannelServiceRecords=[],n;case Bt.RESET_KEY_METRICS:return n.keyMetrics={publish:[],subscribe:[]},n;case Bt.SET_USE_DATACHANNEL:return mt(mt({},n),{},{useDataChannel:i.val});case Bt.SET_USE_P2P:return mt(mt({},n),{},{useP2P:i.val});case Bt.SET_TRANSPORT_TYPE:return mt(mt({},n),{},{p2pTransport:i.val});default:return n}}(this.state,e)}set sessionId(e){this.dispatch({type:Bt.SET_SESSION_ID,sessionId:e})}get sessionId(){return this.state.sessionId}set codec(e){this.state.codec=e}get codec(){return this.state.codec}get mode(){return this.state.mode}get audioCodec(){return this.state.audioCodec}get clientId(){return this.state.clientId}set p2pId(e){this.dispatch({type:Bt.SET_P2P_ID,p2pId:e})}get p2pId(){return this.state.p2pId}set dcId(e){this.dispatch({type:Bt.SET_DC_ID,dcId:e})}get dcId(){return this.state.dcId}set uid(e){this.dispatch({type:Bt.SET_UID,uid:e})}get uid(){return this.state.uid}set intUid(e){this.dispatch({type:Bt.SET_INT_UID,intUid:e})}get intUid(){return this.state.intUid}set pubId(e){this.dispatch({type:Bt.SET_PUB_ID,pubId:e})}get pubId(){return this.state.pubId}set cloudProxyServerMode(e){this.dispatch({type:Bt.SET_CLOUD_PROXY_SERVER_MODE,mode:e})}get cloudProxyServerMode(){return this.state.cloudProxyServerMode}set useDataChannel(e){this.dispatch({type:Bt.SET_USE_DATACHANNEL,val:e})}get useDataChannel(){return this.state.useDataChannel}set useP2P(e){this.dispatch({type:Bt.SET_USE_P2P,val:e})}get useP2P(){return this.state.useP2P}set p2pTransport(e){this.dispatch({type:Bt.SET_TRANSPORT_TYPE,val:e})}get p2pTransport(){return this.state.p2pTransport}clientCreated(){this.dispatch({type:Bt.KEY_METRIC_CLIENT_CREATED,metric:Date.now()})}joinStart(){this.dispatch({type:Bt.KEY_METRIC_JOIN_START,metric:Date.now()})}joinEnd(){this.dispatch({type:Bt.KEY_METRIC_JOIN_END,metric:Date.now()})}requestAPStart(){this.dispatch({type:Bt.KEY_METRIC_REQUEST_AP_START,metric:Date.now()})}requestAPEnd(){this.dispatch({type:Bt.KEY_METRIC_REQUEST_AP_END,metric:Date.now()})}joinGatewayStart(){this.dispatch({type:Bt.KEY_METRIC_JOIN_GATEWAY_START,metric:Date.now()})}joinGatewayEnd(){this.dispatch({type:Bt.KEY_METRIC_JOIN_GATEWAY_END,metric:Date.now()})}peerConnectionStart(){this.dispatch({type:Bt.KEY_METRIC_PEER_CONNECTION_START,metric:Date.now()})}peerConnectionEnd(){this.dispatch({type:Bt.KEY_METRIC_PEER_CONNECTION_END,metric:Date.now()})}descriptionStart(){this.dispatch({type:Bt.KEY_METRIC_DESCRIPTION_START,metric:Date.now()})}signalChannelOpen(){this.dispatch({type:Bt.KEY_METRIC_SIGNAL_CHANNEL_OPEN,metric:Date.now()})}iceConnectionEnd(){this.dispatch({type:Bt.KEY_METRIC_ICE_CONNECTION_END,metric:Date.now()})}publish(e,n,i,r){this.dispatch({type:Bt.KEY_METRIC_PUBLISH,metric:mt(mt({trackId:e,type:n},i&&{publishStart:i}),r&&{publishEnd:r})})}subscribe(e,n,i,r,o,s,a){this.dispatch({type:Bt.KEY_METRIC_SUBSCRIBE,metric:mt(mt(mt(mt(mt({userId:e,type:n},i&&{subscribeStart:i}),r&&{subscribeEnd:r}),o&&{firstFrame:o}),s&&{streamAdded:s}),a&&{firstDecoded:a})})}massSubscribe(e,n,i,r){e.forEach(o=>{this.dispatch({type:Bt.KEY_METRIC_SUBSCRIBE,metric:mt(mt(mt({userId:o.userId,type:o.type},n&&{subscribeStart:n}),i&&{subscribeEnd:i}),r&&{firstFrame:r})})})}get keyMetrics(){return this.state.keyMetrics}recordJoinChannelService(e,n){e.service==="gateway"&&Array.isArray(e.urls)&&(e.urls=e.urls.map(i=>i.replace(/(\d+)-\d+-\d+-(\d+)/,"$1-*-*-$2")));try{return typeof n!="number"?(this.dispatch({type:Bt.RECORD_JOIN_CHANNEL_SERVICE,record:mt(mt({},e),{},{sessionId:this.sessionId,cloudProxyMode:this.cloudProxyServerMode,uid:this.uid})}),this.state.joinChannelServiceRecords.length-1):(n<0||n>=this.state.joinChannelServiceRecords.length||this.dispatch({type:Bt.RECORD_JOIN_CHANNEL_SERVICE,record:e,index:n}),n)}catch{return 0}}resetJoinChannelServiceRecords(){this.dispatch({type:Bt.RESET_JOIN_CHANNEL_SERVICE_RECORDS})}resetKeyMetrics(){this.dispatch({type:Bt.RESET_KEY_METRICS})}get joinChannelServiceRecords(){try{return this.state.joinChannelServiceRecords}catch{return[]}}get avoidJoinStart(){return this.state.avoidJoinStart}set avoidJoinStart(e){this.dispatch({type:Bt.AVOID_JOIN_START,avoidJoinStart:e})}}let ed=function(t){return t.h264="h264",t.h265="h265",t.vp8="vp8",t.vp9="vp9",t.av1="av1",t}({});(function(t){t.opus="opus",t.pcma="pcma",t.pcmu="pcmu",t.g722="g722"})({});const ab=128,HF=96,cb=1e3,nd=10;let KF=0;function db(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),n.push.apply(n,i)}return n}function kt(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?db(Object(n),!0).forEach(function(i){en(t,i,n[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):db(Object(n)).forEach(function(i){Object.defineProperty(t,i,Object.getOwnPropertyDescriptor(n,i))})}return t}function en(t,e,n){return(e=function(i){var r=function(o,s){if(typeof o!="object"||o===null)return o;var a=o[Symbol.toPrimitive];if(a!==void 0){var c=a.call(o,"string");if(typeof c!="object")return c;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(o)}(i);return typeof r=="symbol"?r:String(r)}(e))in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}const ub=new class extends Ve{constructor(){super(...arguments),en(this,"currentUploadLogID",0)}reportLogUploadError(t){const{errorRange:e}=t;e[e.length-1]&&e[e.length-1]>this.currentUploadLogID&&(this.currentUploadLogID=e[e.length-1],this.emit("REPORT_LOG_UPLOAD",t))}};class qF{constructor(e){en(this,"logger",void 0),en(this,"prefixLists",[]),this.logger=e}debug(){for(var e=arguments.length,n=new Array(e),i=0;i<e;i++)n[i]=arguments[i];this.logger.debug(...this.prefixLists,...n)}info(){for(var e=arguments.length,n=new Array(e),i=0;i<e;i++)n[i]=arguments[i];this.logger.info(...this.prefixLists,...n)}warning(){for(var e=arguments.length,n=new Array(e),i=0;i<e;i++)n[i]=arguments[i];this.logger.warning(...this.prefixLists,...n)}error(){for(var e=arguments.length,n=new Array(e),i=0;i<e;i++)n[i]=arguments[i];this.logger.error(...this.prefixLists,...n)}prefix(e){return this.prefixLists.push(e),this}popPrefix(){return this.prefixLists.pop(),this}}function eg(){const t=new Date;return t.toTimeString().split(" ")[0]+":"+t.getMilliseconds()}function lb(){const t=new Date,e=/((\d+:){2}\d+)/.exec(new Date().toUTCString());return e?(e==null?void 0:e[0])+":"+t.getUTCMilliseconds():t.toTimeString().split(" ")[0]+":"+t.getMilliseconds()}const fr={DEBUG:0,INFO:1,WARNING:2,ERROR:3,NONE:4},jp=Date.now(),Xu=t=>{for(const e in fr)if(Object.prototype.hasOwnProperty.call(fr,e)&&fr[e]===t)return e;return"DEFAULT"},E=new class{constructor(){en(this,"proxyServerURL",void 0),en(this,"logLevel",fr.DEBUG),en(this,"uploadState","collecting"),en(this,"uploadLogWaitingList",[]),en(this,"uploadLogUploadingList",[]),en(this,"uploadErrorCount",0),en(this,"currentLogID",0),en(this,"url",void 0),en(this,"extLog",(t,e)=>{this.appendLogToWaitingList(t,...e)})}debug(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];const i=[fr.DEBUG].concat(e);this.log.apply(this,i)}info(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];const i=[fr.INFO].concat(e);this.log.apply(this,i)}warning(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];const i=[fr.WARNING].concat(e);this.log.apply(this,i)}warn(){this.warning(...arguments)}error(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];const i=[fr.ERROR].concat(e);this.log.apply(this,i)}upload(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];const i=[fr.DEBUG].concat(e);this.uploadLog.apply(this,i)}setLogLevel(t){t=Math.min(Math.max(0,t),4),this.logLevel=t}enableLogUpload(){Re("UPLOAD_LOG",!0)}disableLogUpload(){Re("UPLOAD_LOG",!1),this.uploadLogUploadingList=[],this.uploadLogWaitingList=[]}setProxyServer(t){this.proxyServerURL=t}prefix(t){return new qF(this).prefix(t)}log(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];if(Date.now()-jp<100)return void setTimeout(()=>{this.log(...e)},Date.now()-jp);const i=Math.max(0,Math.min(4,e[0]));if(e[0]=eg()+" Agora-SDK [".concat(Xu(i),"]:"),this.appendLogToWaitingList(i,...e),i<this.logLevel)return;const r=eg()+" %cAgora-SDK [".concat(Xu(i),"]:");let o=[];if(!N("USE_NEW_LOG"))switch(i){case fr.DEBUG:o=[r,"color: #64B5F6;"].concat(e.slice(1)),console.log.apply(console,o);break;case fr.INFO:o=[r,"color: #1E88E5; font-weight: bold;"].concat(e.slice(1)),console.log.apply(console,o);break;case fr.WARNING:o=[r,"color: #FB8C00; font-weight: bold;"].concat(e.slice(1)),console.warn.apply(console,o);break;case fr.ERROR:o=[r,"color: #B00020; font-weight: bold;"].concat(e.slice(1)),console.error.apply(console,o)}}uploadLog(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];if(Date.now()-jp<100)return void setTimeout(()=>{this.uploadLog(...e)},Date.now()-jp);const i=Math.max(0,Math.min(4,e[0]));e[0]=eg()+" Agora-SDK [".concat(Xu(i),"]:"),this.appendLogToWaitingList(i,...e)}appendLogToWaitingList(t){if(!N("UPLOAD_LOG"))return;for(var e=arguments.length,n=new Array(e>1?e-1:0),i=1;i<e;i++)n[i-1]=arguments[i];Array.isArray(n[0])?n[0][0]=lb()+" Agora-SDK [".concat(Xu(t),"]:"):n[0]=lb()+" Agora-SDK [".concat(Xu(t),"]:");let r="";n.forEach(o=>{typeof o=="object"&&(o=JSON.stringify(o)),r+="".concat(o," ")}),this.uploadLogWaitingList.push({payload_str:r,log_level:t,log_item_id:this.currentLogID++}),this.uploadState==="uploading"&&this.uploadLogUploadingList.length===0&&this.uploadLogInterval()}startUpload(){this.uploadState="uploading",this.uploadLogUploadingList.length===0&&this.uploadLogInterval()}async uploadLogs(){const t=this.uploadLogUploadingList,e={sdk_version:pr,process_id:N("PROCESS_ID"),payload:JSON.stringify(t)};return so(async()=>{const n=await yi.post(this.url||(this.proxyServerURL?"https://".concat(this.proxyServerURL,"/ls/?h=").concat(N("LOG_UPLOAD_SERVER"),"&p=443&d=upload/v1"):"https://".concat(N("LOG_UPLOAD_SERVER"),"/upload/v1")),e,{responseType:"text"});if(n.data!=="OK"){const i=new Error("unexpected upload log response");throw i.response=n,i}},()=>(this.uploadLogUploadingList=[],!1),n=>{const i={status:-1,message:n.message,errorRange:t.map(r=>r.log_item_id)};return n.response?(i.status=n.response.status,i.data=n.response.data,i.headers=n.response.headers):n.request&&(i.status=n.request.status),ub.reportLogUploadError(i),!0},{timeout:N("UPLOAD_LOG_REQUEST_RETRY_INTERVAL"),maxRetryTimeout:N("UPLOAD_LOG_REQUEST_MAX_RETRY_INTERVAL")})}uploadLogInterval(){this.uploadLogUploadingList.length===0&&this.uploadLogWaitingList.length===0||(this.uploadLogUploadingList.length===0&&(this.uploadLogUploadingList=this.uploadLogWaitingList.splice(0,N("UPLOAD_LOG_LENGTH_EACH_TIME"))),this.uploadLogs().then(()=>{this.uploadErrorCount=0,this.uploadLogWaitingList.length>0&&window.setTimeout(()=>this.uploadLogInterval(),N("UPLOAD_LOG_INTERVAL"))}).catch(t=>{this.uploadErrorCount+=1,this.uploadErrorCount<2?window.setTimeout(()=>this.uploadLogInterval(),N("UPLOAD_LOG_TWICE_RETRY_INTERVAL_V1")):window.setTimeout(()=>this.uploadLogInterval(),N("UPLOAD_LOG_RETRY_INTERVAL_V1"))}))}};var hb;function YF(t){return Fn(t.reportId,"params.reportId",0,100,!1),Fn(t.category,"params.category",0,100,!1),Fn(t.event,"params.event",0,100,!1),Fn(t.label,"params.label",0,100,!1),Se(t.value,"params.value",Number.MIN_SAFE_INTEGER,Number.MAX_SAFE_INTEGER,!1),!0}(hb={}).FREE="free",hb.UPLOADING="uploading",function(t){t[t.MISC=0]="MISC",t[t.INTERNAL_EVENT=1]="INTERNAL_EVENT",t[t.PUBLIC_EVENT=2]="PUBLIC_EVENT",t[t.WEB_EVENT=3]="WEB_EVENT",t[t.INTERNAL_API=4]="INTERNAL_API",t[t.WEB_API=5]="WEB_API",t[t.PUBLIC_API=6]="PUBLIC_API"}({});const zF={sid:"",lts:0,success:null,cname:null,uid:null,peer:null,cid:null,elapse:null,extend:null,vid:0};let Mn=function(t){return t.PUBLISH="publish",t.SUBSCRIBE="subscribe",t.WS_COMPRESSOR_INIT="ws_compressor_init",t.SESSION_INIT="session_init",t.JOIN_CHOOSE_SERVER="join_choose_server",t.REQ_USER_ACCOUNT="req_user_account",t.JOIN_GATEWAY="join_gateway",t.REJOIN_GATEWAY="rejoin_gateway",t.STREAM_SWITCH="stream_switch",t.REQUEST_PROXY_WORKER_MANAGER="request_proxy_worker_manager",t.REQUEST_PROXY_APPCENTER="request_proxy_appcenter",t.FIRST_VIDEO_RECEIVED="first_video_received",t.FIRST_AUDIO_RECEIVED="first_audio_received",t.FIRST_VIDEO_DECODE="first_video_decode",t.FIRST_AUDIO_DECODE="first_audio_decode",t.ON_ADD_AUDIO_STREAM="on_add_audio_stream",t.ON_ADD_VIDEO_STREAM="on_add_video_stream",t.ON_UPDATE_STREAM="on_update_stream",t.ON_REMOVE_STREAM="on_remove_stream",t.USER_ANALYTICS="req_user_analytics",t.PC_STATS="pc_stats",t.UPDATE_REMOTE_RTPCAPABILITIES="update_remote_rtpCapabilities",t}({}),He=function(t){return t.SESSION="io.agora.pb.Wrtc.Session",t.JOIN_CHOOSE_SERVER="io.agora.pb.Wrtc.JoinChooseServer",t.REQ_USER_ACCOUNT="io.agora.pb.Wrtc.ReqUserAccount",t.JOIN_GATEWAY="io.agora.pb.Wrtc.JoinGateway",t.RE_JOIN_GATEWAY="io.agora.pb.Wrtc.ReJoinGateway",t.PUBLISH="io.agora.pb.Wrtc.Publish",t.SUBSCRIBE="io.agora.pb.Wrtc.Subscribe",t.WS_COMPRESSOR_INIT="io.agora.pb.Wrtc.WsCompressorInit",t.STREAM_SWITCH="io.agora.pb.Wrtc.StreamSwitch",t.AUDIO_SENDING_STOPPED="io.agora.pb.Wrtc.AudioSendingStopped",t.VIDEO_SENDING_STOPPED="io.agora.pb.Wrtc.VideoSendingStopped",t.REQUEST_PROXY_APPCENTER="io.agora.pb.Wrtc.RequestProxyAppCenter",t.REQUEST_PROXY_WORKER_MANAGER="io.agora.pb.Wrtc.RequestProxyWorkerManager",t.API_INVOKE="io.agora.pb.Wrtc.ApiInvoke",t.FIRST_VIDEO_RECEIVED="io.agora.pb.Wrtc.FirstVideoReceived",t.FIRST_AUDIO_RECEIVED="io.agora.pb.Wrtc.FirstAudioReceived",t.FIRST_VIDEO_DECODE="io.agora.pb.Wrtc.FirstVideoDecode",t.FIRST_AUDIO_DECODE="io.agora.pb.Wrtc.FirstAudioDecode",t.ON_ADD_AUDIO_STREAM="io.agora.pb.Wrtc.OnAddAudioStream",t.ON_ADD_VIDEO_STREAM="io.agora.pb.Wrtc.OnAddVideoStream",t.ON_UPDATE_STREAM="io.agora.pb.Wrtc.OnUpdateStream",t.ON_REMOVE_STREAM="io.agora.pb.Wrtc.OnRemoveStream",t.JOIN_CHANNEL_TIMEOUT="io.agora.pb.Wrtc.JoinChannelTimeout",t.PEER_PUBLISH_STATUS="io.agora.pb.Wrtc.PeerPublishStatus",t.WORKER_EVENT="io.agora.pb.Wrtc.WorkerEvent",t.AP_WORKER_EVENT="io.agora.pb.Wrtc.APWorkerEvent",t.JOIN_WEB_PROXY_AP="io.agora.pb.Wrtc.JoinWebProxyAP",t.WEBSOCKET_QUIT="io.agora.pb.Wrtc.WebSocketQuit",t.USER_ANALYTICS="io.agora.pb.Wrtc.UserAnalytics",t.AUTOPLAY_FAILED="io.agora.pb.Wrtc.AutoplayFailed",t.PC_STATS="io.agora.pb.Wrtc.PCStats",t.UPDATE_REMOTE_RTPCAPABILITIES="io.agora.pb.Wrtc.UpdateRemoteRTPCapabilities",t}({});(function(t){t[t.WORKER_EVENT=156]="WORKER_EVENT",t[t.AP_WORKER_EVENT=160]="AP_WORKER_EVENT"})({}),function(t){t[t.SESSION=26]="SESSION",t[t.JOIN_CHOOSE_SERVER=27]="JOIN_CHOOSE_SERVER",t[t.REQ_USER_ACCOUNT=196]="REQ_USER_ACCOUNT",t[t.JOIN_GATEWAY=28]="JOIN_GATEWAY",t[t.PUBLISH=30]="PUBLISH",t[t.SUBSCRIBE=29]="SUBSCRIBE",t[t.WS_COMPRESSOR_INIT=9430]="WS_COMPRESSOR_INIT",t[t.STREAM_SWITCH=32]="STREAM_SWITCH",t[t.AUDIO_SENDING_STOPPED=33]="AUDIO_SENDING_STOPPED",t[t.VIDEO_SENDING_STOPPED=34]="VIDEO_SENDING_STOPPED",t[t.REQUEST_PROXY_APPCENTER=35]="REQUEST_PROXY_APPCENTER",t[t.REQUEST_PROXY_WORKER_MANAGER=36]="REQUEST_PROXY_WORKER_MANAGER",t[t.API_INVOKE=41]="API_INVOKE",t[t.FIRST_VIDEO_RECEIVED=348]="FIRST_VIDEO_RECEIVED",t[t.FIRST_AUDIO_RECEIVED=349]="FIRST_AUDIO_RECEIVED",t[t.FIRST_VIDEO_DECODE=350]="FIRST_VIDEO_DECODE",t[t.FIRST_AUDIO_DECODE=351]="FIRST_AUDIO_DECODE",t[t.ON_ADD_AUDIO_STREAM=352]="ON_ADD_AUDIO_STREAM",t[t.ON_ADD_VIDEO_STREAM=353]="ON_ADD_VIDEO_STREAM",t[t.ON_UPDATE_STREAM=356]="ON_UPDATE_STREAM",t[t.ON_REMOVE_STREAM=355]="ON_REMOVE_STREAM",t[t.JOIN_CHANNEL_TIMEOUT=407]="JOIN_CHANNEL_TIMEOUT",t[t.PEER_PUBLISH_STATUS=408]="PEER_PUBLISH_STATUS",t[t.WORKER_EVENT=156]="WORKER_EVENT",t[t.AP_WORKER_EVENT=160]="AP_WORKER_EVENT",t[t.JOIN_WEB_PROXY_AP=700]="JOIN_WEB_PROXY_AP",t[t.WEBSOCKET_QUIT=671]="WEBSOCKET_QUIT",t[t.USER_ANALYTICS=1e4]="USER_ANALYTICS",t[t.AUTOPLAY_FAILED=9178]="AUTOPLAY_FAILED"}({});class Qu{constructor(){en(this,"baseInfoMap",new Map),en(this,"proxyServer",void 0),en(this,"eventUploadTimer",void 0),en(this,"setSessionIdTimer",void 0),en(this,"url",void 0),en(this,"backupUrl",void 0),en(this,"_appId",void 0),en(this,"keyEventUploadPendingItems",[]),en(this,"normalEventUploadPendingItems",[]),en(this,"apiInvokeUploadPendingItems",[]),en(this,"apiInvokeCount",0),en(this,"ltsList",[]),en(this,"lastSendNormalEventTime",Date.now()),en(this,"customReportCounterTimer",void 0),en(this,"customReportCount",0),en(this,"extApiInvoke",async e=>{for(const n of e){const i=kt(kt({},n),{},{sid:null,invokeId:++this.apiInvokeCount,tag:Je.TRACER});this.sendApiInvoke(i)}}),this.eventUploadTimer=window.setInterval(this.doSend.bind(this),N("EVENT_REPORT_SEND_INTERVAL")),this.setSessionIdTimer=window.setInterval(this.appendSessionId.bind(this),N("EVENT_REPORT_SEND_INTERVAL"))}getBaseInfoBySessionId(e){return this.baseInfoMap.get(e)}adjustSessionStartTime(e){if(!this.baseInfoMap.has(e)&&!this.baseInfoMap.get(e))return void E.error("adjust session ".concat(e," start time, sid is not exist or info is undefined"));const n=this.baseInfoMap.get(e),i=Date.now(),r=n.startTime;n.startTime=i,E.debug("rewrite session ".concat(e," startTime: ").concat(i," , ").concat(i-r,"ms")),this.baseInfoMap.set(e,n)}setAppId(e){this._appId=e}reportApiInvoke(e,n,i){n.timeout=n.timeout||6e4,n.reportResult=n.reportResult===void 0||n.reportResult;const r=Date.now();this.apiInvokeCount+=1;const o=this.apiInvokeCount,s=()=>({tag:n.tag,invokeId:o,sid:e,name:n.name,apiInvokeTime:r,options:n.options,states:n.states||null}),a=!!N("SHOW_REPORT_INVOKER_LOG");a&&E.info("".concat(n.name," start"),n.options);let c=!1;wn(n.timeout).then(()=>{c||(this.sendApiInvoke(kt(kt({},s()),{},{error:b.API_INVOKE_TIMEOUT,success:!1})),E.debug("".concat(n.name," timeout")))});const d=new G(b.UNEXPECTED_ERROR,"".concat(n.name,": this api invoke is end"));return{onSuccess:u=>{const l=()=>{if(c)throw d;return c=!0,this.sendApiInvoke(kt(kt({},s()),{},{success:!0},n.reportResult&&{result:u})),a&&E.info("".concat(n.name," onSuccess")),u};return i?nb(l,n.name+"Success",i,()=>c=!0):l()},onError:u=>{const l=()=>{if(c)throw u;c=!0,this.sendApiInvoke(kt(kt({},s()),{},{success:!1,error:u})),a&&E.info("".concat(n.name," onFailure"),u.toString())};return i?nb(l,n.name+"Error",i,()=>c=!0):l()}}}sessionInit(e,n){if(this.baseInfoMap.has(e))return;const i=Date.now(),r=this.createBaseInfo(e,i);r.cname=n.cname;const o=Object.assign({},{willUploadConsoleLog:N("UPLOAD_LOG"),maxTouchPoints:navigator.maxTouchPoints,areaVersion:Zm?"global":"oversea",areas:N("AREAS")&&N("AREAS").join(",")},n.extend),{stringUid:s,channelProfile:a,channelMode:c,isABTestSuccess:d,lsid:u,clientRole:l}=n,p=Date.now(),f=kt(kt({},r),{},{eventType:Mn.SESSION_INIT,appid:n.appid,browser:navigator.userAgent,buildFormat:n.buildFormat,build:tg,lts:p,elapse:p-i,extend:JSON.stringify(o),mode:n.mode,process:N("PROCESS_ID"),appType:N("APP_TYPE"),success:!0,version:pr,stringUid:s,channelProfile:a,channelMode:c,isABTestSuccess:d,lsid:u,clientType:20,clientRole:l,serviceId:N("PROCESS_ID"),extensionID:N("PLUGIN_INFO").join(",")||"",preload:n.preload?1:0});this.send({type:He.SESSION,data:f},!0)}joinChooseServer(e,n){const i=this.baseInfoMap.get(e);if(!i)return;const r=i.info,o=Date.now(),s=kt(kt({},r),{},{eventType:Mn.JOIN_CHOOSE_SERVER,lts:o,eventElapse:n.elapse||o-n.lts,chooseServerAddr:n.csAddr,errorCode:n.ec,elapse:o-i.startTime,success:n.succ,chooseServerAddrList:JSON.stringify(n.serverList),uid:n.uid?parseInt(n.uid):null,cid:n.cid?parseInt(n.cid):null,chooseServerIp:n.csIp||"",opid:n.opid,unilbsServerIds:n.unilbsServerIds,extend:n.extend||void 0,isHttp3:n.isHttp3});this.send({type:He.JOIN_CHOOSE_SERVER,data:s},!0)}reqUserAccount(e,n){const i=this.baseInfoMap.get(e);if(!i)return;const r=i.info,o=Date.now(),s=kt(kt({},r),{},{eventType:Mn.REQ_USER_ACCOUNT,lts:o,success:n.success,serverAddress:n.serverAddr,stringUid:n.stringUid,uid:n.uid,errorCode:n.errorCode,elapse:n.elapse||o-i.startTime,eventElapse:o-n.lts,extend:JSON.stringify(n.extend)});this.send({type:He.REQ_USER_ACCOUNT,data:s},!0)}joinGateway(e,n){const i=this.baseInfoMap.get(e);if(!i)return;const r=i.info;n.vid&&(r.vid=n.vid),r.uid=n.uid,r.cid=n.cid;const o=Date.now(),{firstSuccess:s,avoidJoinStartTime:a,isProxy:c,addr:d}=n,u=o-(s&&a?a:i.startTime),l=kt(kt({},r),{},{eventType:Mn.JOIN_GATEWAY,lts:o,gatewayAddr:n.addr,success:n.succ,errorCode:n.ec,elapse:u,eventElapse:o-n.lts,firstSuccess:s,signalChannel:n.signalChannel}),p=l.success?1:0;if(n.succ&&(i.lastJoinSuccessTime=o),s)this.send({type:He.JOIN_GATEWAY,data:l},!0);else{let f;if(d)if(c){const m=d.match(/h=(\d{1,3}-){3}\d{1,3}/g),g=d.match(/p=[0-9]{1,6}/g);f={isSuccess:p,gatewayIp:m&&m.length?m[0].split("=")[1].replace(/-/g,"."):"",port:g&&g.length?g[0].split("=")[1]:"",isProxy:c?1:0}}else{const m=d.match(/wss:\/\/(\d{1,3}-){3}\d{1,3}/g),g=d.match(/(:|p=)[0-9]{1,6}/g);f={isSuccess:p,gatewayIp:m&&m.length?m[0].split("//")[1].replace(/-/g,"."):"",port:g&&g.length?g[0].split(/:|p=/g)[1]:"",isProxy:c?1:0}}else f={isSuccess:p,gatewayIp:"",port:"",isProxy:c?1:0};delete l.success,delete l.eventType,delete l.firstSuccess,l.vid=Number(l.vid);const C=Object.assign({},l,f,{eventType:Mn.REJOIN_GATEWAY});this.send({type:He.RE_JOIN_GATEWAY,data:C},!0)}}joinChannelTimeout(e,n){const i=this.baseInfoMap.get(e);if(!i)return;const r=Date.now(),o=kt(kt({},i.info),{},{lts:r,timeout:n,elapse:r-i.startTime});this.send({type:He.JOIN_CHANNEL_TIMEOUT,data:o},!0)}publish(e,n){const i=this.baseInfoMap.get(e);if(!i)return;const r=i.info,o=Date.now(),s=kt(kt({},r),{},{eventType:Mn.PUBLISH,lts:o,eventElapse:n.eventElapse,elapse:o-i.startTime,success:n.succ,errorCode:n.ec,videoName:n.videoName,audioName:n.audioName,screenName:n.screenName,screenshare:n.screenshare,audio:n.audio,video:n.video,p2pid:n.p2pid,publishRequestid:n.publishRequestid});this.send({type:He.PUBLISH,data:s},!0)}subscribe(e,n,i){const r=this.baseInfoMap.get(e);if(!r)return;const o=r.info,s=Date.now(),a=kt(kt({},o),{},{eventType:Mn.SUBSCRIBE,lts:s,eventElapse:n.eventElapse,elapse:s-r.startTime,success:n.succ,errorCode:n.ec,video:n.video,audio:n.audio,subscribeRequestid:n.subscribeRequestid,p2pid:n.p2pid},i&&{extend:JSON.stringify({isMassSubscribe:!0})});typeof n.peerid=="string"?a.peerSuid=n.peerid:a.peer=n.peerid,this.send({type:He.SUBSCRIBE,data:a},!0)}wsCompressorInit(e){var n;const i=[...Xi(n=this.baseInfoMap).call(n)],r=i.length?i[0]:"UnableToGetSid",o=this.baseInfoMap.get(r);if(!o)return;const s=o.info,a=Date.now(),c=kt(kt({},s),{},{eventType:Mn.WS_COMPRESSOR_INIT,lts:a,eventElapse:e.eventElapse,elapse:a-o.startTime,status:e.status?1:2});this.send({type:He.WS_COMPRESSOR_INIT,data:c},!0)}firstRemoteVideoDecode(e,n,i,r){const o=this.baseInfoMap.get(e);if(!o)return;const s=o.info,a=Date.now(),c=kt(kt(kt({},s),r),{},{elapse:a-o.startTime,eventType:n,lts:a,firstDecodeFrame:Math.max(a-o.startTime,0),apEnd:Math.max(r.apEnd-o.startTime,0),apStart:Math.max(r.apStart-o.startTime,0),joinGwEnd:Math.max(r.joinGwEnd-o.startTime,0),joinGwStart:Math.max(r.joinGwStart-o.startTime,0),pcEnd:Math.max(r.pcEnd-o.startTime,0),pcStart:Math.max(r.pcStart-o.startTime,0),subscriberEnd:Math.max(r.subscriberEnd-o.startTime,0),subscriberStart:Math.max(r.subscriberStart-o.startTime,0),videoAddNotify:Math.max(r.videoAddNotify-o.startTime,0)});this.send({type:i,data:c},!0)}firstRemoteFrame(e,n,i,r){const o=this.baseInfoMap.get(e);if(!o)return;const s=o.info,a=Date.now(),c=kt(kt(kt({},s),r),{},{elapse:a-o.startTime,eventType:n,lts:a});this.send({type:i,data:c},!0)}pcStats(e,n){const i=this.baseInfoMap.get(e);if(!i)return;const r=i.info,o=Date.now(),s=kt(kt(kt({},r),n),{},{vid:r.vid===void 0?0:Number(r.vid),elapse:o-i.startTime,eventType:Mn.PC_STATS,lts:o});this.send({type:He.PC_STATS,data:s},!0)}updateRemoteRTPCapabilities(e,n){if(e){const i=this.baseInfoMap.get(e);if(!i)return;const r=i.info,o=Date.now(),s=kt(kt(kt({},r),n),{},{vid:r.vid===void 0?0:Number(r.vid),eventType:Mn.UPDATE_REMOTE_RTPCAPABILITIES,lts:o});this.send({type:He.UPDATE_REMOTE_RTPCAPABILITIES,data:s},!0)}}onGatewayStream(e,n,i,r){const o=this.baseInfoMap.get(e);if(!o)return;const s=o.info,a=Date.now(),c=kt(kt(kt({},s),r),{},{eventType:n,lts:a});this.send({type:i,data:c},!0)}streamSwitch(e,n){const i=this.baseInfoMap.get(e);if(!i)return;const r=i.info,o=Date.now(),s=kt(kt({},r),{},{eventType:Mn.STREAM_SWITCH,lts:o,isDual:n.isdual,elapse:o-i.startTime,success:n.succ});this.send({type:He.STREAM_SWITCH,data:s},!0)}requestProxyAppCenter(e,n){const i=this.baseInfoMap.get(e);if(!i)return;const r=i.info,o=Date.now(),s=kt(kt({},r),{},{eventType:Mn.REQUEST_PROXY_APPCENTER,lts:o,eventElapse:o-n.lts,elapse:o-i.startTime,APAddr:n.APAddr,workerManagerList:n.workerManagerList,response:n.response,errorCode:n.ec,success:n.succ});this.send({type:He.REQUEST_PROXY_APPCENTER,data:s},!0)}requestProxyWorkerManager(e,n){const i=this.baseInfoMap.get(e);if(!i)return;const r=i.info,o=Date.now(),s=kt(kt({},r),{},{eventType:Mn.REQUEST_PROXY_WORKER_MANAGER,lts:o,eventElapse:o-n.lts,elapse:o-i.startTime,workerManagerAddr:n.workerManagerAddr,response:n.response,errorCode:n.ec,success:n.succ});this.send({type:He.REQUEST_PROXY_WORKER_MANAGER,data:s},!0)}setProxyServer(e){this.proxyServer=e,e?E.debug("reportProxyServerurl: ".concat(e)):E.debug("disable reportProxyServerurl: ".concat(e))}peerPublishStatus(e,n){const i=this.baseInfoMap.get(e);if(!i)return;const r=i.info,o=Date.now(),s=kt(kt({},r),{},{subscribeElapse:n.subscribeElapse,peer:n.peer,peerPublishDuration:Math.max(n.audioPublishDuration,n.videoPublishDuration),audiotag:n.audioPublishDuration>0?1:-1,videotag:n.videoPublishDuration>0?1:-1,lts:o,elapse:o-i.startTime,joinChannelSuccessElapse:o-(i.lastJoinSuccessTime||o),peerPublishDurationVideo:n.videoPublishDuration,peerPublishDurationAudio:n.audioPublishDuration});this.send({type:He.PEER_PUBLISH_STATUS,data:s},!0)}workerEvent(e,n){const i=this.baseInfoMap.get(e);if(!i)return;const r=i.info,o=Date.now();(function(s,a,c){const d=s[a];if(!d||typeof d!="string")return[s];s[a]="";const u=Uo(JSON.stringify(s));let l=0;const p=[];let f=0;for(let C=0;C<d.length;C++)f+=d.charCodeAt(C)<=127?1:3,f<=c-u||(p[p.length]=mt(mt({},s),{},{[a]:d.substring(l,C)}),l=C,f=d.charCodeAt(C)<=127?1:3);return l!==d.length-1&&(p[p.length]=mt(mt({},s),{},{[a]:d.substring(l)})),p})(kt(kt(kt({},r),n),{},{elapse:o-i.startTime,lts:o,productType:"WebRTC"}),"payload",1300).forEach(s=>this.send({type:He.WORKER_EVENT,data:s},!0))}apworkerEvent(e,n){const i=this.baseInfoMap.get(e);if(!i)return;const r=i.info,o=Date.now(),s=kt(kt(kt({},r),n),{},{elapse:o-i.startTime,lts:o});this.send({type:He.AP_WORKER_EVENT,data:s},!0)}joinWebProxyAP(e,n){const i=this.baseInfoMap.get(e);if(!i)return;const r=i.info,o=Date.now(),s=kt(kt(kt({},r),n),{},{elapse:o-i.startTime,lts:o,extend:n.extend||void 0});this.send({type:He.JOIN_WEB_PROXY_AP,data:s},!0)}WebSocketQuit(e,n){const i=this.baseInfoMap.get(e);if(!i)return;const r=i.info,o=Date.now(),s=kt(kt(kt({},r),n),{},{elapse:o-i.startTime,lts:o});this.send({type:He.WEBSOCKET_QUIT,data:s},!0)}async sendCustomReportMessage(e,n){if(this.customReportCount+=n.length,this.customReportCount>N("CUSTOM_REPORT_LIMIT"))throw new G(b.CUSTOM_REPORT_FREQUENCY_TOO_HIGH);this.customReportCounterTimer||(this.customReportCounterTimer=window.setInterval(()=>{this.customReportCount=0},5e3));const i=Date.now(),r=n.map(o=>({type:He.USER_ANALYTICS,data:kt(kt({sid:e},o),{},{lts:i})}));try{N("NEW_REPORT_SERVER")?await this.postDataToStatsCollector2(r):await this.postDataToStatsCollector(r)}catch(o){throw E.error("send custom report message failed",o.toString()),new G(b.CUSTOM_REPORT_SEND_FAILED,o.message)}}sendApiInvoke(e){const n=N("NOT_REPORT_EVENT");if(e.tag&&it(n)&&it(n).call(n,e.tag))return!1;if(e.sid===null)return this.apiInvokeUploadPendingItems.push(e),!1;const i=this.baseInfoMap.get(e.sid);if(!i)return this.apiInvokeUploadPendingItems.push(e),!1;const{cname:r,uid:o,cid:s}=i.info;let a;if(e.lts=e.lts||Date.now(),e.error)if(e.error instanceof G){const{code:d,message:u}=e.error;a=d||u||e.error.toString()}else a=e.error.toString();const c={invokeId:e.invokeId,sid:e.sid,cname:r,cid:s,uid:o,lts:e.lts,success:e.success,elapse:e.lts-i.startTime,execElapse:e.lts-e.apiInvokeTime,apiName:e.name,options:e.options?JSON.stringify(e.options):void 0,execStates:e.states?JSON.stringify(e.states):void 0,execResult:e.result?JSON.stringify(e.result):void 0,errorCode:e.error?a:void 0,errorMsg:e.error?JSON.stringify(e.error):void 0};return this.send({type:He.API_INVOKE,data:c},!1),!0}appendSessionId(){Qu.__CLIENT_LIST__.forEach(e=>{if(e._sessionId){const n=this.apiInvokeUploadPendingItems.length;for(let i=0;i<n;i++){const r=this.apiInvokeUploadPendingItems.shift();r&&(r.sid=e._sessionId,this.sendApiInvoke(Object.assign({},r)))}}})}send(e,n){if(n)return this.keyEventUploadPendingItems.push(e),void this.sendItems(this.keyEventUploadPendingItems,!0);this.normalEventUploadPendingItems.push(e),this.normalEventUploadPendingItems.length>N("NORMAL_EVENT_QUEUE_CAPACITY")&&this.normalEventUploadPendingItems.splice(0,1),this.normalEventUploadPendingItems.length>=10&&this.sendItems(this.normalEventUploadPendingItems,!1)}doSend(){this.keyEventUploadPendingItems.length>0&&this.sendItems(this.keyEventUploadPendingItems,!0),this.normalEventUploadPendingItems.length>0&&Date.now()-this.lastSendNormalEventTime>=5e3&&this.sendItems(this.normalEventUploadPendingItems,!1)}sendItems(e,n){const i=[],r=[];for(;e.length;){const s=e.shift();i.length<20?i.push(s):r.push(s)}e.push(...r);for(const s of[...i]){var o;this.ltsList.indexOf(s.data.lts)!==-1?(s.data.lts=this.ltsList[this.ltsList.length-1]+1,this.ltsList.push(s.data.lts)):(this.ltsList.push(s.data.lts),Du(o=this.ltsList).call(o,(a,c)=>a-c))}return n||(this.lastSendNormalEventTime=Date.now()),N("ENABLE_EVENT_REPORT")&&i.length&&(N("NEW_REPORT_SERVER")?this.postDataToStatsCollector2(i):this.postDataToStatsCollector(i)).catch((s=>a=>{N("EVENT_REPORT_RETRY")&&(n?this.keyEventUploadPendingItems=this.keyEventUploadPendingItems.concat(s):(this.normalEventUploadPendingItems=this.normalEventUploadPendingItems.concat(s),this.normalEventUploadPendingItems.length>N("NORMAL_EVENT_QUEUE_CAPACITY")&&(this.normalEventUploadPendingItems.splice(0,this.normalEventUploadPendingItems.length-N("NORMAL_EVENT_QUEUE_CAPACITY")),E.warning("report: drop normal events"))))})(i)),e}async postDataToStatsCollector2(e){Xe.networkState===_i.OFFLINE&&await ot.race([Xe.onlineWaiter,wn(2*dn.maxRetryTimeout)]);const n=o=>{let s=new Uint8Array;return o.forEach(a=>{const c=Km(JSON.stringify(a.data)),d=new ArrayBuffer(5),u=(p=>{let f=0;return Object.entries(He).forEach(C=>{let[m,g]=C;g===p.type&&(f=EventNameToID[m])}),f})(a),l=new DataView(d);l.setUint16(0,c.byteLength,!0),l.setUint8(2,255&u),l.setUint8(3,u>>>8&255),l.setUint8(4,u>>>16&255),s=qI(s,new Uint8Array(d)),s=qI(s,c)}),s},i="event";let r=this.proxyServer?"https://".concat(this.proxyServer,"/rs/?h=").concat(N("NEW_REPORT_SERVER_DOMAINS")[0],"&p=443&d=").concat(i):"https://".concat(N("NEW_REPORT_SERVER_DOMAINS")[0],"/").concat(i);for(let o=0;o<2;o+=1){o===1&&(r=this.proxyServer?"https://".concat(this.proxyServer,"/rs/?h=").concat(N("NEW_REPORT_SERVER_DOMAINS")[1],"&p=443&d=").concat(i):"https://".concat(N("NEW_REPORT_SERVER_DOMAINS")[1],"/").concat(i));try{await Qm(r,{timeout:1e4,data:n(e),headers:kt(kt({biz:"webrtc",sendts:Math.round(Date.now()/1e3),debug:"false"},this._appId&&{appid:this._appId}),{},{"Content-Type":"application/octet-stream"})},!0)}catch(s){if(o===1)throw s;continue}return}}async postDataToStatsCollector(e){let n=arguments.length>1&&arguments[1]!==void 0&&arguments[1];const i={msgType:"EventMessages",sentTs:Math.round(Date.now()/1e3),payloads:e.map(s=>JSON.stringify(s)),vid:(s=>{const a=s&&s.data.sid&&this.baseInfoMap.get(s.data.sid);return a&&a.info.vid&&+a.info.vid||0})(e[0])};Xe.networkState===_i.OFFLINE&&await ot.race([Xe.onlineWaiter,wn(2*dn.maxRetryTimeout)]);const r=n?"/events/proto-raws":"/events/messages";let o=this.url||(this.proxyServer?"https://".concat(this.proxyServer,"/rs/?h=").concat(N("EVENT_REPORT_DOMAIN"),"&p=").concat(N("STATS_COLLECTOR_PORT"),"&d=").concat(r):"https://".concat(N("EVENT_REPORT_DOMAIN"),":").concat(N("STATS_COLLECTOR_PORT")).concat(r));for(let s=0;s<2;s+=1){s===1&&(o=this.backupUrl||(this.proxyServer?"https://".concat(this.proxyServer,"/rs/?h=").concat(N("EVENT_REPORT_BACKUP_DOMAIN"),"&p=").concat(N("STATS_COLLECTOR_PORT"),"&d=").concat(r):"https://".concat(N("EVENT_REPORT_BACKUP_DOMAIN"),":").concat(N("STATS_COLLECTOR_PORT")).concat(r)));try{n?await GF(o,{timeout:1e4,data:i}):await Qm(o,{timeout:1e4,data:i})}catch(a){if(s===1)throw a;continue}return}}createBaseInfo(e,n){const i=Object.assign({},zF);return i.sid=e,this.baseInfoMap.set(e,{info:i,startTime:n}),i}reportResourceTiming(e,n){const i=performance.getEntriesByName(e),r=i[i.length-1];r&&this.reportApiInvoke(n,{name:"Client.resourceTiming",options:r,tag:Je.TRACER}).onSuccess()}}function Ct(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return function(e,n,i){const r=i.value;if(typeof r=="function"){const o=t.className||e.__className__||(e.constructor.name==="AgoraRTCClient"?"Client":e.constructor.name);i.value=function(){for(var s=arguments.length,a=new Array(s),c=0;c<s;c++)a[c]=arguments[c];let d=a;if(t.argsMap)try{d=t.argsMap(this,...a)}catch(l){E.warning(l),d=[]}try{JSON.stringify(d)}catch{E.warning("arguments for method ".concat(o,".").concat(String(n)," not serializable for apiInvoke.")),d=[]}const u=(t.report||Et).reportApiInvoke(this._sessionId||null,{name:"".concat(o,".").concat(String(n)),options:d,tag:Je.TRACER,reportResult:t.reportResult},t.throttleTime);try{const l=r.apply(this,a);return l instanceof ot?l.then(p=>(u.onSuccess(t.reportResult&&p),p)).catch(p=>{throw u.onError(p),p}):(u.onSuccess(t.reportResult&&l),l)}catch(l){throw u.onError(l),l}}}return i}}en(Qu,"__CLIENT_LIST__",[]);const Et=new Qu;ub.on("REPORT_LOG_UPLOAD",t=>{t.networkState=Xe.networkState,Et.reportApiInvoke(null,{name:"logUploadError",options:t,tag:Je.TRACER}).onSuccess("logUploadError")});const JF=["CHINA","GLOBAL"],qn=function(){const t="us".concat("erna","me"),e="pa".concat("sswo","rd"),n=["t","s","t"];n.splice(1,0,"e");const i=n.join(""),r=[];for(let a=0;a<6;a++)r.push("1");const o=r.join(""),s={};return s[t]=i,s[e]=o,Object.assign(s,{turnServerURL:"",tcpport:3433,udpport:3478,forceturn:!1})}();window.DEFAULT_TURN_CONFIG=qn,Zm||(Rn.WEBCS_DOMAIN=["ap-web-1-oversea.agora.io","ap-web-1-north-america.agora.io"],Rn.WEBCS_DOMAIN_BACKUP_LIST=["ap-web-2-oversea.agora.io","ap-web-2-north-america.agora.io"],Rn.PROXY_CS=["proxy-ap-web-oversea.agora.io","proxy-ap-web-america.agora.io"],Rn.CDS_AP=["cds-ap-web-oversea.agora.io","cds-ap-web-america.agora.io","cds-ap-web-america2.agora.io"],Rn.ACCOUNT_REGISTER=["sua-ap-web-oversea.agora.io","sua-ap-web-america.agora.io","sua-ap-web-america2.agora.io"],Rn.UAP_AP=["uap-ap-web-oversea.agora.io","uap-ap-web-america.agora.io","uap-ap-web-america2.agora.io"],Rn.LOG_UPLOAD_SERVER="logservice-oversea.agora.io",Rn.EVENT_REPORT_DOMAIN="statscollector-1-oversea.agora.io",Rn.EVENT_REPORT_BACKUP_DOMAIN="statscollector-2-oversea.agora.io",Rn.PROXY_SERVER_TYPE3="webrtc-cloud-proxy.agora.io",Rn.AREAS=["NORTH_AMERICA","OVERSEA"]);const pb=[[0,1,2,3,4,5,5],[0,2,2,3,4,5,5],[0,3,3,3,4,5,5],[0,4,4,4,4,5,5],[0,5,5,5,5,5,5]],Ys=[];function ja(t,e){return!!e&&Ys.some(n=>n.uid===t&&n.channelName===e)}Qu.__CLIENT_LIST__=Ys;var XF=Gv.forEach,fb=Oh("forEach")?[].forEach:function(t){return XF(this,t,arguments.length>1?arguments[1]:void 0)};$t({target:"Array",proto:!0,forced:[].forEach!=fb},{forEach:fb});var QF=oi("Array").forEach,ZF=Or,$F=Dn,tj=Jn,ej=QF,ng=Array.prototype,nj={DOMTokenList:!0,NodeList:!0},ij=function(t){var e=t.forEach;return t===ng||tj(ng,t)&&e===ng.forEach||$F(nj,ZF(t))?ej:e},rj=Dt(ij),oj=br,_b=kh;$t({target:"Object",stat:!0,forced:Pt(function(){_b(1)})},{keys:function(t){return _b(oj(t))}});var Eb=Dt(Bn.Object.keys),sj=Dt(dS),aj=$t,cj=ku,dj=Ge([].reverse),mb=[1,2];aj({target:"Array",proto:!0,forced:String(mb)===String(mb.reverse())},{reverse:function(){return cj(this)&&(this.length=this.length),dj(this)}});var uj=oi("Array").reverse,lj=Jn,hj=uj,ig=Array.prototype,pj=function(t){var e=t.reverse;return t===ig||lj(ig,t)&&e===ig.reverse?hj:e},gb=pj,fj=Dt(gb),_j=$t,Tb=ku,Ej=qh,mj=Oi,Sb=zi,gj=ri,Tj=li,Sj=op,Rj=Ze,Cj=oE,vj=Pv("slice"),yj=Rj("species"),rg=Array,Ij=Math.max;_j({target:"Array",proto:!0,forced:!vj},{slice:function(t,e){var n,i,r,o=Tj(this),s=gj(o),a=Sb(t,s),c=Sb(e===void 0?s:e,s);if(Tb(o)&&(n=o.constructor,(Ej(n)&&(n===rg||Tb(n.prototype))||mj(n)&&(n=n[yj])===null)&&(n=void 0),n===rg||n===void 0))return Cj(o,a,c);for(i=new(n===void 0?rg:n)(Ij(c-a,0)),r=0;a<c;a++,r++)a in o&&Sj(i,r,o[a]);return i.length=r,i}});var bj=oi("Array").slice,Aj=Jn,wj=bj,og=Array.prototype,Oj=function(t){var e=t.slice;return t===og||Aj(og,t)&&e===og.slice?wj:e},Nj=Dt(Oj);function nt(t,e,n,i,r){var o,s,a,c={};return rj(o=Eb(i)).call(o,function(d){c[d]=i[d]}),c.enumerable=!!c.enumerable,c.configurable=!!c.configurable,("value"in c||c.initializer)&&(c.writable=!0),c=sj(s=fj(a=Nj(n).call(n)).call(a)).call(s,function(d,u){return u(t,e,d)||d},c),r&&c.initializer!==void 0&&(c.value=c.initializer?c.initializer.call(r):void 0,c.initializer=void 0),c.initializer===void 0&&(wv(t,e,c),c=null),c}var Dj=oi("Array").values,Pj=Or,Lj=Dn,kj=Jn,Mj=Dj,sg=Array.prototype,Uj={DOMTokenList:!0,NodeList:!0},xj=function(t){var e=t.values;return t===sg||kj(sg,t)&&e===sg.values||Lj(Uj,Pj(t))?Mj:e},ao=Dt(xj);let Vj=function(t){return t.L1T1="L1T1",t.L1T2="L1T2",t.L1T3="L1T3",t.L2T1_KEY="L2T1_KEY",t.L2T2_KEY="L2T2_KEY",t.L2T3_KEY="L2T3_KEY",t.L3T1_KEY="L3T1_KEY",t.L3T2_KEY="L3T2_KEY",t.L3T3_KEY="L3T3_KEY",t}({}),Zi=function(t){return t.CERTIFICATE="certificate",t.CODEC="codec",t.CANDIDATE_PAIR="candidate-pair",t.LOCAL_CANDIDATE="local-candidate",t.REMOTE_CANDIDATE="remote-candidate",t.INBOUND="inbound-rtp",t.TRACK="track",t.OUTBOUND="outbound-rtp",t.PC="peer-connection",t.REMOTE_INBOUND="remote-inbound-rtp",t.REMOTE_OUTBOUND="remote-outbound-rtp",t.TRANSPORT="transport",t.CSRC="csrc",t.DATA_CHANNEL="data-channel",t.STREAM="stream",t.SENDER="sender",t.RECEIVER="receiver",t}({}),Bp=function(t){return t[t.ACCESS_POINT=101]="ACCESS_POINT",t[t.UNILBS=201]="UNILBS",t[t.STRING_UID_ALLOCATOR=901]="STRING_UID_ALLOCATOR",t}({}),ag=function(t){return t[t.IIIEGAL_APPID=1]="IIIEGAL_APPID",t[t.IIIEGAL_UID=2]="IIIEGAL_UID",t[t.INTERNAL_ERROR=3]="INTERNAL_ERROR",t}({}),kr=function(t){return t[t.INVALID_VENDOR_KEY=5]="INVALID_VENDOR_KEY",t[t.INVALID_CHANNEL_NAME=7]="INVALID_CHANNEL_NAME",t[t.INTERNAL_ERROR=8]="INTERNAL_ERROR",t[t.NO_AUTHORIZED=9]="NO_AUTHORIZED",t[t.DYNAMIC_KEY_TIMEOUT=10]="DYNAMIC_KEY_TIMEOUT",t[t.NO_ACTIVE_STATUS=11]="NO_ACTIVE_STATUS",t[t.DYNAMIC_KEY_EXPIRED=13]="DYNAMIC_KEY_EXPIRED",t[t.STATIC_USE_DYNAMIC_KEY=14]="STATIC_USE_DYNAMIC_KEY",t[t.DYNAMIC_USE_STATIC_KEY=15]="DYNAMIC_USE_STATIC_KEY",t[t.USER_OVERLOAD=16]="USER_OVERLOAD",t[t.FORBIDDEN_REGION=18]="FORBIDDEN_REGION",t[t.CANNOT_MEET_AREA_DEMAND=19]="CANNOT_MEET_AREA_DEMAND",t}({}),Ei=function(t){return t[t.NO_FLAG_SET=100]="NO_FLAG_SET",t[t.FLAG_SET_BUT_EMPTY=101]="FLAG_SET_BUT_EMPTY",t[t.INVALID_FALG_SET=102]="INVALID_FALG_SET",t[t.FLAG_SET_BUT_NO_RE=103]="FLAG_SET_BUT_NO_RE",t[t.INVALID_SERVICE_ID=104]="INVALID_SERVICE_ID",t[t.NO_SERVICE_AVAILABLE=200]="NO_SERVICE_AVAILABLE",t[t.NO_SERVICE_AVAILABLE_P2P=201]="NO_SERVICE_AVAILABLE_P2P",t[t.NO_SERVICE_AVAILABLE_VOICE=202]="NO_SERVICE_AVAILABLE_VOICE",t[t.NO_SERVICE_AVAILABLE_WEBRTC=203]="NO_SERVICE_AVAILABLE_WEBRTC",t[t.NO_SERVICE_AVAILABLE_CDS=204]="NO_SERVICE_AVAILABLE_CDS",t[t.NO_SERVICE_AVAILABLE_CDN=205]="NO_SERVICE_AVAILABLE_CDN",t[t.NO_SERVICE_AVAILABLE_TDS=206]="NO_SERVICE_AVAILABLE_TDS",t[t.NO_SERVICE_AVAILABLE_REPORT=207]="NO_SERVICE_AVAILABLE_REPORT",t[t.NO_SERVICE_AVAILABLE_APP_CENTER=208]="NO_SERVICE_AVAILABLE_APP_CENTER",t[t.NO_SERVICE_AVAILABLE_ENV0=209]="NO_SERVICE_AVAILABLE_ENV0",t[t.NO_SERVICE_AVAILABLE_VOET=210]="NO_SERVICE_AVAILABLE_VOET",t[t.NO_SERVICE_AVAILABLE_STRING_UID=211]="NO_SERVICE_AVAILABLE_STRING_UID",t[t.NO_SERVICE_AVAILABLE_WEBRTC_UNILBS=212]="NO_SERVICE_AVAILABLE_WEBRTC_UNILBS",t[t.NO_SERVICE_AVAILABLE_UNILBS_FLV=213]="NO_SERVICE_AVAILABLE_UNILBS_FLV",t}({}),Rt=function(t){return t[t.K_TIMESTAMP_EXPIRED=2]="K_TIMESTAMP_EXPIRED",t[t.K_CHANNEL_PERMISSION_INVALID=3]="K_CHANNEL_PERMISSION_INVALID",t[t.K_CERTIFICATE_INVALID=4]="K_CERTIFICATE_INVALID",t[t.K_CHANNEL_NAME_EMPTY=5]="K_CHANNEL_NAME_EMPTY",t[t.K_CHANNEL_NOT_FOUND=6]="K_CHANNEL_NOT_FOUND",t[t.K_TICKET_INVALID=7]="K_TICKET_INVALID",t[t.K_CHANNEL_CONFLICTED=8]="K_CHANNEL_CONFLICTED",t[t.K_SERVICE_NOT_READY=9]="K_SERVICE_NOT_READY",t[t.K_SERVICE_TOO_HEAVY=10]="K_SERVICE_TOO_HEAVY",t[t.K_UID_BANNED=14]="K_UID_BANNED",t[t.K_IP_BANNED=15]="K_IP_BANNED",t[t.K_CHANNEL_BANNED=16]="K_CHANNEL_BANNED",t[t.K_AUTO_REBALANCE=28]="K_AUTO_REBALANCE",t[t.WARN_NO_AVAILABLE_CHANNEL=103]="WARN_NO_AVAILABLE_CHANNEL",t[t.WARN_LOOKUP_CHANNEL_TIMEOUT=104]="WARN_LOOKUP_CHANNEL_TIMEOUT",t[t.WARN_LOOKUP_CHANNEL_REJECTED=105]="WARN_LOOKUP_CHANNEL_REJECTED",t[t.WARN_OPEN_CHANNEL_TIMEOUT=106]="WARN_OPEN_CHANNEL_TIMEOUT",t[t.WARN_OPEN_CHANNEL_REJECTED=107]="WARN_OPEN_CHANNEL_REJECTED",t[t.WARN_REQUEST_DEFERRED=108]="WARN_REQUEST_DEFERRED",t[t.ERR_DYNAMIC_KEY_TIMEOUT=109]="ERR_DYNAMIC_KEY_TIMEOUT",t[t.ERR_NO_AUTHORIZED=110]="ERR_NO_AUTHORIZED",t[t.ERR_VOM_SERVICE_UNAVAILABLE=111]="ERR_VOM_SERVICE_UNAVAILABLE",t[t.ERR_NO_CHANNEL_AVAILABLE_CODE=112]="ERR_NO_CHANNEL_AVAILABLE_CODE",t[t.ERR_MASTER_VOCS_UNAVAILABLE=114]="ERR_MASTER_VOCS_UNAVAILABLE",t[t.ERR_INTERNAL_ERROR=115]="ERR_INTERNAL_ERROR",t[t.ERR_NO_ACTIVE_STATUS=116]="ERR_NO_ACTIVE_STATUS",t[t.ERR_INVALID_UID=117]="ERR_INVALID_UID",t[t.ERR_DYNAMIC_KEY_EXPIRED=118]="ERR_DYNAMIC_KEY_EXPIRED",t[t.ERR_STATIC_USE_DYANMIC_KE=119]="ERR_STATIC_USE_DYANMIC_KE",t[t.ERR_DYNAMIC_USE_STATIC_KE=120]="ERR_DYNAMIC_USE_STATIC_KE",t[t.ERR_NO_VOCS_AVAILABLE=2e3]="ERR_NO_VOCS_AVAILABLE",t[t.ERR_NO_VOS_AVAILABLE=2001]="ERR_NO_VOS_AVAILABLE",t[t.ERR_JOIN_CHANNEL_TIMEOUT=2002]="ERR_JOIN_CHANNEL_TIMEOUT",t[t.ERR_REPEAT_JOIN_CHANNEL=2003]="ERR_REPEAT_JOIN_CHANNEL",t[t.ERR_JOIN_BY_MULTI_IP=2004]="ERR_JOIN_BY_MULTI_IP",t[t.ERR_NOT_JOINED=2011]="ERR_NOT_JOINED",t[t.ERR_REPEAT_JOIN_REQUEST=2012]="ERR_REPEAT_JOIN_REQUEST",t[t.ERR_INVALID_VENDOR_KEY=2013]="ERR_INVALID_VENDOR_KEY",t[t.ERR_INVALID_CHANNEL_NAME=2014]="ERR_INVALID_CHANNEL_NAME",t[t.ERR_INVALID_STRINGUID=2015]="ERR_INVALID_STRINGUID",t[t.ERR_TOO_MANY_USERS=2016]="ERR_TOO_MANY_USERS",t[t.ERR_SET_CLIENT_ROLE_TIMEOUT=2017]="ERR_SET_CLIENT_ROLE_TIMEOUT",t[t.ERR_SET_CLIENT_ROLE_NO_PERMISSION=2018]="ERR_SET_CLIENT_ROLE_NO_PERMISSION",t[t.ERR_SET_CLIENT_ROLE_ALREADY_IN_USE=2019]="ERR_SET_CLIENT_ROLE_ALREADY_IN_USE",t[t.ERR_PUBLISH_REQUEST_INVALID=2020]="ERR_PUBLISH_REQUEST_INVALID",t[t.ERR_SUBSCRIBE_REQUEST_INVALID=2021]="ERR_SUBSCRIBE_REQUEST_INVALID",t[t.ERR_NOT_SUPPORTED_MESSAGE=2022]="ERR_NOT_SUPPORTED_MESSAGE",t[t.ERR_ILLEAGAL_PLUGIN=2023]="ERR_ILLEAGAL_PLUGIN",t[t.ERR_REJOIN_TOKEN_INVALID=2024]="ERR_REJOIN_TOKEN_INVALID",t[t.ERR_REJOIN_USER_NOT_JOINED=2025]="ERR_REJOIN_USER_NOT_JOINED",t[t.ERR_INVALID_OPTIONAL_INFO=2027]="ERR_INVALID_OPTIONAL_INFO",t[t.ILLEGAL_AES_PASSWORD=2028]="ILLEGAL_AES_PASSWORD",t[t.ILLEGAL_CLIENT_ROLE_LEVEL=2029]="ILLEGAL_CLIENT_ROLE_LEVEL",t[t.ERR_TOO_MANY_BROADCASTERS=2031]="ERR_TOO_MANY_BROADCASTERS",t[t.ERR_TOO_MANY_SUBSCRIBERS=2032]="ERR_TOO_MANY_SUBSCRIBERS",t[t.ERR_LICENSE_MISSING=32769]="ERR_LICENSE_MISSING",t[t.ERR_LICENSE_EXPIRED=32771]="ERR_LICENSE_EXPIRED",t[t.ERR_LICENSE_MINUTES_EXCEEDED=32773]="ERR_LICENSE_MINUTES_EXCEEDED",t[t.ERR_LICENSE_PERIOD_INVALID=32774]="ERR_LICENSE_PERIOD_INVALID",t[t.ERR_LICENSE_MULTIPLE_SDK_SERVICE=32778]="ERR_LICENSE_MULTIPLE_SDK_SERVICE",t[t.ERR_LICENSE_ILLEGAL=32783]="ERR_LICENSE_ILLEGAL",t[t.ERR_TEST_RECOVER=9e3]="ERR_TEST_RECOVER",t[t.ERR_TEST_TRYNEXT=9001]="ERR_TEST_TRYNEXT",t[t.ERR_TEST_RETRY=9002]="ERR_TEST_RETRY",t}({}),Gt=function(t){return t.CONNECTING="connecting",t.CONNECTED="connected",t.RECONNECTING="reconnecting",t.CLOSED="closed",t}({}),ht=function(t){return t.WS_CONNECTED="ws_connected",t.WS_RECONNECTING="ws_reconnecting",t.WS_CLOSED="ws_closed",t.WS_RECONNECT_WAITTING_FINISH="ws_reconnect_waitting_finish",t.WS_RECONNECT_CREATE_CONNECTION="ws_reconnect_create_connection",t.ON_BINARY_DATA="on_binary_data",t.REQUEST_RECOVER="request_recover",t.REQUEST_JOIN_INFO="request_join_info",t.REQUEST_REJOIN_INFO="req_rejoin_info",t.IS_P2P_DISCONNECTED="is_p2p_dis",t.DISCONNECT_P2P="dis_p2p",t.ABORT_P2P_EXECUTION="abort_p2p_execution",t.NEED_RENEW_SESSION="need-sid",t.REPORT_JOIN_GATEWAY="report_join_gateway",t.REQUEST_TIMEOUT="request_timeout",t.REQUEST_SUCCESS="request_success",t.JOIN_RESPONSE="join_response",t.DATACHANNEL_PRECONNECT="datachannel_preconnect",t.DATACHANNEL_CONNECTING="datachannel_connecting",t.DATACHANNEL_FAILBACK="datachannel_failback",t.P2P_CONNECTION="p2p_connection",t.P2P_REMOTE_CANDIDATE_UPDATE="p2p_remote_candidate_update",t.P2P_SUBSCRIBE="p2p_subscribe",t.P2P_UNSUBSCRIBE="p2p_unsubscribe",t.P2P_EXCHANGE_SDP="p2p_exchange_sdp",t.P2P_ON_ADD_VIDEO_STREAM="p2p_on_add_video_stream",t.P2P_ON_ADD_AUDIO_STREAM="p2p_on_add_audio_stream",t}({}),Tt=function(t){return t.PING="ping",t.PING_BACK="ping_back",t.JOIN="join_v3",t.REJOIN="rejoin_v3",t.LEAVE="leave",t.SET_CLIENT_ROLE="set_client_role",t.PUBLISH="publish",t.PUBLISH_DATASTREAM="publish_datastream",t.UNPUBLISH="unpublish",t.UNPUBLISH_DATASTREAM="unpublish_datastream",t.SUBSCRIBE="subscribe",t.PRE_SUBSCRIBE="pre_subscribe",t.SUBSCRIBE_DATASTREAM="subscribe_datastream",t.SUBSCRIBE_STREAMS="subscribe_streams",t.UNSUBSCRIBE="unsubscribe",t.UNSUBSCRIBE_DATASTREAM="unsubscribe_datastream",t.UNSUBSCRIBE_STREAMS="unsubscribe_streams",t.SUBSCRIBE_CHANGE="subscribe_change",t.TRAFFIC_STATS="traffic_stats",t.RENEW_TOKEN="renew_token",t.SWITCH_VIDEO_STREAM="switch_video_stream",t.DEFAULT_VIDEO_STREAM="default_video_stream",t.SET_FALLBACK_OPTION="set_fallback_option",t.GATEWAY_INFO="gateway_info",t.CONTROL="control",t.SEND_METADATA="send_metadata",t.DATA_STREAM="data_stream",t.PICK_SVC_LAYER="pick_svc_layer",t.RESTART_ICE="restart_ice",t.CONNECT_PC="connect_pc",t.SET_VIDEO_PROFILE="set_video_profile",t.SET_PARAMETER="set_parameter",t.SET_RTM2_FLAG="set_rtm2_flag",t}({}),Ba=function(t){return t.WRTC_STATS="wrtc_stats",t.WS_INFLATE_DATA_LENGTH="ws_inflate_data_length",t.DENOISER_STATS="denoiser_stats",t.EXTENSION_USAGE_STATS="extension_usage_stats",t}({}),Nt=function(t){return t.ON_USER_ONLINE="on_user_online",t.ON_USER_OFFLINE="on_user_offline",t.ON_STREAM_FALLBACK_UPDATE="on_stream_fallback_update",t.ON_PUBLISH_STREAM="on_publish_stream",t.ON_UPLINK_STATS="on_uplink_stats",t.ON_P2P_LOST="on_p2p_lost",t.ON_REMOVE_STREAM="on_remove_stream",t.ON_ADD_AUDIO_STREAM="on_add_audio_stream",t.ON_ADD_VIDEO_STREAM="on_add_video_stream",t.ON_TOKEN_PRIVILEGE_WILL_EXPIRE="on_token_privilege_will_expire",t.ON_TOKEN_PRIVILEGE_DID_EXPIRE="on_token_privilege_did_expire",t.ON_USER_BANNED="on_user_banned",t.ON_USER_LICENSE_BANNED="on_user_license_banned",t.ON_NOTIFICATION="on_notification",t.ON_CRYPT_ERROR="on_crypt_error",t.MUTE_AUDIO="mute_audio",t.MUTE_VIDEO="mute_video",t.UNMUTE_AUDIO="unmute_audio",t.UNMUTE_VIDEO="unmute_video",t.ON_P2P_OK="on_p2p_ok",t.RECEIVE_METADATA="receive_metadata",t.ON_DATA_STREAM="on_data_stream",t.ON_RTP_CAPABILITY_CHANGE="on_rtp_capability_change",t.ON_REMOTE_DATASTREAM_UPDATE="on_remote_datastream_update",t.ON_REMOTE_FULL_DATASTREAM_INFO="on_remote_full_datastream_info",t.ENABLE_LOCAL_VIDEO="enable_local_video",t.DISABLE_LOCAL_VIDEO="disable_local_video",t.ENABLE_LOCAL_AUDIO="enable_local_audio",t.DISABLE_LOCAL_AUDIO="disable_local_audio",t.ON_PUBLISHED_USER_LIST="on_published_user_list",t}({}),mi=function(t){return t.SEND_ONLY="SEND_ONLY",t.RECEIVE_ONLY="RECEIVE_ONLY",t}({}),It=function(t){return t.CONNECTED="websocket:connected",t.RECONNECTING="websocket:reconnecting",t.WILL_RECONNECT="websocket:will_reconnect",t.CLOSED="websocket:closed",t.FAILED="websocket:failed",t.ON_MESSAGE="websocket:on_message",t.REQUEST_NEW_URLS="websocket:request_new_urls",t.RECONNECT_WAITTING_FINISH="websocket:reconnect_waitting_finish",t.RECONNECT_CREATE_CONNECTION="websocket:reconnect_create_connection",t.ON_TOKEN_PRIVILEGE_DID_EXPIRE="websocket:on_token_privilege_did_expire",t}({});class U extends G{constructor(e){super(e,arguments.length>1&&arguments[1]!==void 0?arguments[1]:"",arguments.length>2?arguments[2]:void 0),R(this,"name","AgoraRTCException")}print(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:"error";return super.print(e,E)}throw(){super.throw(E)}}function Gp(t){if(typeof t!="string"||!/^[a-zA-Z0-9 \!\#\$\%\&\(\)\+\-\:\;\<\=\.\>\?\@\[\]\^\_\{\}\|\~\,]{1,64}$/.test(t))throw E.error("Invalid Channel Name ".concat(t)),new U(b.INVALID_PARAMS,"The length must be within 64 bytes. The supported characters: a-z,A-Z,0-9,space,!, #, $, %, &, (, ), +, -, :, ;, <, =, ., >, ?, @, [, ], ^, _,  {, }, |, ~, ,")}function Wp(t){if(!function(e){return typeof e=="number"&&Math.floor(e)===e&&0<=e&&e<=4294967295}(t)&&!GI(t,1,255))throw new U(b.INVALID_PARAMS,"[String uid] Length of the string: [1,255]. ASCII characters only. [Number uid] The value range is [0,10000]");typeof t=="string"&&E.warn("You input a string as the user ID, to ensure better end-user experience, Agora highly suggests not using a string as the user ID.")}let Un=function(t){return t.TRANSCODE="mix_streaming",t.RAW="raw_streaming",t.INJECT="inject_streaming",t}({}),id=function(t){return t[t.INJECT_STREAM_STATUS_START_SUCCESS=0]="INJECT_STREAM_STATUS_START_SUCCESS",t[t.INJECT_STREAM_STATUS_START_ALREADY_EXISTS=1]="INJECT_STREAM_STATUS_START_ALREADY_EXISTS",t[t.INJECT_STREAM_STATUS_START_UNAUTHORIZED=2]="INJECT_STREAM_STATUS_START_UNAUTHORIZED",t[t.INJECT_STREAM_STATUS_START_TIMEOUT=3]="INJECT_STREAM_STATUS_START_TIMEOUT",t[t.INJECT_STREAM_STATUS_START_FAILED=4]="INJECT_STREAM_STATUS_START_FAILED",t[t.INJECT_STREAM_STATUS_STOP_SUCCESS=5]="INJECT_STREAM_STATUS_STOP_SUCCESS",t[t.INJECT_STREAM_STATUS_STOP_NOT_FOUND=6]="INJECT_STREAM_STATUS_STOP_NOT_FOUND",t[t.INJECT_STREAM_STATUS_STOP_UNAUTHORIZED=7]="INJECT_STREAM_STATUS_STOP_UNAUTHORIZED",t[t.INJECT_STREAM_STATUS_STOP_TIMEOUT=8]="INJECT_STREAM_STATUS_STOP_TIMEOUT",t[t.INJECT_STREAM_STATUS_STOP_FAILED=9]="INJECT_STREAM_STATUS_STOP_FAILED",t[t.INJECT_STREAM_STATUS_BROKEN=10]="INJECT_STREAM_STATUS_BROKEN",t}({});const Fj={alpha:1,height:640,width:360,x:0,y:0,zOrder:0,audioChannel:0},cg={x:0,y:0,width:160,height:160,zOrder:255,alpha:1};function dg(t,e){Fn(t.url,"".concat(e,".url"),1,1e3,!1),ze(t.x)||Se(t.x,"".concat(e,".x"),0,1e4),ze(t.y)||Se(t.y,"".concat(e,".y"),0,1e4),ze(t.width)||Se(t.width,"".concat(e,".width"),0,1e4),ze(t.height)||Se(t.height,"".concat(e,".height"),0,1e4),ze(t.zOrder)||Se(t.zOrder,"".concat(e,".zOrder"),0,255),ze(t.alpha)||Se(t.alpha,"".concat(e,".alpha"),0,1,!1)}const jj={audioBitrate:48,audioChannels:1,audioSampleRate:48e3,backgroundColor:0,height:360,lowLatency:!1,videoBitrate:400,videoCodecProfile:100,videoCodecType:1,videoFrameRate:15,videoGop:30,width:640,images:[],userConfigs:[],userConfigExtraInfo:""},Bj={audioBitrate:48,audioChannels:2,audioVolume:100,audioSampleRate:48e3,height:0,width:0,videoBitrate:400,videoFramerate:15,videoGop:30};let xo=function(t){return t.WARNING="@live_uap-warning",t.ERROR="@line_uap-error",t.PUBLISH_STREAM_STATUS="@live_uap-publish-status",t.INJECT_STREAM_STATUS="@live_uap-inject-status",t.WORKER_STATUS="@live_uap-worker-status",t.REQUEST_NEW_ADDRESS="@live_uap-request-address",t}({}),Hp=function(t){return t.REQUEST_WORKER_MANAGER_LIST="@live_req_worker_manager",t}({}),Cn=function(t){return t[t.LIVE_STREAM_RESPONSE_SUCCEED=200]="LIVE_STREAM_RESPONSE_SUCCEED",t[t.LIVE_STREAM_RESPONSE_ALREADY_EXISTS_STREAM=454]="LIVE_STREAM_RESPONSE_ALREADY_EXISTS_STREAM",t[t.LIVE_STREAM_RESPONSE_TRANSCODING_PARAMETER_ERROR=450]="LIVE_STREAM_RESPONSE_TRANSCODING_PARAMETER_ERROR",t[t.LIVE_STREAM_RESPONSE_BAD_STREAM=451]="LIVE_STREAM_RESPONSE_BAD_STREAM",t[t.LIVE_STREAM_RESPONSE_WM_PARAMETER_ERROR=400]="LIVE_STREAM_RESPONSE_WM_PARAMETER_ERROR",t[t.LIVE_STREAM_RESPONSE_WM_WORKER_NOT_EXIST=404]="LIVE_STREAM_RESPONSE_WM_WORKER_NOT_EXIST",t[t.LIVE_STREAM_RESPONSE_NOT_AUTHORIZED=456]="LIVE_STREAM_RESPONSE_NOT_AUTHORIZED",t[t.LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE=457]="LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE",t[t.LIVE_STREAM_RESPONSE_REQUEST_TOO_OFTEN=429]="LIVE_STREAM_RESPONSE_REQUEST_TOO_OFTEN",t[t.LIVE_STREAM_RESPONSE_NOT_FOUND_PUBLISH=452]="LIVE_STREAM_RESPONSE_NOT_FOUND_PUBLISH",t[t.LIVE_STREAM_RESPONSE_NOT_SUPPORTED=453]="LIVE_STREAM_RESPONSE_NOT_SUPPORTED",t[t.LIVE_STREAM_RESPONSE_MAX_STREAM_NUM=455]="LIVE_STREAM_RESPONSE_MAX_STREAM_NUM",t[t.LIVE_STREAM_RESPONSE_INTERNAL_SERVER_ERROR=500]="LIVE_STREAM_RESPONSE_INTERNAL_SERVER_ERROR",t[t.LIVE_STREAM_RESPONSE_WORKER_LOST=501]="LIVE_STREAM_RESPONSE_WORKER_LOST",t[t.LIVE_STREAM_RESPONSE_RESOURCE_LIMIT=502]="LIVE_STREAM_RESPONSE_RESOURCE_LIMIT",t[t.LIVE_STREAM_RESPONSE_WORKER_QUIT=503]="LIVE_STREAM_RESPONSE_WORKER_QUIT",t[t.ERROR_FAIL_SEND_MESSAGE=504]="ERROR_FAIL_SEND_MESSAGE",t[t.PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE=30]="PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE",t[t.PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT=31]="PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT",t[t.PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH=32]="PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH",t[t.PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN=33]="PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN",t}({});function Rb(t){if(!t.channelName)throw new U(b.INVALID_PARAMS,"invalid channelName in info");if(typeof t.uid!="number")throw new U(b.INVALID_PARAMS,"invalid uid in info, uid must be a number");return t.token&&Fn(t.token,"info.token",1,2047),Wp(t.uid),Gp(t.channelName),!0}let gi=function(t){return t[t.SetSdkProfile=0]="SetSdkProfile",t[t.SetSourceChannel=1]="SetSourceChannel",t[t.SetSourceUserId=2]="SetSourceUserId",t[t.SetDestChannel=3]="SetDestChannel",t[t.StartPacketTransfer=4]="StartPacketTransfer",t[t.StopPacketTransfer=5]="StopPacketTransfer",t[t.UpdateDestChannel=6]="UpdateDestChannel",t[t.Reconnect=7]="Reconnect",t[t.SetVideoProfile=8]="SetVideoProfile",t}({}),fs=function(t){return t.NETWORK_DISCONNECTED="NETWORK_DISCONNECTED",t.NETWORK_CONNECTED="NETWORK_CONNECTED",t.PACKET_JOINED_SRC_CHANNEL="PACKET_JOINED_SRC_CHANNEL",t.PACKET_JOINED_DEST_CHANNEL="PACKET_JOINED_DEST_CHANNEL",t.PACKET_SENT_TO_DEST_CHANNEL="PACKET_SENT_TO_DEST_CHANNEL",t.PACKET_RECEIVED_VIDEO_FROM_SRC="PACKET_RECEIVED_VIDEO_FROM_SRC",t.PACKET_RECEIVED_AUDIO_FROM_SRC="PACKET_RECEIVED_AUDIO_FROM_SRC",t.PACKET_UPDATE_DEST_CHANNEL="PACKET_UPDATE_DEST_CHANNEL",t.PACKET_UPDATE_DEST_CHANNEL_REFUSED="PACKET_UPDATE_DEST_CHANNEL_REFUSED",t.PACKET_UPDATE_DEST_CHANNEL_NOT_CHANGE="PACKET_UPDATE_DEST_CHANNEL_NOT_CHANGE",t}({}),Di=function(t){return t.RELAY_STATE_IDLE="RELAY_STATE_IDLE",t.RELAY_STATE_CONNECTING="RELAY_STATE_CONNECTING",t.RELAY_STATE_RUNNING="RELAY_STATE_RUNNING",t.RELAY_STATE_FAILURE="RELAY_STATE_FAILURE",t}({}),rd=function(t){return t.RELAY_OK="RELAY_OK",t.SERVER_CONNECTION_LOST="SERVER_CONNECTION_LOST",t.SRC_TOKEN_EXPIRED="SRC_TOKEN_EXPIRED",t.DEST_TOKEN_EXPIRED="DEST_TOKEN_EXPIRED",t}({}),le=function(t){return t.High="high",t.Low="low",t.Audio="audio",t.Screen="screen",t.ScreenLow="screen_low",t}({}),nn=function(t){return t.DISCONNECT="disconnect",t.CONNECTION_STATE_CHANGE="connection-state-change",t.NETWORK_QUALITY="network-quality",t.STREAM_TYPE_CHANGE="stream-type-change",t.IS_P2P_DISCONNECTED="is-p2p-dis",t.DISCONNECT_P2P="dis-p2p",t.REQUEST_NEW_GATEWAY_LIST="req-gate-url",t.NEED_RENEW_SESSION="need-sid",t.REQUEST_P2P_CONNECTION_PARAMS="request-p2p-connection-params",t.JOIN_RESPONSE="join-response",t.REQUEST_DC_CONNECTION_PARAMS="request-dc-connection-params",t.RESET_CONNECTION_EVENTS="reset-connection-events",t.DATACHANNEL_PRECONNECT="datachannel_preconnect",t.DATACHANNEL_FAILBACK="datachannel_failback",t.RESET_SIGNAL="reset-signal",t}({}),Zu=function(t){return t.P2P_DISCONNECTED="P2P_DISCONNECTED",t.A_ROUND_WS_FAILED="A_ROUND_WS_FAILED",t.TIMEOUT="TIMEOUT",t.UNKNOWN_REASON="UNKNOWN_REASON",t}({}),On=function(t){return t[t.Nothing=0]="Nothing",t[t.Audio=1]="Audio",t[t.LwoVideo=2]="LwoVideo",t[t.Video=4]="Video",t[t.Data=8]="Data",t[t.DataStream0=256]="DataStream0",t[t.DataStream1=512]="DataStream1",t[t.DataStream2=1024]="DataStream2",t[t.DataStream3=2048]="DataStream3",t[t.DataStream4=4096]="DataStream4",t[t.DataStream5=8192]="DataStream5",t[t.DataStream6=16384]="DataStream6",t[t.DataStream7=32768]="DataStream7",t}({}),Cb=function(t){return t[t.websocket=0]="websocket",t[t.datachannel=1]="datachannel",t}({}),re=function(t){return t.CHINA="CHINA",t.ASIA="ASIA",t.NORTH_AMERICA="NORTH_AMERICA",t.EUROPE="EUROPE",t.JAPAN="JAPAN",t.INDIA="INDIA",t.KOREA="KOREA",t.HKMC="HKMC",t.US="US",t.OCEANIA="OCEANIA",t.SOUTH_AMERICA="SOUTH_AMERICA",t.AFRICA="AFRICA",t.OVERSEA="OVERSEA",t.GLOBAL="GLOBAL",t.EXTENSIONS="EXTENSIONS",t}({});const vb=[re.AFRICA,re.ASIA,re.CHINA,re.EUROPE,re.GLOBAL,re.INDIA,re.JAPAN,re.NORTH_AMERICA,re.OCEANIA,re.OVERSEA,re.SOUTH_AMERICA];let Zn=function(t){return t.CHINA="CN",t.ASIA="AS",t.NORTH_AMERICA="NA",t.EUROPE="EU",t.JAPAN="JP",t.INDIA="IN",t.KOREA="KR",t.HKMC="HK",t.US="US",t.OCEANIA="OC",t.SOUTH_AMERICA="SA",t.AFRICA="AF",t.OVERSEA="OVERSEA",t.GLOBAL="GLOBAL",t.EXTENSIONS="GLOBAL",t}({});const Kp={CHINA:{},ASIA:{CODE:Zn.ASIA,WEBCS_DOMAIN:["ap-web-1-asia.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-asia.agora.io"],PROXY_CS:["proxy-ap-web-asia.agora.io"],CDS_AP:["cds-ap-web-asia.agora.io","cds-ap-web-asia2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-asia.agora.io","sua-ap-web-asia2.agora.io"],UAP_AP:["uap-ap-web-asia.agora.io","uap-ap-web-asia2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-asia.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-asia.agora.io"],LOG_UPLOAD_SERVER:["logservice-asia.agora.io"],PROXY_SERVER_TYPE3:["southeast-asia.webrtc-cloud-proxy.sd-rtn.com"]},NORTH_AMERICA:{CODE:Zn.NORTH_AMERICA,WEBCS_DOMAIN:["ap-web-1-north-america.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-north-america.agora.io"],PROXY_CS:["proxy-ap-web-america.agora.io"],CDS_AP:["cds-ap-web-america.agora.io","cds-ap-web-america2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-america.agora.io","sua-ap-web-america2.agora.io"],UAP_AP:["uap-ap-web-america.agora.io","uap-ap-web-america2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-north-america.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-north-america.agora.io"],LOG_UPLOAD_SERVER:["logservice-north-america.agora.io"],PROXY_SERVER_TYPE3:["east-usa.webrtc-cloud-proxy.sd-rtn.com"]},EUROPE:{CODE:Zn.EUROPE,WEBCS_DOMAIN:["ap-web-1-europe.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-europe.agora.io"],PROXY_CS:["proxy-ap-web-europe.agora.io"],CDS_AP:["cds-ap-web-europe.agora.io","cds-ap-web-europe2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-europe.agora.io","sua-ap-web-europe.agora.io"],UAP_AP:["uap-ap-web-europe.agora.io","uap-ap-web-europe2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-europe.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-europe.agora.io"],LOG_UPLOAD_SERVER:["logservice-europe.agora.io"],PROXY_SERVER_TYPE3:["europe.webrtc-cloud-proxy.sd-rtn.com"]},JAPAN:{CODE:Zn.JAPAN,WEBCS_DOMAIN:["ap-web-1-japan.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-japan.agora.io"],PROXY_CS:["proxy-ap-web-japan.agora.io"],CDS_AP:["cds-ap-web-japan.agora.io","cds-ap-web-japan2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-japan.agora.io","sua-ap-web-japan2.agora.io"],UAP_AP:["uap-ap-web-japan.agora.io","uap-ap-web-japan2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-japan.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-japan.agora.io"],LOG_UPLOAD_SERVER:["logservice-japan.agora.io"],PROXY_SERVER_TYPE3:["japan.webrtc-cloud-proxy.sd-rtn.com"]},INDIA:{CODE:Zn.INDIA,WEBCS_DOMAIN:["ap-web-1-india.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-india.agora.io"],PROXY_CS:["proxy-ap-web-india.agora.io"],CDS_AP:["cds-ap-web-india.agora.io","cds-ap-web-india2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-india.agora.io","sua-ap-web-india2.agora.io"],UAP_AP:["uap-ap-web-india.agora.io","uap-ap-web-india2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-india.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-india.agora.io"],LOG_UPLOAD_SERVER:["logservice-india.agora.io"],PROXY_SERVER_TYPE3:["india.webrtc-cloud-proxy.sd-rtn.com"]},KOREA:{CODE:Zn.KOREA,WEBCS_DOMAIN:["ap-web-1-korea.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-korea.agora.io"],PROXY_CS:["proxy-ap-web-korea.agora.io"],CDS_AP:["cds-ap-web-korea.agora.io","cds-ap-web-korea2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-korea.agora.io","sua-ap-web-korea2.agora.io"],UAP_AP:["uap-ap-web-korea.agora.io","uap-ap-web-korea2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-korea.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-korea.agora.io"],LOG_UPLOAD_SERVER:["logservice-korea.agora.io"],PROXY_SERVER_TYPE3:["korea.webrtc-cloud-proxy.sd-rtn.com"]},HKMC:{CODE:Zn.HKMC,WEBCS_DOMAIN:["ap-web-1-hkmc.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-hkmc.agora.io"],PROXY_CS:["proxy-ap-web-hkmc.agora.io"],CDS_AP:["cds-ap-web-hkmc.agora.io","cds-ap-web-hkmc2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-hkmc.agora.io","sua-ap-web-hkmc2.agora.io"],UAP_AP:["uap-ap-web-hkmc.agora.io","uap-ap-web-hkmc2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-hkmc.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-hkmc.agora.io"],LOG_UPLOAD_SERVER:["logservice-hkmc.agora.io"],PROXY_SERVER_TYPE3:["hkmc.webrtc-cloud-proxy.sd-rtn.com"]},US:{CODE:Zn.US,WEBCS_DOMAIN:["ap-web-1-us.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-us.agora.io"],PROXY_CS:["proxy-ap-web-us.agora.io"],CDS_AP:["cds-ap-web-us.agora.io","cds-ap-web-us2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-us.agora.io","sua-ap-web-us2.agora.io"],UAP_AP:["uap-ap-web-us.agora.io","uap-ap-web-us2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-us.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-us.agora.io"],LOG_UPLOAD_SERVER:["logservice-us.agora.io"],PROXY_SERVER_TYPE3:["us.webrtc-cloud-proxy.sd-rtn.com"]},OVERSEA:{CODE:Zn.OVERSEA,WEBCS_DOMAIN:["ap-web-1-oversea.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-oversea.agora.io"],PROXY_CS:["proxy-ap-web-oversea.agora.io"],CDS_AP:["cds-ap-web-oversea.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-oversea.agora.io"],UAP_AP:["uap-ap-web-oversea.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-oversea.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-oversea.agora.io"],LOG_UPLOAD_SERVER:["logservice-oversea.agora.io"],PROXY_SERVER_TYPE3:["webrtc-cloud-proxy.agora.io"]},GLOBAL:{CODE:Zn.GLOBAL,WEBCS_DOMAIN:["webrtc2-ap-web-1.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["webrtc2-ap-web-3.agora.io"],PROXY_CS:["ap-proxy-1.agora.io","ap-proxy-2.agora.io"],CDS_AP:["cds-ap-web-1.agora.io","cds-ap-web-3.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-1.agora.io","sua-ap-web-3.agora.io"],UAP_AP:["uap-ap-web-1.agora.io","uap-ap-web-3.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2.agora.io"],LOG_UPLOAD_SERVER:["logservice.agora.io"],PROXY_SERVER_TYPE3:["webrtc-cloud-proxy.sd-rtn.com"]},OCEANIA:{CODE:Zn.OCEANIA,WEBCS_DOMAIN:["ap-web-1-oceania.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-oceania.agora.io"],PROXY_CS:["proxy-ap-web-oceania.agora.io"],CDS_AP:["cds-ap-web-oceania.agora.io","cds-ap-web-oceania2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-oceania.agora.io","sua-ap-web-oceania2.agora.io"],UAP_AP:["uap-ap-web-oceania.agora.io","uap-ap-web-oceania2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-oceania.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-oceania.agora.io"],LOG_UPLOAD_SERVER:["logservice-oceania.agora.io"],PROXY_SERVER_TYPE3:["oceania.webrtc-cloud-proxy.sd-rtn.com"]},SOUTH_AMERICA:{CODE:Zn.SOUTH_AMERICA,WEBCS_DOMAIN:["ap-web-1-south-america.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-south-america.agora.io"],PROXY_CS:["proxy-ap-web-south-america.agora.io"],CDS_AP:["cds-ap-web-south-america.agora.io","cds-ap-web-south-america2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-south-america.agora.io","sua-ap-web-south-america2.agora.io"],UAP_AP:["uap-ap-web-south-america.agora.io","uap-ap-web-south-america2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-south-america.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-south-america.agora.io"],LOG_UPLOAD_SERVER:["logservice-south-america.agora.io"],PROXY_SERVER_TYPE3:["south-america.webrtc-cloud-proxy.sd-rtn.com"]},AFRICA:{CODE:Zn.AFRICA,WEBCS_DOMAIN:["ap-web-1-africa.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-africa.agora.io"],PROXY_CS:["proxy-ap-web-africa.agora.io"],CDS_AP:["cds-ap-web-africa.agora.io","cds-ap-web-africa2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-africa.agora.io","sua-ap-web-africa2.agora.io"],UAP_AP:["uap-ap-web-africa.agora.io","uap-ap-web-africa2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-africa.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-africa.agora.io"],LOG_UPLOAD_SERVER:["logservice-south-africa.agora.io"],PROXY_SERVER_TYPE3:["africa.webrtc-cloud-proxy.sd-rtn.com"]},EXTENSIONS:{}};Zm&&(Kp.CHINA={CODE:Zn.CHINA,WEBCS_DOMAIN:["webrtc2-2.ap.sd-rtn.com"],WEBCS_DOMAIN_BACKUP_LIST:["webrtc2-4.ap.sd-rtn.com"],PROXY_CS:["proxy-web.ap.sd-rtn.com"],CDS_AP:["cds-web-2.ap.sd-rtn.com","cds-web-4.ap.sd-rtn.com"],ACCOUNT_REGISTER:["sua-web-2.ap.sd-rtn.com","sua-web-4.ap.sd-rtn.com"],UAP_AP:["uap-web-2.ap.sd-rtn.com","uap-web-4.ap.sd-rtn.com"],EVENT_REPORT_DOMAIN:["web-3.statscollector.sd-rtn.com"],EVENT_REPORT_BACKUP_DOMAIN:["web-4.statscollector.sd-rtn.com"],LOG_UPLOAD_SERVER:["logservice-china.agora.io"],PROXY_SERVER_TYPE3:["east-cn.webrtc-cloud-proxy.sd-rtn.com"]});let ug=function(t){return t.UPDATE_BITRATE_LIMIT="update_bitrate_limit",t}({});class yb extends Ve{constructor(e,n){super(),R(this,"onICEConnectionStateChange",void 0),R(this,"onConnectionStateChange",void 0),R(this,"onDTLSTransportStateChange",void 0),R(this,"onDTLSTransportError",void 0),R(this,"onICETransportStateChange",void 0),R(this,"onFirstAudioReceived",void 0),R(this,"onFirstVideoReceived",void 0),R(this,"onFirstAudioDecoded",void 0),R(this,"onFirstVideoDecoded",void 0),R(this,"onFirstVideoDecodedTimeout",void 0),R(this,"onSelectedLocalCandidateChanged",void 0),R(this,"onSelectedRemoteCandidateChanged",void 0),R(this,"getLocalVideoStats",void 0)}}class qp extends yb{constructor(e,n){super(e,n),R(this,"establishPromise",void 0)}}let _t=function(t){return t.VIDEO="video",t.AUDIO="audio",t}({}),ai=function(t){return t[t.UDP=0]="UDP",t[t.TCP=1]="TCP",t[t.RELAY=2]="RELAY",t}({}),_s=function(t){return t[t.FIRST_CONNECTION=0]="FIRST_CONNECTION",t[t.TCP_RESTART=1]="TCP_RESTART",t[t.RELAY_RESTART=2]="RELAY_RESTART",t[t.OLD_FIRST_CONNECTION=10]="OLD_FIRST_CONNECTION",t[t.OLD_RESTART=11]="OLD_RESTART",t[t.DISCONNECTED_OR_FAILED=20]="DISCONNECTED_OR_FAILED",t}({}),X=function(t){return t.LocalVideoTrack="videoTrack",t.LocalAudioTrack="audioTrack",t.LocalVideoLowTrack="videoLowTrack",t}({}),he=function(t){return t.New="new",t.Connected="connected",t.Reconnecting="reconnecting",t.Disconnected="disconnected",t}({}),yt=function(t){return t.StateChange="stateChange",t.IceConnectionStateChange="iceConnectionStateChange",t.RequestMuteLocal="requestMuteLocal",t.RequestUnmuteLocal="requestUnmuteLocal",t.RequestRePublish="requestRePublish",t.RequestRePublishDataChannel="requestRePublishDataChannel",t.RequestReSubscribe="requestReSubscribe",t.RequestUploadStats="requestUploadStats",t.RequestUpload="requestUpload",t.MediaReconnectStart="MediaReconnectStart",t.MediaReconnectEnd="MediaReconnectEnd",t.NeedSignalRTT="NeedSignalRTT",t.RequestRestartICE="RequestRestartIce",t.PeerConnectionStateChange="PeerConnectionStateChange",t.RequestReconnect="RequestReconnect",t.RequestReconnectPC="RequestReconnectPC",t.RequestUnpublishForReconnectPC="RequestUnpublishForReconnectPC",t.P2PLost="P2PLost",t.UpdateVideoEncoder="UpdateVideoEncoder",t.ConnectionTypeChange="ConnectionTypeChange",t.RequestLowStreamParameter="RequestLowStreamParameter",t.QueryClientConnectionState="QueryClientConnectionState",t.LocalCandidate="LocalCandidate",t.RequestP2PMuteLocal="requestP2PMuteLocal",t.RequestP2PUnPublish="RequestP2PUnPublish",t.RequestP2PUnmuteRemote="RequestP2PUnmuteRemote",t.RequestP2PMuteRemote="RequestP2PMuteRemote",t.RequestP2PRestartICE="RequestP2PRestartICE",t}({}),Mr=function(t){return t.CONNECTING="CONNECTING",t.RECONNECTING="RECONNECTING",t.CONNECTED="CONNECTED",t.CLOSED="CLOSED",t}({}),Ur=function(t){return t[t.CONNECT_AP=0]="CONNECT_AP",t[t.AP_CONNECTED=1]="AP_CONNECTED",t[t.CONNECT_WORKER_MANAGER=2]="CONNECT_WORKER_MANAGER",t[t.WORKER_MANAGER_CONNECTED=3]="WORKER_MANAGER_CONNECTED",t[t.GET_WORKER_MANAGER_RESPONSE=4]="GET_WORKER_MANAGER_RESPONSE",t[t.CONNECT_WORKER=5]="CONNECT_WORKER",t[t.WORKER_CONNECTED=6]="WORKER_CONNECTED",t[t.CLOSED=7]="CLOSED",t}({}),xn=function(t){return t.CONNECTION_STATE_CHANGE="connection-state-change",t.STATE_CHANGE="state-change",t.INSPECT_RESULT="inspect-result",t.CLIENT_LOCAL_VIDEO_TRACK="client-local-video-track",t.REQUEST_NEW_WORKER_URL="request-new-worker-url",t}({}),zs=function(t){return t.NETWORK_ERROR="NETWORK_ERROR",t.SERVER_ERROR="SERVER_ERROR",t.MULTI_IP="MULTI_IP",t.TIMEOUT="TIMEOUT",t.OFFLINE="OFFLINE",t.LEAVE="LEAVE",t.P2P_FAILED="P2P_FAILED",t.FALLBACK="FALLBACK",t}({}),mn=function(t){return t.CONNECTED="transmitter:connected",t.RECONNECTING="transmitter:reconnecting",t.WILL_RECONNECT="transmitter:will_reconnect",t.CLOSED="transmitter:closed",t.FAILED="transmitter:failed",t.ON_MESSAGE="transmitter:on_message",t.REQUEST_NEW_URLS="transmitter:request_new_urls",t.RECONNECT_WAITTING_FINISH="transmitter:reconnect_waitting_finish",t.RECONNECT_CREATE_CONNECTION="transmitter:reconnect_create_connection",t.ON_TOKEN_PRIVILEGE_DID_EXPIRE="transmitter:on_token_privilege_did_expire",t.TO_CONNECT_DATACHANNEL="transmitter:to_connect_datachannel",t.FAILBACK="transmitter:failback",t}({}),Vo=function(t){return t.CAMERA_CHANGED="camera-changed",t.MICROPHONE_CHANGED="microphone-changed",t.PLAYBACK_DEVICE_CHANGED="playback-device-changed",t.AUDIO_AUTOPLAY_FAILED="audio-autoplay-failed",t.AUTOPLAY_FAILED="autoplay-failed",t.AUDIO_CONTEXT_STATE_CHANGED="audio-context-state-changed",t.SECURITY_POLICY_VIOLATION="security-policy-violation",t}({}),_r=function(t){return t.CONNECTING="CONNECTING",t.RECONNECTING="RECONNECTING",t.CONNECTED="CONNECTED",t.CLOSED="CLOSED",t}({}),co=function(t){return t.CONNECTION_STATE_CHANGE="connection-state-change",t.STATE_CHANGE="state-change",t.INSPECT_RESULT="inspect-result",t.CLIENT_LOCAL_VIDEO_TRACK="client-local-video-track",t.REQUEST_NEW_WORKER_URL="request-new-worker-url",t}({}),od=function(t){return t[t.CONNECT_AP=0]="CONNECT_AP",t[t.AP_CONNECTED=1]="AP_CONNECTED",t[t.CONNECT_WORKER_MANAGER=2]="CONNECT_WORKER_MANAGER",t[t.WORKER_MANAGER_CONNECTED=3]="WORKER_MANAGER_CONNECTED",t[t.GET_WORKER_MANAGER_RESPONSE=4]="GET_WORKER_MANAGER_RESPONSE",t[t.CONNECT_WORKER=5]="CONNECT_WORKER",t[t.WORKER_CONNECTED=6]="WORKER_CONNECTED",t[t.CLOSED=7]="CLOSED",t}({}),rn=function(t){return t.CALL="call",t.CANDIDATE="candidate",t.PUBLISH="publish",t.UNPUBLISH="unpublish",t.CONTROL="control",t.RESTART_ICE="restart_ice",t.ACK="ack",t.RESPONSE="response",t.JOIN="join",t.CHECK="check",t}({}),sd=function(t){return t.ABORT="abort",t}({}),Js=function(t){return t.MUTE_LOCAL_AUDIO="mute_local_audio",t.MUTE_LOCAL_VIDEO="mute_local_video",t.UNMUTE_LOCAL_AUDIO="unmute_local_audio",t.UNMUTE_LOCAL_VIDEO="unmute_local_video",t}({}),Gj=function(t){return t.P2P_TOKEN_TIMEOUT="p2p_token_timeout",t.P2P_TOKEN_CHANGED="p2p_token_changed",t}({});const Wj={[Bp.ACCESS_POINT]:{[Ei.NO_FLAG_SET]:{desc:"flag is zero",retry:!1},[Ei.FLAG_SET_BUT_EMPTY]:{desc:"flag is empty",retry:!1},[Ei.INVALID_FALG_SET]:{desc:"invalid flag",retry:!1},[Ei.FLAG_SET_BUT_NO_RE]:{desc:"flag set unilbs but no request",retry:!1},[Ei.INVALID_SERVICE_ID]:{desc:"invalid service id",retry:!1},[Ei.NO_SERVICE_AVAILABLE]:{desc:"no service available",retry:!0},[Ei.NO_SERVICE_AVAILABLE_P2P]:{desc:"no unilbs p2p service available",retry:!0},[Ei.NO_SERVICE_AVAILABLE_VOICE]:{desc:"no unilbs voice service available",retry:!0},[Ei.NO_SERVICE_AVAILABLE_WEBRTC]:{desc:"no unilbs webrtc service available",retry:!0},[Ei.NO_SERVICE_AVAILABLE_CDS]:{desc:"no cds service available",retry:!0},[Ei.NO_SERVICE_AVAILABLE_CDN]:{desc:"no cdn dispatcher service available",retry:!0},[Ei.NO_SERVICE_AVAILABLE_TDS]:{desc:"no tds service available",retry:!0},[Ei.NO_SERVICE_AVAILABLE_REPORT]:{desc:"no unilbs report service available",retry:!0},[Ei.NO_SERVICE_AVAILABLE_APP_CENTER]:{desc:"no app center service available",retry:!0},[Ei.NO_SERVICE_AVAILABLE_ENV0]:{desc:"no unilbs sig env0 service available",retry:!0},[Ei.NO_SERVICE_AVAILABLE_VOET]:{desc:"no unilbs voet service available",retry:!0},[Ei.NO_SERVICE_AVAILABLE_STRING_UID]:{desc:"no string uid service available",retry:!0},[Ei.NO_SERVICE_AVAILABLE_WEBRTC_UNILBS]:{desc:"no webrtc unilbs service available",retry:!0}},[Bp.UNILBS]:{[kr.INVALID_VENDOR_KEY]:{desc:"invalid vendor key, can not find appid",retry:!1},[kr.INVALID_CHANNEL_NAME]:{desc:"invalid channel name",retry:!1},[kr.INTERNAL_ERROR]:{desc:"unilbs internal error",retry:!1},[kr.NO_AUTHORIZED]:{desc:"invalid token, authorized failed",retry:!1},[kr.DYNAMIC_KEY_TIMEOUT]:{desc:"dynamic key or token timeout",retry:!1},[kr.NO_ACTIVE_STATUS]:{desc:"no active status",retry:!1},[kr.DYNAMIC_KEY_EXPIRED]:{desc:"dynamic key expired",retry:!1},[kr.STATIC_USE_DYNAMIC_KEY]:{desc:"static use dynamic key",retry:!1},[kr.DYNAMIC_USE_STATIC_KEY]:{desc:"dynamic use static key",retry:!1},[kr.USER_OVERLOAD]:{desc:"amount of users over load",retry:!1},[kr.FORBIDDEN_REGION]:{desc:"the request is forbidden in this area",retry:!1},[kr.CANNOT_MEET_AREA_DEMAND]:{desc:"unable to allocate services in this area",retry:!1}},[Bp.STRING_UID_ALLOCATOR]:{[ag.IIIEGAL_APPID]:{desc:"invalid appid",retry:!1},[ag.IIIEGAL_UID]:{desc:"invalid string uid",retry:!1},[ag.INTERNAL_ERROR]:{desc:"string uid allocator internal error",retry:!0}}};function ad(t){const e=Wj[Math.floor(t/1e4)];if(!e)return{desc:"unknown error",retry:!1};const n=e[t%1e4];if(!n){if(Math.floor(t/1e4)===Bp.ACCESS_POINT){const i=t%1e4;if(i.toString()[0]==="1")return{desc:t.toString(),retry:!1};if(i.toString()[0]==="2")return{desc:t.toString(),retry:!0}}return{desc:"unknown error",retry:!1}}return n}const Hj={[Rt.K_TIMESTAMP_EXPIRED]:{desc:"K_TIMESTAMP_EXPIRED",action:"failed"},[Rt.K_CHANNEL_PERMISSION_INVALID]:{desc:"K_CHANNEL_PERMISSION_INVALID",action:"failed"},[Rt.K_CERTIFICATE_INVALID]:{desc:"K_CERTIFICATE_INVALID",action:"failed"},[Rt.K_CHANNEL_NAME_EMPTY]:{desc:"K_CHANNEL_NAME_EMPTY",action:"failed"},[Rt.K_CHANNEL_NOT_FOUND]:{desc:"K_CHANNEL_NOT_FOUND",action:"failed"},[Rt.K_TICKET_INVALID]:{desc:"K_TICKET_INVALID",action:"failed"},[Rt.K_CHANNEL_CONFLICTED]:{desc:"K_CHANNEL_CONFLICTED",action:"failed"},[Rt.K_SERVICE_NOT_READY]:{desc:"K_SERVICE_NOT_READY",action:"tryNext"},[Rt.K_SERVICE_TOO_HEAVY]:{desc:"K_SERVICE_TOO_HEAVY",action:"tryNext"},[Rt.K_UID_BANNED]:{desc:"K_UID_BANNED",action:"failed"},[Rt.K_IP_BANNED]:{desc:"K_IP_BANNED",action:"failed"},[Rt.K_AUTO_REBALANCE]:{desc:"k_AUTO_REBALANCE",action:"recover"},[Rt.ERR_INVALID_VENDOR_KEY]:{desc:"ERR_INVALID_VENDOR_KEY",action:"failed"},[Rt.ERR_INVALID_CHANNEL_NAME]:{desc:"ERR_INVALID_CHANNEL_NAME",action:"failed"},[Rt.WARN_NO_AVAILABLE_CHANNEL]:{desc:"WARN_NO_AVAILABLE_CHANNEL",action:"failed"},[Rt.WARN_LOOKUP_CHANNEL_TIMEOUT]:{desc:"WARN_LOOKUP_CHANNEL_TIMEOUT",action:"tryNext"},[Rt.WARN_LOOKUP_CHANNEL_REJECTED]:{desc:"WARN_LOOKUP_CHANNEL_REJECTED",action:"failed"},[Rt.WARN_OPEN_CHANNEL_TIMEOUT]:{desc:"WARN_OPEN_CHANNEL_TIMEOUT",action:"tryNext"},[Rt.WARN_OPEN_CHANNEL_REJECTED]:{desc:"WARN_OPEN_CHANNEL_REJECTED",action:"failed"},[Rt.WARN_REQUEST_DEFERRED]:{desc:"WARN_REQUEST_DEFERRED",action:"failed"},[Rt.ERR_DYNAMIC_KEY_TIMEOUT]:{desc:"ERR_DYNAMIC_KEY_TIMEOUT",action:"failed"},[Rt.ERR_NO_AUTHORIZED]:{desc:"ERR_NO_AUTHORIZED",action:"failed"},[Rt.ERR_VOM_SERVICE_UNAVAILABLE]:{desc:"ERR_VOM_SERVICE_UNAVAILABLE",action:"tryNext"},[Rt.ERR_NO_CHANNEL_AVAILABLE_CODE]:{desc:"ERR_NO_CHANNEL_AVAILABLE_CODE",action:"failed"},[Rt.ERR_MASTER_VOCS_UNAVAILABLE]:{desc:"ERR_MASTER_VOCS_UNAVAILABLE",action:"tryNext"},[Rt.ERR_INTERNAL_ERROR]:{desc:"ERR_INTERNAL_ERROR",action:"tryNext"},[Rt.ERR_NO_ACTIVE_STATUS]:{desc:"ERR_NO_ACTIVE_STATUS",action:"failed"},[Rt.ERR_INVALID_UID]:{desc:"ERR_INVALID_UID",action:"failed"},[Rt.ERR_DYNAMIC_KEY_EXPIRED]:{desc:"ERR_DYNAMIC_KEY_EXPIRED",action:"failed"},[Rt.ERR_STATIC_USE_DYANMIC_KE]:{desc:"ERR_STATIC_USE_DYANMIC_KE",action:"failed"},[Rt.ERR_DYNAMIC_USE_STATIC_KE]:{desc:"ERR_DYNAMIC_USE_STATIC_KE",action:"failed"},[Rt.ERR_NO_VOCS_AVAILABLE]:{desc:"ERR_NO_VOCS_AVAILABLE",action:"tryNext"},[Rt.ERR_NO_VOS_AVAILABLE]:{desc:"ERR_NO_VOS_AVAILABLE",action:"tryNext"},[Rt.ERR_JOIN_CHANNEL_TIMEOUT]:{desc:"ERR_JOIN_CHANNEL_TIMEOUT",action:"tryNext"},[Rt.ERR_JOIN_BY_MULTI_IP]:{desc:"ERR_JOIN_BY_MULTI_IP",action:"recover"},[Rt.ERR_NOT_JOINED]:{desc:"ERR_NOT_JOINED",action:"failed"},[Rt.ERR_REPEAT_JOIN_REQUEST]:{desc:"ERR_REPEAT_JOIN_REQUEST",action:"quit"},[Rt.ERR_REPEAT_JOIN_CHANNEL]:{desc:"ERR_REPEAT_JOIN_CHANNEL",action:"quit"},[Rt.ERR_INVALID_STRINGUID]:{desc:"ERR_INVALID_STRINGUID",action:"failed"},[Rt.ERR_TOO_MANY_USERS]:{desc:"ERR_TOO_MANY_USERS",action:"tryNext"},[Rt.ERR_SET_CLIENT_ROLE_TIMEOUT]:{desc:"ERR_SET_CLIENT_ROLE_TIMEOUT",action:"failed"},[Rt.ERR_SET_CLIENT_ROLE_NO_PERMISSION]:{desc:"ERR_SET_CLIENT_ROLE_TIMEOUT",action:"failed"},[Rt.ERR_SET_CLIENT_ROLE_ALREADY_IN_USE]:{desc:"ERR_SET_CLIENT_ROLE_ALREADY_IN_USE",action:"success"},[Rt.ERR_PUBLISH_REQUEST_INVALID]:{desc:"ERR_PUBLISH_REQUEST_INVALID",action:"failed"},[Rt.ERR_SUBSCRIBE_REQUEST_INVALID]:{desc:"ERR_SUBSCRIBE_REQUEST_INVALID",action:"failed"},[Rt.ERR_NOT_SUPPORTED_MESSAGE]:{desc:"ERR_NOT_SUPPORTED_MESSAGE",action:"failed"},[Rt.ERR_ILLEAGAL_PLUGIN]:{desc:"ERR_ILLEAGAL_PLUGIN",action:"failed"},[Rt.ILLEGAL_CLIENT_ROLE_LEVEL]:{desc:"ILLEGAL_CLIENT_ROLE_LEVEL",action:"failed"},[Rt.ERR_REJOIN_TOKEN_INVALID]:{desc:"ERR_REJOIN_TOKEN_INVALID",action:"failed"},[Rt.ERR_REJOIN_USER_NOT_JOINED]:{desc:"ERR_REJOIN_NOT_JOINED",action:"failed"},[Rt.ERR_INVALID_OPTIONAL_INFO]:{desc:"ERR_INVALID_OPTIONAL_INFO",action:"quit"},[Rt.ERR_TEST_RECOVER]:{desc:"ERR_TEST_RECOVER",action:"recover"},[Rt.ERR_TEST_TRYNEXT]:{desc:"ERR_TEST_TRYNEXT",action:"recover"},[Rt.ERR_TEST_RETRY]:{desc:"ERR_TEST_RETRY",action:"recover"},[Rt.ILLEGAL_AES_PASSWORD]:{desc:"ERR_TEST_RETRY",action:"failed"},[Rt.ERR_TOO_MANY_BROADCASTERS]:{desc:"ERR_TOO_MANY_BROADCASTERS",action:"failed"},[Rt.ERR_TOO_MANY_SUBSCRIBERS]:{desc:"ERR_TOO_MANY_SUBSCRIBERS",action:"failed"},[Rt.ERR_LICENSE_ILLEGAL]:{desc:"ERR_LICENSE_ILLEGAL",action:"quit"},[Rt.ERR_LICENSE_MISSING]:{desc:"ERR_LICENSE_MISSING",action:"quit"},[Rt.ERR_LICENSE_EXPIRED]:{desc:"ERR_LICENSE_EXPIRED",action:"quit"},[Rt.ERR_LICENSE_MINUTES_EXCEEDED]:{desc:"ERR_LICENSE_MINUTES_EXCEEDED",action:"quit"},[Rt.ERR_LICENSE_PERIOD_INVALID]:{desc:"ERR_LICENSE_PERIOD_INVALID",action:"quit"},[Rt.ERR_LICENSE_MULTIPLE_SDK_SERVICE]:{desc:"ERR_LICENSE_MULTIPLE_SDK_SERVICE",action:"quit"}};function Ga(t){return Hj[t]||{desc:"UNKNOW_ERROR_".concat(t),action:"failed"}}function Ib(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),n.push.apply(n,i)}return n}function lg(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?Ib(Object(n),!0).forEach(function(i){R(t,i,n[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):Ib(Object(n)).forEach(function(i){Object.defineProperty(t,i,Object.getOwnPropertyDescriptor(n,i))})}return t}function bb(t){return t.every(e=>e.readyState===WebSocket.CLOSED||e.readyState===WebSocket.CLOSING)}function Ab(t,e){if(typeof t=="string")return t;const{proxy:n,host:i,port:r}=t;if(e){const o=N("JOIN_GATEWAY_FALLBACK_PORT")||443;return o===443?"wss://".concat(i,"/ws/?p=").concat(Number(r)+150):"wss://".concat(i,":").concat(o,"/ws/?p=").concat(Number(r)+150)}return n?"wss://".concat(n,"/ws/?h=").concat(i,"&p=").concat(r):"wss://".concat(i,":").concat(r)}const Kj=/wss:\/\/(.+)\/ws\/\?h=(.+)&p=([0-9]+)\/?/,qj=/wss:\/\/(.+)\/ws\/\?p=([0-9]+)\/?/,Yj=/wss:\/\/(.+):([0-9]+)\/?/,zj=/wss:\/\/(.[^\/]+)\/?/;let Jj=0;class Xj{constructor(e,n){R(this,"id",0),R(this,"store",void 0),R(this,"recordIndex",void 0),R(this,"websockets",[]),R(this,"try443PortDuration",2e3),R(this,"forceCloseWSDuration",5e3),R(this,"try443PortTimeout",null),R(this,"forceCloseTimeout",null),R(this,"isTry443PortFailed",!1),R(this,"isNormalPortFailed",!1),R(this,"useDoubleDomain",!1),R(this,"useProxy",!1),R(this,"startTime",Date.now()),this.id=++Jj,this.try443PortDuration=N("JOIN_GATEWAY_TRY_443PORT_DURATION")||2e3,this.forceCloseWSDuration=e||5e3,this.store=n}closeAllWebsockets(){this.websockets.forEach(e=>{e.onopen=null,e.onclose=null,e.onmessage=null,e.close()}),this.websockets.length=0}clearTimeout(){this.forceCloseTimeout&&clearTimeout(this.forceCloseTimeout),this.try443PortTimeout&&clearTimeout(this.try443PortTimeout)}logger(){var e;const n=Date.now()-this.startTime;for(var i=arguments.length,r=new Array(i),o=0;o<i;o++)r[o]=arguments[o];E.debug("[choose-best-ws ".concat((e=this.store)===null||e===void 0?void 0:e.clientId," ").concat(this.id,"] ").concat(n,"ms:"),...r)}createWebSocket(e,n,i){this.logger("createWebSocket:",e,{isTry443Port:n,hasTimeoutDetection:i});const r=N("GATEWAY_DOMAINS"),o=Date.now(),s=[],a=r.find(u=>{var l;return it(l=e.host).call(l,u)});a||(this.useDoubleDomain=!1);const c=[];if(this.useDoubleDomain)r.forEach(u=>{c.push(Ab(lg(lg({},e),{},{host:e.host.replace(a,u)}),n))});else{const u=lg({},e);if(n&&a){const l=r.find(p=>p!==a);l&&(u.host=u.host.replace(a,l))}c.push(Ab(u,n))}try{c.forEach(u=>{const l=new WebSocket(u);l.binaryType="arraybuffer",s.push(l),this.logger("ws is connecting:",l.url)})}catch(u){if(this.logger("ws create failed"),s.forEach(l=>l.close()),s.length=0,this.useDoubleDomain)return this.useDoubleDomain=!1,this.createWebSocket(e,n,i);if(!n&&Number(e.port)!==443)return this.createWebSocket(e,!0,i);throw new U(b.WS_ERR,"init websocket failed! Error: ".concat(u.toString()))}const d=Ku();return this.store&&this.store.recordJoinChannelService({urls:s.map(u=>u.url),service:"gateway"},this.recordIndex),s.forEach(u=>{u.onopen=()=>{this.logger("onopen: ws ".concat(u.url," open cost ").concat(Date.now()-o,"ms")),this.websockets.forEach(l=>{l!==u&&(l.onopen=null,l.onclose=null,l.onmessage=null,l.close(),this.logger("close backup websocket: ".concat(l.url)))}),this.websockets.length=0,d.resolve(u)},u.onclose=l=>{this.logger("onclose: ws ".concat(u.url," closed cost ").concat(Date.now()-o,"ms state: ").concat(u.readyState)),n?this.isTry443PortFailed=bb(s):this.isNormalPortFailed=bb(s),this.logger("443: ".concat(this.useProxy?"not try":this.isTry443PortFailed?"failed":"trying"," 47xx: ").concat(this.isNormalPortFailed?"failed":"trying")),(n&&this.isTry443PortFailed||!n&&(this.isTry443PortFailed||this.useProxy)&&this.isNormalPortFailed)&&(this.logger("onclose: all websocket is closed, ".concat(l.reason)),d.reject({code:l.code,reason:Zu.A_ROUND_WS_FAILED}))},u.onmessage=l=>this.logger("".concat(u.url," onmessage: ").concat(l.data))}),this.websockets.push(...s),i||(()=>{const u=()=>{this.logger("5s timeout close un-opens, isWebsocket created: ",d.isResolved),this.websockets.forEach(l=>l.readyState!==WebSocket.OPEN&&l.close())};if(n||this.useProxy)return this.logger("add 5s timeout at ".concat(n?"try-443":"proxy"," condition")),this.forceCloseTimeout=window.setTimeout(u,this.forceCloseWSDuration);this.try443PortTimeout=window.setTimeout(()=>{if(this.logger("2s timeout, isWebsocket created: ",d.isResolved),d.isResolved)return u();Zt().os===bn.MAC_OS&&ye()&&u(),this.createWebSocket(e,!0,!0).then(l=>d.resolve(l)).catch(l=>{this.isNormalPortFailed&&d.reject(l),this.logger("try 443 port to create ws failed")}),this.forceCloseTimeout=window.setTimeout(u,this.forceCloseWSDuration)},this.try443PortDuration)})(),d.promise}chooseBestWebsocket(e,n,i,r){return this.useDoubleDomain=!!n,typeof e=="string"&&(e=function(o){let s,a,c;return[,s,a,c]=o.match(Kj)||[],s||([,a,c]=o.match(qj)||[]),a&&c||([,a,c]=o.match(Yj)||[]),a&&c||([,a]=o.match(zj)||[]),a||E.warning("un-destructible url: ",o),{proxy:s,host:a,port:c||"443"}}(e)),this.recordIndex=r,this.useProxy=!!e.proxy,i&&this.useProxy&&(E.warn("cannot use 443 only when use proxy"),i=!1),this.createWebSocket(e,!!i,!1).finally(()=>this.clearTimeout())}}function wb(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),n.push.apply(n,i)}return n}class Ob extends Ve{get url(){return this.websocket&&this.websocket.url||null}get reconnectMode(){return this._reconnectMode}set reconnectMode(e){var n;it(n=["tryNext","recover"]).call(n,e)&&this.resetReconnectCount(e),this._reconnectMode=e}get state(){return this._state}set state(e){e!==this._state&&(this._state=e,this._state==="reconnecting"?this.emit(It.RECONNECTING,this.reconnectReason):this._state==="connected"?this.emit(It.CONNECTED):this._state==="closed"?this.emit(It.CLOSED):this._state==="failed"&&this.emit(It.FAILED))}resetReconnectCount(e){E.debug("websocket reset reconnect count, reason: "+e),this.reconnectCount=0}constructor(e,n){let i=arguments.length>2&&arguments[2]!==void 0&&arguments[2],r=arguments.length>3&&arguments[3]!==void 0&&arguments[3],o=arguments.length>4&&arguments[4]!==void 0&&arguments[4],s=arguments.length>5?arguments[5]:void 0;super(),R(this,"connectionID",0),R(this,"currentURLIndex",0),R(this,"urls",[]),R(this,"_reconnectMode","tryNext"),R(this,"reconnectReason",void 0),R(this,"_initMutex",new kn("websocket")),R(this,"name",void 0),R(this,"_state","closed"),R(this,"reconnectInterrupter",void 0),R(this,"websocket",void 0),R(this,"retryConfig",void 0),R(this,"reconnectCount",0),R(this,"forceCloseTimeout",5e3),R(this,"onlineReconnectListener",void 0),R(this,"useCompress",void 0),R(this,"tryDoubleDomain",!1),R(this,"use443PortOnly",!1),R(this,"wsInflateLength",0),R(this,"wsDeflateLength",0),R(this,"closeEstablishingWs",()=>{}),R(this,"store",void 0),R(this,"joinGatewayRecordIndex",void 0),this.store=s,this.name=e,this.retryConfig=function(l){for(var p=1;p<arguments.length;p++){var f=arguments[p]!=null?arguments[p]:{};p%2?wb(Object(f),!0).forEach(function(C){R(l,C,f[C])}):Object.getOwnPropertyDescriptors?Object.defineProperties(l,Object.getOwnPropertyDescriptors(f)):wb(Object(f)).forEach(function(C){Object.defineProperty(l,C,Object.getOwnPropertyDescriptor(f,C))})}return l}({},n),this.useCompress=i,this.tryDoubleDomain=r,this.use443PortOnly=o;const{timeout:a,timeoutFactor:c}=n,d=Math.max(300,Math.floor(3*a/5)),u=Math.max(1.2,Math.floor(8*c)/10);_i.ONLINE&&(this.retryConfig.timeout=d,this.retryConfig.timeoutFactor=u),Xe.on(Ma.NETWORK_STATE_CHANGE,(l,p)=>{l!==p&&(this.resetReconnectCount("network state change: ".concat(p," -> ").concat(l)),l===_i.ONLINE?(this.retryConfig.timeout=d,this.retryConfig.timeoutFactor=u):(this.retryConfig.timeout=a,this.retryConfig.timeoutFactor=c))})}getConnection(){return this.websocket||void 0}async init(e){let n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:5e3;const i=await this._initMutex.lock();this.forceCloseTimeout=n,this.urls=e,this.state="connecting";try{const r=Ku(),o=this.urls[this.currentURLIndex];this.createWebSocketConnection(o).then(r.resolve).catch(r.reject),this.once(It.CLOSED,()=>{r.reject(new G(b.WS_DISCONNECT))}),this.once(It.CONNECTED,r.resolve),await r.promise}catch{}finally{i()}}close(e,n){if(this.currentURLIndex=0,this.resetReconnectCount("close"),this.reconnectInterrupter&&this.reconnectInterrupter(),this.websocket){this.websocket.onclose=null,this.websocket.onopen=null,this.websocket.onmessage=null;const i=this.websocket;n?setTimeout(()=>i.close(),500):i.close(),this.websocket=void 0}this.state=e?"failed":"closed",this.closeEstablishingWs&&this.closeEstablishingWs()}reconnect(e,n){if(!this.websocket)return void E.warning("[".concat(this.name,"] can not reconnect, no websocket"));e!==void 0&&(this.reconnectMode=e),E.debug("[".concat(this.name,"] reconnect is triggered initiative")),typeof this.joinGatewayRecordIndex=="number"&&this.store&&this.store.recordJoinChannelService({status:"error",errors:[new Error(n)]},this.joinGatewayRecordIndex);const i=this.websocket.onclose;this.websocket.onclose=null,this.websocket.close(),i&&i.bind(this.websocket)({code:9999,reason:n})}sendMessage(e){let n=arguments.length>2&&arguments[2]!==void 0&&arguments[2];if(!this.websocket||this.websocket.readyState!==WebSocket.OPEN)throw new G(b.WS_ABORT,"websocket is not ready");try{n||(e=JSON.stringify(e)),this.websocket.send(e)}catch(i){throw new G(b.WS_ERR,"send websocket message error"+i.toString())}}setWsInflateData(e){this.wsDeflateLength=this.wsDeflateLength+e.originLength,this.wsInflateLength=this.wsInflateLength+e.compressedLength}getWsInflateData(){const e=this.wsInflateLength,n=this.wsDeflateLength;return this.clearWsInflateData(),{wsInflateLength:e,wsDeflateLength:n}}clearWsInflateData(){this.wsInflateLength=0,this.wsDeflateLength=0}async createWebSocketConnection(e){var n;const i=Ku();this.connectionID+=1,this.joinGatewayRecordIndex=void 0;const r=u=>{var l;(l=this.store)===null||l===void 0||l.signalChannelOpen(),E.debug("[".concat(this.name,"] websocket opened:"),u),this.reconnectMode="retry",this.state="connected",this.resetReconnectCount("opened"),i.resolve()},o=async u=>{var l;if(E.debug("[".concat(this.name,"] websocket close ").concat((l=this.websocket)===null||l===void 0?void 0:l.url,", code: ").concat(u.code,", reason: ").concat(u.reason,", current mode: ").concat(this.reconnectMode)),this.reconnectCount>=this.retryConfig.maxRetryCount)i.reject(new G(b.WS_DISCONNECT,"websocket close: ".concat(u.code))),this.close();else{this.state==="connected"&&(this.reconnectReason=u.reason,this.state="reconnecting");const p=Gi(this,It.WILL_RECONNECT,this.reconnectMode,u.reason)||this.reconnectMode,f=await this.reconnectWithAction(p);if(this.state==="closed")return void E.debug("[".concat(this.connectionID,"] ws is closed, no need to reconnect"));if(!f)return i.reject(new G(b.WS_DISCONNECT,"websocket reconnect failed: ".concat(u.code))),this.close(!0);i.resolve()}},s=u=>{this.emit(It.ON_MESSAGE,u)},a=u=>{E.warn("[".concat(this.connectionID,"] ws open error ").concat(u))};this.websocket&&(this.websocket.onclose=null,this.websocket.close()),N("GATEWAY_WSS_ADDRESS")&&this.name.startsWith("gateway")&&(e=N("GATEWAY_WSS_ADDRESS")),E.debug("[".concat(this.name,"] start connect, url:"),e);const c=(n=this.store)===null||n===void 0?void 0:n.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"gateway"});try{var d;const u=await this.chooseBestWebsocketConnection(e);this.websocket=u,r&&r(this.websocket.url),this.websocket.onclose=o,this.websocket.onmessage=s,this.websocket.onerror=a,(d=this.store)===null||d===void 0||d.recordJoinChannelService({endTs:Date.now(),status:"success"},c),this.joinGatewayRecordIndex=c}catch(u){const l=this.state==="closed",p=u instanceof G,f=p&&u.code===b.WS_ABORT,C=p&&u.code===b.WS_ERR,m=p?u.message:u&&(u.reason||u.toString());E.warning("[choose-best-ws] chooseBestWebsocket error: ".concat(m)),this.store&&this.store.recordJoinChannelService({endTs:Date.now(),status:f?"aborted":"error",errors:[u]},c),l||C?(i.reject(l?new G(b.WS_DISCONNECT,"websocket is closed: ".concat(m)):new G(b.WS_ERR,"init websocket failed: ".concat(m))),C&&E.error("[".concat(this.name,"] init websocket failed: ").concat(m))):o&&o(u)}return i.promise}async reconnectWithAction(e){let n=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1];if(this.reconnectCount>=this.retryConfig.maxRetryCount||this.urls.length===0||this.state==="closed")return!1;E.warning("[choose-best-ws] action: =>",e),this.onlineReconnectListener||Xe.isOnline||!Xe.onlineWaiter||(this.onlineReconnectListener=Xe.onlineWaiter.then(()=>{this.onlineReconnectListener=void 0}));let i=!0;if(this.reconnectInterrupter=()=>i=!1,n){const s=xp(this.reconnectCount,this.retryConfig);E.debug("[".concat(this.name,"] wait ").concat(s,"ms to reconnect websocket, mode: ").concat(e)),await ot.race([wn(s),this.onlineReconnectListener||new ot(()=>{})])}if(this._state==="closed"||!i)return!1;this.reconnectCount+=1;const r=async(s,a)=>{this.emit(It.RECONNECT_CREATE_CONNECTION,a),await this.createWebSocketConnection(s)};try{if(e==="retry")this.emit(It.RECONNECT_WAITTING_FINISH,e),await r(this.urls[this.currentURLIndex],e);else if(e==="tryNext"){if(this.currentURLIndex+=1,this.currentURLIndex>=this.urls.length)return this.reconnectWithAction("recover",!1);E.debug("[".concat(this.name,"] websocket url length: ").concat(this.urls.length," current index: ").concat(this.currentURLIndex)),this.emit(It.RECONNECT_WAITTING_FINISH,e),await r(this.urls[this.currentURLIndex],e)}else e==="recover"&&(E.debug("[".concat(this.name,"] request new urls")),this.resetReconnectCount("recover mode"),this.emit(It.RECONNECT_WAITTING_FINISH,e),this.urls=await En(this,It.REQUEST_NEW_URLS),this.currentURLIndex=0,await r(this.urls[this.currentURLIndex],e))}catch(s){var o;E.error("[".concat(this.name,"] reconnect failed ").concat(s&&s.toString()));const a=s==null||(o=s.data)===null||o===void 0?void 0:o.desc;return Array.isArray(a)&&it(a).call(a,"dynamic key expired")?(this.emit(It.ON_TOKEN_PRIVILEGE_DID_EXPIRE),!1):this.reconnectWithAction(e,n)}return!0}}class $u extends Ob{constructor(e,n){super(e,n,arguments.length>2&&arguments[2]!==void 0&&arguments[2],arguments.length>3&&arguments[3]!==void 0&&arguments[3],arguments.length>4&&arguments[4]!==void 0&&arguments[4],arguments.length>5?arguments[5]:void 0)}async chooseBestWebsocketConnection(e,n){const i=Ku(),r=function(s,a){return new Xj(s,a)}(this.forceCloseTimeout,this.store);this.closeEstablishingWs=()=>{E.debug("[choose-best-ws] close establishing websockets"),r.closeAllWebsockets(),i.reject(new G(b.WS_ABORT,"choose best websocket aborted"))};const o=N("GATEWAY_DOMAINS");return E.debug("[choose-best-ws] currentDomain: ",e,", domains: ",o,"total: ".concat(this.urls.length),"current: ".concat(this.currentURLIndex+1)),r.chooseBestWebsocket(e,this.tryDoubleDomain,this.use443PortOnly,n).then(i.resolve).catch(i.reject),i.promise.finally(()=>{this.closeEstablishingWs=void 0})}}class tl extends Ob{constructor(e,n){super(e,n,arguments.length>2&&arguments[2]!==void 0&&arguments[2],arguments.length>3&&arguments[3]!==void 0&&arguments[3],arguments.length>4&&arguments[4]!==void 0&&arguments[4],arguments.length>5?arguments[5]:void 0)}async chooseBestWebsocketConnection(e,n){return new ot((i,r)=>{let o=!1;const s=[];this.closeEstablishingWs=()=>{E.debug("[choose-best-ws] close establishing websockets"),s.forEach(C=>{C.onclose=null,C.onopen=null,C.onmessage=null,C.close()}),r(new G(b.WS_ABORT,"choose best websocket aborted"))};const a=N("GATEWAY_DOMAINS");let c;const d=e.indexOf("?h="),u=a.find(C=>d!==-1?it(e).call(e,C,d):it(e).call(e,C));E.debug("[choose-best-ws] currentDomain: ",u,", domains: ",a);let l=!this.tryDoubleDomain||!u;if(!l&&u){var p;const C=Date.now();try{a.forEach(m=>{const g=d===-1?e.replace(u,m):e.substr(0,d)+e.substr(d).replace(u,m),y=new WebSocket(g);y.binaryType="arraybuffer",s.push(y),E.debug("[choose-best-ws] ws is connecting:",y.url)})}catch{for(E.debug("[choose-best-ws] ws create failed, fallback to single url"),s.forEach(g=>g.close());s.length;)s.pop();l=!0}(p=this.store)===null||p===void 0||p.recordJoinChannelService({urls:s.map(m=>m.url),service:"gateway"},n),s.forEach(m=>{m.onopen=()=>{if(o)return;const g=Date.now()-C;E.debug("[choose-best-ws] ws open cost ".concat(g,"ms")),s.filter(y=>y!==m).forEach(y=>{E.debug("[choose-best-ws]close backup websocket: ".concat(y.url)),y.close()}),o=!0,i(m)},m.onclose=g=>{c=g,!o&&(s.find(y=>!(y.readyState===WebSocket.CLOSED||y.readyState===WebSocket.CLOSING))||(E.debug("[choose-best-ws] all websocket is closed"),o=!0,r(c)))},m.onmessage=g=>{E.debug("[choose-best-ws]".concat(m.url," onmessage: ").concat(g.data))}}),wn(this.forceCloseTimeout).then(()=>{s.forEach(m=>{m.readyState!==WebSocket.OPEN&&m.close()})})}if(l){var f;let C;E.debug("[choose-best-ws] use single url: ",e),(f=this.store)===null||f===void 0||f.recordJoinChannelService({urls:[e],service:"gateway"},n);try{C=new WebSocket(e),s.push(C),C.binaryType="arraybuffer"}catch(m){const g=new G(b.WS_ERR,"init websocket failed! Error: ".concat(m.toString()));return E.error("[".concat(this.name,"]").concat(g)),void r(g)}C.onopen=()=>{i(C)},C.onclose=m=>{r(m)},C.onmessage=m=>{E.debug("[choose-best-ws]".concat(C.url," onmessage: ").concat(m.data))},wn(this.forceCloseTimeout).then(()=>{C&&C.readyState!==WebSocket.OPEN&&C.close()})}}).then(i=>(this.closeEstablishingWs=void 0,i)).catch(i=>{throw this.closeEstablishingWs=void 0,i})}}class Nb extends Ve{get connectionState(){return this._connectionState}set connectionState(e){e!==this._connectionState&&(this._connectionState=e,e===Gt.CONNECTED?this.emit(ht.WS_CONNECTED):e===Gt.RECONNECTING?this.emit(ht.WS_RECONNECTING,this._websocketReconnectReason):e===Gt.CLOSED&&this.emit(ht.WS_CLOSED,this._disconnectedReason))}get currentURLIndex(){return this.websocket.currentURLIndex}get url(){return this.websocket&&this.websocket.url||null}get rtt(){return this.rttRolling.mean()}constructor(e,n){super(),R(this,"_disconnectedReason",void 0),R(this,"_websocketReconnectReason",void 0),R(this,"_connectionState",Gt.CLOSED),R(this,"reconnectToken",void 0),R(this,"websocket",void 0),R(this,"openConnectionTime",void 0),R(this,"clientId",void 0),R(this,"lastMsgTime",Date.now()),R(this,"uploadCache",[]),R(this,"uploadCacheInterval",void 0),R(this,"rttRolling",new Jm(5)),R(this,"pingpongTimer",void 0),R(this,"wsInflateDataTimer",void 0),R(this,"pingpongTimeoutCount",0),R(this,"joinResponse",void 0),R(this,"multiIpOption",void 0),R(this,"initError",void 0),R(this,"spec",void 0),R(this,"store",void 0),R(this,"onWebsocketMessage",i=>{if(i.data instanceof ArrayBuffer)return void this.emit(ht.ON_BINARY_DATA,i.data);const r=JSON.parse(i.data);if(this.lastMsgTime=Date.now(),Object.prototype.hasOwnProperty.call(r,"_id")){const o="res-@".concat(r._id);this.emit(o,r._result,r._message)}else if(Object.prototype.hasOwnProperty.call(r,"_type")){if(this.emit(r._type,r._message),r._type===Nt.ON_NOTIFICATION&&this.handleNotification(r._message),r._type===Nt.ON_USER_BANNED)switch(r._message.error_code){case 14:this.close(Ht.UID_BANNED);break;case 15:this.close(Ht.IP_BANNED);break;case 16:this.close(Ht.CHANNEL_BANNED)}if(r._type===Nt.ON_USER_LICENSE_BANNED)switch(r._message.error_code){case Rt.ERR_LICENSE_MISSING:this.close(Ht.LICENSE_MISSING);break;case Rt.ERR_LICENSE_EXPIRED:this.close(Ht.LICENSE_EXPIRED);break;case Rt.ERR_LICENSE_MINUTES_EXCEEDED:this.close(Ht.LICENSE_MINUTES_EXCEEDED);break;case Rt.ERR_LICENSE_PERIOD_INVALID:this.close(Ht.LICENSE_PERIOD_INVALID);break;case Rt.ERR_LICENSE_MULTIPLE_SDK_SERVICE:this.close(Ht.LICENSE_MULTIPLE_SDK_SERVICE);break;case Rt.ERR_LICENSE_ILLEGAL:this.close(Ht.LICENSE_ILLEGAL);break;default:this.close()}}}),this.clientId=e.clientId,this.spec=e,this.store=n,this.websocket=new $u("gateway-".concat(this.clientId),this.spec.retryConfig,!0,N("JOIN_GATEWAY_USE_DUAL_DOMAIN"),N("JOIN_GATEWAY_USE_443PORT_ONLY"),n),this.handleWebsocketEvents(),window.addEventListener("offline",()=>{this.connectionState===Gt.CONNECTED&&this.reconnect("retry",Kn.OFFLINE)})}async request(e,n,i,r){const o=be(6,""),s={_id:o,_type:e,_message:n},a=this.websocket.connectionID,c=()=>new ot((C,m)=>{if(this.connectionState===Gt.CONNECTED)return C();const g=()=>{this.off(ht.WS_CLOSED,y),C()},y=()=>{this.off(ht.WS_CONNECTED,g),m(new U(b.WS_ABORT))};this.once(ht.WS_CONNECTED,g),this.once(ht.WS_CLOSED,y),e!==Tt.PUBLISH&&e!==Tt.PUBLISH_DATASTREAM&&e!==Tt.SUBSCRIBE&&e!==Tt.SUBSCRIBE_DATASTREAM&&e!==Tt.UNSUBSCRIBE&&e!==Tt.UNSUBSCRIBE_DATASTREAM&&e!==Tt.UNPUBLISH&&e!==Tt.UNPUBLISH_DATASTREAM&&e!==Tt.CONTROL&&e!==Tt.RESTART_ICE||this.once(ht.DISCONNECT_P2P,()=>{m(new U(b.DISCONNECT_P2P))}),e!==Tt.PUBLISH&&e!==Tt.RESTART_ICE||this.once(ht.ABORT_P2P_EXECUTION,()=>{m(new U(b.DISCONNECT_P2P))})});if(this.connectionState!==Gt.CONNECTING&&this.connectionState!==Gt.RECONNECTING||e===Tt.JOIN||e===Tt.REJOIN||await c(),this.websocket.sendMessage(s,!0),r)return;const d=new ot((C,m)=>{let g=!1;const y=(k,M)=>{g=!0,C({isSuccess:k==="success",message:M||{}}),this.off(ht.WS_CLOSED,A),this.off(ht.WS_RECONNECTING,A),this.emit(ht.REQUEST_SUCCESS,e,n)};this.once("res-@".concat(o),y);const A=()=>{m(new U(b.WS_ABORT,"type: ".concat(e))),this.off(ht.WS_CLOSED,A),this.off(ht.WS_RECONNECTING,A),this.off("res-@".concat(o),y)};this.once(ht.WS_CLOSED,A),this.once(ht.WS_RECONNECTING,A),wn(N("SIGNAL_REQUEST_TIMEOUT")).then(()=>{this.websocket.connectionID!==a||g||(E.warning("[".concat(this.clientId,"] ws request timeout, type: ").concat(e)),this.emit(ht.REQUEST_TIMEOUT,e,n))})});let u=null;try{u=await d}catch(C){if(this.connectionState===Gt.CLOSED||e===Tt.LEAVE)throw new U(b.WS_ABORT);return!this.spec.forceWaitGatewayResponse||i?C.throw():e===Tt.JOIN||e===Tt.REJOIN?null:(await c(),await this.request(e,n))}if(u.isSuccess)return u.message;const l=Number(u.message.error_code||u.message.code),p=Ga(l),f=new U(b.UNEXPECTED_RESPONSE,"".concat(p.desc,": ").concat(u.message.error_str),{code:l,data:u.message});return p.action==="success"?u.message:(E.warning("[".concat(this.clientId,"] [").concat(this.websocket.connectionID,"] unexpected response from type ").concat(e,", error_code: ").concat(l,", message: ").concat(p.desc,", action: ").concat(p.action)),l===Rt.ERR_TOO_MANY_BROADCASTERS?((e===Tt.JOIN||e===Tt.REJOIN)&&(this.initError=f,this.close()),f.throw()):p.action==="failed"?f.throw():p.action==="quit"?(this.initError=f,this.close(),f.throw()):(l===Rt.ERR_JOIN_BY_MULTI_IP?(this.multiIpOption=u.message.option,E.warning("[".concat(this.clientId,"] detect multi ip, recover")),this.reconnect("recover",Kn.MULTI_IP)):this.reconnect(p.action,Kn.SERVER_ERROR),e===Tt.JOIN||e===Tt.REJOIN?null:await this.request(e,n)))}waitMessage(e,n){return new ot(i=>{const r=o=>{(!n||n(o))&&(this.off(e,r),i(o))};this.on(e,r)})}uploadWRTCStats(e){if(!this.store.sessionId)return void E.warn("[".concat(this.clientId,"] no session id when upload wrtc stats"));const n={lts:Date.now(),sid:this.store.sessionId,uid:this.store.intUid,stats:e};this.upload(Ba.WRTC_STATS,n)}upload(e,n){const i={_type:e,_message:n};try{this.websocket.sendMessage(i)}catch{const o=N("MAX_UPLOAD_CACHE")||50;this.uploadCache.push(i),this.uploadCache.length>o&&this.uploadCache.splice(0,1),this.uploadCache.length>0&&!this.uploadCacheInterval&&(this.uploadCacheInterval=window.setInterval(()=>{if(this.connectionState!==Gt.CONNECTED)return;const s=this.uploadCache.splice(0,1)[0];this.uploadCache.length===0&&(window.clearInterval(this.uploadCacheInterval),this.uploadCacheInterval=void 0),this.upload(s._type,s._message)},N("UPLOAD_CACHE_INTERVAL")||2e3))}}send(e,n){const i={_type:e,_message:n};this.websocket.sendMessage(i)}init(e,n){return this.initError=void 0,this.multiIpOption=void 0,this.joinResponse=void 0,this.reconnectToken=void 0,this.openConnectionTime=void 0,new ot((i,r)=>{this.once(ht.WS_CONNECTED,()=>i(this.joinResponse)),this.once(ht.WS_CLOSED,()=>r(this.initError||new U(b.WS_ABORT))),this.connectionState=Gt.CONNECTING,this.websocket.init(e).catch(r),this.wsInflateDataTimer&&window.clearInterval(this.wsInflateDataTimer),this.wsInflateDataTimer=window.setInterval(()=>{this.handleWsInflateData()},2e4)})}close(e){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.wsInflateDataTimer&&(this.handleWsInflateData(),window.clearInterval(this.wsInflateDataTimer),this.wsInflateDataTimer=void 0),this.reconnectToken=void 0,this.joinResponse=void 0,this._disconnectedReason=e||Ht.LEAVE,this.connectionState=Gt.CLOSED,E.debug("[".concat(this.clientId,"] ")+"will close websocket in signal"),this.websocket.close(),e===Ht.FALLBACK&&(this.websocket.removeAllListeners(),this.websocket=new $u("gateway-".concat(this.clientId),this.spec.retryConfig,!0,N("JOIN_GATEWAY_USE_DUAL_DOMAIN"),N("JOIN_GATEWAY_USE_443PORT_ONLY"),this.store),this.handleWebsocketEvents())}async join(){if(!this.joinResponse){this.emit(ht.ABORT_P2P_EXECUTION);const e=await En(this,ht.REQUEST_JOIN_INFO),n=await this.request(Tt.JOIN,e);if(!n)return this.emit(ht.REPORT_JOIN_GATEWAY,Zu.TIMEOUT,this.url||""),!1;this.joinResponse=n,this.emit(ht.JOIN_RESPONSE,this.joinResponse),this.reconnectToken=this.joinResponse.rejoin_token}return this.connectionState=Gt.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),!0}async rejoin(){if(!this.reconnectToken)throw new U(b.UNEXPECTED_ERROR,"can not rejoin, no rejoin token");const e=Ua(this,ht.REQUEST_REJOIN_INFO);e.token=this.reconnectToken;const n=await this.request(Tt.REJOIN,e);return!!n&&(this.connectionState=Gt.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),n.peers&&n.peers.forEach(i=>{this.emit(Nt.ON_USER_ONLINE,{uid:i.uid}),i.audio&&this.emit(Nt.ON_ADD_AUDIO_STREAM,{uid:i.uid,uint_id:i.uint_id,audio:!0,ssrcId:i.audio_ssrc}),i.video&&this.emit(Nt.ON_ADD_VIDEO_STREAM,{uid:i.uid,uint_id:i.uint_id,video:!0,ssrcId:i.video_ssrc}),i.audio_mute?this.emit(Nt.MUTE_AUDIO,{uid:i.uid}):this.emit(Nt.UNMUTE_AUDIO,{uid:i.uid}),i.video_mute?this.emit(Nt.MUTE_VIDEO,{uid:i.uid}):this.emit(Nt.UNMUTE_VIDEO,{uid:i.uid}),i.audio_enable_local?this.emit(Nt.ENABLE_LOCAL_AUDIO,{uid:i.uid}):this.emit(Nt.DISABLE_LOCAL_AUDIO,{uid:i.uid}),i.video_enable_local?this.emit(Nt.ENABLE_LOCAL_VIDEO,{uid:i.uid}):this.emit(Nt.DISABLE_LOCAL_VIDEO,{uid:i.uid}),i.audio||i.video||this.emit(Nt.ON_REMOVE_STREAM,{uid:i.uid,uint_id:i.uint_id})}),!0)}reconnect(e,n){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.websocket.reconnect(e,n)}handleNotification(e){E.debug("[".concat(this.clientId,"] receive notification: "),e);const n=Ga(e.code);if(n.action!=="success"){if(n.action!=="failed")return n.action==="quit"?(n.desc==="ERR_REPEAT_JOIN_CHANNEL"&&this.close(Ht.UID_BANNED),void this.close()):void this.reconnect(n.action,Kn.SERVER_ERROR);E.error("[".concat(this.clientId,"] ignore error: "),n.desc)}}handlePingPong(){if(!this.websocket||this.websocket.state!=="connected")return;this.pingpongTimeoutCount>0&&this.rttRolling.add(3e3),this.pingpongTimeoutCount+=1;const e=N("PING_PONG_TIME_OUT"),n=Date.now();this.pingpongTimeoutCount>=e&&(E.warning("[".concat(this.clientId,"] PING-PONG Timeout. Last Socket Message: ").concat(n-this.lastMsgTime,"ms")),n-this.lastMsgTime>N("WEBSOCKET_TIMEOUT_MIN"))?this.reconnect("retry",Kn.TIMEOUT):this.request(Tt.PING,void 0,!0).then(()=>{this.pingpongTimeoutCount=0;const i=Date.now()-n;this.rttRolling.add(i),N("REPORT_STATS")&&this.send(Tt.PING_BACK,{pingpongElapse:i})}).catch(i=>{})}handleWsInflateData(){const{wsInflateLength:e,wsDeflateLength:n}=this.websocket.getWsInflateData();e!==0&&n!==0&&this.upload(Ba.WS_INFLATE_DATA_LENGTH,{ws_deflate_length:n,ws_inflate_length:e})}handleWebsocketEvents(){this.websocket.on(It.RECONNECT_WAITTING_FINISH,e=>{this.emit(ht.WS_RECONNECT_WAITTING_FINISH,e)}),this.websocket.on(It.RECONNECT_CREATE_CONNECTION,e=>{this.emit(ht.WS_RECONNECT_CREATE_CONNECTION,e)}),this.websocket.on(It.ON_MESSAGE,this.onWebsocketMessage),this.websocket.on(It.CLOSED,()=>{this.connectionState=Gt.CLOSED}),this.websocket.on(It.FAILED,()=>{this._disconnectedReason=Ht.NETWORK_ERROR,this.connectionState=Gt.CLOSED}),this.websocket.on(It.RECONNECTING,e=>{this._websocketReconnectReason=e,this.joinResponse=void 0,this.connectionState===Gt.CONNECTED?this.connectionState=Gt.RECONNECTING:this.connectionState=Gt.CONNECTING}),this.websocket.on(It.WILL_RECONNECT,(e,n,i)=>{const r=Ua(this,ht.IS_P2P_DISCONNECTED),o=r||e!=="retry";r&&e==="retry"&&(E.debug("".concat(this.clientId," reconnect mode is retry, but p2p lost, change to tryNext")),e="tryNext",n=Zu.P2P_DISCONNECTED),o&&(E.debug("".concat(this.clientId," will renewSession, reconnect mode: ").concat(e)),this.emit(ht.REPORT_JOIN_GATEWAY,n||Zu.UNKNOWN_REASON,this.url||""),this.reconnectToken=void 0,this.emit(ht.NEED_RENEW_SESSION,this.websocket.currentURLIndex>=this.websocket.urls.length-1?"recover":e),this.emit(ht.DISCONNECT_P2P)),i(e)}),this.websocket.on(It.CONNECTED,()=>{this.openConnectionTime=Date.now(),this.reconnectToken?this.rejoin().catch(e=>{E.warning("[".concat(this.clientId,"] rejoin failed ").concat(e)),this.reconnect("tryNext",Kn.SERVER_ERROR)}):this.join().catch(e=>{if(this.emit(ht.REPORT_JOIN_GATEWAY,e.message||e.code||Zu.UNKNOWN_REASON,this.url||""),e instanceof U){if(e.code===b.UNEXPECTED_RESPONSE&&e.data.code===Rt.ERR_NO_AUTHORIZED)return this.initError=new U(b.CAN_NOT_GET_GATEWAY_SERVER,"AgoraRTCError CAN_NOT_GET_GATEWAY_SERVER: dynamic key expired"),E.warning("[".concat(this.clientId,"] reconnect no authorized, recover")),void this.reconnect("recover",Kn.SERVER_ERROR);E.error("[".concat(this.clientId,"] join gateway request failed"),e.toString()),this.spec.forceWaitGatewayResponse?this.reconnect("tryNext",Kn.SERVER_ERROR):(this.initError=e,this.close())}})}),this.websocket.on(It.REQUEST_NEW_URLS,(e,n)=>{En(this,ht.REQUEST_RECOVER,this.multiIpOption).then(e).catch(n)}),this.websocket.on(It.ON_TOKEN_PRIVILEGE_DID_EXPIRE,()=>{this.emit(Nt.ON_TOKEN_PRIVILEGE_DID_EXPIRE)})}}let un=function(t){return t[t.CHOOSE_SERVER=11]="CHOOSE_SERVER",t[t.CLOUD_PROXY=18]="CLOUD_PROXY",t[t.CLOUD_PROXY_5=20]="CLOUD_PROXY_5",t[t.CLOUD_PROXY_FALLBACK=26]="CLOUD_PROXY_FALLBACK",t}({});function Db(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),n.push.apply(n,i)}return n}function Yp(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?Db(Object(n),!0).forEach(function(i){R(t,i,n[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):Db(Object(n)).forEach(function(i){Object.defineProperty(t,i,Object.getOwnPropertyDescriptor(n,i))})}return t}function Xs(t){return t.match(/^[\.\:\d]+$/)?"".concat(t.replace(/[^\d]/g,"-"),".").concat(N("TURN_DOMAIN")):(E.info("Unidentified as ip: ".concat(t,", use as host")),t)}function hg(t,e){t.addresses||(t.addresses=[]);const n=function(o,s){if(N("CONNECT_GATEWAY_WITHOUT_DOMAIN"))return o.map(d=>{let{ip:u,port:l}=d;return{address:"".concat(u,":").concat(l)}});const a=N("GATEWAY_DOMAINS");let c=a[1]&&it(s).call(s,a[1])?1:0;return o.map(d=>{let{domain_prefix:u,port:l,ip:p}=d;if(u)return{address:"".concat(u,".").concat(a[c++%a.length],":").concat(l)};const f=/^[\.\:\d]+$/.test(p),C=f?"".concat(p.replace(/[^\d]/g,"-"),".").concat(a[c++%a.length],":").concat(l):"".concat(p,":").concat(l);return f||E.info("Unidentified as ip: ".concat(p,", use as host")),{ip:p,port:l,address:C}})}(t.addresses,e),i=Array.isArray(t.detail)&&t.detail[18];if(i&&typeof i=="string"){const o=i.split(";");for(let s=0;s<o.length;s++){var r;const a=si(r=o[s]).call(r);n[s]&&a&&(n[s].ip6=a)}}return{gatewayAddrs:n,uid:t.uid,cid:t.cid,cert:t.cert,vid:t.detail&&t.detail[8],uni_lbs_ip:t.detail&&t.detail[1],res:t,csIp:t.detail&&t.detail[502]}}function Pi(t){return typeof t=="number"?t:t.exact||t.ideal||t.max||t.min||0}function Pb(t){const e=t._encoderConfig;if(!e)return{};const n={resolution:e.width&&e.height?"".concat(Pi(e.width),"x").concat(Pi(e.height)):void 0,maxVideoBW:e.bitrateMax,minVideoBW:e.bitrateMin};return typeof e.frameRate=="number"?(n.maxFrameRate=e.frameRate,n.minFrameRate=e.frameRate):e.frameRate&&(n.maxFrameRate=e.frameRate.max||e.frameRate.ideal||e.frameRate.exact||e.frameRate.min,n.minFrameRate=e.frameRate.min||e.frameRate.ideal||e.frameRate.exact||e.frameRate.max),n}function Lb(t){return t>=0&&t<.17?1:t>=.17&&t<.36?2:t>=.36&&t<.59?3:t>=.59&&t<=1?4:t>1?5:0}function el(t,e){let n,i,r;switch(e){case un.CHOOSE_SERVER:i=4096,r="choose server";break;case un.CLOUD_PROXY:i=1048576,r="proxy";break;case un.CLOUD_PROXY_5:i=4194304,r="proxy5";break;case un.CLOUD_PROXY_FALLBACK:i=4194310,r="proxy fallback";break;default:throw new U(b.UNEXPECTED_ERROR,"multi unlibs response transformer get unknown service id",{csIp:t.detail&&t.detail[502],retry:!1})}if(t.response_body.forEach(o=>{o.buffer&&o.buffer.flag===i&&(n={code:o.buffer.code,addresses:(o.buffer.edges_services||[]).map(s=>Yp(Yp({},s),{},{ticket:o.buffer.cert})),server_ts:t.enter_ts,uid:o.buffer.uid,cid:o.buffer.cid,cname:o.buffer.cname,detail:Yp(Yp({},o.buffer.detail),t.detail),flag:o.buffer.flag,opid:t.opid,cert:o.buffer.cert})}),!n)throw new U(b.MULTI_UNILBS_RESPONSE_ERROR,"cannot parse response ".concat(r," from multi unilbs response"),{csIp:t.detail&&t.detail[502]});return n}async function kb(t,e){return await ot.all(t.addresses.map(async n=>({address:Xs(n.ip),tcpport:n.port,udpport:n.port,username:e&&N("ENCRYPT_PROXY_USERNAME_AND_PSW")&&window.isSecureContext?e.toString():qn.username,password:e&&N("ENCRYPT_PROXY_USERNAME_AND_PSW")&&window.isSecureContext?await qm(e.toString()):qn.password})))}function pg(t,e){const n=e.getMediaStreamTrack(!0).getSettings(),i=e.videoHeight||n.height,r=e.videoWidth||n.width;return i&&r?Math.max(Math.min(i,r)/Math.min(Pi(t.height),Pi(t.width)),1):(E.warning("can't get ori-track's height, default scale down 4 times for low stream"),4)}function Qs(t){let{candidateType:e,relayProtocol:n,type:i,address:r,port:o,protocol:s}=t;return i==="local-candidate"?{candidateType:e,relayProtocol:n,protocol:s}:{candidateType:e,relayProtocol:n,address:r,port:o,protocol:s}}function Mb(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),n.push.apply(n,i)}return n}class Qj extends Ve{get url(){return this._url?this._url:null}get reconnectMode(){return this._reconnectMode}set reconnectMode(e){var n;it(n=["tryNext","recover"]).call(n,e)&&this.resetReconnectCount(e),this._reconnectMode=e}get state(){return this._state}set state(e){e!==this._state&&(this._state=e,this._state==="reconnecting"?this.emit(mn.RECONNECTING,this.reconnectReason):this._state==="connected"?this.emit(mn.CONNECTED):this._state==="closed"?this.emit(mn.CLOSED):this._state==="failed"&&this.emit(mn.FAILED))}constructor(e,n,i,r){super(),R(this,"connectionID",0),R(this,"currentURLIndex",0),R(this,"reconnectReason",void 0),R(this,"_reconnectMode","tryNext"),R(this,"_initMutex",void 0),R(this,"_name",void 0),R(this,"_state","closed"),R(this,"_reconnectInterrupter",void 0),R(this,"_url",void 0),R(this,"_retryConfig",void 0),R(this,"_reconnectCount",0),R(this,"_forceCloseTimeout",5e3),R(this,"_onlineReconnectListener",void 0),R(this,"_closeEstablishingTransmitter",()=>{}),R(this,"_store",void 0),R(this,"_joinChannelServiceRecordIndex",void 0),R(this,"_transmitter",void 0),R(this,"_useCompress",void 0),R(this,"_inflateLength",0),R(this,"_deflateLength",0),this._store=r,this._name=e,this._retryConfig=function(o){for(var s=1;s<arguments.length;s++){var a=arguments[s]!=null?arguments[s]:{};s%2?Mb(Object(a),!0).forEach(function(c){R(o,c,a[c])}):Object.getOwnPropertyDescriptors?Object.defineProperties(o,Object.getOwnPropertyDescriptors(a)):Mb(Object(a)).forEach(function(c){Object.defineProperty(o,c,Object.getOwnPropertyDescriptor(a,c))})}return o}({},n),this._useCompress=i}resetReconnectCount(e){E.debug("".concat(this._name," reset reconnect count, reason: ").concat(e)),this._reconnectCount=0}close(e,n){if(this.currentURLIndex=0,this.resetReconnectCount("close"),this._reconnectInterrupter&&this._reconnectInterrupter(),this._transmitter){this._transmitter.onclose=null,this._transmitter.onopen=null,this._transmitter.onmessage=null;const i=this._transmitter;n?setTimeout(()=>i.close(),500):i.close(),this._transmitter=void 0}this.state=e?"failed":"closed",this._closeEstablishingTransmitter&&this._closeEstablishingTransmitter()}reconnect(e,n){if(!this._transmitter)return void E.warning("[".concat(this._name,"] can not reconnect, no websocket"));var i;e!==void 0&&(this.reconnectMode=e),E.debug("[".concat(this._name,"] reconnect is triggered initiative")),typeof this._joinChannelServiceRecordIndex=="number"&&((i=this._store)===null||i===void 0||i.recordJoinChannelService({status:"error",errors:[new Error(n)]},this._joinChannelServiceRecordIndex));const r=this._transmitter.onclose;this._transmitter.onclose=null,this._transmitter.close(),r&&r.bind(this._transmitter)({code:9999,reason:n})}getInflateData(){const e=this._inflateLength,n=this._deflateLength;return this.clearInflateData(),{inflateLength:e,deflateLength:n}}setInflateData(e){this._deflateLength=this._deflateLength+e.originLength,this._inflateLength=this._inflateLength+e.compressedLength}clearInflateData(){this._inflateLength=0,this._deflateLength=0}}let uo=function(t){return t[t.Default=0]="Default",t[t.Ack=1]="Ack",t}({});class Zj{constructor(e,n,i){R(this,"version",1),R(this,"initialRTO",void 0),R(this,"maxBatchAckCount",void 0),R(this,"maxRTO",void 0),R(this,"initialRTT",void 0),R(this,"ID",void 0),R(this,"rtt",void 0),R(this,"packetNumber",1),R(this,"rtoRatioMap",new Map),R(this,"timeoutMap",new Map),R(this,"unorderedPacketQueue",[]),R(this,"batchAckPacketQueue",[]),R(this,"lastOrderedPacketNumber",0),R(this,"batchAckTimer",void 0),R(this,"sendImpl",void 0),R(this,"receiveImpl",void 0),this.sendImpl=e,this.receiveImpl=n,this.ID=be(7,"transmitter-"),this.initialRTO=(i==null?void 0:i.initialRTO)!==void 0?i.initialRTO:N("TRANSMITTER_INITIAL_RTO"),this.initialRTT=(i==null?void 0:i.initialRTT)!==void 0?i.initialRTT:N("TRANSMITTER_INITIAL_RTT"),this.rtt=(i==null?void 0:i.initialRTT)!==void 0?i.initialRTT:N("TRANSMITTER_INITIAL_RTT"),this.maxBatchAckCount=(i==null?void 0:i.maxBatchAckCount)!==void 0?i.maxBatchAckCount:N("TRANSMITTER_MAX_BATCH_ACK_COUNT"),this.maxRTO=(i==null?void 0:i.maxRTO)!==void 0?i.maxRTO:N("TRANSMITTER_MAX_RTO")}packetize(e,n){return{type:uo.Default,version:this.version,packetNumber:n,payload:e}}serialize(e){switch(e.type){case uo.Default:{let n;typeof e.payload=="string"?n=new TextEncoder().encode(e.payload):n=e.payload;const i=new ArrayBuffer(n.length+15),r=new DataView(i);return r.setUint16(0,e.version),r.setUint8(2,e.type),r.setUint32(3,e.packetNumber),HI(r,7,BigInt(e.sendTs)),new Uint8Array(r.buffer).set(n,15),i}case uo.Ack:{const n=new ArrayBuffer(16),i=new DataView(n);return i.setUint16(0,e.version),i.setUint8(2,e.type),i.setUint32(3,e.maxAckPacketNumber),i.setUint8(7,e.shift),HI(i,8,BigInt(e.ackSendTs)),n}}}deserialize(e){const n=new DataView(e),i=n.getUint16(0),r=n.getUint8(2);switch(r){case uo.Default:{const o=n.getUint32(3),s=WI(n,7),a=e.slice(15),c=new TextDecoder().decode(a);return{version:i,type:r,packetNumber:o,sendTs:Number(s),payload:c}}case uo.Ack:{const o=n.getUint32(3),s=n.getUint8(7),a=WI(n,8);return{version:i,type:r,maxAckPacketNumber:o,shift:s,ackSendTs:Number(a)}}default:throw E.error("[".concat(this.ID,"] Unrecognized packet type ").concat(r)),new Error("Unrecognized packet type ".concat(r))}}sendMessage(e){const n=this.packetize(e,this.packetNumber);this.packetNumber=this.packetNumber===4294967295?1:this.packetNumber+1;const i=this.calculateRTO(n),r=window.setTimeout(()=>{this.resendMessage(n)},i);this.timeoutMap.set(n.packetNumber,r),this.sendPacket(n)}onData(e){const n=this.deserialize(e);n.type===uo.Default?this.ack(n):n.type===uo.Ack&&(this.updateRTT(n,Math.round(performance.now())),this.clearRTO(n))}close(){this.rtt=this.initialRTT,this.packetNumber=1,Array.from(this.timeoutMap.entries()).forEach(e=>{let[n,i]=e;window.clearTimeout(i)}),this.timeoutMap=new Map,this.rtoRatioMap=new Map,this.unorderedPacketQueue=[],this.batchAckPacketQueue=[],this.lastOrderedPacketNumber=0,this.batchAckTimer!==void 0&&window.clearTimeout(this.batchAckTimer)}resendMessage(e){const n=this.calculateRTO(e),i=window.setTimeout(()=>{this.resendMessage(e)},n);this.timeoutMap.set(e.packetNumber,i),this.sendPacket(e)}calculateRTO(e){const n=this.rtoRatioMap.get(e.packetNumber);if(n===void 0)return this.rtoRatioMap.set(e.packetNumber,1),this.initialRTO;{const i=9*this.rtt/8*n;return this.rtoRatioMap.set(e.packetNumber,n+1),i>this.maxRTO?this.maxRTO:i}}updateRTT(e,n){const i=e.ackSendTs;this.rtt=this.rtt*(7/8)+(n-i-this.rtt)/8}ack(e){if(e.packetNumber===this.lastOrderedPacketNumber+1)for(this.batchAckPacketQueue.length>=this.maxBatchAckCount&&this.batchAck(),this.batchAckTimer?this.batchAckPacketQueue.push(e):(this.batchAckPacketQueue.push(e),this.batchAckTimer=window.setTimeout(()=>{this.batchAck()},this.rtt/8)),this.lastOrderedPacketNumber+=1,this.receiveImpl(e.payload);;){const n=this.unorderedPacketQueue[0];if(!n){this.unorderedPacketQueue.shift();break}this.batchAckTimer&&this.batchAck(),this.receiveImpl(n.payload),this.unorderedPacketQueue.shift(),this.lastOrderedPacketNumber+=1}else if(e.packetNumber<=this.lastOrderedPacketNumber){const n={ackSendTs:e.sendTs,maxAckPacketNumber:e.packetNumber,shift:0,type:uo.Ack,version:this.version};this.sendPacket(n)}else if(e.packetNumber>this.lastOrderedPacketNumber){this.unorderedPacketQueue[e.packetNumber-this.lastOrderedPacketNumber-2]=e;const n={ackSendTs:e.sendTs,maxAckPacketNumber:e.packetNumber,shift:0,type:uo.Ack,version:this.version};this.sendPacket(n)}}batchAck(){window.clearTimeout(this.batchAckTimer),this.batchAckTimer=void 0;const e={ackSendTs:this.batchAckPacketQueue[this.batchAckPacketQueue.length-1].sendTs,maxAckPacketNumber:this.batchAckPacketQueue[this.batchAckPacketQueue.length-1].packetNumber,shift:this.batchAckPacketQueue.length-1,type:uo.Ack,version:this.version};this.sendPacket(e),this.batchAckPacketQueue=[]}sendPacket(e){e.type===uo.Default&&(e.sendTs=Math.round(performance.now()));const n=this.serialize(e);this.sendImpl(n)}clearRTO(e){for(let n=e.maxAckPacketNumber-e.shift;n<=e.maxAckPacketNumber;n++){const i=this.timeoutMap.get(n);i!==void 0&&window.clearTimeout(i),this.timeoutMap.delete(n),this.rtoRatioMap.delete(n)}}}class Ub extends Qj{constructor(e,n){super(e,n,arguments.length>2&&arguments[2]!==void 0&&arguments[2],arguments.length>3?arguments[3]:void 0),R(this,"_initMutex",void 0),R(this,"_reconnectInterrupter",void 0),R(this,"_url",void 0),R(this,"_transmitter",void 0),R(this,"_addresses",void 0),R(this,"_reliableTransmission",void 0),this._initMutex=new kn("datachannel");const{timeout:i,timeoutFactor:r}=n,o=Math.max(300,Math.floor(3*i/5)),s=Math.max(1.2,Math.floor(8*r)/10);_i.ONLINE&&(this._retryConfig.timeout=o,this._retryConfig.timeoutFactor=s),Xe.on(Ma.NETWORK_STATE_CHANGE,(a,c)=>{a!==c&&(this.resetReconnectCount("network state change: ".concat(c," -> ").concat(a)),a===_i.ONLINE?(this._retryConfig.timeout=o,this._retryConfig.timeoutFactor=s):(this._retryConfig.timeout=i,this._retryConfig.timeoutFactor=r))})}getConnection(){if(this._reliableTransmission)return this._reliableTransmission}async init(e){let n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:5e3;this._forceCloseTimeout=n;const i=(r,o)=>{this._addresses=e,this.currentURLIndex=this._addresses.findIndex(a=>a.fingerprint||N("FINGERPRINT"));const s=this._addresses[this.currentURLIndex];this.state="connecting",this.createTransmitterConnection(s).then(r).catch(o),this.once(mn.CLOSED,()=>o(new U(b.WS_DISCONNECT))),this.once(mn.CONNECTED,()=>r())};return this._initMutex.lock().then(r=>new ot((o,s)=>{i(o,s)}).then(()=>{r()}).catch(()=>{r()}))}sendMessage(e){let n=arguments.length>2&&arguments[2]!==void 0&&arguments[2];if(!this._transmitter||!this._reliableTransmission)throw new U(b.WS_ABORT,"datachannel is not ready");try{n||(e=JSON.stringify(e)),this._reliableTransmission.sendMessage(e)}catch(i){throw new U(b.WS_ERR,"send datachannel signal message error"+i.toString())}}unbindDcCloseEventListener(){this._transmitter&&(this._transmitter.onclose=null)}sendMessageWithJSON(e){const n=JSON.stringify(e);return{compressed:n,compressedLength:n.length,origin:e}}sendMessageWithUint8Array(e){return{compressed:e,compressedLength:e.byteLength,origin:e}}createTransmitterConnection(e){return this.connectionID+=1,this._joinChannelServiceRecordIndex=void 0,this._url="dc://".concat(e.ip,":").concat(e.port),new ot((n,i)=>{var r;const o=()=>{E.debug("[".concat(this._name,"] datachannel opened:"),this._url),this.reconnectMode="retry",this.state="connected",this.resetReconnectCount("opened"),n()},s=async u=>{var l;if((l=this._closeEstablishingTransmitter)===null||l===void 0||l.call(this),E.debug("[".concat(this._name,"] datachannel close ").concat(this._url,", code: ").concat(u.code,", reason: ").concat(u.reason,", current mode: ").concat(this.reconnectMode)),this._reconnectCount<this._retryConfig.maxRetryCount){this.state==="connected"&&(this.reconnectReason=u.reason,this.state="reconnecting");const p=Gi(this,mn.WILL_RECONNECT,this.reconnectMode)||this.reconnectMode,f=await this.reconnectWithAction(p);if(this.state==="closed")return void E.debug("[".concat(this.connectionID,"] dc is closed, no need to reconnect"));if(!f)return i(new U(b.WS_DISCONNECT,"datachannel reconnect failed: ".concat(u.code))),void this.close(!0);n()}else i(new U(b.WS_DISCONNECT,"datachannel close: ".concat(u.code))),this.close()},a=u=>{var l;(l=this._reliableTransmission)===null||l===void 0||l.onData(u.data)};this._transmitter&&(this._transmitter.onclose=null,this._transmitter.close()),this._reliableTransmission&&(this._reliableTransmission.close(),this._reliableTransmission=void 0),E.debug("[".concat(this._name,"] start connect, address: ").concat(JSON.stringify(e)));const c=(r=this._store)===null||r===void 0?void 0:r.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"gateway"}),d=Date.now();En(this,mn.TO_CONNECT_DATACHANNEL,e).then(u=>{var l,p;if(!u)throw new Error("transmissonInfo not exist yet");const{transmitter:f,close:C}=u;this._transmitter=f,(l=this._store)===null||l===void 0||l.signalChannelOpen();const m=Date.now()-d;E.debug("[choose dc] dc open cost ".concat(m,"ms")),this._reliableTransmission=new Zj(g=>{var y;this._transmitter&&this._transmitter.readyState==="open"&&((y=this._transmitter)===null||y===void 0||y.send(g))},g=>{typeof g=="string"&&this.emit(mn.ON_MESSAGE,g)}),this._closeEstablishingTransmitter=()=>{var g;(g=this._reliableTransmission)===null||g===void 0||g.close(),this._reliableTransmission=void 0,C()},o&&o(),f.onclose=s,f.onmessage=a,(p=this._store)===null||p===void 0||p.recordJoinChannelService({endTs:Date.now(),status:"success"},c),this._joinChannelServiceRecordIndex=c}).catch(u=>{var l;if((l=this._store)===null||l===void 0||l.recordJoinChannelService({endTs:Date.now(),status:u instanceof U&&u.code===b.WS_ABORT?"aborted":"error",errors:[u]},c),this.state!=="closed"){if(u instanceof U&&u.code===b.WS_ERR){const p=new U(b.WS_ERR,"init datachannel failed! Error: ".concat(u.toString()));return E.error("[".concat(this._name,"]").concat(p)),void i(p)}s&&s(u)}else i(new U(b.WS_DISCONNECT,"datachannel is closed: ".concat(u.toString())))})})}async reconnectWithAction(e){let n=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1];if(this._reconnectCount>=this._retryConfig.maxRetryCount||!this._addresses||this.state==="closed")return!1;this._onlineReconnectListener||Xe.networkState!==_i.OFFLINE||(this._onlineReconnectListener=Xe.onlineWaiter&&Xe.onlineWaiter.then(()=>{this._onlineReconnectListener=void 0}));let i=!0;if(this._reconnectInterrupter=()=>{i=!1},n){const a=xp(this._reconnectCount,this._retryConfig);E.debug("[".concat(this._name,"] wait ").concat(a,"ms to reconnect datachannel, mode: ").concat(e)),await ot.race([wn(a),this._onlineReconnectListener||new ot(()=>{})])}if(this.state==="closed"||!i)return!1;this._reconnectCount+=1;const r=async(a,c)=>{this.emit(mn.RECONNECT_CREATE_CONNECTION,c),await this.createTransmitterConnection(a)};try{if(e==="retry"){const a=this._addresses[this.currentURLIndex];this.emit(mn.RECONNECT_WAITTING_FINISH,e),await r(a,e)}else if(e==="tryNext"){this.currentURLIndex+=1;for(let c=this.currentURLIndex;c<this._addresses.length;c++){if(this._addresses[c].fingerprint||N("FINGERPRINT")){this.currentURLIndex=c;break}this.currentURLIndex+=1}if(this.currentURLIndex>=this._addresses.length)return E.debug("[".concat(this._name,"] the available addresses are exhausted, change to recover")),await this.reconnectWithAction("recover",!1);E.debug("[".concat(this._name,"] datachannel url length: ").concat(this._addresses.length," current index: ").concat(this.currentURLIndex));const a=this._addresses[this.currentURLIndex];this.emit(mn.RECONNECT_WAITTING_FINISH,e),await r(a,e)}else e==="recover"&&(E.debug("[".concat(this._name,"] start to failback to websocket")),this.resetReconnectCount("recover mode"),this.emit(mn.RECONNECT_WAITTING_FINISH,e),this.emit(mn.FAILBACK));return!0}catch(a){var o,s;return E.error("[".concat(this._name,"] reconnect failed"),a.toString()),a!=null&&(o=a.data)!==null&&o!==void 0&&o.desc&&Array.isArray(a.data.desc)&&a.data.desc.length&&it(s=a.data.desc).call(s,"dynamic key expired")?(this.emit(mn.ON_TOKEN_PRIVILEGE_DID_EXPIRE),!1):await this.reconnectWithAction(e,n)}}}class Es extends Ve{get connectionState(){return this._connectionState}set connectionState(e){e!==this._connectionState&&(this._connectionState=e,e===Gt.CONNECTED?this.emit(ht.WS_CONNECTED):e===Gt.RECONNECTING?this.emit(ht.WS_RECONNECTING,this._websocketReconnectReason):e===Gt.CLOSED&&this.emit(ht.WS_CLOSED,this._disconnectedReason))}get currentURLIndex(){return this.websocket.currentURLIndex}get url(){return this.websocket?this.websocket.url:null}get rtt(){return this.rttRolling.mean()}constructor(e,n){super(),R(this,"_disconnectedReason",void 0),R(this,"_websocketReconnectReason",void 0),R(this,"_connectionState",Gt.CLOSED),R(this,"reconnectToken",void 0),R(this,"websocket",void 0),R(this,"openConnectionTime",void 0),R(this,"clientId",void 0),R(this,"lastMsgTime",Date.now()),R(this,"uploadCache",[]),R(this,"uploadCacheInterval",void 0),R(this,"rttRolling",new Jm(5)),R(this,"pingpongTimer",void 0),R(this,"inflateDataTimer",void 0),R(this,"pingpongTimeoutCount",0),R(this,"joinResponse",void 0),R(this,"multiIpOption",void 0),R(this,"initError",void 0),R(this,"spec",void 0),R(this,"store",void 0),R(this,"onWebsocketMessage",i=>{if(i instanceof ArrayBuffer)return void this.emit(ht.ON_BINARY_DATA,i);const r=JSON.parse(i);if(this.lastMsgTime=Date.now(),Object.prototype.hasOwnProperty.call(r,"_id")){const o="res-@".concat(r._id);this.emit(o,r._result,r._message)}else if(Object.prototype.hasOwnProperty.call(r,"_type")&&(this.emit(r._type,r._message),r._type===Nt.ON_NOTIFICATION&&this.handleNotification(r._message),r._type===Nt.ON_USER_BANNED))switch(r._message.error_code){case 14:this.close(Ht.UID_BANNED);break;case 15:this.close(Ht.IP_BANNED);break;case 16:this.close(Ht.CHANNEL_BANNED)}}),this.clientId=e.clientId,this.spec=e,this.store=n,this.websocket=new Ub("gateway-".concat(this.clientId),this.spec.retryConfig,!0,n),this.handleWebsocketEvents(),window.addEventListener("offline",()=>{this.connectionState===Gt.CONNECTED&&this.reconnect("retry",zs.OFFLINE)})}async request(e,n,i,r){const o=be(6,""),s={_id:o,_type:e,_message:n},a=this.websocket.connectionID,c=()=>new ot((C,m)=>{if(this.connectionState===Gt.CONNECTED)return C();const g=()=>{this.off(ht.WS_CLOSED,y),C()},y=()=>{this.off(ht.WS_CONNECTED,g),m(new U(b.WS_ABORT))};this.once(ht.WS_CONNECTED,g),this.once(ht.WS_CLOSED,y),e!==Tt.PUBLISH&&e!==Tt.SUBSCRIBE&&e!==Tt.UNSUBSCRIBE&&e!==Tt.UNPUBLISH&&e!==Tt.CONTROL&&e!==Tt.RESTART_ICE||this.once(ht.DISCONNECT_P2P,()=>{m(new U(b.DISCONNECT_P2P))}),e!==Tt.PUBLISH&&e!==Tt.RESTART_ICE||this.once(ht.ABORT_P2P_EXECUTION,()=>{m(new U(b.DISCONNECT_P2P))})});if(this.connectionState!==Gt.CONNECTING&&this.connectionState!==Gt.RECONNECTING||e===Tt.JOIN||e===Tt.REJOIN||await c(),e===Tt.LEAVE&&(this.websocket.unbindDcCloseEventListener(),r=!0),this.websocket.sendMessage(s,!0,!1),r)return;const d=new ot((C,m)=>{let g=!1;const y=(k,M)=>{g=!0,C({isSuccess:k==="success",message:M||{}}),this.off(ht.WS_CLOSED,A),this.off(ht.WS_RECONNECTING,A),this.emit(ht.REQUEST_SUCCESS,e,n)};this.once("res-@".concat(o),y);const A=()=>{m(new U(b.WS_ABORT,"type: ".concat(e))),this.off(ht.WS_CLOSED,A),this.off(ht.WS_RECONNECTING,A),this.off("res-@".concat(o),y)};this.once(ht.WS_CLOSED,A),this.once(ht.WS_RECONNECTING,A),wn(N("SIGNAL_REQUEST_TIMEOUT")).then(()=>{this.websocket.connectionID!==a||g||(E.warning("dc request timeout, type: ".concat(e)),this.emit(ht.REQUEST_TIMEOUT,e,n))})});let u=null;try{u=await d}catch(C){if(this.connectionState===Gt.CLOSED||e===Tt.LEAVE)throw new U(b.WS_ABORT);return!this.spec.forceWaitGatewayResponse||i?C.throw():e===Tt.JOIN||e===Tt.REJOIN?null:(await c(),await this.request(e,n))}if(u.isSuccess)return u.message;const l=Number(u.message.error_code||u.message.code),p=Ga(l),f=new U(b.UNEXPECTED_RESPONSE,"".concat(p.desc,": ").concat(u.message.error_str),{code:l,data:u.message});return p.action==="success"?u.message:(E.warning("[".concat(this.websocket.connectionID,"] unexpected response from type ").concat(e,", error_code: ").concat(l,", message: ").concat(p.desc,", action: ").concat(p.action)),l===Rt.ERR_TOO_MANY_BROADCASTERS?((e===Tt.JOIN||e===Tt.REJOIN)&&(this.initError=f,this.close()),f.throw()):p.action==="failed"?f.throw():p.action==="quit"?(this.initError=f,this.close(),f.throw()):(l===Rt.ERR_JOIN_BY_MULTI_IP?(this.multiIpOption=u.message.option,E.warning("[".concat(this.clientId,"] detect multi ip, recover")),this.reconnect("recover",zs.MULTI_IP)):this.reconnect(p.action,zs.SERVER_ERROR),e===Tt.JOIN||e===Tt.REJOIN?null:await this.request(e,n)))}waitMessage(e,n){return new ot(i=>{const r=o=>{(!n||n(o))&&(this.off(e,r),i(o))};this.on(e,r)})}uploadWRTCStats(e){if(!this.store.sessionId)return void E.warn("[".concat(this.clientId,"] no session id when upload wrtc stats"));const n={lts:Date.now(),sid:this.store.sessionId,uid:this.store.intUid,stats:e};this.upload(Ba.WRTC_STATS,n)}upload(e,n){const i={_type:e,_message:n};try{this.websocket.sendMessage(i)}catch{const o=N("MAX_UPLOAD_CACHE")||50;this.uploadCache.push(i),this.uploadCache.length>o&&this.uploadCache.splice(0,1),this.uploadCache.length>0&&!this.uploadCacheInterval&&(this.uploadCacheInterval=window.setInterval(()=>{if(this.connectionState!==Gt.CONNECTED)return;const s=this.uploadCache.splice(0,1)[0];this.uploadCache.length===0&&(window.clearInterval(this.uploadCacheInterval),this.uploadCacheInterval=void 0),this.upload(s._type,s._message)},N("UPLOAD_CACHE_INTERVAL")||2e3))}}send(e,n){const i={_type:e,_message:n};this.websocket.sendMessage(i)}init(e,n){return this.initError=void 0,this.multiIpOption=void 0,this.joinResponse=void 0,this.reconnectToken=void 0,this.openConnectionTime=void 0,new ot((i,r)=>{this.once(ht.WS_CONNECTED,()=>i(this.joinResponse)),this.once(ht.WS_CLOSED,()=>r(this.initError||new U(b.WS_ABORT))),this.connectionState=Gt.CONNECTING,this.websocket.init(e).catch(r),this.websocket.once(mn.FAILBACK,()=>{this.openConnectionTime===void 0&&r(new U(b.INIT_DATACHANNEL_TIMEOUT))}),this.inflateDataTimer&&window.clearInterval(this.inflateDataTimer),this.inflateDataTimer=window.setInterval(()=>{this.handleInflateData()},2e4),setTimeout(()=>{n&&this.openConnectionTime===void 0&&(E.debug("[".concat(this.clientId,"] init datachannel timeout while join with failback to websocket")),r(new U(b.INIT_DATACHANNEL_TIMEOUT)))},N("DC_JOIN_WITH_FAILBACK"))})}close(e){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.inflateDataTimer&&(this.handleInflateData(),window.clearInterval(this.inflateDataTimer),this.inflateDataTimer=void 0),this.reconnectToken=void 0,this.joinResponse=void 0,this._disconnectedReason=e||Ht.LEAVE,this.connectionState=Gt.CLOSED,E.debug("[".concat(this.clientId,"] ")+"will close datachannel in signal"),this.websocket.close(),e===Ht.FALLBACK&&(this.websocket.removeAllListeners(),this.websocket=new Ub("gateway-".concat(this.clientId),this.spec.retryConfig,!0,this.store),this.handleWebsocketEvents())}async join(){if(!this.joinResponse){this.emit(ht.ABORT_P2P_EXECUTION);const e=await En(this,ht.DATACHANNEL_CONNECTING),n=await this.request(Tt.JOIN,e);if(!n)return this.emit(ht.REPORT_JOIN_GATEWAY,b.TIMEOUT,this.url||""),!1;this.joinResponse=n,this.emit(ht.JOIN_RESPONSE,this.joinResponse),this.reconnectToken=this.joinResponse.rejoin_token}return this.connectionState=Gt.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),!0}async rejoin(){if(!this.reconnectToken)throw new U(b.UNEXPECTED_ERROR,"can not rejoin, no rejoin token");const e=Ua(this,ht.REQUEST_REJOIN_INFO);e.token=this.reconnectToken;const n=await this.request(Tt.REJOIN,e);return!!n&&(this.connectionState=Gt.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),n.peers&&n.peers.forEach(i=>{this.emit(Nt.ON_USER_ONLINE,{uid:i.uid}),i.audio&&this.emit(Nt.ON_ADD_AUDIO_STREAM,{uid:i.uid,uint_id:i.uint_id,audio:!0,ssrcId:i.audio_ssrc}),i.video&&this.emit(Nt.ON_ADD_VIDEO_STREAM,{uid:i.uid,uint_id:i.uint_id,video:!0,ssrcId:i.video_ssrc}),i.audio_mute?this.emit(Nt.MUTE_AUDIO,{uid:i.uid}):this.emit(Nt.UNMUTE_AUDIO,{uid:i.uid}),i.video_mute?this.emit(Nt.MUTE_VIDEO,{uid:i.uid}):this.emit(Nt.UNMUTE_VIDEO,{uid:i.uid}),i.audio_enable_local?this.emit(Nt.ENABLE_LOCAL_AUDIO,{uid:i.uid}):this.emit(Nt.DISABLE_LOCAL_AUDIO,{uid:i.uid}),i.video_enable_local?this.emit(Nt.ENABLE_LOCAL_VIDEO,{uid:i.uid}):this.emit(Nt.DISABLE_LOCAL_VIDEO,{uid:i.uid}),i.audio||i.video||this.emit(Nt.ON_REMOVE_STREAM,{uid:i.uid,uint_id:i.uint_id})}),!0)}reconnect(e,n){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.websocket.reconnect(e,n)}handleNotification(e){E.debug("[".concat(this.clientId,"] receive notification: "),e);const n=Ga(e.code);if(n.action!=="success"){if(n.action!=="failed")return n.action==="quit"?(n.desc==="ERR_REPEAT_JOIN_CHANNEL"&&this.close(Ht.UID_BANNED),void this.close()):void this.reconnect(n.action,zs.SERVER_ERROR);E.error("[".concat(this.clientId,"] ignore error: "),n.desc)}}handlePingPong(){if(!this.websocket||this.websocket.state!=="connected")return;this.pingpongTimeoutCount>0&&this.rttRolling.add(3e3),this.pingpongTimeoutCount+=1;const e=N("PING_PONG_TIME_OUT"),n=Date.now();this.pingpongTimeoutCount>=e&&(E.warning("PINGPONG Timeout. Last Socket Message: ".concat(n-this.lastMsgTime,"ms")),n-this.lastMsgTime>N("WEBSOCKET_TIMEOUT_MIN"))?this.reconnect("retry",zs.TIMEOUT):this.request(Tt.PING,void 0,!0).then(()=>{this.pingpongTimeoutCount=0;const i=Date.now()-n;this.rttRolling.add(i),N("REPORT_STATS")&&this.send(Tt.PING_BACK,{pingpongElapse:i})}).catch(i=>{})}handleInflateData(){const{inflateLength:e,deflateLength:n}=this.websocket.getInflateData();e!==0&&n!==0&&this.upload(Ba.WS_INFLATE_DATA_LENGTH,{ws_deflate_length:n,ws_inflate_length:e})}handleWebsocketEvents(){this.websocket.on(mn.RECONNECT_WAITTING_FINISH,e=>{this.emit(ht.WS_RECONNECT_WAITTING_FINISH,e)}),this.websocket.on(mn.RECONNECT_CREATE_CONNECTION,e=>{this.emit(ht.WS_RECONNECT_CREATE_CONNECTION,e)}),this.websocket.on(mn.ON_MESSAGE,this.onWebsocketMessage),this.websocket.on(mn.CLOSED,()=>{this.connectionState=Gt.CLOSED}),this.websocket.on(mn.FAILED,()=>{this._disconnectedReason=Ht.NETWORK_ERROR,this.connectionState=Gt.CLOSED}),this.websocket.on(mn.RECONNECTING,e=>{this._websocketReconnectReason=e,this.joinResponse=void 0,this.connectionState===Gt.CONNECTED?this.connectionState=Gt.RECONNECTING:this.connectionState=Gt.CONNECTING}),this.websocket.on(mn.WILL_RECONNECT,(e,n)=>{if(Ua(this,ht.IS_P2P_DISCONNECTED)&&e==="retry")return E.debug("".concat(this.clientId," reconnect mode is retry, but p2p lost, change to tryNext")),this.reconnectToken=void 0,this.emit(ht.NEED_RENEW_SESSION),this.emit(ht.DISCONNECT_P2P),n("tryNext");e!=="retry"&&(E.debug("".concat(this.clientId," websockt will_connect event, renewSession reconnectMode is ").concat(e)),this.reconnectToken=void 0,this.emit(ht.NEED_RENEW_SESSION),this.emit(ht.DISCONNECT_P2P)),n(e)}),this.websocket.on(mn.CONNECTED,()=>{this.openConnectionTime=Date.now(),this.reconnectToken?this.rejoin().catch(e=>{E.warning("[".concat(this.clientId,"] rejoin failed ").concat(e)),this.reconnect("tryNext",zs.SERVER_ERROR)}):this.join().catch(e=>{if(this.emit(ht.REPORT_JOIN_GATEWAY,e.message||e.code,this.url||""),e instanceof U&&e.code===b.UNEXPECTED_RESPONSE&&e.data.code===Rt.ERR_NO_AUTHORIZED)return E.warning("[".concat(this.clientId,"] reconnect no authorized, recover")),void this.reconnect("recover",zs.SERVER_ERROR);E.error("[".concat(this.clientId,"] join gateway request failed"),e.toString()),this.spec.forceWaitGatewayResponse?this.reconnect("tryNext",zs.SERVER_ERROR):(this.initError=e,this.close())})}),this.websocket.on(mn.REQUEST_NEW_URLS,(e,n)=>{En(this,ht.REQUEST_RECOVER,this.multiIpOption).then(e).catch(n)}),this.websocket.on(mn.ON_TOKEN_PRIVILEGE_DID_EXPIRE,()=>{this.emit(Nt.ON_TOKEN_PRIVILEGE_DID_EXPIRE)}),this.websocket.on(mn.TO_CONNECT_DATACHANNEL,async(e,n,i)=>En(this,ht.DATACHANNEL_PRECONNECT,e).then(n).catch(i)),this.websocket.on(mn.FAILBACK,()=>{this.openConnectionTime!==void 0&&this.emit(ht.DATACHANNEL_FAILBACK)})}}class Wa extends Ve{constructor(e,n){super(),R(this,"signal",void 0),R(this,"token",void 0),R(this,"tokenTimeout",void 0),R(this,"tokenInterval",void 0),R(this,"_sequence",0),R(this,"userMap",new Map),R(this,"encoder",new TextEncoder),this.signal=e,this.token=n;const i=()=>{this.signal.connectionState===Gt.CONNECTED&&this.check(),this.userMap.size===0?this.tokenInterval=window.setTimeout(i,1e3):this.tokenInterval=window.setTimeout(i,3*N("P2P_TOKEN_INTERVAL"))};i()}async send(e,n,i,r,o){var s,a,c;if(this.userMap.size===0)return;const d=Array.from(ao(s=this.userMap).call(s))[0].token;typeof n!="string"&&(n=JSON.stringify(n)),r=(a=r)!==null&&a!==void 0?a:be(6,""),o=(c=o)!==null&&c!==void 0?c:this._sequence++;const u={_id:r,_type:e,_seq:o,_message:n,token:"".concat(this.token,"_").concat(d)};N("SHOW_P2P_LOG")&&E.debug("send message",u,"noNeedResponse : ".concat(i)),this.splitMessage(JSON.stringify(u)).forEach(p=>{this.signal.request(Tt.DATA_STREAM,{payload:Ks(this.encoder.encode(p))})});const l=new ot((p,f)=>{const C=window.setTimeout(()=>{this.off("res-@".concat(r,"_ack"),m),this.off("res-@".concat(r),y),this.off(sd.ABORT,g),E.debug("[external-signal] request timeout, type: ".concat(e,", requestId: ").concat(r)),this.userMap.size===0?f(new G(b.INVALID_REMOTE_USER)):f(new G(b.TIMEOUT))},N("EXTERNAL_SIGNAL_REQUEST_TIMEOUT")),m=()=>{C&&window.clearTimeout(C),this.off(sd.ABORT,g),i&&p()},g=()=>{C&&window.clearTimeout(C),this.off("res-@".concat(r,"_ack"),m),this.off("res-@".concat(r),y),f(new G(b.EXTERNAL_SIGNAL_ABORT,"type: ".concat(e,", requestId: ").concat(r)))};this.once(sd.ABORT,g),this.once("res-@".concat(r,"_ack"),m);const y=(k,M)=>{A=!0,C&&window.clearTimeout(C),this.off("res-@".concat(r,"_ack"),m),this.off(sd.ABORT,g),k==="success"?p(M):f(new G(b.P2P_MESSAGE_FAILED,"request ".concat(e," failed, requestId: ").concat(r)))};let A=!1;i||(this.once("res-@".concat(r),y),wn(N("SIGNAL_REQUEST_TIMEOUT")).then(()=>{A||E.warning("external_signal request timeout, type: ".concat(e,", requestId: ").concat(r,", ").concat(u))}))});try{return await l}catch(p){if(p.code===b.TIMEOUT)return await this.send(e,n,i,r,o);throw p}}onMessage(e){var n;const{_uid:i}=e;let r,o=this.userMap.get(i);if(o)r=o.splitMessageMap;else{if(this.userMap.size>0||!("_type"in e)||e._type!==rn.CHECK)return;const{token:d}=e;r=new Map,o={uid:i,isStart:!0,token:d,splitMessageMap:r,nextExpectedSequenceNumber:0,receivedMessagesMap:new Map},this.userMap.set(i,o),this.signal.emit(Nt.ON_USER_ONLINE,{uid:i}),this.handleUserOnline()}if("id"in e&&"total"in e){var s;const{id:d,total:u}=e,l=(s=r.get(d))!==null&&s!==void 0?s:[];if(l.push(e),r.has(d)||r.set(d,l),l.length!==u)return;{const p=Du(l).call(l,(f,C)=>f.index-C.index).map(f=>f.payload).join("");r.delete(d),(e=JSON.parse(p))._uid=i}}const{_type:a,token:c}=e;if(it(n=[rn.ACK,rn.CHECK]).call(n,a))return a===rn.CHECK&&this.handleCheckToken(o,c),void this.receiveMessage(e);c==="".concat(o.token,"_").concat(this.token)?this.handleReceivedMessage(e):E.debug('Receive unexpected message", '.concat(c,", cur_token: ").concat(o.token,"_").concat(this.token),e)}check(){const e={_id:be(6,""),token:this.token,_type:rn.CHECK};N("SHOW_P2P_LOG")&&E.debug("send message",e),this.signal.request(Tt.DATA_STREAM,{payload:Ks(this.encoder.encode(JSON.stringify(e)))})}ack(e){const n={_id:e,_type:rn.ACK,token:this.token};N("SHOW_P2P_LOG")&&E.debug("send message",n),this.signal.request(Tt.DATA_STREAM,{payload:Ks(this.encoder.encode(JSON.stringify(n)))})}response(e,n,i){this.send(rn.RESPONSE,JSON.stringify({success:!i,message:n}),!0,e)}handleReceivedMessage(e){const n=()=>{this.userMap.forEach(d=>{const{receivedMessagesMap:u,nextExpectedSequenceNumber:l}=d;for(;u.has(l);){const p=u.get(l);u.delete(l),this.receiveMessage(p),d.nextExpectedSequenceNumber++}})};if(!e)return void n();const{_uid:i,_seq:r}=e,o=this.userMap.get(i),{receivedMessagesMap:s,isStart:a,nextExpectedSequenceNumber:c}=o;if(r<c)return this.ack(e._id),void E.debug("[external-signal] receive old message, seq: ".concat(r,", ").concat(e._message));s.set(r,e),a&&r===c&&(this.receiveMessage(e),s.delete(c),o.nextExpectedSequenceNumber++,n())}receiveMessage(e){const{_id:n,_type:i,_message:r,_uid:o}=e;if(N("SHOW_P2P_LOG")&&E.debug("receive message",e),n){let s;switch(e._type!==rn.ACK&&(r&&(s=JSON.parse(r)),this.ack(e._id)),e._type){case rn.CANDIDATE:case rn.CONTROL:this.signal.emit(i,s,o);break;case rn.PUBLISH:case rn.UNPUBLISH:case rn.RESTART_ICE:case rn.CALL:s.uid=o,En(this.signal,i,s).then(a=>{this.response(e._id,a)}).catch(()=>{this.response(e._id,void 0,!0)});break;case rn.ACK:this.getListeners("res-@".concat(n,"_ack")).length>0&&this.emit("res-@".concat(n,"_ack"));break;case rn.RESPONSE:{const{success:a,message:c}=s;this.emit("res-@".concat(n),a?"success":"failed",c);break}}}}splitMessage(e){if(e.length<Wa.MAX_MESSAGE_SIZE)return[e];const n=[],{remoteToken:i}=JSON.parse(e),r=be(6,"");let o=0,s=800;const a=Math.ceil(e.length/s);for(;e.length>0;){o++;const c={id:r,index:o,total:a,payload:e.slice(0,s),token:"".concat(this.token,"_").concat(i)};JSON.stringify(c).length>Wa.MAX_MESSAGE_SIZE?s-=50:(n.push(c),e=e.slice(s))}return n.map(c=>JSON.stringify(c))}handleCheckToken(e,n){return e.token!==n?(E.debug("token changed, from ".concat(e.token," to ").concat(n)),this.reset(e.uid,n),!1):(this.tokenTimeout&&(window.clearTimeout(this.tokenTimeout),this.tokenTimeout=void 0),this.tokenTimeout=window.setTimeout(()=>{E.debug("token timeout, ".concat(n)),this.reset(e.uid)},N("MAX_P2P_TIMEOUT")),!0)}async handleUserOnline(){const e=await En(this.signal,rn.CALL,void 0),n=await this.send(rn.CALL,e);this.signal.emit(ht.P2P_CONNECTION,n,!0)}async reset(e,n){const i=this.userMap.get(e);i&&(this.emit(sd.ABORT),this.signal.emit(Nt.ON_USER_OFFLINE,{uid:i.uid,reason:Gj.P2P_TOKEN_CHANGED}),this._sequence=0,this.userMap.clear(),n||(E.debug("change local token from ".concat(n," to ").concat(n)),this.token=be(6,"")))}clear(){this._sequence=0,this.userMap.clear(),this.tokenInterval&&window.clearTimeout(this.tokenInterval),this.tokenInterval=void 0,this.tokenTimeout&&window.clearTimeout(this.tokenTimeout),this.tokenTimeout=void 0,this.emit(sd.ABORT)}}R(Wa,"MAX_SIZE",1),R(Wa,"MAX_MESSAGE_SIZE",1024);class xb extends Ve{get connectionState(){return this._connectionState}set connectionState(e){e!==this._connectionState&&(this._connectionState=e,e===Gt.CONNECTED?this.emit(ht.WS_CONNECTED):e===Gt.RECONNECTING?this.emit(ht.WS_RECONNECTING,this._websocketReconnectReason):e===Gt.CLOSED&&this.emit(ht.WS_CLOSED,this._disconnectedReason))}get currentURLIndex(){return this.websocket.currentURLIndex}get url(){return this.websocket&&this.websocket.url||null}get rtt(){return this.rttRolling.mean()}constructor(e,n){super(),R(this,"_disconnectedReason",void 0),R(this,"_websocketReconnectReason",void 0),R(this,"_connectionState",Gt.CLOSED),R(this,"reconnectToken",void 0),R(this,"p2pToken",void 0),R(this,"websocket",void 0),R(this,"openConnectionTime",void 0),R(this,"clientId",void 0),R(this,"lastMsgTime",Date.now()),R(this,"uploadCache",[]),R(this,"uploadCacheInterval",void 0),R(this,"rttRolling",new Jm(5)),R(this,"pingpongTimer",void 0),R(this,"pingpongTimeoutCount",0),R(this,"joinResponse",void 0),R(this,"multiIpOption",void 0),R(this,"initError",void 0),R(this,"spec",void 0),R(this,"store",void 0),R(this,"_external_signal",void 0),R(this,"onWebsocketMessage",i=>{if(i.data instanceof ArrayBuffer)return void this.emit(ht.ON_BINARY_DATA,i.data);const r=JSON.parse(i.data);if(this.lastMsgTime=Date.now(),Object.prototype.hasOwnProperty.call(r,"_id")){const o="res-@".concat(r._id);this.emit(o,r._result,r._message)}else if(Object.prototype.hasOwnProperty.call(r,"_type")){switch(r._type){case Nt.ON_DATA_STREAM:return void this.handleDataStream(r._message);case Nt.MUTE_AUDIO:case Nt.MUTE_VIDEO:case Nt.ON_P2P_LOST:case Nt.ON_USER_ONLINE:return;case Nt.ON_USER_OFFLINE:const{uid:o}=r._message;return E.debug("[".concat(this.clientId,"] user-offline uid: ").concat(o)),void this._external_signal.reset(o)}if(this.emit(r._type,r._message),r._type===Nt.ON_NOTIFICATION&&this.handleNotification(r._message),r._type===Nt.ON_USER_BANNED)switch(r._message.error_code){case 14:this.close(Ht.UID_BANNED);break;case 15:this.close(Ht.IP_BANNED);break;case 16:this.close(Ht.CHANNEL_BANNED)}if(r._type===Nt.ON_USER_LICENSE_BANNED)switch(r._message.error_code){case Rt.ERR_LICENSE_MISSING:this.close(Ht.LICENSE_MISSING);break;case Rt.ERR_LICENSE_EXPIRED:this.close(Ht.LICENSE_EXPIRED);break;case Rt.ERR_LICENSE_MINUTES_EXCEEDED:this.close(Ht.LICENSE_MINUTES_EXCEEDED);break;case Rt.ERR_LICENSE_PERIOD_INVALID:this.close(Ht.LICENSE_PERIOD_INVALID);break;case Rt.ERR_LICENSE_MULTIPLE_SDK_SERVICE:this.close(Ht.LICENSE_MULTIPLE_SDK_SERVICE);break;case Rt.ERR_LICENSE_ILLEGAL:this.close(Ht.LICENSE_ILLEGAL);break;default:this.close()}}}),this.clientId=e.clientId,this.spec=e,this.store=n,this.websocket=new $u("gateway-".concat(this.clientId),this.spec.retryConfig,!0,N("JOIN_GATEWAY_USE_DUAL_DOMAIN"),N("JOIN_GATEWAY_USE_443PORT_ONLY"),n),this.handleWebsocketEvents(),window.addEventListener("offline",()=>{this.connectionState===Gt.CONNECTED&&this.reconnect("retry",Kn.OFFLINE)}),this.p2pToken=be(6,""),this._external_signal=new Wa(this,this.p2pToken)}async request(e,n,i,r){const o=be(6,""),s={_id:o,_type:e,_message:n},a=this.websocket.connectionID,c=()=>new ot((C,m)=>{if(this.connectionState===Gt.CONNECTED)return C();const g=()=>{this.off(ht.WS_CLOSED,y),C()},y=()=>{this.off(ht.WS_CONNECTED,g),m(new G(b.WS_ABORT))};this.once(ht.WS_CONNECTED,g),this.once(ht.WS_CLOSED,y)});if(this.connectionState!==Gt.CONNECTING&&this.connectionState!==Gt.RECONNECTING||e===Tt.JOIN||e===Tt.REJOIN||await c(),this.websocket.sendMessage(s,!0),r)return;const d=new ot((C,m)=>{let g=!1;const y=(k,M)=>{g=!0,C({isSuccess:k==="success",message:M||{}}),this.off(ht.WS_CLOSED,A),this.off(ht.WS_RECONNECTING,A),this.emit(ht.REQUEST_SUCCESS,e,n)};this.once("res-@".concat(o),y);const A=()=>{m(new G(b.WS_ABORT,"type: ".concat(e))),this.off(ht.WS_CLOSED,A),this.off(ht.WS_RECONNECTING,A),this.off("res-@".concat(o),y)};this.once(ht.WS_CLOSED,A),this.once(ht.WS_RECONNECTING,A),wn(N("SIGNAL_REQUEST_TIMEOUT")).then(()=>{this.websocket.connectionID!==a||g||(E.warning("[".concat(this.clientId,"] ws request timeout, type: ").concat(e)),this.emit(ht.REQUEST_TIMEOUT,e,n))})});let u=null;try{u=await d}catch(C){if(this.connectionState===Gt.CLOSED||e===Tt.LEAVE)throw new G(b.WS_ABORT);return!this.spec.forceWaitGatewayResponse||i?C.throw():e===Tt.JOIN||e===Tt.REJOIN?null:(await c(),await this.request(e,n))}if(u.isSuccess)return u.message;const l=Number(u.message.error_code||u.message.code),p=Ga(l),f=new G(b.UNEXPECTED_RESPONSE,"".concat(p.desc,": ").concat(u.message.error_str),{code:l,data:u.message});return p.action==="success"?u.message:(E.warning("[".concat(this.clientId,"] [").concat(this.websocket.connectionID,"] unexpected response from type ").concat(e,", error_code: ").concat(l,", message: ").concat(p.desc,", action: ").concat(p.action)),l===Rt.ERR_TOO_MANY_BROADCASTERS?((e===Tt.JOIN||e===Tt.REJOIN)&&(this.initError=f,this.close()),f.throw()):p.action==="failed"?f.throw():p.action==="quit"?(this.initError=f,this.close(),f.throw()):(l===Rt.ERR_JOIN_BY_MULTI_IP?(this.multiIpOption=u.message.option,E.warning("[".concat(this.clientId,"] detect multi ip, recover")),this.reconnect("recover",Kn.MULTI_IP)):this.reconnect(p.action,Kn.SERVER_ERROR),e===Tt.JOIN||e===Tt.REJOIN?null:await this.request(e,n)))}waitMessage(e,n){return new ot(i=>{const r=o=>{(!n||n(o))&&(this.off(e,r),i(o))};this.on(e,r)})}uploadWRTCStats(e){if(!this.store.sessionId)return void E.warn("[".concat(this.clientId,"] no session id when upload wrtc stats"));const n={lts:Date.now(),sid:this.store.sessionId,uid:this.store.intUid,stats:e};this.upload(Ba.WRTC_STATS,n)}upload(e,n){const i={_type:e,_message:n};try{this.websocket.sendMessage(i)}catch{const o=N("MAX_UPLOAD_CACHE")||50;this.uploadCache.push(i),this.uploadCache.length>o&&this.uploadCache.splice(0,1),this.uploadCache.length>0&&!this.uploadCacheInterval&&(this.uploadCacheInterval=window.setInterval(()=>{if(this.connectionState!==Gt.CONNECTED)return;const s=this.uploadCache.splice(0,1)[0];this.uploadCache.length===0&&(window.clearInterval(this.uploadCacheInterval),this.uploadCacheInterval=void 0),this.upload(s._type,s._message)},N("UPLOAD_CACHE_INTERVAL")||2e3))}}send(e,n){const i={_type:e,_message:n};this.websocket.sendMessage(i)}async sendExtensionMessage(e,n,i){return await this._external_signal.send(e,n,i)}init(e){return this.initError=void 0,this.multiIpOption=void 0,this.joinResponse=void 0,this.reconnectToken=void 0,this.openConnectionTime=void 0,new ot((n,i)=>{this.once(ht.WS_CONNECTED,()=>n(this.joinResponse)),this.once(ht.WS_CLOSED,()=>i(this.initError||new G(b.WS_ABORT))),this.connectionState=Gt.CONNECTING,this.websocket.init(e).catch(i)})}close(e){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.reconnectToken=void 0,this.joinResponse=void 0,this._external_signal.clear(),this._disconnectedReason=e||Ht.LEAVE,this.connectionState=Gt.CLOSED,E.debug("[".concat(this.clientId,"] ")+"will close websocket in signal"),this.websocket.close(),e===Ht.FALLBACK&&(this.websocket.removeAllListeners(),this.websocket=new $u("gateway-".concat(this.clientId),this.spec.retryConfig,!0,N("JOIN_GATEWAY_USE_DUAL_DOMAIN"),N("JOIN_GATEWAY_USE_443PORT_ONLY"),this.store),this.handleWebsocketEvents()),this.p2pToken=be(6,""),this._external_signal.clear(),this._external_signal=new Wa(this,this.p2pToken)}async join(){if(!this.joinResponse){this.emit(ht.ABORT_P2P_EXECUTION);const e=await En(this,ht.REQUEST_JOIN_INFO),n=await this.request(Tt.JOIN,e);if(!n)return this.emit(ht.REPORT_JOIN_GATEWAY,b.TIMEOUT,this.url||""),!1;this.joinResponse=n,this.emit(ht.JOIN_RESPONSE,this.joinResponse),this.reconnectToken=this.joinResponse.rejoin_token}return this.connectionState=Gt.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),!0}reconnect(e,n){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.websocket.reconnect(e,n)}handleDataStream(e){try{var n;const i=Va(e.payload),r=new TextDecoder().decode(i),o=JSON.parse(r);"total"in o&&"id"in o||it(n=Object.values(rn)).call(n,o._type)?(o._uid=e.uid,this._external_signal.onMessage(o)):this.emit(Nt.ON_DATA_STREAM,e)}catch{this.emit(Nt.ON_DATA_STREAM,e)}}handleNotification(e){E.debug("[".concat(this.clientId,"] receive notification: "),e);const n=Ga(e.code);if(n.action!=="success"){if(n.action!=="failed")return n.action==="quit"?(n.desc==="ERR_REPEAT_JOIN_CHANNEL"&&this.close(Ht.UID_BANNED),void this.close()):void this.reconnect(n.action,Kn.SERVER_ERROR);E.error("[".concat(this.clientId,"] ignore error: "),n.desc)}}handlePingPong(){if(!this.websocket||this.websocket.state!=="connected")return;this.pingpongTimeoutCount>0&&this.rttRolling.add(3e3),this.pingpongTimeoutCount+=1;const e=N("PING_PONG_TIME_OUT"),n=Date.now();this.pingpongTimeoutCount>=e&&(E.warning("[".concat(this.clientId,"] PINGPONG Timeout. Last Socket Message: ").concat(n-this.lastMsgTime,"ms")),n-this.lastMsgTime>N("WEBSOCKET_TIMEOUT_MIN"))?this.reconnect("retry",Kn.TIMEOUT):this.request(Tt.PING,void 0,!0).then(()=>{this.pingpongTimeoutCount=0;const i=Date.now()-n;this.rttRolling.add(i),N("REPORT_STATS")&&this.send(Tt.PING_BACK,{pingpongElapse:i})}).catch(i=>{})}handleWebsocketEvents(){this.websocket.on(It.RECONNECT_WAITTING_FINISH,e=>{this.emit(ht.WS_RECONNECT_WAITTING_FINISH,e)}),this.websocket.on(It.RECONNECT_CREATE_CONNECTION,e=>{this.emit(ht.WS_RECONNECT_CREATE_CONNECTION,e)}),this.websocket.on(It.ON_MESSAGE,this.onWebsocketMessage),this.websocket.on(It.CLOSED,()=>{this.connectionState=Gt.CLOSED}),this.websocket.on(It.FAILED,()=>{this._disconnectedReason=Ht.NETWORK_ERROR,this.connectionState=Gt.CLOSED}),this.websocket.on(It.RECONNECTING,e=>{this._websocketReconnectReason=e,this.joinResponse=void 0,this.connectionState===Gt.CONNECTED?this.connectionState=Gt.RECONNECTING:this.connectionState=Gt.CONNECTING}),this.websocket.on(It.WILL_RECONNECT,(e,n,i)=>{e!=="retry"?(E.debug("".concat(this.clientId," websocket will_connect event, renewSession reconnectMode is ").concat(e)),this.reconnectToken=void 0,this.emit(ht.NEED_RENEW_SESSION)):E.debug("".concat(this.clientId," reconnect mode is retry, no need to renew session")),i(e)}),this.websocket.on(It.CONNECTED,()=>{this.openConnectionTime=Date.now(),this.join().catch(e=>{if(this.emit(ht.REPORT_JOIN_GATEWAY,e.message||e.code,this.url||""),e instanceof G&&e.code===b.UNEXPECTED_RESPONSE&&e.data.code===Rt.ERR_NO_AUTHORIZED)return E.warning("[".concat(this.clientId,"] reconnect no authorized, recover")),void this.reconnect("recover",Kn.SERVER_ERROR);E.error("[".concat(this.clientId,"] join gateway request failed"),e.toString()),this.spec.forceWaitGatewayResponse?this.reconnect("tryNext",Kn.SERVER_ERROR):(this.initError=e,this.close())})}),this.websocket.on(It.REQUEST_NEW_URLS,(e,n)=>{En(this,ht.REQUEST_RECOVER,this.multiIpOption).then(e).catch(n)}),this.websocket.on(It.ON_TOKEN_PRIVILEGE_DID_EXPIRE,()=>{this.emit(Nt.ON_TOKEN_PRIVILEGE_DID_EXPIRE)})}}function Vb(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),n.push.apply(n,i)}return n}function xr(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?Vb(Object(n),!0).forEach(function(i){R(t,i,n[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):Vb(Object(n)).forEach(function(i){Object.defineProperty(t,i,Object.getOwnPropertyDescriptor(n,i))})}return t}const fg=new Map;class $j extends Ve{get state(){return this._state}set state(e){if(e===this._state)return;const n=this._state;this._state=e,e==="DISCONNECTED"&&this._disconnectedReason?this.emit(nn.CONNECTION_STATE_CHANGE,e,n,this._disconnectedReason):this.emit(nn.CONNECTION_STATE_CHANGE,e,n)}get joinGatewayStartTime(){return this._joinGatewayStartTime}set joinGatewayStartTime(e){E.debug("[".concat(this.store.clientId,"] set joinGatewayStartTime at ").concat(e)),this._joinGatewayStartTime=e}constructor(e,n){super(),R(this,"store",void 0),R(this,"joinInfo",void 0),R(this,"key",void 0),R(this,"ntpOffset",0),R(this,"signal",void 0),R(this,"role",void 0),R(this,"inChannelInfo",{joinAt:null,duration:0}),R(this,"spec",void 0),R(this,"_state","DISCONNECTED"),R(this,"_statsCollector",void 0),R(this,"_disconnectedReason",void 0),R(this,"isSignalRecover",!1),R(this,"hasChangeBGPAddress",!1),R(this,"trafficStatsInterval",void 0),R(this,"networkQualityInterval",void 0),R(this,"_joinGatewayStartTime",0),R(this,"_signalTimeout",!1),R(this,"_clientRoleOptions",void 0),R(this,"_isProactiveJoin",!1),this.store=e,this.spec=n,this.signal=this.store.useP2P?new xb(xr(xr({},n),{},{retryConfig:n.websocketRetryConfig}),e):this.store.useDataChannel?new Es(xr(xr({},n),{},{retryConfig:n.websocketRetryConfig}),e):new Nb(xr(xr({},n),{},{retryConfig:n.websocketRetryConfig}),e),this._statsCollector=n.statsCollector,this.role=n.role||"audience",this._clientRoleOptions=n.clientRoleOptions,this.handleSignalEvents()}async join(e,n,i){if(this.signal instanceof Es){let c=!1;e.cloudProxyServer!=="disabled"?(E.debug("[".concat(this.store.clientId,"] Dc is not supported, because cloudProxyServer are not supported (").concat(e.cloudProxyServer,")")),c=!0):"".concat(e.apResponse.cid,"_").concat(e.apResponse.cert).length>255||"".concat(e.apResponse.cid,"_").concat(e.apResponse.cert).length<22?(E.debug("[".concat(this.store.clientId,"] Dc is not supported, because ticket length is incorrect, it has to be between 22 and 255")),c=!0):e.apResponse.addresses.some(d=>d.fingerprint)||N("FINGERPRINT")||(E.debug("[".concat(this.store.clientId,"] Dc is not supported, because fingerprint does not exist")),c=!0),c&&this.resetSignal()}this.store.joinGatewayStart(),e.cloudProxyServer!=="disabled"&&(this.hasChangeBGPAddress=!0);const r=Date.now();let o=fg.get(e.cname);if(o||(o=new Map,fg.set(e.cname,o)),this._isProactiveJoin=!0,o.has(e.uid)){const c=new U(b.UID_CONFLICT);throw Et.joinGateway(e.sid,{lts:r,succ:!1,ec:c.message,addr:null,uid:e.uid,cid:e.cid,firstSuccess:this._isProactiveJoin,avoidJoinStartTime:this.store.avoidJoinStart,isProxy:!!e.proxyServer,signalChannel:this.signal instanceof Es?"1":"0"}),this._isProactiveJoin=!1,c}o.set(e.uid,!0),this.joinInfo=e,this.key=n;let s=0;this.joinGatewayStartTime=r;const a=e.proxyServer;try{let c;if(E.debug("[".concat(this.store.clientId,"] use ").concat(this.signal instanceof Es?"datachannel":"websocket"," join uid ").concat(s)),this.signal instanceof Es)c=await this.signal.init(e.apResponse.addresses,i);else{const d=e.gatewayAddrs.map(u=>{let{address:l}=u;const[p,f]=l.split(":"),C={host:p,port:f};return e.proxyServer&&(C.proxy=e.proxyServer),C});c=await this.signal.init(d,i)}s=c.uid,E.debug("[".concat(this.store.clientId,"] ").concat(this.signal instanceof Es?"datachannel":"websocket"," join uid ").concat(s," cost ").concat(Date.now()-this.joinGatewayStartTime))}catch(c){throw c&&c.code===b.INIT_WEBSOCKET_TIMEOUT?(E.warning("[".concat(this.store.clientId,"] User join failed"),c.toString()),c):c&&c.code===b.INIT_DATACHANNEL_TIMEOUT?(E.warning("[".concat(this.store.clientId,"] User join datachannel failed"),c.toString()),this.resetSignal(),c):(E.error("[".concat(this.store.clientId,"] User join failed"),c.toString()),Et.joinGateway(e.sid,{lts:r,succ:!1,ec:c.message,addr:this.signal.url,uid:e.uid,cid:e.cid,firstSuccess:this._isProactiveJoin,avoidJoinStartTime:this.store.avoidJoinStart,isProxy:!!a,signalChannel:this.signal instanceof Es?"1":"0"}),this._isProactiveJoin=!1,o.delete(e.uid),this.signal.close(),c)}return this.state="CONNECTED",this.inChannelInfo.joinAt=Date.now(),E.debug("[".concat(this.store.clientId,"] Connected to gateway server")),this.trafficStatsInterval=window.setInterval(()=>{this.updateTrafficStats().catch(c=>{E.warning("[".concat(this.store.clientId,"] get traffic stats error"),c.toString())})},3e3),this.networkQualityInterval=window.setInterval(()=>{navigator&&navigator.onLine!==void 0&&!navigator.onLine?this.emit(nn.NETWORK_QUALITY,{downlinkNetworkQuality:6,uplinkNetworkQuality:6}):this._signalTimeout?this.emit(nn.NETWORK_QUALITY,{downlinkNetworkQuality:5,uplinkNetworkQuality:5}):this.state==="CONNECTED"&&this._statsCollector.trafficStats?this.emit(nn.NETWORK_QUALITY,{uplinkNetworkQuality:Lb(this._statsCollector.trafficStats.B_unq),downlinkNetworkQuality:Lb(this._statsCollector.trafficStats.B_dnq)}):this.emit(nn.NETWORK_QUALITY,{uplinkNetworkQuality:0,downlinkNetworkQuality:0})},2e3),this.store.joinGatewayEnd(),s}async leave(){let e=arguments.length>0&&arguments[0]!==void 0&&arguments[0],n=arguments.length>1?arguments[1]:void 0;if(this.state!=="DISCONNECTED"){n!==Ht.FALLBACK&&(this.state="DISCONNECTING");try{e||this.signal.connectionState!==Gt.CONNECTED||await function(i,r){return r===1/0?i:ot.race([i,jF(r)])}(this.signal.request(Tt.LEAVE,void 0,!0),3e3)}catch(i){E.warning("[".concat(this.store.clientId,"] leave request failed, ignore"),i)}this.signal.close(n),n!==Ht.FALLBACK&&(this.state="DISCONNECTED"),this.reset()}}async publish(e,n,i){if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new U(b.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));const r={state:"offer",p2p_id:this.store.p2pId,ortc:n,mode:this.spec.mode,extend:N("PUB_EXTEND"),twcc:!!N("PUBLISH_TWCC"),rtx:!!N("USE_PUB_RTX")};try{return(await this.signal.request(Tt.PUBLISH,r,!0))._message}catch(o){if(i&&o.data&&o.data.code===Rt.ERR_PUBLISH_REQUEST_INVALID)return E.warning("[".concat(this.store.clientId,"] receive publish error code, retry"),o.toString()),await this.tryUnpubBeforeRepub(e,n),this.publish(e,n,!1);throw o}}async publishDataChannel(e,n,i){var r;if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new U(b.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));const o={stream_id:n.streamId,ordered:n.ordered?1:0,max_retrans_times:(r=n.maxRetransmits)!==null&&r!==void 0?r:10,channel_id:n.channelId,metadata:n.metadata};try{await this.signal.request(Tt.PUBLISH_DATASTREAM,o,!0)}catch(s){if(i&&s.data&&s.data.code===Rt.ERR_PUBLISH_REQUEST_INVALID)return E.warning("[".concat(this.store.clientId,"] receive publish datachannels error code, retry"),s.toString()),await this.tryUnpubDataChannelBeforeRepub(e,n),this.publishDataChannel(e,n,!1);throw s}}async unpublish(e,n){try{if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new U(b.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));await this.signal.request(Tt.UNPUBLISH,{stream_id:n,ortc:e},!0)}catch(i){E.warning("[".concat(this.store.clientId,"] unpublish warning: "),i)}}async unpublishDataChannel(e){try{if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new U(b.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));await ot.all(e.map(n=>this.signal.request(Tt.UNPUBLISH_DATASTREAM,{channel_id:n},!0)))}catch(n){E.warning("unpublish datachannels warning: ",n)}}async presubscribe(e,n,i){if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new U(b.INVALID_OPERATION,"can not presubscribe when connection state is ".concat(this.state));const r={stream_id:e,stream_type:n,mode:this.spec.mode,codec:this.spec.codec,p2p_id:this.store.p2pId,twcc:!!N("SUBSCRIBE_TWCC"),rtx:!!N("USE_SUB_RTX")||void 0,extend:N("SUB_EXTEND"),svc:Array.isArray(N("SVC"))&&N("SVC").length!==0?N("SVC"):void 0};try{return await this.signal.request(Tt.PRE_SUBSCRIBE,r,!0)}catch(o){if(i&&o.data&&o.data.code===Rt.ERR_SUBSCRIBE_REQUEST_INVALID)return E.warning("[".concat(this.store.clientId,"] pre-subscribe error, retry"),o.toString()),this.presubscribe(e,n,!1);throw o}}async subscribe(e,n,i){if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new U(b.INVALID_OPERATION,"can not subscribe when connection state is ".concat(this.state));const r={stream_id:e,stream_type:n.stream_type,mode:this.spec.mode,codec:this.spec.codec,p2p_id:this.store.p2pId,twcc:!!N("SUBSCRIBE_TWCC"),rtx:!!N("USE_SUB_RTX"),extend:N("SUB_EXTEND"),ssrcId:n.ssrcId,svc:Array.isArray(N("SVC"))&&N("SVC").length!==0?N("SVC"):void 0};try{return(await this.signal.request(Tt.SUBSCRIBE,r,!0))._message}catch(o){if(i&&o.data&&o.data.code===Rt.ERR_SUBSCRIBE_REQUEST_INVALID)return E.warning("[".concat(this.store.clientId,"] receiver subscribe error code, retry"),o.toString()),await this.tryUnsubBeforeResub(e,n),await this.subscribe(e,n,!1);throw o}}async subscribeDataChannel(e,n,i){if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new U(b.INVALID_OPERATION,"can not subscribe datachannel when connection state is ".concat(this.state));const r={uid:e,stream_id:n.id,channel_id:n.datachannelId};try{return void await this.signal.request(Tt.SUBSCRIBE_DATASTREAM,r,!0)}catch(o){if(i&&o.data&&o.data.code===Rt.ERR_SUBSCRIBE_REQUEST_INVALID)return E.warning("[".concat(this.store.clientId,"] receiver subscribe datachannel error code, retry"),o.toString()),await this.tryUnsubDataChannelBeforeResub(e,n),await this.subscribeDataChannel(e,n,!1);throw o}}async subscribeAll(e,n){if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new U(b.INVALID_OPERATION,"can not massSubscribe when connection state is ".concat(this.state));const i={p2p_id:this.store.p2pId,users:e,dtx:!1,rtx:!!N("USE_SUB_RTX"),twcc:!!N("SUBSCRIBE_TWCC"),svc:Array.isArray(N("SVC"))&&N("SVC").length!==0?N("SVC"):void 0};try{return await this.signal.request(Tt.SUBSCRIBE_STREAMS,i,!0)}catch(r){if(n&&r.data&&r.data.code===Rt.ERR_SUBSCRIBE_REQUEST_INVALID)return E.warning("[".concat(this.store.clientId,"] receiver massSubscribe error code, retry"),r.toString()),await this.tryMassUnsubBeforeResub(e),await this.subscribeAll(e,!1);throw r}}async setVideoProfile(e){const n=function(i){if(!(i.bitrateMax&&i.bitrateMin&&i.frameRate&&i.height&&i.width))return;let r=i.frameRate,o=i.width,s=i.height,a=!0;return typeof r!="number"&&(r=r.exact||r.ideal||r.max||r.min||0,r||(a=!1)),typeof o!="number"&&(o=o.exact||o.ideal||o.max||o.min||0,o||(a=!1)),typeof s!="number"&&(s=s.exact||s.ideal||s.max||s.min||0,r||(a=!1)),a?{stream_type:0,width:o,height:s,fps:r,start_bps:1e3*i.bitrateMax,min_bps:1e3*i.bitrateMin,target_bps:1e3*i.bitrateMax}:void 0}(e);if(n)return this.signal.request(Tt.SET_VIDEO_PROFILE,n);E.debug("[".concat(this.store.clientId,"] encoder config is not complete, do not report to gateway"))}async unsubscribe(e,n){try{await this.signal.request(Tt.UNSUBSCRIBE,{p2p_id:this.store.p2pId,ortc:e,stream_id:n},!0)}catch(i){E.warning("[".concat(this.store.clientId,"] unsubscribe warning: "),i)}}async unsubscribeDataChannel(e,n){try{if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new U(b.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));await ot.all(e.map(i=>this.signal.request(Tt.UNSUBSCRIBE_DATASTREAM,{stream_id:i,uid:n},!0)))}catch(i){E.warning("unsubscribeDataChannel warning: ",i)}}async massUnsubscribe(e){try{await this.signal.request(Tt.UNSUBSCRIBE_STREAMS,e,!0)}catch(n){E.warning("[".concat(this.store.clientId,"] massUnsubscribeAll warning: "),n)}}async reconnectPC(e){const{iceParameters:n,dtlsParameters:i,rtpCapabilities:r}=e;return{gatewayEstablishParams:await this.signal.request(Tt.CONNECT_PC,{p2p_id:this.store.p2pId,stream_id:this.store.uid,ortc:{iceParameters:n,dtlsParameters:i,rtpCapabilities:r}},!0),gatewayAddress:this.getCurrentGatewayAddress()}}getGatewayInfo(){return this.signal.request(Tt.GATEWAY_INFO)}async renewToken(e){await this.signal.request(Tt.RENEW_TOKEN,e),this.key=e.token}async setClientRole(e,n){if(n&&(this._clientRoleOptions=Object.assign({},n)),this.state!=="CONNECTED")return void(this.role=e);let i,r=0;e==="audience"?this._clientRoleOptions&&this._clientRoleOptions.delay?(i=this._clientRoleOptions.delay,r=1):r=this._clientRoleOptions&&this._clientRoleOptions.level?this._clientRoleOptions.level:2:r=0,await this.signal.request(Tt.SET_CLIENT_ROLE,{role:e,level:r,delay:i,client_ts:Date.now()}),this.role=e}async setRemoteVideoStreamType(e,n){await this.signal.request(Tt.SWITCH_VIDEO_STREAM,{stream_id:e,stream_type:n})}async setDefaultRemoteVideoStreamType(e){await this.signal.request(Tt.DEFAULT_VIDEO_STREAM,{stream_type:e})}async setStreamFallbackOption(e,n){await this.signal.request(Tt.SET_FALLBACK_OPTION,{stream_id:e,fallback_type:n})}async pickSVCLayer(e,n){await this.signal.request(Tt.PICK_SVC_LAYER,{stream_id:e,spatial_layer:n.spatialLayer,temporal_layer:n.temporalLayer})}async setRTM2Flag(e){await this.signal.request(Tt.SET_RTM2_FLAG,{rtm2_flag:e})}async sendExtensionMessage(e,n,i){if(this.signal instanceof xb)return this.signal.sendExtensionMessage(e,n,i)}getInChannelInfo(){return this.inChannelInfo.joinAt&&(this.inChannelInfo.duration=Date.now()-this.inChannelInfo.joinAt),xr({},this.inChannelInfo)}async getGatewayVersion(){return(await this.signal.request(Tt.GATEWAY_INFO)).version}reset(){if(this.inChannelInfo.joinAt&&(this.inChannelInfo.duration=Date.now()-this.inChannelInfo.joinAt,this.inChannelInfo.joinAt=null),this.trafficStatsInterval&&(window.clearInterval(this.trafficStatsInterval),this.trafficStatsInterval=void 0),this.joinInfo){const e=fg.get(this.joinInfo.cname);e&&e.delete(this.joinInfo.uid)}this.joinInfo=void 0,this.key=void 0,this.networkQualityInterval&&(window.clearInterval(this.networkQualityInterval),this.networkQualityInterval=void 0)}updateTurnConfigFromSignal(){if(!this.joinInfo)return;const e=function(n){let i;return i=n.startsWith("dc")?n.match(/(dc\:\/\/)?([^:]+):(\d+)/):n.match(/(wss\:\/\/)?([^:]+):(\d+)/),i?{username:qn.username,password:qn.password,turnServerURL:i[2],tcpport:parseInt(i[3])+30,udpport:parseInt(i[3])+30,forceturn:!1}:null}((this.joinInfo.cloudProxyServer==="disabled"?this.signal.url:this.joinInfo.gatewayAddrs[this.signal.currentURLIndex].address)||"");this.joinInfo.turnServer.serversFromGateway=[],e&&this.joinInfo.turnServer.mode!=="off"&&this.joinInfo.cloudProxyServer==="disabled"&&this.joinInfo.turnServer.serversFromGateway.push(xr(xr({},qn),{},{turnServerURL:e.turnServerURL,tcpport:e.tcpport,udpport:e.udpport,username:this.joinInfo.uid.toString(),password:this.joinInfo.token}))}async updateTrafficStats(){if(this.state!=="CONNECTED")return;const e=await this.signal.request(Tt.TRAFFIC_STATS,void 0,!0);e.timestamp=Date.now(),e.ntp_offset!=null&&(this.ntpOffset=e.ntp_offset),e.peer_delay.forEach(n=>{const i=this._statsCollector.trafficStats&&this._statsCollector.trafficStats.peer_delay.find(r=>r.peer_uid===n.peer_uid);i&&i.B_st!==n.B_st&&kp(()=>{this.emit(nn.STREAM_TYPE_CHANGE,n.peer_uid,n.B_st)})}),this._statsCollector.updateTrafficStats(e)}getJoinMessage(e){if(!this.joinInfo||!this.key)throw new U(b.UNEXPECTED_ERROR,"can not generate join message, no join info");const n=Object.assign({},this.joinInfo.apResponse);let i=N("REPORT_APP_SCENARIO");if(typeof i!="string")try{i=JSON.stringify(i)}catch{i=void 0}i&&i.length>128&&(i=void 0);const r=xr({license:this.joinInfo.license,p2p_id:this.store.p2pId,session_id:this.joinInfo.sid,app_id:this.joinInfo.appId,channel_key:this.key,channel_name:this.joinInfo.cname,sdk_version:pr,browser:navigator.userAgent,process_id:N("PROCESS_ID"),mode:this.store.useP2P?"p2p":this.spec.mode,codec:this.spec.codec,role:this.role,has_changed_gateway:this.hasChangeBGPAddress,ap_response:n,extend:N("JOIN_EXTEND"),details:{6:this.joinInfo.stringUid,cservice_map:this.joinInfo.cloudProxyServer==="proxy3"?"1":this.joinInfo.cloudProxyServer==="proxy5"?"2":void 0},features:{rejoin:!0},optionalInfo:this.joinInfo.optionalInfo,appScenario:i,attributes:{userAttributes:{enablePublishedUserList:N("ENABLE_PUBLISHED_USER_LIST"),maxSubscription:N("MAX_SUBSCRIPTION"),subscribeAudioFilterTopN:typeof N("SUBSCRIBE_AUDIO_FILTER_TOPN")=="number"?N("SUBSCRIBE_AUDIO_FILTER_TOPN"):void 0,enablePublishAudioFilter:typeof N("ENABLE_PUBLISH_AUDIO_FILTER")=="boolean"?N("ENABLE_PUBLISH_AUDIO_FILTER"):void 0,enableUserLicenseCheck:typeof N("ENABLE_USER_LICENSE_CHECK")=="boolean"?N("ENABLE_USER_LICENSE_CHECK"):void 0,enableRTX:N("USE_PUB_RTX")===!0||N("USE_SUB_RTX")===!0||void 0,disableFEC:N("DISABLE_FEC"),enableNTPReport:!!N("ENABLE_NTP_REPORT")||void 0,enableInstantVideo:!!N("ENABLE_INSTANT_VIDEO")||void 0,enableDataStream2:typeof N("ENABLE_DATASTREAM_2")=="boolean"?N("ENABLE_DATASTREAM_2"):void 0,rtm2Flag:typeof this.joinInfo.rtmFlag=="number"?this.joinInfo.rtmFlag:void 0,enableUserAutoRebalanceCheck:!!N("ENABLE_USER_AUTO_REBALANCE_CHECK"),enableXR:typeof N("USE_XR")=="boolean"?N("USE_XR"):void 0,enableLossbasedBwe:typeof N("ENABLE_LOSSBASED_BWE")=="boolean"?N("ENABLE_LOSSBASED_BWE"):void 0,enableAutCC:typeof N("ENABLE_AUT_CC")=="boolean"?N("ENABLE_AUT_CC"):void 0,enableCCFallback:typeof N("ENABLE_CC_FALLBACK")=="boolean"?N("ENABLE_CC_FALLBACK"):void 0}},join_ts:this.joinGatewayStartTime},e);return this.joinInfo.stringUid&&(r.string_uid=this.joinInfo.stringUid),this.joinInfo.aesmode&&this.joinInfo.aespassword&&(r.aes_mode=this.joinInfo.aesmode,N("ENCRYPT_AES")?(r.aes_secret=this.joinInfo.aespassword,r.aes_encrypt=!0):r.aes_secret=this.joinInfo.aespassword,this.joinInfo.aessalt&&(r.aes_salt=this.joinInfo.aessalt)),n.addresses[this.signal.websocket.currentURLIndex]&&(r.ap_response.ticket=n.addresses[this.signal.websocket.currentURLIndex].ticket,delete n.addresses),this.joinInfo.defaultVideoStream!==void 0&&(r.default_video_stream=this.joinInfo.defaultVideoStream),r}getRejoinMessage(){if(!this.joinInfo)throw new U(b.UNEXPECTED_ERROR,"can not generate rejoin message, no join info");return{session_id:this.joinInfo.sid,channel_name:this.joinInfo.cname,cid:this.joinInfo.cid,uid:this.joinInfo.uid,vid:Number(this.joinInfo.vid)}}handleSignalEvents(){this.signal.on(ht.WS_RECONNECT_WAITTING_FINISH,e=>{var n;it(n=["tryNext","recover"]).call(n,e)&&this.joinInfo&&Et.adjustSessionStartTime(this.joinInfo.sid)}),this.signal.on(ht.WS_RECONNECT_CREATE_CONNECTION,e=>{this.joinGatewayStartTime=Date.now()}),this.signal.on(ht.WS_RECONNECTING,e=>{this.joinInfo&&Et.WebSocketQuit(this.joinInfo.sid,{lts:Date.now(),succ:-1,cname:this.joinInfo.cname,uid:this.joinInfo.uid,cid:this.joinInfo.cid,errorCode:e||Kn.NETWORK_ERROR}),this.joinInfo&&(this.state="RECONNECTING",Et.sessionInit(this.joinInfo.sid,{lts:new Date().getTime(),extend:this.isSignalRecover?{recover:!0}:{rejoin:!0},cname:this.joinInfo.cname,appid:this.joinInfo.appId,mode:this.spec.mode,stringUid:this.joinInfo.stringUid,channelProfile:this.spec.mode==="live"?1:0,channelMode:0,lsid:this.joinInfo.sid,clientRole:this.role==="audience"?2:1,buildFormat:1}),this.isSignalRecover=!1,this.joinGatewayStartTime=Date.now())}),this.signal.on(ht.WS_CLOSED,e=>{let n;switch(e){case Ht.LEAVE:n=Kn.LEAVE;break;case Ht.UID_BANNED:case Ht.IP_BANNED:case Ht.CHANNEL_BANNED:case Ht.SERVER_ERROR:n=Kn.SERVER_ERROR;break;case Ht.FALLBACK:n=Kn.FALLBACK;break;case Ht.LICENSE_MISSING:case Ht.LICENSE_EXPIRED:case Ht.LICENSE_MINUTES_EXCEEDED:case Ht.LICENSE_PERIOD_INVALID:case Ht.LICENSE_MULTIPLE_SDK_SERVICE:case Ht.LICENSE_ILLEGAL:case Ht.TOKEN_EXPIRE:n=e;break;default:n=Kn.NETWORK_ERROR}E.debug("[".concat(this.store.clientId,"] [signal] websocket closed, reason: ").concat(n||"undefined -> "+Kn.NETWORK_ERROR)),this.joinInfo&&Et.WebSocketQuit(this.joinInfo.sid,{lts:Date.now(),succ:e===Ht.LEAVE?1:-1,cname:this.joinInfo.cname,uid:this.joinInfo.uid,cid:this.joinInfo.cid,errorCode:n}),this._disconnectedReason=e,e!==Ht.FALLBACK&&(this.state="DISCONNECTED"),this.reset()}),this.signal.on(ht.WS_CONNECTED,()=>{if(this.updateTurnConfigFromSignal(),this.state="CONNECTED",this.joinInfo&&(this.role==="audience"&&this._clientRoleOptions&&(this._clientRoleOptions.level||this._clientRoleOptions.delay)&&(E.debug("[".concat(this.store.clientId,"] patch to send set client role, role: ").concat(this.role,", mode: ").concat(this.spec.mode,", level: ").concat(this._clientRoleOptions.level,", delay: ").concat(this._clientRoleOptions.delay)),this.setClientRole(this.role,this._clientRoleOptions)),Et.joinGateway(this.joinInfo.sid,{lts:this.joinGatewayStartTime,succ:!0,ec:null,vid:this.joinInfo.vid,addr:this.signal.url,uid:this.joinInfo.uid,cid:this.joinInfo.cid,firstSuccess:this._isProactiveJoin,avoidJoinStartTime:this.store.avoidJoinStart,isProxy:!!this.joinInfo.proxyServer,signalChannel:this.signal instanceof Es?"1":"0"}),this._isProactiveJoin=!1,this.joinInfo.useLocalAccessPoint&&this.joinInfo.setLocalAPVersion===1)){const e=this.signal.url&&this.signal.url.match(/wss\:\/\/([^:]+):(\d+)/);if(!e)return void E.error("[".concat(this.store.clientId,"] set local access point after joined failed: ").concat(e));Re("EVENT_REPORT_DOMAIN",e[1]),Re("EVENT_REPORT_BACKUP_DOMAIN",e[1]),Re("LOG_UPLOAD_SERVER","".concat(e[1],":6444"))}}),this.signal.on(Nt.ON_UPLINK_STATS,e=>{this._statsCollector.updateUplinkStats(e)}),this.signal.on(ht.REQUEST_RECOVER,(e,n,i)=>{if(!this.joinInfo)return i(new U(b.UNEXPECTED_ERROR,"gateway: can not recover, no join info"));e&&(this.joinInfo.multiIP=e,this.hasChangeBGPAddress=!0),this.isSignalRecover=!0,En(this,nn.REQUEST_NEW_GATEWAY_LIST).then(n).catch(i)}),this.signal.on(ht.REQUEST_JOIN_INFO,async e=>{var n;if(this.updateTurnConfigFromSignal(),this.store.useP2P)return void e(this.getJoinMessage({ortc:{}}));const{iceParameters:i,dtlsParameters:r,rtpCapabilities:o}=await En(this,nn.REQUEST_P2P_CONNECTION_PARAMS,{turnServer:(n=this.joinInfo)===null||n===void 0?void 0:n.turnServer});e(this.getJoinMessage({ortc:{iceParameters:i,dtlsParameters:r,rtpCapabilities:o,version:"2"}}))}),this.signal.on(ht.REQUEST_REJOIN_INFO,e=>{e(this.getRejoinMessage())}),this.signal.on(ht.REPORT_JOIN_GATEWAY,(e,n)=>{this.joinInfo&&(Et.joinGateway(this.joinInfo.sid,{lts:this.joinGatewayStartTime,succ:!1,ec:e,addr:n,uid:this.joinInfo.uid,cid:this.joinInfo.cid,firstSuccess:this._isProactiveJoin,avoidJoinStartTime:this.store.avoidJoinStart,isProxy:!!this.joinInfo.proxyServer,signalChannel:this.signal instanceof Es?"1":"0"}),this._isProactiveJoin=!1)}),this.signal.on(ht.IS_P2P_DISCONNECTED,e=>{e(Ua(this,nn.IS_P2P_DISCONNECTED))}),this.signal.on(ht.DISCONNECT_P2P,()=>{this.emit(nn.DISCONNECT_P2P)}),this.signal.on(ht.NEED_RENEW_SESSION,e=>{this.emit(nn.NEED_RENEW_SESSION,e)}),this.signal.on(ht.REQUEST_SUCCESS,()=>{this._signalTimeout=!1}),this.signal.on(ht.REQUEST_TIMEOUT,()=>{this._signalTimeout=!0}),this.signal.on(ht.JOIN_RESPONSE,e=>{const n=this.getCurrentGatewayAddress();this.emit(nn.JOIN_RESPONSE,e,n)}),this.signal.on(ht.DATACHANNEL_PRECONNECT,async(e,n,i)=>{this.updateTurnConfigFromSignal();const r=this.getCurrentGatewayAddress();return En(this,nn.DATACHANNEL_PRECONNECT,e,r).then(n).catch(i)}),this.signal.on(ht.DATACHANNEL_CONNECTING,async e=>{const{iceParameters:n,dtlsParameters:i,rtpCapabilities:r}=await En(this,nn.REQUEST_DC_CONNECTION_PARAMS);e(this.getJoinMessage({ortc:{iceParameters:n,dtlsParameters:i,rtpCapabilities:r,version:"2"}}))}),this.signal.on(ht.DATACHANNEL_FAILBACK,()=>{E.warning("[".concat(this.store.clientId,"] User join datachannel failed")),this.reset(),this.resetSignal(),this.emit(nn.DATACHANNEL_FAILBACK)})}async tryUnsubBeforeResub(e,n){try{await this.signal.request(Tt.UNSUBSCRIBE,{p2p_id:this.store.p2pId,stream_id:e,ortc:[n]},!0)}catch(i){throw E.warning("[".concat(this.store.clientId,"] tryUnsubBeforeResub warning"),i),i}}async tryUnsubDataChannelBeforeResub(e,n){try{await this.signal.request(Tt.UNSUBSCRIBE,{stream_id:n.id},!0)}catch(i){throw E.warning("unsubscribe datachannel warning",i),i}}async tryUnpubBeforeRepub(e,n){try{await this.signal.request(Tt.UNPUBLISH,{stream_id:e,ortc:n},!0)}catch(i){throw E.warning("[".concat(this.store.clientId,"] tryUnpubBeforeRepub warning: "),i),i}}async tryUnpubDataChannelBeforeRepub(e,n){try{await this.signal.request(Tt.UNPUBLISH_DATASTREAM,{channnel_id:n.channelId},!0)}catch(i){throw E.warning("unpublish datastream warning: ",i),i}}async tryMassUnsubBeforeResub(e){const n={users:e.map(i=>({stream_id:i.stream_id,stream_type:i.stream_type}))};try{await this.signal.request(Tt.UNSUBSCRIBE_STREAMS,n,!0)}catch(i){throw E.warning("[".concat(this.store.clientId,"] tryMassUnsubBeforeResub warning"),i),i}}async muteLocal(e,n){const i={action:e.find(r=>r.stream_type===le.Audio)?"mute_local_audio":"mute_local_video",p2p_id:this.store.p2pId,ortc:e,stream_id:n};try{await this.signal.request(Tt.CONTROL,i,!0,!0)}catch(r){throw E.warning("[".concat(this.store.clientId,"] gateway muteLocal warning: "),r),r}}async unmuteLocal(e,n){const i={action:e.find(r=>r.stream_type===le.Audio)?"unmute_local_audio":"unmute_local_video",p2p_id:this.store.p2pId,ortc:e,stream_id:n};try{await this.signal.request(Tt.CONTROL,i,!0,!0)}catch(r){throw E.warning("[".concat(this.store.clientId,"] gateway unmuteLocal warning: "),r),r}}async muteRemote(e,n){const i={action:e===_t.AUDIO?"mute_remote_audio":"mute_remote_video",p2p_id:this.store.p2pId,stream_id:n};try{await this.signal.request(Tt.CONTROL,i,!0,!0)}catch(r){throw E.warning("[".concat(this.store.clientId,"] gateway muteRemote warning: "),r),r}}async unmuteRemote(e,n){const i={action:e===_t.AUDIO?"unmute_remote_audio":"unmute_remote_video",p2p_id:this.store.p2pId,stream_id:n};try{await this.signal.request(Tt.CONTROL,i,!0,!0)}catch(r){throw E.warning("[".concat(this.store.clientId,"] gateway unmuteRemote warning: "),r),r}}uploadWRTCStats(e){this.signal.uploadWRTCStats(e)}upload(e,n){this.signal.upload(e,n)}getSignalRTT(){return this.signal.rtt}async restartICE(e){const n={p2p_id:this.store.p2pId,stream_id:this.store.uid,ortc:e};try{return await this.signal.request(Tt.RESTART_ICE,n,!0)}catch(i){throw E.warning("[".concat(this.store.clientId,"] P2PChannel.restartICE warning: "),i),i}}reconnect(){this.state==="CONNECTED"&&this.signal.reconnect(void 0,Kn.P2P_FAILED)}getCurrentGatewayAddress(){var e;if(!N("GATEWAY_WSS_ADDRESS"))return(e=this.joinInfo)!==null&&e!==void 0&&e.gatewayAddrs?this.joinInfo.gatewayAddrs[this.signal.currentURLIndex]:void 0}async setPublishAudioFilterEnabled(e){await this.signal.request(Tt.SET_PARAMETER,{enablePublishAudioFilter:e})}resetSignal(){this.signal&&(this.signal.removeAllListeners(),this.signal.close(Ht.FALLBACK)),this.store.useDataChannel=!1,this.signal=new Nb(xr(xr({},this.spec),{},{retryConfig:this.spec.websocketRetryConfig}),this.store),this.handleSignalEvents(),this.emit(nn.RESET_SIGNAL,Cb.websocket)}}let zp=0,_g=0;function lo(t,e,n,i){return new ot((r,o)=>{e.timeout=e.timeout||N("HTTP_CONNECT_TIMEOUT"),e.responseType=e.responseType||"json",e.data&&!n?(e.data=JSON.stringify(e.data),zp+=Uo(e.data)):n&&(e.data.size?zp+=e.data.size:e.data instanceof FormData?zp+=tb(e.data):zp+=Uo(JSON.stringify(e.data))),e.headers=e.headers||{},e.headers["Content-Type"]=e.headers["Content-Type"]||"application/json",e.method="POST",e.url=t,yi.request(e).then(s=>{typeof s.data=="string"?_g+=Uo(s.data):s.data instanceof ArrayBuffer||s.data instanceof Uint8Array?_g+=s.data.byteLength:_g+=Uo(JSON.stringify(s.data)),i&&r({data:s.data,headers:s.headers}),r(s.data)}).catch(s=>{yi.isCancel(s)?o(new U(b.OPERATION_ABORTED,"cancel token canceled")):s.code==="ECONNABORTED"?o(new U(b.NETWORK_TIMEOUT,s.message)):s.response?o(new U(b.NETWORK_RESPONSE_ERROR,s.response.status)):o(new U(b.NETWORK_ERROR,s.message))})})}/*! formdata-polyfill. MIT License. Jimmy W?rting <https://jimmy.warting.se/opensource> */(function(){var t;function e(z){var tt=0;return function(){return tt<z.length?{done:!1,value:z[tt++]}:{done:!0}}}var n=typeof Object.defineProperties=="function"?Object.defineProperty:function(z,tt,ft){return z==Array.prototype||z==Object.prototype||(z[tt]=ft.value),z},i,r=function(z){z=[typeof globalThis=="object"&&globalThis,z,typeof window=="object"&&window,typeof self=="object"&&self,typeof Ut=="object"&&Ut];for(var tt=0;tt<z.length;++tt){var ft=z[tt];if(ft&&ft.Math==Math)return ft}throw Error("Cannot find global object")}(this);function o(z,tt){if(tt)t:{var ft=r;z=z.split(".");for(var wt=0;wt<z.length-1;wt++){var oe=z[wt];if(!(oe in ft))break t;ft=ft[oe]}(tt=tt(wt=ft[z=z[z.length-1]]))!=wt&&tt!=null&&n(ft,z,{configurable:!0,writable:!0,value:tt})}}function s(z){return(z={next:z})[Symbol.iterator]=function(){return this},z}function a(z){var tt=typeof Symbol!="undefined"&&Symbol.iterator&&z[Symbol.iterator];return tt?tt.call(z):{next:e(z)}}if(o("Symbol",function(z){function tt(oe,st){this.A=oe,n(this,"description",{configurable:!0,writable:!0,value:st})}if(z)return z;tt.prototype.toString=function(){return this.A};var ft="jscomp_symbol_"+(1e9*Math.random()>>>0)+"_",wt=0;return function oe(st){if(this instanceof oe)throw new TypeError("Symbol is not a constructor");return new tt(ft+(st||"")+"_"+wt++,st)}}),o("Symbol.iterator",function(z){if(z)return z;z=Symbol("Symbol.iterator");for(var tt="Array Int8Array Uint8Array Uint8ClampedArray Int16Array Uint16Array Int32Array Uint32Array Float32Array Float64Array".split(" "),ft=0;ft<tt.length;ft++){var wt=r[tt[ft]];typeof wt=="function"&&typeof wt.prototype[z]!="function"&&n(wt.prototype,z,{configurable:!0,writable:!0,value:function(){return s(e(this))}})}return z}),typeof Object.setPrototypeOf=="function")i=Object.setPrototypeOf;else{var c;t:{var d={};try{d.__proto__={a:!0},c=d.a;break t}catch{}c=!1}i=c?function(z,tt){if(z.__proto__=tt,z.__proto__!==tt)throw new TypeError(z+" is not extensible");return z}:null}var u=i;function l(){this.m=!1,this.j=null,this.v=void 0,this.h=1,this.u=this.C=0,this.l=null}function p(z){if(z.m)throw new TypeError("Generator is already running");z.m=!0}function f(z,tt){return z.h=3,{value:tt}}function C(z){this.g=new l,this.G=z}function m(z,tt,ft,wt){try{var oe=tt.call(z.g.j,ft);if(!(oe instanceof Object))throw new TypeError("Iterator result "+oe+" is not an object");if(!oe.done)return z.g.m=!1,oe;var st=oe.value}catch(T){return z.g.j=null,z.g.s(T),g(z)}return z.g.j=null,wt.call(z.g,st),g(z)}function g(z){for(;z.g.h;)try{var tt=z.G(z.g);if(tt)return z.g.m=!1,{value:tt.value,done:!1}}catch(ft){z.g.v=void 0,z.g.s(ft)}if(z.g.m=!1,z.g.l){if(tt=z.g.l,z.g.l=null,tt.F)throw tt.D;return{value:tt.return,done:!0}}return{value:void 0,done:!0}}function y(z){this.next=function(tt){return z.o(tt)},this.throw=function(tt){return z.s(tt)},this.return=function(tt){return function(ft,wt){p(ft.g);var oe=ft.g.j;return oe?m(ft,"return"in oe?oe.return:function(st){return{value:st,done:!0}},wt,ft.g.return):(ft.g.return(wt),g(ft))}(z,tt)},this[Symbol.iterator]=function(){return this}}function A(z,tt){return tt=new y(new C(tt)),u&&z.prototype&&u(tt,z.prototype),tt}if(l.prototype.o=function(z){this.v=z},l.prototype.s=function(z){this.l={D:z,F:!0},this.h=this.C||this.u},l.prototype.return=function(z){this.l={return:z},this.h=this.u},C.prototype.o=function(z){return p(this.g),this.g.j?m(this,this.g.j.next,z,this.g.o):(this.g.o(z),g(this))},C.prototype.s=function(z){return p(this.g),this.g.j?m(this,this.g.j.throw,z,this.g.o):(this.g.s(z),g(this))},o("Array.prototype.entries",function(z){return z||function(){return function(tt,ft){tt instanceof String&&(tt+="");var wt=0,oe=!1,st={next:function(){if(!oe&&wt<tt.length){var T=wt++;return{value:ft(T,tt[T]),done:!1}}return oe=!0,{done:!0,value:void 0}}};return st[Symbol.iterator]=function(){return st},st}(this,function(tt,ft){return[tt,ft]})}}),typeof Blob!="undefined"&&(typeof FormData=="undefined"||!FormData.prototype.keys)){var k=function(z,tt){for(var ft=0;ft<z.length;ft++)tt(z[ft])},M=function(z){return z.replace(/\r?\n|\r/g,`\r
`)},V=function(z,tt,ft){return tt instanceof Blob?(ft=ft!==void 0?String(ft+""):typeof tt.name=="string"?tt.name:"blob",tt.name===ft&&Object.prototype.toString.call(tt)!=="[object Blob]"||(tt=new File([tt],ft)),[String(z),tt]):[String(z),String(tt)]},B=function(z,tt){if(z.length<tt)throw new TypeError(tt+" argument required, but only "+z.length+" present.")},K=typeof globalThis=="object"?globalThis:typeof window=="object"?window:typeof self=="object"?self:this,Y=K.FormData,J=K.XMLHttpRequest&&K.XMLHttpRequest.prototype.send,lt=K.Request&&K.fetch,Yt=K.navigator&&K.navigator.sendBeacon,de=K.Element&&K.Element.prototype,Pe=K.Symbol&&Symbol.toStringTag;Pe&&(Blob.prototype[Pe]||(Blob.prototype[Pe]="Blob"),"File"in K&&!File.prototype[Pe]&&(File.prototype[Pe]="File"));try{new File([],"")}catch{K.File=function(tt,ft,wt){return tt=new Blob(tt,wt||{}),Object.defineProperties(tt,{name:{value:ft},lastModified:{value:+(wt&&wt.lastModified!==void 0?new Date(wt.lastModified):new Date)},toString:{value:function(){return"[object File]"}}}),Pe&&Object.defineProperty(tt,Pe,{value:"File"}),tt}}var hn=function(z){return z.replace(/\n/g,"%0A").replace(/\r/g,"%0D").replace(/"/g,"%22")},qe=function(z){this.i=[];var tt=this;z&&k(z.elements,function(ft){if(ft.name&&!ft.disabled&&ft.type!=="submit"&&ft.type!=="button"&&!ft.matches("form fieldset[disabled] *"))if(ft.type==="file"){var wt=ft.files&&ft.files.length?ft.files:[new File([],"",{type:"application/octet-stream"})];k(wt,function(oe){tt.append(ft.name,oe)})}else ft.type==="select-multiple"||ft.type==="select-one"?k(ft.options,function(oe){!oe.disabled&&oe.selected&&tt.append(ft.name,oe.value)}):ft.type==="checkbox"||ft.type==="radio"?ft.checked&&tt.append(ft.name,ft.value):(wt=ft.type==="textarea"?M(ft.value):ft.value,tt.append(ft.name,wt))})};if((t=qe.prototype).append=function(z,tt,ft){B(arguments,2),this.i.push(V(z,tt,ft))},t.delete=function(z){B(arguments,1);var tt=[];z=String(z),k(this.i,function(ft){ft[0]!==z&&tt.push(ft)}),this.i=tt},t.entries=function z(){var tt,ft=this;return A(z,function(wt){if(wt.h==1&&(tt=0),wt.h!=3)return tt<ft.i.length?wt=f(wt,ft.i[tt]):(wt.h=0,wt=void 0),wt;tt++,wt.h=2})},t.forEach=function(z,tt){B(arguments,1);for(var ft=a(this),wt=ft.next();!wt.done;wt=ft.next()){var oe=a(wt.value);wt=oe.next().value,oe=oe.next().value,z.call(tt,oe,wt,this)}},t.get=function(z){B(arguments,1);var tt=this.i;z=String(z);for(var ft=0;ft<tt.length;ft++)if(tt[ft][0]===z)return tt[ft][1];return null},t.getAll=function(z){B(arguments,1);var tt=[];return z=String(z),k(this.i,function(ft){ft[0]===z&&tt.push(ft[1])}),tt},t.has=function(z){B(arguments,1),z=String(z);for(var tt=0;tt<this.i.length;tt++)if(this.i[tt][0]===z)return!0;return!1},t.keys=function z(){var tt,ft,wt,oe,st=this;return A(z,function(T){if(T.h==1&&(tt=a(st),ft=tt.next()),T.h!=3)return ft.done?void(T.h=0):(wt=ft.value,oe=a(wt),f(T,oe.next().value));ft=tt.next(),T.h=2})},t.set=function(z,tt,ft){B(arguments,2),z=String(z);var wt=[],oe=V(z,tt,ft),st=!0;k(this.i,function(T){T[0]===z?st&&(st=!wt.push(oe)):wt.push(T)}),st&&wt.push(oe),this.i=wt},t.values=function z(){var tt,ft,wt,oe,st=this;return A(z,function(T){if(T.h==1&&(tt=a(st),ft=tt.next()),T.h!=3)return ft.done?void(T.h=0):(wt=ft.value,(oe=a(wt)).next(),f(T,oe.next().value));ft=tt.next(),T.h=2})},qe.prototype._asNative=function(){for(var z=new Y,tt=a(this),ft=tt.next();!ft.done;ft=tt.next()){var wt=a(ft.value);ft=wt.next().value,wt=wt.next().value,z.append(ft,wt)}return z},qe.prototype._blob=function(){var z="----formdata-polyfill-"+Math.random(),tt=[],ft="--"+z+`\r
Content-Disposition: form-data; name="`;return this.forEach(function(wt,oe){return typeof wt=="string"?tt.push(ft+hn(M(oe))+`"\r
\r
`+M(wt)+`\r
`):tt.push(ft+hn(M(oe))+'"; filename="'+hn(wt.name)+`"\r
Content-Type: `+(wt.type||"application/octet-stream")+`\r
\r
`,wt,`\r
`)}),tt.push("--"+z+"--"),new Blob(tt,{type:"multipart/form-data; boundary="+z})},qe.prototype[Symbol.iterator]=function(){return this.entries()},qe.prototype.toString=function(){return"[object FormData]"},de&&!de.matches&&(de.matches=de.matchesSelector||de.mozMatchesSelector||de.msMatchesSelector||de.oMatchesSelector||de.webkitMatchesSelector||function(z){for(var tt=(z=(this.document||this.ownerDocument).querySelectorAll(z)).length;0<=--tt&&z.item(tt)!==this;);return-1<tt}),Pe&&(qe.prototype[Pe]="FormData"),J){var Qr=K.XMLHttpRequest.prototype.setRequestHeader;K.XMLHttpRequest.prototype.setRequestHeader=function(z,tt){Qr.call(this,z,tt),z.toLowerCase()==="content-type"&&(this.B=!0)},K.XMLHttpRequest.prototype.send=function(z){z instanceof qe?(z=z._blob(),this.B||this.setRequestHeader("Content-Type",z.type),J.call(this,z)):J.call(this,z)}}lt&&(K.fetch=function(z,tt){return tt&&tt.body&&tt.body instanceof qe&&(tt.body=tt.body._blob()),lt.call(this,z,tt)}),Yt&&(K.navigator.sendBeacon=function(z,tt){return tt instanceof qe&&(tt=tt._asNative()),Yt.call(this,z,tt)}),K.FormData=qe}})();const nl=()=>{const t=N("AREAS");return t.length===0&&t.push(re.GLOBAL),io(t).call(t,(e,n,i)=>{const r=Fb(n);return r?i===0?r:"".concat(e,",").concat(r):e},"")},Fb=t=>t===re.OVERSEA?"".concat(Zn.ASIA,",").concat(Zn.EUROPE,",").concat(Zn.AFRICA,",").concat(Zn.NORTH_AMERICA,",").concat(Zn.SOUTH_AMERICA,",").concat(Zn.OCEANIA):Zn[t],tB=t=>{const e={CODE:"",WEBCS_DOMAIN:[],WEBCS_DOMAIN_BACKUP_LIST:[],PROXY_CS:[],CDS_AP:[],ACCOUNT_REGISTER:[],UAP_AP:[],EVENT_REPORT_DOMAIN:[],EVENT_REPORT_BACKUP_DOMAIN:[],LOG_UPLOAD_SERVER:[],PROXY_SERVER_TYPE3:[]};return t.map(n=>{const i=Kp[n],r=Object.keys(i);r&&r.map(o=>{o!=="CODE"&&(e[o]=e[o].concat(i[o]))})}),e},Jp={GLOBAL:{ASIA:[re.CHINA,re.JAPAN,re.INDIA,re.KOREA,re.HKMC],EUROPE:[],NORTH_AMERICA:[re.US],SOUTH_AMERICA:[],OCEANIA:[],AFRICA:[]}},Xp=Object.keys(Jp[re.GLOBAL]),Eg=[re.CHINA,re.NORTH_AMERICA,re.EUROPE,re.ASIA,re.JAPAN,re.INDIA,re.OCEANIA,re.SOUTH_AMERICA,re.AFRICA,re.KOREA,re.HKMC,re.US],eB=function(t,e){let n=[];if(it(t).call(t,re.GLOBAL)){const o=[re.GLOBAL,re.OVERSEA],s=Object.keys(Kp);if(e===re.GLOBAL)throw new U(b.INVALID_PARAMS,"GLOBAL is an invalid excludedArea value");if(e===re.CHINA)n=[re.OVERSEA];else if(r=e,it(Xp).call(Xp,r)){const a=(i=e,Jp[re.GLOBAL][i]||[]),c=[...o,e,...a];n=s.filter(d=>!it(c).call(c,d))}else if(function(a){let c=!1;return Xp.forEach(d=>{var u;it(u=Jp[re.GLOBAL][d]).call(u,a)&&(c=!0)}),c}(e)){const a=function(d){let u;return Xp.forEach(l=>{var p;it(p=Jp[re.GLOBAL][l]).call(p,d)&&(u=l)}),u}(e),c=[...o,a,e];n=s.filter(d=>!it(c).call(c,d))}else n=t;n=function(a){const c=[];return Eg.forEach(d=>{it(a).call(a,d)&&c.push(d)}),c.concat(a.filter(d=>!it(Eg).call(Eg,d)))}(n)}else n=t;var i,r;return n};function jb(t){var e,n;if(!t&&it(e=N("AREAS")).call(e,re.EXTENSIONS))return E.debug("update area from ap : reset"),void mg(JF,!0);if(!it(n=N("AREAS")).call(n,re.GLOBAL)||!t)return;let i=Kp.EXTENSIONS;i&&(i={CODE:Fb(re.EXTENSIONS),WEBCS_DOMAIN:["ap-web-1-".concat(t,".agora.io")],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-".concat(t,".ap.sd-rtn.com")],PROXY_CS:["proxy-ap-web-".concat(t,".agora.io")],CDS_AP:["cds-ap-web-1-".concat(t,".agora.io"),"cds-ap-web-2-".concat(t,".ap.sd-rtn.com")],ACCOUNT_REGISTER:["sua-ap-web-1-".concat(t,".agora.io"),"sua-ap-web-2-".concat(t,".ap.sd-rtn.com")],UAP_AP:["uap-ap-web-1-".concat(t,".agora.io"),"uap-ap-web-2-".concat(t,".ap.sd-rtn.com")],EVENT_REPORT_DOMAIN:["statscollector-1-".concat(t,".agora.io")],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-".concat(t,".agora.io")],LOG_UPLOAD_SERVER:["logservice-".concat(t,".agora.io")],PROXY_SERVER_TYPE3:["webrtc-cloud-proxy-".concat(t,".agora.io")]},E.debug("update area from ap success: ".concat(t,",config is "),i),Re("AREAS",[re.EXTENSIONS],!0),Object.keys(i).map(r=>{r==="LOG_UPLOAD_SERVER"||r==="EVENT_REPORT_DOMAIN"||r==="EVENT_REPORT_BACKUP_DOMAIN"||r==="PROXY_SERVER_TYPE3"?Re(r,i[r][0]):Re(r,i[r])}))}function mg(t){let e=arguments.length>1&&arguments[1]!==void 0&&arguments[1];const n=Et.reportApiInvoke(null,{name:_n.SET_AREA,options:t,tag:Je.TRACER});try{let i=[];if(typeof t=="string"&&(i=[t]),Array.isArray(t)&&(t.forEach(o=>{if(!it(vb).call(vb,o))throw new U(b.INVALID_PARAMS,"invalid area code")}),i=t),Object.prototype.toString.call(t)==="[object Object]"){const{areaCode:o,excludedArea:s}=t;if(!o)throw new U(b.INVALID_PARAMS,"area code is needed");let a=o;typeof o=="string"&&(a=[o]),i=s?eB(a,s):a}if(!e){if(qs.AREAS){const o=new U(b.PROHIBITED_OPERATION,"setArea is prohibited because of config-distribute");return n.onError(o),void E.warning("setArea is prohibited because of config-distribute")}if(it(i).call(i,re.GLOBAL)&&N("AREAS")===re.EXTENSIONS){const o=new U(b.PROHIBITED_OPERATION,"setArea is prohibited because of ap extensions");return n.onError(o),void E.warning("setArea is prohibited because of ap extensions")}}Re("AREAS",i,e);const r=tB(i);Object.keys(r).map(o=>{o==="LOG_UPLOAD_SERVER"||o==="EVENT_REPORT_DOMAIN"||o==="EVENT_REPORT_BACKUP_DOMAIN"||o==="PROXY_SERVER_TYPE3"?Re(o,r[o][0]):Re(o,r[o])}),E.debug("set area success:",i.join(","))}catch(i){throw n.onError(i),i}n.onSuccess()}function Bb(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),n.push.apply(n,i)}return n}function gg(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?Bb(Object(n),!0).forEach(function(i){R(t,i,n[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):Bb(Object(n)).forEach(function(i){Object.defineProperty(t,i,Object.getOwnPropertyDescriptor(n,i))})}return t}let Tg=1;function nB(t,e,n,i,r){Tg+=1;const o={sid:n.sid,command:"convergeAllocateEdge",uid:"666",appId:n.appId,ts:Math.floor(Date.now()/1e3),seq:Tg,requestId:Tg,version:pr,cname:n.cname},s={service_name:e,json_body:JSON.stringify(o)};let a,c,d=t[0];return so(async()=>{a=Date.now();const u=await lo(d,{data:s,cancelToken:i,headers:{"X-Packet-Service-Type":"0","X-Packet-URI":"61"}});if(c=Date.now()-a,u.code!==0){const f=new U(b.UNEXPECTED_RESPONSE,"live streaming ap error, code"+u.code,{retry:!0,responseTime:c});throw E.error(f.toString()),f}const l=JSON.parse(u.json_body);if(l.code!==200){const f=new U(b.UNEXPECTED_RESPONSE,"live streaming app center error, code: ".concat(l.code,", reason: ").concat(l.reason),{code:l.code,responseTime:c});throw E.error(f.toString()),f}if(!l.servers||l.servers.length===0){const f=new U(b.UNEXPECTED_RESPONSE,"live streaming app center empty server",{code:l.code,responseTime:c});throw E.error(f.toString()),f}const p=function(f,C){return{addressList:f.servers.map(m=>"wss://".concat(m.address.replace(/\./g,"-"),".").concat(N("WORKER_DOMAIN"),":").concat(m.wss,"?serviceName=").concat(encodeURIComponent(C))),workerToken:f.workerToken,vid:f.vid}}(l,e);return N("LIVE_STREAMING_ADDRESS")&&(p.addressList=N("LIVE_STREAMING_ADDRESS")instanceof Array?N("LIVE_STREAMING_ADDRESS"):[N("LIVE_STREAMING_ADDRESS")]),gg(gg({},p),{},{responseTime:c})},(u,l)=>(Et.apworkerEvent(n.sid,{success:!0,sc:200,serviceName:e,responseDetail:JSON.stringify(u.addressList),firstSuccess:l===0,responseTime:c,serverIp:t[l%t.length]}),!1),(u,l)=>(Et.apworkerEvent(n.sid,{success:!1,sc:u.data&&u.data.code||200,serviceName:e,responseTime:c,serverIp:t[l%t.length]}),!!(u.code!==b.OPERATION_ABORTED&&u.code!==b.UNEXPECTED_RESPONSE||u.data&&u.data.retry)&&(d=t[(l+1)%t.length],!0)),r)}let Sg=1;function Gb(t,e,n,i){let{url:r,areaCode:o}=t;const{clientId:s,sid:a}=e,c=Date.now();let d;const[u,l]=Cg(e,o,[un.CHOOSE_SERVER]);let p=Xe.networkState;return so(async()=>{p&&Xe.networkState===_i.OFFLINE&&Xe.onlineWaiter&&await ot.race([Xe.onlineWaiter,wn(i&&i.maxRetryTimeout||dn.maxRetryTimeout)]),p=Xe.networkState;const{data:f,headers:C}=await lo(r,{data:u,cancelToken:n,headers:{"Content-Type":"multipart/form-data;"}},!0,!0);d=C.http3==="1"?1:-1,Et.reportResourceTiming(r,a),Hb(f,r,e,c,[un.CHOOSE_SERVER],d);const m=el(f,un.CHOOSE_SERVER);return Rg(m),hg(m,r)},f=>(f&&Et.joinChooseServer(a,{lts:c,succ:!0,csAddr:r,opid:l,serverList:f.gatewayAddrs.map(C=>C.address),ec:null,cid:f.cid.toString(),uid:f.uid.toString(),csIp:f.csIp,unilbsServerIds:[un.CHOOSE_SERVER].toString(),isHttp3:d}),!1),f=>f.code!==b.OPERATION_ABORTED&&(f.code===b.CAN_NOT_GET_GATEWAY_SERVER?f.data.retry:(Et.joinChooseServer(a,{lts:c,succ:!1,csAddr:r,serverList:null,opid:l,ec:f.code,csIp:f.data&&f.data.csIp,unilbsServerIds:[un.CHOOSE_SERVER].toString(),extend:JSON.stringify({networkState:p}),isHttp3:d}),E.warning("[".concat(s||"sid-".concat(a.slice(0,6)),"] Choose server network error, retry"),f),!0)),i)}function Wb(t,e,n,i){let r,{url:o,areaCode:s,serviceIds:a}=t;const c=Date.now(),[d,u]=Cg(e,s,a);let l;return so(async()=>{l&&Xe.networkState===_i.OFFLINE&&Xe.onlineWaiter&&await ot.race([Xe.onlineWaiter,wn(i&&i.maxRetryTimeout||dn.maxRetryTimeout)]),l=Xe.networkState;const{data:p,headers:f}=await lo(o,{data:d,cancelToken:n,headers:{"Content-Type":"multipart/form-data;"}},!0,!0);r=f.http3==="1"?1:-1,Et.reportResourceTiming(o,e.sid),Hb(p,o,e,c,a,r);const C=el(p,un.CHOOSE_SERVER),m=el(p,e.cloudProxyServer==="proxy5"?un.CLOUD_PROXY_5:e.cloudProxyServer==="proxy3"||e.cloudProxyServer==="proxy4"?un.CLOUD_PROXY:un.CLOUD_PROXY_FALLBACK);return Rg(C),{gatewayInfo:hg(C,o),proxyInfo:m,url:o}},p=>(p.gatewayInfo&&Et.joinChooseServer(e.sid,{lts:c,succ:!0,csAddr:o,serverList:p.gatewayInfo.gatewayAddrs.map(f=>f.address),ec:null,opid:u,cid:p.gatewayInfo.cid.toString(),uid:p.gatewayInfo.uid.toString(),csIp:p.gatewayInfo.csIp,unilbsServerIds:a.toString(),isHttp3:r}),p.proxyInfo&&Et.joinWebProxyAP(e.sid,{lts:c,sucess:1,apServerAddr:o,turnServerAddrList:p.proxyInfo.addresses.map(f=>f.ip).join(","),errorCode:null,eventType:e.cloudProxyServer,unilbsServerIds:a.toString()}),!1),p=>p.code!==b.OPERATION_ABORTED&&(p.code===b.CAN_NOT_GET_GATEWAY_SERVER?p.data.retry:(Et.joinWebProxyAP(e.sid,{lts:c,sucess:0,apServerAddr:o,turnServerAddrList:null,errorCode:p.code,eventType:e.cloudProxyServer,unilbsServerIds:a.toString(),extend:JSON.stringify({networkState:l})}),E.warning("[".concat(e.clientId,"] multi unilbs network error, retry"),p),!0)),i)}const Hb=(t,e,n,i,r,o)=>{const{sid:s,clientId:a,cloudProxyServer:c}=n,d=[],u=l=>{l.flag===4096?Et.joinChooseServer(s,{lts:i,succ:!1,csAddr:e,opid:t.opid,serverList:null,ec:l.error.message,csIp:l.error.data&&l.error.data.csIp,unilbsServerIds:r.toString(),isHttp3:o}):l.flag!==1048576&&l.flag!==4194304&&l.flag!==4194310||Et.joinWebProxyAP(s,{lts:i,sucess:0,apServerAddr:e,turnServerAddrList:null,errorCode:l.error.code,eventType:c,unilbsServerIds:r.toString()})};if(t.response_body.forEach(l=>{const p=l.buffer.code;if(l.uri===23&&p===0&&!l.buffer.edges_services)if(l.buffer.flag===4194310)E.warning("no edge services in ap response of proxy fallback, will not set proxy in iceServers"),l.buffer.edges_services=[];else{const f={error:new U(b.CAN_NOT_GET_GATEWAY_SERVER,"no edge services in ap response",{retry:!0,csIp:t.detail[502]}),flag:l.buffer.flag};d.push(f),u(f)}if(p!==0){const f=ad(p),C={error:new U(b.CAN_NOT_GET_GATEWAY_SERVER,f.desc,{desc:f.desc,retry:f.retry,csIp:t.detail[502]}),flag:l.buffer.flag};l.buffer.flag===4194310?E.warning(C.error.toString()):d.push(C),u(C)}}),d.length)throw E.warning("[".concat(a||"sid-".concat(s.slice(0,6)),"] multi unilbs ").concat(e," failed, ").concat(d.map(l=>"flag: ".concat(l.flag,", message: ").concat(l.error.message,", retry: ").concat(l.error.data.retry)).join(" | "))),new U(b.CAN_NOT_GET_GATEWAY_SERVER,d.map(l=>"flag: ".concat(l.flag,", message: ").concat(l.error.message)).join(" | "),{retry:!!d.find(l=>l.error.data.retry),csIp:t.detail[502],desc:[...new Set(d.map(l=>{var p;return l==null||(p=l.error)===null||p===void 0||(p=p.data)===null||p===void 0?void 0:p.desc}).filter(l=>!!l))]})},Rg=t=>{var e,n,i,r;if(t.addresses&&t.addresses.length===0&&t.code===0)throw new U(b.CAN_NOT_GET_GATEWAY_SERVER,"void gateway address",{retry:!0,csIp:t.detail&&t.detail[502]});if(N("AP_AREA")&&((i=t.detail)!==null&&i!==void 0&&i[23]&&typeof((r=t.detail)===null||r===void 0?void 0:r[23])=="string"?jb(t.detail[23].toLowerCase()):jb()),(e=t.detail)!==null&&e!==void 0&&e[19]&&typeof((n=t.detail)===null||n===void 0?void 0:n[19])=="string"){const s=t.detail[19],a=s==null?void 0:s.split(";");for(let c=0;c<a.length;c++){var o;const d=si(o=a[c]).call(o);t.addresses[c]&&a&&(t.addresses[c].fingerprint=d)}}if(N("GATEWAY_ADDRESS")&&N("GATEWAY_ADDRESS").length>0){E.debug("assign gateway address to",N("GATEWAY_ADDRESS"));const s=N("GATEWAY_ADDRESS").map(a=>{var c,d;const u=(c=(d=t.addresses.find(l=>l.ip===a.ip&&l.port===a.port))===null||d===void 0?void 0:d.fingerprint)!==null&&c!==void 0?c:"";return{ip:a.ip,port:a.port,ticket:t.addresses[0]&&t.addresses[0].ticket,fingerprint:u}});t.addresses=s}},iB=(t,e)=>{if(t.response_body&&t.response_body.length){const n=t.response_body[0];if(n.buffer.code!==0){const i=ad(n.buffer.code);throw new U(b.UPDATE_TICKET_FAILED,"[".concat(n.buffer.code,"]: ").concat(i.desc),{retry:i.retry})}return n.buffer.ticket}throw E.debug("update ticket request received ap response without response body:",e),new U(b.UPDATE_TICKET_FAILED,"cannot find response body from ap response",{retry:!1})},Cg=(t,e,n)=>{const i=Math.floor(Math.random()*1e12),r={appid:t.appId,client_ts:Date.now(),opid:i,sid:t.sid,request_bodies:[{uri:22,buffer:{cname:t.cname,detail:gg({6:t.stringUid,11:e,12:N("USE_NEW_TOKEN")?"1":void 0,22:e},t.apRTM?{26:"RTM2"}:{}),key:t.token,service_ids:n,uid:t.uid||0}}]};r.request_bodies.forEach(s=>{t.multiIP&&t.multiIP.gateway_ip&&(s.buffer.detail[5]=JSON.stringify({vocs_ip:[t.multiIP.uni_lbs_ip],vos_ip:[t.multiIP.gateway_ip]}))});const o=new FormData;return o.append("request",JSON.stringify(r)),[o,i]},rB=(t,e)=>{const n=Math.floor(Math.random()*1e12),i={appid:t.appId,client_ts:Date.now(),opid:n,sid:t.sid,request_bodies:[{uri:28,buffer:{cname:t.cname,detail:{1:"",6:t.stringUid,12:"1"},token:t.token,service_ids:e,uid:t.uid||0,edges_services:t.apResponse.addresses.map(o=>({ip:o.ip,port:o.port}))}}]},r=new FormData;return r.append("request",JSON.stringify(i)),[r,n]};let cd=0;function dd(t){return ot.all(t.map(e=>e.then(n=>{throw n},n=>n))).then(e=>{throw e},e=>e)}const il=async t=>{let{fragementLength:e,referenceList:n,asyncMapHandler:i,allFailedhandler:r,promisesCollector:o}=t,s=0;const a=e;let c,d=0;const u=async()=>{const l=(()=>{const p=s*a,f=p+a;return n.slice(p,f).map(i)})();o&&o.push(...l);try{c=await dd(l)}catch(p){if(d+=a,s++,!(d>=n.length))return void await u();r(p)}l.forEach(p=>p.cancel())};return await u(),c},Kb=async t=>{let{referenceList:e,asyncMapHandler:n,closeFn:i}=t;const r=e.length;let o=0;const s=async()=>{const a=n(e.shift());try{return await a}catch(c){if(o++,o>=r||i!=null&&i(c))throw c;return s()}};return s()};async function vg(t,e,n,i){return{gatewayInfo:await async function(o,s,a,c){let d=null;const u=[],l=async()=>{const f=N("WEBCS_DOMAIN").slice(0,N("AJAX_REQUEST_CONCURRENT")).map(g=>({url:o.proxyServer?"https://".concat(o.proxyServer,"/ap/?url=").concat(g+"/api/v2/transpond/webrtc?v=2"):"https://".concat(g,"/api/v2/transpond/webrtc?v=2"),areaCode:nl()})),C=c.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"chooseServer",urls:f.map(g=>g.url)}),m=await il({fragementLength:N("FRAGEMENT_LENGTH"),referenceList:f,asyncMapHandler:g=>(E.debug("[".concat(o.clientId,"] Connect to choose_server:"),g.url),Gb(g,o,s,a)),allFailedhandler:g=>{throw c.recordJoinChannelService({endTs:Date.now(),status:"error",errors:g},C),g[0]},promisesCollector:u});return c.recordJoinChannelService({endTs:Date.now(),status:"success"},C),m},p=async()=>{if(await wn(1e3),d!==null)return d;const f=N("WEBCS_DOMAIN_BACKUP_LIST").map(g=>({url:o.proxyServer?"https://".concat(o.proxyServer,"/ap/?url=").concat(g+"/api/v2/transpond/webrtc?v=2"):"https://".concat(g,"/api/v2/transpond/webrtc?v=2"),areaCode:nl()})),C=c.recordJoinChannelService({endTs:void 0,startTs:Date.now(),status:"pending",service:"chooseServer",urls:f.map(g=>g.url)}),m=await il({fragementLength:N("FRAGEMENT_LENGTH"),referenceList:f,asyncMapHandler:g=>(E.debug("[".concat(o.clientId,"] Connect to backup choose_server:"),g.url),Gb(g,o,s,a)),allFailedhandler:g=>{throw c.recordJoinChannelService({endTs:Date.now(),status:"error",errors:g},C),g[0]},promisesCollector:u});return c.recordJoinChannelService({endTs:Date.now(),status:"success"},C),m};try{return d=await dd([l(),p()]),u.length&&u.forEach(f=>f.cancel&&typeof f.cancel=="function"&&f.cancel()),d}catch(f){throw f[0]}}(t,e,n,i)}}async function qb(t,e,n,i,r){const o=t.cloudProxyServer;if(o==="disabled"){if(!i)return;if(t.useLocalAccessPoint)return await vg(t,e,n,r);if(N("JOIN_WITH_FALLBACK_MEDIA_PROXY")){const{gatewayInfo:p,proxyInfo:f}=await Jb(t,e,n,r);if(t.turnServer&&t.turnServer.mode!=="auto")return{gatewayInfo:p};const C=f.map(m=>({turnServerURL:m.address,tcpport:m.tcpport||qn.tcpport,udpport:m.udpport||qn.udpport,username:m.username||qn.username,password:m.password||qn.password,forceturn:!1,security:!0}));if(r.useP2P){var s;const m=(s=t.uid)!==null&&s!==void 0?s:p.uid,g="glb:".concat(m.toString()),y=await qm(g),A=f.map(k=>({turnServerURL:k.address,tcpport:k.tcpport||qn.tcpport,udpport:k.udpport||qn.udpport,username:g,password:y,forceturn:!1,security:!0}));C.push(...A)}return t.turnServer={mode:"manual",servers:C},{gatewayInfo:p}}return await vg(t,e,n,r)}const{proxyInfo:a,gatewayInfo:c}=await Jb(t,e,n,r),d={gatewayInfo:c},u=a.map(p=>({turnServerURL:p.address,tcpport:o==="proxy3"?void 0:p.tcpport?p.tcpport:qn.tcpport,udpport:o==="proxy4"?void 0:p.udpport?p.udpport:qn.udpport,username:p.username||qn.username,password:p.password||qn.password,forceturn:o!=="proxy4",security:o==="proxy5"}));if(r.useP2P){var l;const p=(l=t.uid)!==null&&l!==void 0?l:c.uid,f="glb:".concat(p.toString()),C=await qm(f),m=a.map(g=>({turnServerURL:g.address,tcpport:o==="proxy3"?void 0:g.tcpport||qn.tcpport,udpport:o==="proxy4"?void 0:g.udpport||qn.udpport,username:f,password:C,forceturn:o!=="proxy4",security:o==="proxy5"}));u.push(...m)}return t.turnServer={mode:"manual",servers:u},E.debug("[".concat(t.clientId,"] set proxy server: ").concat(t.proxyServer,", mode: ").concat(o)),d}async function Yb(t,e,n,i,r){const o=N("ACCOUNT_REGISTER").slice(0,N("AJAX_REQUEST_CONCURRENT"));let s=[];s=e.proxyServer?o.map(c=>"https://".concat(e.proxyServer,"/ap/?url=").concat(c+"/api/v1")):o.map(c=>"https://".concat(c,"/api/v1"));const a=r==null?void 0:r.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"stringUID",urls:s});try{const c=await async function(d,u,l,p,f){const C=Date.now(),m={sid:l.sid,opid:10,appid:l.appId,string_uid:u};let g=d[0];const y=await so(()=>lo(g+"".concat(g.indexOf("?")===-1?"?":"&","action=stringuid"),{data:m,cancelToken:p,headers:{"X-Packet-Service-Type":0,"X-Packet-URI":72}}),(A,k)=>{if(A.code===0){if(A.uid<=0||A.uid>=Math.pow(2,32))throw E.error("Invalid Uint Uid ".concat(u," => ").concat(A.uid),A),Et.reqUserAccount(m.sid,{lts:C,success:!1,serverAddr:g,stringUid:m.string_uid,uid:A.uid,errorCode:b.INVALID_UINT_UID_FROM_STRING_UID,extend:m}),new U(b.INVALID_UINT_UID_FROM_STRING_UID);return Et.reqUserAccount(m.sid,{lts:C,success:!0,serverAddr:g,stringUid:m.string_uid,uid:A.uid,errorCode:null,extend:m}),!1}const M=ad(A.code);return M.retry&&(g=d[(k+1)%d.length]),Et.reqUserAccount(m.sid,{lts:C,success:!1,serverAddr:g,stringUid:m.string_uid,uid:A.uid,errorCode:M.desc,extend:m}),M.retry},(A,k)=>A.code!==b.OPERATION_ABORTED&&(Et.reqUserAccount(m.sid,{lts:C,success:!1,serverAddr:g,stringUid:m.string_uid,uid:null,errorCode:A.code,extend:m}),g=d[(k+1)%d.length],!0),f);if(y.code!==0){const A=ad(y.code);throw new U(b.UNEXPECTED_RESPONSE,A.desc)}return y}(s,t,e,n,i);return r==null||r.recordJoinChannelService({status:"success",endTs:Date.now()},a),c.uid}catch(c){throw r==null||r.recordJoinChannelService({status:"error",endTs:Date.now(),errors:[c]},a),c}}async function oB(t,e,n){const i=N("ACCOUNT_REGISTER");let r=[];r=e.proxyServer?i.map(o=>"https://".concat(e.proxyServer,"/ap/?url=").concat(o+"/api/v1")):i.map(o=>"https://".concat(o,"/api/v1"));try{return await Kb({referenceList:r,asyncMapHandler:s=>async function(a,c,d,u){const l=Date.now(),p={sid:d.sid,opid:10,appid:d.appId,string_uid:c};try{const f=await lo(a+"".concat(a.indexOf("?")===-1?"?":"&","action=stringuid"),{data:p,cancelToken:u,headers:{"X-Packet-Service-Type":0,"X-Packet-URI":72}});if(f.code!==0){const C=ad(f.code);throw new U(b.UNEXPECTED_RESPONSE,"preload sua error:".concat(C.desc),C)}if(f.uid<=0||f.uid>=Math.pow(2,32))throw new U(b.INVALID_UINT_UID_FROM_STRING_UID);return{requestTime:l,url:a,req:p,uid:f.uid,elapse:Date.now()-l}}catch(f){throw f}}(s,t,e,n),closeFn:s=>s.code===b.OPERATION_ABORTED||s.code===b.UNEXPECTED_RESPONSE&&!s.data.retry})}catch(o){throw o}}async function sB(t,e,n){const i=N("CDS_AP").slice(0,N("AJAX_REQUEST_CONCURRENT")).map(c=>t.proxyServer?"https://".concat(t.proxyServer,"/ap/?url=").concat(c+"/api/v1"):"https://".concat(c,"/api/v1?action=config")),r=i.map(c=>function(d,u,l,p){const f=Zt(),C={flag:64,cipher_method:0,features:{device:f.name,system:f.os,system_general:navigator.userAgent,vendor:u.appId,version:pr,cname:u.cname,sid:u.sid,session_id:u.sid,detail:"",proxyServer:u.proxyServer}};return so(()=>lo(d,{data:C,timeout:1e3,cancelToken:l,headers:{"X-Packet-Service-Type":0,"X-Packet-URI":54}}),void 0,m=>m.code!==b.OPERATION_ABORTED,p)}(c,t,e,n));let o=null,s=null,a={};try{o=await dd(r)}catch(c){if(c.code===b.OPERATION_ABORTED)throw c;s=c}if(r.forEach(c=>c.cancel()),Et.reportApiInvoke(t.sid,{name:_n.REQUEST_CONFIG_DISTRIBUTE,options:{error:s,res:o}}).onSuccess(),o&&o.test_tags)try{a=function(c){if(!c.test_tags)return{};const d=c.test_tags,u=Object.keys(d),l={};return u.forEach(p=>{var f;const C=si(f=p.slice(4)).call(f),m=JSON.parse(d[p])[1];l[C]=m}),l}(o)}catch{}return a}async function zb(t,e){const n=N("WEBCS_DOMAIN").concat(N("WEBCS_DOMAIN_BACKUP_LIST")).map(i=>({url:"https://".concat(i,"/api/v2/transpond/webrtc?v=2"),areaCode:nl(),serviceIds:[un.CHOOSE_SERVER,un.CLOUD_PROXY_FALLBACK]}));try{return await Kb({referenceList:n,asyncMapHandler:r=>async function(o,s,a){let c,{url:d,areaCode:u,serviceIds:l}=o;const p=Date.now(),[f,C]=Cg(s,u,l);let m=Xe.networkState;try{m&&Xe.networkState===_i.OFFLINE&&Xe.onlineWaiter&&await ot.race([Xe.onlineWaiter,wn(dn.maxRetryTimeout)]),m=Xe.networkState;const{data:g,headers:y}=await lo(d,{data:f,cancelToken:a,headers:{"Content-Type":"multipart/form-data;"}},!0,!0);c=y.http3==="1"?1:-1,(V=>{const B=[];if(V.response_body.forEach(K=>{const Y=K.buffer.code;if(K.uri===23&&Y===0&&!K.buffer.edges_services)if(K.buffer.flag===4194310)K.buffer.edges_services=[];else{const J={error:new U(b.CAN_NOT_GET_GATEWAY_SERVER,"no edge services in ap response",{retry:!0,csIp:V.detail[502]}),flag:K.buffer.flag};B.push(J)}if(Y!==0){const J=ad(Y),lt={error:new U(b.CAN_NOT_GET_GATEWAY_SERVER,J.desc,{desc:J.desc,retry:J.retry,csIp:V.detail[502]}),flag:K.buffer.flag};K.buffer.flag===4194310?E.warning(lt.error.toString()):B.push(lt)}}),B.length)throw new U(b.CAN_NOT_GET_GATEWAY_SERVER,B.map(K=>"flag: ".concat(K.flag,", message: ").concat(K.error.message)).join(" | "),{retry:!!B.find(K=>K.error.data.retry),csIp:V.detail[502],desc:[...new Set(B.map(K=>{var Y;return K==null||(Y=K.error)===null||Y===void 0||(Y=Y.data)===null||Y===void 0?void 0:Y.desc}).filter(K=>!!K))]})})(g);const k=el(g,un.CHOOSE_SERVER),M=el(g,un.CLOUD_PROXY_FALLBACK);return Rg(k),{gatewayInfo:hg(k,d),proxyInfo:M,opid:C,requestTime:p,url:d,isHttp3:c,elapse:Date.now()-p}}catch(g){throw g}}(r,t,e),closeFn:r=>r.code===b.OPERATION_ABORTED||r.code===b.CAN_NOT_GET_GATEWAY_SERVER&&!r.data.retry})}catch(i){throw i}}async function Jb(t,e,n,i){const r=N("PROXY_SERVER_TYPE3"),o=(f,C,m)=>{let g=m||r;return Array.isArray(g)&&(g=C%2==0?r[1]:r[0]),"https://".concat(g,"/ap/?url=").concat(f)};let s=null;const a=[],c=async()=>{const f=N("WEBCS_DOMAIN").slice(0,N("AJAX_REQUEST_CONCURRENT")).map((g,y)=>{let A;return A=t.cloudProxyServer==="disabled"&&t.proxyServer?o("".concat(g,"/api/v2/transpond/webrtc?v=2"),y,t.proxyServer):t.cloudProxyServer==="disabled"||t.cloudProxyServer==="fallback"?"https://".concat(g,"/api/v2/transpond/webrtc?v=2"):o("".concat(g,"/api/v2/transpond/webrtc?v=2"),y),{url:A,areaCode:nl(),serviceIds:[un.CHOOSE_SERVER,t.cloudProxyServer==="proxy5"?un.CLOUD_PROXY_5:t.cloudProxyServer==="proxy3"||t.cloudProxyServer==="proxy4"?un.CLOUD_PROXY:un.CLOUD_PROXY_FALLBACK]}}),C=i.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"chooseServer",urls:f.map(g=>g.url)}),m=await il({fragementLength:N("FRAGEMENT_LENGTH"),referenceList:f,asyncMapHandler:g=>(E.debug("[".concat(t.clientId,"] Connect to choose_server:"),g.url),Wb(g,t,e,n)),allFailedhandler:g=>{throw i.recordJoinChannelService({endTs:Date.now(),status:"error",errors:g},C),g[0]},promisesCollector:a});return i.recordJoinChannelService({endTs:Date.now(),status:"success"},C),m},d=async()=>{if(await wn(1e3),s!==null)return s;const f=N("WEBCS_DOMAIN_BACKUP_LIST").map((g,y)=>{let A;return A=t.cloudProxyServer==="disabled"&&t.proxyServer?o("".concat(g,"/api/v2/transpond/webrtc?v=2"),y,t.proxyServer):t.cloudProxyServer==="disabled"||t.cloudProxyServer==="fallback"?"https://".concat(g,"/api/v2/transpond/webrtc?v=2"):o("".concat(g,"/api/v2/transpond/webrtc?v=2"),y),{url:A,areaCode:nl(),serviceIds:[un.CHOOSE_SERVER,t.cloudProxyServer==="proxy5"?un.CLOUD_PROXY_5:t.cloudProxyServer==="proxy3"||t.cloudProxyServer==="proxy4"?un.CLOUD_PROXY:un.CLOUD_PROXY_FALLBACK]}}),C=i.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"chooseServer",urls:f.map(g=>g.url)}),m=await il({fragementLength:N("FRAGEMENT_LENGTH"),referenceList:f,asyncMapHandler:g=>(E.debug("[".concat(t.clientId,"] Connect to backup choose_server:"),g.url),Wb(g,t,e,n)),allFailedhandler:g=>{throw i.recordJoinChannelService({endTs:Date.now(),status:"error",errors:g},C),g[0]},promisesCollector:a});return i.recordJoinChannelService({endTs:Date.now(),status:"success"},C),m};let u,l,p;try{({gatewayInfo:u,proxyInfo:l,url:p}=await dd([c(),d()]))}catch(f){throw f[0]}if(a.length&&a.forEach(f=>f.cancel&&typeof f.cancel=="function"&&f.cancel()),!u||!l)throw new U(b.UNEXPECTED_ERROR,"missing gateway or proxy response").print();if(t.apUrl=p,t.cloudProxyServer!=="disabled"&&Array.isArray(r)&&p){const f=/^https?:\/\/(.+?)(\/.*)?$/.exec(p)[1];it(r).call(r,f)&&(t.proxyServer=f,E.setProxyServer(f),Et.setProxyServer(f))}return s={gatewayInfo:u,proxyInfo:await kb(l,u.uid)},s}async function Xb(t,e,n,i){const r=N("UAP_AP").slice(0,N("AJAX_REQUEST_CONCURRENT")).map(o=>e.proxyServer?"https://".concat(e.proxyServer,"/ap/?url=").concat(o+"/api/v1?action=uap"):"https://".concat(o,"/api/v1?action=uap"));return await nB(r,t,e,n,i)}async function aB(t,e,n){const i=N("UAP_AP").slice(0,N("AJAX_REQUEST_CONCURRENT")).map(o=>t.proxyServer?"https://".concat(t.proxyServer,"/ap/?url=").concat(o+"/api/v1?action=uap"):"https://".concat(o,"/api/v1?action=uap")),r=i.map(o=>function(s,a,c,d){const u={command:"convergeAllocateEdge",sid:a.sid,appId:a.appId,token:a.token,ts:Date.now(),version:pr,cname:a.cname,uid:a.uid.toString(),requestId:Sg,seq:Sg};Sg+=1;const l={service_name:"tele_channel",json_body:JSON.stringify(u)};return so(async()=>{const p=await lo(s,{data:l,cancelToken:c,headers:{"X-Packet-Service-Type":0,"X-Packet-URI":61}});if(p.code!==0){const C=new U(b.UNEXPECTED_RESPONSE,"cross channel ap error, code"+p.code,{retry:!0});throw E.error(C.toString()),C}const f=JSON.parse(p.json_body);if(f.code!==200){const C=new U(b.UNEXPECTED_RESPONSE,"cross channel app center error, code: ".concat(f.code,", reason: ").concat(f.reason));throw E.error(C.toString()),C}if(!f.servers||f.servers.length===0){const C=new U(b.UNEXPECTED_RESPONSE,"cross channel app center empty server");throw E.error(C.toString()),C}return{vid:f.vid,workerToken:f.workerToken,addressList:(N("CHANNEL_MEDIA_RELAY_SERVERS")||f.servers).map(C=>"wss://".concat(C.address.replace(/\./g,"-"),".").concat(N("WORKER_DOMAIN"),":").concat(C.wss))}},void 0,p=>!!(p.code!==b.OPERATION_ABORTED&&p.code!==b.UNEXPECTED_RESPONSE||p.data&&p.data.retry),d)}(o,t,e,n));try{const o=await dd(r);return r.forEach(s=>s.cancel()),o}catch(o){throw o[0]}}async function cB(t,e,n){let i=null;const r=[],o=async s=>{const a=N(s?"WEBCS_DOMAIN_BACKUP_LIST":"WEBCS_DOMAIN").map(c=>t.proxyServer?"https://".concat(t.proxyServer,"/ap/?url=").concat(c+"/api/v2/transpond/webrtc?v=2"):"https://".concat(c,"/api/v2/transpond/webrtc?v=2"));return s&&(await wn(1e3),i!==null)?i:await il({fragementLength:N("FRAGEMENT_LENGTH"),referenceList:a,asyncMapHandler:c=>(E.debug("[".concat(t.clientId,"] update ticket, Connect to ").concat(s?"backup":""," choose_server:"),c),function(d,u,l,p){const[f]=rB(u,[un.CHOOSE_SERVER]);let C=Xe.networkState;return so(async()=>{C&&Xe.networkState===_i.OFFLINE&&Xe.onlineWaiter&&await ot.race([Xe.onlineWaiter,wn(p&&p.maxRetryTimeout||dn.maxRetryTimeout)]),C=Xe.networkState;const m=await lo(d,{data:f,cancelToken:l,headers:{"Content-Type":"multipart/form-data;"}},!0);return iB(m,d)},()=>!1,m=>m.code!==b.OPERATION_ABORTED&&(m.code===b.UPDATE_TICKET_FAILED?m.data.retry:(E.warning("[".concat(u.clientId,"] update ticket network error, retry"),m),!0)),p)}(c,t,e,n)),allFailedhandler:c=>{throw c[0]},promisesCollector:r})};try{return i=await dd([o(!1),o(!0)]),r.length&&r.forEach(s=>s.cancel&&typeof s.cancel=="function"&&s.cancel()),i}catch(s){throw s[0]}}function Qb(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),n.push.apply(n,i)}return n}function Zb(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?Qb(Object(n),!0).forEach(function(i){R(t,i,n[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):Qb(Object(n)).forEach(function(i){Object.defineProperty(t,i,Object.getOwnPropertyDescriptor(n,i))})}return t}class dB extends Ve{get isSuccess(){return!!this.configs}constructor(){super(),R(this,"configs",void 0),R(this,"joinInfo",void 0),R(this,"cancelToken",void 0),R(this,"retryConfig",{timeout:3e3,timeoutFactor:1.5,maxRetryCount:1,maxRetryTimeout:1e4}),R(this,"interval",void 0),R(this,"mutex",new kn("config-distribute")),R(this,"mutableParamsRead",!1)}startGetConfigDistribute(e,n){this.joinInfo=e,this.cancelToken=n,this.interval&&this.stopGetConfigDistribute(),N("ENABLE_CONFIG_DISTRIBUTE")&&(this.updateConfigDistribute(),this.interval=window.setInterval(()=>{this.updateConfigDistribute()},N("CONFIG_DISTRIBUTE_INTERVAL")))}stopGetConfigDistribute(){this.interval&&clearInterval(this.interval),this.interval=void 0,this.joinInfo=void 0,this.cancelToken=void 0}async awaitConfigDistributeComplete(){!this.mutex.isLocked||(await this.mutex.lock())()}async updateConfigDistribute(){if(this.mutableParamsRead||(this.mutableParamsRead=!0,Et.reportApiInvoke(null,{options:void 0,name:_n.LOAD_CONFIG_FROM_LOCALSTORAGE,tag:Je.TRACER}).onSuccess(JSON.stringify(qs))),!this.joinInfo||!this.cancelToken||!this.retryConfig)return void E.debug("[config-distribute] get config distribute interrupted have no joininfo");let e;const n=await this.mutex.lock();try{e=await sB(this.joinInfo,this.cancelToken,this.retryConfig),E.debug("[config-distribute] get config distribute",JSON.stringify(e)),e.limit_bitrate&&this.handleBitrateLimit(e.limit_bitrate),this.cacheGlobalParameterConfig(e),this.configs=e}catch(i){const r=new U(b.NETWORK_RESPONSE_ERROR,i);E.warning("[config-distribute] ".concat(r.toString()))}finally{n()}}getBitrateLimit(){return this.configs?this.configs.limit_bitrate:void 0}handleBitrateLimit(e){var n;(n=e)&&n.uplink&&n.id&&n.uplink.max_bitrate!==void 0&&n.uplink.min_bitrate!==void 0&&(this.configs&&this.configs.limit_bitrate?this.configs&&this.configs.limit_bitrate&&this.configs.limit_bitrate.id!==e.id&&this.emit(ug.UPDATE_BITRATE_LIMIT,e):this.emit(ug.UPDATE_BITRATE_LIMIT,e))}getLowStreamConfigDistribute(){return this.configs&&this.configs.limit_bitrate&&Zb({},this.configs.limit_bitrate.low_stream_uplink)}cacheGlobalParameterConfig(e){var n;const i=Du(n=Object.keys(e).filter(o=>/^webrtc_ng_global_parameter/.test(o))).call(n);for(let o=0;o<i.length;o++)for(let s=i.length-1;s>o;s--){const a=i[s];if(typeof e[a].__priority=="number"){const c=e[a].__priority,d=i[s-1];if(typeof e[d].__priority=="number"){if(!(c>e[d].__priority))continue;{const u=a;i[s]=i[s-1],i[s-1]=u}}else{const u=a;i[s]=i[s-1],i[s-1]=u}}}const r={};i.forEach(o=>{const s=e[o],a=s.__expires;Object.keys(s).forEach(c=>{c==="__priority"||c==="__expires"||Object.prototype.hasOwnProperty.call(r,c)||(r[c]=Zb({value:s[c]},a&&{expires:a}))})});try{(function(a){try{const c=Date.now();Object.keys(a).forEach(d=>{switch(d){case"ENABLE_EVENT_REPORT":case"UPLOAD_LOG":case"ENABLE_AG_ADAPTATION":case"FORCE_AG_HIGH_FRAMERATE":case"FORCE_SUPPORT_AG_ADAPTATION":case"ENCODER_CONFIG_LIMIT":case"CAMERA_CAPTURE_CONFIG":case"ENABLE_PRELOAD":if(Object.prototype.hasOwnProperty.call(Rn,d)){const{value:u,expires:l}=a[d];if(l&&l<=c)return;qs[d]=u,Rn[d]=u,E.debug("Update global parameters from config distribute",d,u)}}})}catch(c){E.error("Error update config immediately: ".concat(a),c.message)}})(r);const o=JSON.stringify(r),s=window.btoa(o);window.localStorage.setItem("websdk_ng_global_parameter",s),E.debug("Caching global parameters ".concat(o))}catch(o){E.error("Error caching global parameters:",o.message)}}}var Vr,uB=Dt(gb),$b=Vi,lB=Ge,hB=cn,pB=Pt,yg=kh,fB=Su,_B=Sa,EB=br,mB=_c,ud=Object.assign,tA=Object.defineProperty,gB=lB([].concat),TB=!ud||pB(function(){if($b&&ud({b:1},ud(tA({},"a",{enumerable:!0,get:function(){tA(this,"b",{value:3,enumerable:!1})}}),{b:2})).b!==1)return!0;var t={},e={},n=Symbol(),i="abcdefghijklmnopqrst";return t[n]=7,i.split("").forEach(function(r){e[r]=r}),ud({},t)[n]!=7||yg(ud({},e)).join("")!=i})?function(t,e){for(var n=EB(t),i=arguments.length,r=1,o=fB.f,s=_B.f;i>r;)for(var a,c=mB(arguments[r++]),d=o?gB(yg(c),o(c)):yg(c),u=d.length,l=0;u>l;)a=d[l++],$b&&!hB(s,c,a)||(n[a]=c[a]);return n}:ud,SB=Gn,RB=PS,CB=eo,vB=cn,yB=br,IB=function(t,e,n,i){try{return i?e(SB(n)[0],n[1]):e(n)}catch(r){RB(t,"throw",r)}},bB=OS,AB=qh,wB=ri,eA=op,OB=B_,NB=xh,nA=Array,Ha=Ge,Ig=2147483647,DB=/[^\0-\u007E]/,iA=/[.\u3002\uFF0E\uFF61]/g,rA="Overflow: input needs wider integers to process",oA=RangeError,PB=Ha(iA.exec),ld=Math.floor,bg=String.fromCharCode,sA=Ha("".charCodeAt),aA=Ha([].join),Zs=Ha([].push),LB=Ha("".replace),kB=Ha("".split),MB=Ha("".toLowerCase),cA=function(t){return t+22+75*(t<26)},UB=function(t,e,n){var i=0;for(t=n?ld(t/700):t>>1,t+=ld(t/e);t>455;)t=ld(t/35),i+=36;return ld(i+36*t/(t+38))},xB=function(t){var e=[];t=function(y){for(var A=[],k=0,M=y.length;k<M;){var V=sA(y,k++);if(V>=55296&&V<=56319&&k<M){var B=sA(y,k++);(64512&B)==56320?Zs(A,((1023&V)<<10)+(1023&B)+65536):(Zs(A,V),k--)}else Zs(A,V)}return A}(t);var n,i,r=t.length,o=128,s=0,a=72;for(n=0;n<t.length;n++)(i=t[n])<128&&Zs(e,bg(i));var c=e.length,d=c;for(c&&Zs(e,"-");d<r;){var u=Ig;for(n=0;n<t.length;n++)(i=t[n])>=o&&i<u&&(u=i);var l=d+1;if(u-o>ld((Ig-s)/l))throw oA(rA);for(s+=(u-o)*l,o=u,n=0;n<t.length;n++){if((i=t[n])<o&&++s>Ig)throw oA(rA);if(i==o){for(var p=s,f=36;;){var C=f<=a?1:f>=a+26?26:f-a;if(p<C)break;var m=p-C,g=36-C;Zs(e,bg(cA(C+m%g))),p=ld(m/g),f+=36}Zs(e,bg(cA(p))),a=UB(s,l,d==c),s=0,d++}}s++,o++}return aA(e,"")},VB=$t,Ag=Vi,FB=_m,wg=Lt,dA=eo,Fr=Ge,Qp=Ms,jr=Kh,jB=tE,Og=Dn,Ng=TB,hd=function(t){var e=yB(t),n=AB(this),i=arguments.length,r=i>1?arguments[1]:void 0,o=r!==void 0;o&&(r=CB(r,i>2?arguments[2]:void 0));var s,a,c,d,u,l,p=NB(e),f=0;if(!p||this===nA&&bB(p))for(s=wB(e),a=n?new this(s):nA(s);s>f;f++)l=o?r(e[f],f):e[f],eA(a,f,l);else for(u=(d=OB(e,p)).next,a=n?new this:[];!(c=vB(u,d)).done;f++)l=o?IB(d,r,[c.value,f],!0):c.value,eA(a,f,l);return a.length=f,a},ho=WE,BB=DE.codeAt,GB=function(t){var e,n,i=[],r=kB(LB(MB(t),iA,"."),".");for(e=0;e<r.length;e++)n=r[e],Zs(i,PB(DB,n)?"xn--"+xB(n):n);return aA(i,".")},ms=x,WB=Us,HB=Yh,uA=JV,lA=Oa,KB=lA.set,Zp=lA.getterFor("URL"),qB=uA.URLSearchParams,YB=uA.getState,rl=wg.URL,Dg=wg.TypeError,$p=wg.parseInt,zB=Math.floor,hA=Math.pow,Br=Fr("".charAt),po=Fr(/./.exec),ol=Fr([].join),JB=Fr(1 .toString),XB=Fr([].pop),pd=Fr([].push),Pg=Fr("".replace),QB=Fr([].shift),ZB=Fr("".split),sl=Fr("".slice),tf=Fr("".toLowerCase),$B=Fr([].unshift),Lg="Invalid scheme",Ka="Invalid host",pA="Invalid port",fA=/[a-z]/i,tG=/[\d+-.a-z]/i,kg=/\d/,eG=/^0x/i,nG=/^[0-7]+$/,iG=/^\d+$/,_A=/^[\da-f]+$/i,rG=/[\0\t\n\r #%/:<>?@[\\\]^|]/,oG=/[\0\t\n\r #/:<>?@[\\\]^|]/,sG=/^[\u0000-\u0020]+/,aG=/(^|[^\u0000-\u0020])[\u0000-\u0020]+$/,cG=/[\t\n\r]/g,al=function(t){var e,n,i,r;if(typeof t=="number"){for(e=[],n=0;n<4;n++)$B(e,t%256),t=zB(t/256);return ol(e,".")}if(typeof t=="object"){for(e="",i=function(o){for(var s=null,a=1,c=null,d=0,u=0;u<8;u++)o[u]!==0?(d>a&&(s=c,a=d),c=null,d=0):(c===null&&(c=u),++d);return d>a&&(s=c,a=d),s}(t),n=0;n<8;n++)r&&t[n]===0||(r&&(r=!1),i===n?(e+=n?":":"::",r=!0):(e+=JB(t[n],16),n<7&&(e+=":")));return"["+e+"]"}return t},ef={},EA=Ng({},ef,{" ":1,'"':1,"<":1,">":1,"`":1}),mA=Ng({},EA,{"#":1,"?":1,"{":1,"}":1}),Mg=Ng({},mA,{"/":1,":":1,";":1,"=":1,"@":1,"[":1,"\\":1,"]":1,"^":1,"|":1}),$s=function(t,e){var n=BB(t,0);return n>32&&n<127&&!Og(e,t)?t:encodeURIComponent(t)},nf={ftp:21,file:null,http:80,https:443,ws:80,wss:443},cl=function(t,e){var n;return t.length==2&&po(fA,Br(t,0))&&((n=Br(t,1))==":"||!e&&n=="|")},gA=function(t){var e;return t.length>1&&cl(sl(t,0,2))&&(t.length==2||(e=Br(t,2))==="/"||e==="\\"||e==="?"||e==="#")},dG=function(t){return t==="."||tf(t)==="%2e"},Ug={},TA={},xg={},SA={},RA={},Vg={},CA={},vA={},rf={},of={},Fg={},jg={},Bg={},Gg={},yA={},Wg={},fd={},Fo={},IA={},qa={},gs={},Hg=function(t,e,n){var i,r,o,s=ms(t);if(e){if(r=this.parse(s))throw Dg(r);this.searchParams=null}else{if(n!==void 0&&(i=new Hg(n,!0)),r=this.parse(s,null,i))throw Dg(r);(o=YB(new qB)).bindURL(this),this.searchParams=o}};Hg.prototype={type:"URL",parse:function(t,e,n){var i,r,o,s,a,c=this,d=e||Ug,u=0,l="",p=!1,f=!1,C=!1;for(t=ms(t),e||(c.scheme="",c.username="",c.password="",c.host=null,c.port=null,c.path=[],c.query=null,c.fragment=null,c.cannotBeABaseURL=!1,t=Pg(t,sG,""),t=Pg(t,aG,"$1")),t=Pg(t,cG,""),i=hd(t);u<=i.length;){switch(r=i[u],d){case Ug:if(!r||!po(fA,r)){if(e)return Lg;d=xg;continue}l+=tf(r),d=TA;break;case TA:if(r&&(po(tG,r)||r=="+"||r=="-"||r=="."))l+=tf(r);else{if(r!=":"){if(e)return Lg;l="",d=xg,u=0;continue}if(e&&(c.isSpecial()!=Og(nf,l)||l=="file"&&(c.includesCredentials()||c.port!==null)||c.scheme=="file"&&!c.host))return;if(c.scheme=l,e)return void(c.isSpecial()&&nf[c.scheme]==c.port&&(c.port=null));l="",c.scheme=="file"?d=Gg:c.isSpecial()&&n&&n.scheme==c.scheme?d=SA:c.isSpecial()?d=vA:i[u+1]=="/"?(d=RA,u++):(c.cannotBeABaseURL=!0,pd(c.path,""),d=IA)}break;case xg:if(!n||n.cannotBeABaseURL&&r!="#")return Lg;if(n.cannotBeABaseURL&&r=="#"){c.scheme=n.scheme,c.path=ho(n.path),c.query=n.query,c.fragment="",c.cannotBeABaseURL=!0,d=gs;break}d=n.scheme=="file"?Gg:Vg;continue;case SA:if(r!="/"||i[u+1]!="/"){d=Vg;continue}d=rf,u++;break;case RA:if(r=="/"){d=of;break}d=Fo;continue;case Vg:if(c.scheme=n.scheme,r==Vr)c.username=n.username,c.password=n.password,c.host=n.host,c.port=n.port,c.path=ho(n.path),c.query=n.query;else if(r=="/"||r=="\\"&&c.isSpecial())d=CA;else if(r=="?")c.username=n.username,c.password=n.password,c.host=n.host,c.port=n.port,c.path=ho(n.path),c.query="",d=qa;else{if(r!="#"){c.username=n.username,c.password=n.password,c.host=n.host,c.port=n.port,c.path=ho(n.path),c.path.length--,d=Fo;continue}c.username=n.username,c.password=n.password,c.host=n.host,c.port=n.port,c.path=ho(n.path),c.query=n.query,c.fragment="",d=gs}break;case CA:if(!c.isSpecial()||r!="/"&&r!="\\"){if(r!="/"){c.username=n.username,c.password=n.password,c.host=n.host,c.port=n.port,d=Fo;continue}d=of}else d=rf;break;case vA:if(d=rf,r!="/"||Br(l,u+1)!="/")continue;u++;break;case rf:if(r!="/"&&r!="\\"){d=of;continue}break;case of:if(r=="@"){p&&(l="%40"+l),p=!0,o=hd(l);for(var m=0;m<o.length;m++){var g=o[m];if(g!=":"||C){var y=$s(g,Mg);C?c.password+=y:c.username+=y}else C=!0}l=""}else if(r==Vr||r=="/"||r=="?"||r=="#"||r=="\\"&&c.isSpecial()){if(p&&l=="")return"Invalid authority";u-=hd(l).length+1,l="",d=Fg}else l+=r;break;case Fg:case jg:if(e&&c.scheme=="file"){d=Wg;continue}if(r!=":"||f){if(r==Vr||r=="/"||r=="?"||r=="#"||r=="\\"&&c.isSpecial()){if(c.isSpecial()&&l=="")return Ka;if(e&&l==""&&(c.includesCredentials()||c.port!==null))return;if(s=c.parseHost(l))return s;if(l="",d=fd,e)return;continue}r=="["?f=!0:r=="]"&&(f=!1),l+=r}else{if(l=="")return Ka;if(s=c.parseHost(l))return s;if(l="",d=Bg,e==jg)return}break;case Bg:if(!po(kg,r)){if(r==Vr||r=="/"||r=="?"||r=="#"||r=="\\"&&c.isSpecial()||e){if(l!=""){var A=$p(l,10);if(A>65535)return pA;c.port=c.isSpecial()&&A===nf[c.scheme]?null:A,l=""}if(e)return;d=fd;continue}return pA}l+=r;break;case Gg:if(c.scheme="file",r=="/"||r=="\\")d=yA;else{if(!n||n.scheme!="file"){d=Fo;continue}if(r==Vr)c.host=n.host,c.path=ho(n.path),c.query=n.query;else if(r=="?")c.host=n.host,c.path=ho(n.path),c.query="",d=qa;else{if(r!="#"){gA(ol(ho(i,u),""))||(c.host=n.host,c.path=ho(n.path),c.shortenPath()),d=Fo;continue}c.host=n.host,c.path=ho(n.path),c.query=n.query,c.fragment="",d=gs}}break;case yA:if(r=="/"||r=="\\"){d=Wg;break}n&&n.scheme=="file"&&!gA(ol(ho(i,u),""))&&(cl(n.path[0],!0)?pd(c.path,n.path[0]):c.host=n.host),d=Fo;continue;case Wg:if(r==Vr||r=="/"||r=="\\"||r=="?"||r=="#"){if(!e&&cl(l))d=Fo;else if(l==""){if(c.host="",e)return;d=fd}else{if(s=c.parseHost(l))return s;if(c.host=="localhost"&&(c.host=""),e)return;l="",d=fd}continue}l+=r;break;case fd:if(c.isSpecial()){if(d=Fo,r!="/"&&r!="\\")continue}else if(e||r!="?")if(e||r!="#"){if(r!=Vr&&(d=Fo,r!="/"))continue}else c.fragment="",d=gs;else c.query="",d=qa;break;case Fo:if(r==Vr||r=="/"||r=="\\"&&c.isSpecial()||!e&&(r=="?"||r=="#")){if((a=tf(a=l))===".."||a==="%2e."||a===".%2e"||a==="%2e%2e"?(c.shortenPath(),r=="/"||r=="\\"&&c.isSpecial()||pd(c.path,"")):dG(l)?r=="/"||r=="\\"&&c.isSpecial()||pd(c.path,""):(c.scheme=="file"&&!c.path.length&&cl(l)&&(c.host&&(c.host=""),l=Br(l,0)+":"),pd(c.path,l)),l="",c.scheme=="file"&&(r==Vr||r=="?"||r=="#"))for(;c.path.length>1&&c.path[0]==="";)QB(c.path);r=="?"?(c.query="",d=qa):r=="#"&&(c.fragment="",d=gs)}else l+=$s(r,mA);break;case IA:r=="?"?(c.query="",d=qa):r=="#"?(c.fragment="",d=gs):r!=Vr&&(c.path[0]+=$s(r,ef));break;case qa:e||r!="#"?r!=Vr&&(r=="'"&&c.isSpecial()?c.query+="%27":c.query+=r=="#"?"%23":$s(r,ef)):(c.fragment="",d=gs);break;case gs:r!=Vr&&(c.fragment+=$s(r,EA))}u++}},parseHost:function(t){var e,n,i;if(Br(t,0)=="["){if(Br(t,t.length-1)!="]"||(e=function(r){var o,s,a,c,d,u,l,p=[0,0,0,0,0,0,0,0],f=0,C=null,m=0,g=function(){return Br(r,m)};if(g()==":"){if(Br(r,1)!=":")return;m+=2,C=++f}for(;g();){if(f==8)return;if(g()!=":"){for(o=s=0;s<4&&po(_A,g());)o=16*o+$p(g(),16),m++,s++;if(g()=="."){if(s==0||(m-=s,f>6))return;for(a=0;g();){if(c=null,a>0){if(!(g()=="."&&a<4))return;m++}if(!po(kg,g()))return;for(;po(kg,g());){if(d=$p(g(),10),c===null)c=d;else{if(c==0)return;c=10*c+d}if(c>255)return;m++}p[f]=256*p[f]+c,++a!=2&&a!=4||f++}if(a!=4)return;break}if(g()==":"){if(m++,!g())return}else if(g())return;p[f++]=o}else{if(C!==null)return;m++,C=++f}}if(C!==null)for(u=f-C,f=7;f!=0&&u>0;)l=p[f],p[f--]=p[C+u-1],p[C+--u]=l;else if(f!=8)return;return p}(sl(t,1,-1)),!e))return Ka;this.host=e}else if(this.isSpecial()){if(t=GB(t),po(rG,t)||(e=function(r){var o,s,a,c,d,u,l,p=ZB(r,".");if(p.length&&p[p.length-1]==""&&p.length--,(o=p.length)>4)return r;for(s=[],a=0;a<o;a++){if((c=p[a])=="")return r;if(d=10,c.length>1&&Br(c,0)=="0"&&(d=po(eG,c)?16:8,c=sl(c,d==8?1:2)),c==="")u=0;else{if(!po(d==10?iG:d==8?nG:_A,c))return r;u=$p(c,d)}pd(s,u)}for(a=0;a<o;a++)if(u=s[a],a==o-1){if(u>=hA(256,5-o))return null}else if(u>255)return null;for(l=XB(s),a=0;a<s.length;a++)l+=s[a]*hA(256,3-a);return l}(t),e===null))return Ka;this.host=e}else{if(po(oG,t))return Ka;for(e="",n=hd(t),i=0;i<n.length;i++)e+=$s(n[i],ef);this.host=e}},cannotHaveUsernamePasswordPort:function(){return!this.host||this.cannotBeABaseURL||this.scheme=="file"},includesCredentials:function(){return this.username!=""||this.password!=""},isSpecial:function(){return Og(nf,this.scheme)},shortenPath:function(){var t=this.path,e=t.length;!e||this.scheme=="file"&&e==1&&cl(t[0],!0)||t.length--},serialize:function(){var t=this,e=t.scheme,n=t.username,i=t.password,r=t.host,o=t.port,s=t.path,a=t.query,c=t.fragment,d=e+":";return r!==null?(d+="//",t.includesCredentials()&&(d+=n+(i?":"+i:"")+"@"),d+=al(r),o!==null&&(d+=":"+o)):e=="file"&&(d+="//"),d+=t.cannotBeABaseURL?s[0]:s.length?"/"+ol(s,"/"):"",a!==null&&(d+="?"+a),c!==null&&(d+="#"+c),d},setHref:function(t){var e=this.parse(t);if(e)throw Dg(e);this.searchParams.update()},getOrigin:function(){var t=this.scheme,e=this.port;if(t=="blob")try{return new _d(t.path[0]).origin}catch{return"null"}return t!="file"&&this.isSpecial()?t+"://"+al(this.host)+(e!==null?":"+e:""):"null"},getProtocol:function(){return this.scheme+":"},setProtocol:function(t){this.parse(ms(t)+":",Ug)},getUsername:function(){return this.username},setUsername:function(t){var e=hd(ms(t));if(!this.cannotHaveUsernamePasswordPort()){this.username="";for(var n=0;n<e.length;n++)this.username+=$s(e[n],Mg)}},getPassword:function(){return this.password},setPassword:function(t){var e=hd(ms(t));if(!this.cannotHaveUsernamePasswordPort()){this.password="";for(var n=0;n<e.length;n++)this.password+=$s(e[n],Mg)}},getHost:function(){var t=this.host,e=this.port;return t===null?"":e===null?al(t):al(t)+":"+e},setHost:function(t){this.cannotBeABaseURL||this.parse(t,Fg)},getHostname:function(){var t=this.host;return t===null?"":al(t)},setHostname:function(t){this.cannotBeABaseURL||this.parse(t,jg)},getPort:function(){var t=this.port;return t===null?"":ms(t)},setPort:function(t){this.cannotHaveUsernamePasswordPort()||((t=ms(t))==""?this.port=null:this.parse(t,Bg))},getPathname:function(){var t=this.path;return this.cannotBeABaseURL?t[0]:t.length?"/"+ol(t,"/"):""},setPathname:function(t){this.cannotBeABaseURL||(this.path=[],this.parse(t,fd))},getSearch:function(){var t=this.query;return t?"?"+t:""},setSearch:function(t){(t=ms(t))==""?this.query=null:(Br(t,0)=="?"&&(t=sl(t,1)),this.query="",this.parse(t,qa)),this.searchParams.update()},getSearchParams:function(){return this.searchParams.facade},getHash:function(){var t=this.fragment;return t?"#"+t:""},setHash:function(t){(t=ms(t))!=""?(Br(t,0)=="#"&&(t=sl(t,1)),this.fragment="",this.parse(t,gs)):this.fragment=null},update:function(){this.query=this.searchParams.serialize()||null}};var _d=function(t){var e=jB(this,Wi),n=HB(arguments.length,1)>1?arguments[1]:void 0,i=KB(e,new Hg(t,!1,n));Ag||(e.href=i.serialize(),e.origin=i.getOrigin(),e.protocol=i.getProtocol(),e.username=i.getUsername(),e.password=i.getPassword(),e.host=i.getHost(),e.hostname=i.getHostname(),e.port=i.getPort(),e.pathname=i.getPathname(),e.search=i.getSearch(),e.searchParams=i.getSearchParams(),e.hash=i.getHash())},Wi=_d.prototype,Gr=function(t,e){return{get:function(){return Zp(this)[t]()},set:e&&function(n){return Zp(this)[e](n)},configurable:!0,enumerable:!0}};if(Ag&&(jr(Wi,"href",Gr("serialize","setHref")),jr(Wi,"origin",Gr("getOrigin")),jr(Wi,"protocol",Gr("getProtocol","setProtocol")),jr(Wi,"username",Gr("getUsername","setUsername")),jr(Wi,"password",Gr("getPassword","setPassword")),jr(Wi,"host",Gr("getHost","setHost")),jr(Wi,"hostname",Gr("getHostname","setHostname")),jr(Wi,"port",Gr("getPort","setPort")),jr(Wi,"pathname",Gr("getPathname","setPathname")),jr(Wi,"search",Gr("getSearch","setSearch")),jr(Wi,"searchParams",Gr("getSearchParams")),jr(Wi,"hash",Gr("getHash","setHash"))),Qp(Wi,"toJSON",function(){return Zp(this).serialize()},{enumerable:!0}),Qp(Wi,"toString",function(){return Zp(this).serialize()},{enumerable:!0}),rl){var bA=rl.createObjectURL,AA=rl.revokeObjectURL;bA&&Qp(_d,"createObjectURL",dA(bA,rl)),AA&&Qp(_d,"revokeObjectURL",dA(AA,rl))}WB(_d,"URL"),VB({global:!0,constructor:!0,forced:!FB,sham:!Ag},{URL:_d});var uG=$t,lG=Pt,hG=Yh,wA=x,pG=_m,OA=Ci("URL");uG({target:"URL",stat:!0,forced:!(pG&&lG(function(){OA.canParse()}))},{canParse:function(t){var e=hG(arguments.length,1),n=wA(t),i=e<2||arguments[1]===void 0?void 0:wA(arguments[1]);try{return!!new OA(n,i)}catch{return!1}}});var NA=Dt(Bn.URL),fG=Jn,_G=oI,DA=RegExp.prototype,EG=function(t){return t===DA||fG(DA,t)?_G(t):t.flags},ci=Dt(EG);function Ed(t){let e=t.length;for(;--e>=0;)t[e]=0}const Kg=256,PA=286,dl=30,ul=15,qg=new Uint8Array([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0]),sf=new Uint8Array([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13]),mG=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7]),LA=new Uint8Array([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),Ts=new Array(576);Ed(Ts);const ll=new Array(60);Ed(ll);const hl=new Array(512);Ed(hl);const pl=new Array(256);Ed(pl);const Yg=new Array(29);Ed(Yg);const af=new Array(dl);function zg(t,e,n,i,r){this.static_tree=t,this.extra_bits=e,this.extra_base=n,this.elems=i,this.max_length=r,this.has_stree=t&&t.length}let kA,MA,UA;function Jg(t,e){this.dyn_tree=t,this.max_code=0,this.stat_desc=e}Ed(af);const xA=t=>t<256?hl[t]:hl[256+(t>>>7)],fl=(t,e)=>{t.pending_buf[t.pending++]=255&e,t.pending_buf[t.pending++]=e>>>8&255},$i=(t,e,n)=>{t.bi_valid>16-n?(t.bi_buf|=e<<t.bi_valid&65535,fl(t,t.bi_buf),t.bi_buf=e>>16-t.bi_valid,t.bi_valid+=n-16):(t.bi_buf|=e<<t.bi_valid&65535,t.bi_valid+=n)},jo=(t,e,n)=>{$i(t,n[2*e],n[2*e+1])},VA=(t,e)=>{let n=0;do n|=1&t,t>>>=1,n<<=1;while(--e>0);return n>>>1},FA=(t,e,n)=>{const i=new Array(16);let r,o,s=0;for(r=1;r<=ul;r++)s=s+n[r-1]<<1,i[r]=s;for(o=0;o<=e;o++){let a=t[2*o+1];a!==0&&(t[2*o]=VA(i[a]++,a))}},jA=t=>{let e;for(e=0;e<PA;e++)t.dyn_ltree[2*e]=0;for(e=0;e<dl;e++)t.dyn_dtree[2*e]=0;for(e=0;e<19;e++)t.bl_tree[2*e]=0;t.dyn_ltree[512]=1,t.opt_len=t.static_len=0,t.sym_next=t.matches=0},BA=t=>{t.bi_valid>8?fl(t,t.bi_buf):t.bi_valid>0&&(t.pending_buf[t.pending++]=t.bi_buf),t.bi_buf=0,t.bi_valid=0},GA=(t,e,n,i)=>{const r=2*e,o=2*n;return t[r]<t[o]||t[r]===t[o]&&i[e]<=i[n]},Xg=(t,e,n)=>{const i=t.heap[n];let r=n<<1;for(;r<=t.heap_len&&(r<t.heap_len&&GA(e,t.heap[r+1],t.heap[r],t.depth)&&r++,!GA(e,i,t.heap[r],t.depth));)t.heap[n]=t.heap[r],n=r,r<<=1;t.heap[n]=i},WA=(t,e,n)=>{let i,r,o,s,a=0;if(t.sym_next!==0)do i=255&t.pending_buf[t.sym_buf+a++],i+=(255&t.pending_buf[t.sym_buf+a++])<<8,r=t.pending_buf[t.sym_buf+a++],i===0?jo(t,r,e):(o=pl[r],jo(t,o+Kg+1,e),s=qg[o],s!==0&&(r-=Yg[o],$i(t,r,s)),i--,o=xA(i),jo(t,o,n),s=sf[o],s!==0&&(i-=af[o],$i(t,i,s)));while(a<t.sym_next);jo(t,256,e)},Qg=(t,e)=>{const n=e.dyn_tree,i=e.stat_desc.static_tree,r=e.stat_desc.has_stree,o=e.stat_desc.elems;let s,a,c,d=-1;for(t.heap_len=0,t.heap_max=573,s=0;s<o;s++)n[2*s]!==0?(t.heap[++t.heap_len]=d=s,t.depth[s]=0):n[2*s+1]=0;for(;t.heap_len<2;)c=t.heap[++t.heap_len]=d<2?++d:0,n[2*c]=1,t.depth[c]=0,t.opt_len--,r&&(t.static_len-=i[2*c+1]);for(e.max_code=d,s=t.heap_len>>1;s>=1;s--)Xg(t,n,s);c=o;do s=t.heap[1],t.heap[1]=t.heap[t.heap_len--],Xg(t,n,1),a=t.heap[1],t.heap[--t.heap_max]=s,t.heap[--t.heap_max]=a,n[2*c]=n[2*s]+n[2*a],t.depth[c]=(t.depth[s]>=t.depth[a]?t.depth[s]:t.depth[a])+1,n[2*s+1]=n[2*a+1]=c,t.heap[1]=c++,Xg(t,n,1);while(t.heap_len>=2);t.heap[--t.heap_max]=t.heap[1],((u,l)=>{const p=l.dyn_tree,f=l.max_code,C=l.stat_desc.static_tree,m=l.stat_desc.has_stree,g=l.stat_desc.extra_bits,y=l.stat_desc.extra_base,A=l.stat_desc.max_length;let k,M,V,B,K,Y,J=0;for(B=0;B<=ul;B++)u.bl_count[B]=0;for(p[2*u.heap[u.heap_max]+1]=0,k=u.heap_max+1;k<573;k++)M=u.heap[k],B=p[2*p[2*M+1]+1]+1,B>A&&(B=A,J++),p[2*M+1]=B,M>f||(u.bl_count[B]++,K=0,M>=y&&(K=g[M-y]),Y=p[2*M],u.opt_len+=Y*(B+K),m&&(u.static_len+=Y*(C[2*M+1]+K)));if(J!==0){do{for(B=A-1;u.bl_count[B]===0;)B--;u.bl_count[B]--,u.bl_count[B+1]+=2,u.bl_count[A]--,J-=2}while(J>0);for(B=A;B!==0;B--)for(M=u.bl_count[B];M!==0;)V=u.heap[--k],V>f||(p[2*V+1]!==B&&(u.opt_len+=(B-p[2*V+1])*p[2*V],p[2*V+1]=B),M--)}})(t,e),FA(n,d,t.bl_count)},HA=(t,e,n)=>{let i,r,o=-1,s=e[1],a=0,c=7,d=4;for(s===0&&(c=138,d=3),e[2*(n+1)+1]=65535,i=0;i<=n;i++)r=s,s=e[2*(i+1)+1],++a<c&&r===s||(a<d?t.bl_tree[2*r]+=a:r!==0?(r!==o&&t.bl_tree[2*r]++,t.bl_tree[32]++):a<=10?t.bl_tree[34]++:t.bl_tree[36]++,a=0,o=r,s===0?(c=138,d=3):r===s?(c=6,d=3):(c=7,d=4))},KA=(t,e,n)=>{let i,r,o=-1,s=e[1],a=0,c=7,d=4;for(s===0&&(c=138,d=3),i=0;i<=n;i++)if(r=s,s=e[2*(i+1)+1],!(++a<c&&r===s)){if(a<d)do jo(t,r,t.bl_tree);while(--a!=0);else r!==0?(r!==o&&(jo(t,r,t.bl_tree),a--),jo(t,16,t.bl_tree),$i(t,a-3,2)):a<=10?(jo(t,17,t.bl_tree),$i(t,a-3,3)):(jo(t,18,t.bl_tree),$i(t,a-11,7));a=0,o=r,s===0?(c=138,d=3):r===s?(c=6,d=3):(c=7,d=4)}};let qA=!1;const YA=(t,e,n,i)=>{$i(t,0+(i?1:0),3),BA(t),fl(t,n),fl(t,~n),n&&t.pending_buf.set(t.window.subarray(e,e+n),t.pending),t.pending+=n};var gG=t=>{qA||((()=>{let e,n,i,r,o;const s=new Array(16);for(i=0,r=0;r<28;r++)for(Yg[r]=i,e=0;e<1<<qg[r];e++)pl[i++]=r;for(pl[i-1]=r,o=0,r=0;r<16;r++)for(af[r]=o,e=0;e<1<<sf[r];e++)hl[o++]=r;for(o>>=7;r<dl;r++)for(af[r]=o<<7,e=0;e<1<<sf[r]-7;e++)hl[256+o++]=r;for(n=0;n<=ul;n++)s[n]=0;for(e=0;e<=143;)Ts[2*e+1]=8,e++,s[8]++;for(;e<=255;)Ts[2*e+1]=9,e++,s[9]++;for(;e<=279;)Ts[2*e+1]=7,e++,s[7]++;for(;e<=287;)Ts[2*e+1]=8,e++,s[8]++;for(FA(Ts,287,s),e=0;e<dl;e++)ll[2*e+1]=5,ll[2*e]=VA(e,5);kA=new zg(Ts,qg,257,PA,ul),MA=new zg(ll,sf,0,dl,ul),UA=new zg(new Array(0),mG,0,19,7)})(),qA=!0),t.l_desc=new Jg(t.dyn_ltree,kA),t.d_desc=new Jg(t.dyn_dtree,MA),t.bl_desc=new Jg(t.bl_tree,UA),t.bi_buf=0,t.bi_valid=0,jA(t)},TG=(t,e,n,i)=>{let r,o,s=0;t.level>0?(t.strm.data_type===2&&(t.strm.data_type=(a=>{let c,d=4093624447;for(c=0;c<=31;c++,d>>>=1)if(1&d&&a.dyn_ltree[2*c]!==0)return 0;if(a.dyn_ltree[18]!==0||a.dyn_ltree[20]!==0||a.dyn_ltree[26]!==0)return 1;for(c=32;c<Kg;c++)if(a.dyn_ltree[2*c]!==0)return 1;return 0})(t)),Qg(t,t.l_desc),Qg(t,t.d_desc),s=(a=>{let c;for(HA(a,a.dyn_ltree,a.l_desc.max_code),HA(a,a.dyn_dtree,a.d_desc.max_code),Qg(a,a.bl_desc),c=18;c>=3&&a.bl_tree[2*LA[c]+1]===0;c--);return a.opt_len+=3*(c+1)+5+5+4,c})(t),r=t.opt_len+3+7>>>3,o=t.static_len+3+7>>>3,o<=r&&(r=o)):r=o=n+5,n+4<=r&&e!==-1?YA(t,e,n,i):t.strategy===4||o===r?($i(t,2+(i?1:0),3),WA(t,Ts,ll)):($i(t,4+(i?1:0),3),((a,c,d,u)=>{let l;for($i(a,c-257,5),$i(a,d-1,5),$i(a,u-4,4),l=0;l<u;l++)$i(a,a.bl_tree[2*LA[l]+1],3);KA(a,a.dyn_ltree,c-1),KA(a,a.dyn_dtree,d-1)})(t,t.l_desc.max_code+1,t.d_desc.max_code+1,s+1),WA(t,t.dyn_ltree,t.dyn_dtree)),jA(t),i&&BA(t)},SG=(t,e,n)=>(t.pending_buf[t.sym_buf+t.sym_next++]=e,t.pending_buf[t.sym_buf+t.sym_next++]=e>>8,t.pending_buf[t.sym_buf+t.sym_next++]=n,e===0?t.dyn_ltree[2*n]++:(t.matches++,e--,t.dyn_ltree[2*(pl[n]+Kg+1)]++,t.dyn_dtree[2*xA(e)]++),t.sym_next===t.sym_end),RG=t=>{$i(t,2,3),jo(t,256,Ts),(e=>{e.bi_valid===16?(fl(e,e.bi_buf),e.bi_buf=0,e.bi_valid=0):e.bi_valid>=8&&(e.pending_buf[e.pending++]=255&e.bi_buf,e.bi_buf>>=8,e.bi_valid-=8)})(t)},CG={_tr_init:gG,_tr_stored_block:YA,_tr_flush_block:TG,_tr_tally:SG,_tr_align:RG},_l=(t,e,n,i)=>{let r=65535&t|0,o=t>>>16&65535|0,s=0;for(;n!==0;){s=n>2e3?2e3:n,n-=s;do r=r+e[i++]|0,o=o+r|0;while(--s);r%=65521,o%=65521}return r|o<<16|0};const vG=new Uint32Array((()=>{let t,e=[];for(var n=0;n<256;n++){t=n;for(var i=0;i<8;i++)t=1&t?3988292384^t>>>1:t>>>1;e[n]=t}return e})());var Ti=(t,e,n,i)=>{const r=vG,o=i+n;t^=-1;for(let s=i;s<o;s++)t=t>>>8^r[255&(t^e[s])];return-1^t},Ya={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"},md={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_MEM_ERROR:-4,Z_BUF_ERROR:-5,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_BINARY:0,Z_TEXT:1,Z_UNKNOWN:2,Z_DEFLATED:8};const{_tr_init:yG,_tr_stored_block:Zg,_tr_flush_block:IG,_tr_tally:ta,_tr_align:bG}=CG,{Z_NO_FLUSH:ea,Z_PARTIAL_FLUSH:AG,Z_FULL_FLUSH:wG,Z_FINISH:Wr,Z_BLOCK:zA,Z_OK:Ii,Z_STREAM_END:JA,Z_STREAM_ERROR:Bo,Z_DATA_ERROR:OG,Z_BUF_ERROR:$g,Z_DEFAULT_COMPRESSION:NG,Z_FILTERED:DG,Z_HUFFMAN_ONLY:cf,Z_RLE:PG,Z_FIXED:LG,Z_DEFAULT_STRATEGY:kG,Z_UNKNOWN:MG,Z_DEFLATED:df}=md,tT=286,UG=30,xG=19,VG=2*tT+1,FG=15,za=258,Go=262,gd=42,Ja=113,El=666,Xa=(t,e)=>(t.msg=Ya[e],e),XA=t=>2*t-(t>4?9:0),na=t=>{let e=t.length;for(;--e>=0;)t[e]=0},jG=t=>{let e,n,i,r=t.w_size;e=t.hash_size,i=e;do n=t.head[--i],t.head[i]=n>=r?n-r:0;while(--e);e=r,i=e;do n=t.prev[--i],t.prev[i]=n>=r?n-r:0;while(--e)};let ia=(t,e,n)=>(e<<t.hash_shift^n)&t.hash_mask;const Er=t=>{const e=t.state;let n=e.pending;n>t.avail_out&&(n=t.avail_out),n!==0&&(t.output.set(e.pending_buf.subarray(e.pending_out,e.pending_out+n),t.next_out),t.next_out+=n,e.pending_out+=n,t.total_out+=n,t.avail_out-=n,e.pending-=n,e.pending===0&&(e.pending_out=0))},mr=(t,e)=>{IG(t,t.block_start>=0?t.block_start:-1,t.strstart-t.block_start,e),t.block_start=t.strstart,Er(t.strm)},$e=(t,e)=>{t.pending_buf[t.pending++]=e},ml=(t,e)=>{t.pending_buf[t.pending++]=e>>>8&255,t.pending_buf[t.pending++]=255&e},eT=(t,e,n,i)=>{let r=t.avail_in;return r>i&&(r=i),r===0?0:(t.avail_in-=r,e.set(t.input.subarray(t.next_in,t.next_in+r),n),t.state.wrap===1?t.adler=_l(t.adler,e,r,n):t.state.wrap===2&&(t.adler=Ti(t.adler,e,r,n)),t.next_in+=r,t.total_in+=r,r)},QA=(t,e)=>{let n,i,r=t.max_chain_length,o=t.strstart,s=t.prev_length,a=t.nice_match;const c=t.strstart>t.w_size-Go?t.strstart-(t.w_size-Go):0,d=t.window,u=t.w_mask,l=t.prev,p=t.strstart+za;let f=d[o+s-1],C=d[o+s];t.prev_length>=t.good_match&&(r>>=2),a>t.lookahead&&(a=t.lookahead);do if(n=e,d[n+s]===C&&d[n+s-1]===f&&d[n]===d[o]&&d[++n]===d[o+1]){o+=2,n++;do;while(d[++o]===d[++n]&&d[++o]===d[++n]&&d[++o]===d[++n]&&d[++o]===d[++n]&&d[++o]===d[++n]&&d[++o]===d[++n]&&d[++o]===d[++n]&&d[++o]===d[++n]&&o<p);if(i=za-(p-o),o=p-za,i>s){if(t.match_start=e,s=i,i>=a)break;f=d[o+s-1],C=d[o+s]}}while((e=l[e&u])>c&&--r!=0);return s<=t.lookahead?s:t.lookahead},Td=t=>{const e=t.w_size;let n,i,r;do{if(i=t.window_size-t.lookahead-t.strstart,t.strstart>=e+(e-Go)&&(t.window.set(t.window.subarray(e,e+e-i),0),t.match_start-=e,t.strstart-=e,t.block_start-=e,t.insert>t.strstart&&(t.insert=t.strstart),jG(t),i+=e),t.strm.avail_in===0)break;if(n=eT(t.strm,t.window,t.strstart+t.lookahead,i),t.lookahead+=n,t.lookahead+t.insert>=3)for(r=t.strstart-t.insert,t.ins_h=t.window[r],t.ins_h=ia(t,t.ins_h,t.window[r+1]);t.insert&&(t.ins_h=ia(t,t.ins_h,t.window[r+3-1]),t.prev[r&t.w_mask]=t.head[t.ins_h],t.head[t.ins_h]=r,r++,t.insert--,!(t.lookahead+t.insert<3)););}while(t.lookahead<Go&&t.strm.avail_in!==0)},ZA=(t,e)=>{let n,i,r,o=t.pending_buf_size-5>t.w_size?t.w_size:t.pending_buf_size-5,s=0,a=t.strm.avail_in;do{if(n=65535,r=t.bi_valid+42>>3,t.strm.avail_out<r||(r=t.strm.avail_out-r,i=t.strstart-t.block_start,n>i+t.strm.avail_in&&(n=i+t.strm.avail_in),n>r&&(n=r),n<o&&(n===0&&e!==Wr||e===ea||n!==i+t.strm.avail_in)))break;s=e===Wr&&n===i+t.strm.avail_in?1:0,Zg(t,0,0,s),t.pending_buf[t.pending-4]=n,t.pending_buf[t.pending-3]=n>>8,t.pending_buf[t.pending-2]=~n,t.pending_buf[t.pending-1]=~n>>8,Er(t.strm),i&&(i>n&&(i=n),t.strm.output.set(t.window.subarray(t.block_start,t.block_start+i),t.strm.next_out),t.strm.next_out+=i,t.strm.avail_out-=i,t.strm.total_out+=i,t.block_start+=i,n-=i),n&&(eT(t.strm,t.strm.output,t.strm.next_out,n),t.strm.next_out+=n,t.strm.avail_out-=n,t.strm.total_out+=n)}while(s===0);return a-=t.strm.avail_in,a&&(a>=t.w_size?(t.matches=2,t.window.set(t.strm.input.subarray(t.strm.next_in-t.w_size,t.strm.next_in),0),t.strstart=t.w_size,t.insert=t.strstart):(t.window_size-t.strstart<=a&&(t.strstart-=t.w_size,t.window.set(t.window.subarray(t.w_size,t.w_size+t.strstart),0),t.matches<2&&t.matches++,t.insert>t.strstart&&(t.insert=t.strstart)),t.window.set(t.strm.input.subarray(t.strm.next_in-a,t.strm.next_in),t.strstart),t.strstart+=a,t.insert+=a>t.w_size-t.insert?t.w_size-t.insert:a),t.block_start=t.strstart),t.high_water<t.strstart&&(t.high_water=t.strstart),s?4:e!==ea&&e!==Wr&&t.strm.avail_in===0&&t.strstart===t.block_start?2:(r=t.window_size-t.strstart,t.strm.avail_in>r&&t.block_start>=t.w_size&&(t.block_start-=t.w_size,t.strstart-=t.w_size,t.window.set(t.window.subarray(t.w_size,t.w_size+t.strstart),0),t.matches<2&&t.matches++,r+=t.w_size,t.insert>t.strstart&&(t.insert=t.strstart)),r>t.strm.avail_in&&(r=t.strm.avail_in),r&&(eT(t.strm,t.window,t.strstart,r),t.strstart+=r,t.insert+=r>t.w_size-t.insert?t.w_size-t.insert:r),t.high_water<t.strstart&&(t.high_water=t.strstart),r=t.bi_valid+42>>3,r=t.pending_buf_size-r>65535?65535:t.pending_buf_size-r,o=r>t.w_size?t.w_size:r,i=t.strstart-t.block_start,(i>=o||(i||e===Wr)&&e!==ea&&t.strm.avail_in===0&&i<=r)&&(n=i>r?r:i,s=e===Wr&&t.strm.avail_in===0&&n===i?1:0,Zg(t,t.block_start,n,s),t.block_start+=n,Er(t.strm)),s?3:1)},nT=(t,e)=>{let n,i;for(;;){if(t.lookahead<Go){if(Td(t),t.lookahead<Go&&e===ea)return 1;if(t.lookahead===0)break}if(n=0,t.lookahead>=3&&(t.ins_h=ia(t,t.ins_h,t.window[t.strstart+3-1]),n=t.prev[t.strstart&t.w_mask]=t.head[t.ins_h],t.head[t.ins_h]=t.strstart),n!==0&&t.strstart-n<=t.w_size-Go&&(t.match_length=QA(t,n)),t.match_length>=3)if(i=ta(t,t.strstart-t.match_start,t.match_length-3),t.lookahead-=t.match_length,t.match_length<=t.max_lazy_match&&t.lookahead>=3){t.match_length--;do t.strstart++,t.ins_h=ia(t,t.ins_h,t.window[t.strstart+3-1]),n=t.prev[t.strstart&t.w_mask]=t.head[t.ins_h],t.head[t.ins_h]=t.strstart;while(--t.match_length!=0);t.strstart++}else t.strstart+=t.match_length,t.match_length=0,t.ins_h=t.window[t.strstart],t.ins_h=ia(t,t.ins_h,t.window[t.strstart+1]);else i=ta(t,0,t.window[t.strstart]),t.lookahead--,t.strstart++;if(i&&(mr(t,!1),t.strm.avail_out===0))return 1}return t.insert=t.strstart<2?t.strstart:2,e===Wr?(mr(t,!0),t.strm.avail_out===0?3:4):t.sym_next&&(mr(t,!1),t.strm.avail_out===0)?1:2},Sd=(t,e)=>{let n,i,r;for(;;){if(t.lookahead<Go){if(Td(t),t.lookahead<Go&&e===ea)return 1;if(t.lookahead===0)break}if(n=0,t.lookahead>=3&&(t.ins_h=ia(t,t.ins_h,t.window[t.strstart+3-1]),n=t.prev[t.strstart&t.w_mask]=t.head[t.ins_h],t.head[t.ins_h]=t.strstart),t.prev_length=t.match_length,t.prev_match=t.match_start,t.match_length=2,n!==0&&t.prev_length<t.max_lazy_match&&t.strstart-n<=t.w_size-Go&&(t.match_length=QA(t,n),t.match_length<=5&&(t.strategy===DG||t.match_length===3&&t.strstart-t.match_start>4096)&&(t.match_length=2)),t.prev_length>=3&&t.match_length<=t.prev_length){r=t.strstart+t.lookahead-3,i=ta(t,t.strstart-1-t.prev_match,t.prev_length-3),t.lookahead-=t.prev_length-1,t.prev_length-=2;do++t.strstart<=r&&(t.ins_h=ia(t,t.ins_h,t.window[t.strstart+3-1]),n=t.prev[t.strstart&t.w_mask]=t.head[t.ins_h],t.head[t.ins_h]=t.strstart);while(--t.prev_length!=0);if(t.match_available=0,t.match_length=2,t.strstart++,i&&(mr(t,!1),t.strm.avail_out===0))return 1}else if(t.match_available){if(i=ta(t,0,t.window[t.strstart-1]),i&&mr(t,!1),t.strstart++,t.lookahead--,t.strm.avail_out===0)return 1}else t.match_available=1,t.strstart++,t.lookahead--}return t.match_available&&(i=ta(t,0,t.window[t.strstart-1]),t.match_available=0),t.insert=t.strstart<2?t.strstart:2,e===Wr?(mr(t,!0),t.strm.avail_out===0?3:4):t.sym_next&&(mr(t,!1),t.strm.avail_out===0)?1:2};function Wo(t,e,n,i,r){this.good_length=t,this.max_lazy=e,this.nice_length=n,this.max_chain=i,this.func=r}const gl=[new Wo(0,0,0,0,ZA),new Wo(4,4,8,4,nT),new Wo(4,5,16,8,nT),new Wo(4,6,32,32,nT),new Wo(4,4,16,16,Sd),new Wo(8,16,32,32,Sd),new Wo(8,16,128,128,Sd),new Wo(8,32,128,256,Sd),new Wo(32,128,258,1024,Sd),new Wo(32,258,258,4096,Sd)];function BG(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=df,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new Uint16Array(2*VG),this.dyn_dtree=new Uint16Array(2*(2*UG+1)),this.bl_tree=new Uint16Array(2*(2*xG+1)),na(this.dyn_ltree),na(this.dyn_dtree),na(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new Uint16Array(FG+1),this.heap=new Uint16Array(2*tT+1),na(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new Uint16Array(2*tT+1),na(this.depth),this.sym_buf=0,this.lit_bufsize=0,this.sym_next=0,this.sym_end=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}const Tl=t=>{if(!t)return 1;const e=t.state;return!e||e.strm!==t||e.status!==gd&&e.status!==57&&e.status!==69&&e.status!==73&&e.status!==91&&e.status!==103&&e.status!==Ja&&e.status!==El?1:0},$A=t=>{if(Tl(t))return Xa(t,Bo);t.total_in=t.total_out=0,t.data_type=MG;const e=t.state;return e.pending=0,e.pending_out=0,e.wrap<0&&(e.wrap=-e.wrap),e.status=e.wrap===2?57:e.wrap?gd:Ja,t.adler=e.wrap===2?0:1,e.last_flush=-2,yG(e),Ii},tw=t=>{const e=$A(t);return e===Ii&&(n=>{n.window_size=2*n.w_size,na(n.head),n.max_lazy_match=gl[n.level].max_lazy,n.good_match=gl[n.level].good_length,n.nice_match=gl[n.level].nice_length,n.max_chain_length=gl[n.level].max_chain,n.strstart=0,n.block_start=0,n.lookahead=0,n.insert=0,n.match_length=n.prev_length=2,n.match_available=0,n.ins_h=0})(t.state),e},ew=(t,e,n,i,r,o)=>{if(!t)return Bo;let s=1;if(e===NG&&(e=6),i<0?(s=0,i=-i):i>15&&(s=2,i-=16),r<1||r>9||n!==df||i<8||i>15||e<0||e>9||o<0||o>LG||i===8&&s!==1)return Xa(t,Bo);i===8&&(i=9);const a=new BG;return t.state=a,a.strm=t,a.status=gd,a.wrap=s,a.gzhead=null,a.w_bits=i,a.w_size=1<<a.w_bits,a.w_mask=a.w_size-1,a.hash_bits=r+7,a.hash_size=1<<a.hash_bits,a.hash_mask=a.hash_size-1,a.hash_shift=~~((a.hash_bits+3-1)/3),a.window=new Uint8Array(2*a.w_size),a.head=new Uint16Array(a.hash_size),a.prev=new Uint16Array(a.w_size),a.lit_bufsize=1<<r+6,a.pending_buf_size=4*a.lit_bufsize,a.pending_buf=new Uint8Array(a.pending_buf_size),a.sym_buf=a.lit_bufsize,a.sym_end=3*(a.lit_bufsize-1),a.level=e,a.strategy=o,a.method=n,tw(t)};var GG=(t,e)=>{if(Tl(t)||e>zA||e<0)return t?Xa(t,Bo):Bo;const n=t.state;if(!t.output||t.avail_in!==0&&!t.input||n.status===El&&e!==Wr)return Xa(t,t.avail_out===0?$g:Bo);const i=n.last_flush;if(n.last_flush=e,n.pending!==0){if(Er(t),t.avail_out===0)return n.last_flush=-1,Ii}else if(t.avail_in===0&&XA(e)<=XA(i)&&e!==Wr)return Xa(t,$g);if(n.status===El&&t.avail_in!==0)return Xa(t,$g);if(n.status===gd&&n.wrap===0&&(n.status=Ja),n.status===gd){let r=df+(n.w_bits-8<<4)<<8,o=-1;if(o=n.strategy>=cf||n.level<2?0:n.level<6?1:n.level===6?2:3,r|=o<<6,n.strstart!==0&&(r|=32),r+=31-r%31,ml(n,r),n.strstart!==0&&(ml(n,t.adler>>>16),ml(n,65535&t.adler)),t.adler=1,n.status=Ja,Er(t),n.pending!==0)return n.last_flush=-1,Ii}if(n.status===57){if(t.adler=0,$e(n,31),$e(n,139),$e(n,8),n.gzhead)$e(n,(n.gzhead.text?1:0)+(n.gzhead.hcrc?2:0)+(n.gzhead.extra?4:0)+(n.gzhead.name?8:0)+(n.gzhead.comment?16:0)),$e(n,255&n.gzhead.time),$e(n,n.gzhead.time>>8&255),$e(n,n.gzhead.time>>16&255),$e(n,n.gzhead.time>>24&255),$e(n,n.level===9?2:n.strategy>=cf||n.level<2?4:0),$e(n,255&n.gzhead.os),n.gzhead.extra&&n.gzhead.extra.length&&($e(n,255&n.gzhead.extra.length),$e(n,n.gzhead.extra.length>>8&255)),n.gzhead.hcrc&&(t.adler=Ti(t.adler,n.pending_buf,n.pending,0)),n.gzindex=0,n.status=69;else if($e(n,0),$e(n,0),$e(n,0),$e(n,0),$e(n,0),$e(n,n.level===9?2:n.strategy>=cf||n.level<2?4:0),$e(n,3),n.status=Ja,Er(t),n.pending!==0)return n.last_flush=-1,Ii}if(n.status===69){if(n.gzhead.extra){let r=n.pending,o=(65535&n.gzhead.extra.length)-n.gzindex;for(;n.pending+o>n.pending_buf_size;){let a=n.pending_buf_size-n.pending;if(n.pending_buf.set(n.gzhead.extra.subarray(n.gzindex,n.gzindex+a),n.pending),n.pending=n.pending_buf_size,n.gzhead.hcrc&&n.pending>r&&(t.adler=Ti(t.adler,n.pending_buf,n.pending-r,r)),n.gzindex+=a,Er(t),n.pending!==0)return n.last_flush=-1,Ii;r=0,o-=a}let s=new Uint8Array(n.gzhead.extra);n.pending_buf.set(s.subarray(n.gzindex,n.gzindex+o),n.pending),n.pending+=o,n.gzhead.hcrc&&n.pending>r&&(t.adler=Ti(t.adler,n.pending_buf,n.pending-r,r)),n.gzindex=0}n.status=73}if(n.status===73){if(n.gzhead.name){let r,o=n.pending;do{if(n.pending===n.pending_buf_size){if(n.gzhead.hcrc&&n.pending>o&&(t.adler=Ti(t.adler,n.pending_buf,n.pending-o,o)),Er(t),n.pending!==0)return n.last_flush=-1,Ii;o=0}r=n.gzindex<n.gzhead.name.length?255&n.gzhead.name.charCodeAt(n.gzindex++):0,$e(n,r)}while(r!==0);n.gzhead.hcrc&&n.pending>o&&(t.adler=Ti(t.adler,n.pending_buf,n.pending-o,o)),n.gzindex=0}n.status=91}if(n.status===91){if(n.gzhead.comment){let r,o=n.pending;do{if(n.pending===n.pending_buf_size){if(n.gzhead.hcrc&&n.pending>o&&(t.adler=Ti(t.adler,n.pending_buf,n.pending-o,o)),Er(t),n.pending!==0)return n.last_flush=-1,Ii;o=0}r=n.gzindex<n.gzhead.comment.length?255&n.gzhead.comment.charCodeAt(n.gzindex++):0,$e(n,r)}while(r!==0);n.gzhead.hcrc&&n.pending>o&&(t.adler=Ti(t.adler,n.pending_buf,n.pending-o,o))}n.status=103}if(n.status===103){if(n.gzhead.hcrc){if(n.pending+2>n.pending_buf_size&&(Er(t),n.pending!==0))return n.last_flush=-1,Ii;$e(n,255&t.adler),$e(n,t.adler>>8&255),t.adler=0}if(n.status=Ja,Er(t),n.pending!==0)return n.last_flush=-1,Ii}if(t.avail_in!==0||n.lookahead!==0||e!==ea&&n.status!==El){let r=n.level===0?ZA(n,e):n.strategy===cf?((o,s)=>{let a;for(;;){if(o.lookahead===0&&(Td(o),o.lookahead===0)){if(s===ea)return 1;break}if(o.match_length=0,a=ta(o,0,o.window[o.strstart]),o.lookahead--,o.strstart++,a&&(mr(o,!1),o.strm.avail_out===0))return 1}return o.insert=0,s===Wr?(mr(o,!0),o.strm.avail_out===0?3:4):o.sym_next&&(mr(o,!1),o.strm.avail_out===0)?1:2})(n,e):n.strategy===PG?((o,s)=>{let a,c,d,u;const l=o.window;for(;;){if(o.lookahead<=za){if(Td(o),o.lookahead<=za&&s===ea)return 1;if(o.lookahead===0)break}if(o.match_length=0,o.lookahead>=3&&o.strstart>0&&(d=o.strstart-1,c=l[d],c===l[++d]&&c===l[++d]&&c===l[++d])){u=o.strstart+za;do;while(c===l[++d]&&c===l[++d]&&c===l[++d]&&c===l[++d]&&c===l[++d]&&c===l[++d]&&c===l[++d]&&c===l[++d]&&d<u);o.match_length=za-(u-d),o.match_length>o.lookahead&&(o.match_length=o.lookahead)}if(o.match_length>=3?(a=ta(o,1,o.match_length-3),o.lookahead-=o.match_length,o.strstart+=o.match_length,o.match_length=0):(a=ta(o,0,o.window[o.strstart]),o.lookahead--,o.strstart++),a&&(mr(o,!1),o.strm.avail_out===0))return 1}return o.insert=0,s===Wr?(mr(o,!0),o.strm.avail_out===0?3:4):o.sym_next&&(mr(o,!1),o.strm.avail_out===0)?1:2})(n,e):gl[n.level].func(n,e);if(r!==3&&r!==4||(n.status=El),r===1||r===3)return t.avail_out===0&&(n.last_flush=-1),Ii;if(r===2&&(e===AG?bG(n):e!==zA&&(Zg(n,0,0,!1),e===wG&&(na(n.head),n.lookahead===0&&(n.strstart=0,n.block_start=0,n.insert=0))),Er(t),t.avail_out===0))return n.last_flush=-1,Ii}return e!==Wr?Ii:n.wrap<=0?JA:(n.wrap===2?($e(n,255&t.adler),$e(n,t.adler>>8&255),$e(n,t.adler>>16&255),$e(n,t.adler>>24&255),$e(n,255&t.total_in),$e(n,t.total_in>>8&255),$e(n,t.total_in>>16&255),$e(n,t.total_in>>24&255)):(ml(n,t.adler>>>16),ml(n,65535&t.adler)),Er(t),n.wrap>0&&(n.wrap=-n.wrap),n.pending!==0?Ii:JA)},WG=(t,e)=>{let n=e.length;if(Tl(t))return Bo;const i=t.state,r=i.wrap;if(r===2||r===1&&i.status!==gd||i.lookahead)return Bo;if(r===1&&(t.adler=_l(t.adler,e,n,0)),i.wrap=0,n>=i.w_size){r===0&&(na(i.head),i.strstart=0,i.block_start=0,i.insert=0);let c=new Uint8Array(i.w_size);c.set(e.subarray(n-i.w_size,n),0),e=c,n=i.w_size}const o=t.avail_in,s=t.next_in,a=t.input;for(t.avail_in=n,t.next_in=0,t.input=e,Td(i);i.lookahead>=3;){let c=i.strstart,d=i.lookahead-2;do i.ins_h=ia(i,i.ins_h,i.window[c+3-1]),i.prev[c&i.w_mask]=i.head[i.ins_h],i.head[i.ins_h]=c,c++;while(--d);i.strstart=c,i.lookahead=2,Td(i)}return i.strstart+=i.lookahead,i.block_start=i.strstart,i.insert=i.lookahead,i.lookahead=0,i.match_length=i.prev_length=2,i.match_available=0,t.next_in=s,t.input=a,t.avail_in=o,i.wrap=r,Ii},Sl={deflateInit:(t,e)=>ew(t,e,df,15,8,kG),deflateInit2:ew,deflateReset:tw,deflateResetKeep:$A,deflateSetHeader:(t,e)=>Tl(t)||t.state.wrap!==2?Bo:(t.state.gzhead=e,Ii),deflate:GG,deflateEnd:t=>{if(Tl(t))return Bo;const e=t.state.status;return t.state=null,e===Ja?Xa(t,OG):Ii},deflateSetDictionary:WG,deflateInfo:"pako deflate (from Nodeca project)"};const HG=(t,e)=>Object.prototype.hasOwnProperty.call(t,e);var uf={assign:function(t){const e=Array.prototype.slice.call(arguments,1);for(;e.length;){const n=e.shift();if(n){if(typeof n!="object")throw new TypeError(n+"must be non-object");for(const i in n)HG(n,i)&&(t[i]=n[i])}}return t},flattenChunks:t=>{let e=0;for(let i=0,r=t.length;i<r;i++)e+=t[i].length;const n=new Uint8Array(e);for(let i=0,r=0,o=t.length;i<o;i++){let s=t[i];n.set(s,r),r+=s.length}return n}};let nw=!0;try{String.fromCharCode.apply(null,new Uint8Array(1))}catch{nw=!1}const Rl=new Uint8Array(256);for(let t=0;t<256;t++)Rl[t]=t>=252?6:t>=248?5:t>=240?4:t>=224?3:t>=192?2:1;Rl[254]=Rl[254]=1;var Cl={string2buf:t=>{if(typeof TextEncoder=="function"&&TextEncoder.prototype.encode)return new TextEncoder().encode(t);let e,n,i,r,o,s=t.length,a=0;for(r=0;r<s;r++)n=t.charCodeAt(r),(64512&n)==55296&&r+1<s&&(i=t.charCodeAt(r+1),(64512&i)==56320&&(n=65536+(n-55296<<10)+(i-56320),r++)),a+=n<128?1:n<2048?2:n<65536?3:4;for(e=new Uint8Array(a),o=0,r=0;o<a;r++)n=t.charCodeAt(r),(64512&n)==55296&&r+1<s&&(i=t.charCodeAt(r+1),(64512&i)==56320&&(n=65536+(n-55296<<10)+(i-56320),r++)),n<128?e[o++]=n:n<2048?(e[o++]=192|n>>>6,e[o++]=128|63&n):n<65536?(e[o++]=224|n>>>12,e[o++]=128|n>>>6&63,e[o++]=128|63&n):(e[o++]=240|n>>>18,e[o++]=128|n>>>12&63,e[o++]=128|n>>>6&63,e[o++]=128|63&n);return e},buf2string:(t,e)=>{const n=e||t.length;if(typeof TextDecoder=="function"&&TextDecoder.prototype.decode)return new TextDecoder().decode(t.subarray(0,e));let i,r;const o=new Array(2*n);for(r=0,i=0;i<n;){let s=t[i++];if(s<128){o[r++]=s;continue}let a=Rl[s];if(a>4)o[r++]=65533,i+=a-1;else{for(s&=a===2?31:a===3?15:7;a>1&&i<n;)s=s<<6|63&t[i++],a--;a>1?o[r++]=65533:s<65536?o[r++]=s:(s-=65536,o[r++]=55296|s>>10&1023,o[r++]=56320|1023&s)}}return((s,a)=>{if(a<65534&&s.subarray&&nw)return String.fromCharCode.apply(null,s.length===a?s:s.subarray(0,a));let c="";for(let d=0;d<a;d++)c+=String.fromCharCode(s[d]);return c})(o,r)},utf8border:(t,e)=>{(e=e||t.length)>t.length&&(e=t.length);let n=e-1;for(;n>=0&&(192&t[n])==128;)n--;return n<0||n===0?e:n+Rl[t[n]]>e?n:e}},iw=function(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0};const rw=Object.prototype.toString,{Z_NO_FLUSH:KG,Z_SYNC_FLUSH:qG,Z_FULL_FLUSH:YG,Z_FINISH:zG,Z_OK:lf,Z_STREAM_END:JG,Z_DEFAULT_COMPRESSION:XG,Z_DEFAULT_STRATEGY:QG,Z_DEFLATED:ZG}=md;function vl(t){this.options=uf.assign({level:XG,method:ZG,chunkSize:16384,windowBits:15,memLevel:8,strategy:QG},t||{});let e=this.options;e.raw&&e.windowBits>0?e.windowBits=-e.windowBits:e.gzip&&e.windowBits>0&&e.windowBits<16&&(e.windowBits+=16),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new iw,this.strm.avail_out=0;let n=Sl.deflateInit2(this.strm,e.level,e.method,e.windowBits,e.memLevel,e.strategy);if(n!==lf)throw new Error(Ya[n]);if(e.header&&Sl.deflateSetHeader(this.strm,e.header),e.dictionary){let i;if(i=typeof e.dictionary=="string"?Cl.string2buf(e.dictionary):rw.call(e.dictionary)==="[object ArrayBuffer]"?new Uint8Array(e.dictionary):e.dictionary,n=Sl.deflateSetDictionary(this.strm,i),n!==lf)throw new Error(Ya[n]);this._dict_set=!0}}function iT(t,e){const n=new vl(e);if(n.push(t,!0),n.err)throw n.msg||Ya[n.err];return n.result}vl.prototype.push=function(t,e){const n=this.strm,i=this.options.chunkSize;let r,o;if(this.ended)return!1;for(o=e===~~e?e:e===!0?zG:KG,typeof t=="string"?n.input=Cl.string2buf(t):rw.call(t)==="[object ArrayBuffer]"?n.input=new Uint8Array(t):n.input=t,n.next_in=0,n.avail_in=n.input.length;;)if(n.avail_out===0&&(n.output=new Uint8Array(i),n.next_out=0,n.avail_out=i),(o===qG||o===YG)&&n.avail_out<=6)this.onData(n.output.subarray(0,n.next_out)),n.avail_out=0;else{if(r=Sl.deflate(n,o),r===JG)return n.next_out>0&&this.onData(n.output.subarray(0,n.next_out)),r=Sl.deflateEnd(this.strm),this.onEnd(r),this.ended=!0,r===lf;if(n.avail_out!==0){if(o>0&&n.next_out>0)this.onData(n.output.subarray(0,n.next_out)),n.avail_out=0;else if(n.avail_in===0)break}else this.onData(n.output)}return!0},vl.prototype.onData=function(t){this.chunks.push(t)},vl.prototype.onEnd=function(t){t===lf&&(this.result=uf.flattenChunks(this.chunks)),this.chunks=[],this.err=t,this.msg=this.strm.msg};var $G={Deflate:vl,deflate:iT,deflateRaw:function(t,e){return(e=e||{}).raw=!0,iT(t,e)},gzip:function(t,e){return(e=e||{}).gzip=!0,iT(t,e)},constants:md};const hf=16209;var tW=function(t,e){let n,i,r,o,s,a,c,d,u,l,p,f,C,m,g,y,A,k,M,V,B,K,Y,J;const lt=t.state;n=t.next_in,Y=t.input,i=n+(t.avail_in-5),r=t.next_out,J=t.output,o=r-(e-t.avail_out),s=r+(t.avail_out-257),a=lt.dmax,c=lt.wsize,d=lt.whave,u=lt.wnext,l=lt.window,p=lt.hold,f=lt.bits,C=lt.lencode,m=lt.distcode,g=(1<<lt.lenbits)-1,y=(1<<lt.distbits)-1;t:do{f<15&&(p+=Y[n++]<<f,f+=8,p+=Y[n++]<<f,f+=8),A=C[p&g];e:for(;;){if(k=A>>>24,p>>>=k,f-=k,k=A>>>16&255,k===0)J[r++]=65535&A;else{if(!(16&k)){if((64&k)==0){A=C[(65535&A)+(p&(1<<k)-1)];continue e}if(32&k){lt.mode=16191;break t}t.msg="invalid literal/length code",lt.mode=hf;break t}M=65535&A,k&=15,k&&(f<k&&(p+=Y[n++]<<f,f+=8),M+=p&(1<<k)-1,p>>>=k,f-=k),f<15&&(p+=Y[n++]<<f,f+=8,p+=Y[n++]<<f,f+=8),A=m[p&y];n:for(;;){if(k=A>>>24,p>>>=k,f-=k,k=A>>>16&255,!(16&k)){if((64&k)==0){A=m[(65535&A)+(p&(1<<k)-1)];continue n}t.msg="invalid distance code",lt.mode=hf;break t}if(V=65535&A,k&=15,f<k&&(p+=Y[n++]<<f,f+=8,f<k&&(p+=Y[n++]<<f,f+=8)),V+=p&(1<<k)-1,V>a){t.msg="invalid distance too far back",lt.mode=hf;break t}if(p>>>=k,f-=k,k=r-o,V>k){if(k=V-k,k>d&&lt.sane){t.msg="invalid distance too far back",lt.mode=hf;break t}if(B=0,K=l,u===0){if(B+=c-k,k<M){M-=k;do J[r++]=l[B++];while(--k);B=r-V,K=J}}else if(u<k){if(B+=c+u-k,k-=u,k<M){M-=k;do J[r++]=l[B++];while(--k);if(B=0,u<M){k=u,M-=k;do J[r++]=l[B++];while(--k);B=r-V,K=J}}}else if(B+=u-k,k<M){M-=k;do J[r++]=l[B++];while(--k);B=r-V,K=J}for(;M>2;)J[r++]=K[B++],J[r++]=K[B++],J[r++]=K[B++],M-=3;M&&(J[r++]=K[B++],M>1&&(J[r++]=K[B++]))}else{B=r-V;do J[r++]=J[B++],J[r++]=J[B++],J[r++]=J[B++],M-=3;while(M>2);M&&(J[r++]=J[B++],M>1&&(J[r++]=J[B++]))}break}}break}}while(n<i&&r<s);M=f>>3,n-=M,f-=M<<3,p&=(1<<f)-1,t.next_in=n,t.next_out=r,t.avail_in=n<i?i-n+5:5-(n-i),t.avail_out=r<s?s-r+257:257-(r-s),lt.hold=p,lt.bits=f};const pf=15,eW=new Uint16Array([3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0]),nW=new Uint8Array([16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78]),iW=new Uint16Array([1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0]),rW=new Uint8Array([16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64]);var yl=(t,e,n,i,r,o,s,a)=>{const c=a.bits;let d,u,l,p,f,C,m=0,g=0,y=0,A=0,k=0,M=0,V=0,B=0,K=0,Y=0,J=null;const lt=new Uint16Array(16),Yt=new Uint16Array(16);let de,Pe,hn,qe=null;for(m=0;m<=pf;m++)lt[m]=0;for(g=0;g<i;g++)lt[e[n+g]]++;for(k=c,A=pf;A>=1&&lt[A]===0;A--);if(k>A&&(k=A),A===0)return r[o++]=20971520,r[o++]=20971520,a.bits=1,0;for(y=1;y<A&&lt[y]===0;y++);for(k<y&&(k=y),B=1,m=1;m<=pf;m++)if(B<<=1,B-=lt[m],B<0)return-1;if(B>0&&(t===0||A!==1))return-1;for(Yt[1]=0,m=1;m<pf;m++)Yt[m+1]=Yt[m]+lt[m];for(g=0;g<i;g++)e[n+g]!==0&&(s[Yt[e[n+g]]++]=g);if(t===0?(J=qe=s,C=20):t===1?(J=eW,qe=nW,C=257):(J=iW,qe=rW,C=0),Y=0,g=0,m=y,f=o,M=k,V=0,l=-1,K=1<<k,p=K-1,t===1&&K>852||t===2&&K>592)return 1;for(;;){de=m-V,s[g]+1<C?(Pe=0,hn=s[g]):s[g]>=C?(Pe=qe[s[g]-C],hn=J[s[g]-C]):(Pe=96,hn=0),d=1<<m-V,u=1<<M,y=u;do u-=d,r[f+(Y>>V)+u]=de<<24|Pe<<16|hn|0;while(u!==0);for(d=1<<m-1;Y&d;)d>>=1;if(d!==0?(Y&=d-1,Y+=d):Y=0,g++,--lt[m]==0){if(m===A)break;m=e[n+s[g]]}if(m>k&&(Y&p)!==l){for(V===0&&(V=k),f+=y,M=m-V,B=1<<M;M+V<A&&(B-=lt[M+V],!(B<=0));)M++,B<<=1;if(K+=1<<M,t===1&&K>852||t===2&&K>592)return 1;l=Y&p,r[l]=k<<24|M<<16|f-o|0}}return Y!==0&&(r[f+Y]=m-V<<24|64<<16|0),a.bits=k,0};const{Z_FINISH:ow,Z_BLOCK:oW,Z_TREES:ff,Z_OK:Qa,Z_STREAM_END:sW,Z_NEED_DICT:aW,Z_STREAM_ERROR:Hr,Z_DATA_ERROR:sw,Z_MEM_ERROR:aw,Z_BUF_ERROR:cW,Z_DEFLATED:cw}=md,_f=16180,Ef=16190,Ss=16191,rT=16192,oT=16194,mf=16199,gf=16200,sT=16206,Vn=16209,dw=t=>(t>>>24&255)+(t>>>8&65280)+((65280&t)<<8)+((255&t)<<24);function dW(){this.strm=null,this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new Uint16Array(320),this.work=new Uint16Array(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}const Za=t=>{if(!t)return 1;const e=t.state;return!e||e.strm!==t||e.mode<_f||e.mode>16211?1:0},uw=t=>{if(Za(t))return Hr;const e=t.state;return t.total_in=t.total_out=e.total=0,t.msg="",e.wrap&&(t.adler=1&e.wrap),e.mode=_f,e.last=0,e.havedict=0,e.flags=-1,e.dmax=32768,e.head=null,e.hold=0,e.bits=0,e.lencode=e.lendyn=new Int32Array(852),e.distcode=e.distdyn=new Int32Array(592),e.sane=1,e.back=-1,Qa},lw=t=>{if(Za(t))return Hr;const e=t.state;return e.wsize=0,e.whave=0,e.wnext=0,uw(t)},hw=(t,e)=>{let n;if(Za(t))return Hr;const i=t.state;return e<0?(n=0,e=-e):(n=5+(e>>4),e<48&&(e&=15)),e&&(e<8||e>15)?Hr:(i.window!==null&&i.wbits!==e&&(i.window=null),i.wrap=n,i.wbits=e,lw(t))},pw=(t,e)=>{if(!t)return Hr;const n=new dW;t.state=n,n.strm=t,n.window=null,n.mode=_f;const i=hw(t,e);return i!==Qa&&(t.state=null),i};let aT,cT,fw=!0;const uW=t=>{if(fw){aT=new Int32Array(512),cT=new Int32Array(32);let e=0;for(;e<144;)t.lens[e++]=8;for(;e<256;)t.lens[e++]=9;for(;e<280;)t.lens[e++]=7;for(;e<288;)t.lens[e++]=8;for(yl(1,t.lens,0,288,aT,0,t.work,{bits:9}),e=0;e<32;)t.lens[e++]=5;yl(2,t.lens,0,32,cT,0,t.work,{bits:5}),fw=!1}t.lencode=aT,t.lenbits=9,t.distcode=cT,t.distbits=5},_w=(t,e,n,i)=>{let r;const o=t.state;return o.window===null&&(o.wsize=1<<o.wbits,o.wnext=0,o.whave=0,o.window=new Uint8Array(o.wsize)),i>=o.wsize?(o.window.set(e.subarray(n-o.wsize,n),0),o.wnext=0,o.whave=o.wsize):(r=o.wsize-o.wnext,r>i&&(r=i),o.window.set(e.subarray(n-i,n-i+r),o.wnext),(i-=r)?(o.window.set(e.subarray(n-i,n),0),o.wnext=i,o.whave=o.wsize):(o.wnext+=r,o.wnext===o.wsize&&(o.wnext=0),o.whave<o.wsize&&(o.whave+=r))),0};var lW=(t,e)=>{let n,i,r,o,s,a,c,d,u,l,p,f,C,m,g,y,A,k,M,V,B,K,Y=0;const J=new Uint8Array(4);let lt,Yt;const de=new Uint8Array([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]);if(Za(t)||!t.output||!t.input&&t.avail_in!==0)return Hr;n=t.state,n.mode===Ss&&(n.mode=rT),s=t.next_out,r=t.output,c=t.avail_out,o=t.next_in,i=t.input,a=t.avail_in,d=n.hold,u=n.bits,l=a,p=c,K=Qa;t:for(;;)switch(n.mode){case _f:if(n.wrap===0){n.mode=rT;break}for(;u<16;){if(a===0)break t;a--,d+=i[o++]<<u,u+=8}if(2&n.wrap&&d===35615){n.wbits===0&&(n.wbits=15),n.check=0,J[0]=255&d,J[1]=d>>>8&255,n.check=Ti(n.check,J,2,0),d=0,u=0,n.mode=16181;break}if(n.head&&(n.head.done=!1),!(1&n.wrap)||(((255&d)<<8)+(d>>8))%31){t.msg="incorrect header check",n.mode=Vn;break}if((15&d)!==cw){t.msg="unknown compression method",n.mode=Vn;break}if(d>>>=4,u-=4,B=8+(15&d),n.wbits===0&&(n.wbits=B),B>15||B>n.wbits){t.msg="invalid window size",n.mode=Vn;break}n.dmax=1<<n.wbits,n.flags=0,t.adler=n.check=1,n.mode=512&d?16189:Ss,d=0,u=0;break;case 16181:for(;u<16;){if(a===0)break t;a--,d+=i[o++]<<u,u+=8}if(n.flags=d,(255&ci(n))!==cw){t.msg="unknown compression method",n.mode=Vn;break}if(57344&ci(n)){t.msg="unknown header flags set",n.mode=Vn;break}n.head&&(n.head.text=d>>8&1),512&ci(n)&&4&n.wrap&&(J[0]=255&d,J[1]=d>>>8&255,n.check=Ti(n.check,J,2,0)),d=0,u=0,n.mode=16182;case 16182:for(;u<32;){if(a===0)break t;a--,d+=i[o++]<<u,u+=8}n.head&&(n.head.time=d),512&ci(n)&&4&n.wrap&&(J[0]=255&d,J[1]=d>>>8&255,J[2]=d>>>16&255,J[3]=d>>>24&255,n.check=Ti(n.check,J,4,0)),d=0,u=0,n.mode=16183;case 16183:for(;u<16;){if(a===0)break t;a--,d+=i[o++]<<u,u+=8}n.head&&(n.head.xflags=255&d,n.head.os=d>>8),512&ci(n)&&4&n.wrap&&(J[0]=255&d,J[1]=d>>>8&255,n.check=Ti(n.check,J,2,0)),d=0,u=0,n.mode=16184;case 16184:if(1024&ci(n)){for(;u<16;){if(a===0)break t;a--,d+=i[o++]<<u,u+=8}n.length=d,n.head&&(n.head.extra_len=d),512&ci(n)&&4&n.wrap&&(J[0]=255&d,J[1]=d>>>8&255,n.check=Ti(n.check,J,2,0)),d=0,u=0}else n.head&&(n.head.extra=null);n.mode=16185;case 16185:if(1024&ci(n)&&(f=n.length,f>a&&(f=a),f&&(n.head&&(B=n.head.extra_len-n.length,n.head.extra||(n.head.extra=new Uint8Array(n.head.extra_len)),n.head.extra.set(i.subarray(o,o+f),B)),512&ci(n)&&4&n.wrap&&(n.check=Ti(n.check,i,f,o)),a-=f,o+=f,n.length-=f),n.length))break t;n.length=0,n.mode=16186;case 16186:if(2048&ci(n)){if(a===0)break t;f=0;do B=i[o+f++],n.head&&B&&n.length<65536&&(n.head.name+=String.fromCharCode(B));while(B&&f<a);if(512&ci(n)&&4&n.wrap&&(n.check=Ti(n.check,i,f,o)),a-=f,o+=f,B)break t}else n.head&&(n.head.name=null);n.length=0,n.mode=16187;case 16187:if(4096&ci(n)){if(a===0)break t;f=0;do B=i[o+f++],n.head&&B&&n.length<65536&&(n.head.comment+=String.fromCharCode(B));while(B&&f<a);if(512&ci(n)&&4&n.wrap&&(n.check=Ti(n.check,i,f,o)),a-=f,o+=f,B)break t}else n.head&&(n.head.comment=null);n.mode=16188;case 16188:if(512&ci(n)){for(;u<16;){if(a===0)break t;a--,d+=i[o++]<<u,u+=8}if(4&n.wrap&&d!==(65535&n.check)){t.msg="header crc mismatch",n.mode=Vn;break}d=0,u=0}n.head&&(n.head.hcrc=ci(n)>>9&1,n.head.done=!0),t.adler=n.check=0,n.mode=Ss;break;case 16189:for(;u<32;){if(a===0)break t;a--,d+=i[o++]<<u,u+=8}t.adler=n.check=dw(d),d=0,u=0,n.mode=Ef;case Ef:if(n.havedict===0)return t.next_out=s,t.avail_out=c,t.next_in=o,t.avail_in=a,n.hold=d,n.bits=u,aW;t.adler=n.check=1,n.mode=Ss;case Ss:if(e===oW||e===ff)break t;case rT:if(n.last){d>>>=7&u,u-=7&u,n.mode=sT;break}for(;u<3;){if(a===0)break t;a--,d+=i[o++]<<u,u+=8}switch(n.last=1&d,d>>>=1,u-=1,3&d){case 0:n.mode=16193;break;case 1:if(uW(n),n.mode=mf,e===ff){d>>>=2,u-=2;break t}break;case 2:n.mode=16196;break;case 3:t.msg="invalid block type",n.mode=Vn}d>>>=2,u-=2;break;case 16193:for(d>>>=7&u,u-=7&u;u<32;){if(a===0)break t;a--,d+=i[o++]<<u,u+=8}if((65535&d)!=(d>>>16^65535)){t.msg="invalid stored block lengths",n.mode=Vn;break}if(n.length=65535&d,d=0,u=0,n.mode=oT,e===ff)break t;case oT:n.mode=16195;case 16195:if(f=n.length,f){if(f>a&&(f=a),f>c&&(f=c),f===0)break t;r.set(i.subarray(o,o+f),s),a-=f,o+=f,c-=f,s+=f,n.length-=f;break}n.mode=Ss;break;case 16196:for(;u<14;){if(a===0)break t;a--,d+=i[o++]<<u,u+=8}if(n.nlen=257+(31&d),d>>>=5,u-=5,n.ndist=1+(31&d),d>>>=5,u-=5,n.ncode=4+(15&d),d>>>=4,u-=4,n.nlen>286||n.ndist>30){t.msg="too many length or distance symbols",n.mode=Vn;break}n.have=0,n.mode=16197;case 16197:for(;n.have<n.ncode;){for(;u<3;){if(a===0)break t;a--,d+=i[o++]<<u,u+=8}n.lens[de[n.have++]]=7&d,d>>>=3,u-=3}for(;n.have<19;)n.lens[de[n.have++]]=0;if(n.lencode=n.lendyn,n.lenbits=7,lt={bits:n.lenbits},K=yl(0,n.lens,0,19,n.lencode,0,n.work,lt),n.lenbits=lt.bits,K){t.msg="invalid code lengths set",n.mode=Vn;break}n.have=0,n.mode=16198;case 16198:for(;n.have<n.nlen+n.ndist;){for(;Y=n.lencode[d&(1<<n.lenbits)-1],g=Y>>>24,y=Y>>>16&255,A=65535&Y,!(g<=u);){if(a===0)break t;a--,d+=i[o++]<<u,u+=8}if(A<16)d>>>=g,u-=g,n.lens[n.have++]=A;else{if(A===16){for(Yt=g+2;u<Yt;){if(a===0)break t;a--,d+=i[o++]<<u,u+=8}if(d>>>=g,u-=g,n.have===0){t.msg="invalid bit length repeat",n.mode=Vn;break}B=n.lens[n.have-1],f=3+(3&d),d>>>=2,u-=2}else if(A===17){for(Yt=g+3;u<Yt;){if(a===0)break t;a--,d+=i[o++]<<u,u+=8}d>>>=g,u-=g,B=0,f=3+(7&d),d>>>=3,u-=3}else{for(Yt=g+7;u<Yt;){if(a===0)break t;a--,d+=i[o++]<<u,u+=8}d>>>=g,u-=g,B=0,f=11+(127&d),d>>>=7,u-=7}if(n.have+f>n.nlen+n.ndist){t.msg="invalid bit length repeat",n.mode=Vn;break}for(;f--;)n.lens[n.have++]=B}}if(n.mode===Vn)break;if(n.lens[256]===0){t.msg="invalid code -- missing end-of-block",n.mode=Vn;break}if(n.lenbits=9,lt={bits:n.lenbits},K=yl(1,n.lens,0,n.nlen,n.lencode,0,n.work,lt),n.lenbits=lt.bits,K){t.msg="invalid literal/lengths set",n.mode=Vn;break}if(n.distbits=6,n.distcode=n.distdyn,lt={bits:n.distbits},K=yl(2,n.lens,n.nlen,n.ndist,n.distcode,0,n.work,lt),n.distbits=lt.bits,K){t.msg="invalid distances set",n.mode=Vn;break}if(n.mode=mf,e===ff)break t;case mf:n.mode=gf;case gf:if(a>=6&&c>=258){t.next_out=s,t.avail_out=c,t.next_in=o,t.avail_in=a,n.hold=d,n.bits=u,tW(t,p),s=t.next_out,r=t.output,c=t.avail_out,o=t.next_in,i=t.input,a=t.avail_in,d=n.hold,u=n.bits,n.mode===Ss&&(n.back=-1);break}for(n.back=0;Y=n.lencode[d&(1<<n.lenbits)-1],g=Y>>>24,y=Y>>>16&255,A=65535&Y,!(g<=u);){if(a===0)break t;a--,d+=i[o++]<<u,u+=8}if(y&&(240&y)==0){for(k=g,M=y,V=A;Y=n.lencode[V+((d&(1<<k+M)-1)>>k)],g=Y>>>24,y=Y>>>16&255,A=65535&Y,!(k+g<=u);){if(a===0)break t;a--,d+=i[o++]<<u,u+=8}d>>>=k,u-=k,n.back+=k}if(d>>>=g,u-=g,n.back+=g,n.length=A,y===0){n.mode=16205;break}if(32&y){n.back=-1,n.mode=Ss;break}if(64&y){t.msg="invalid literal/length code",n.mode=Vn;break}n.extra=15&y,n.mode=16201;case 16201:if(n.extra){for(Yt=n.extra;u<Yt;){if(a===0)break t;a--,d+=i[o++]<<u,u+=8}n.length+=d&(1<<n.extra)-1,d>>>=n.extra,u-=n.extra,n.back+=n.extra}n.was=n.length,n.mode=16202;case 16202:for(;Y=n.distcode[d&(1<<n.distbits)-1],g=Y>>>24,y=Y>>>16&255,A=65535&Y,!(g<=u);){if(a===0)break t;a--,d+=i[o++]<<u,u+=8}if((240&y)==0){for(k=g,M=y,V=A;Y=n.distcode[V+((d&(1<<k+M)-1)>>k)],g=Y>>>24,y=Y>>>16&255,A=65535&Y,!(k+g<=u);){if(a===0)break t;a--,d+=i[o++]<<u,u+=8}d>>>=k,u-=k,n.back+=k}if(d>>>=g,u-=g,n.back+=g,64&y){t.msg="invalid distance code",n.mode=Vn;break}n.offset=A,n.extra=15&y,n.mode=16203;case 16203:if(n.extra){for(Yt=n.extra;u<Yt;){if(a===0)break t;a--,d+=i[o++]<<u,u+=8}n.offset+=d&(1<<n.extra)-1,d>>>=n.extra,u-=n.extra,n.back+=n.extra}if(n.offset>n.dmax){t.msg="invalid distance too far back",n.mode=Vn;break}n.mode=16204;case 16204:if(c===0)break t;if(f=p-c,n.offset>f){if(f=n.offset-f,f>n.whave&&n.sane){t.msg="invalid distance too far back",n.mode=Vn;break}f>n.wnext?(f-=n.wnext,C=n.wsize-f):C=n.wnext-f,f>n.length&&(f=n.length),m=n.window}else m=r,C=s-n.offset,f=n.length;f>c&&(f=c),c-=f,n.length-=f;do r[s++]=m[C++];while(--f);n.length===0&&(n.mode=gf);break;case 16205:if(c===0)break t;r[s++]=n.length,c--,n.mode=gf;break;case sT:if(n.wrap){for(;u<32;){if(a===0)break t;a--,d|=i[o++]<<u,u+=8}if(p-=c,t.total_out+=p,n.total+=p,4&n.wrap&&p&&(t.adler=n.check=ci(n)?Ti(n.check,r,p,s-p):_l(n.check,r,p,s-p)),p=c,4&n.wrap&&(ci(n)?d:dw(d))!==n.check){t.msg="incorrect data check",n.mode=Vn;break}d=0,u=0}n.mode=16207;case 16207:if(n.wrap&&ci(n)){for(;u<32;){if(a===0)break t;a--,d+=i[o++]<<u,u+=8}if(4&n.wrap&&d!==(4294967295&n.total)){t.msg="incorrect length check",n.mode=Vn;break}d=0,u=0}n.mode=16208;case 16208:K=sW;break t;case Vn:K=sw;break t;case 16210:return aw;default:return Hr}return t.next_out=s,t.avail_out=c,t.next_in=o,t.avail_in=a,n.hold=d,n.bits=u,(n.wsize||p!==t.avail_out&&n.mode<Vn&&(n.mode<sT||e!==ow))&&_w(t,t.output,t.next_out,p-t.avail_out),l-=t.avail_in,p-=t.avail_out,t.total_in+=l,t.total_out+=p,n.total+=p,4&n.wrap&&p&&(t.adler=n.check=ci(n)?Ti(n.check,r,p,t.next_out-p):_l(n.check,r,p,t.next_out-p)),t.data_type=n.bits+(n.last?64:0)+(n.mode===Ss?128:0)+(n.mode===mf||n.mode===oT?256:0),(l===0&&p===0||e===ow)&&K===Qa&&(K=cW),K},Rs={inflateReset:lw,inflateReset2:hw,inflateResetKeep:uw,inflateInit:t=>pw(t,15),inflateInit2:pw,inflate:lW,inflateEnd:t=>{if(Za(t))return Hr;let e=t.state;return e.window&&(e.window=null),t.state=null,Qa},inflateGetHeader:(t,e)=>{if(Za(t))return Hr;const n=t.state;return(2&n.wrap)==0?Hr:(n.head=e,e.done=!1,Qa)},inflateSetDictionary:(t,e)=>{const n=e.length;let i,r,o;return Za(t)?Hr:(i=t.state,i.wrap!==0&&i.mode!==Ef?Hr:i.mode===Ef&&(r=1,r=_l(r,e,n,0),r!==i.check)?sw:(o=_w(t,e,n,n),o?(i.mode=16210,aw):(i.havedict=1,Qa)))},inflateInfo:"pako inflate (from Nodeca project)"},hW=function(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1};const Ew=Object.prototype.toString,{Z_NO_FLUSH:pW,Z_FINISH:fW,Z_OK:Il,Z_STREAM_END:dT,Z_NEED_DICT:uT,Z_STREAM_ERROR:_W,Z_DATA_ERROR:mw,Z_MEM_ERROR:EW}=md;function bl(t){this.options=uf.assign({chunkSize:65536,windowBits:15,to:""},t||{});const e=this.options;e.raw&&e.windowBits>=0&&e.windowBits<16&&(e.windowBits=-e.windowBits,e.windowBits===0&&(e.windowBits=-15)),!(e.windowBits>=0&&e.windowBits<16)||t&&t.windowBits||(e.windowBits+=32),e.windowBits>15&&e.windowBits<48&&(15&e.windowBits)==0&&(e.windowBits|=15),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new iw,this.strm.avail_out=0;let n=Rs.inflateInit2(this.strm,e.windowBits);if(n!==Il)throw new Error(Ya[n]);if(this.header=new hW,Rs.inflateGetHeader(this.strm,this.header),e.dictionary&&(typeof e.dictionary=="string"?e.dictionary=Cl.string2buf(e.dictionary):Ew.call(e.dictionary)==="[object ArrayBuffer]"&&(e.dictionary=new Uint8Array(e.dictionary)),e.raw&&(n=Rs.inflateSetDictionary(this.strm,e.dictionary),n!==Il)))throw new Error(Ya[n])}function lT(t,e){const n=new bl(e);if(n.push(t),n.err)throw n.msg||Ya[n.err];return n.result}bl.prototype.push=function(t,e){const n=this.strm,i=this.options.chunkSize,r=this.options.dictionary;let o,s,a;if(this.ended)return!1;for(s=e===~~e?e:e===!0?fW:pW,Ew.call(t)==="[object ArrayBuffer]"?n.input=new Uint8Array(t):n.input=t,n.next_in=0,n.avail_in=n.input.length;;){for(n.avail_out===0&&(n.output=new Uint8Array(i),n.next_out=0,n.avail_out=i),o=Rs.inflate(n,s),o===uT&&r&&(o=Rs.inflateSetDictionary(n,r),o===Il?o=Rs.inflate(n,s):o===mw&&(o=uT));n.avail_in>0&&o===dT&&n.state.wrap>0&&t[n.next_in]!==0;)Rs.inflateReset(n),o=Rs.inflate(n,s);switch(o){case _W:case mw:case uT:case EW:return this.onEnd(o),this.ended=!0,!1}if(a=n.avail_out,n.next_out&&(n.avail_out===0||o===dT))if(this.options.to==="string"){let c=Cl.utf8border(n.output,n.next_out),d=n.next_out-c,u=Cl.buf2string(n.output,c);n.next_out=d,n.avail_out=i-d,d&&n.output.set(n.output.subarray(c,c+d),0),this.onData(u)}else this.onData(n.output.length===n.next_out?n.output:n.output.subarray(0,n.next_out));if(o!==Il||a!==0){if(o===dT)return o=Rs.inflateEnd(this.strm),this.onEnd(o),this.ended=!0,!0;if(n.avail_in===0)break}}return!0},bl.prototype.onData=function(t){this.chunks.push(t)},bl.prototype.onEnd=function(t){t===Il&&(this.options.to==="string"?this.result=this.chunks.join(""):this.result=uf.flattenChunks(this.chunks)),this.chunks=[],this.err=t,this.msg=this.strm.msg};var mW={Inflate:bl,inflate:lT,inflateRaw:function(t,e){return(e=e||{}).raw=!0,lT(t,e)},ungzip:lT,constants:md};const{Deflate:iH,deflate:gW,deflateRaw:rH,gzip:oH}=$G,{Inflate:sH,inflate:TW,inflateRaw:aH,ungzip:cH}=mW;var SW=gW,RW=TW;const Yn={getDisplayMedia:!1,getStreamFromExtension:!1,supportUnifiedPlan:!1,supportMinBitrate:!1,supportSetRtpSenderParameters:!1,supportDualStream:!0,webAudioMediaStreamDest:!1,supportReplaceTrack:!1,supportWebGL:!1,webAudioWithAEC:!1,supportRequestFrame:!1,supportShareAudio:!1,supportDualStreamEncoding:!1,supportDataChannel:!1,supportPCSetConfiguration:!1,supportWebRTCEncodedTransform:!1,supportWebRTCInsertableStream:!1,supportRequestVideoFrameCallback:!1,supportWebCrypto:!1};function zt(){return Yn}function gw(){return"setSinkId"in HTMLAudioElement.prototype&&(!N("RESTRICTION_SET_PLAYBACK_DEVICE")||(Gs()||NI())&&!Gm())}let jn=function(t){return t.IOS_15_16_INTERRUPTION_START="ios15_16-interruption-start",t.IOS_15_16_INTERRUPTION_END="ios15_16-interruption-end",t.IOS_INTERRUPTION_START="ios-interruption-start",t.IOS_INTERRUPTION_END="ios-interruption-end",t.STATE_CHANGE="state-change",t}({});function Rd(t,e,n){return{sampleRate:t,stereo:e,bitrate:n}}function Xt(t,e,n,i,r){return{width:t,height:e,frameRate:n,bitrateMin:i,bitrateMax:r}}function Kr(t,e,n,i,r){return{width:{max:t},height:{max:e},frameRate:n,bitrateMin:i,bitrateMax:r}}function hT(t,e){return{numSpatialLayers:t,numTemporalLayers:e}}const CW={"90p":Xt(160,90),"90p_1":Xt(160,90),"120p":Xt(160,120,15,30,65),"120p_1":Xt(160,120,15,30,65),"120p_3":Xt(120,120,15,30,50),"120p_4":Xt(212,120),"180p":Xt(320,180,15,30,140),"180p_1":Xt(320,180,15,30,140),"180p_3":Xt(180,180,15,30,100),"180p_4":Xt(240,180,15,30,120),"240p":Xt(320,240,15,40,200),"240p_1":Xt(320,240,15,40,200),"240p_3":Xt(240,240,15,40,140),"240p_4":Xt(424,240,15,40,220),"360p":Xt(640,360,15,80,400),"360p_1":Xt(640,360,15,80,400),"360p_3":Xt(360,360,15,80,260),"360p_4":Xt(640,360,30,80,600),"360p_6":Xt(360,360,30,80,400),"360p_7":Xt(480,360,15,80,320),"360p_8":Xt(480,360,30,80,490),"360p_9":Xt(640,360,15,80,800),"360p_10":Xt(640,360,24,80,800),"360p_11":Xt(640,360,24,80,1e3),"480p":Xt(640,480,15,100,500),"480p_1":Xt(640,480,15,100,500),"480p_2":Xt(640,480,30,100,1e3),"480p_3":Xt(480,480,15,100,400),"480p_4":Xt(640,480,30,100,750),"480p_6":Xt(480,480,30,100,600),"480p_8":Xt(848,480,15,100,610),"480p_9":Xt(848,480,30,100,930),"480p_10":Xt(640,480,10,100,400),"720p":Xt(1280,720,15,120,1130),"720p_auto":Xt(1280,720,30,900,3e3),"720p_1":Xt(1280,720,15,120,1130),"720p_2":Xt(1280,720,30,120,2e3),"720p_3":Xt(1280,720,30,120,1710),"720p_5":Xt(960,720,15,120,910),"720p_6":Xt(960,720,30,120,1380),"1080p":Xt(1920,1080,15,120,2080),"1080p_1":Xt(1920,1080,15,120,2080),"1080p_2":Xt(1920,1080,30,120,3e3),"1080p_3":Xt(1920,1080,30,120,3150),"1080p_5":Xt(1920,1080,60,120,4780),"1440p":Xt(2560,1440,30,120,4850),"1440p_1":Xt(2560,1440,30,120,4850),"1440p_2":Xt(2560,1440,60,120,7350),"4k":Xt(3840,2160,30,120,8910),"4k_1":Xt(3840,2160,30,120,8910),"4k_3":Xt(3840,2160,60,120,13500)},Tf=[{scaleResolutionDownBy:2,width:1280,height:720,frameRate:30,bitrateMin:300,bitrateMax:900},{scaleResolutionDownBy:1.333333,width:1280,height:720,frameRate:30,bitrateMin:600,bitrateMax:2e3},{scaleResolutionDownBy:1,width:1280,height:720,frameRate:30,bitrateMin:900,bitrateMax:3e3}],vW={"480p":Kr(640,480,5),"480p_1":Kr(640,480,5),"480p_2":Kr(640,480,30),"480p_3":Kr(640,480,15),"720p":Kr(1280,720,5),"720p_auto":Xt(1280,720,30,900,3e3),"720p_1":Kr(1280,720,5),"720p_2":Kr(1280,720,30),"720p_3":Kr(1280,720,15),"1080p":Kr(1920,1080,5),"1080p_1":Kr(1920,1080,5),"1080p_2":Kr(1920,1080,30),"1080p_3":Kr(1920,1080,15)},yW={"1SL1TL":hT(1,1),"3SL3TL":hT(3,3),"2SL3TL":hT(2,3)};function Ho(t){return t||(t="480p_1"),typeof t=="string"?Object.assign({},CW[t]):t}function pT(t){return typeof t=="string"?Object.assign({},vW[t]):t}function Sf(t){return typeof t=="string"?Object.assign({},yW[t]):t}const IW={speech_low_quality:Rd(16e3,!1),speech_standard:Rd(32e3,!1,18),music_standard:Rd(48e3,!1),standard_stereo:Rd(48e3,!0,56),high_quality:Rd(48e3,!1,128),high_quality_stereo:Rd(48e3,!0,192)};function Rf(t){return typeof t=="string"?Object.assign({},IW[t]):t}const Cd=[];function Tw(t){return yn(t,"mediaSource",["screen","window","application"]),!0}let ut=function(t){return t.NEED_RENEGOTIATE="@need_renegotiate",t.NEED_REPLACE_TRACK="@need_replace_track",t.NEED_REPLACE_MIXING_TRACK="@need_replace_mixing_track",t.NEED_CLOSE="@need_close",t.NEED_ENABLE_TRACK="@need_enable_track",t.NEED_DISABLE_TRACK="@need_disable_track",t.NEED_SESSION_ID="@need_sid",t.SET_OPTIMIZATION_MODE="@set_optimization_mode",t.GET_STATS="@get_stats",t.GET_RTC_STATS="@get_rtc_stats",t.GET_LOW_VIDEO_TRACK="@get_low_video_track",t.NEED_RESET_REMOTE_SDP="@need_reset_remote_sdp",t.NEED_UPDATE_VIDEO_ENCODER="@need_update_video_encoder",t.NEED_UPDATE_VIDEO_SEND_PARAMETERS="@need_update_video_send_parameters",t.NEED_MUTE_TRACK="@need_mute_track",t.NEED_UNMUTE_TRACK="@need_unmute_track",t}({}),De=function(t){return t.SCREEN_TRACK="screen_track",t.CUSTOM_TRACK="custome_track",t.LOW_STREAM="low_stream",t}({}),vd=function(t){return t[t.HIGH_STREAM=0]="HIGH_STREAM",t[t.LOW_STREAM=1]="LOW_STREAM",t}({}),bW=function(t){return t[t.HIGH_STREAM=0]="HIGH_STREAM",t[t.LOW_STREAM=1]="LOW_STREAM",t}({}),AW=function(t){return t[t.DISABLE=0]="DISABLE",t[t.LOW_STREAM=1]="LOW_STREAM",t[t.AUDIO_ONLY=2]="AUDIO_ONLY",t}({}),$a=function(t){return t.TRANSCEIVER_UPDATED="transceiver-updated",t.SEI_TO_SEND="sei-to-send",t.SEI_RECEIVED="sei-received",t.TRACK_UPDATED="track-updated",t}({}),yd=function(t){return t.SOURCE_STATE_CHANGE="source-state-change",t.TRACK_ENDED="track-ended",t.BEAUTY_EFFECT_OVERLOAD="beauty-effect-overload",t.VIDEO_ELEMENT_VISIBLE_STATUS="video-element-visible-status",t.CLOSED="closed",t}({}),Id=function(t){return t.FIRST_FRAME_DECODED="first-frame-decoded",t.VIDEO_ELEMENT_VISIBLE_STATUS="video-element-visible-status",t.VIDEO_STATE_CHANGED="video-state-changed",t}({}),tr=function(t){return t.AUDIO_SOURCE_STATE_CHANGE="audio_source_state_change",t.RECEIVE_TRACK_BUFFER="receive_track_buffer",t.ON_AUDIO_BUFFER="on_audio_buffer",t.UPDATE_SOURCE="update_source",t}({});(function(t){t.UPDATE_TRACK_SOURCE="update-track-source"})({});const fT={sendVolumeLevel:0,sendBitrate:0,sendBytes:0,sendPackets:0,sendPacketsLost:0,sendJitterMs:0,sendRttMs:0,currentPacketLossRate:0},_T={sendBytes:0,sendBitrate:0,sendPackets:0,sendPacketsLost:0,sendJitterMs:0,sendRttMs:0,sendResolutionHeight:0,sendResolutionWidth:0,captureResolutionHeight:0,captureResolutionWidth:0,targetSendBitrate:0,totalDuration:0,totalFreezeTime:0,currentPacketLossRate:0},Sw={transportDelay:0,end2EndDelay:0,receiveBitrate:0,receiveLevel:0,receiveBytes:0,receiveDelay:0,receivePackets:0,receivePacketsLost:0,totalDuration:0,totalFreezeTime:0,freezeRate:0,packetLossRate:0,currentPacketLossRate:0,publishDuration:-1},wW={uplinkNetworkQuality:0,downlinkNetworkQuality:0},Rw={transportDelay:0,end2EndDelay:0,receiveBitrate:0,receiveBytes:0,receiveDelay:0,receivePackets:0,receivePacketsLost:0,receiveResolutionHeight:0,receiveResolutionWidth:0,totalDuration:0,totalFreezeTime:0,freezeRate:0,packetLossRate:0,currentPacketLossRate:0,publishDuration:-1};let Si=function(t){return t.ON_TRACK="on_track",t.ON_NODE="on_node",t}({}),er=function(t){return t.REQUEST_UPDATE_CONSTRAINTS="request_update_constraints",t.REQUEST_CONSTRAINTS="request_constraints",t}({}),Al=function(t){return t.IDLE="IDLE",t.INITING="INITING",t.INITEND="INITEND",t}({}),tc=function(t){return t.STATE_CHANGE="state_change",t.RECORDING_DEVICE_CHANGED="recordingDeviceChanged",t.PLAYOUT_DEVICE_CHANGED="playoutDeviceChanged",t.CAMERA_DEVICE_CHANGED="cameraDeviceChanged",t}({}),di=function(t){return t.NONE="none",t.INIT="init",t.CANPLAY="canplay",t.PLAYING="playing",t.PAUSED="paused",t.SUSPEND="suspend",t.STALLED="stalled",t.WAITING="waiting",t.ERROR="error",t.DESTROYED="destroyed",t.ABORT="abort",t.ENDED="ended",t.EMPTIED="emptied",t.LOADEDDATA="loadeddata",t}({}),Ko=function(t){return t[t.VideoStateStopped=0]="VideoStateStopped",t[t.VideoStateStarting=1]="VideoStateStarting",t[t.VideoStateDecoding=2]="VideoStateDecoding",t[t.VideoStateFrozen=3]="VideoStateFrozen",t}({});const ET={uninit:100,none:110,init:120,loadeddata:130,canplay:200,playing:210,paused:220,suspend:300,stalled:310,waiting:320,error:330,destroyed:340,abort:350,ended:360,emptied:370};let Cf=function(t){return t.OPEN="open",t.MESSAGE="message",t.CLOSE="close",t.CLOSING="closing",t.ERROR="error",t}({});function Cw(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),n.push.apply(n,i)}return n}function Fe(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?Cw(Object(n),!0).forEach(function(i){W(t,i,n[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):Cw(Object(n)).forEach(function(i){Object.defineProperty(t,i,Object.getOwnPropertyDescriptor(n,i))})}return t}function W(t,e,n){return(e=function(i){var r=function(o,s){if(typeof o!="object"||o===null)return o;var a=o[Symbol.toPrimitive];if(a!==void 0){var c=a.call(o,"string");if(typeof c!="object")return c;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(o)}(i);return typeof r=="symbol"?r:String(r)}(e))in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function Jt(t,e,n,i,r){var o,s,a={};return Object.keys(i).forEach(function(c){a[c]=i[c]}),a.enumerable=!!a.enumerable,a.configurable=!!a.configurable,("value"in a||a.initializer)&&(a.writable=!0),a=io(o=uB(s=n.slice()).call(s)).call(o,function(c,d){return d(t,e,c)||c},a),r&&a.initializer!==void 0&&(a.value=a.initializer?a.initializer.call(r):void 0,a.initializer=void 0),a.initializer===void 0&&(Object.defineProperty(t,e,a),a=null),a}class vw extends Ve{set _mediaStreamTrack(e){e!==this.mediaStreamTrack&&(this.safeEmit($a.TRACK_UPDATED,e),this.mediaStreamTrack=e)}get _mediaStreamTrack(){return this.mediaStreamTrack}constructor(e,n){super(),W(this,"trackMediaType",void 0),W(this,"_ID",void 0),W(this,"_rtpTransceiver",void 0),W(this,"_lowRtpTransceiver",void 0),W(this,"_hints",[]),W(this,"_isClosed",!1),W(this,"_originMediaStreamTrack",void 0),W(this,"mediaStreamTrack",void 0),W(this,"_external",{}),this._ID=n||be(8,"track-"),this._originMediaStreamTrack=e,this.mediaStreamTrack=e,function(i){it(Cd).call(Cd,i)||Cd.push(i)}(this)}toString(){return this._ID}getTrackId(){return this._ID}getMediaStreamTrack(e){return e||Hs(()=>{var n;Et.reportApiInvoke(null,{name:_n.GET_MEDIA_STREAM_TRACK,options:[],tag:Je.TRACER}).onSuccess(((n=this._mediaStreamTrack)===null||n===void 0?void 0:n.label)||"")},this.mediaStreamTrack.id||this.getTrackId()),this._mediaStreamTrack}getRTCRtpTransceiver(e){return e===vd.LOW_STREAM?this._lowRtpTransceiver:this._rtpTransceiver}getMediaStreamTrackSettings(){return this.getMediaStreamTrack(!0).getSettings()}close(){this._isClosed=!0,this._lowRtpTransceiver=void 0,this._rtpTransceiver=void 0,function(e){const n=Cd.indexOf(e);n!==-1&&Cd.splice(n,1)}(this),this.emit(yd.CLOSED),this.removeAllListeners($a.SEI_RECEIVED)}_updateRtpTransceiver(e,n){if(n===vd.LOW_STREAM){if(this._lowRtpTransceiver===e)return;this._lowRtpTransceiver=e}else{if(this._rtpTransceiver===e)return;this._rtpTransceiver=e}this.emit($a.TRANSCEIVER_UPDATED,e,n)}}class bd extends vw{get isExternalTrack(){return this._isExternalTrack}get muted(){return this._muted}get enabled(){return this._enabled}get processorContext(){return this._processorContext}constructor(e,n){super(e,n),W(this,"_enabled",!0),W(this,"_muted",!1),W(this,"_isExternalTrack",!1),W(this,"_isClosed",!1),W(this,"_enabledMutex",void 0),W(this,"processor",void 0),W(this,"_processorContext",void 0),W(this,"_handleTrackEnded",()=>{this.onTrackEnded()}),this._enabledMutex=new kn("".concat(this.getTrackId())),e.addEventListener("ended",this._handleTrackEnded)}getTrackLabel(){var e,n;return(e=(n=this._originMediaStreamTrack)===null||n===void 0?void 0:n.label)!==null&&e!==void 0?e:""}close(){this._isClosed||(this.stop(),this._originMediaStreamTrack.stop(),this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack.stop(),this._mediaStreamTrack=null),this._originMediaStreamTrack=null,this._enabledMutex=null,E.debug("[".concat(this.getTrackId(),"] close")),this.emit(ut.NEED_CLOSE),super.close())}async _updateOriginMediaStreamTrack(e,n){let i=arguments.length>2&&arguments[2]!==void 0&&arguments[2];this._isExternalTrack=i,e!==this._originMediaStreamTrack&&(this._originMediaStreamTrack&&(this._originMediaStreamTrack.removeEventListener("ended",this._handleTrackEnded),n&&this._originMediaStreamTrack.stop()),e.addEventListener("ended",this._handleTrackEnded),this._originMediaStreamTrack=e,this._muted&&(this._originMediaStreamTrack.enabled=!1),this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource(),await Ie(this,ut.NEED_REPLACE_TRACK,this),this.processor&&this._processorContext&&this.processor.updateInput({track:this._originMediaStreamTrack,context:this._processorContext}))}_getDefaultPlayerConfig(){return{}}onTrackEnded(){E.debug("[".concat(this.getTrackId(),"] track ended")),this.safeEmit(yd.TRACK_ENDED)}stateCheck(e,n){if(E.debug("check track state, [muted: ".concat(this._muted,", enabled: ").concat(this._enabled,"] to [").concat(e,": ").concat(n,"]")),hs(n,e),this._enabled&&this._muted&&e==="enabled"&&n===!1)throw new G(b.TRACK_STATE_UNREACHABLE,"cannot set enabled while the track is muted").print("error",E);if(!this._enabled&&!this._muted&&e==="muted"&&n===!0)throw new G(b.TRACK_STATE_UNREACHABLE,"cannot set muted while the track is disabled").print("error",E)}getProcessorStats(){return this._processorContext&&this._processorContext.gatherStats()||[]}getProcessorUsage(){return this._processorContext?this._processorContext.gatherUsage():ot.resolve([])}}const yw=window.AudioContext||window.webkitAudioContext;let nr=null;const Ee=new class extends Ve{constructor(){super(...arguments),W(this,"prevState",void 0),W(this,"curState",void 0),W(this,"currentTime",void 0),W(this,"currentTimeStuckAt",void 0),W(this,"interruptDetectorTrack",void 0),W(this,"onLocalAudioTrackMute",()=>{E.info("ios15-interruption-start"),this.emit(jn.IOS_15_16_INTERRUPTION_START)}),W(this,"onLocalAudioTrackUnmute",async()=>{E.info("ios15-interruption-end"),this.curState!=="running"||this.duringInterruption?E.info("ios15-interruption-end-canceled"):(nr&&await nr.suspend(),this.emit(jn.IOS_15_16_INTERRUPTION_END))})}get duringInterruption(){return this.prevState==="running"&&this.curState==="interrupted"}bindInterruptDetectorTrack(t){E.debug("webaudio bindInterruptDetectorTrack ".concat(t.getTrackId())),this.interruptDetectorTrack||(this.interruptDetectorTrack=t,this.interruptDetectorTrack._mediaStreamTrack.onmute=this.onLocalAudioTrackMute,this.interruptDetectorTrack._mediaStreamTrack.onunmute=this.onLocalAudioTrackUnmute)}unbindInterruptDetectorTrack(t){E.debug("webaudio unbindInterruptDetectorTrack ".concat(t.getTrackId())),this.interruptDetectorTrack&&this.interruptDetectorTrack===t&&(this.interruptDetectorTrack._mediaStreamTrack&&(this.interruptDetectorTrack._mediaStreamTrack.onmute=null,this.interruptDetectorTrack._mediaStreamTrack.onunmute=null),this.interruptDetectorTrack=void 0)}};function Ad(){if(!nr){if(function(){if(!yw)return void E.error("your browser is not support web audio");E.info("create audio context");const t=Fe({},N("WEBAUDIO_INIT_OPTIONS"));E.debug("audio context init option:",JSON.stringify(t)),nr=new yw(t),Ee.curState=nr.state,nr.onstatechange=()=>{Ee.prevState=Ee.curState,Ee.curState=nr?nr.state:void 0;const{prevState:e,curState:n}=Ee,i=n==="running",r=n==="interrupted",o=e==="running",s=e==="suspended",a=e==="interrupted",c=Zt().osVersion;(Qn()||Lr())&&o&&r&&(E.info("ios".concat(c,"-interruption-start")),Ee.emit(jn.IOS_INTERRUPTION_START)),(Qn()||Lr())&&(s||a)&&i&&(E.info("ios".concat(c,"-interruption-end")),Ee.emit(jn.IOS_INTERRUPTION_END)),e!==n&&Ee.emit(jn.STATE_CHANGE,n,e)},setInterval(()=>{var e;const n=(e=nr)===null||e===void 0?void 0:e.currentTime;Ee.currentTime!==n?(Ee.currentTimeStuckAt&&(E.debug("AudioContext current time resume at ".concat(n)),Ee.currentTimeStuckAt=void 0),Ee.currentTime=n):(n!==Ee.currentTimeStuckAt&&(Et.reportApiInvoke(null,{name:"WEB_AUDIO_CURRENT_TIME_STUCK",options:{currentTime:n},tag:Je.TRACER}).onSuccess(),E.warning("AudioContext current time stuck at ".concat(n))),Ee.currentTimeStuckAt=n)},5e3),async function(e){const n=["click","contextmenu","auxclick","dblclick","mousedown","mouseup","touchend","keydown","keyup"];let i,r=!1,o=!1,s=!1;function a(m){e.state==="running"?c(!1):Qn()||Lr()?e.state==="suspended"&&(c(!0),m&&e.resume().then(d,d)):e.state!=="closed"&&(c(!0),m&&e.resume().then(d,d))}function c(m){if(r!==m){r=m;for(let g=0,y=n;g<y.length;g+=1){const A=y[g];m?window.addEventListener(A,u,{capture:!0,passive:!0}):window.removeEventListener(A,u,{capture:!0,passive:!0})}}}function d(){a(!1)}function u(){a(!0)}function l(m){if(!s)if(i.paused)if(m){let g;p(!1),s=!0;try{g=i.play(),g?g.then(f,f):(i.addEventListener("playing",f),i.addEventListener("abort",f),i.addEventListener("error",f))}catch{f()}}else p(!0);else p(!1)}function p(m){if(o!==m){o=m;for(let g=0,y=n;g<y.length;g++){const A=y[g];m?window.addEventListener(A,C,{capture:!0,passive:!0}):window.removeEventListener(A,C,{capture:!0,passive:!0})}}}function f(){i.removeEventListener("playing",f),i.removeEventListener("abort",f),i.removeEventListener("error",f),s=!1,l(!1)}function C(){l(!0)}if(Qn()){const m=e.createMediaStreamDestination(),g=document.createElement("div");g.innerHTML="<audio x-webkit-airplay='deny'></audio>",i=g.children.item(0),i.controls=!1,i.disableRemotePlayback=!0,i.preload="auto",i.srcObject=m.stream,l(!0)}Ee.on(jn.STATE_CHANGE,function(){a(!0)}),a(!1)}(nr)}(),!nr)throw new G(b.NOT_SUPPORTED,"can not create audio context");return nr}return nr}function ec(t){if(function(){if(mT!==null)return mT;const i=Ad(),r=i.createBufferSource(),o=i.createGain(),s=i.createGain();r.connect(o),r.connect(s),r.disconnect(o);let a=!1;try{r.disconnect(o)}catch{a=!0}return r.disconnect(),mT=a,a}())return;const e=t.connect,n=t.disconnect;t.connect=(i,r,o)=>{var s;return t._inputNodes||(t._inputNodes=[]),it(s=t._inputNodes).call(s,i)||(i instanceof AudioNode?(t._inputNodes.push(i),e.call(t,i,r,o)):e.call(t,i,r)),t},t.disconnect=(i,r,o)=>{n.call(t),i?Lp(t._inputNodes,i):t._inputNodes=[];for(const s of t._inputNodes)e.call(t,s)}}let mT=null;function gT(t,e){let n=!1;const i=1/e;if(N("DISABLE_WEBAUDIO")){const r=window.setInterval(()=>{n?window.clearInterval(r):t(performance.now()/1e3)},1e3*i)}else{const r=Ad();let o=r.createGain();o.gain.value=0,o.connect(r.destination);const s=()=>{if(n)return void(o=null);const a=r.createOscillator();a.onended=s,a.connect(o),a.start(0),a.stop(r.currentTime+i),t(r.currentTime)};s()}return()=>{n=!0}}class Iw{constructor(){W(this,"context",void 0),W(this,"analyserNode",void 0),W(this,"sourceNode",void 0),this.context=Ad(),this.analyserNode=this.context.createAnalyser(),this.analyserNode.fftSize=2048,this.analyserNode.smoothingTimeConstant=.4}updateSource(e){if(e!==this.sourceNode){if(this.sourceNode)try{this.sourceNode.disconnect(this.analyserNode)}catch{}this.sourceNode=e,e==null||e.connect(this.analyserNode)}}getVolumeLevel(){if(!this.sourceNode||(!this.context||Qn()||Lr()||this.context.state!=="running"&&this.context.resume(),!this.analyserNode))return 0;const e=new Float32Array(this.analyserNode.fftSize);if(this.analyserNode.getFloatTimeDomainData)this.analyserNode.getFloatTimeDomainData(e);else{const i=new Uint8Array(this.analyserNode.fftSize);this.analyserNode.getByteTimeDomainData(i);for(let r=0;r<e.length;++r)e[r]=i[r]/128-1}const n=io(e).call(e,(i,r)=>i+r*r,0)/e.length;return Math.max(10*Math.log10(n)+100,0)/100}getAnalyserNode(){return this.analyserNode}rebuildAnalyser(){try{var e,n;(e=this.sourceNode)===null||e===void 0||e.disconnect(this.analyserNode),this.analyserNode=this.context.createAnalyser(),this.analyserNode.fftSize=2048,this.analyserNode.smoothingTimeConstant=.4,(n=this.sourceNode)===null||n===void 0||n.connect(this.analyserNode)}catch{E.warning("rebuild analyser node failed.")}}destroy(){this.updateSource(void 0)}}class bw extends Ve{get processSourceNode(){return this.sourceNode}set processedNode(e){var n;if(!this.isDestroyed&&this._processedNode!==e){try{var i;(i=this.sourceNode)===null||i===void 0||i.disconnect(this.outputNode)}catch{}(n=this._processedNode)===null||n===void 0||n.disconnect(),this._processedNode=e,this.connect()}}get processedNode(){return this._processedNode}constructor(){super(),W(this,"outputNode",void 0),W(this,"outputTrack",void 0),W(this,"isPlayed",!1),W(this,"sourceNode",void 0),W(this,"context",void 0),W(this,"audioBufferNode",void 0),W(this,"destNode",void 0),W(this,"audioOutputLevel",0),W(this,"volumeLevelAnalyser",void 0),W(this,"_processedNode",void 0),W(this,"playNode",void 0),W(this,"isDestroyed",!1),W(this,"onNoAudioInput",void 0),W(this,"isNoAudioInput",!1),W(this,"_noAudioInputCount",0),this.context=Ad(),this.playNode=this.context.destination,this.outputNode=this.context.createGain(),ec(this.outputNode),this.volumeLevelAnalyser=new Iw}startGetAudioBuffer(e){this.audioBufferNode||(this.audioBufferNode=this.context.createScriptProcessor(e),this.outputNode.connect(this.audioBufferNode),this.audioBufferNode.connect(this.context.destination),this.audioBufferNode.onaudioprocess=n=>{this.emit(tr.ON_AUDIO_BUFFER,function(i){for(let r=0;r<i.outputBuffer.numberOfChannels;r+=1){const o=i.outputBuffer.getChannelData(r);for(let s=0;s<o.length;s+=1)o[s]=0}return i.inputBuffer}(n))})}stopGetAudioBuffer(){this.audioBufferNode&&(this.audioBufferNode.onaudioprocess=null,this.outputNode.disconnect(this.audioBufferNode),this.audioBufferNode=void 0)}createOutputTrack(){if(!zt().webAudioMediaStreamDest)throw new G(b.NOT_SUPPORTED,"your browser is not support audio processor");return this.destNode&&this.outputTrack||(this.destNode=this.context.createMediaStreamDestination(),this.outputNode.connect(this.destNode),this.outputTrack=this.destNode.stream.getAudioTracks()[0]),this.outputTrack}play(e){this.context.state!=="running"&&kp(()=>{Ee.emit("autoplay-failed")}),this.isPlayed=!0,this.playNode=e||this.context.destination,this.outputNode.connect(this.playNode)}stop(){if(this.isPlayed)try{this.outputNode.disconnect(this.playNode)}catch{}this.isPlayed=!1}getAccurateVolumeLevel(){return this.volumeLevelAnalyser.getVolumeLevel()}async checkHasAudioInput(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:0;if(e>5)return this.isNoAudioInput=!0,this.onNoAudioInput&&this.onNoAudioInput(),!1;Qn()||Lr()?this.context.state==="suspended"&&this.context.resume():this.context.state!=="running"&&this.context.resume();const n=this.volumeLevelAnalyser.getAnalyserNode();let i;n.getFloatTimeDomainData?(i=new Float32Array(n.fftSize),n.getFloatTimeDomainData(i)):(i=new Uint8Array(n.fftSize),n.getByteTimeDomainData(i));let r=!1;for(let o=0;o<i.length;o++)i[o]!==0&&(r=!0);return r?(this.isNoAudioInput=!1,!0):(await wn(200),await this.checkHasAudioInput(e?e+1:1)&&r)}getAudioVolume(){return this.outputNode.gain.value}setVolume(e){this.outputNode.gain.setValueAtTime(e,this.context.currentTime)}destroy(){this.disconnect(),this.stop(),this.isDestroyed=!0,this.onNoAudioInput=void 0}disconnect(){var e,n;(e=this.processedNode)===null||e===void 0||e.disconnect(),(n=this.sourceNode)===null||n===void 0||n.disconnect(),this.outputNode&&this.outputNode.disconnect()}connect(){var e;this.processedNode?(e=this.processedNode)===null||e===void 0||e.connect(this.outputNode):this.sourceNode&&this.sourceNode.connect(this.outputNode),this.volumeLevelAnalyser.updateSource(this.outputNode)}}class Aw extends bw{get isFreeze(){return!1}constructor(e,n,i){var r;if(super(),W(this,"sourceNode",void 0),W(this,"track",void 0),W(this,"clonedTrack",void 0),W(this,"audioElement",void 0),W(this,"isCurrentTrackCloned",!1),W(this,"isRemoteTrack",!1),W(this,"originVolumeLevelAnalyser",void 0),W(this,"rebuildWebAudio",async()=>{if(E.debug("ready to rebuild web audio, state:",this.context.state),this.isNoAudioInput&&await this.checkHasAudioInput(),!this.isNoAudioInput||this.isDestroyed)return document.body.removeEventListener("click",this.rebuildWebAudio,!0),void E.debug("rebuild web audio success, current volume status",this.getAccurateVolumeLevel());this.context.resume().then(()=>E.info("resume success")),E.debug("rebuild web audio because of ios 12 bugs"),this.disconnect();const a=this.track;this.track=this.track.clone(),this.isCurrentTrackCloned?a.stop():this.isCurrentTrackCloned=!0;const c=new MediaStream([this.track]);this.sourceNode=this.context.createMediaStreamSource(c),ec(this.sourceNode),this.volumeLevelAnalyser.rebuildAnalyser();const d=this.outputNode.gain.value;this.outputNode=this.context.createGain(),this.outputNode.gain.setValueAtTime(d,this.context.currentTime),ec(this.outputNode),this.emit(tr.UPDATE_SOURCE),this.connect(),this.audioElement.srcObject=c,this.isPlayed&&this.play(this.playNode),this.checkHasAudioInput()}),e.kind!=="audio")throw new G(b.UNEXPECTED_ERROR);this.track=e;const o=new MediaStream([this.track]);if(this.isRemoteTrack=!!n,this.sourceNode=this.context.createMediaStreamSource(o),ec(this.sourceNode),i){const a=i.clone();a.enabled=!0,this.clonedTrack=a,E.debug("create an unmuted track ".concat(a.id," from the original track ").concat(i.id," to get the volume"));const c=this.context.createMediaStreamSource(new MediaStream([a]));ec(c),this.originVolumeLevelAnalyser=new Iw,this.originVolumeLevelAnalyser.updateSource(c)}this.connect(),this.audioElement=document.createElement("audio"),this.audioElement.srcObject=o;const s=Zt();n&&s.os===bn.IOS&&Number((r=s.osVersion)===null||r===void 0?void 0:r.split(".")[0])<15&&(Ee.on(jn.STATE_CHANGE,()=>{this.context.state==="suspended"?document.body.addEventListener("click",this.rebuildWebAudio,!0):this.context.state==="running"&&this.rebuildWebAudio()}),this.checkHasAudioInput().then(a=>{a||document.body.addEventListener("click",this.rebuildWebAudio,!0)}))}updateTrack(e){this.sourceNode.disconnect(),this.track=e,this.isCurrentTrackCloned=!1;const n=new MediaStream([e]);this.sourceNode=this.context.createMediaStreamSource(n),ec(this.sourceNode),this.processedNode||this.sourceNode.connect(this.outputNode),this.emit(tr.UPDATE_SOURCE),this.audioElement.srcObject=n}destroy(){var e;this.audioElement.srcObject=null,this.audioElement.remove(),Ee.off("state-change",this.rebuildWebAudio),(e=this.originVolumeLevelAnalyser)===null||e===void 0||e.destroy(),this.clonedTrack=void 0,super.destroy()}createMediaStreamSourceNode(e){return this.context.createMediaStreamSource(new MediaStream([e]))}updateOriginTrack(e){const n=e.clone();n.enabled=!0,this.clonedTrack&&(this.clonedTrack.stop(),this.clonedTrack=n),E.debug("create an unmuted track ".concat(n.id," from the original track ").concat(e.id," to get the volume"));const i=this.context.createMediaStreamSource(new MediaStream([n]));ec(i),this.originVolumeLevelAnalyser&&this.originVolumeLevelAnalyser.updateSource(i)}getOriginVolumeLevel(){return this.originVolumeLevelAnalyser?this.originVolumeLevelAnalyser.getVolumeLevel():this.getAccurateVolumeLevel()}}async function ww(t,e,n){const i=(o,s)=>o?typeof o!="number"?o.max||o.exact||o.ideal||o.min||s:o:s,r={audio:!!n&&{mandatory:{chromeMediaSource:"desktop"}},video:{mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:t,maxHeight:i(e.height,1080),maxWidth:i(e.width,1920)}}};return e.frameRate&&typeof e.frameRate!="number"?(r.video.mandatory.maxFrameRate=e.frameRate.max,r.video.mandatory.minFrameRate=e.frameRate.min):typeof e.frameRate=="number"&&(r.video.mandatory.maxFrameRate=e.frameRate),await navigator.mediaDevices.getUserMedia(r)}async function OW(t,e){const n=await Ow(t.mediaSource),{sourceId:i,audio:r}=await function(o){let s=arguments.length>1&&arguments[1]!==void 0&&arguments[1];return new ot((a,c)=>{const d=document.createElement("div");d.innerText="share screen",d.setAttribute("style","text-align: center; height: 25px; line-height: 25px; border-radius: 4px 4px 0 0; background: #D4D2D4; border-bottom:  solid 1px #B9B8B9;");const u=document.createElement("div");u.setAttribute("style","width: 100%; height: 500px; padding: 15px 25px ; box-sizing: border-box;");const l=document.createElement("div");l.innerText="Agora Web Screensharing wants to share the contents of your screen with webdemo.agorabeckon.com. Choose what you'd like to share.",l.setAttribute("style","height: 12%;");const p=document.createElement("div");p.setAttribute("style","width: 100%; height: 80%; background: #FFF; border:  solid 1px #CBCBCB; display: flex; flex-wrap: wrap; justify-content: space-around; overflow-y: scroll; padding: 0 15px; box-sizing: border-box;");const f=document.createElement("div");f.setAttribute("style","display: flex; justify-content: space-between; padding: 16px 0;");const C=document.createElement("button");C.innerHTML="cancel",C.setAttribute("style","width: 85px;"),C.onclick=()=>{document.body.removeChild(y);const A=new Error("NotAllowedError");A.name="NotAllowedError",c(A)};let m=s;const g=document.createElement("div");if(s){const A=document.createElement("input");A.setAttribute("type","checkbox");const k=document.createElement("span");A.setAttribute("style","margin-right: 6px;"),k.innerText="Share audio",A.checked=m,A.onchange=()=>{m=A.checked},g.appendChild(A),g.appendChild(k)}f.appendChild(g),f.appendChild(C),u.appendChild(l),u.appendChild(p),u.appendChild(f);const y=document.createElement("div");y.setAttribute("style","position: fixed; z-index: 99999999; top: 50%; left: 50%; width: 620px; height: 525px; background: #ECECEC; border-radius: 4px; -webkit-transform: translate(-50%,-50%); transform: translate(-50%,-50%);"),y.appendChild(d),y.appendChild(u),document.body.appendChild(y),o.map(A=>{if(A.id){const k=document.createElement("div");k.setAttribute("style","width: 30%; height: 160px; padding: 20px 0; text-align: center;box-sizing: content-box;");let M=A.thumbnail;try{const{width:V}=M.getSize();V>1920&&(M=M.resize({width:1920}))}catch(V){throw V&&V.message.startsWith("Illegal invocation")&&console.error("Operate thumbnail error, please try to set contextIsolation: false. (https://github.com/electron/electron/issues/34953)"),V}k.innerHTML='<div style="height: 120px; display: table-cell; vertical-align: middle;"><img style="width: 100%; background: #333333; box-shadow: 1px 1px 1px 1px rgba(0, 0, 0, 0.2);" src='+M.toDataURL()+' /></div><span style="	height: 40px; line-height: 40px; display: inline-block; width: 70%; word-break: keep-all; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">'+A.name.replace(/[\u00A0-\u9999<>\&]/g,function(V){return"&#"+V.charCodeAt(0)+";"})+"</span>",k.onclick=()=>{document.body.removeChild(y),a({sourceId:A.id,audio:m})},p.appendChild(k)}})})}(n,e);return await ww(i,t,r)}async function Ow(t){let e=["window","screen"];t!=="application"&&t!=="window"||(e=["window"]),t==="screen"&&(e=["screen"]);const n=YI();if(!n)throw console.error("failed to fetch electron, please mount it to window"),new G(b.ELECTRON_IS_NULL);let i=null;try{var r;i=((r=n.desktopCapturer)===null||r===void 0?void 0:r.getSources({types:e}))||n.ipcRenderer.invoke("DESKTOP_CAPTURER_GET_SOURCES",{types:e})}catch{i=null}i&&i.then||(i=new ot((o,s)=>{n.desktopCapturer.getSources({types:e},(a,c)=>{a?s(a):o(c)})}));try{return await i}catch(o){throw new G(b.ELECTRON_DESKTOP_CAPTURER_GET_SOURCES_ERROR,o.toString())}}const TT=new kn("safari");let Nw=!1,Dw=!1;async function ir(t,e){let n=0,i=null;for(;n<2;)try{i=await NW(t,e,n>0);break}catch(r){if(r instanceof G)throw E.error("[".concat(e,"] ").concat(r.toString())),r;const o=vf(r.name||r.code||r,r.message);if(o.code===b.MEDIA_OPTION_INVALID){E.debug("[".concat(e,"] detect media option invalid, retry")),n+=1,await wn(500);continue}throw E.error("[".concat(e,"] ").concat(o.toString())),o}if(!i)throw new G(b.UNEXPECTED_ERROR,"can not find stream after getUserMedia");return i}async function NW(t,e,n){if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)throw new G(b.NOT_SUPPORTED,"can not find getUserMedia");n&&(t.video&&(delete t.video.width,delete t.video.height),t.screen&&(delete t.screen.width,delete t.screen.height));const i=zt(),r=new MediaStream;if(t.audioSource&&r.addTrack(t.audioSource),t.videoSource&&r.addTrack(t.videoSource),!t.audio&&!t.video&&!t.screen)return E.debug("Using Video Source/ Audio Source"),r;if(t.screen)if(YI())t.screen.sourceId?wd(r,await ww(t.screen.sourceId,t.screen,t.screenAudio)):wd(r,await OW(t.screen,t.screenAudio));else if(Gs()&&t.screen.extensionId&&t.screen.mandatory){if(!i.getStreamFromExtension)throw new G(b.NOT_SUPPORTED,"This browser does not support screen sharing");E.debug("[".concat(e,'] Screen access on chrome stable, looking for extension"'));const p=await(s=t.screen.extensionId,a=e,new ot((f,C)=>{try{chrome.runtime.sendMessage(s,{getStream:!0},m=>{if(!m||!m.streamId)return E.error("[".concat(a,"] No response from Chrome Plugin. Plugin not installed properly"),m),void C(new G(b.CHROME_PLUGIN_NO_RESPONSE,"No response from Chrome Plugin. Plugin not installed properly"));f(m.streamId)})}catch(m){E.error("[".concat(a,"] AgoraRTC screensharing plugin is not accessible(").concat(s,")"),m.toString()),C(new G(b.CHROME_PLUGIN_NOT_INSTALL))}}));t.screen.mandatory.chromeMediaSourceId=p,wd(r,await navigator.mediaDevices.getUserMedia({video:{mandatory:t.screen.mandatory}}))}else if(i.getDisplayMedia){var o;t.screen.mediaSource&&Tw(t.screen.mediaSource);const p={width:t.screen.width,height:t.screen.height,frameRate:t.screen.frameRate,displaySurface:(o=t.screen.displaySurface)!==null&&o!==void 0?o:t.screen.mediaSource==="screen"?"monitor":t.screen.mediaSource},{selfBrowserSurface:f,surfaceSwitching:C,systemAudio:m}=t.screen,g={selfBrowserSurface:f,surfaceSwitching:C,systemAudio:m};!f&&delete g.selfBrowserSurface,!C&&delete g.surfaceSwitching,!m&&delete g.systemAudio,E.debug("[".concat(e,"] getDisplayMedia:"),JSON.stringify({video:p,audio:!!t.screenAudio,controls:g})),wd(r,await navigator.mediaDevices.getDisplayMedia(Fe({video:p,audio:!!t.screenAudio},g)))}else{if(!ye())throw E.error("[".concat(e,"] This browser does not support screenSharing")),new G(b.NOT_SUPPORTED,"This browser does not support screen sharing");{t.screen.mediaSource&&Tw(t.screen.mediaSource);const p={video:{mediaSource:t.screen.mediaSource,width:t.screen.width,height:t.screen.height,frameRate:t.screen.frameRate}};E.debug("[".concat(e,"] getUserMedia: ").concat(JSON.stringify(p))),wd(r,await navigator.mediaDevices.getUserMedia(p))}}var s,a;if(!t.video&&!t.audio)return r;let c={video:t.video,audio:t.audio},d=N("MEDIA_DEVICE_CONSTRAINTS");if(d)try{typeof d=="string"&&(d=JSON.parse(d)),c=Ym(c,d)}catch{}E.debug("[".concat(e,"] GetUserMedia"),JSON.stringify(c)),Zt();let u,l=null;(An()||Qn()||Dp())&&(l=await TT.lock());try{u=await navigator.mediaDevices.getUserMedia(c)}catch(p){throw l&&l(),p}return c.audio&&(Nw=!0),c.video&&(Dw=!0),wd(r,u),l&&l(),r}function vf(t,e){switch(t){case"Starting video failed":case"OverconstrainedError":case"TrackStartError":return new G(b.MEDIA_OPTION_INVALID,"".concat(t,": ").concat(e));case"NotFoundError":case"DevicesNotFoundError":return new G(b.DEVICE_NOT_FOUND,"".concat(t,": ").concat(e));case"NotSupportedError":return new G(b.NOT_SUPPORTED,"".concat(t,": ").concat(e));case"NotReadableError":return new G(b.NOT_READABLE,"".concat(t,": ").concat(e));case"InvalidStateError":case"NotAllowedError":case"PERMISSION_DENIED":case"PermissionDeniedError":return new G(b.PERMISSION_DENIED,"".concat(t,": ").concat(e));case"ConstraintNotSatisfiedError":return new G(b.CONSTRAINT_NOT_SATISFIED,"".concat(t,": ").concat(e));default:return E.error("getUserMedia unexpected error",t),new G(b.UNEXPECTED_ERROR,"".concat(t,": ").concat(e))}}function wd(t,e){const n=t.getVideoTracks()[0],i=t.getAudioTracks()[0],r=e.getVideoTracks()[0],o=e.getAudioTracks()[0];o&&(i&&t.removeTrack(i),t.addTrack(o)),r&&(n&&t.removeTrack(n),t.addTrack(r))}const rr=new class extends Ve{get state(){return this._state}set state(t){t!==this._state&&(this.emit(tc.STATE_CHANGE,t),this._state=t)}constructor(){super(),W(this,"_state",Al.IDLE),W(this,"isAccessMicrophonePermission",!1),W(this,"isAccessCameraPermission",!1),W(this,"lastAccessMicrophonePermission",!1),W(this,"lastAccessCameraPermission",!1),W(this,"checkdeviceMatched",!1),W(this,"deviceInfoMap",new Map),this.init().then(()=>{navigator.mediaDevices.addEventListener&&navigator.mediaDevices.addEventListener("devicechange",this.updateDevicesInfo.bind(this)),window.setInterval(()=>{(N("ENUMERATE_DEVICES_INTERVAL")||(Pp()||Np()===bn.HARMONY_OS)&&Ws())&&this.updateDevicesInfo()},N("ENUMERATE_DEVICES_INTERVAL_TIME"))}).catch(t=>E.error(t.toString()))}async enumerateDevices(t,e){let n=arguments.length>2&&arguments[2]!==void 0&&arguments[2];if(!navigator.mediaDevices||!navigator.mediaDevices.enumerateDevices)return new G(b.NOT_SUPPORTED,"enumerateDevices() not supported.").throw();const i=await navigator.mediaDevices.enumerateDevices(),r=this.checkMediaDeviceInfoIsOk(i);let o=!this.isAccessMicrophonePermission&&t,s=!this.isAccessCameraPermission&&e;r.audio&&(o=!1),r.video&&(s=!1);let a=null,c=null,d=null;if(!n&&(o||s)){if(TT.isLocked&&(E.debug("[device manager] wait GUM lock"),(await TT.lock())(),E.debug("[device manager] GUM unlock")),Nw&&(o=!1,this.isAccessMicrophonePermission=!0),Dw&&(s=!1,this.isAccessCameraPermission=!0),E.debug("[device manager] check media device permissions",t,e,o,s),o&&s){try{d=await navigator.mediaDevices.getUserMedia({audio:!0,video:!0})}catch(u){const l=vf(u.name||u.code||u,u.message);if(l.code===b.PERMISSION_DENIED)throw l;E.warning("getUserMedia failed in getDevices",l)}this.isAccessCameraPermission=!0,this.isAccessMicrophonePermission=!0}else if(o){try{a=await navigator.mediaDevices.getUserMedia({audio:t})}catch(u){const l=vf(u.name||u.code||u,u.message);if(l.code===b.PERMISSION_DENIED)throw l;E.warning("getUserMedia failed in getDevices",l)}this.isAccessMicrophonePermission=!0}else if(s){try{c=await navigator.mediaDevices.getUserMedia({video:e})}catch(u){const l=vf(u.name||u.code||u,u.message);if(l.code===b.PERMISSION_DENIED)throw l;E.warning("getUserMedia failed in getDevices",l)}this.isAccessCameraPermission=!0}E.debug("[device manager] mic permission",t,"cam permission",e)}try{const u=await navigator.mediaDevices.enumerateDevices();return a&&a.getTracks().forEach(l=>l.stop()),c&&c.getTracks().forEach(l=>l.stop()),d&&d.getTracks().forEach(l=>l.stop()),a=null,c=null,d=null,u}catch(u){return a&&a.getTracks().forEach(l=>l.stop()),c&&c.getTracks().forEach(l=>l.stop()),d&&d.getTracks().forEach(l=>l.stop()),a=null,c=null,d=null,new G(b.ENUMERATE_DEVICES_FAILED,u.toString()).throw()}}async getRecordingDevices(){let t=arguments.length>0&&arguments[0]!==void 0&&arguments[0];return(await this.enumerateDevices(!0,!1,t)).filter(e=>e.kind==="audioinput")}async getCamerasDevices(){let t=arguments.length>0&&arguments[0]!==void 0&&arguments[0];return(await this.enumerateDevices(!1,!0,t)).filter(e=>e.kind==="videoinput")}async getSpeakers(){let t=arguments.length>0&&arguments[0]!==void 0&&arguments[0];return(await this.enumerateDevices(!0,!1,t)).filter(e=>e.kind==="audiooutput")}searchDeviceIdByName(t){let e=null;return this.deviceInfoMap.forEach(n=>{n.device.label===t&&(e=n.device.deviceId)}),e}async getDeviceById(t){const e=(await this.enumerateDevices(!0,!0,!0)).find(n=>n.deviceId===t);if(!e)throw new G(b.DEVICE_NOT_FOUND,"deviceId: ".concat(t));return e}async init(){this.state=Al.INITING;try{await this.updateDevicesInfo(),this.state=Al.INITEND}catch(t){throw E.warning("Device Detection functionality cannot start properly.",t.toString()),this.state=Al.IDLE,(typeof isSecureContext=="boolean"?isSecureContext:location.protocol==="https:"||location.protocol==="file:"||location.hostname==="localhost"||location.hostname==="127.0.0.1"||location.hostname==="::1")||new G(b.WEB_SECURITY_RESTRICT,"Your context is limited by web security, please try using https protocol or localhost.").throw(),t}}async updateDevicesInfo(){const t=await this.enumerateDevices(!0,!0,!0),e=Date.now(),n=[];if(t[0]&&t[0].label&&this.checkdeviceMatched===!1){this.checkdeviceMatched=!0;const r=t.find(s=>s.kind==="audioinput"&&s.deviceId==="default"),o=t.find(s=>s.kind==="audiooutput"&&s.deviceId==="default");r&&o?o.groupId===r.groupId?E.debug("[device-check] default input ".concat(r.label," and output ").concat(o.label," is the same group")):E.warning("[device-check] default input ".concat(r.label," and output ").concat(o.label," is not the same group")):E.debug("[device-check] default input or output not found")}const i=this.checkMediaDeviceInfoIsOk(t);if(t.forEach(r=>{if(!r.deviceId)return;const o=this.deviceInfoMap.get("".concat(r.kind,"_").concat(r.deviceId));if((o?o.state:"INACTIVE")!=="ACTIVE"){const s={initAt:e,updateAt:e,device:r,state:"ACTIVE"};this.deviceInfoMap.set("".concat(r.kind,"_").concat(r.deviceId),s),n.push(s)}o&&(o.updateAt=e)}),this.deviceInfoMap.forEach((r,o)=>{r.state==="ACTIVE"&&r.updateAt!==e&&(r.state="INACTIVE",n.push(r))}),this.state!==Al.INITEND)return i.audio&&(this.lastAccessMicrophonePermission=!0,this.isAccessMicrophonePermission=!0),void(i.video&&(this.lastAccessCameraPermission=!0,this.isAccessCameraPermission=!0));n.forEach(r=>{switch(r.device.kind){case"audioinput":this.lastAccessMicrophonePermission&&this.isAccessMicrophonePermission&&this.emit(tc.RECORDING_DEVICE_CHANGED,r);break;case"videoinput":this.lastAccessCameraPermission&&this.isAccessCameraPermission&&this.emit(tc.CAMERA_DEVICE_CHANGED,r);break;case"audiooutput":this.lastAccessMicrophonePermission&&this.isAccessMicrophonePermission&&this.emit(tc.PLAYOUT_DEVICE_CHANGED,r)}}),i.audio&&(this.lastAccessMicrophonePermission=!0,this.isAccessMicrophonePermission=!0),i.video&&(this.lastAccessCameraPermission=!0,this.isAccessCameraPermission=!0)}checkMediaDeviceInfoIsOk(t){const e=t.filter(r=>r.kind==="audioinput"),n=t.filter(r=>r.kind==="videoinput"),i={audio:!1,video:!1};for(const r of e)if(r.label&&r.deviceId){i.audio=!0;break}for(const r of n)if(r.label&&r.deviceId){i.video=!0;break}return i}};let ST=!1;const or=new class extends Ve{constructor(){super(...arguments),W(this,"onAutoplayFailed",void 0),W(this,"onAudioAutoplayFailed",void 0)}};function Pw(){if(Zt(),!ST){const t=e=>{e.preventDefault(),ST=!1,qu()?document.body.removeEventListener("click",t,!0):(document.body.removeEventListener("touchstart",t,!0),document.body.removeEventListener("mousedown",t,!0))};ST=!0,qu()?document.body.addEventListener("click",t,!0):(document.body.addEventListener("touchstart",t,!0),document.body.addEventListener("mousedown",t,!0)),E.info("detect media autoplay failed, document: https://docs.agora.io/cn/Voice/autoplay_policy_web_ng?platform=Web"),or.onAutoplayFailed?or.onAutoplayFailed():or.onAudioAutoplayFailed?E.warning(`AgoraRTC.onAudioAutoplayFailed has been deprecated in favor of AgoraRTC.onAutoplayFailed.

  Please refer to the Agora document to migrate the newer API, https://docs.agora.io/en/Voice/autoplay_policy_web_ng?platform=Web .`):E.warning(`We have detected a media autoplay failed event, and found out that you haven't implemented AgoraRTC.onAutoplayFailed callback yet.

  It will cause audio/video element not playing automatically on some browsers without user interaction, possibly hurting user experiences.

  Please refer to the Agora document to properly handle autoplay failed event, https://docs.agora.io/en/Voice/autoplay_policy_web_ng?platform=Web .`),or.emit("autoplay-failed")}}function Lw(t,e,n,i){if(!t)return;const r=Et.getBaseInfoBySessionId(t);if(!r)return;const o=r.info,s=Date.now(),a=Fe(Fe({},o),{},{vid:o.vid===void 0?0:Number(o.vid),lts:s,elapse:s-r.startTime,cbRegistered:or.onAutoplayFailed||or.onAudioAutoplayFailed?1:-1,errorMsg:n,mediaType:e,trackId:i,extend:void 0});Et.send({type:He.AUTOPLAY_FAILED,data:a},!0)}const DW=["play","playing","loadeddata","canplay","pause","stalled","suspend","waiting","abort","emptied","ended","error"],bi=new class{constructor(){W(this,"onAutoplayFailed",void 0),W(this,"elementMap",new Map),W(this,"elementStateMap",new Map),W(this,"elementsNeedToResume",[]),W(this,"sinkIdMap",new Map),W(this,"autoResumeAfterInterruption",t=>{Array.from(this.elementMap.entries()).forEach(e=>{let[n,i]=e;const r=this.elementStateMap.get(n),o=i.srcObject.getAudioTracks()[0],s=o&&o.readyState;if(E.debug("resume after interrupted, ele: ".concat(r," audio: ").concat(s," ").concat(t)),s==="live"){if(t)return i.pause(),void i.play();if(Ee.curState==="running")return Qc()?(i.pause(),void i.play()):void(r&&r==="paused"&&i.play())}})}),W(this,"autoResumeAfterInterruptionOnIOS15_16",()=>{Array.from(this.elementMap.entries()).forEach(t=>{let[e,n]=t;const i=n.srcObject.getAudioTracks()[0];i&&i.readyState==="live"&&(E.debug("auto resume after interruption inside autoResumeAfterInterruptionOnIOS15"),n.pause(),n.play())})}),this.autoResumeAudioElement(),Ee.on(jn.IOS_INTERRUPTION_END,this.autoResumeAfterInterruption),Ee.on(jn.IOS_15_16_INTERRUPTION_END,this.autoResumeAfterInterruptionOnIOS15_16),Ee.on(jn.STATE_CHANGE,()=>{Qn()&&Ee.prevState==="suspended"&&Ee.curState==="running"&&this.autoResumeAfterInterruption()})}async setSinkID(t,e){const n=this.elementMap.get(t);if(this.sinkIdMap.set(t,e),n)try{await n.setSinkId(e)}catch(i){throw new G(b.PERMISSION_DENIED,"can not set sink id: "+i.toString())}}play(t,e,n,i){if(this.elementMap.has(e))return;const r=document.createElement("audio");r.autoplay=!0,r.srcObject=new MediaStream([t]),this.bindAudioElementEvents(e,r),this.elementMap.set(e,r),this.elementStateMap.set(e,di.INIT),this.setVolume(e,n);const o=this.sinkIdMap.get(e);if(o)try{r.setSinkId(o).catch(a=>{E.warning("[".concat(e,"] set sink id failed"),a.toString())})}catch(a){E.warning("[".concat(e,"] set sink id failed"),a.toString())}const s=r.play();s&&s.then&&s.catch(a=>{i&&Lw(i,"audio",a.message,e),E.warning("audio element play warning",a.toString()),this.elementMap.has(e)&&a.name==="NotAllowedError"&&(E.warning("detected audio element autoplay failed"),this.elementsNeedToResume.push(r),kp(()=>{this.onAutoplayFailed&&this.onAutoplayFailed(),Pw()}))})}updateTrack(t,e){const n=this.elementMap.get(t);n&&(n.srcObject=new MediaStream([e]))}isPlaying(t){return this.elementMap.has(t)&&this.elementStateMap.get(t)==="playing"}setVolume(t,e){const n=this.elementMap.get(t);n&&(e=Math.max(0,Math.min(100,e)),n.volume=e/100)}stop(t){const e=this.elementMap.get(t);if(this.sinkIdMap.delete(t),!e)return;const n=this.elementsNeedToResume.indexOf(e);this.elementsNeedToResume.splice(n,1),e.srcObject=null,e.remove(),this.elementMap.delete(t),this.elementStateMap.delete(t)}bindAudioElementEvents(t,e){DW.forEach(n=>{e.addEventListener(n,i=>{const r=this.elementStateMap.get(t),o=i.type==="pause"?"paused":i.type;if(E.debug("[".concat(t,"] audio-element-status change ").concat(r," => ").concat(o)),i.type==="error"){const s=e==null?void 0:e.error;s&&E.error("[".concat(t,"] media error, code: ").concat(s.code,", message: ").concat(s.message))}this.elementStateMap.set(t,o)})})}getPlayerState(t){return this.elementStateMap.get(t)||"uninit"}autoResumeAudioElement(){const t=()=>{this.elementsNeedToResume.forEach(e=>{e.play().then(n=>{E.debug("Auto resume audio element success")}).catch(n=>{E.warning("Auto resume audio element failed!",n)})}),this.elementsNeedToResume=[]};new ot(e=>{document.body?e():window.addEventListener("load",()=>e())}).then(()=>{qu()?document.body.addEventListener("click",t,!0):(document.body.addEventListener("touchstart",t,!0),document.body.addEventListener("mousedown",t,!0))})}};function on(){return function(t,e,n){const i=n.value;return typeof i=="function"&&(n.value=function(){this._isClosed&&new G(b.INVALID_OPERATION,"[".concat(this.getTrackId(),"] cannot operate a closed track")).print("warning",E);for(var r=arguments.length,o=new Array(r),s=0;s<r;s++)o[s]=arguments[s];const a=i.apply(this,o);return a instanceof ot?new ot((c,d)=>{a.then(c).catch(d)}):a}),n}}class kw extends Ve{constructor(e){super(),W(this,"name","VideoProcessorDestination"),W(this,"ID","0"),W(this,"_source",void 0),W(this,"videoContext",void 0),W(this,"inputTrack",void 0),this.videoContext=e}get kind(){return"video"}get enabled(){return!0}pipe(){throw new G(b.NOT_SUPPORTED,"VideoProcessor cannot pipe to any other Processor")}unpipe(){throw new G(b.NOT_SUPPORTED,"VideoProcessor cannot unpipe to any other Processor")}enable(){}disable(){}updateInput(e){if(e.context!==this.videoContext)throw new Error(`ProcessorContext passed to VideoTrack.processorDestination doesn't match it's belonging VideoTrack's context.
Probably you are making pipeline like this:
videoTrack1.pipe(processor).pipe(videoTrack2.processorDestination).`);e.track&&e.track!==this.inputTrack&&(this.videoContext.chained=!0,this.inputTrack=e.track,this.emit(Si.ON_TRACK,e.track))}reset(){this.inputTrack=void 0,this.videoContext.chained=!1,this.emit(Si.ON_TRACK,void 0)}}class Mw extends Ve{set chained(e){this._chained=e}get chained(){return this._chained}constructor(e,n){super(),W(this,"constraintsMap",new Map),W(this,"statsRegistry",[]),W(this,"usageRegistry",[]),W(this,"trackId",void 0),W(this,"direction",void 0),W(this,"_chained",!1),this.trackId=e,this.direction=n}async getConstraints(){return await En(this,er.REQUEST_CONSTRAINTS)}async requestApplyConstraints(e,n){var i;return E.info("processor ".concat(n.name," requestApplyConstraints for ").concat(this.trackId)),e&&this.constraintsMap.set(n,e),Ie(this,er.REQUEST_UPDATE_CONSTRAINTS,Array.from(ao(i=this.constraintsMap).call(i)))}async requestRevertConstraints(e){var n;if(this.constraintsMap.has(e))return E.info("processor ".concat(e.name," requestRevertConstraints for ").concat(this.trackId)),this.constraintsMap.delete(e),Ie(this,er.REQUEST_UPDATE_CONSTRAINTS,Array.from(ao(n=this.constraintsMap).call(n)))}registerStats(e,n,i){this.statsRegistry.find(r=>r.processorID===e.ID&&r.processorName===e.name&&r.type===n)||this.statsRegistry.push({processorName:e.name,processorID:e.ID,type:n,cb:i})}unregisterStats(e,n){const i=this.statsRegistry.findIndex(r=>r.processorID===e.ID&&r.processorName===e.name&&r.type===n);i!==-1&&this.statsRegistry.splice(i,1)}gatherStats(){const e=[];for(const{processorID:n,processorName:i,type:r,cb:o}of this.statsRegistry)try{const s=o();e.push({processorID:n,processorName:i,type:r,stats:s})}catch(s){E.error(new G(b.UNEXPECTED_ERROR,s.message))}return e}registerUsage(e,n){this.usageRegistry.find(i=>i.processorID===e.ID&&i.processorName===e.name)||this.usageRegistry.push({processorID:e.ID,processorName:e.name,cb:n})}unregisterUsage(e){const n=this.usageRegistry.findIndex(i=>i.processorID===e.ID&&i.processorName===e.name);n!==-1&&this.usageRegistry.splice(n,1)}async gatherUsage(){const e=[];if(!this.chained)return[];for(const{cb:n}of this.usageRegistry)try{let i=n();i instanceof ot&&(i=await i),e.push(Fe(Fe({},i),{},{direction:this.direction}))}catch(i){E.error("gather extension usage error",i)}return e}getDirection(){return this.direction}}class Uw extends Ve{constructor(e){super(),W(this,"name","AudioProcessorDestination"),W(this,"ID","0"),W(this,"inputTrack",void 0),W(this,"inputNode",void 0),W(this,"audioProcessorContext",void 0),W(this,"_source",void 0),this.audioProcessorContext=e}get kind(){return"audio"}get enabled(){return!0}pipe(){throw new G(b.NOT_SUPPORTED,"AudioProcessorDestination cannot pipe to any other Processor")}unpipe(){throw new G(b.NOT_SUPPORTED,"AudioProcessor cannot unpipe to any other Processor")}enable(){}disable(){}reset(){this.inputTrack=void 0,this.inputNode=void 0,this.audioProcessorContext.chained=!1,this.emit(Si.ON_TRACK,void 0),this.emit(Si.ON_NODE,void 0)}updateInput(e){if(e.context!==this.audioProcessorContext)throw new Error(`ProcessorContext passed to AudioTrack.processorDestination doesn't match it's belonging AudioTrack's context.
        Probably you are making pipeline like this: audioTrack1.pipe(processor).pipe(audioTrack2.processorDestination).`);e.track&&this.inputTrack!==e.track&&(this.audioProcessorContext.chained=!0,this.inputTrack=e.track,this.emit(Si.ON_TRACK,this.inputTrack)),e.node&&this.inputNode!==e.node&&(this.audioProcessorContext.chained=!0,this.inputNode=e.node,this.emit(Si.ON_NODE,this.inputNode))}}class xw extends Ve{set chained(e){this._chained=e}get chained(){return this._chained}constructor(e,n,i){super(),W(this,"constraintsMap",new Map),W(this,"statsRegistry",[]),W(this,"audioContext",void 0),W(this,"trackId",void 0),W(this,"direction",void 0),W(this,"usageRegistry",[]),W(this,"_chained",!1),this.audioContext=e,this.trackId=n,this.direction=i}async getConstraints(){return En(this,er.REQUEST_CONSTRAINTS)}getAudioContext(){return this.audioContext}async requestApplyConstraints(e,n){var i;return E.info("processor ".concat(n.name," requestApplyConstraints for ").concat(this.trackId)),e&&this.constraintsMap.set(n,e),Ie(this,er.REQUEST_UPDATE_CONSTRAINTS,Array.from(ao(i=this.constraintsMap).call(i)))}async requestRevertConstraints(e){var n;if(this.constraintsMap.has(e))return this.constraintsMap.delete(e),Ie(this,er.REQUEST_UPDATE_CONSTRAINTS,Array.from(ao(n=this.constraintsMap).call(n)))}registerStats(e,n,i){this.statsRegistry.find(r=>r.processorID===e.ID&&r.processorName===e.name&&r.type===n)||this.statsRegistry.push({processorName:e.name,processorID:e.ID,type:n,cb:i})}unregisterStats(e,n){const i=this.statsRegistry.findIndex(r=>r.processorID===e.ID&&r.processorName===e.name&&r.type===n);i!==-1&&this.statsRegistry.splice(i,1)}gatherStats(){const e=[];for(const{processorID:n,processorName:i,type:r,cb:o}of this.statsRegistry)try{const s=o();e.push({processorID:n,processorName:i,type:r,stats:s})}catch(s){E.error(new G(b.UNEXPECTED_ERROR,s.message))}return e}registerUsage(e,n){this.usageRegistry.find(i=>i.processorID===e.ID&&i.processorName===e.name)||this.usageRegistry.push({processorID:e.ID,processorName:e.name,cb:n})}unregisterUsage(e){const n=this.usageRegistry.findIndex(i=>i.processorID===e.ID&&i.processorName===e.name);n!==-1&&this.usageRegistry.splice(n,1)}async gatherUsage(){const e=[];if(!this.chained)return[];for(const{cb:n}of this.usageRegistry)try{let i=n();i instanceof ot&&(i=await i),e.push(Fe(Fe({},i),{},{direction:this.direction}))}catch(i){E.error("gather extension usage error",i)}return e}getDirection(){return this.direction}}class RT extends Ve{get isPlayed(){return!0}get isFreeze(){return!1}constructor(){super(),W(this,"context",void 0),W(this,"processSourceNode",void 0),W(this,"outputTrack",void 0),W(this,"processedNode",void 0),W(this,"clonedTrack",void 0),W(this,"outputNode",void 0),this.outputNode=new PW}setVolume(){}createOutputTrack(){throw new G(b.NOT_SUPPORTED,"can not create output MediaStreamTrack when WebAudio disabled")}getOriginVolumeLevel(){return 0}getAccurateVolumeLevel(){return 0}stopGetAudioBuffer(){}startGetAudioBuffer(){}play(){}stop(){}destroy(){}updateTrack(){}updateOriginTrack(){}createMediaStreamSourceNode(){}}class PW{disconnect(){}connect(){}}function Vw(t){return new ot((e,n)=>{let i=!1;const r=document.createElement("video");r.setAttribute("autoplay",""),r.setAttribute("muted",""),r.muted=!0,r.autoplay=!0,r.setAttribute("playsinline",""),r.setAttribute("style","position: fixed; top: 0; left: 0; width: 1px; height: 1px"),document.body.appendChild(r);const o=Qn()?"canplay":"playing";r.addEventListener(o,()=>{const s=r.videoWidth,a=r.videoHeight;!s&&ye()||(i=!0,r.srcObject=null,r.remove(),e([s,a]))}),r.srcObject=new MediaStream([t]),r.play().catch(Mp),setTimeout(()=>{i||(r.srcObject=null,r.remove(),e([r.videoWidth,r.videoHeight]))},4e3)})}function yf(t){const e={};t.facingMode&&(e.facingMode=t.facingMode),t.cameraId&&(e.deviceId={exact:t.cameraId});const n=Ho(t.encoderConfig);return n.width!=null&&(e.width=n.width),n.height!=null&&(e.height=n.height),!jI()&&n.frameRate&&(e.frameRate=n.frameRate),NI()&&typeof e.frameRate=="object"&&(e.frameRate.max=60),ye()&&(e.frameRate={ideal:30,max:30}),e}function Fw(t){const e={};if(jI()||(t.AGC!==void 0&&(e.autoGainControl=t.AGC),t.AEC!==void 0&&(e.echoCancellation=t.AEC),t.ANS!==void 0&&(e.noiseSuppression=t.ANS,Gs()&&t.ANS&&(e.googHighpassFilter=t.ANS))),t.encoderConfig){const n=Rf(t.encoderConfig);e.channelCount=n.stereo?2:1,e.sampleRate=n.sampleRate,e.sampleSize=n.sampleSize}return t.microphoneId&&(e.deviceId={exact:t.microphoneId}),Pp()&&(e.sampleRate=void 0),e}const LW=t=>{const e=t._encoderConfig;if(!e)return;const{frameRate:n,width:i,height:r}=t.getMediaStreamTrackSettings();let{frameRate:o=n,width:s=i,height:a=r}=e;if(!o||!s||!a)return;s=zm(s),a=zm(a),o=zm(o);const{max:c,min:d}=function(f,C,m){const g=200*Math.pow(m/15,.6)*Math.pow(f*C/640/360,.75);return{min:Math.floor(g),max:Math.floor(4*g)}}(s,a,o),{bitrateMax:u,bitrateMin:l}=e||{};u||E.debug("calculate bitrate: [w: ".concat(s,", h: ").concat(a,", fps: ").concat(o,"] => [brMax: ").concat(u,", brMin: ").concat(l,"]"));const{maxFramerate:p}=N("ENCODER_CONFIG_LIMIT");return p&&typeof p=="number"&&(o=Math.min(o,p)),{frameRate:o,bitrateMax:u||c,bitrateMin:l||d,scaleResolutionDownBy:1,scale:0}},jw=async(t,e,n)=>await(async(i,r,o)=>{const s=function(d){const u=[];for(let l=0;l<d.length;l+=2)u.push(parseInt(d.slice(l,l+2),16));return Uint8Array.from(u)}(ob(""+r+o)).slice(0,16),a=s.slice(0,12),c=await window.crypto.subtle.importKey("raw",s,"AES-GCM",!0,["encrypt"]);return new Uint8Array(await window.crypto.subtle.encrypt({name:"AES-GCM",iv:a},c,i))})(t.buffer,e,n),CT=t=>{const e=document.createElement("canvas");return e.width=2,e.height=2,new ot((n,i)=>{e.toBlob(async r=>{if(e.remove(),r){const o=await Bw(r);n({buffer:o,width:e.width,height:e.height})}else i(new G(b.CONVERTING_VIDEO_FRAME_TO_BLOB_FAILED))},t,1)})},Bw=async t=>{const e=await t.arrayBuffer();return new Uint8Array(e)};var Gw,Ww,Hw,Kw,qw,Yw,zw,Jw,Xw,Qw,Zw,$w,tO,eO,nO,iO,rO,oO,Ke,sO,aO,cO,dO,uO,lO,qo,hO,pO,fO,_O,EO,mO,gO,TO,SO,RO,CO,vO,yO,zn;let Qe=(Gw=Ct({argsMap:(t,e)=>[t.getTrackId(),e],throttleTime:300}),Ww=Ct({argsMap:(t,e)=>[t.getTrackId(),e]}),Hw=on(),Kw=td("LocalAudioTrack","_enabledMutex"),qw=Ct({argsMap:(t,e)=>[t.getTrackId(),e]}),Yw=on(),zw=td("LocalAudioTrack","_enabledMutex"),Jw=Ct({argsMap:(t,e)=>[t.getTrackId(),e]}),Xw=on(),Qw=on(),Zw=on(),$w=Ct({argsMap:t=>[t.getTrackId()]}),tO=on(),eO=Ct({argsMap:t=>[t.getTrackId()]}),nO=on(),iO=Ct({argsMap:t=>[t.getTrackId()]}),rO=Ct({argsMap:(t,e)=>[t.getTrackId(),e.name]}),oO=Ct({argsMap:t=>[t.getTrackId()]}),Jt((Ke=class extends bd{get _source(){return this.initWebAudio()}set _source(t){this._trackSource=t}get processorContext(){return this._processorContext||(this._processorContext=this.initProcessor().processorContext),this._processorContext}get processorDestination(){return this._processorDestination||(this._processorDestination=this.initProcessor().processorDestination),this._processorDestination}get isPlaying(){return this._useAudioElement?bi.isPlaying(this.getTrackId()):this._source.isPlayed}get __className__(){return"LocalAudioTrack"}constructor(t,e,n,i){super(t,n),W(this,"trackMediaType","audio"),W(this,"_encoderConfig",void 0),W(this,"_trackSource",void 0),W(this,"_enabled",!0),W(this,"_volume",100),W(this,"_useAudioElement",!0),W(this,"_bypassWebAudio",!1),W(this,"processor",void 0),W(this,"_processorContext",void 0),W(this,"_processorDestination",void 0),W(this,"_getOriginVolumeLevel",void 0),this._encoderConfig=e,this._getOriginVolumeLevel=!!i,this._trackSource=new RT,N("DISABLE_WEBAUDIO")&&(this._bypassWebAudio=!0),N("LOCAL_AUDIO_TRACK_USES_WEB_AUDIO")&&(this._useAudioElement=!1),An()&&!nr?setTimeout(()=>this.initWebAudio()):this.initWebAudio()}setVolume(t){Se(t,"volume",0,1e3),this._volume=t,this._source.setVolume(t/100),this._useAudioElement&&bi.setVolume(this.getTrackId(),t);try{if(this._bypassWebAudio)return void E.debug("[".concat(this.getTrackId(),"] setVolume returned because no pass through WebAudio."));const e=this._source.createOutputTrack();this._mediaStreamTrack!==e&&(this._mediaStreamTrack=e,Ie(this,ut.NEED_REPLACE_TRACK,this).then(()=>{E.debug("[".concat(this.getTrackId(),"] replace web audio track success"))}).catch(n=>{E.warning("[".concat(this.getTrackId(),"] replace web audio track failed"),n)}))}catch{}}getVolumeLevel(){return this._muted&&this.enabled&&this._getOriginVolumeLevel?this._source.getOriginVolumeLevel():this._source.getAccurateVolumeLevel()}async setPlaybackDevice(t){if(!this._useAudioElement||!gw())throw new G(b.NOT_SUPPORTED,"your browser does not support setting the audio output device");await bi.setSinkID(this.getTrackId(),t)}async setEnabled(t,e,n){return this._setEnabled(t,e,n)}async _setEnabled(t,e,n){if(!n){if(t===this._enabled)return;this.stateCheck("enabled",t)}if(E.info("[".concat(this.getTrackId(),"] start setEnabled"),t),t){this._originMediaStreamTrack.enabled=!0;try{n||(this._enabled=!0),await Ie(this,ut.NEED_ENABLE_TRACK,this),E.info("[".concat(this.getTrackId(),"] setEnabled to ").concat(t," success"))}catch(i){throw n||(this._enabled=!1),E.error("[".concat(this.getTrackId(),"] setEnabled to true error"),i.toString()),i}}else{this._originMediaStreamTrack.enabled=!1,n||(this._enabled=!1);try{await Ie(this,ut.NEED_DISABLE_TRACK,this)}catch(i){throw n||(this._enabled=!0),E.error("[".concat(this.getTrackId(),"] setEnabled to false error"),i.toString()),i}}}async setMuted(t){t!==this._muted&&(this.stateCheck("muted",t),this._muted=t,this._originMediaStreamTrack.enabled=!t,E.debug("[".concat(this.getTrackId(),"] start set muted: ").concat(t)),t?await Ie(this,ut.NEED_MUTE_TRACK,this):await Ie(this,ut.NEED_UNMUTE_TRACK,this))}getStats(){return Hs(()=>{E.warning("[deprecated] LocalAudioTrack.getStats will be removed in the future, use AgoraRTCClient.getLocalAudioStats instead")},"localAudioTrackGetStatsWarning"),Gi(this,ut.GET_STATS)||Fe({},fT)}setAudioFrameCallback(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:4096;if(!t)return this._source.removeAllListeners(tr.ON_AUDIO_BUFFER),void this._source.stopGetAudioBuffer();this._source.startGetAudioBuffer(e),this._source.removeAllListeners(tr.ON_AUDIO_BUFFER),this._source.on(tr.ON_AUDIO_BUFFER,n=>t(n))}play(){E.debug("[".concat(this.getTrackId(),"] start audio playback")),this._useAudioElement?(E.debug("[".concat(this.getTrackId(),"] start audio playback in element")),bi.play(this._mediaStreamTrack,this.getTrackId(),this._volume)):this._source.play()}stop(){E.debug("[".concat(this.getTrackId(),"] stop audio playback")),this._useAudioElement?bi.stop(this.getTrackId()):this._source.stop()}close(){super.close(),this._processorDestination&&this.unbindProcessorDestinationEvents(this._processorDestination),this._processorContext&&this.unbindProcessorContextEvents(this._processorContext),this.unpipe(),this._processorDestination&&this._processorDestination._source&&this._processorDestination._source.unpipe(),this._source.destroy()}_updatePlayerSource(){let t=!(arguments.length>0&&arguments[0]!==void 0)||arguments[0];E.debug("[".concat(this.getTrackId(),"] update player source track")),t&&this._source.updateTrack(this._mediaStreamTrack),this._useAudioElement&&bi.updateTrack(this.getTrackId(),this._mediaStreamTrack)}async _updateOriginMediaStreamTrack(t,e){this._originMediaStreamTrack!==t&&(this._originMediaStreamTrack&&(this._originMediaStreamTrack.removeEventListener("ended",this._handleTrackEnded),e&&this._originMediaStreamTrack.stop()),t.addEventListener("ended",this._handleTrackEnded),this._originMediaStreamTrack=t,this._muted&&(this._originMediaStreamTrack.enabled=!1),this.processor&&this._processorContext&&this.processor.updateInput({track:t,context:this._processorContext}),this._mediaStreamTrack!==this._source.outputTrack?(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource(),await Ie(this,ut.NEED_REPLACE_TRACK,this)):this._source.updateTrack(this._originMediaStreamTrack),this._getOriginVolumeLevel&&this._source.updateOriginTrack(t))}renewMediaStreamTrack(t){return ot.resolve(void 0)}pipe(t){if(this._bypassWebAudio)throw new G(b.INVALID_OPERATION,"Can not process AudioTrack when bypassWebAudio set to true.");if(this.processor===t)return t;if(t._source)throw new G(b.INVALID_OPERATION,"Processor ".concat(t.name," already piped, please call unpipe beforehand."));return this.unpipe(),this.processor=t,this.processor._source=this,t.updateInput({track:this._originMediaStreamTrack,node:this._source.processSourceNode,context:this.processorContext}),t}unpipe(){var t;if(!this.processor)return;const e=this.processor;(t=this._source.processSourceNode)===null||t===void 0||t.disconnect(),this.processor._source=!1,this.processor=void 0,e.reset()}bindProcessorDestinationEvents(t){t.on(Si.ON_TRACK,async e=>{e?e!==this._mediaStreamTrack&&(this._mediaStreamTrack=e,this._updatePlayerSource(!1),this._source.processedNode=this._source.createMediaStreamSourceNode(e),await Ie(this,ut.NEED_REPLACE_TRACK,this)):this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource(),await Ie(this,ut.NEED_REPLACE_TRACK,this))}),t.on(Si.ON_NODE,e=>{this._source.processedNode=e})}unbindProcessorDestinationEvents(t){t.removeAllListeners(Si.ON_TRACK),t.removeAllListeners(Si.ON_NODE)}bindProcessorContextEvents(t){t.on(er.REQUEST_CONSTRAINTS,async e=>{e(this._originMediaStreamTrack.getSettings())})}unbindProcessorContextEvents(t){t.removeAllListeners(er.REQUEST_CONSTRAINTS)}initWebAudio(){return this._trackSource instanceof RT&&(this._trackSource=new Aw(this._mediaStreamTrack,!1,this._getOriginVolumeLevel?this._mediaStreamTrack:void 0)),this._trackSource}initProcessor(){const t=new xw(this._source.context,this.getTrackId(),"local"),e=new Uw(t);return this._processorContext=t,this._processorDestination=e,this.bindProcessorContextEvents(t),this.bindProcessorDestinationEvents(e),this._source.on(tr.UPDATE_SOURCE,()=>{this.processor&&this.processor.updateInput({node:this._source.processSourceNode,context:t})}),this._useAudioElement&&(this._useAudioElement=!1,this.isPlaying&&(bi.stop(this.getTrackId()),this._source.play()),Ie(this,ut.NEED_REPLACE_MIXING_TRACK,this).then(()=>{E.debug("[".concat(this.getTrackId(),"] replace from origin track to web audio track success"))}).catch(n=>{E.warning("[".concat(this.getTrackId(),"] replace from origin track to web audio track failed"),n)})),{processorContext:t,processorDestination:e}}}).prototype,"setVolume",[Gw],Object.getOwnPropertyDescriptor(Ke.prototype,"setVolume"),Ke.prototype),Jt(Ke.prototype,"setPlaybackDevice",[Ww,Hw],Object.getOwnPropertyDescriptor(Ke.prototype,"setPlaybackDevice"),Ke.prototype),Jt(Ke.prototype,"setEnabled",[Kw,qw,Yw],Object.getOwnPropertyDescriptor(Ke.prototype,"setEnabled"),Ke.prototype),Jt(Ke.prototype,"setMuted",[zw,Jw,Xw],Object.getOwnPropertyDescriptor(Ke.prototype,"setMuted"),Ke.prototype),Jt(Ke.prototype,"getStats",[Qw],Object.getOwnPropertyDescriptor(Ke.prototype,"getStats"),Ke.prototype),Jt(Ke.prototype,"setAudioFrameCallback",[Zw],Object.getOwnPropertyDescriptor(Ke.prototype,"setAudioFrameCallback"),Ke.prototype),Jt(Ke.prototype,"play",[$w,tO],Object.getOwnPropertyDescriptor(Ke.prototype,"play"),Ke.prototype),Jt(Ke.prototype,"stop",[eO,nO],Object.getOwnPropertyDescriptor(Ke.prototype,"stop"),Ke.prototype),Jt(Ke.prototype,"close",[iO],Object.getOwnPropertyDescriptor(Ke.prototype,"close"),Ke.prototype),Jt(Ke.prototype,"pipe",[rO],Object.getOwnPropertyDescriptor(Ke.prototype,"pipe"),Ke.prototype),Jt(Ke.prototype,"unpipe",[oO],Object.getOwnPropertyDescriptor(Ke.prototype,"unpipe"),Ke.prototype),Ke),If=(sO=Ct({argsMap:(t,e)=>[t.getTrackId(),e]}),aO=on(),cO=td("MicrophoneAudioTrack","_enabledMutex"),dO=Ct({argsMap:(t,e,n)=>[t.getTrackId(),e,n]}),uO=on(),lO=Ct({argsMap:t=>[t.getTrackId()]}),Jt((qo=class extends Qe{get __className__(){return"MicrophoneAudioTrack"}constructor(t,e,n,i){super(t,e.encoderConfig?Rf(e.encoderConfig):{},i,N("GET_VOLUME_OF_MUTED_AUDIO_TRACK")),W(this,"_config",void 0),W(this,"_deviceName","default"),W(this,"_constraints",void 0),W(this,"_originalConstraints",void 0),W(this,"_enabled",!0),this._config=e,this._constraints=n,this._originalConstraints=n,this._deviceName=t.label,typeof e.bypassWebAudio=="boolean"&&(this._bypassWebAudio=e.bypassWebAudio),(Qc()||Bm())&&Ee.bindInterruptDetectorTrack(this)}async setDevice(t){if(E.info("[".concat(this.getTrackId(),"] start set device to ").concat(t)),this._enabled)try{const e=await rr.getDeviceById(t),n={};n.audio=Fe({},this._constraints),n.audio.deviceId={exact:t},this._originMediaStreamTrack.stop();let i=null;try{i=await ir(n,this.getTrackId())}catch(r){throw E.error("[".concat(this.getTrackId(),"] setDevice failed"),r.toString()),i=await ir({audio:this._constraints},this.getTrackId()),await this._updateOriginMediaStreamTrack(i.getAudioTracks()[0],!1),r}await this._updateOriginMediaStreamTrack(i.getAudioTracks()[0],!1),this._deviceName=e.label,this._config.microphoneId=t,this._constraints.deviceId={exact:t}}catch(e){throw E.error("[".concat(this.getTrackId(),"] setDevice error"),e.toString()),e}else try{const e=await rr.getDeviceById(t);this._deviceName=e.label,this._config.microphoneId=t,this._constraints.deviceId={exact:t}}catch(e){throw E.error("[".concat(this.getTrackId(),"] setDevice error"),e.toString()),e}E.info("[".concat(this.getTrackId(),"] set device to ").concat(t," success"))}async setEnabled(t,e,n){if(e)return E.debug("[".concat(this.getTrackId(),"] setEnabled false (do not close microphone)")),await super._setEnabled(t);if(!n){if(t===this._enabled)return;this.stateCheck("enabled",t)}if(E.info("[".concat(this.getTrackId(),"] start setEnabled"),t),N("AUTO_RESET_AUDIO_ROUTE")&&(Qn()||Lr())){const s=navigator.audioSession;s&&(t||(s.type="playback"),s.type="auto")}if(!t){var i;this._originMediaStreamTrack.onended=null,this._originMediaStreamTrack.stop(),(i=this._source.clonedTrack)===null||i===void 0||i.stop(),n||(this._enabled=!1);try{await Ie(this,ut.NEED_DISABLE_TRACK,this)}catch(s){throw E.error("[".concat(this.getTrackId(),"] setEnabled false failed"),s.toString()),s}return}const r=Fe({},this._constraints),o=rr.searchDeviceIdByName(this._deviceName);o&&!r.deviceId&&(r.deviceId=o);try{n||(this._enabled=!0);const s=await ir({audio:this._constraints},this.getTrackId());await this._updateOriginMediaStreamTrack(s.getAudioTracks()[0],!1),await Ie(this,ut.NEED_ENABLE_TRACK,this)}catch(s){throw n||(this._enabled=!1),E.error("[".concat(this.getTrackId(),"] setEnabled true failed"),s.toString()),s}E.info("[".concat(this.getTrackId(),"] setEnabled success"))}close(){super.close(),(Qc()||Bm())&&Ee.unbindInterruptDetectorTrack(this)}onTrackEnded(){if((Qn()||Lr())&&this._enabled&&!this._isClosed&&Ee.duringInterruption){const t=async()=>{Ee.off(jn.IOS_INTERRUPTION_END,t),this._enabled&&!this._isClosed&&(E.debug("[".concat(this.getTrackId(),"] try capture microphone media device for interrupted iOS device.")),await this.setEnabled(!1),await this.setEnabled(!0))};Ee.on(jn.IOS_INTERRUPTION_END,t)}else E.debug("[".concat(this.getTrackId(),"] track ended")),this.safeEmit(yd.TRACK_ENDED)}async renewMediaStreamTrack(t){const e=t||this._constraints,n=rr.searchDeviceIdByName(this._deviceName);if(n&&!e.deviceId&&(e.deviceId=n),this._constraints=e,this._enabled){this._originMediaStreamTrack.stop();const i=await ir({audio:this._constraints},this.getTrackId());await this._updateOriginMediaStreamTrack(i.getAudioTracks()[0],!0)}}bindProcessorContextEvents(t){super.bindProcessorContextEvents(t),t.on(er.REQUEST_UPDATE_CONSTRAINTS,async(e,n,i)=>{try{const r=Object.assign({},this._originalConstraints,...e);await this.renewMediaStreamTrack(r),n()}catch(r){i(r)}})}unbindProcessorContextEvents(t){super.unbindProcessorContextEvents(t),t.removeAllListeners(er.REQUEST_UPDATE_CONSTRAINTS)}}).prototype,"setDevice",[sO,aO],Object.getOwnPropertyDescriptor(qo.prototype,"setDevice"),qo.prototype),Jt(qo.prototype,"setEnabled",[cO,dO,uO],Object.getOwnPropertyDescriptor(qo.prototype,"setEnabled"),qo.prototype),Jt(qo.prototype,"close",[lO],Object.getOwnPropertyDescriptor(qo.prototype,"close"),qo.prototype),qo),kW=(hO=Ct({argsMap:(t,e)=>[t.getTrackId(),e,t.duration]}),pO=on(),fO=Ct({argsMap:t=>[t.getTrackId()]}),_O=on(),EO=Ct({argsMap:t=>[t.getTrackId()]}),mO=on(),gO=Ct({argsMap:t=>[t.getTrackId()]}),TO=on(),SO=Ct({argsMap:t=>[t.getTrackId()]}),RO=on(),CO=Ct({argsMap:t=>[t.getTrackId()]}),vO=Ct({argsMap:t=>[t.getTrackId()]}),yO=on(),Jt((zn=class extends Qe{get __className__(){return"BufferSourceAudioTrack"}constructor(t,e,n,i){super(e.createOutputTrack(),n,i),W(this,"source",void 0),W(this,"_bufferSource",void 0),this._useAudioElement=!1,this.source=t,this._bufferSource=e,this._bufferSource.on(tr.AUDIO_SOURCE_STATE_CHANGE,r=>{this.safeEmit(yd.SOURCE_STATE_CHANGE,r)});try{this._mediaStreamTrack=this._source.createOutputTrack()}catch{}}get currentState(){return this._bufferSource.currentState}get duration(){return this._bufferSource.duration}get playbackSpeed(){return this._bufferSource.playbackSpeed}getCurrentTime(){return this._bufferSource.currentTime}startProcessAudioBuffer(t){t&&this._bufferSource.updateOptions(t),this._bufferSource.startProcessAudioBuffer()}pauseProcessAudioBuffer(){this._bufferSource.pauseProcessAudioBuffer()}seekAudioBuffer(t){this._bufferSource.seekAudioBuffer(t)}resumeProcessAudioBuffer(){this._bufferSource.resumeProcessAudioBuffer()}stopProcessAudioBuffer(){this._bufferSource.stopProcessAudioBuffer()}close(){this.source=null,this._bufferSource.destroy(),super.close()}setAudioBufferPlaybackSpeed(t){Se(t,"speed",0),this._bufferSource.setAudioBufferPlaybackSpeed(t)}}).prototype,"startProcessAudioBuffer",[hO,pO],Object.getOwnPropertyDescriptor(zn.prototype,"startProcessAudioBuffer"),zn.prototype),Jt(zn.prototype,"pauseProcessAudioBuffer",[fO,_O],Object.getOwnPropertyDescriptor(zn.prototype,"pauseProcessAudioBuffer"),zn.prototype),Jt(zn.prototype,"seekAudioBuffer",[EO,mO],Object.getOwnPropertyDescriptor(zn.prototype,"seekAudioBuffer"),zn.prototype),Jt(zn.prototype,"resumeProcessAudioBuffer",[gO,TO],Object.getOwnPropertyDescriptor(zn.prototype,"resumeProcessAudioBuffer"),zn.prototype),Jt(zn.prototype,"stopProcessAudioBuffer",[SO,RO],Object.getOwnPropertyDescriptor(zn.prototype,"stopProcessAudioBuffer"),zn.prototype),Jt(zn.prototype,"close",[CO],Object.getOwnPropertyDescriptor(zn.prototype,"close"),zn.prototype),Jt(zn.prototype,"setAudioBufferPlaybackSpeed",[vO,yO],Object.getOwnPropertyDescriptor(zn.prototype,"setAudioBufferPlaybackSpeed"),zn.prototype),zn);class vn extends Qe{get __className__(){return"MixingAudioTrack"}get isActive(){for(const e of this.trackList)if(e._enabled&&!e._isClosed&&!e.muted)return!0;return!1}constructor(){const e=Ad().createMediaStreamDestination();super(e.stream.getAudioTracks()[0],void 0,be(8,"track-mix-")),W(this,"trackList",void 0),W(this,"destNode",void 0),this._useAudioElement=!1;try{this._mediaStreamTrack=this._source.createOutputTrack()}catch{}this.destNode=e,this.trackList=[]}hasAudioTrack(e){return this.trackList.indexOf(e)!==-1}addAudioTrack(e){this.trackList.indexOf(e)===-1?(E.debug("add ".concat(e.getTrackId()," to mixing track")),e._source.outputNode.connect(this.destNode),this.trackList.push(e),this.updateEncoderConfig()):E.debug("track ".concat(e.getTrackId()," is already added"))}removeAudioTrack(e){if(this.trackList.indexOf(e)!==-1){E.debug("remove ".concat(e.getTrackId()," from mixing track"));try{e._source.outputNode.disconnect(this.destNode)}catch{}Lp(this.trackList,e),this.updateEncoderConfig()}}updateEncoderConfig(){const e={};this.trackList.forEach(n=>{n._encoderConfig&&((n._encoderConfig.bitrate||0)>(e.bitrate||0)&&(e.bitrate=n._encoderConfig.bitrate),(n._encoderConfig.sampleRate||0)>(e.sampleRate||0)&&(e.sampleRate=n._encoderConfig.sampleRate),(n._encoderConfig.sampleSize||0)>(e.sampleSize||0)&&(e.sampleSize=n._encoderConfig.sampleSize),n._encoderConfig.stereo&&(e.stereo=!0))}),this._encoderConfig=e}_updateRtpTransceiver(e){this._rtpTransceiver!==e&&(this._rtpTransceiver=e,this.trackList.forEach(n=>{n instanceof vn?n.emit($a.TRANSCEIVER_UPDATED,e):n._updateRtpTransceiver(e)}))}}class MW extends bw{set currentState(e){e!==this._currentState&&(this._currentState=e,this.safeEmit(tr.AUDIO_SOURCE_STATE_CHANGE,this._currentState))}get currentState(){return this._currentState}constructor(e){let n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};super(),W(this,"audioBuffer",void 0),W(this,"sourceNode",void 0),W(this,"startPlayTime",0),W(this,"startPlayOffset",0),W(this,"pausePlayTime",0),W(this,"options",void 0),W(this,"currentLoopCount",0),W(this,"currentPlaybackSpeed",100),W(this,"_currentState","stopped"),this.audioBuffer=e,this.options=n,this.startPlayOffset=this.options.startPlayTime||0}createWebAudioDiagram(){return this.context.createGain()}get duration(){return this.audioBuffer?this.audioBuffer.duration:0}get playbackSpeed(){return this.currentPlaybackSpeed}get currentTime(){return this.audioBuffer?this.currentState==="stopped"?0:this.currentState==="paused"?this.pausePlayTime:((this.context.currentTime-this.startPlayTime)*(this.playbackSpeed/100)+this.startPlayOffset)%this.audioBuffer.duration:0}updateOptions(e){this.currentState==="stopped"?(this.options=e,this.startPlayOffset=this.options.startPlayTime||0):E.warning("can not set audio source options")}startProcessAudioBuffer(){this.sourceNode&&this.stopProcessAudioBuffer(),this.sourceNode=this.createSourceNode(),this.startSourceNode(),this.currentState="playing"}pauseProcessAudioBuffer(){this.sourceNode&&this.currentState==="playing"&&(this.pausePlayTime=this.currentTime,this.sourceNode.onended=null,this.sourceNode.stop(),this.sourceNode.buffer=null,this.sourceNode=this.createSourceNode(),this.currentState="paused")}seekAudioBuffer(e){this.sourceNode&&(this.sourceNode.onended=null,this.currentState==="playing"&&this.sourceNode.stop(),this.sourceNode=this.createSourceNode(),this.currentState==="playing"?(this.startPlayOffset=e,this.startSourceNode()):this.currentState==="paused"&&(this.pausePlayTime=e))}resumeProcessAudioBuffer(){this.currentState==="paused"&&this.sourceNode&&(this.startPlayOffset=this.pausePlayTime,this.pausePlayTime=0,this.startSourceNode(),this.currentState="playing")}stopProcessAudioBuffer(){if(this.sourceNode){this.sourceNode.onended=null;try{this.sourceNode.stop()}catch{}this.reset()}}destroy(){this.audioBuffer=null,super.destroy()}setAudioBufferPlaybackSpeed(e){this.sourceNode&&(this.currentState==="playing"&&(this.startPlayOffset=this.currentTime,this.startPlayTime=this.context.currentTime),this.sourceNode.playbackRate.value=e/100),this.currentPlaybackSpeed=e}startSourceNode(){this.sourceNode&&this.sourceNode.buffer&&(this.sourceNode.start(0,this.startPlayOffset),this.startPlayTime=this.context.currentTime,this.sourceNode.onended=this.handleSourceNodeEnded.bind(this))}createSourceNode(){const e=this.context.createBufferSource();return e.buffer=this.audioBuffer,e.loop=!!this.options.loop,e.connect(this.outputNode),e.playbackRate.value=this.currentPlaybackSpeed/100,e}handleSourceNodeEnded(){if(this.currentLoopCount+=1,this.options.cycle&&this.options.cycle>this.currentLoopCount)return this.startPlayOffset=0,this.sourceNode=void 0,void this.startProcessAudioBuffer();this.reset()}reset(){this.startPlayOffset=this.options.startPlayTime||0,this.currentState="stopped",this.sourceNode&&(this.sourceNode.disconnect(),this.sourceNode=void 0),this.currentLoopCount=0}}const IO=new Map;class vT{get rendFrameRate(){if(this.renderStats&&this.renderStats.curTs!==this.renderStats.lastTs){const e=this.renderStats.curTs-this.renderStats.lastTs,n=(this.renderStats.renderNum-this.renderStats.lastRenderNum)/e;return this.renderStats.lastRenderNum=this.renderStats.renderNum,this.renderStats.lastTs=this.renderStats.curTs,n}return 0}get videoElementStatus(){return this._videoElementStatus}set videoElementStatus(e){e!==this._videoElementStatus&&(E.debug("[".concat(this.trackId,"] video-element-status change ").concat(this._videoElementStatus," => ").concat(e)),this._videoElementStatus=e)}get videoState(){return this._videoState}set videoState(e){var n;e!==this._videoState&&(this._videoState=e,(n=this.onVideoStateChanged)===null||n===void 0||n.call(this,this.videoState))}constructor(e){W(this,"trackId",void 0),W(this,"config",void 0),W(this,"onFirstVideoFrameDecoded",void 0),W(this,"onVideoStateChanged",void 0),W(this,"freezeTimeCounterList",[]),W(this,"renderFreezeAccTime",0),W(this,"isKeepLastFrame",!1),W(this,"timeUpdatedCount",0),W(this,"freezeTime",0),W(this,"playbackTime",0),W(this,"lastTimeUpdatedTime",0),W(this,"autoplayFailed",!1),W(this,"videoTrack",void 0),W(this,"videoElement",void 0),W(this,"cacheVideoElement",void 0),W(this,"renderStats",void 0),W(this,"_videoState",Ko.VideoStateStopped),W(this,"videoElementCheckInterval",void 0),W(this,"videoElementFreezeTimeout",void 0),W(this,"_videoElementStatus",di.NONE),W(this,"isGettingVideoDimensions",!1),W(this,"startGetVideoDimensions",()=>{const n=()=>{if(this.isGettingVideoDimensions=!0,this.videoElement.videoWidth*this.videoElement.videoHeight>4)return E.debug("[".concat(this.trackId,"] current video dimensions:"),this.videoElement.videoWidth,this.videoElement.videoHeight),void(this.isGettingVideoDimensions=!1);setTimeout(n,500)};!this.isGettingVideoDimensions&&n()}),W(this,"autoResumeAfterInterruption",()=>{this.videoTrack&&this.videoTrack.readyState==="live"&&Ee.curState==="running"&&(E.debug("[track-".concat(this.trackId,"] video element paused, auto resume for ").concat(OI())),VI()?(this.videoElement.srcObject=null,this.videoElement.srcObject=new MediaStream([this.videoTrack]),this.videoElement.play()):(this.videoElement.pause(),this.videoElement.play()))}),W(this,"handleVideoEvents",n=>{switch(n.type){case"play":case"playing":this.startGetVideoDimensions(),this.videoElementStatus=di.PLAYING;break;case"loadeddata":if(this.videoState=Ko.VideoStateStarting,this.onFirstVideoFrameDecoded&&this.onFirstVideoFrameDecoded(),this.cacheVideoElement){try{this.cacheVideoElement.srcObject=null,this.cacheVideoElement.remove()}catch{}this.cacheVideoElement=void 0}break;case"canplay":this.videoElementStatus=di.CANPLAY;break;case"stalled":this.videoElementStatus=di.STALLED;break;case"suspend":this.videoElementStatus=di.SUSPEND;break;case"pause":this.videoElementStatus=di.PAUSED,Qn()||Lr()||An()&&this.autoplayFailed||!this.videoTrack||this.videoTrack.readyState!=="live"||(E.debug("[track-".concat(this.trackId,"] video element paused, auto resume")),this.videoElement.play());break;case"waiting":this.videoElementStatus=di.WAITING;break;case"abort":this.videoElementStatus=di.ABORT;break;case"ended":this.videoElementStatus=di.ENDED;break;case"emptied":this.videoElementStatus=di.EMPTIED;break;case"error":{const i=this.videoElement.error;i?(this.videoElementStatus=di.ERROR,E.error("[".concat(this.trackId,"] media error: ").concat(i.message," (").concat(i.code,")"))):E.debug("[".concat(this.trackId,"] media not been an error."));break}case"timeupdate":{const i=performance.now();if(this.timeUpdatedCount+=1,this.timeUpdatedCount<10)return void(this.lastTimeUpdatedTime=i);const r=i-this.lastTimeUpdatedTime,o=this.lastTimeUpdatedTime;if(this.lastTimeUpdatedTime=i,Cs.lastVisibleTime<Cs.lastHiddenTime||o<Cs.lastHiddenTime||o<Cs.lastVisibleTime)return;for(r>N("VIDEO_FREEZE_DURATION")&&(this.freezeTime+=r),this.playbackTime+=r;this.playbackTime>=6e3;){this.playbackTime-=6e3;const s=Math.min(6e3,this.freezeTime);this.freezeTimeCounterList.push(s),this.freezeTime=Math.max(0,this.freezeTime-6e3)}break}}}),W(this,"autoResumeAfterInterruptionOnIOS15_16",()=>{this.videoTrack&&this.videoTrack.readyState==="live"&&(E.debug("[track-".concat(this.trackId,"] video element paused, auto resume for ").concat(OI())),VI()?(this.videoElement.srcObject=null,this.videoElement.srcObject=new MediaStream([this.videoTrack]),this.videoElement.play()):(this.videoElement.pause(),this.videoElement.play()))}),this.trackId=e.trackId,this.config=e,e.element instanceof HTMLVideoElement?this.videoElement=e.element:this.videoElement=document.createElement("video"),Ee.on(jn.IOS_INTERRUPTION_END,this.autoResumeAfterInterruption),Ee.on(jn.IOS_15_16_INTERRUPTION_END,this.autoResumeAfterInterruptionOnIOS15_16)}getVideoElement(){return this.videoElement}getContainerElement(){var e;return(e=this.videoElement.parentElement)!==null&&e!==void 0?e:void 0}updateConfig(e){this.config=e,this.trackId=e.trackId,e.element!==this.videoElement&&(this.destroy(),this.videoElement=e.element),this.videoTrack&&this.initVideoElement()}updateVideoTrack(e){this.videoTrack!==e&&(this.videoTrack=e,this.initVideoElement())}play(e){const n=this.videoElement.play();n&&n.catch&&n.catch(r=>{e&&Lw(e,"video",r.message,this.trackId),r.name==="NotAllowedError"?(E.warning("detected video element autoplay failed",r),this.autoplayFailed=!0,this.handleAutoPlayFailed()):E.warning("[".concat(this.trackId,"] play warning: "),r)});const i=Zt();if((i.name==="Safari"&&Number(i.version)===15||Qc())&&n&&n.then){const r=()=>{this.config.mirror&&(this.videoElement.style.transform="rotateY(180deg)")};n.then(r).catch(r)}}getCurrentFrame(){const e=document.createElement("canvas");e.width=this.videoElement.videoWidth,e.height=this.videoElement.videoHeight;const n=e.getContext("2d");if(!n)return E.error("create canvas context failed!"),new ImageData(2,2);n.drawImage(this.videoElement,0,0,e.width,e.height);const i=n.getImageData(0,0,e.width,e.height);return e.remove(),i}async getCurrentFrameToUint8Array(e){let n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:1;const i=document.createElement("canvas");i.width=this.videoElement.videoWidth,i.height=this.videoElement.videoHeight;const r=i.getContext("2d");return r?(r.drawImage(this.videoElement,0,0,i.width,i.height),new ot((o,s)=>{i.toBlob(async a=>{if(i.remove(),a){const c=await Bw(a);o({buffer:c,width:i.width,height:i.height})}else s(new G(b.CONVERTING_VIDEO_FRAME_TO_BLOB_FAILED))},e,n<0?.1:n>1?1:n)})):await CT(e)}destroy(){this.renderStats=void 0,Ee.off(jn.IOS_INTERRUPTION_END,this.autoResumeAfterInterruption),Ee.off(jn.IOS_15_16_INTERRUPTION_END,this.autoResumeAfterInterruptionOnIOS15_16),this.videoElement.srcObject=null,this.resetVideoElement(),this.freezeTimeCounterList=[],this.videoState=Ko.VideoStateStopped}initVideoElement(){if(this.videoElementStatus=di.INIT,!this.videoElementCheckInterval&&(bO.forEach(o=>{this.videoElement.addEventListener(o,this.handleVideoEvents)}),this.videoElementCheckInterval=window.setInterval(()=>{(function(o){return o!==document.body&&document.body.contains(o)})(this.videoElement)||(this.videoElementStatus=di.DESTROYED)},1e3),N("ENABLE_VIDEO_FRAME_CALLBACK"))){var e,n;let o;const s=()=>{document.visibilityState==="visible"&&(document.removeEventListener("visibilitychange",s),this.videoElementFreezeTimeout=window.setTimeout(a,N("VIDEO_FREEZE_DURATION")))},a=()=>{this.videoElementFreezeTimeout=void 0,this.videoState===Ko.VideoStateDecoding&&(document.visibilityState==="visible"?this.videoState=Ko.VideoStateFrozen:document.addEventListener("visibilitychange",s))},c=(d,u)=>{if(this.videoElementStatus===di.PLAYING){if(this.renderStats?(this.renderStats.renderNum++,this.renderStats.curTs=u.mediaTime):this.renderStats={lastTs:u.mediaTime,curTs:u.mediaTime,lastRenderNum:0,renderNum:0},o){const f=u.presentationTime-o.presentationTime;this.videoState===Ko.VideoStateStarting&&(this.videoState=Ko.VideoStateDecoding),this.videoState===Ko.VideoStateDecoding&&this.onVideoStateChanged&&(this.videoElementFreezeTimeout&&window.clearTimeout(this.videoElementFreezeTimeout),this.videoElementFreezeTimeout=window.setTimeout(a,N("VIDEO_FREEZE_DURATION"))),f<N("VIDEO_FREEZE_DURATION")&&this.videoState===Ko.VideoStateFrozen&&(this.videoState=Ko.VideoStateDecoding),f>N("VIDEO_FREEZE_DURATION")&&Cs.lastVisibleTime>=Cs.lastHiddenTime&&o.timestamp>Cs.lastVisibleTime&&o.timestamp>Cs.lastHiddenTime&&(this.renderFreezeAccTime+=f)}o=Fe(Fe({},u),{},{timestamp:d})}var l,p;N("ENABLE_VIDEO_FRAME_CALLBACK")&&((l=(p=this.videoElement).requestVideoFrameCallback)===null||l===void 0||l.call(p,c))};(e=(n=this.videoElement).requestVideoFrameCallback)===null||e===void 0||e.call(n,c)}this.videoElement.controls=!1,this.videoElement.setAttribute("playsinline",""),Pp()&&!N("HIDE_NO_POSTER")&&(this.videoElement.poster="noposter");const i=Zt();i.name==="Safari"&&Number(i.version)===15||Qc()||!this.config.mirror||(this.videoElement.style.transform="rotateY(180deg)"),this.config.fit?this.videoElement.style.objectFit=this.config.fit:this.videoElement.style.objectFit="cover",this.videoElement.setAttribute("muted",""),this.videoElement.muted=!0,this.videoElement.srcObject&&this.videoElement.srcObject instanceof MediaStream?this.videoElement.srcObject.getVideoTracks()[0]!==this.videoTrack&&(this.videoElement.srcObject=this.videoTrack?new MediaStream([this.videoTrack]):null,ye()&&this.videoElement.load()):(this.videoElement.srcObject=this.videoTrack?new MediaStream([this.videoTrack]):null,ye()&&this.videoElement.load());const r=this.videoElement.play();r!==void 0&&r.catch(o=>{E.debug("[".concat(this.trackId,"] playback interrupted"),o.toString())})}resetVideoElement(){bO.forEach(e=>{this.videoElement&&this.videoElement.removeEventListener(e,this.handleVideoEvents)}),this.videoElementCheckInterval&&(window.clearInterval(this.videoElementCheckInterval),this.videoElementCheckInterval=void 0),this.videoElementStatus=di.NONE}handleAutoPlayFailed(){const e=n=>{n.preventDefault(),this.videoElement.play().then(()=>{E.debug("[".concat(this.trackId,"] Video element for trackId:").concat(this.trackId," autoplay resumed."))}).catch(i=>{E.error(i)}),this.autoplayFailed=!1,qu()?document.body.removeEventListener("click",e,!0):(document.body.removeEventListener("touchstart",e,!0),document.body.removeEventListener("mousedown",e,!0))};qu()?document.body.addEventListener("click",e,!0):(document.body.addEventListener("touchstart",e,!0),document.body.addEventListener("mousedown",e,!0)),Pw()}}const bO=["play","playing","loadeddata","canplay","pause","stalled","suspend","waiting","abort","emptied","ended","timeupdate","error"];class AO extends vT{constructor(e){super(e),W(this,"container",void 0),W(this,"slot",void 0),this.slot=e.element,this.updateConfig(e)}updateConfig(e){this.config=e,this.trackId=e.trackId;const n=e.element;n!==this.slot&&(this.destroy(),this.slot=n),this.createElements()}updateVideoTrack(e){this.videoTrack!==e&&(this.videoTrack=e,this.createElements())}play(e){var n;(n=this.container)!==null&&n!==void 0&&n.contains(this.videoElement)&&super.play(e)}getCurrentFrame(){var e;return(e=this.container)!==null&&e!==void 0&&e.contains(this.videoElement)?super.getCurrentFrame():new ImageData(2,2)}async getCurrentFrameToUint8Array(e){var n;let i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:1;return(n=this.container)!==null&&n!==void 0&&n.contains(this.videoElement)?await super.getCurrentFrameToUint8Array(e,i):await CT(e)}destroy(){if(super.destroy(),this.videoElement.remove(),this.videoElement=document.createElement("video"),this.container){try{this.container.remove(),this.slot.removeChild(this.container)}catch{}this.container=void 0}}createElements(){this.container||(this.container=document.createElement("div")),this.container.id="agora-video-player-".concat(this.trackId),this.container.style.width="100%",this.container.style.height="100%",this.container.style.position="relative",this.container.style.overflow="hidden",this.videoTrack?(this.container.style.backgroundColor="black",N("KEEP_LAST_FRAME")&&this.isKeepLastFrame&&this.videoElement.paused&&this.resetVideoElement(),this.mountedVideoElement()):this.unmountedVideoElement(),this.slot.appendChild(this.container)}mountedVideoElement(){var e;!this.container||(e=this.container)!==null&&e!==void 0&&e.contains(this.videoElement)||this.container.appendChild(this.videoElement),super.initVideoElement(),this.videoElement.id="video_".concat(this.trackId),this.videoElement.className="agora_video_player",this.videoElement.style.width="100%",this.videoElement.style.height="100%",this.videoElement.style.position="absolute",this.videoElement.style.left="0",this.videoElement.style.top="0"}unmountedVideoElement(){var e;if((e=this.container)!==null&&e!==void 0&&e.contains(this.videoElement)){super.resetVideoElement();try{this.container&&this.container.removeChild(this.videoElement)}catch{}this.videoElement=document.createElement("video")}}resetVideoElement(){var e;(e=this.container)!==null&&e!==void 0&&e.contains(this.videoElement)&&(super.resetVideoElement(),this.cacheVideoElement=this.videoElement,this.videoElement=document.createElement("video"))}getContainerElement(){return this.container}}var wO,OO,NO,DO,PO,LO,kO,MO,UO,xO,VO,FO,jO,BO,GO,WO,HO,KO,qO,YO,zO,JO,XO,QO,ZO,qt,$O,t0,e0,n0,i0,r0,o0,s0,sr;let Ae=(wO=Ct({argsMap:(t,e,n)=>[t.getTrackId(),typeof e=="string"?e:e instanceof HTMLVideoElement?"HTMLVideoElement":"HTMLElement",n]}),OO=on(),NO=Ct({argsMap:t=>[t.getTrackId()]}),DO=td("LocalVideoTrack","_enabledMutex"),PO=Ct({argsMap:(t,e)=>[t.getTrackId(),e]}),LO=on(),kO=td("LocalVideoTrack","_enabledMutex"),MO=Ct({argsMap:(t,e)=>[t.getTrackId(),e]}),UO=on(),xO=Ct({argsMap:(t,e)=>[t.getTrackId(),e]}),VO=on(),FO=on(),jO=Ct({argsMap:(t,e,n)=>[t.getTrackId(),e,n]}),BO=on(),GO=on(),WO=on(),HO=on(),KO=on(),qO=on(),YO=on(),zO=Ct({argsMap:(t,e)=>[t.getTrackId(),e.name]}),JO=Ct({argsMap:t=>[t.getTrackId()]}),XO=Ct({argsMap:t=>[t.getTrackId()]}),QO=Ct({argsMap:(t,e,n)=>[t.getTrackId(),e.label,n]}),ZO=Ct(),qt=class cP extends bd{get videoHeight(){if(An()){const{height:e}=this._mediaStreamTrack.getSettings();return this._videoHeight=e,this._videoHeight}return this._videoHeight}get videoWidth(){if(An()){const{width:e}=this._mediaStreamTrack.getSettings();return this._videoWidth=e,this._videoWidth}return this._videoWidth}get isPlaying(){return!(!this._player||this._player.videoElementStatus!==di.PLAYING)}get processorDestination(){return this._processorDestination}get processorContext(){return this._processorContext}set processorContext(e){this._processorContext=e}get __className__(){return"LocalVideoTrack"}constructor(e,n,i,r,o,s){if(super(e,o),W(this,"trackMediaType","video"),W(this,"_player",void 0),W(this,"isUseScaleResolutionDownBy",!1),W(this,"_videoVisibleTimer",null),W(this,"_statsTimer",null),W(this,"_previousVideoVisibleStatus",void 0),W(this,"_clearPreviousVideoVisibleStatus",()=>this._previousVideoVisibleStatus=void 0),W(this,"_encoderConfig",void 0),W(this,"_scalabilityMode",{numSpatialLayers:1,numTemporalLayers:1}),W(this,"_optimizationMode",void 0),W(this,"_videoHeight",void 0),W(this,"_videoWidth",void 0),W(this,"_forceBitrateLimit",void 0),W(this,"_enabled",!0),W(this,"_processorDestination",void 0),W(this,"_processorContext",void 0),An()){const{width:a,height:c}=e.getSettings();this._videoWidth=a,this._videoHeight=c}else this.updateMediaStreamTrackResolution();if(this._encoderConfig=n,this._scalabilityMode=i,this._optimizationMode=r,this._hints=s||[],this._hints.indexOf(De.SCREEN_TRACK)===-1)this.updateBitrateFromProfile();else if(function(a,c,d){const u=Zt();return!(u.name!==a||!u.osVersion)&&(d?Number(u.version)>=c&&Number(u.version)<=d:Number(u.version)===c)}(ue.CHROME,115)&&Np().indexOf("Windows")!==-1){const a=function(c,d){if("VideoFrame"in window&&"TransformStream"in window&&zt().supportWebRTCInsertableStream){const u=new MediaStreamTrackProcessor(c),l=new MediaStreamTrackGenerator({kind:"video"});let p,f,C=Date.now();const m=()=>{g&&(clearInterval(g),g=void 0),p&&(p.close(),p=void 0),c.stop(),f=void 0,l.removeEventListener("ended",m)};let g=window.setInterval(()=>{if(f&&p&&Date.now()-C>(d!=null?d:1e3))try{l.readyState==="live"?f.enqueue(p.clone()):m()}catch{m()}},d!=null?d:1e3);const y=new TransformStream({transform:(A,k)=>{l.readyState==="live"?(f=k,C=Date.now(),p===void 0?(p=A,k.enqueue(A.clone())):(k.enqueue(p),p=A)):A.close()}});return l.addEventListener("ended",m),u.readable.pipeThrough(y).pipeTo(l.writable),l}}(e);a&&(E.info("local screen video track begin to inject frame"),this._mediaStreamTrack=a)}n&&this._hints.indexOf(De.CUSTOM_TRACK)!==-1&&this.setEncoderConfiguration(n),this._processorContext=new Mw(this.getTrackId(),"local"),this._processorDestination=new kw(this.processorContext),this.bindProcessorDestinationEvents()}play(e){let n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(typeof e=="string"){const r=document.getElementById(e);r?e=r:(E.warning("[".concat(this.getTrackId(),'] can not find "#').concat(e,'" element, use document.body')),e=document.body)}E.debug("[".concat(this.getTrackId(),"] start video playback in ").concat(e instanceof HTMLVideoElement?"HTMLVideoElement":"HTMLElement"),JSON.stringify(n));const i=Fe(Fe(Fe({},this._getDefaultPlayerConfig()),n),{},{trackId:this.getTrackId(),element:e});this._player?this._player.updateConfig(i):(e instanceof HTMLVideoElement?this._player=new vT(i):this._player=new AO(i),this._player.updateVideoTrack(this._mediaStreamTrack)),this._player.play(),this._videoVisibleTimer&&window.clearInterval(this._videoVisibleTimer),this._clearPreviousVideoVisibleStatus(),this._videoVisibleTimer=window.setInterval(()=>{try{const r=this.getVideoElementVisibleStatus();this.safeEmit(yd.VIDEO_ELEMENT_VISIBLE_STATUS,r)}catch{}},N("CHECK_VIDEO_VISIBLE_INTERVAL"))}stop(){this._player&&(this._videoVisibleTimer&&(window.clearInterval(this._videoVisibleTimer),this._videoVisibleTimer=null),this._statsTimer&&(this.isUseScaleResolutionDownBy=!1,window.clearInterval(this._statsTimer),this._statsTimer=null),this._clearPreviousVideoVisibleStatus(),this._player.destroy(),this._player=void 0,E.debug("[".concat(this.getTrackId(),"] stop video playback")))}async setEnabled(e,n){if(!n){if(e===this._enabled)return;this.stateCheck("enabled",e)}if(E.info("[".concat(this.getTrackId(),"] start setEnabled"),e),!e){this._originMediaStreamTrack.enabled=!1;try{await Ie(this,ut.NEED_DISABLE_TRACK,this)}catch(i){throw E.error("[".concat(this.getTrackId(),"] setEnabled to false error"),i.toString()),i}return n||(this._enabled=!1),void E.info("[".concat(this.getTrackId(),"] setEnabled to false success"))}this._originMediaStreamTrack.enabled=!0;try{await Ie(this,ut.NEED_ENABLE_TRACK,this)}catch(i){throw E.error("[".concat(this.getTrackId(),"] setEnabled to true error"),i.toString()),i}E.info("[".concat(this.getTrackId(),"] setEnabled to true success")),n||(this._enabled=!0)}async setMuted(e){e!==this._muted&&(this.stateCheck("muted",e),this._muted=e,this._originMediaStreamTrack.enabled=!e,E.debug("[".concat(this.getTrackId(),"] start set muted: ").concat(e)),e?await Ie(this,ut.NEED_MUTE_TRACK,this):await Ie(this,ut.NEED_UNMUTE_TRACK,this))}async setEncoderConfiguration(e,n){if(!this._enabled)throw new G(b.TRACK_IS_DISABLED,"can not set encoder configuration when track is disabled");if(e==="720p_auto"?this.startMonitorStats():this._statsTimer&&(window.clearInterval(this._statsTimer),this._statsTimer=null),e=Ho(e),this._forceBitrateLimit&&(e.bitrateMax=this._forceBitrateLimit.max_bitrate?this._forceBitrateLimit.max_bitrate:e.bitrateMax,e.bitrateMin=this._forceBitrateLimit.min_bitrate?this._forceBitrateLimit.min_bitrate:e.bitrateMin),e.width||e.height||e.frameRate){const i=yf({encoderConfig:e});(An()||Qn()||Lr())&&(i.deviceId=void 0),E.debug("[".concat(this.getTrackId(),"] setEncoderConfiguration applyConstraints"),JSON.stringify(e),JSON.stringify(i));try{await this._originMediaStreamTrack.applyConstraints(i),this.updateMediaStreamTrackResolution()}catch(r){const o=new G(b.UNEXPECTED_ERROR,r.toString());throw E.error("[".concat(this.getTrackId(),"] applyConstraints error"),o.toString()),o}}this._encoderConfig=e,this._hints.indexOf(De.SCREEN_TRACK)===-1&&this.updateBitrateFromProfile();try{await Ie(this,ut.NEED_UPDATE_VIDEO_ENCODER,this)}catch(i){return i.throw(E)}}getStats(){return Hs(()=>{E.warning("[deprecated] LocalVideoTrack.getStats will be removed in the future, use AgoraRTCClient.getLocalVideoStats instead")},"localVideoTrackGetStatsWarning"),Gi(this,ut.GET_STATS)||Fe({},_T)}async setBeautyEffect(e){E.error("LocalVideoTrack.setBeautyEffect was deprecated, please migrate to agora-extension-beauty-effect")}getCurrentFrameData(){return this._player?this._player.getCurrentFrame():new ImageData(2,2)}async getCurrentFrameImage(e){let n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:1;return this._player?this._player.getCurrentFrameToUint8Array(e,n):await CT(e)}async setBitrateLimit(e){if(E.debug("[".concat(this.getTrackId(),"] set bitrate limit, ").concat(JSON.stringify(e))),e){this._forceBitrateLimit=e,this._encoderConfig&&(this._encoderConfig.bitrateMax?this._encoderConfig.bitrateMax=this._encoderConfig.bitrateMax<e.max_bitrate?this._encoderConfig.bitrateMax:e.max_bitrate:this._encoderConfig.bitrateMax=e.max_bitrate,this._encoderConfig.bitrateMin,this._encoderConfig.bitrateMin=e.min_bitrate);try{await Ie(this,ut.NEED_UPDATE_VIDEO_ENCODER,this)}catch(n){return n.throw(E)}}}async setOptimizationMode(e){if(e!=="motion"&&e!=="detail"&&e!=="balanced")return void E.error(b.INVALID_PARAMS,"optimization mode must be motion, detail or balanced");const n=this._optimizationMode;try{this._optimizationMode=e,await Ie(this,ut.NEED_UPDATE_VIDEO_SEND_PARAMETERS,this)}catch(i){throw this._optimizationMode=n,E.error("[".concat(this.getTrackId(),"] set optimization mode failed"),i.toString()),i}E.info("[".concat(this.getTrackId(),"] set optimization mode success (").concat(e,")"))}setScalabiltyMode(e){if(e.numSpatialLayers===1&&e.numTemporalLayers!==1)return E.error(b.INVALID_PARAMS,"scalability mode currently not supported, no SVC."),void(this._scalabilityMode={numSpatialLayers:1,numTemporalLayers:1});this._scalabilityMode=e,E.info("[".concat(this.getTrackId(),"] set scalability mode success (").concat(e,")"))}updateMediaStreamTrackResolution(){Vw(this._originMediaStreamTrack).then(e=>{let[n,i]=e;this._videoHeight=i,this._videoWidth=n}).catch(Mp)}_updatePlayerSource(){this._player&&this._player.updateVideoTrack(this._mediaStreamTrack)}_getDefaultPlayerConfig(){return{fit:"contain"}}async setSenderConfiguration(e){if(!this._enabled)throw new G(b.TRACK_IS_DISABLED,"can not set encoder configuration when track is disabled");E.debug("[".concat(this.getTrackId(),"] setSenderConfiguration applyConstraints"),JSON.stringify(e)),e=Ho(e),this._forceBitrateLimit&&(e.bitrateMax=this._forceBitrateLimit.max_bitrate?this._forceBitrateLimit.max_bitrate:e.bitrateMax,e.bitrateMin=this._forceBitrateLimit.min_bitrate?this._forceBitrateLimit.min_bitrate:e.bitrateMin),this._encoderConfig=e,this._hints.indexOf(De.SCREEN_TRACK)===-1&&this.updateBitrateFromProfile();try{await Ie(this,ut.NEED_UPDATE_VIDEO_ENCODER,this)}catch(n){return n.throw(E)}}updateBitrateFromProfile(){if(!this._encoderConfig)return;const{width:e,height:n,frameRate:i}=this.getMediaStreamTrackSettings();if(!e||!n||!i)return;const{bitrateMax:r,bitrateMin:o}=this._encoderConfig;if(o==null||r==null){const{max:s,min:a}=function(c,d,u,l,p){const f=N("BITRATE_ADAPTER_TYPE");if(f==="DEFAULT_BITRATE")return{min:l,max:p};if(p===void 0){var C;const g=Math.floor(200*Math.pow(u/15,.6)*Math.pow(c*d/640/360,.75));p=f==="STANDARD_BITRATE"?4*g:2*g,l=(C=l)!==null&&C!==void 0?C:g}else{var m;l=(m=l)!==null&&m!==void 0?m:Math.floor(p/10)}return{min:l,max:p}}(e,n,i,o,r);this._encoderConfig.bitrateMin=a,this._encoderConfig.bitrateMax=s,E.debug("[".concat(this.getTrackId(),"] update bitrate from profile, [w: ").concat(e,", h: ").concat(n,", fps: ").concat(i,"] => [brMax: ").concat(s,", brMin: ").concat(a,"]"))}}getVideoElementVisibleStatus(){try{var e,n;const i=this==null||(e=this._player)===null||e===void 0?void 0:e.getContainerElement(),r={track:this,element:this==null||(n=this._player)===null||n===void 0?void 0:n.getVideoElement(),slot:i==null?void 0:i.parentElement},{element:o,slot:s}=r;if(this.isPlaying&&o instanceof HTMLVideoElement&&s instanceof HTMLElement){const a=KI.checkOneElementVisible(o),c=Object.assign({},a);if(c.visible!==this._previousVideoVisibleStatus){this._previousVideoVisibleStatus=c.visible;const d=Et.reportApiInvoke(null,{tag:Je.TRACER,name:_n.LOCAL_VIDEO_TRACK_GET_VIDEO_VISIBLE,options:[this.getTrackId()]});c.visible?d.onSuccess("Video is visible"):d.onSuccess("Invisible because of ".concat(c.reason))}return c}return}catch(i){throw new G(b.GET_VIDEO_ELEMENT_VISIBLE_ERROR,i.message)}}async renewMediaStreamTrack(e){}pipe(e){if(this.processor===e)return e;if(e._source)throw new G(b.INVALID_OPERATION,"Processor ".concat(e.name," already piped, please call unpipe beforehand."));return this.unpipe(),this.processor=e,this.processor._source=this,e.updateInput({track:this._originMediaStreamTrack,context:this.processorContext}),e}unpipe(){if(!this.processor)return;const e=this.processor;this.processor._source=void 0,this.processor=void 0,e.reset()}close(){super.close(),this.unbindProcessorDestinationEvents(),this.unbindProcessorContextEvents(),this.unpipe(),this.processorDestination._source&&this.processorDestination._source.unpipe()}clone(e){let n=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1],i=this._encoderConfig;e&&(i=Fe(Fe({},i),Ho(e))),i=xa(i);const r=be(8,"track-video-cloned-"),o=new cP(n?this._mediaStreamTrack.clone():this._mediaStreamTrack,i,xa(this._scalabilityMode),this._optimizationMode,r,xa(this._hints));return e&&i&&o.setEncoderConfiguration(i),E.debug("clone video track from ".concat(this.getTrackId()," to ").concat(r,", clone ").concat(n)),o}async replaceTrack(e,n){if(!(e instanceof MediaStreamTrack))throw new G(b.INVALID_PARAMS,"track should be an instance of MediaStreamTrack");if(e.kind!=="video")throw new G(b.INVALID_PARAMS,"track should be a video MediaStreamTrack");await this._updateOriginMediaStreamTrack(e,n,!0),this.updateMediaStreamTrackResolution()}startMonitorStats(){if(!An()&&!Qn())return;this._statsTimer&&window.clearInterval(this._statsTimer);let e=2,n=Tf[e],i=-1,r=Date.now();const o=s=>{s>2||s<0||(r=Date.now(),n=Tf[s],this.setSenderConfiguration(n))};this.isUseScaleResolutionDownBy=!0,this._statsTimer=window.setInterval(()=>{const s=this.getStats(),a=Gi(this,ut.GET_RTC_STATS);if(s.sendPackets>0&&a){i===-1&&(i=Date.now());const c=Date.now();if(c-i<1e3||c-r<N("PROFILE_SWITCH_INTERVAL"))return;const d=s.sendFrameRate,u=.6*n.frameRate,l=.9*n.frameRate;typeof d=="number"&&d>0&&d<u?e>0&&(e--,o(e),E.debug("[".concat(this.getTrackId(),"] step down for fps ").concat(d,", switchProfile to ").concat(e))):a.OutgoingAvailableBandwidth<n.bitrateMin?e>0&&(e--,o(e),E.debug("[".concat(this.getTrackId(),"] step down for OutgoingAvailableBandwidth ").concat(a.OutgoingAvailableBandwidth,", bitrateMin ").concat(n.bitrateMin,", switchProfile to ").concat(e))):typeof d=="number"&&d>l&&e<Tf.length-1&&a.OutgoingAvailableBandwidth>1.2*Tf[e+1].bitrateMin&&(e++,o(e),E.debug("[".concat(this.getTrackId(),"] step up for fps ").concat(d,", OutgoingAvailableBandwidth ").concat(a.OutgoingAvailableBandwidth,", switchProfile to ").concat(e)))}},N("CHECK_LOCAL_STATS_INTERVAL"))}sendSeiData(e){if(Hs(()=>{Et.reportApiInvoke(null,{name:_n.LOCAL_VIDEO_SEND_SEI_DATA,options:[],tag:Je.TRACER}).onSuccess("")},this._mediaStreamTrack.id||this.getTrackId()),!N("ENABLE_VIDEO_SEI")||!N("ENABLE_ENCODED_TRANSFORM"))return void E.warning('To send/receive SEI, please call AgoraRTC.setParameter("ENABLE_VIDEO_SEI", true) before instantiate IAgoraRtcClient');if(e instanceof Uint8Array==0)return new G(b.INVALID_PARAMS,"Invalid argument type, ILocalVideoTrack.sendSeiData() only accept Uint8Array argument.").throw();const n=this.getRTCRtpTransceiver();if(!n)return void E.warning("Video track is not published, SEI can not be send");const i=n.sender.getParameters();if(i.codecs.length===0)return;const r=i.codecs[0].mimeType.toLocaleLowerCase();r==="video/h264"?this.safeEmit("sei-to-send",e):E.warning("SEI is not supported by ".concat(r))}bindProcessorDestinationEvents(){this.processorDestination.on(Si.ON_TRACK,async e=>{e?e!==this._mediaStreamTrack&&(this._mediaStreamTrack=e,this._updatePlayerSource(),await Ie(this,ut.NEED_REPLACE_TRACK,this)):this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource(),await Ie(this,ut.NEED_REPLACE_TRACK,this))})}unbindProcessorDestinationEvents(){this.processorDestination.removeAllListeners(Si.ON_TRACK)}unbindProcessorContextEvents(){this.processorContext.removeAllListeners(er.REQUEST_UPDATE_CONSTRAINTS),this.processorContext.removeAllListeners(er.REQUEST_CONSTRAINTS)}},Jt(qt.prototype,"play",[wO,OO],Object.getOwnPropertyDescriptor(qt.prototype,"play"),qt.prototype),Jt(qt.prototype,"stop",[NO],Object.getOwnPropertyDescriptor(qt.prototype,"stop"),qt.prototype),Jt(qt.prototype,"setEnabled",[DO,PO,LO],Object.getOwnPropertyDescriptor(qt.prototype,"setEnabled"),qt.prototype),Jt(qt.prototype,"setMuted",[kO,MO,UO],Object.getOwnPropertyDescriptor(qt.prototype,"setMuted"),qt.prototype),Jt(qt.prototype,"setEncoderConfiguration",[xO,VO],Object.getOwnPropertyDescriptor(qt.prototype,"setEncoderConfiguration"),qt.prototype),Jt(qt.prototype,"getStats",[FO],Object.getOwnPropertyDescriptor(qt.prototype,"getStats"),qt.prototype),Jt(qt.prototype,"setBeautyEffect",[jO,BO],Object.getOwnPropertyDescriptor(qt.prototype,"setBeautyEffect"),qt.prototype),Jt(qt.prototype,"getCurrentFrameData",[GO],Object.getOwnPropertyDescriptor(qt.prototype,"getCurrentFrameData"),qt.prototype),Jt(qt.prototype,"getCurrentFrameImage",[WO],Object.getOwnPropertyDescriptor(qt.prototype,"getCurrentFrameImage"),qt.prototype),Jt(qt.prototype,"setBitrateLimit",[HO],Object.getOwnPropertyDescriptor(qt.prototype,"setBitrateLimit"),qt.prototype),Jt(qt.prototype,"setOptimizationMode",[KO],Object.getOwnPropertyDescriptor(qt.prototype,"setOptimizationMode"),qt.prototype),Jt(qt.prototype,"setScalabiltyMode",[qO],Object.getOwnPropertyDescriptor(qt.prototype,"setScalabiltyMode"),qt.prototype),Jt(qt.prototype,"updateMediaStreamTrackResolution",[YO],Object.getOwnPropertyDescriptor(qt.prototype,"updateMediaStreamTrackResolution"),qt.prototype),Jt(qt.prototype,"pipe",[zO],Object.getOwnPropertyDescriptor(qt.prototype,"pipe"),qt.prototype),Jt(qt.prototype,"unpipe",[JO],Object.getOwnPropertyDescriptor(qt.prototype,"unpipe"),qt.prototype),Jt(qt.prototype,"close",[XO],Object.getOwnPropertyDescriptor(qt.prototype,"close"),qt.prototype),Jt(qt.prototype,"replaceTrack",[QO],Object.getOwnPropertyDescriptor(qt.prototype,"replaceTrack"),qt.prototype),Jt(qt.prototype,"startMonitorStats",[ZO],Object.getOwnPropertyDescriptor(qt.prototype,"startMonitorStats"),qt.prototype),qt),yT=($O=Ct({argsMap:(t,e)=>[t.getTrackId(),e]}),t0=on(),e0=td("CameraVideoTrack","_enabledMutex"),n0=Ct({argsMap:(t,e)=>[t.getTrackId(),e]}),i0=on(),r0=Ct({argsMap:(t,e)=>[t.getTrackId(),e]}),o0=on(),s0=Ct({argsMap:t=>[t.getTrackId()]}),sr=class dP extends Ae{get __className__(){return"CameraVideoTrack"}constructor(e,n,i,r,o,s){super(e,Ho(n.encoderConfig),r,o,s),W(this,"_config",void 0),W(this,"_originalConstraints",void 0),W(this,"_constraints",void 0),W(this,"_enabled",!0),W(this,"_deviceName","default"),W(this,"tryResumeVideoForIOS15_16WeChat",async()=>{(Qc()||Bm())&&!function(){const a=Zt();if(a.os!==bn.IOS||!a.osVersion)return!1;const c=a.osVersion.split(".");return Number(c[0])===15&&Number(c[1])>=2}()&&FI()&&this._enabled&&!this._isClosed&&(E.debug("[".concat(this.getTrackId(),"] try capture camera media device for interrupted iOS 15 device on WeChat.")),await this.renewMediaStreamTrack())}),this._config=n,this._originalConstraints=i,this._constraints=i,this._deviceName=e.label,this._encoderConfig=Ho(this._config.encoderConfig),Ee.on(jn.IOS_15_16_INTERRUPTION_END,this.tryResumeVideoForIOS15_16WeChat),Ee.on(jn.IOS_INTERRUPTION_END,this.tryResumeVideoForIOS15_16WeChat),this.bindProcessorContextEvents()}async setDevice(e){return typeof e=="string"?this._setDeviceById(e):e.deviceId?this._setDeviceById(e.deviceId):e.facingMode?this._setDeviceByFacingModel(e.facingMode):void 0}async _setDeviceById(e){if(E.info("[".concat(this.getTrackId(),"] set device to ").concat(e)),this._enabled)try{const n=await rr.getDeviceById(e),i={};i.video=Fe({},this._constraints),i.video.deviceId={exact:e},i.video.facingMode=void 0,this._originMediaStreamTrack.stop();let r=null;try{r=await ir(i,this.getTrackId())}catch(o){throw E.error("[".concat(this.getTrackId(),"] setDevice failed"),o.toString()),r=await ir({video:this._constraints},this.getTrackId()),await this._updateOriginMediaStreamTrack(r.getVideoTracks()[0],!1),o}await this._updateOriginMediaStreamTrack(r.getVideoTracks()[0],!1),this.updateMediaStreamTrackResolution(),this._deviceName=n.label,this._config.cameraId=e,this._constraints.deviceId={exact:e}}catch(n){throw E.error("[".concat(this.getTrackId(),"] setDevice error"),n.toString()),n}else try{const n=await rr.getDeviceById(e);this._deviceName=n.label,this._config.cameraId=e,this._constraints.deviceId={exact:e}}catch(n){throw E.error("[".concat(this.getTrackId(),"] setDevice error"),n.toString()),n}E.info("[".concat(this.getTrackId(),"] setDevice success"))}async _setDeviceByFacingModel(e){E.info("[".concat(this.getTrackId(),"] set facingMode ").concat(e));const n={video:Fe(Fe({},this._constraints),{},{deviceId:void 0,facingMode:{exact:e}})};if(this._enabled){this._originMediaStreamTrack.stop();let i=null;try{i=await ir(n,this.getTrackId())}catch(r){throw E.error("[".concat(this.getTrackId(),"] setDeviceByFacingModel failed"),r.toString()),i=await ir({video:this._constraints},this.getTrackId()),await this._updateOriginMediaStreamTrack(i.getVideoTracks()[0],!1),r}await this._updateOriginMediaStreamTrack(i.getVideoTracks()[0],!1),this.updateMediaStreamTrackResolution()}this._deviceName="",this._config.facingMode=e,this._config.cameraId=void 0,this._constraints=Fe({},n.video),E.info("[".concat(this.getTrackId(),"] setDeviceByFacingModel success"))}async setEnabled(e,n){if(!n){if(e===this._enabled)return;this.stateCheck("enabled",e)}if(E.info("[".concat(this.getTrackId(),"] start setEnabled"),e),e){try{if(this.isExternalTrack)this._originMediaStreamTrack.enabled=!0;else{const i=await ir({video:this._constraints},this.getTrackId());await this._updateOriginMediaStreamTrack(i.getVideoTracks()[0],!1)}await Ie(this,ut.NEED_ENABLE_TRACK,this)}catch(i){throw E.error("[".concat(this.getTrackId(),"] setEnabled true error"),i.toString()),i}this.updateMediaStreamTrackResolution(),E.info("[".concat(this.getTrackId(),"] setEnabled to true success")),n||(this._enabled=!0)}else{this.isExternalTrack?this._originMediaStreamTrack.enabled=!1:(this._originMediaStreamTrack.onended=null,this._originMediaStreamTrack.stop()),n||(this._enabled=!1);try{await Ie(this,ut.NEED_DISABLE_TRACK,this)}catch(i){throw E.error("[".concat(this.getTrackId(),"] setEnabled to false error"),i.toString()),i}E.info("[".concat(this.getTrackId(),"] setEnabled to false success"))}}async setEncoderConfiguration(e,n){if(!this._enabled)throw new G(b.TRACK_IS_DISABLED,"can not set encoder configuration when track is disabled");e==="720p_auto"?this.startMonitorStats():this._statsTimer&&(window.clearInterval(this._statsTimer),this._statsTimer=null),e=Ho(e),this._forceBitrateLimit&&(e.bitrateMax=this._forceBitrateLimit.max_bitrate||e.bitrateMax,e.bitrateMin=this._forceBitrateLimit.min_bitrate||e.bitrateMin);const i=Ne(this._config);i.encoderConfig=e;const r=yf(i);(An()||Qn()||Lr())&&(r.deviceId=void 0),E.debug("[".concat(this.getTrackId(),"] setEncoderConfiguration applyConstraints"),JSON.stringify(e),JSON.stringify(r));try{await this._originMediaStreamTrack.applyConstraints(r),this.updateMediaStreamTrackResolution()}catch(o){const s=new G(b.UNEXPECTED_ERROR,o.toString());throw E.error("[".concat(this.getTrackId(),"] applyConstraints error"),s.toString()),s}this._config=i,this._constraints=r,this._originalConstraints=r,this._encoderConfig=e,this._hints.indexOf(De.SCREEN_TRACK)===-1&&this.updateBitrateFromProfile();try{await Ie(this,ut.NEED_UPDATE_VIDEO_ENCODER,this)}catch(o){return o.throw(E)}}_getDefaultPlayerConfig(){return{mirror:!0,fit:"cover"}}onTrackEnded(){if((Qn()||Lr())&&this._enabled&&!this._isClosed&&Ee.duringInterruption){const e=async()=>{Ee.off(jn.IOS_INTERRUPTION_END,e),this._enabled&&!this._isClosed&&(E.debug("[".concat(this.getTrackId(),"] try capture camera media device for interrupted iOS device.")),await this.setEnabled(!1),await this.setEnabled(!0))};Ee.on(jn.IOS_INTERRUPTION_END,e)}else E.debug("[".concat(this.getTrackId(),"] track ended")),this.safeEmit(yd.TRACK_ENDED)}async renewMediaStreamTrack(e){const n=e||this._constraints,i=rr.searchDeviceIdByName(this._deviceName);if(i&&!n.deviceId&&(n.deviceId={exact:i}),this._enabled){const r=await ir({video:n},this.getTrackId());this._constraints=n,await this._updateOriginMediaStreamTrack(r.getVideoTracks()[0],!0),this.updateMediaStreamTrackResolution()}}close(){super.close(),Ee.off(jn.IOS_15_16_INTERRUPTION_END,this.tryResumeVideoForIOS15_16WeChat),Ee.off(jn.IOS_INTERRUPTION_END,this.tryResumeVideoForIOS15_16WeChat)}clone(e){let n=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1],i=this._encoderConfig;e&&(i=Fe(Fe({},i),Ho(e))),i=xa(i);const r=be(8,"track-cam-cloned-"),o=new dP(n?this._mediaStreamTrack.clone():this._mediaStreamTrack,xa(Fe(Fe({},this._config),{},{encoderConfig:i})),xa(this._constraints),xa(this._scalabilityMode),this._optimizationMode,r);return e&&i&&o.setEncoderConfiguration(i),E.debug("clone track from ".concat(this.getTrackId()," to ").concat(r,", clone ").concat(n)),o}bindProcessorContextEvents(){this.processorContext.on(er.REQUEST_UPDATE_CONSTRAINTS,async(e,n,i)=>{try{const r=Object.assign({},this._originalConstraints,...e);await this.renewMediaStreamTrack(r),n()}catch(r){i(r)}}),this.processorContext.on(er.REQUEST_CONSTRAINTS,async e=>{e(this._originMediaStreamTrack.getSettings())})}},Jt(sr.prototype,"setDevice",[$O,t0],Object.getOwnPropertyDescriptor(sr.prototype,"setDevice"),sr.prototype),Jt(sr.prototype,"setEnabled",[e0,n0,i0],Object.getOwnPropertyDescriptor(sr.prototype,"setEnabled"),sr.prototype),Jt(sr.prototype,"setEncoderConfiguration",[r0,o0],Object.getOwnPropertyDescriptor(sr.prototype,"setEncoderConfiguration"),sr.prototype),Jt(sr.prototype,"close",[s0],Object.getOwnPropertyDescriptor(sr.prototype,"close"),sr.prototype),sr);function IT(t,e,n,i){n.optimizationMode&&(i&&i.width&&i.height?(n.encoderConfig=Fe(Fe({},i),{},{bitrateMin:i.bitrateMin,bitrateMax:i.bitrateMax}),n.optimizationMode!=="motion"&&n.optimizationMode!=="detail"||(e.contentHint=n.optimizationMode,e.contentHint===n.optimizationMode?E.debug("[".concat(t,"] set content hint to"),n.optimizationMode):E.debug("[".concat(t,"] set content hint failed")))):E.warning("[".concat(t,"] can not apply optimization mode bitrate config, no encoderConfig")))}var a0,c0,d0,u0,gr,l0,h0,p0,f0,_0,E0,ui;class m0 extends vw{getUserId(){return this._userId}constructor(e,n,i,r){super(e,"track-".concat(e.kind,"-").concat(n,"-").concat(r.clientId,"_").concat(be(5,""))),W(this,"_userId",void 0),W(this,"_uintId",void 0),W(this,"_isDestroyed",!1),W(this,"store",void 0),W(this,"processor",void 0),W(this,"processorContext",void 0),this._userId=n,this._uintId=i,this.store=r}_updateOriginMediaStreamTrack(e){this._originMediaStreamTrack=e,this._mediaStreamTrack=e,this._updatePlayerSource(),this.processor&&this.processor.updateInput({track:this._originMediaStreamTrack,context:this.processorContext})}_destroy(){this._isDestroyed=!0,E.info("[".concat(this.getTrackId(),"] is destroyed")),this.stop(),super.close()}getProcessorStats(){return this.processorContext.gatherStats()}getProcessorUsage(){return this.processorContext.gatherUsage()}}let Od=(a0=Ct({argsMap:(t,e,n)=>[t.getTrackId(),typeof e=="string"?e:e instanceof HTMLVideoElement?"HTMLVideoElement":"HTMLElement",n]}),c0=Ct({argsMap:t=>[t.getTrackId()]}),d0=Ct({argsMap:(t,e)=>[t.getTrackId(),e.name]}),u0=Ct({argsMap:t=>[t.getTrackId()]}),Jt((gr=class extends m0{get isPlaying(){return!(!this._player||this._player.videoElementStatus!==di.PLAYING)}get __className__(){return"RemoteVideoTrack"}constructor(t,e,n,i){super(t,e,n,i),W(this,"_videoVisibleTimer",null),W(this,"_previousVideoVisibleStatus",void 0),W(this,"_clearPreviousVideoVisibleStatus",()=>this._previousVideoVisibleStatus=void 0),W(this,"trackMediaType","video"),W(this,"_videoWidth",void 0),W(this,"_videoHeight",void 0),W(this,"_player",void 0),W(this,"processorDestination",void 0),W(this,"processorContext",void 0),this.updateMediaStreamTrackResolution(),this.processorContext=new Mw(this.getTrackId(),"remote"),this.processorDestination=new kw(this.processorContext),this.bindProcessorDestinationEvents()}getStats(){return Hs(()=>{E.warning("[deprecated] RemoteVideoTrack.getStats will be removed in the future, use AgoraRTCClient.getRemoteVideoStats instead")},"remoteVideoTrackGetStatsWarning"),Gi(this,ut.GET_STATS)||Fe({},Rw)}play(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(typeof t=="string"){const i=document.getElementById(t);i?t=i:(E.warning("[".concat(this.getTrackId(),'] can not find "#').concat(t,'" element, use document.body')),t=document.body)}E.debug("[".concat(this.getTrackId(),"] start video playback in ").concat(t instanceof HTMLVideoElement?"HTMLVideoElement":"HTMLElement"),JSON.stringify(e));const n=Fe(Fe({fit:"cover"},e),{},{trackId:this.getTrackId(),element:t});this._player?this._player.updateConfig(n):(t instanceof HTMLVideoElement?this._player=new vT(n):this._player=new AO(n),this._player.updateVideoTrack(this._mediaStreamTrack),this._player.onFirstVideoFrameDecoded=()=>{this.store.subscribe(this.getUserId(),"video",void 0,void 0,Date.now()),this.safeEmit(Id.FIRST_FRAME_DECODED)},this._player.onVideoStateChanged=i=>{this.safeEmit(Id.VIDEO_STATE_CHANGED,i)}),this._player.play(this.store.sessionId||void 0),this._videoVisibleTimer&&window.clearInterval(this._videoVisibleTimer),this._clearPreviousVideoVisibleStatus(),this._videoVisibleTimer=window.setInterval(()=>{try{const i=this.getVideoElementVisibleStatus();this.safeEmit(Id.VIDEO_ELEMENT_VISIBLE_STATUS,i)}catch{}},N("CHECK_VIDEO_VISIBLE_INTERVAL"))}stop(){this._player&&(this._videoVisibleTimer&&(window.clearInterval(this._videoVisibleTimer),this._videoVisibleTimer=null),this._clearPreviousVideoVisibleStatus(),this._player.destroy(),this._player=void 0,E.debug("[".concat(this.getTrackId(),"] stop video playback")))}getCurrentFrameData(){return this._player?this._player.getCurrentFrame():new ImageData(2,2)}updateMediaStreamTrackResolution(){Vw(this._originMediaStreamTrack).then(t=>{let[e,n]=t;this._videoHeight=n,this._videoWidth=e}).catch(Mp)}_updatePlayerSource(){E.debug("[".concat(this.getTrackId(),"] update player source track")),this._player&&this._player.updateVideoTrack(this._mediaStreamTrack)}getVideoElementVisibleStatus(){try{var t,e;const n=this==null||(t=this._player)===null||t===void 0?void 0:t.getContainerElement(),i={track:this,element:this==null||(e=this._player)===null||e===void 0?void 0:e.getVideoElement(),slot:n==null?void 0:n.parentElement},{element:r,slot:o}=i;if(this.isPlaying&&r instanceof HTMLVideoElement&&o instanceof HTMLElement){const s=KI.checkOneElementVisible(r),a=Object.assign({},s);if(a.visible!==this._previousVideoVisibleStatus){this._previousVideoVisibleStatus=a.visible;const c=Et.reportApiInvoke(null,{tag:Je.TRACER,name:_n.REMOTE_VIDEO_TRACK_GET_VIDEO_VISIBLE,options:[this.getTrackId()]});a.visible?c.onSuccess("Video is visible"):c.onSuccess("Invisible because of ".concat(a.reason))}return a}return}catch(n){throw new G(b.GET_VIDEO_ELEMENT_VISIBLE_ERROR,n.message)}}pipe(t){if(this.processor===t)return t;if(t._source)throw new G(b.INVALID_OPERATION,"Processor ".concat(t.name," already piped, please call unpipe beforehand."));return this.unpipe(),this.processor=t,this.processor._source=this,t.updateInput({track:this._originMediaStreamTrack,context:this.processorContext}),t}unpipe(){if(!this.processor)return;const t=this.processor;this.processor._source=void 0,this.processor=void 0,t.reset()}bindProcessorDestinationEvents(){this.processorDestination.on(Si.ON_TRACK,async t=>{t?t!==this._mediaStreamTrack&&(this._mediaStreamTrack=t,this._updatePlayerSource()):this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource())})}unbindProcessorDestinationEvents(){this.processorDestination.removeAllListeners(Si.ON_TRACK)}_destroy(){super._destroy(),this.unbindProcessorDestinationEvents()}_onSei(t){this.emit($a.SEI_RECEIVED,t)}}).prototype,"play",[a0],Object.getOwnPropertyDescriptor(gr.prototype,"play"),gr.prototype),Jt(gr.prototype,"stop",[c0],Object.getOwnPropertyDescriptor(gr.prototype,"stop"),gr.prototype),Jt(gr.prototype,"pipe",[d0],Object.getOwnPropertyDescriptor(gr.prototype,"pipe"),gr.prototype),Jt(gr.prototype,"unpipe",[u0],Object.getOwnPropertyDescriptor(gr.prototype,"unpipe"),gr.prototype),gr),Nd=(l0=Ct({argsMap:(t,e)=>[t.getTrackId(),e],throttleTime:300}),h0=Ct({argsMap:(t,e)=>[t.getTrackId(),e]}),p0=Ct({argsMap:t=>[t.getTrackId()]}),f0=Ct({argsMap:t=>[t.getTrackId()]}),_0=Ct({argsMap:(t,e)=>[t.getTrackId(),e.name]}),E0=Ct({argsMap:t=>[t.getTrackId()]}),Jt((ui=class extends m0{get isPlaying(){return this._useAudioElement?bi.isPlaying(this.getTrackId()):this._source.isPlayed}get __className__(){return"RemoteAudioTrack"}constructor(t,e,n,i){super(t,e,n,i),W(this,"trackMediaType","audio"),W(this,"_source",void 0),W(this,"_useAudioElement",!0),W(this,"_volume",100),W(this,"processorContext",void 0),W(this,"processorDestination",void 0),W(this,"_played",!1),W(this,"_bypassWebAudio",!1),N("DISABLE_WEBAUDIO")?(this._source=new RT,this._bypassWebAudio=!0,this._useAudioElement=!0):(this._source=new Aw(t,!0),N("REMOTE_AUDIO_TRACK_USES_WEB_AUDIO")&&(this._useAudioElement=!1)),this._source.once(tr.RECEIVE_TRACK_BUFFER,()=>{this.safeEmit(Id.FIRST_FRAME_DECODED)}),this.processorContext=new xw(this._source.context,this.getTrackId(),"remote"),this.processorDestination=new Uw(this.processorContext),this.bindProcessorDestinationEvents(),this._source.on(tr.UPDATE_SOURCE,()=>{this.processor&&this.processor.updateInput({node:this._source.processSourceNode,context:this.processorContext})})}setAudioFrameCallback(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:4096;if(!t)return this._source.removeAllListeners(tr.ON_AUDIO_BUFFER),void this._source.stopGetAudioBuffer();this._source.startGetAudioBuffer(e),this._source.removeAllListeners(tr.ON_AUDIO_BUFFER),this._source.on(tr.ON_AUDIO_BUFFER,n=>t(n))}setVolume(t){this._volume=t,this._useAudioElement?bi.setVolume(this.getTrackId(),t):this._source.setVolume(t/100)}async setPlaybackDevice(t){if(!this._useAudioElement||!gw())throw new G(b.NOT_SUPPORTED,"your browser does not support setting the audio output device");await bi.setSinkID(this.getTrackId(),t)}getVolumeLevel(){return this._source.getAccurateVolumeLevel()}getStats(){return Hs(()=>{E.warning("[deprecated] RemoteAudioTrack.getStats will be removed in the future, use AgoraRTCClient.getRemoteAudioStats instead")},"remoteAudioTrackGetStatsWarning"),Gi(this,ut.GET_STATS)||Fe({},Sw)}play(){E.debug("[".concat(this.getTrackId(),"] start audio playback")),this._played=!0,this._useAudioElement?(E.debug("[".concat(this.getTrackId(),"] use audio element to play")),bi.play(this._mediaStreamTrack,this.getTrackId(),this._volume,this.store.sessionId||void 0)):this._source.play()}stop(){E.debug("[".concat(this.getTrackId(),"] stop audio playback")),this._played=!1,this._useAudioElement?bi.stop(this.getTrackId()):this._source.stop()}_destroy(){super._destroy(),this._played=!1,this.unbindProcessorDestinationEvents(),this._source.destroy()}_isFreeze(){return this._source.isFreeze}_updatePlayerSource(){let t=!(arguments.length>0&&arguments[0]!==void 0)||arguments[0];E.debug("[".concat(this.getTrackId(),"] update player source track")),t&&this._source.updateTrack(this._mediaStreamTrack),this._useAudioElement&&bi.updateTrack(this.getTrackId(),this._mediaStreamTrack)}pipe(t){if(this._bypassWebAudio)throw new G(b.NOT_SUPPORTED,"can not pipe extension when WebAudio disabled");if(this.processor===t)return t;if(t._source)throw new G(b.INVALID_OPERATION,"Processor ".concat(t.name," already piped, please call unpipe beforehand."));return this.unpipe(),this.processor=t,this.processor._source=this,t.updateInput({track:this._originMediaStreamTrack,node:this._source.processSourceNode,context:this.processorContext}),t}unpipe(){var t;if(this._bypassWebAudio)throw new G(b.NOT_SUPPORTED,"can not unpipe extension when WebAudio disabled");if(!this.processor)return;const e=this.processor;(t=this._source.processSourceNode)===null||t===void 0||t.disconnect(),this.processor._source=!1,this.processor=void 0,e.reset()}bindProcessorDestinationEvents(){this.processorDestination.on(Si.ON_TRACK,async t=>{t?t!==this._mediaStreamTrack&&(this._mediaStreamTrack=t,this._updatePlayerSource(!1),this._source.processedNode=this._source.createMediaStreamSourceNode(t)):this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource())}),this.processorDestination.on(Si.ON_NODE,t=>{this._source.processedNode=t;const e=!t;this._useAudioElement!==e&&(this._played?(this.stop(),this._useAudioElement=e,this.play()):this._useAudioElement=e)})}unbindProcessorDestinationEvents(){this.processorDestination.removeAllListeners(Si.ON_TRACK),this.processorDestination.removeAllListeners(Si.ON_NODE)}}).prototype,"setVolume",[l0],Object.getOwnPropertyDescriptor(ui.prototype,"setVolume"),ui.prototype),Jt(ui.prototype,"setPlaybackDevice",[h0],Object.getOwnPropertyDescriptor(ui.prototype,"setPlaybackDevice"),ui.prototype),Jt(ui.prototype,"play",[p0],Object.getOwnPropertyDescriptor(ui.prototype,"play"),ui.prototype),Jt(ui.prototype,"stop",[f0],Object.getOwnPropertyDescriptor(ui.prototype,"stop"),ui.prototype),Jt(ui.prototype,"pipe",[_0],Object.getOwnPropertyDescriptor(ui.prototype,"pipe"),ui.prototype),Jt(ui.prototype,"unpipe",[E0],Object.getOwnPropertyDescriptor(ui.prototype,"unpipe"),ui.prototype),ui);const Cs=new class extends Ve{get visibility(){return document.visibilityState}get lastHiddenTime(){return this._lastHiddenTime}get lastVisibleTime(){return this._lastVisibleTime}constructor(){super(),W(this,"_lastHiddenTime",0),W(this,"_lastVisibleTime",0),document.addEventListener("visibilitychange",()=>{document.visibilityState==="hidden"?this._lastHiddenTime=performance.now():this._lastVisibleTime=performance.now(),E.debug("document visibility went ".concat(document.visibilityState)),this.emit("VISIBILITY_CHANGE",document.visibilityState)})}};var g0=function(t){return t[t.ONE_BYTE=0]="ONE_BYTE",t[t.TWO_BYTE=1]="TWO_BYTE",t}(g0||{});class UW{constructor(){W(this,"_sequence",0),W(this,"_startTime",Date.now()),W(this,"isUseOneByte",!0)}get startTime(){const e=Date.now()-this._startTime;return e<Math.pow(2,16)?e:(this._startTime+=Math.pow(2,16),this.startTime)}get sequence(){return this._sequence<Math.pow(2,32)?this._sequence++:(this._sequence-=Math.pow(2,32),this.sequence)}serialize(e){const n={commonPacketHeader:{length:0,reserved:0,extension:0,sequence:this.sequence},commonStreamHeader:this.startTime,extension:void 0,payload:e};if(e.byteLength>128){const a=new Uint8Array(4);a.set([1,0,0,0]);const c={id:0,length:4,data:a.buffer},d={profile:this.isUseOneByte?0:1,length:this.isUseOneByte?5:6,datas:[c]};n.commonPacketHeader.extension=1,n.extension=d,n.payload=this.compress(e),n.commonPacketHeader.length=8+(n.extension.length+2)+n.payload.byteLength}else n.commonPacketHeader.length=8+n.payload.byteLength;N("SHOW_DATASTREAM2_LOG")&&E.debug("send data header: ".concat(JSON.stringify(n.commonPacketHeader)));const i=new ArrayBuffer(n.commonPacketHeader.length),r=new Uint8Array(i),o=new DataView(i);let s=0;if(o.setUint16(s,n.commonPacketHeader.extension<<15|n.commonPacketHeader.reserved<<14|n.commonPacketHeader.length,!0),s+=2,o.setUint32(s,n.commonPacketHeader.sequence,!0),s+=4,o.setUint16(s,n.commonStreamHeader,!0),s+=2,n.extension){const a=this.serializeExtension(n.extension);r.set(new Uint8Array(a),s),s+=a.byteLength}if(r.set(new Uint8Array(n.payload),s),s+=n.payload.byteLength,s!==n.commonPacketHeader.length)throw Error("serialize error!");return i}deserialize(e){if(e.byteLength<4)return new ArrayBuffer(0);const n=new DataView(e);let i=0;const r=n.getUint16(i,!0);i+=2;const o={length:16383&r,reserved:(16384&r)>>14,extension:(32768&r)>>15,sequence:n.getUint16(i+2,!0)<<16|n.getUint16(i,!0)};let s,a;if(i+=4,N("SHOW_DATASTREAM2_LOG")&&E.debug("receive data header: ".concat(JSON.stringify(o))),n.getUint16(i,!0),i+=2,o.extension){a=this.deserializeExtension(e.slice(i)),i+=2+a.length,s=e.slice(i);let c=!1;if(a.datas.length>0){const d=a.datas.find(u=>u.id===0);d&&(c=(1&new DataView(d.data).getUint32(0,!0))==1)}s=c?this.decompress(s):s}else s=e.slice(8);return s}serializeExtension(e){const{profile:n,length:i,datas:r}=e,o=new ArrayBuffer(i+2),s=new Uint8Array(o),a=new DataView(o);let c=0;if(a.setUint8(c++,n),a.setUint8(c++,i),r.forEach(d=>{n?(a.setUint8(c++,d.id),a.setUint8(c++,d.length),s.set(new Uint8Array(d.data),c),c+=d.data.byteLength):(a.setUint8(c++,d.id|d.length<<4),s.set(new Uint8Array(d.data),c),c+=d.data.byteLength)}),c!==i+2)throw Error("serialize extension error, is ".concat(c,"!==").concat(i+2));return o}deserializeExtension(e){const n=new DataView(e);let i=0;const r=n.getUint8(i);i++;const o=n.getUint8(i);i++;const s=r===g0.TWO_BYTE,a=[],c=new DataView(e,2);let d=0;for(;d<o;){let u=0,l=0,p=new ArrayBuffer(0);s?(u=c.getUint8(d),d++,l=c.getUint8(d),d++):(u=15&c.getUint8(d),l=c.getUint8(d)>>4,d++),l>0&&(p=c.buffer.slice(d+2,d+2+l),d+=p.byteLength),a.push({id:u,length:l,data:p})}if(d!==o)throw Error("parse error");return{profile:r,length:o,datas:a}}decompress(e){return RW(new Uint8Array(e))}compress(e){return SW(new Uint8Array(e))}}class T0 extends Ve{constructor(e,n){super(),W(this,"_version",1),W(this,"_type",3),W(this,"_config",void 0),W(this,"_originDataChannel",void 0),W(this,"_dataStreamPacketHeader",new ArrayBuffer(4)),W(this,"_dataStreamPacketHandler",void 0),W(this,"_datachannelEventMap",new Map),this._config=e,n&&(this._originDataChannel=n,this._bandDataChannelEvents(n)),this._initPacketHeader(),this._dataStreamPacketHandler=new UW}get id(){return this._config.id}get ordered(){return this._config.ordered}get maxRetransmits(){return N("DATASTREAM_MAX_RETRANSMITS")}get metadata(){return this._config.metadata}get readyState(){var e,n;return(e=(n=this._originDataChannel)===null||n===void 0?void 0:n.readyState)!==null&&e!==void 0?e:"connecting"}get _originDataChannelId(){var e,n;return(e=(n=this._originDataChannel)===null||n===void 0?void 0:n.id)!==null&&e!==void 0?e:null}getChannelId(){return this.id}getConfig(){return this._config}_close(){this._originDataChannel&&(this._unbindDataChannelEvents(this._originDataChannel),this._originDataChannel=void 0)}async _waitTillOpen(){return new ot((e,n)=>{if(this._originDataChannel){this._originDataChannel.readyState==="open"&&e();const i=setTimeout(()=>{var r;n(new G(b.DATACHANNEL_CONNECTION_TIMEOUT,"Cannot create datachannel, id: ".concat((r=this._originDataChannel)===null||r===void 0?void 0:r.id)))},1e4);this._originDataChannel.onopen=()=>{clearTimeout(i),this._originDataChannel&&this._bandDataChannelEvents(this._originDataChannel),e()},this._originDataChannel.onerror=()=>{throw clearTimeout(i),new G(b.DATACHANNEL_CONNECTION_TIMEOUT)}}else n(new G(b.DATACHANNEL_CONNECTION_TIMEOUT,"cannot find dataChannel"))})}_updateOriginDataChannel(e){this._originDataChannel=e,this._bandDataChannelEvents(e)}_initPacketHeader(){const e=new DataView(this._dataStreamPacketHeader);e.setUint16(0,this._version),e.setUint8(2,this._type),e.setUint8(3,this._config.id)}_bandDataChannelEvents(e){this._unbindDataChannelEvents(e),[Cf.OPEN,Cf.CLOSE,Cf.ERROR].forEach(n=>{const i=()=>{this.emit(n)};this._datachannelEventMap.set(n,i),e.addEventListener(n,i)})}_unbindDataChannelEvents(e){Array.from(this._datachannelEventMap.entries()).forEach(n=>{let[i,r]=n;e.removeEventListener(i,r)}),this._datachannelEventMap.clear()}}class xW extends T0{constructor(e){super(e),W(this,"_messageListener",void 0),this._messageListener=n=>{if(n.data.byteLength<this._dataStreamPacketHeader.byteLength)throw Error("invalid byteLength: the byte length must exceed "+this._dataStreamPacketHeader.byteLength);const i=n.data.slice(0,this._dataStreamPacketHeader.byteLength),r=new DataView(i).getUint8(3);if(r!==this.id)return void(N("SHOW_DATASTREAM2_LOG")&&E.debug("invalid datachannel id: ".concat(r," !== ").concat(this.id)));let o=n.data.slice(this._dataStreamPacketHeader.byteLength);o=this._dataStreamPacketHandler.deserialize(o),this.emit(Cf.MESSAGE,o)}}_updateOriginDataChannel(e){super._updateOriginDataChannel(e),this._bandRemoteDataChannelEvents()}_close(){this._originDataChannel&&(this._originDataChannel.removeEventListener("message",this._messageListener),super._close())}_bandRemoteDataChannelEvents(){this._originDataChannel&&this._originDataChannel.addEventListener("message",this._messageListener)}}class S0 extends T0{send(e){if(this._originDataChannel){let n=e;n=this._dataStreamPacketHandler.serialize(e);const i=new Uint8Array(this._dataStreamPacketHeader.byteLength+n.byteLength);i.set(new Uint8Array(this._dataStreamPacketHeader),0),i.set(new Uint8Array(n),this._dataStreamPacketHeader.byteLength),this._originDataChannel.send(i.buffer)}}}function bf(){const t=new Blob([atob("ZnVuY3Rpb24gZShlKXtjb25zdCB0PW5ldyBEYXRhVmlldyhlLmRhdGEpO2lmKDA9PT10LmdldFVpbnQ4KDApJiYwPT09dC5nZXRVaW50OCgxKSYmMD09PXQuZ2V0VWludDgoMikmJjE9PT10LmdldFVpbnQ4KDMpJiY2PT09dC5nZXRVaW50OCg0KSl7bGV0IG49NixyPTAsbz0wO2Zvcig7MjU1PT09KG89dC5nZXRVaW50OChuKyspKTspcis9MjU1O3IrPW87Y29uc3QgYT1mdW5jdGlvbihlLHQsbil7bGV0IHI9bmV3IFVpbnQ4QXJyYXkoZSx0LG4pLG89W10sYT0wO2Zvcig7YTxuOylhKzM8biYmMD09PXJbYV0mJjA9PT1yW2ErMV0mJjM9PT1yW2ErMl0mJigwPT09clthKzNdfHwxPT09clthKzNdfHwyPT09clthKzNdfHwzPT09clthKzNdKT8oby5wdXNoKHJbYV0sclthKzFdLHJbYSszXSksYSs9NCk6KG8ucHVzaChyW2FdKSxhKyspO3JldHVybiBuZXcgVWludDhBcnJheShvKX0oZS5kYXRhLG4scik7cmV0dXJuIG5ldyBVaW50OEFycmF5KGEpfXJldHVybiBudWxsfWZ1bmN0aW9uIHQoZSx0KXtjb25zdCBuPWZ1bmN0aW9uKGUpe2NvbnN0IHQ9ZS5sZW5ndGg7bGV0IG49W10scj0wO2Zvcig7cjx0OylyKzI8dCYmMD09PWVbcl0mJjA9PT1lW3IrMV0mJigwPT09ZVtyKzJdfHwxPT09ZVtyKzJdfHwyPT09ZVtyKzJdfHwzPT09ZVtyKzJdKT8obi5wdXNoKGVbcl0sZVtyKzFdLDMsZVtyKzJdKSxyKz0zKToobi5wdXNoKGVbcl0pLHIrKyk7cmV0dXJuIG5ldyBVaW50OEFycmF5KG4pfSh0KSxyPW4ubGVuZ3RoLG89TWF0aC5mbG9vcihyLzI1NSksYT1yJTI1NSxzPW5ldyBVaW50OEFycmF5KDYrbysxK3IrZS5ieXRlTGVuZ3RoKTtzWzBdPTAsc1sxXT0wLHNbMl09MCxzWzNdPTEsc1s0XT02LHNbNV09MTAxO2xldCBpPTA7Zm9yKDtpPG87KXNbNitpXT0yNTUsaSsrO3JldHVybiBzWzYraV09YSxpKysscy5zZXQobiw2K2kpLHMuc2V0KG5ldyBVaW50OEFycmF5KGUpLDYraStyKSxzLmJ1ZmZlcn1uYXZpZ2F0b3IudXNlckFnZW50LmluZGV4T2YoIlNhZmFyaSIpPi0xJiYtMT09PW5hdmlnYXRvci51c2VyQWdlbnQuaW5kZXhPZigiQ2hyb21lIikmJihzZWxmLm9ucnRjdHJhbnNmb3JtPW49Pntjb25zdCByPW4udHJhbnNmb3JtZXI7bGV0IG89W107ci5vcHRpb25zLnBvcnQub25tZXNzYWdlPWU9PntlLmRhdGEuc2VpJiZvLnB1c2goZS5kYXRhLnNlaSl9LHNlbGYucG9zdE1lc3NhZ2UoInN0YXJ0ZWQiKTtjb25zdCBhPXIucmVhZGFibGUuZ2V0UmVhZGVyKCkscz1yLndyaXRhYmxlLmdldFdyaXRlcigpOyJyeCI9PT1yLm9wdGlvbnMubmFtZT9mdW5jdGlvbiB0KG4pe2EucmVhZCgpLnRoZW4oKHI9PntpZighci5kb25lKXtpZihyLnZhbHVlIGluc3RhbmNlb2YgUlRDRW5jb2RlZFZpZGVvRnJhbWUpe2NvbnN0IHQ9ZShyLnZhbHVlKTt0JiZuLm9wdGlvbnMucG9ydC5wb3N0TWVzc2FnZSh7c2VpOnR9KX1zLndyaXRlKHIudmFsdWUpLG4ub3B0aW9ucy5wb3J0LnBvc3RNZXNzYWdlKHt0cmFuc2Zvcm1lZDohMH0pLHQobil9fSkpfShyKToidHgiPT09ci5vcHRpb25zLm5hbWUmJmZ1bmN0aW9uIGUobil7YS5yZWFkKCkudGhlbigocj0+e2lmKCFyLmRvbmUpe2lmKHIudmFsdWUgaW5zdGFuY2VvZiBSVENFbmNvZGVkVmlkZW9GcmFtZSl7Y29uc3QgZT1vLnNoaWZ0KCk7ZSYmKHIudmFsdWUuZGF0YT10KHIudmFsdWUuZGF0YSxlKSl9cy53cml0ZShyLnZhbHVlKSxuLm9wdGlvbnMucG9ydC5wb3N0TWVzc2FnZSh7dHJhbnNmb3JtZWQ6ITB9KSxlKG4pfX0pKX0ocil9LHNlbGYucG9zdE1lc3NhZ2UoInJlZ2lzdGVyZWQiKSk7Cg==")],{type:"text/javascript"});return setTimeout(()=>NA.revokeObjectURL(t),0),new Worker(NA.createObjectURL(t))}const Af=new Map,wf=new Map,Of=new Map;async function VW(t,e){if(!zt().supportWebRTCEncodedTransform)return void E.warning("browser not support video encoded transform");if(Of.has(t)||!t.track)return;const n={track:t.track};if(Gs()){if(!t.createEncodedStreams)return void E.warning("browser not support createEncodedStreams() API");let r=null;try{r=t.createEncodedStreams()}catch(a){return void E.error("create video-encoded-streams error",a&&a.message)}let o=[];e.on("sei-to-send",a=>{o.push(a)});const s=new TransformStream({transform(a,c){n.controller||(n.controller=c),t.track&&t.track.id!==n.track.id&&(E.debug("video track changed: ".concat(n.track.id," => ").concat(t.track.id)),n.track.removeEventListener("ended",i),n.track=t.track,n.track.addEventListener("ended",i));const d=o.shift();d&&(a.data=function(u,l){const p=function(A){const k=A.length;let M=[],V=0;for(;V<k;)V+2<k&&A[V]===0&&A[V+1]===0&&(A[V+2]===0||A[V+2]===1||A[V+2]===2||A[V+2]===3)?(M.push(A[V],A[V+1],3,A[V+2]),V+=3):(M.push(A[V]),V++);return new Uint8Array(M)}(l),f=p.length,C=Math.floor(f/255),m=f%255,g=new Uint8Array(6+C+1+f+u.byteLength);g[0]=0,g[1]=0,g[2]=0,g[3]=1,g[4]=6,g[5]=101;let y=0;for(;y<C;)g[6+y]=255,y++;return g[6+y]=m,y++,g.set(p,6+y),g.set(new Uint8Array(u),6+y+f),g.buffer}(a.data,d)),c.enqueue(a)}});r.readable.pipeThrough(s).pipeTo(r.writable)}else{if(!An())return;{if(typeof RTCRtpScriptTransform=="undefined")return void E.warning("browser not support RTCRtpScriptTransform");const r=bf(),o=new MessageChannel;await new ot(a=>r.onmessage=c=>{c.data==="registered"&&a(void 0)});const s=new RTCRtpScriptTransform(r,{name:"tx",port:o.port2},[o.port2]);t.transform=s,await new ot(a=>r.onmessage=c=>{c.data==="started"&&a(void 0)}),e.on("sei-to-send",a=>{o.port1.postMessage({sei:a})}),o.port1.onmessage=a=>{var c;a.data.transformed&&t.track&&((c=t.track)===null||c===void 0?void 0:c.id)!==n.track.id&&(E.debug("video track changed: ".concat(n.track.id," => ").concat(t.track.id)),n.track.removeEventListener("ended",i),n.track=t.track,n.track.addEventListener("ended",i))},n.worker=r}}function i(){if(t.track){if(this.id!==t.track.id)return;t.track.removeEventListener("ended",i)}const r=Of.get(t);if(r){Of.delete(t);try{var o,s;(o=r.controller)===null||o===void 0||o.terminate(),(s=r.worker)===null||s===void 0||s.terminate()}catch(a){E.warning(a&&a.message)}}}Of.set(t,n),t.track.addEventListener("ended",i)}const wl=new Map;async function FW(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(!zt().supportWebRTCEncodedTransform)return void E.warning("browser not support video encoded transform");if(!t.track)return;if(wl.has(t)){const r=wl.get(t);return void(r&&(r.onSei=e.onSei))}const n={track:t.track,onSei:e.onSei};if(Gs()){if(!t.createEncodedStreams)return void E.warning("browser not support createEncodedStreams() API");let r=null;try{r=t.createEncodedStreams()}catch(s){return void E.error("create video-encoded-streams error",s&&s.message)}const o=new TransformStream({transform(s,a){n.controller||(n.controller=a),t.track&&t.track.id!==n.track.id&&(E.debug("video track changed: ".concat(n.track.id," => ").concat(t.track.id)),n.track.removeEventListener("ended",i),n.track=t.track,n.track.addEventListener("ended",i));const c=function(d){const u=new DataView(d.data);if(u.getUint8(0)===0&&u.getUint8(1)===0&&u.getUint8(2)===0&&u.getUint8(3)===1&&u.getUint8(4)===6){let l=6,p=0,f=0;for(;(f=u.getUint8(l++))===255;)p+=255;p+=f;const C=function(m,g,y){let A=new Uint8Array(m,g,y),k=[],M=0;for(;M<y;)M+3<y&&A[M]===0&&A[M+1]===0&&A[M+2]===3&&(A[M+3]===0||A[M+3]===1||A[M+3]===2||A[M+3]===3)?(k.push(A[M],A[M+1],A[M+3]),M+=4):(k.push(A[M]),M++);return new Uint8Array(k)}(d.data,l,p);return new Uint8Array(C)}return null}(s);c&&n.onSei&&n.onSei(c),a.enqueue(s)}});r.readable.pipeThrough(o).pipeTo(r.writable)}else if(An()){if(typeof RTCRtpScriptTransform=="undefined")return void E.warning("browser not support RTCRtpScriptTransform");const r=bf(),o=new MessageChannel;await new ot(a=>r.onmessage=c=>{c.data==="registered"&&a(void 0)});const s=new RTCRtpScriptTransform(r,{name:"rx",port:o.port2},[o.port2]);t.transform=s,await new ot(a=>r.onmessage=c=>{c.data==="started"&&a(void 0)}),o.port1.onmessage=a=>{var c;a.data.transformed&&t.track&&((c=t.track)===null||c===void 0?void 0:c.id)!==n.track.id?(E.debug("video track changed: ".concat(n.track.id," => ").concat(t.track.id)),n.track.removeEventListener("ended",i),n.track=t.track,n.track.addEventListener("ended",i)):a.data.sei&&n.onSei&&n.onSei(a.data.sei)},n.worker=r}function i(){if(t.track){if(this.id!==t.track.id)return;t.track.removeEventListener("ended",i)}(function(r){const o=wl.get(r);if(o){wl.delete(r);try{var s,a;(s=o.controller)===null||s===void 0||s.terminate(),(a=o.worker)===null||a===void 0||a.terminate()}catch(c){E.warning(c&&c.message)}}})(t)}wl.set(t,n),t.track.addEventListener("ended",i)}(function(){const t=Zt();Yn.getDisplayMedia=!(!navigator.mediaDevices||!navigator.mediaDevices.getDisplayMedia),Yn.getStreamFromExtension=t.name===ue.CHROME&&Number(t.version)>34,Yn.supportUnifiedPlan=function(){if(!window.RTCRtpTransceiver||!("currentDirection"in RTCRtpTransceiver.prototype))return!1;const e=new RTCPeerConnection;let n=!1;try{e.addTransceiver("audio"),n=!0}catch{}return e.close(),n}(),Yn.supportMinBitrate=t.name===ue.CHROME||t.name===ue.EDGE,Yn.supportSetRtpSenderParameters=function(){const e=Zt();return!!(window.RTCRtpSender&&window.RTCRtpSender.prototype.setParameters&&window.RTCRtpSender.prototype.getParameters)&&(!!Ws()||!(!An()&&!Dp())||e.name===ue.FIREFOX&&Number(e.version)>=64)}(),t.name===ue.SAFARI&&(Number(t.version)>=14?Yn.supportDualStream=!0:Yn.supportDualStream=!1),Yn.webAudioMediaStreamDest=function(){const e=Zt();return!(e.name===ue.SAFARI&&Number(e.version)<12)}(),Yn.supportReplaceTrack=!!window.RTCRtpSender&&typeof RTCRtpSender.prototype.replaceTrack=="function",Yn.supportWebGL=typeof WebGLRenderingContext!="undefined",Yn.supportRequestFrame=!!window.CanvasCaptureMediaStreamTrack,Ws()||(Yn.webAudioWithAEC=!0),Yn.supportShareAudio=function(){const e=Zt();return(e.os===bn.WIN_10||e.os===bn.WIN_81||e.os===bn.WIN_7||e.os===bn.LINUX||e.os===bn.MAC_OS||e.os===bn.CHROMIUM_OS)&&e.name===ue.CHROME&&Number(e.version)>=74}(),Yn.supportDataChannel=!!(jm(76)||function(e){const n=Zt();return!(n.name!==ue.FIREFOX||!n.osVersion)&&Number(n.version)>=e}(68)||PI(14)),Yn.supportPCSetConfiguration=function(){const e=window.RTCPeerConnection;return!ye()&&!!e&&e.prototype.setConfiguration instanceof Function}(),Yn.supportWebRTCEncodedTransform=function(){const e=Zt();return e.name==="Chrome"&&Number(e.version)>=86||e.name==="Safari"&&Number(e.version)>=15}(),Yn.supportWebRTCInsertableStream=function(){const e=Zt();return(e.name===ue.CHROME||e.name===ue.EDGE)&&Number(e.version)>=94&&"MediaStreamTrackGenerator"in window&&"MediaStreamTrackProcessor"in window}(),Yn.supportRequestVideoFrameCallback="requestVideoFrameCallback"in HTMLVideoElement.prototype,Yn.supportWebCrypto=typeof window!="undefined"&&window.crypto!==void 0&&window.crypto.subtle!==void 0,kp(()=>{Yn.supportDualStreamEncoding=function(){const e=Zt();return!!N("DISABLE_WEBAUDIO")||e.name==="Safari"&&Number(e.version)>=14||!!(e.name==="Chrome"&&/Windows/i.test(e.os||"")&&Number(e.version)>=100&&N("CHROME_DUAL_STREAM_USE_ENCODING"))}(),E.info("browser compatibility",JSON.stringify(Yn),JSON.stringify(t))})})();class jW extends Ve{constructor(){super(...arguments),R(this,"resultStorage",new Map)}setLocalAudioStats(e,n,i){this.record("AUDIO_INPUT_LEVEL_TOO_LOW",e,this.checkAudioInputLevel(i,n)),this.record("SEND_AUDIO_BITRATE_TOO_LOW",e,this.checkSendAudioBitrate(i,n))}setLocalVideoStats(e,n,i){this.record("SEND_VIDEO_BITRATE_TOO_LOW",e,this.checkSendVideoBitrate(i,n)),this.record("FRAMERATE_INPUT_TOO_LOW",e,this.checkFramerateInput(i,n)),this.record("FRAMERATE_SENT_TOO_LOW",e,this.checkFramerateSent(i))}setRemoteAudioStats(e,n){const i=e.getUserId();this.record("AUDIO_OUTPUT_LEVEL_TOO_LOW",i,this.checkAudioOutputLevel(n))}setRemoteVideoStats(e,n){const i=e.getUserId();this.record("RECV_VIDEO_DECODE_FAILED",i,this.checkVideoDecode(n))}record(e,n,i){if(N("STATS_UPDATE_INTERVAL")>500)return;this.resultStorage.has(e)||this.resultStorage.set(e,{result:[],isPrevNormal:!0});const r=this.resultStorage.get(e);if(r&&(r.result.push(i),r.result.length>=5)){var o;const s=it(o=r.result).call(o,!0);r.isPrevNormal&&!s&&this.emit("exception",R0[e],e,n),!r.isPrevNormal&&s&&this.emit("exception",R0[e]+2e3,e+"_RECOVER",n),r.isPrevNormal=s,r.result=[]}}checkAudioOutputLevel(e){return!(e.receiveBitrate>0&&e.receiveLevel===0)}checkAudioInputLevel(e,n){return n instanceof vn&&!n.isActive||!!n.muted||e.sendVolumeLevel!==0}checkFramerateInput(e,n){let i=null;n._encoderConfig&&n._encoderConfig.frameRate&&(i=Pi(n._encoderConfig.frameRate));const r=e.captureFrameRate;return!i||!r||!(i>10&&r<5||i<10&&i>=5&&r<=1)}checkFramerateSent(e){return!(e.captureFrameRate&&e.sendFrameRate&&e.captureFrameRate>5&&e.sendFrameRate<=1)}checkSendVideoBitrate(e,n){return!!n.muted||e.sendBitrate!==0}checkSendAudioBitrate(e,n){return n instanceof vn&&!n.isActive||!!n.muted||e.sendBitrate!==0}checkVideoDecode(e){return e.receiveBitrate===0||e.decodeFrameRate!==0}}const R0={FRAMERATE_INPUT_TOO_LOW:1001,FRAMERATE_SENT_TOO_LOW:1002,SEND_VIDEO_BITRATE_TOO_LOW:1003,RECV_VIDEO_DECODE_FAILED:1005,AUDIO_INPUT_LEVEL_TOO_LOW:2001,AUDIO_OUTPUT_LEVEL_TOO_LOW:2002,SEND_AUDIO_BITRATE_TOO_LOW:2003},$n=new class{markSubscribeStart(t,e){performance.mark("agora-web-sdk/".concat(t,"/subscribe-").concat(e))}markPublishStart(t,e){performance.mark("agora-web-sdk/".concat(t,"/publish-").concat(e))}measureFromSubscribeStart(t,e){const n=performance.getEntriesByName("agora-web-sdk/".concat(t,"/subscribe-").concat(e));if(n.length>0){const i=n[n.length-1];return Math.round(performance.now()-i.startTime)}return 0}measureFromPublishStart(t,e){const n=performance.getEntriesByName("agora-web-sdk/".concat(t,"/publish-").concat(e));if(n.length>0){const i=n[n.length-1];return Math.round(performance.now()-i.startTime)}return 0}};function bT(t,e){this.v=t,this.k=e}function Mt(t){return new bT(t,0)}var BW=aC,GW=Do;$t({target:"Promise",stat:!0,forced:!0},{withResolvers:function(){var t=GW.f(this);return{promise:t.promise,resolve:t.resolve,reject:t.reject}}});var WW=Do,HW=xc;$t({target:"Promise",stat:!0,forced:!0},{try:function(t){var e=WW.f(this),n=HW(t);return(n.error?e.reject:e.resolve)(n.value),e.promise}});var AT=Dt(BW),C0=Gc.f("asyncIterator"),KW=Dt(C0);function Ol(t){var e,n;function i(o,s){try{var a=t[o](s),c=a.value,d=c instanceof bT;AT.resolve(d?c.v:c).then(function(u){if(d){var l=o==="return"?"return":"next";if(!c.k||u.done)return i(l,u);u=t[l](u).value}r(a.done?"return":"normal",u)},function(u){i("throw",u)})}catch(u){r("throw",u)}}function r(o,s){switch(o){case"return":e.resolve({value:s,done:!0});break;case"throw":e.reject(s);break;default:e.resolve({value:s,done:!1})}(e=e.next)?i(e.key,e.arg):n=null}this._invoke=function(o,s){return new AT(function(a,c){var d={key:o,arg:s,resolve:a,reject:c,next:null};n?n=n.next=d:(e=n=d,i(o,s))})},typeof t.return!="function"&&(this.return=void 0)}function Hi(t){return function(){return new Ol(t.apply(this,arguments))}}Ol.prototype[typeof Kc=="function"&&KW||"@@asyncIterator"]=function(){return this},Ol.prototype.next=function(t){return this._invoke("next",t)},Ol.prototype.throw=function(t){return this._invoke("throw",t)},Ol.prototype.return=function(t){return this._invoke("return",t)};var v0=Dt(Bn.Object.getOwnPropertySymbols),qW=$t,YW=Ye.indexOf,zW=Oh,wT=ga([].indexOf),y0=!!wT&&1/wT([1],1,-0)<0;qW({target:"Array",proto:!0,forced:y0||!zW("indexOf")},{indexOf:function(t){var e=arguments.length>1?arguments[1]:void 0;return y0?wT(this,t,e)||0:YW(this,t,e)}});var JW=oi("Array").indexOf,XW=Jn,QW=JW,OT=Array.prototype,ZW=function(t){var e=t.indexOf;return t===OT||XW(OT,t)&&e===OT.indexOf?QW:e},I0=Dt(ZW);function $W(t,e){if(t==null)return{};var n,i,r=function(s,a){if(s==null)return{};var c,d,u={},l=Eb(s);for(d=0;d<l.length;d++)c=l[d],I0(a).call(a,c)>=0||(u[c]=s[c]);return u}(t,e);if(v0){var o=v0(t);for(i=0;i<o.length;i++)n=o[i],I0(e).call(e,n)>=0||Object.prototype.propertyIsEnumerable.call(t,n)&&(r[n]=t[n])}return r}var b0={exports:{}};(function(t,e){t.exports=(()=>{var n={8:(o,s,a)=>{a.r(s),a.d(s,{Parser:()=>Yt,Printer:()=>Qr,parse:()=>wt,print:()=>oe});const c=`
`,d="".concat("\r").concat(c),u=" ";let l;function p(st){return st>="0"&&st<="9"}function f(st){return st>="!"&&st<="~"}function C(st){return f(st)||st>="\x80"&&st<="\xFF"}function m(st){return st==="!"||st>="#"&&st<="'"||st>="*"&&st<="+"||st>="-"&&st<="."||st>="0"&&st<="9"||st>="A"&&st<="Z"||st>="^"&&st<="~"}function g(st){return st>="1"&&st<="9"}function y(st){return st>="A"&&st<="Z"||st>="a"&&st<="z"}function A(st){return st==="d"||st==="h"||st==="m"||st==="s"}function k(st){return st>""&&st<"	"||st>"\v"&&st<"\f"||st>""&&st<"\xFF"}function M(st){return y(st)||p(st)||st==="+"||st==="/"}function V(st){return p(st)||y(st)||st==="+"||st==="/"||st==="-"||st==="_"}function B(st){return y(st)||p(st)||st==="+"||st==="/"}function K(st,T){var D=Object.keys(st);if(Object.getOwnPropertySymbols){var L=Object.getOwnPropertySymbols(st);T&&(L=L.filter(function(Q){return Object.getOwnPropertyDescriptor(st,Q).enumerable})),D.push.apply(D,L)}return D}function Y(st){for(var T=1;T<arguments.length;T++){var D=arguments[T]!=null?arguments[T]:{};T%2?K(Object(D),!0).forEach(function(L){J(st,L,D[L])}):Object.getOwnPropertyDescriptors?Object.defineProperties(st,Object.getOwnPropertyDescriptors(D)):K(Object(D)).forEach(function(L){Object.defineProperty(st,L,Object.getOwnPropertyDescriptor(D,L))})}return st}function J(st,T,D){return T in st?Object.defineProperty(st,T,{value:D,enumerable:!0,configurable:!0,writable:!0}):st[T]=D,st}(function(st){st.VERSION="v",st.ORIGIN="o",st.SESSION_NAME="s",st.INFORMATION="i",st.URI="u",st.EMAIL="e",st.PHONE="p",st.CONNECTION="c",st.BANDWIDTH="b",st.TIME="t",st.REPEAT="r",st.ZONE_ADJUSTMENTS="z",st.KEY="k",st.ATTRIBUTE="a",st.MEDIA="m"})(l||(l={}));class lt{consumeText(T,D){let L=D;for(;L<T.length;){const Q=T[L];if(Q==="\0"||Q==="\r"||Q===c)break;L+=1}if(L-D==0)throw new Error("Invalid text, at ".concat(T));return L}consumeUnicastAddress(T,D,L){return this.consumeTill(T,D,u)}consumeOneOrMore(T,D,L){let Q=D;for(;L(T[Q]);)Q++;if(Q-D==0)throw new Error("Invalid rule at ".concat(D,"."));return Q}consumeSpace(T,D){if(T[D]===u)return D+1;throw new Error("Invalid space at ".concat(D,"."))}consumeIP4Address(T,D){let L=D;for(let Q=0;Q<4;Q++)if(L=this.consumeDecimalUChar(T,L),Q!==3){if(T[L]!==".")throw new Error("Invalid IP4 address.");L++}return L}consumeDecimalUChar(T,D){let L=D;for(let Ot=0;Ot<3&&p(T[L]);Ot++,L++);if(L-D==0)throw new Error("Invalid decimal uchar.");const Q=parseInt(T.slice(D,L));if(Q>=0&&Q<=255)return L;throw new Error("Invalid decimal uchar")}consumeIP6Address(T,D){let L=this.consumeHexpart(T,D);return T[L]===":"&&(L+=1,L=this.consumeIP4Address(T,L)),L}consumeHexpart(T,D){let L=D;if(T[L]===":"&&T[L+1]===":"){L+=2;try{L=this.consumeHexseq(T,L)}catch{}return L}if(L=this.consumeHexseq(T,L),T[L]===":"&&T[L+1]===":"){L+=2;try{L=this.consumeHexseq(T,L)}catch{}return L}return L}consumeHexseq(T,D){let L=D;for(;L=this.consumeHex4(T,L),T[L]===":"&&T[L+1]!==":";)L+=1;return L}consumeHex4(T,D){let L=0;for(;L<4;L++)if(!((Q=T[D+L])>="0"&&Q<="9"||Q>="a"&&Q<="f"||Q>="A"&&Q<="F")){if(L===0)throw new Error("Invalid hex 4");break}var Q;return D+L}consumeFQDN(T,D){let L=D;for(;p(T[L])||y(T[L])||T[L]==="-"||T[L]===".";)L+=1;if(L-D<4)throw new Error("Invalid FQDN");return L}consumeExtnAddr(T,D){return this.consumeOneOrMore(T,D,C)}consumeMulticastAddress(T,D,L){switch(L){case"IP4":case"ip4":return this.consumeIP4MulticastAddress(T,D);case"IP6":case"ip6":return this.consumeIP6MulticastAddress(T,D);default:try{return this.consumeFQDN(T,D)}catch{return this.consumeExtnAddr(T,D)}}}consumeIP6MulticastAddress(T,D){const L=this.consumeHexpart(T,D);return T[L]==="/"?this.consumeInteger(T,L+1):L}consumeIP4MulticastAddress(T,D){let L=D+3;const Q=T.slice(D,L),Ot=parseInt(Q);if(Ot<224||Ot>239)throw new Error("Invalid IP4 multicast address, IPv4 multicast addresses may be in the range 224.0.0.0 to 239.255.255.255.");for(let me=0;me<3;me++){if(T[L]!==".")throw new Error("Invalid IP4 multicast address.");L+=1,L=this.consumeDecimalUChar(T,L)}return T[L]==="/"&&(L+=1),L=this.consumeTTL(T,L),T[L]==="/"&&(L=this.consumeInteger(T,L)),L}consumeInteger(T,D){if(!g(T[D]))throw new Error("Invalid integer.");for(D+=1;p(T[D]);)D+=1;return D}consumeTTL(T,D){if(T[D]==="0")return D+1;if(!g(T[D]))throw new Error("Invalid TTL.");D+=1;for(let L=0;L<2&&p(T[D]);L++)D+=1;return D}consumeToken(T,D){return this.consumeOneOrMore(T,D,m)}consumeTime(T,D){let L=D;if(T[L]==="0")return L+1;for(g(T[L])&&(L+=1);p(T[L]);)L++;if(L-D<10)throw new Error("Invalid time");return L}consumeAddress(T,D){return this.consumeTill(T,D,u)}consumeTypedTime(T,D){let L=D;return L=this.consumeOneOrMore(T,L,p),A(T[L])?L+1:L}consumeRepeatInterval(T,D){if(!g(T[D]))throw new Error("Invalid repeat interval");for(D+=1;p(T[D]);)D+=1;return A(T[D])&&(D+=1),D}consumePort(T,D){return this.consumeOneOrMore(T,D,p)}consume(T,D,L){for(let Q=0;Q<L.length;Q++){if(D+Q>=T.length)throw new Error("consume exceeding value length");if(T[D+Q]!==L[Q])throw new Error("consume ".concat(L," failed at ").concat(Q))}return D+L.length}consumeTill(T,D,L){let Q=D;for(;Q<T.length&&(typeof L!="string"||T[Q]!==L)&&(typeof L!="function"||!L(T[Q]));)Q++;return Q}}class Yt extends lt{constructor(){super(),J(this,"records",[]),J(this,"currentLine",0)}parse(T){const D=this.probeEOL(T);this.records=T.split(D).filter(Tn=>!!si(Tn).call(Tn)).map(this.parseLine),this.currentLine=0;const L=this.parseVersion(),Q=this.parseOrigin(),Ot=this.parseSessionName(),me=this.parseInformation(),In=this.parseUri(),Ui=this.parseEmail(),Is=this.parsePhone(),$f=this.parseConnection(),t_=this.parseBandWidth(),Cr=this.parseTimeFields(),fa=this.parseKey(),jd=this.parseSessionAttribute(),sn=this.parseMediaDescription();if(this.currentLine!==this.records.length)throw new Error("parsing failed, non exhaustive sdp lines.");return{version:L,origin:Q,sessionName:Ot,information:me,uri:In,emails:Ui,phones:Is,connection:$f,bandwidths:t_,timeFields:Cr,key:fa,attributes:jd,mediaDescriptions:sn}}getCurrentRecord(){const T=this.records[this.currentLine];if(!T)throw new Error("Record doesn't exit.");return T}probeEOL(T){for(let D=0;D<T.length;D++)if(T[D]===c)return T[D-1]==="\r"?d:c;throw new Error("Invalid newline character.")}parseLine(T,D){if(T.length<2)throw new Error("Invalid sdp line, sdp line should be of form <type>=<value>.");const L=T[0];if(T[1]!=="=")throw new Error('Invalid sdp line, <type> should be a single character followed by an "=" sign.');return{type:L,value:T.slice(2),line:D,cur:0}}parseSessionAttribute(){const T=new Pe;for(;this.currentLine<this.records.length;){const D=this.getCurrentRecord();if(D.type!==l.ATTRIBUTE)break;const L={attField:this.extractOneOrMore(D,Q=>m(Q)&&Q!==":"),_cur:0};D.value[D.cur]===":"&&(D.cur+=1,L.attValue=this.extractOneOrMore(D,k)),T.parse(L),this.currentLine++}return T.digest()}parseMediaAttributes(T){const D=new hn(T);for(;this.currentLine<this.records.length;){const L=this.getCurrentRecord();if(L.type!==l.ATTRIBUTE)break;const Q={attField:this.extractOneOrMore(L,Ot=>m(Ot)&&Ot!==":"),_cur:0};L.value[L.cur]===":"&&(L.cur+=1,Q.attValue=this.extractOneOrMore(L,k)),D.parse(Q),this.currentLine++}return D.digest()}parseKey(){const T=this.getCurrentRecord();if(T.type===l.KEY){if(T.value==="prompt"||T.value==="clear:"||T.value==="base64:"||T.value==="uri:")return T.value;throw this.currentLine++,new Error("Invalid key.")}}parseZone(){const T=this.getCurrentRecord();if(T.type===l.ZONE_ADJUSTMENTS){const D=[];for(;;)try{const L=this.extract(T,this.consumeTime);this.consumeSpaceForRecord(T);let Q=!1;T.value[T.cur]==="-"&&(Q=!0,T.cur+=1);const Ot=this.extract(T,this.consumeTypedTime);D.push({time:L,typedTime:Ot,back:Q})}catch{break}if(D.length===0)throw new Error("Invalid zone adjustments");return this.currentLine++,D}return[]}parseRepeat(){const T=[];for(;;){const D=this.getCurrentRecord();if(D.type!==l.REPEAT)break;{const L=this.extract(D,this.consumeRepeatInterval),Q=this.parseTypedTime(D);T.push({repeatInterval:L,typedTimes:Q}),this.currentLine++}}return T}parseTypedTime(T){const D=[];for(;;)try{this.consumeSpaceForRecord(T),D.push(this.extract(T,this.consumeTypedTime))}catch{break}if(D.length===0)throw new Error("Invalid typed time.");return D}parseTime(){const T=this.getCurrentRecord(),D=this.extract(T,this.consumeTime);this.consumeSpaceForRecord(T);const L=this.extract(T,this.consumeTime);return this.currentLine++,{startTime:D,stopTime:L}}parseBandWidth(){const T=[];for(;this.currentLine<this.records.length;){const D=this.getCurrentRecord();if(D.type!==l.BANDWIDTH)break;{const L=this.extractOneOrMore(D,m);if(D.value[D.cur]!==":")throw new Error("Invalid bandwidth field.");D.cur++;const Q=this.extractOneOrMore(D,p);T.push({bwtype:L,bandwidth:Q}),this.currentLine++}}return T}parseVersion(){const T=this.getCurrentRecord();if(T.type!==l.VERSION)throw new Error("first sdp record must be version");const D=T.value.slice(0,this.consumeOneOrMore(T.value,0,p));if(D.length!==T.value.length)throw new Error('invalid proto version, "v='.concat(T.value,'"'));return this.currentLine++,D}parseOrigin(){const T=this.getCurrentRecord();if(T.type!==l.ORIGIN)throw new Error("second line of sdp must be origin");const D=this.extractOneOrMore(T,C);this.consumeSpaceForRecord(T);const L=this.extractOneOrMore(T,p);this.consumeSpaceForRecord(T);const Q=this.extractOneOrMore(T,p);this.consumeSpaceForRecord(T);const Ot=this.extractOneOrMore(T,m);this.consumeSpaceForRecord(T);const me=this.extractOneOrMore(T,m);this.consumeSpaceForRecord(T);const In=this.extract(T,this.consumeUnicastAddress);return this.currentLine++,{username:D,sessId:L,sessVersion:Q,nettype:Ot,addrtype:me,unicastAddress:In}}parseSessionName(){const T=this.getCurrentRecord();if(T.type===l.SESSION_NAME){const D=this.extract(T,this.consumeText);return this.currentLine++,D}}parseInformation(){const T=this.getCurrentRecord();if(T.type!==l.INFORMATION)return;const D=this.extract(T,this.consumeText);return this.currentLine++,D}parseUri(){const T=this.getCurrentRecord();if(T.type===l.URI)return this.currentLine++,T.value}parseEmail(){const T=[];for(;;){const D=this.getCurrentRecord();if(D.type!==l.EMAIL)break;T.push(D.value),this.currentLine++}return T}parsePhone(){const T=[];for(;;){const D=this.getCurrentRecord();if(D.type!==l.PHONE)break;T.push(D.value),this.currentLine++}return T}parseConnection(){const T=this.getCurrentRecord();if(T.type===l.CONNECTION){const D=this.extractOneOrMore(T,m);this.consumeSpaceForRecord(T);const L=this.extractOneOrMore(T,m);this.consumeSpaceForRecord(T);const Q=this.extract(T,this.consumeAddress);return this.currentLine++,{nettype:D,addrtype:L,address:Q}}}parseMedia(){const T=this.getCurrentRecord(),D=this.extract(T,this.consumeToken);this.consumeSpaceForRecord(T);let L=this.extract(T,this.consumePort);T.value[T.cur]==="/"&&(T.cur+=1,L+=this.extract(T,this.consumeInteger)),this.consumeSpaceForRecord(T);const Q=[];for(Q.push(this.extract(T,this.consumeToken));T.value[T.cur]==="/";)T.cur+=1,Q.push(this.extract(T,this.consumeToken));if(Q.length===0)throw new Error("Invalid proto");const Ot=this.parseFmt(T);return this.currentLine++,{mediaType:D,port:L,protos:Q,fmts:Ot}}parseTimeFields(){const T=[];for(;this.getCurrentRecord().type===l.TIME;){const D=this.parseTime(),L=this.parseRepeat(),Q=this.parseZone();T.push({time:D,repeats:L,zones:Q})}return T}parseMediaDescription(){const T=[];for(;this.currentLine<this.records.length&&this.getCurrentRecord().type===l.MEDIA;){const D=this.parseMedia(),L=this.parseInformation(),Q=this.parseConnections(),Ot=this.parseBandWidth(),me=this.parseKey(),In=this.parseMediaAttributes(D);T.push({media:D,information:L,connections:Q,bandwidths:Ot,key:me,attributes:In})}return T}parseConnections(){const T=[];for(;this.currentLine<this.records.length&&this.getCurrentRecord().type===l.CONNECTION;)T.push(this.parseConnection());return T}parseFmt(T){const D=[];for(;;)try{this.consumeSpaceForRecord(T),D.push(this.extract(T,this.consumeToken))}catch{break}if(D.length===0)throw new Error("Invalid fmts");return D}extract(T,D){for(var L=arguments.length,Q=new Array(L>2?L-2:0),Ot=2;Ot<L;Ot++)Q[Ot-2]=arguments[Ot];const me=D.call(this,T.value,T.cur,...Q),In=T.value.slice(T.cur,me);return T.cur=me,In}extractOneOrMore(T,D){const L=this.consumeOneOrMore(T.value,T.cur,D),Q=T.value.slice(T.cur,L);return T.cur=L,Q}consumeSpaceForRecord(T){if(T.value[T.cur]!==u)throw new Error("Invalid space at ".concat(T.cur,"."));T.cur+=1}}class de extends lt{constructor(){super(...arguments),J(this,"attributes",void 0),J(this,"digested",!1)}extractOneOrMore(T,D,L){const Q=this.consumeOneOrMore(T.attValue,T._cur,D),Ot=T.attValue.slice(T._cur,Q),[me,In]=L||[];if(typeof me=="number"&&Ot.length<me)throw new Error("error in length, should be more or equal than ".concat(me," characters."));if(typeof In=="number"&&Ot.length>In)throw new Error("error in length, should be less or equal than ".concat(In," characters."));return T._cur=Q,Ot}consumeAttributeSpace(T){if(T.attValue[T._cur]!==u)throw new Error("Invalid space at ".concat(T._cur,"."));T._cur+=1}extract(T,D){if(!T.attValue)throw new Error("Nothing to extract from attValue.");for(var L=arguments.length,Q=new Array(L>2?L-2:0),Ot=2;Ot<L;Ot++)Q[Ot-2]=arguments[Ot];const me=D.call(this,T.attValue,T._cur,...Q),In=T.attValue.slice(T._cur,me);return T._cur=me,In}atEnd(T){if(!T.attValue)throw new Error;return T._cur>=T.attValue.length}peekChar(T){if(!T.attValue)throw new Error;return T.attValue[T._cur]}peek(T,D){if(!T.attValue)throw new Error;for(let L=0;L<D.length;L++)if(D[L]!==T.attValue[T._cur+L])return!1;return!0}parseIceUfrag(T){if(this.attributes.iceUfrag)throw new Error("Invalid ice-ufrag, should be only a single line if 'a=ice-ufrag'");this.attributes.iceUfrag=this.extractOneOrMore(T,M,[4,256])}parseIcePwd(T){if(this.attributes.icePwd)throw new Error("Invalid ice-pwd, should be only a single line if 'a=ice-pwd'");this.attributes.icePwd=this.extractOneOrMore(T,M,[22,256])}parseIceOptions(T){if(this.attributes.iceOptions)throw new Error("Invalid ice-options, should be only one 'ice-options' line");const D=[];for(;!this.atEnd(T);){D.push(this.extractOneOrMore(T,M));try{this.consumeAttributeSpace(T)}catch(L){if(this.atEnd(T))break;throw L}}this.attributes.iceOptions=D}parseFingerprint(T){const D=this.extract(T,this.consumeToken);this.consumeAttributeSpace(T);const L=this.extract(T,this.consumeTill);this.attributes.fingerprints.push({hashFunction:D,fingerprint:L})}parseExtmap(T){const D=this.extractOneOrMore(T,p);let L;this.peekChar(T)==="/"&&(this.extract(T,this.consume,"/"),L=this.extract(T,this.consumeToken)),this.consumeAttributeSpace(T);const Q=this.extract(T,this.consumeTill,u),Ot=Y(Y({entry:parseInt(D,10)},L&&{direction:L}),{},{extensionName:Q});this.peekChar(T)===u&&(this.consumeAttributeSpace(T),Ot.extensionAttributes=this.extract(T,this.consumeTill)),this.attributes.extmaps.push(Ot)}parseSetup(T){if(this.attributes.setup)throw new Error("must only be one single 'a=setup' line.");const D=this.extract(T,this.consumeTill);if(D!=="active"&&D!=="passive"&&D!=="actpass"&&D!=="holdconn")throw new Error("role must be one of 'active', 'passive', 'actpass', 'holdconn'.");this.attributes.setup=D}}class Pe extends de{constructor(){super(...arguments),J(this,"attributes",{unrecognized:[],groups:[],extmaps:[],fingerprints:[],identities:[]})}parse(T){if(this.digested)throw new Error("already digested");try{switch(T.attField){case"group":this.parseGroup(T);break;case"ice-lite":this.parseIceLite();break;case"ice-ufrag":this.parseIceUfrag(T);break;case"ice-pwd":this.parseIcePwd(T);break;case"ice-options":this.parseIceOptions(T);break;case"fingerprint":this.parseFingerprint(T);break;case"setup":this.parseSetup(T);break;case"tls-id":this.parseTlsId(T);break;case"identity":this.parseIdentity(T);break;case"extmap":this.parseExtmap(T);break;case"msid-semantic":this.parseMsidSemantic(T);break;default:T.ignored=!0,this.attributes.unrecognized.push(T)}}catch(D){throw console.error("parsing session attribute ".concat(T.attField,' error, "a=').concat(T.attField,":").concat(T.attValue,'"')),D}if(!T.ignored&&T.attValue&&!this.atEnd(T))throw new Error("attribute parsing error")}digest(){return this.digested=!0,this.attributes}parseGroup(T){const D=this.extract(T,this.consumeToken),L=[];for(;!this.atEnd(T)&&this.peekChar(T)===u;)this.consumeAttributeSpace(T),L.push(this.extract(T,this.consumeToken));this.attributes.groups.push({semantic:D,identificationTag:L})}parseIceLite(){if(this.attributes.iceLite)throw new Error("Invalid ice-lite, should be only a single line of 'a=ice-lite'");this.attributes.iceLite=!0}parseTlsId(T){if(this.attributes.tlsId)throw new Error("must be only one tld-id line");this.attributes.tlsId=this.extractOneOrMore(T,V)}parseIdentity(T){const D=this.extractOneOrMore(T,B),L=[];for(;!this.atEnd(T)&&this.peekChar(T)===u;){this.consumeAttributeSpace(T);const Q=this.extract(T,this.consumeToken);this.extract(T,this.consume,"=");const Ot=this.extractOneOrMore(T,me=>me!==u&&k(me));L.push({name:Q,value:Ot})}this.attributes.identities.push({assertionValue:D,extensions:L})}parseMsidSemantic(T){this.peekChar(T)===u&&this.consumeAttributeSpace(T);const D={semantic:this.extract(T,this.consumeToken),identifierList:[]};for(;;){try{this.consumeAttributeSpace(T)}catch{break}if(this.peekChar(T)==="*"){this.extract(T,this.consume,"*"),D.applyForAll=!0;break}{const L=this.extract(T,this.consumeTill,u);D.identifierList.push(L)}}this.attributes.msidSemantic=D}}class hn extends de{constructor(T){super(),J(this,"attributes",void 0),T.protos.indexOf("RTP")!==-1||T.protos.indexOf("rtp"),this.attributes={unrecognized:[],candidates:[],extmaps:[],fingerprints:[],imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:[],ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:[]}}parse(T){if(this.digested)throw new Error("already digested");try{switch(T.attField){case"extmap":this.parseExtmap(T);break;case"setup":this.parseSetup(T);break;case"ice-ufrag":this.parseIceUfrag(T);break;case"ice-pwd":this.parseIcePwd(T);break;case"ice-options":this.parseIceOptions(T);break;case"candidate":this.parseCandidate(T);break;case"remote-candidate":this.parseRemoteCandidate(T);break;case"end-of-candidates":this.parseEndOfCandidates();break;case"fingerprint":this.parseFingerprint(T);break;case"rtpmap":this.parseRtpmap(T);break;case"ptime":this.parsePtime(T);break;case"maxptime":this.parseMaxPtime(T);break;case"sendrecv":case"recvonly":case"sendonly":case"inactive":this.parseDirection(T);break;case"ssrc":this.parseSSRC(T);break;case"fmtp":this.parseFmtp(T);break;case"rtcp-fb":this.parseRtcpFb(T);break;case"rtcp-mux":this.parseRTCPMux();break;case"rtcp-mux-only":this.parseRTCPMuxOnly();break;case"rtcp-rsize":this.parseRTCPRsize();break;case"rtcp":this.parseRTCP(T);break;case"mid":this.parseMid(T);break;case"msid":this.parseMsid(T);break;case"imageattr":this.parseImageAttr(T);break;case"rid":this.parseRid(T);break;case"simulcast":this.parseSimulcast(T);break;case"sctp-port":this.parseSctpPort(T);break;case"max-message-size":this.parseMaxMessageSize(T);break;case"ssrc-group":this.parseSSRCGroup(T);break;default:T.ignored=!0,this.attributes.unrecognized.push(T)}}catch(D){throw console.error("parsing media attribute ".concat(T.attField,' error, "a=').concat(T.attField,":").concat(T.attValue,'"')),D}if(!T.ignored&&T.attValue&&!this.atEnd(T))throw new Error("attribute parsing error")}parseCandidate(T){const D=this.extractOneOrMore(T,M,[1,32]);this.consumeAttributeSpace(T);const L=this.extractOneOrMore(T,p,[1,5]);this.consumeAttributeSpace(T);const Q=this.extract(T,this.consumeToken);this.consumeAttributeSpace(T);const Ot=this.extractOneOrMore(T,p,[1,10]);this.consumeAttributeSpace(T);const me=this.extract(T,this.consumeAddress);this.consumeAttributeSpace(T);const In=this.extract(T,this.consumePort);this.consumeAttributeSpace(T),this.extract(T,this.consume,"typ"),this.consumeAttributeSpace(T);const Ui={foundation:D,componentId:L,transport:Q,priority:Ot,connectionAddress:me,port:In,type:this.extract(T,this.consumeToken),extension:{}};for(this.peek(T," raddr")&&(this.extract(T,this.consume," raddr"),this.consumeAttributeSpace(T),Ui.relAddr=this.extract(T,this.consumeAddress)),this.peek(T," rport")&&(this.extract(T,this.consume," rport"),this.consumeAttributeSpace(T),Ui.relPort=this.extract(T,this.consumePort));this.peekChar(T)===u;){this.consumeAttributeSpace(T);const Is=this.extract(T,this.consumeToken);this.consumeAttributeSpace(T),Ui.extension[Is]=this.extractOneOrMore(T,f)}this.attributes.candidates.push(Ui)}parseRemoteCandidate(T){const D=[];for(;;){const L=this.extractOneOrMore(T,p,[1,5]);this.consumeAttributeSpace(T);const Q=this.extract(T,this.consumeAddress);this.consumeAttributeSpace(T);const Ot=this.extract(T,this.consumePort);D.push({componentId:L,connectionAddress:Q,port:Ot});try{this.consumeAttributeSpace(T)}catch{break}}this.attributes.remoteCandidatesList.push(D)}parseEndOfCandidates(){if(this.attributes.endOfCandidates)throw new Error("must be only one line of end-of-candidates");this.attributes.endOfCandidates=!0}parseRtpmap(T){const D=this.extract(T,this.consumeToken);this.consumeAttributeSpace(T);const L=this.extract(T,this.consumeTill,"/");this.extract(T,this.consume,"/");const Q={encodingName:L,clockRate:this.extractOneOrMore(T,p)};this.atEnd(T)||this.peekChar(T)!=="/"||(this.extract(T,this.consume,"/"),Q.encodingParameters=parseInt(this.extract(T,this.consumeTill),10));const Ot=this.attributes.payloads.find(me=>me.payloadType===parseInt(D,10));Ot?Ot.rtpMap=Q:this.attributes.payloads.push({payloadType:parseInt(D,10),rtpMap:Q,rtcpFeedbacks:[]})}parsePtime(T){if(this.attributes.ptime)throw new Error("must be only one line of ptime");this.attributes.ptime=this.extract(T,this.consumeTill)}parseMaxPtime(T){if(this.attributes.maxPtime)throw new Error("must be only one line of ptime");this.attributes.maxPtime=this.extract(T,this.consumeTill)}parseDirection(T){if(this.attributes.direction)throw new Error("must be only one line of direction info");this.attributes.direction=T.attField}parseSSRC(T){const D=this.extractOneOrMore(T,p);this.consumeAttributeSpace(T);const L=this.extract(T,this.consumeTill,":");let Q;this.peekChar(T)===":"&&(this.extract(T,this.consume,":"),Q=this.extract(T,this.consumeTill));const Ot=this.attributes.ssrcs.find(me=>me.ssrcId===parseInt(D,10));Ot?Ot.attributes[L]=Q:this.attributes.ssrcs.push({ssrcId:parseInt(D,10),attributes:{[L]:Q}})}parseFmtp(T){const D=this.extract(T,this.consumeTill,u);this.consumeAttributeSpace(T);const L=this.extract(T,this.consumeTill),Q={};L.split(";").forEach(me=>{let[In,Ui]=me.split("=");In=si(In).call(In);const Is=typeof Ui=="string"?si(Ui).call(Ui):null;typeof In=="string"&&In.length>0&&(Q[In]=Is)});const Ot=this.attributes.payloads.find(me=>me.payloadType===parseInt(D,10));Ot?Ot.fmtp={parameters:Q}:this.attributes.payloads.push({payloadType:parseInt(D,10),rtcpFeedbacks:[],fmtp:{parameters:Q}})}parseFmtParameters(T){const D={},L=this.extract(T,this.consumeTill,"=");T._cur++;const Q=this.extract(T,this.consumeTill,";");for(D[L]=Q;T.attValue[T._cur]===";";){const Ot=this.extract(T,this.consumeTill,"=");T._cur++;const me=this.extract(T,this.consumeTill,";");D[Ot]=me}return D}parseRtcpFb(T){let D="";D=this.peekChar(T)==="*"?this.extract(T,this.consume,"*"):this.extract(T,this.consumeTill,u),this.consumeAttributeSpace(T);const L=this.extract(T,this.consumeTill,u);let Q;if(L==="trr-int")Q={type:L,interval:this.extract(T,this.consumeTill)};else{const Ot={type:L};this.peekChar(T)===u&&(this.consumeAttributeSpace(T),Ot.parameter=this.extract(T,this.consumeToken),this.peekChar(T)===u&&(Ot.additional=this.extract(T,this.consumeTill))),Q=Ot}if(D==="*")this.attributes.rtcpFeedbackWildcards.push(Q);else{const Ot=this.attributes.payloads.find(me=>me.payloadType===parseInt(D,10));Ot?Ot.rtcpFeedbacks.push(Q):this.attributes.payloads.push({payloadType:parseInt(D,10),rtcpFeedbacks:[Q]})}}parseRTCPMux(){if(this.attributes.rtcpMux)throw new Error("must be single line of rtcp-mux");this.attributes.rtcpMux=!0}parseRTCPMuxOnly(){if(this.attributes.rtcpMuxOnly)throw new Error("must be single line of rtcp-only");this.attributes.rtcpMuxOnly=!0}parseRTCPRsize(){if(this.attributes.rtcpRsize)throw new Error("must be single line of rtcp-rsize");this.attributes.rtcpRsize=!0}parseRTCP(T){if(this.attributes.rtcp)throw new Error("must be single line of rtcp");const D={port:this.extract(T,this.consumePort)};this.peekChar(T)===u&&(this.consumeAttributeSpace(T),D.netType=this.extractOneOrMore(T,m),this.consumeAttributeSpace(T),D.addressType=this.extractOneOrMore(T,m),this.consumeAttributeSpace(T),D.address=this.extract(T,this.consumeAddress)),this.attributes.rtcp=D}parseMsid(T){const D={id:this.extractOneOrMore(T,m,[1,64])};this.peekChar(T)===u&&(this.consumeAttributeSpace(T),D.appdata=this.extractOneOrMore(T,m,[1,64])),this.attributes.msids.push(D)}parseImageAttr(T){this.attributes.imageattr.push(T.attValue)}parseRid(T){const D=this.extractOneOrMore(T,Q=>y(Q)||p(Q)||Q==="_"||Q==="-");this.consumeAttributeSpace(T);const L={id:D,direction:this.extract(T,this.consumeToken),params:[]};if(this.peekChar(T)===u){if(this.consumeAttributeSpace(T),this.peek(T,"pt=")){this.extract(T,this.consume,"pt=");const Q=[];for(;;){const Ot=this.extract(T,this.consumeToken);Q.push(Ot);try{this.extract(T,this.consume,",")}catch{break}}L.payloads=Q,this.peekChar(T)===u&&this.extract(T,this.consume,u)}for(;;){const Q=this.extract(T,this.consumeToken);switch(Q){case"depend":{const Ot={type:Q,rids:this.extract(T,this.consume,"=").split(",")};L.params.push(Ot);break}default:{const Ot={type:Q};this.peekChar(T)==="="&&(this.extract(T,this.consume,"="),Ot.val=this.extract(T,this.consumeTill,";")),L.params.push(Ot)}}try{this.extract(T,this.consume,";")}catch{break}}}this.attributes.rids.push(L)}parseSimulcast(T){if(this.attributes.simulcast)throw new Error("must be single line of simulcast");this.attributes.simulcast=T.attValue,this.extract(T,this.consumeTill)}parseSctpPort(T){this.attributes.sctpPort=this.extractOneOrMore(T,p,[1,5])}parseMaxMessageSize(T){this.attributes.maxMessageSize=this.extractOneOrMore(T,p,[1,void 0])}digest(){return this.digested=!0,this.attributes}parseMid(T){this.attributes.mid=this.extract(T,this.consumeToken)}parseSSRCGroup(T){const D=this.extract(T,this.consumeToken),L=[];for(;;)try{this.consumeAttributeSpace(T);const Q=this.extract(T,this.consumeInteger);L.push(parseInt(Q,10))}catch{break}this.attributes.ssrcGroups.push({semantic:D,ssrcIds:L})}}function qe(st,T,D){return T in st?Object.defineProperty(st,T,{value:D,enumerable:!0,configurable:!0,writable:!0}):st[T]=D,st}class Qr{constructor(){qe(this,"eol",d)}print(T,D){let L="";return D&&(this.eol=D),L+=this.printVersion(T.version),L+=this.printOrigin(T.origin),L+=this.printSessionName(T.sessionName),L+=this.printInformation(T.information),L+=this.printUri(T.uri),L+=this.printEmail(T.emails),L+=this.printPhone(T.phones),L+=this.printConnection(T.connection),L+=this.printBandwidth(T.bandwidths),L+=this.printTimeFields(T.timeFields),L+=this.printKey(T.key),L+=this.printSessionAttributes(T.attributes),L+=this.printMediaDescription(T.mediaDescriptions),L}printVersion(T){return"v=".concat(T).concat(this.eol)}printOrigin(T){return"o=".concat(T.username," ").concat(T.sessId," ").concat(T.sessVersion," ").concat(T.nettype," ").concat(T.addrtype," ").concat(T.unicastAddress).concat(this.eol)}printSessionName(T){return T?"s=".concat(T).concat(this.eol):""}printInformation(T){return T?"i=".concat(T).concat(this.eol):""}printUri(T){return T?"u=".concat(T).concat(this.eol):""}printEmail(T){let D="";for(const L of T)D+="e=".concat(L).concat(this.eol);return D}printPhone(T){let D="";for(const L of T)D+="e=".concat(L).concat(this.eol);return D}printConnection(T){return T?"c=".concat(T.nettype," ").concat(T.addrtype," ").concat(T.address).concat(this.eol):""}printBandwidth(T){let D="";for(const L of T)D+="b=".concat(L.bwtype,":").concat(L.bandwidth).concat(this.eol);return D}printTimeFields(T){let D="";for(const L of T){D+="t=".concat(L.time.startTime," ").concat(L.time.startTime).concat(this.eol);for(const Q of L.repeats)D+="r=".concat(Q.repeatInterval," ").concat(Q.typedTimes.join(" ")).concat(this.eol);L.zoneAdjustments&&(D+="z=",D+="z=".concat(L.zoneAdjustments.map(Q=>"".concat(Q.time," ").concat(Q.back?"-":""," ").concat(Q.typedTime)).join(" ")).concat(this.eol),D+=this.eol)}return D}printKey(T){return T?"k=".concat(T).concat(this.eol):""}printAttributes(T){let D="";for(const L of T)D+="a=".concat(L.attField).concat(L.attValue?":".concat(L.attValue):"").concat(this.eol);return D}printMediaDescription(T){let D="";for(const L of T)D+=this.printMedia(L.media),D+=this.printInformation(L.information),D+=this.printConnections(L.connections),D+=this.printBandwidth(L.bandwidths),D+=this.printKey(L.key),D+=this.printMediaAttributes(L);return D}printConnections(T){let D="";for(const L of T)D+=this.printConnection(L);return D}printMedia(T){return"m=".concat(T.mediaType," ").concat(T.port," ").concat(T.protos.join("/")," ").concat(T.fmts.join(" ")).concat(this.eol)}printSessionAttributes(T){return new tt(this.eol).print(T)}printMediaAttributes(T){return new ft(this.eol).print(T)}}class z{constructor(T){qe(this,"eol",void 0),this.eol=T}printIceUfrag(T){return T===void 0?"":"a=ice-ufrag:".concat(T).concat(this.eol)}printIcePwd(T){return T===void 0?"":"a=ice-pwd:".concat(T).concat(this.eol)}printIceOptions(T){return T===void 0?"":"a=ice-options:".concat(T.join(u)).concat(this.eol)}printFingerprints(T){return T.length>0?T.map(D=>"a=fingerprint:".concat(D.hashFunction).concat(u).concat(D.fingerprint)).join(this.eol)+this.eol:""}printExtmap(T){return T.map(D=>"a=extmap:".concat(D.entry).concat(D.direction?"/".concat(D.direction):"").concat(u).concat(D.extensionName).concat(D.extensionAttributes?"".concat(u).concat(D.extensionAttributes):"").concat(this.eol)).join("")}printSetup(T){return T===void 0?"":"a=setup:".concat(T).concat(this.eol)}printUnrecognized(T){return T.map(D=>"a=".concat(D.attField).concat(D.attValue?":".concat(D.attValue):"").concat(this.eol)).join("")}}class tt extends z{print(T){let D="";return D+=this.printGroups(T.groups),D+=this.printMsidSemantic(T.msidSemantic),D+=this.printIceLite(T.iceLite),D+=this.printIceUfrag(T.iceUfrag),D+=this.printIcePwd(T.icePwd),D+=this.printIceOptions(T.iceOptions),D+=this.printFingerprints(T.fingerprints),D+=this.printSetup(T.setup),D+=this.printTlsId(T.tlsId),D+=this.printIdentity(T.identities),D+=this.printExtmap(T.extmaps),D+=this.printUnrecognized(T.unrecognized),D}printGroups(T){let D="";return T.length>0&&(D+=T.map(L=>"a=group:".concat(L.semantic).concat(L.identificationTag.map(Q=>"".concat(u).concat(Q)).join("")).concat(this.eol)).join("")),D}printIceLite(T){return T===void 0?"":"a=ice-lite"+this.eol}printTlsId(T){return T?"a=tls-id:".concat(T).concat(this.eol):""}printIdentity(T){return T.length===0?"":T.map(D=>"a=identity:".concat(D.assertionValue).concat(D.extensions.map(L=>"".concat(u).concat(L.name).concat(L.value?"=".concat(L.value):"")))).join(this.eol)+this.eol}printMsidSemantic(T){if(!T)return"";let D="a=msid-semantic:".concat(T.semantic);return T.applyForAll?D+="".concat(u,"*"):T.identifierList.length>0&&(D+=T.identifierList.map(L=>"".concat(u).concat(L))),D+this.eol}}class ft extends z{print(T){const D=T.attributes;let L="";return L+=this.printRTCP(D.rtcp),L+=this.printIceUfrag(D.iceUfrag),L+=this.printIcePwd(D.icePwd),L+=this.printIceOptions(D.iceOptions),L+=this.printCandidates(D.candidates),L+=this.printRemoteCandidatesList(D.remoteCandidatesList),L+=this.printEndOfCandidates(D.endOfCandidates),L+=this.printFingerprints(D.fingerprints),L+=this.printSetup(D.setup),L+=this.printMid(D.mid),L+=this.printExtmap(D.extmaps),L+=this.printRTPRelated(D),L+=this.printPtime(D.ptime),L+=this.printMaxPtime(D.maxPtime),L+=this.printDirection(D.direction),L+=this.printSSRCGroups(D.ssrcGroups),L+=this.printSSRC(D.ssrcs),L+=this.printRTCPMux(D.rtcpMux),L+=this.printRTCPMuxOnly(D.rtcpMuxOnly),L+=this.printRTCPRsize(D.rtcpRsize),L+=this.printMSId(D.msids),L+=this.printImageattr(D.imageattr),L+=this.printRid(D.rids),L+=this.printSimulcast(D.simulcast),L+=this.printSCTPPort(D.sctpPort),L+=this.printMaxMessageSize(D.maxMessageSize),L+=this.printUnrecognized(D.unrecognized),L}printCandidates(T){return T.map(D=>"a=candidate:".concat(D.foundation).concat(u).concat(D.componentId).concat(u).concat(D.transport).concat(u).concat(D.priority).concat(u).concat(D.connectionAddress).concat(u).concat(D.port).concat(u,"typ").concat(u).concat(D.type).concat(D.relAddr?"".concat(u,"raddr").concat(u).concat(D.relAddr):"").concat(D.relPort?"".concat(u,"rport").concat(u).concat(D.relPort):"").concat(Object.keys(D.extension).map(L=>"".concat(u).concat(L).concat(u).concat(D.extension[L])).join("")).concat(this.eol)).join("")}printRemoteCandidatesList(T){return T.map(D=>"a=remote-candidates:".concat(D.join(u)).concat(this.eol)).join("")}printEndOfCandidates(T){return T===void 0?"":"a=end-of-candidates"+this.eol}printRTPRelated(T){if(!T.payloads)return"";const D=T.payloads;let L="";L+=T.rtcpFeedbackWildcards.map(Q=>this.printRTCPFeedback("*",Q)).join("");for(const Q of D)L+=this.printRtpMap(Q.payloadType,Q.rtpMap),L+=this.printFmtp(Q.payloadType,Q.fmtp),L+=Q.rtcpFeedbacks.map(Ot=>this.printRTCPFeedback(Q.payloadType,Ot)).join("");return L}printFmtp(T,D){if(!D)return"";const L=Object.keys(D.parameters);return L.length===1&&D.parameters[L[0]]===null?"a=fmtp:".concat(T).concat(u).concat(L[0]).concat(this.eol):"a=fmtp:".concat(T).concat(u).concat(Object.keys(D.parameters).map(Q=>"".concat(Q,"=").concat(D.parameters[Q])).join(";")).concat(this.eol)}printRtpMap(T,D){return D?"a=rtpmap:".concat(T).concat(u).concat(D.encodingName,"/").concat(D.clockRate).concat(D.encodingParameters?"/".concat(D.encodingParameters):"").concat(this.eol):""}printRTCPFeedback(T,D){let L="a=rtcp-fb:".concat(T).concat(u),Q=D;return Q.type==="trr-int"?L+="ttr-int".concat(u).concat(Q.interval):(L+="".concat(Q.type),Q.parameter&&(L+="".concat(u).concat(Q.parameter),Q.additional&&(L+="".concat(u).concat(Q.additional)))),L+this.eol}printPtime(T){return T===void 0?"":"a=ptime:".concat(T).concat(this.eol)}printMaxPtime(T){return T===void 0?"":"a=maxptime:".concat(T).concat(this.eol)}printDirection(T){return T===void 0?"":"a=".concat(T).concat(this.eol)}printSSRC(T){return T.map(D=>Object.keys(D.attributes).map(L=>"a=ssrc:".concat(D.ssrcId.toString(10)).concat(u).concat(L).concat(D.attributes[L]?":".concat(D.attributes[L]):"").concat(this.eol)).join("")).join("")}printRTCPMux(T){return T===void 0?"":"a=rtcp-mux".concat(this.eol)}printRTCPMuxOnly(T){return T===void 0?"":"a=rtcp-mux-only".concat(this.eol)}printRTCPRsize(T){return T===void 0?"":"a=rtcp-rsize".concat(this.eol)}printRTCP(T){if(T===void 0)return"";let D="a=rtcp:".concat(T.port);return T.netType&&(D+="".concat(u).concat(T.netType)),T.addressType&&(D+="".concat(u).concat(T.addressType)),T.address&&(D+="".concat(u).concat(T.address)),D+this.eol}printMSId(T){return T.map(D=>"a=msid:".concat(D.id).concat(D.appdata?"".concat(u).concat(D.appdata):"").concat(this.eol)).join("")}printImageattr(T){return T.map(D=>"a=imageattr:".concat(D).concat(this.eol)).join("")}printRid(T){return T.map(D=>{let L="a=rid:".concat(D.id).concat(u).concat(D.direction);return D.payloads&&(L+="".concat(u,"pt=").concat(D.payloads.join(","))),D.params.length>0&&(L+="".concat(u).concat(D.params.map(Q=>Q.type==="depend"?"depend=".concat(Q.rids.join(",")):"".concat(Q.type,"=").concat(Q.val)).join(";"))),L+this.eol}).join("")}printSimulcast(T){return T===void 0?"":"a=simulcast:".concat(T).concat(this.eol)}printSCTPPort(T){return T===void 0?"":"a=sctp-port:".concat(T).concat(this.eol)}printMaxMessageSize(T){return T===void 0?"":"a=max-message-size:".concat(T).concat(this.eol)}printMid(T){return T===void 0?"":"a=mid:".concat(T).concat(this.eol)}printSSRCGroups(T){return T.map(D=>"a=ssrc-group:".concat(D.semantic).concat(D.ssrcIds.map(L=>"".concat(u).concat(L.toString(10))).join("")).concat(this.eol)).join("")}}function wt(st){return new Yt().parse(st)}function oe(st,T){return new Qr().print(st,T)}}},i={};function r(o){if(i[o])return i[o].exports;var s=i[o]={exports:{}};return n[o](s,s.exports,r),s.exports}return r.d=(o,s)=>{for(var a in s)r.o(s,a)&&!r.o(o,a)&&Object.defineProperty(o,a,{enumerable:!0,get:s[a]})},r.o=(o,s)=>Object.prototype.hasOwnProperty.call(o,s),r.r=o=>{typeof Symbol!="undefined"&&Symbol.toStringTag&&Object.defineProperty(o,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(o,"__esModule",{value:!0})},r(8)})()})(b0);var je=b0.exports;function qr(t){if(Array.isArray(t))return t.map(n=>n);if(!A0(t))return t;const e={};for(const n in t){const i=t[n];A0(i)||Array.isArray(i)?e[n]=qr(i):e[n]=i}return e}function A0(t){return!(typeof t!="object"||Array.isArray(t)||!t)}class NT{constructor(e){R(this,"input",[]),R(this,"size",void 0),this.size=e}add(e){this.input.push(e),this.input.length>this.size&&this.input.splice(0,1)}diffMean(){return this.input.length===0?0:(this.input[this.input.length-1]-this.input[0])/this.input.length}}const Yo={address:"unknown",candidateType:"unknown",id:"unknown",port:0,priority:0,protocol:"unknown",type:"unknown"},Nl={timestamp:0,bitrate:{actualEncoded:0,transmit:0},sendPacketLossRate:0,recvPacketLossRate:0,videoRecv:[],videoSend:[],audioRecv:[],audioSend:[],selectedCandidatePair:{id:"unknown",localCandidate:Yo,remoteCandidate:Yo}},w0={firsCount:0,nacksCount:0,plisCount:0,framesDecodeCount:0,framesDecodeInterval:0,framesDecodeFreezeTime:0,decodeFrameRate:0,bytes:0,packetsLost:0,packetLostRate:0,packets:0,ssrc:0,qpSumPerFrame:0,framesDroppedCount:0,outputFrameRate:0},O0={firsCount:0,nacksCount:0,plisCount:0,frameCount:0,bytes:0,packets:0,packetsLost:0,packetLostRate:0,ssrc:0,rttMs:0,jitterMs:0,qpSumPerFrame:0},N0={bytes:0,packets:0,packetsLost:0,packetLostRate:0,ssrc:0,rttMs:0,jitterMs:0},D0={jitterBufferMs:0,jitterMs:0,bytes:0,packetsLost:0,packetLostRate:0,packets:0,ssrc:0,receivedFrames:0,droppedFrames:0,concealedSamples:0};function P0(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),n.push.apply(n,i)}return n}function L0(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?P0(Object(n),!0).forEach(function(i){R(t,i,n[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):P0(Object(n)).forEach(function(i){Object.defineProperty(t,i,Object.getOwnPropertyDescriptor(n,i))})}return t}class DT{constructor(e,n){R(this,"onFirstVideoReceived",void 0),R(this,"onFirstVideoDecoded",void 0),R(this,"onFirstAudioReceived",void 0),R(this,"onFirstVideoDecodedTimeout",void 0),R(this,"onFirstAudioDecoded",void 0),R(this,"onSelectedLocalCandidateChanged",void 0),R(this,"onSelectedRemoteCandidateChanged",void 0),R(this,"videoIsReady",!1),R(this,"videoIsReady2",{}),R(this,"pc",void 0),R(this,"options",void 0),R(this,"intervalTimer",void 0),R(this,"stats",qr(Nl)),R(this,"isFirstVideoReceived",{}),R(this,"isFirstVideoDecoded",{}),R(this,"isFirstAudioReceived",{}),R(this,"isFirstAudioDecoded",{}),R(this,"isFirstVideoDecodedTimeout",{}),R(this,"lossRateWindowStats",[]),this.pc=e,this.options=n,this.intervalTimer=window.setInterval(async()=>{this.updateStats()},this.options.updateInterval)}getStats(){return this.stats}getSelectedCandidatePair(){return new ot(e=>{e({local:L0({},Yo),remote:L0({},Yo)})})}setVideoIsReady(e){this.videoIsReady=e}setVideoIsReady2(e,n){this.videoIsReady2[e]=n}getVideoIsReady(e){return this.videoIsReady2[e]||!1}setIsFirstAudioDecoded(e){}destroy(){window.clearInterval(this.intervalTimer),this.pc=void 0}calcLossRate(e){this.lossRateWindowStats.push(e),this.lossRateWindowStats.length>this.options.lossRateInterval&&this.lossRateWindowStats.splice(0,1);const n=this.lossRateWindowStats.length,i=["videoSend","audioSend","videoRecv","audioRecv"];let r=0,o=0,s=0,a=0;for(const c of i)e[c].forEach((d,u)=>{if(!this.lossRateWindowStats[n-1][c][u]||!this.lossRateWindowStats[0][c][u])return;const l=this.lossRateWindowStats[n-1][c][u].packets-this.lossRateWindowStats[0][c][u].packets,p=this.lossRateWindowStats[n-1][c][u].packetsLost-this.lossRateWindowStats[0][c][u].packetsLost;c==="videoSend"||c==="audioSend"?(r+=l,s+=p):(o+=l,a+=p),Number.isNaN(l)||Number.isNaN(l)?d.packetLostRate=0:d.packetLostRate=l<=0||p<=0?0:p/(l+p)});e.sendPacketLossRate=r<=0||s<=0?0:s/(r+s),e.recvPacketLossRate=o<=0||a<=0?0:a/(o+a)}}function k0(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),n.push.apply(n,i)}return n}function t3(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?k0(Object(n),!0).forEach(function(i){R(t,i,n[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):k0(Object(n)).forEach(function(i){Object.defineProperty(t,i,Object.getOwnPropertyDescriptor(n,i))})}return t}class e3 extends DT{constructor(){super(...arguments),R(this,"_stats",Nl),R(this,"lastDecodeVideoReceiverStats",new Map)}async updateStats(){const e=await this._getStats(),n=this.statsResponsesToObjects(e);this._stats=qr(Nl);const i=n.filter(o=>o.type==="ssrc");this.processSSRCStats(i);const r=n.find(o=>o.type==="VideoBwe");r&&this.processBandwidthStats(r),this._stats.timestamp=Date.now(),this.calcLossRate(this._stats),this.stats=this._stats}processBandwidthStats(e){this._stats.bitrate={actualEncoded:Number(e.googActualEncBitrate),targetEncoded:Number(e.googTargetEncBitrate),retransmit:Number(e.googRetransmitBitrate),transmit:Number(e.googTransmitBitrate)},this._stats.sendBandwidth=Number(e.googAvailableSendBandwidth)}processSSRCStats(e){e.forEach(n=>{var i;const r=it(i=n.id).call(i,"send");switch("".concat(n.mediaType,"_").concat(r?"send":"recv")){case"video_send":{const o=qr(O0);o.codec=n.googCodecName,o.adaptionChangeReason="none",n.googCpuLimitedResolution&&(o.adaptionChangeReason="cpu"),n.googBandwidthLimitedResolution&&(o.adaptionChangeReason="bandwidth"),o.avgEncodeMs=Number(n.googAvgEncodeMs),o.inputFrame={width:Number(n.googFrameWidthInput)||Number(n.googFrameWidthSent),height:Number(n.googFrameHeightInput)||Number(n.googFrameHeightSent),frameRate:Number(n.googFrameRateInput)},o.sentFrame={width:Number(n.googFrameWidthSent),height:Number(n.googFrameHeightSent),frameRate:Number(n.googFrameRateInput)},o.firsCount=Number(n.googFirReceived),o.nacksCount=Number(n.googNacksReceived),o.plisCount=Number(n.googPlisReceived),o.frameCount=Number(n.framesEncoded),o.bytes=Number(n.bytesSent),o.packets=Number(n.packetsSent),o.packetsLost=Number(n.packetsLost),o.ssrc=Number(n.ssrc),o.rttMs=Number(n.googRtt||0),this._stats.videoSend.push(o),this._stats.rtt=o.rttMs;break}case"video_recv":{const o=qr(w0),s=this.lastDecodeVideoReceiverStats.get(Number(n.ssrc));if(o.codec=n.googCodecName,o.targetDelayMs=Number(n.googTargetDelayMs),o.renderDelayMs=Number(n.googRenderDelayMs),o.currentDelayMs=Number(n.googCurrentDelayMs),o.minPlayoutDelayMs=Number(n.googMinPlayoutDelayMs),o.decodeMs=Number(n.googDecodeMs),o.maxDecodeMs=Number(n.googMaxDecodeMs),o.receivedFrame={width:Number(n.googFrameWidthReceived),height:Number(n.googFrameHeightReceived),frameRate:Number(n.googFrameRateReceived)},o.decodedFrame={width:Number(n.googFrameWidthReceived),height:Number(n.googFrameHeightReceived),frameRate:Number(n.googFrameRateDecoded)},o.decodeFrameRate=Number(n.googFrameRateDecoded),o.outputFrame={width:Number(n.googFrameWidthReceived),height:Number(n.googFrameHeightReceived),frameRate:Number(n.googFrameRateOutput)},o.jitterBufferMs=Number(n.googJitterBufferMs),o.firsCount=Number(n.googFirsSent),o.nacksCount=Number(n.googNacksSent),o.plisCount=Number(n.googPlisSent),o.framesDecodeCount=Number(n.framesDecoded),o.bytes=Number(n.bytesReceived),o.packets=Number(n.packetsReceived),o.packetsLost=Number(n.packetsLost),o.ssrc=Number(n.ssrc),o.packets>0&&!this.isFirstVideoReceived[o.ssrc]&&(this.onFirstVideoReceived&&this.onFirstVideoReceived(o.ssrc),this.isFirstVideoReceived[o.ssrc]=!0),o.framesDecodeCount>0&&!this.isFirstVideoDecoded[o.ssrc]&&(this.onFirstVideoDecoded&&this.onFirstVideoDecoded(o.ssrc,o.decodedFrame.width,o.decodedFrame.height),this.isFirstVideoDecoded[o.ssrc]=!0),s){const a=s.stats,c=Date.now()-s.lts;o.framesDecodeFreezeTime=a.framesDecodeFreezeTime,o.framesDecodeInterval=a.framesDecodeInterval,o.framesDecodeCount>a.framesDecodeCount&&this.isFirstVideoDecoded[o.ssrc]?(s.lts=Date.now(),o.framesDecodeInterval=c,o.framesDecodeInterval>=this.options.freezeRateLimit&&(this.getVideoIsReady(parseInt(n.ssrc,10))?o.framesDecodeFreezeTime+=o.framesDecodeInterval:this.setVideoIsReady2(parseInt(n.ssrc,10),!0))):o.framesDecodeCount<s.stats.framesDecodeCount&&(o.framesDecodeInterval=0)}this.lastDecodeVideoReceiverStats.set(o.ssrc,{stats:t3({},o),lts:Date.now()}),this._stats.videoRecv.push(o);break}case"audio_recv":{const o=qr(D0);o.codec=n.googCodecName,o.outputLevel=Math.abs(Number(n.audioOutputLevel))/32767,o.decodingCNG=Number(n.googDecodingCNG),o.decodingCTN=Number(n.googDecodingCTN),o.decodingCTSG=Number(n.googDecodingCTSG),o.decodingNormal=Number(n.googDecodingNormal),o.decodingPLC=Number(n.googDecodingPLC),o.decodingPLCCNG=Number(n.googDecodingPLCCNG),o.expandRate=Number(n.googExpandRate),o.accelerateRate=Number(n.googAccelerateRate),o.preemptiveExpandRate=Number(n.googPreemptiveExpandRate),o.secondaryDecodedRate=Number(n.googSecondaryDecodedRate),o.speechExpandRate=Number(n.googSpeechExpandRate),o.preferredJitterBufferMs=Number(n.googPreferredJitterBufferMs),o.jitterBufferMs=Number(n.googJitterBufferMs),o.jitterMs=Number(n.googJitterReceived),o.bytes=Number(n.bytesReceived),o.packets=Number(n.packetsReceived),o.packetsLost=Number(n.packetsLost),o.ssrc=Number(n.ssrc),o.receivedFrames=Number(n.googDecodingCTN)||Number(n.packetsReceived),o.droppedFrames=Number(n.googDecodingPLC)+Number(n.googDecodingPLCCNG)||Number(n.packetsLost),o.receivedFrames>0&&!this.isFirstAudioReceived[o.ssrc]&&(this.onFirstAudioReceived&&this.onFirstAudioReceived(o.ssrc),this.isFirstAudioReceived[o.ssrc]=!0),o.decodingNormal>0&&!this.isFirstAudioDecoded[o.ssrc]&&(this.onFirstAudioDecoded&&this.onFirstAudioDecoded(o.ssrc),this.isFirstAudioDecoded[o.ssrc]=!0),this._stats.audioRecv.push(o);break}case"audio_send":{const o=qr(N0);o.codec=n.googCodecName,o.inputLevel=Math.abs(Number(n.audioInputLevel))/32767,o.aecReturnLoss=Number(n.googEchoCancellationReturnLoss||0),o.aecReturnLossEnhancement=Number(n.googEchoCancellationReturnLossEnhancement||0),o.residualEchoLikelihood=Number(n.googResidualEchoLikelihood||0),o.residualEchoLikelihoodRecentMax=Number(n.googResidualEchoLikelihoodRecentMax||0),o.bytes=Number(n.bytesSent),o.packets=Number(n.packetsSent),o.packetsLost=Number(n.packetsLost),o.ssrc=Number(n.ssrc),o.rttMs=Number(n.googRtt||0),this._stats.rtt=o.rttMs,this._stats.audioSend.push(o);break}}})}_getStats(){return new ot((e,n)=>{this.pc.getStats(e,n)})}statsResponsesToObjects(e){const n=[];return e.result().forEach(i=>{const r={id:i.id,timestamp:i.timestamp.valueOf().toString(),type:i.type};i.names().forEach(o=>{r[o]=i.stat(o)}),n.push(r)}),n}}function M0(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),n.push.apply(n,i)}return n}function nc(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?M0(Object(n),!0).forEach(function(i){R(t,i,n[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):M0(Object(n)).forEach(function(i){Object.defineProperty(t,i,Object.getOwnPropertyDescriptor(n,i))})}return t}class U0 extends DT{constructor(){super(...arguments),R(this,"_stats",Nl),R(this,"report",void 0),R(this,"lastDecodeVideoReceiverStats",new Map),R(this,"lastVideoFramesRecv",new Map),R(this,"lastVideoFramesSent",new Map),R(this,"lastVideoFramesDecode",new Map),R(this,"lastVideoFramesOutput",new Map),R(this,"lastVideoJBDelay",new Map),R(this,"lastAudioJBDelay",new Map),R(this,"mediaBytesSent",new Map),R(this,"mediaBytesRetransmit",new Map),R(this,"mediaBytesTargetEncode",new Map),R(this,"lastEncoderMs",new Map)}async updateStats(){this.report=await this.pc.getStats(),this._stats=qr(Nl),this.report.forEach(e=>{switch(e.type){case Zi.OUTBOUND:case Zi.INBOUND:{const n=e.mediaType||e.kind,i=!n&&"frameWidth"in e,r=!n&&!("frameWidth"in e);e.type===Zi.OUTBOUND?n==="audio"||r?this.processAudioOutboundStats(e):(n==="video"||i)&&this.processVideoOutboundStats(e):e.type===Zi.INBOUND&&(n==="audio"||r?this.processAudioInboundStats(e):(n==="video"||i)&&this.processVideoInboundStats(e));break}case Zi.TRANSPORT:{const n=this.report.get(e.selectedCandidatePairId);n&&this.processCandidatePairStats(n);break}case Zi.CANDIDATE_PAIR:e.selected&&this.processCandidatePairStats(e)}}),this.updateSendBitrate(),this._stats.timestamp=Date.now(),this.calcLossRate(this._stats),this.stats=this._stats}async getSelectedCandidatePair(){const e=await this.pc.getStats(),n={local:nc({},Yo),remote:nc({},Yo)};return e.forEach(i=>{let r;if(i.type===Zi.TRANSPORT&&(r=e.get(i.selectedCandidatePairId)),i.type===Zi.CANDIDATE_PAIR&&i.selected&&(r=i),r){const o=(s,a)=>{s.type=a.type,s.id=a.id,a.address&&(s.address=a.address),a.candidateType&&(s.candidateType=a.candidateType),a.port&&(s.port=a.port),a.priority&&(s.priority=a.priority),a.protocol&&(s.protocol=a.protocol),a.relayProtocol&&(s.relayProtocol=a.relayProtocol)};if(r.localCandidateId){const s=e.get(r.localCandidateId);s&&o(n.local,s)}if(r.remoteCandidateId){const s=e.get(r.remoteCandidateId);s&&o(n.remote,s)}}}),n}processCandidatePairStats(e){if(this._stats.sendBandwidth=e.availableOutgoingBitrate||0,e.currentRoundTripTime&&(this._stats.rtt=1e3*e.currentRoundTripTime),this._stats.videoSend.forEach(n=>{e.currentRoundTripTime&&(n.rttMs=1e3*e.currentRoundTripTime)}),this._stats.audioSend.forEach(n=>{e.currentRoundTripTime&&(n.rttMs=1e3*e.currentRoundTripTime)}),this._stats.selectedCandidatePair.id=e.id,e.localCandidateId){const n=this.report.get(e.localCandidateId);n&&this.processCandidateStats(n)}if(e.remoteCandidateId){const n=this.report.get(e.remoteCandidateId);n&&this.processCandidateStats(n)}}processCandidateStats(e){let n;e.type===Zi.LOCAL_CANDIDATE&&(n=this._stats.selectedCandidatePair.localCandidate),e.type===Zi.REMOTE_CANDIDATE&&(n=this._stats.selectedCandidatePair.remoteCandidate),n&&(n.type=e.type,n.id=e.id,e.address&&(n.address=e.address),e.candidateType&&(n.candidateType=e.candidateType),e.port&&(n.port=e.port),e.priority&&(n.priority=e.priority),e.protocol&&(n.protocol=e.protocol),e.relayProtocol&&(n.relayProtocol=e.relayProtocol),e.type===Zi.LOCAL_CANDIDATE&&this.stats.selectedCandidatePair.localCandidate.id!==n.id&&this.onSelectedLocalCandidateChanged&&this.onSelectedLocalCandidateChanged(nc({},n),nc({},this.stats.selectedCandidatePair.localCandidate)),e.type===Zi.REMOTE_CANDIDATE&&this.stats.selectedCandidatePair.remoteCandidate.id!==n.id&&this.onSelectedRemoteCandidateChanged&&this.onSelectedRemoteCandidateChanged(nc({},n),nc({},this.stats.selectedCandidatePair.remoteCandidate)))}processAudioInboundStats(e){let n=this._stats.audioRecv.find(i=>i.ssrc===e.ssrc);n||(n=qr(D0),this._stats.audioRecv.push(n)),n.ssrc=e.ssrc,n.packets=e.packetsReceived,n.packetsLost=e.packetsLost,n.bytes=e.bytesReceived,n.jitterMs=1e3*e.jitter,this.processAudioTrackReceiverStats(e,e.trackId,n),e.codecId&&(n.codec=this.getCodecFromCodecStats(e.codecId)),n.receivedFrames||(n.receivedFrames=e.packetsReceived),n.droppedFrames||(n.droppedFrames=e.packetsLost),n.receivedFrames>0&&!this.isFirstAudioReceived[n.ssrc]&&(this.onFirstAudioReceived&&this.onFirstAudioReceived(n.ssrc),this.isFirstAudioReceived[n.ssrc]=!0),n.outputLevel&&n.outputLevel>0&&!this.isFirstAudioDecoded[n.ssrc]&&(this.onFirstAudioDecoded&&this.onFirstAudioDecoded(n.ssrc),this.isFirstAudioDecoded[n.ssrc]=!0),typeof e.concealedSamples=="number"&&(n.concealedSamples=e.concealedSamples)}processVideoInboundStats(e){let n=this._stats.videoRecv.find(a=>a.ssrc===e.ssrc);n||(n=qr(w0),this._stats.videoRecv.push(n)),n.ssrc=e.ssrc,n.packets=e.packetsReceived,n.packetsLost=e.packetsLost,n.bytes=e.bytesReceived,n.firsCount=e.firCount,n.nacksCount=e.nackCount,n.plisCount=e.pliCount,n.framesDecodeCount=e.framesDecoded,n.framesDroppedCount=e.framesDropped,n.totalInterFrameDelay=e.totalInterFrameDelay,n.totalSquaredInterFrameDelay=e.totalSquaredInterFrameDelay,n.totalFreezesDuration=e.totalFreezesDuration;const i=this.lastDecodeVideoReceiverStats.get(n.ssrc),r=this.lastVideoFramesDecode.get(n.ssrc),o=this.lastVideoFramesOutput.get(n.ssrc),s=Date.now();if(n.framesDecodeCount>0&&!this.isFirstVideoDecoded[n.ssrc]){const a=n.decodedFrame?n.decodedFrame.width:0,c=n.decodedFrame?n.decodedFrame.height:0;this.onFirstVideoDecoded&&this.onFirstVideoDecoded(n.ssrc,a,c),this.isFirstVideoDecoded[n.ssrc]=!0}if(i){const a=i.stats,c=s-i.lts;n.framesDecodeFreezeTime=a.framesDecodeFreezeTime,n.framesDecodeInterval=a.framesDecodeInterval,!this.isFirstVideoDecoded[n.ssrc]&&c>this.options.firstVideoDecodedTimeout&&!this.isFirstVideoDecodedTimeout[n.ssrc]&&(this.onFirstVideoDecodedTimeout&&this.onFirstVideoDecodedTimeout(n.ssrc),this.isFirstVideoDecodedTimeout[n.ssrc]=!0),n.framesDecodeCount>a.framesDecodeCount&&this.isFirstVideoDecoded[n.ssrc]?(i.lts=Date.now(),n.framesDecodeInterval=c,n.framesDecodeInterval>=this.options.freezeRateLimit&&(this.getVideoIsReady(parseInt(e.ssrc))?n.framesDecodeFreezeTime+=n.framesDecodeInterval:this.setVideoIsReady2(parseInt(e.ssrc,10),!0))):n.framesDecodeCount<a.framesDecodeCount&&(n.framesDecodeInterval=0),e.framesDecoded&&e.qpSum&&(i.stats.framesDecodeCount>e.framesDecoded?n.qpSumPerFrame=e.qpSum/e.framesDecoded:n.qpSumPerFrame=(e.qpSum-i.qpSum)/(e.framesDecoded-i.stats.framesDecodeCount))}r&&s-r.lts>=800?(n.decodeFrameRate=Math.round((n.framesDecodeCount-r.count)/((s-r.lts)/1e3)),this.lastVideoFramesDecode.set(n.ssrc,{count:n.framesDecodeCount,lts:s,rate:n.decodeFrameRate})):r?n.decodeFrameRate=r.rate:this.lastVideoFramesDecode.set(n.ssrc,{count:n.framesDecodeCount,lts:s,rate:0}),n.framesDroppedCount&&e.framesReceived&&(o&&s-o.lts>=800?(n.outputFrameRate=Math.round((e.framesReceived-n.framesDroppedCount-o.count)/((s-o.lts)/1e3)),this.lastVideoFramesOutput.set(n.ssrc,{count:e.framesReceived-n.framesDroppedCount,lts:s,rate:Math.max(n.outputFrameRate,0)})):o?n.outputFrameRate=o.rate:this.lastVideoFramesOutput.set(n.ssrc,{count:e.framesReceived-n.framesDroppedCount,lts:s,rate:0})),e.totalDecodeTime&&(n.decodeMs=1e3*e.totalDecodeTime),this.processVideoTrackReceiverStats(e,e.trackId,n),e.codecId&&(n.codec=this.getCodecFromCodecStats(e.codecId)),e.framerateMean&&(n.framesRateFirefox=e.framerateMean),n.packets>0&&!this.isFirstVideoReceived[n.ssrc]&&(this.onFirstVideoReceived&&this.onFirstVideoReceived(n.ssrc),this.isFirstVideoReceived[n.ssrc]=!0),this.lastDecodeVideoReceiverStats.set(n.ssrc,{stats:nc({},n),lts:i?i.lts:Date.now(),qpSum:e.qpSum})}processVideoOutboundStats(e){let n=this._stats.videoSend.find(r=>r.ssrc===e.ssrc);n||(n=qr(O0),this._stats.videoSend.push(n));const i=this.mediaBytesSent.get(e.ssrc);if(i)i.add(e.bytesSent);else{const r=new NT(10);r.add(e.bytesSent),this.mediaBytesSent.set(e.ssrc,r)}if(e.retransmittedBytesSent!==void 0){const r=this.mediaBytesRetransmit.get(e.ssrc);if(r)r.add(e.retransmittedBytesSent);else{const o=new NT(10);o.add(e.retransmittedBytesSent),this.mediaBytesRetransmit.set(e.ssrc,o)}}if(e.totalEncodedBytesTarget){const r=this.mediaBytesTargetEncode.get(e.ssrc);if(r)r.add(e.totalEncodedBytesTarget);else{const o=new NT(10);o.add(e.totalEncodedBytesTarget),this.mediaBytesTargetEncode.set(e.ssrc,o)}}if(n.ssrc=e.ssrc,n.bytes=e.bytesSent,n.packets=e.packetsSent,n.firsCount=e.firCount,n.nacksCount=e.nackCount,n.plisCount=e.pliCount,n.frameCount=e.framesEncoded,n.adaptionChangeReason=e.qualityLimitationReason,n.scalabilityMode=e.scalabilityMode,e.totalEncodeTime&&e.framesEncoded){const r=this.lastEncoderMs.get(e.ssrc);if(!r||r.lastFrameCount>e.framesEncoded)n.avgEncodeMs=1e3*e.totalEncodeTime/e.framesEncoded;else{const o=e.framesEncoded-r.lastFrameCount,s=e.totalEncodeTime-r.lastEncoderTime;n.avgEncodeMs=1e3*s/o}}if(e.framesEncoded&&e.qpSum){const r=this.lastEncoderMs.get(e.ssrc);!r||r.lastFrameCount>e.framesEncoded?n.qpSumPerFrame=e.qpSum/e.framesEncoded:n.qpSumPerFrame=(e.qpSum-r.lastQpSum)/(e.framesEncoded-r.lastFrameCount)}if(this.lastEncoderMs.set(e.ssrc,{lastFrameCount:e.framesEncoded,lastEncoderTime:e.totalEncodeTime,lastQpSum:e.qpSum,lts:Date.now()}),e.codecId&&(n.codec=this.getCodecFromCodecStats(e.codecId)),e.mediaSourceId&&this.processVideoMediaSource(e.mediaSourceId,n),this.processVideoTrackSenderStats(e,e.trackId,n),e.remoteId)this.processRemoteInboundStats(e.remoteId,n);else{const r=this.findRemoteStatsId(e.ssrc,Zi.REMOTE_INBOUND);r&&this.processRemoteInboundStats(r,n)}}processAudioOutboundStats(e){let n=this._stats.audioSend.find(i=>i.ssrc===e.ssrc);if(n||(n=qr(N0),this._stats.audioSend.push(n)),n.ssrc=e.ssrc,n.packets=e.packetsSent,n.bytes=e.bytesSent,e.mediaSourceId&&this.processAudioMediaSource(e.mediaSourceId,n),e.codecId&&(n.codec=this.getCodecFromCodecStats(e.codecId)),this.processAudioTrackSenderStats(e,e.trackId,n),e.remoteId)this.processRemoteInboundStats(e.remoteId,n);else{const i=this.findRemoteStatsId(e.ssrc,Zi.REMOTE_INBOUND);i&&this.processRemoteInboundStats(i,n)}}findRemoteStatsId(e,n){var i;const r=Array.from(ao(i=this.report).call(i)).find(o=>o.type===n&&o.ssrc===e);return r?r.id:null}processVideoMediaSource(e,n){const i=this.report.get(e);i&&i.width&&i.height&&i.framesPerSecond&&(n.inputFrame={width:i.width,height:i.height,frameRate:i.framesPerSecond})}processAudioMediaSource(e,n){const i=this.report.get(e);i&&(n.inputLevel=i.audioLevel)}processVideoTrackSenderStats(e,n,i){var r,o,s,a;const c=n?this.report.get(n):void 0,d=(r=c==null?void 0:c.framesSent)!==null&&r!==void 0?r:e.framesSent;if(typeof d!="number")return;let u=(o=c==null?void 0:c.frameWidth)!==null&&o!==void 0?o:e.frameWidth,l=(s=c==null?void 0:c.frameHeight)!==null&&s!==void 0?s:e.frameHeight,p=(a=c==null?void 0:c.framesPerSecond)!==null&&a!==void 0?a:e.framesPerSecond;if(typeof u=="number"&&typeof l=="number"||(u=0,l=0),p==null){const f=Date.now(),C=this.lastVideoFramesSent.get(i.ssrc);C&&f-C.lts>=800?(p=Math.round((d-C.count)/((f-C.lts)/1e3)),this.lastVideoFramesSent.set(i.ssrc,{count:d,lts:f,rate:p})):C?p=C.rate:this.lastVideoFramesSent.set(i.ssrc,{count:d,lts:f,rate:0})}i.sentFrame={width:u,height:l,frameRate:Math.max(0,p)}}processVideoTrackReceiverStats(e,n,i){var r,o,s,a,c;const d=n?this.report.get(n):void 0,u=(r=d==null?void 0:d.framesReceived)!==null&&r!==void 0?r:e.framesReceived,l=(o=d==null?void 0:d.frameWidth)!==null&&o!==void 0?o:e.frameWidth,p=(s=d==null?void 0:d.frameHeight)!==null&&s!==void 0?s:e.frameHeight,f=(a=d==null?void 0:d.jitterBufferDelay)!==null&&a!==void 0?a:e.jitterBufferDelay,C=(c=d==null?void 0:d.jitterBufferEmittedCount)!==null&&c!==void 0?c:e.jitterBufferEmittedCount;if(typeof u=="number"){const m=this.lastVideoFramesRecv.get(i.ssrc),g=Date.now();i.framesReceivedCount=u;let y=0;m&&g-m.lts>=800?(y=Math.round((u-m.count)/((g-m.lts)/1e3)),this.lastVideoFramesRecv.set(i.ssrc,{count:u,lts:g,rate:y})):m?y=m.rate:this.lastVideoFramesRecv.set(i.ssrc,{count:u,lts:g,rate:0}),i.receivedFrame={width:l||0,height:p||0,frameRate:y||0},i.decodedFrame={width:l||0,height:p||0,frameRate:i.decodeFrameRate||0},i.outputFrame={width:l||0,height:p||0,frameRate:i.outputFrameRate||i.decodeFrameRate||0}}if(f&&C){const m=this.lastVideoJBDelay.get(i.ssrc)||{jitterBufferDelay:0,jitterBufferEmittedCount:0,jitterBufferMs:0};let g=m.jitterBufferMs;const y=C-m.jitterBufferEmittedCount;y>0&&(g=1e3*(f-m.jitterBufferDelay)/y),i.jitterBufferMs=g,i.currentDelayMs=Math.round(g),this.lastVideoJBDelay.set(i.ssrc,{jitterBufferDelay:f,jitterBufferEmittedCount:C,jitterBufferMs:i.currentDelayMs})}}processAudioTrackSenderStats(e,n,i){var r,o,s,a;const c=n?this.report.get(n):void 0,d=(r=(o=c==null?void 0:c.echoReturnLoss)!==null&&o!==void 0?o:e.echoReturnLoss)!==null&&r!==void 0?r:0,u=(s=(a=c==null?void 0:c.echoReturnLossEnhancement)!==null&&a!==void 0?a:e.echoReturnLossEnhancement)!==null&&s!==void 0?s:0;i.aecReturnLoss=d,i.aecReturnLossEnhancement=u}processAudioTrackReceiverStats(e,n,i){var r,o,s,a,c,d,u;const l=n?this.report.get(n):void 0,p=(r=l==null?void 0:l.removedSamplesForAcceleration)!==null&&r!==void 0?r:e.removedSamplesForAcceleration,f=(o=l==null?void 0:l.totalSamplesReceived)!==null&&o!==void 0?o:e.totalSamplesReceived,C=(s=l==null?void 0:l.jitterBufferDelay)!==null&&s!==void 0?s:e.jitterBufferDelay,m=(a=l==null?void 0:l.jitterBufferEmittedCount)!==null&&a!==void 0?a:e.jitterBufferEmittedCount,g=(c=l==null?void 0:l.audioLevel)!==null&&c!==void 0?c:e==null?void 0:e.audioLevel,y=(d=l==null?void 0:l.totalSamplesDuration)!==null&&d!==void 0?d:e==null?void 0:e.totalSamplesDuration,A=(u=l==null?void 0:l.concealedSamples)!==null&&u!==void 0?u:e.concealedSamples;if(p&&f&&(i.accelerateRate=p/f),C&&m){const M=this.lastAudioJBDelay.get(i.ssrc)||{jitterBufferDelay:0,jitterBufferEmittedCount:0,jitterBufferMs:0};let V=M.jitterBufferMs;const B=m-M.jitterBufferEmittedCount;B>0&&(V=1e3*(C-M.jitterBufferDelay)/B),i.jitterBufferMs=Math.round(V),this.lastAudioJBDelay.set(i.ssrc,{jitterBufferDelay:C,jitterBufferEmittedCount:m,jitterBufferMs:i.jitterBufferMs})}i.outputLevel=g;let k=1920;y&&f&&(k=f/y/50,i.receivedFrames=Math.round(f/k)),A&&(i.droppedFrames=Math.round(A/k))}processRemoteInboundStats(e,n){const i=this.report.get(e);i&&(n.packetsLost=i.packetsLost,i.roundTripTime&&(n.rttMs=1e3*i.roundTripTime),i.jitter&&(n.jitterMs=1e3*i.jitter),i.timestamp&&(n.timestamp=i.timestamp))}getCodecFromCodecStats(e){const n=this.report.get(e);if(!n)return"";const i=n.mimeType.match(/\/(.*)$/);return i&&i[1]?i[1]:""}updateSendBitrate(){let e=0,n=null,i=null;this.mediaBytesSent.forEach(o=>{e+=o.diffMean()}),this.mediaBytesRetransmit.forEach(o=>{n=n===null?o.diffMean():n+o.diffMean()}),this.mediaBytesTargetEncode.forEach(o=>{i=i===null?o.diffMean():i+o.diffMean()});const r=n!==null?e-n:e;this._stats.bitrate={actualEncoded:8*r/(this.options.updateInterval/1e3),transmit:8*e/(this.options.updateInterval/1e3)},n!==null&&(this._stats.bitrate.retransmit=8*n/(this.options.updateInterval/1e3)),i!==null&&(this._stats.bitrate.targetEncoded=8*i/(this.options.updateInterval/1e3))}}class n3 extends DT{updateStats(){return ot.resolve()}}function Nf(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:250,n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:8,i=arguments.length>3&&arguments[3]!==void 0?arguments[3]:500,r=arguments.length>4&&arguments[4]!==void 0?arguments[4]:1e4;const o=function(){const s=navigator.userAgent.toLocaleLowerCase().match(/chrome\/[\d]*/i);return s&&s[0]?Number(s[0].split("/")[1]):null}();return o?o<76?new e3(t,{updateInterval:e,lossRateInterval:n,freezeRateLimit:i,firstVideoDecodedTimeout:r}):new U0(t,{updateInterval:e,lossRateInterval:n,freezeRateLimit:i,firstVideoDecodedTimeout:r}):function(s){return!!window.RTCStatsReport&&s.getStats()instanceof ot}(t)?new U0(t,{updateInterval:e,lossRateInterval:n,freezeRateLimit:i,firstVideoDecodedTimeout:r}):new n3(t,{updateInterval:e,lossRateInterval:n,freezeRateLimit:i,firstVideoDecodedTimeout:r})}function x0(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),n.push.apply(n,i)}return n}function V0(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?x0(Object(n),!0).forEach(function(i){R(t,i,n[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):x0(Object(n)).forEach(function(i){Object.defineProperty(t,i,Object.getOwnPropertyDescriptor(n,i))})}return t}function Dl(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{},i=arguments.length>3?arguments[3]:void 0;const{filterRTX:r,filterVideoFec:o,filterAudioFec:s,filterAudioCodec:a,filterVideoCodec:c}=e,{useXR:d}=n;let u=[],l=[],p=[],f=[],C=!1,m=!1;if(je.parse(t).mediaDescriptions.forEach(y=>{i&&i!==y.attributes.direction||(y.media.mediaType!=="video"||C||(l=y.attributes.payloads,f=y.attributes.extmaps,C=!0),y.media.mediaType!=="audio"||m||(u=y.attributes.payloads,p=y.attributes.extmaps,m=!0))}),!f||l.length===0)throw new Error("Cannot get video capabilities from SDP.");if(!p||u.length===0)throw new Error("Cannot get audio capabilities from SDP.");if(l.forEach(y=>{var A;(A=y.rtpMap)!==null&&A!==void 0&&A.clockRate&&(y.rtpMap.clockRate=parseInt(y.rtpMap.clockRate)),d&&y.rtcpFeedbacks.push({type:"rrtr"})}),u.forEach(y=>{var A;(A=y.rtpMap)!==null&&A!==void 0&&A.clockRate&&(y.rtpMap.clockRate=parseInt(y.rtpMap.clockRate)),d&&y.rtcpFeedbacks.push({type:"rrtr"})}),r&&(u=u.filter(y=>{var A;return((A=y.rtpMap)===null||A===void 0?void 0:A.encodingName.toLowerCase())!=="rtx"}),l=l.filter(y=>{var A;return((A=y.rtpMap)===null||A===void 0?void 0:A.encodingName.toLowerCase())!=="rtx"})),o&&(l=l.filter(y=>{var A;return!/(red)|(ulpfec)|(flexfec)/i.test(((A=y.rtpMap)===null||A===void 0?void 0:A.encodingName)||"")})),s&&(u=u.filter(y=>{var A;return!/(red)|(ulpfec)|(flexfec)/i.test(((A=y.rtpMap)===null||A===void 0?void 0:A.encodingName)||"")})),a&&(a==null?void 0:a.length)>0&&(u=u.filter(y=>{var A;return it(a).call(a,((A=y.rtpMap)===null||A===void 0?void 0:A.encodingName.toLowerCase())||"")})),c&&(c==null?void 0:c.length)>0){const y=l.filter(A=>{var k;return it(c).call(c,((k=A.rtpMap)===null||k===void 0?void 0:k.encodingName.toLowerCase())||"")});l=y.concat(r?[]:UT(y,l))}const g=N("UNSUPPORTED_VIDEO_CODEC");return g&&g.length>0&&(l=l.filter(y=>!(y.rtpMap&&it(g).call(g,y.rtpMap.encodingName.toLowerCase())))),{audioCodecs:u,videoCodecs:l,audioExtensions:p,videoExtensions:f}}function fo(t){const e=je.parse(t);let n,i;for(const r of e.mediaDescriptions){if(!n){const o=r.attributes.iceUfrag,s=r.attributes.icePwd;if(!o||!s)throw new Error("Cannot get iceUfrag or icePwd from SDP.");n={iceUfrag:o,icePwd:s}}if(!i){const o=r.attributes.fingerprints;o.length>0&&(i={fingerprints:o})}}if(!i&&e.attributes.fingerprints.length>0&&(i={fingerprints:e.attributes.fingerprints}),!i||!n)throw new Error("Cannot get iceParameters or dtlsParameters from SDP.");return{iceParameters:n,dtlsParameters:i}}function PT(t,e){const n=[],i=t.attributes.ssrcGroups.filter(s=>s.semantic==="FID"),r=t.attributes.ssrcGroups.find(s=>s.semantic==="SIM"),o=t.attributes.ssrcs;if(r)r.ssrcIds.forEach(s=>{var a;const c=(a=i.find(d=>d.ssrcIds[0]===s))===null||a===void 0?void 0:a.ssrcIds[1];n.push({ssrcId:s,rtx:e?c:void 0})});else if(i.length>0){const s=i[0].ssrcIds[0],a=i[0].ssrcIds[1];n.push({ssrcId:s,rtx:e?a:void 0})}else{if(o.length===0)throw new Error("No ssrcs found on local media description.");n.push({ssrcId:o[0].ssrcId})}return n}function F0(t,e){const{cname:n}=t;let i;e&&e.ip&&typeof e.port=="number"?(i=[{foundation:"udpcandidate",componentId:"1",transport:"udp",priority:"2103266323",connectionAddress:e.ip,port:e.port.toString(),type:"host",extension:{}}],E.debug("Using remote candidate from AP ".concat(e.ip,":").concat(e.port)),e.ip6&&(i.push({foundation:"udpcandidate",componentId:"1",transport:"udp",priority:"2103266323",connectionAddress:e.ip6,port:e.port.toString(),type:"host",extension:{}}),E.debug("Using IPV6 remote candidate from AP ".concat(e.ip6,":").concat(e.port)))):i=t.iceParameters.candidates.map(a=>({foundation:a.foundation,componentId:"1",transport:a.protocol,priority:a.priority.toString(),connectionAddress:a.ip,port:a.port.toString(),type:a.type,extension:{}}));const r={fingerprints:t.dtlsParameters.fingerprints.map(a=>({hashFunction:a.algorithm,fingerprint:a.fingerprint}))},o={iceUfrag:t.iceParameters.iceUfrag,icePwd:t.iceParameters.icePwd};let s;switch(t.dtlsParameters.role){case"server":s="passive";break;case"client":s="active";break;case"auto":s="actpass"}return{dtlsParameters:r,iceParameters:o,candidates:i,rtpCapabilities:Pd(t.rtpCapabilities),setup:s,cname:n}}function ar(t,e,n){const i=[],r=[];return t.forEach(o=>{let{ssrcId:s,rtx:a}=o;const c=be(8,"track-"),d={ssrcId:s,attributes:V0({label:c,mslabel:n=n||be(10,""),msid:"".concat(n," ").concat(c)},e&&{cname:e})};if(i.push(d),a!==void 0){const u={ssrcId:a,attributes:V0({label:c,mslabel:n,msid:"".concat(n," ").concat(c)},e&&{cname:e})};i.push(u),r.push({semantic:"FID",ssrcIds:[s,a]})}}),t.length>1&&r.push({semantic:"SIM",ssrcIds:t.map(o=>{let{ssrcId:s}=o;return s})}),{ssrcs:i,ssrcGroups:r}}function ra(t,e){e instanceof Qe&&t.attributes.payloads.forEach(n=>{var i;const r=(i=n.rtpMap)===null||i===void 0?void 0:i.encodingName.toLowerCase();if(!r||["opus","pcmu","pcma","g722"].indexOf(r)===-1)return;n.fmtp||(n.fmtp={parameters:{}}),n.fmtp.parameters.minptime="10",n.fmtp.parameters.useinbandfec="1";const o=e._encoderConfig;o&&r!=="pcmu"&&r!=="pcma"&&r!=="g722"&&(o.bitrate&&!ye()&&(n.fmtp.parameters.maxaveragebitrate="".concat(Math.floor(1e3*o.bitrate))),o.sampleRate&&(n.fmtp.parameters.maxplaybackrate="".concat(o.sampleRate),n.fmtp.parameters["sprop-maxcapturerate"]="".concat(o.sampleRate)),o.stereo&&(n.fmtp.parameters.stereo="1",n.fmtp.parameters["sprop-stereo"]="1"))})}function Df(t){const e=t.attributes.unrecognized.findIndex(n=>n.attField==="x-google-flag"&&n.attValue==="conference");e!==-1&&t.attributes.unrecognized.splice(e,1)}function Pf(t,e){var n;if(!(e instanceof Ae&&e._encoderConfig&&e._hints.indexOf(De.SCREEN_TRACK)===-1))return;const i=e._encoderConfig;zt().supportMinBitrate&&i.bitrateMin&&t.attributes.payloads.forEach(r=>{var o,s;it(o=["h264","h265","vp8","vp9","av1"]).call(o,((s=r.rtpMap)===null||s===void 0?void 0:s.encodingName.toLowerCase())||"")&&(r.fmtp||(r.fmtp={parameters:{}}),r.fmtp.parameters["x-google-min-bitrate"]="".concat(i.bitrateMin))}),zt().supportMinBitrate&&!it(n=e._hints).call(n,De.LOW_STREAM)&&i.bitrateMax&&t.attributes.payloads.forEach(r=>{var o,s;it(o=["h264","h265","vp8","vp9","av1"]).call(o,((s=r.rtpMap)===null||s===void 0?void 0:s.encodingName.toLowerCase())||"")&&(r.fmtp||(r.fmtp={parameters:{}}),r.fmtp.parameters["x-google-start-bitrate"]="".concat(N("X_GOOGLE_START_BITRATE")||Math.floor(i.bitrateMax)))})}function LT(t){if(t.media.mediaType!=="video")return;const e=Zt();if(e.name!==ue.SAFARI&&e.os!==bn.IOS)return;const n=t.attributes.extmaps.findIndex(i=>/video-orientation/g.test(i.extensionName));n!==-1&&t.attributes.extmaps.splice(n,1)}function Dd(t,e,n){if(!e)return;let i,r;if(t.media.mediaType==="video"?(i=n.videoExtensions,r=n.videoCodecs):(i=n.audioExtensions,r=n.audioCodecs),e.twcc===!0){const o=i.find(s=>s.extensionName==="http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01");o&&(t.attributes.extmaps.find(a=>a.extensionName==="http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01")||t.attributes.extmaps.push({entry:o.entry,extensionName:"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"}),function(a,c){return c.filter(d=>!!a.find(u=>u.payloadType===d.payloadType&&!!u.rtcpFeedbacks.find(l=>l.type==="transport-cc")))}(r,t.attributes.payloads).forEach(a=>{a.rtcpFeedbacks.find(c=>c.type==="transport-cc")||a.rtcpFeedbacks.push({type:"transport-cc"})}))}else if(e.twcc===!1){const o=t.attributes.extmaps.findIndex(s=>s.extensionName==="http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01");o!==-1&&t.attributes.extmaps.splice(o,1),t.attributes.payloads.forEach(s=>{const a=s.rtcpFeedbacks.findIndex(c=>c.type==="transport-cc");a!==-1&&s.rtcpFeedbacks.splice(a,1)})}if(e.remb===!0){const o=i.find(s=>s.extensionName==="http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time");o&&(t.attributes.extmaps.find(a=>a.extensionName==="http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time")||t.attributes.extmaps.push({entry:o.entry,extensionName:"http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time"}),function(a,c){return c.filter(d=>!!a.find(u=>u.payloadType===d.payloadType&&!!u.rtcpFeedbacks.find(l=>l.type==="goog-remb")))}(r,t.attributes.payloads).forEach(a=>{a.rtcpFeedbacks.find(c=>c.type==="goog-remb")||a.rtcpFeedbacks.push({type:"goog-remb"})}))}else if(e.remb===!1){const o=t.attributes.extmaps.findIndex(s=>s.extensionName==="http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time");o!==-1&&t.attributes.extmaps.splice(o,1),t.attributes.payloads.forEach(s=>{const a=s.rtcpFeedbacks.findIndex(c=>c.type==="goog-remb");a!==-1&&s.rtcpFeedbacks.splice(a,1)})}}function kT(t,e,n){if(ye()||t.media.mediaType!=="video"||!(e instanceof Ae)||n!=="vp9"&&n!=="vp8"||n==="vp8"&&!N("SIMULCAST")||e._scalabilityMode===void 0||e._scalabilityMode.numSpatialLayers<=1)return;const i=n==="vp8"?2:e._scalabilityMode.numSpatialLayers,r=t.attributes.ssrcs[0],o=t.attributes.ssrcGroups.find(a=>a.semantic==="FID"&&a.ssrcIds[0]===r.ssrcId),s={semantic:"SIM",ssrcIds:[r.ssrcId]};for(let a=1;a<i;a++)t.attributes.ssrcs.push({ssrcId:r.ssrcId+a,attributes:Ne(r.attributes)}),s.ssrcIds.push(r.ssrcId+a),o&&(t.attributes.ssrcs.push({ssrcId:o.ssrcIds[1]+a,attributes:Ne(r.attributes)}),t.attributes.ssrcGroups.push({semantic:"FID",ssrcIds:[r.ssrcId+a,o.ssrcIds[1]+a]}));t.attributes.ssrcGroups.unshift(s)}async function MT(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};const n=new RTCPeerConnection;n.addTransceiver("video",{direction:"sendonly"}),n.addTransceiver("audio",{direction:"sendonly"}),n.addTransceiver("video",{direction:"recvonly"}),n.addTransceiver("audio",{direction:"recvonly"});const i=(await n.createOffer()).sdp,{send:r,recv:o,sendrecv:s}=function(){let a=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},c=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},d=arguments.length>2?arguments[2]:void 0;const u=Dl(d,a,c,"sendonly"),l=Dl(d,a,c,"recvonly"),p={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},f={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},C={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]};if(Yr(u,l,"videoExtensions",p,f,C),Yr(u,l,"videoCodecs",p,f,C),Yr(u,l,"audioExtensions",p,f,C),Yr(u,l,"audioCodecs",p,f,C),N("RAISE_H264_BASELINE_PRIORITY")){const m=C.videoCodecs.findIndex(g=>{var y,A;return((y=g.rtpMap)===null||y===void 0?void 0:y.encodingName.toLocaleLowerCase())==="h264"&&((A=g.fmtp)===null||A===void 0?void 0:A.parameters["profile-level-id"])==="42001f"});if(m!==-1){const g=C.videoCodecs.findIndex(y=>{var A;return((A=y.rtpMap)===null||A===void 0?void 0:A.encodingName.toLocaleLowerCase())==="h264"});if(g<m){E.debug("raising H264 baseline profile priority");const y=C.videoCodecs[m];C.videoCodecs.splice(m,1),C.videoCodecs.splice(g,0,y)}g!==-1&&(f.videoCodecs=f.videoCodecs.filter(y=>{var A,k;return!(((A=y.rtpMap)===null||A===void 0?void 0:A.encodingName.toLocaleLowerCase())==="h264"&&((k=y.fmtp)===null||k===void 0?void 0:k.parameters["profile-level-id"])!=="42001f")})),g!==-1&&N("FILTER_SEND_H264_BASELINE")&&(p.videoCodecs=p.videoCodecs.filter(y=>{var A,k;return!(((A=y.rtpMap)===null||A===void 0?void 0:A.encodingName.toLocaleLowerCase())==="h264"&&((k=y.fmtp)===null||k===void 0?void 0:k.parameters["profile-level-id"])!=="42001f")}))}}return{send:p,recv:f,sendrecv:C}}(t,e,i);try{n.close()}catch{}return{send:r,recv:o,sendrecv:s}}function j0(){const t={audioCodecs:[],videoCodecs:[],audioExtensions:[],videoExtensions:[]},e=Dl(arguments.length>2?arguments[2]:void 0,arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},"recvonly"),n={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},i={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},r={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]};if(Yr(t,e,"videoExtensions",n,i,r),Yr(t,e,"videoCodecs",n,i,r),Yr(t,e,"audioExtensions",n,i,r),Yr(t,e,"audioCodecs",n,i,r),N("RAISE_H264_BASELINE_PRIORITY")){const o=r.videoCodecs.findIndex(s=>s.rtpMap&&s.rtpMap.encodingName.toLocaleLowerCase()==="h264"&&s.fmtp&&s.fmtp.parameters["profile-level-id"]==="42001f");if(o!==-1){const s=r.videoCodecs.findIndex(a=>a.rtpMap&&a.rtpMap.encodingName.toLocaleLowerCase()==="h264");if(s<o){E.debug("raising H264 baseline profile priority");const a=r.videoCodecs[o];r.videoCodecs.splice(o,1),r.videoCodecs.splice(s,0,a)}s!==-1&&(i.videoCodecs=i.videoCodecs.filter(a=>!(a.rtpMap&&a.rtpMap.encodingName.toLocaleLowerCase()==="h264"&&a.fmtp&&a.fmtp.parameters["profile-level-id"]!=="42001f")))}}return{send:n,recv:i,sendrecv:r}}function Yr(t,e,n,i,r,o){if(n==="videoExtensions"||n==="audioExtensions"){const s=[];return t[n].forEach(a=>{e[n].some((c,d)=>{if(a.entry===c.entry&&a.extensionName===c.extensionName)return s.push(d),!0})?o[n].push(a):i[n].push(a)}),void e[n].forEach((a,c)=>{s.indexOf(c)===-1&&r[n].push(a)})}if(n==="videoCodecs"||n==="audioCodecs"){const s=[];return t[n].forEach(a=>{e[n].some((c,d)=>{if(a.payloadType===c.payloadType&&JSON.stringify(a)===JSON.stringify(c))return s.push(d),!0})?o[n].push(a):i[n].push(a)}),void e[n].forEach((a,c)=>{s.indexOf(c)===-1&&r[n].push(a)})}}function Pd(t){const{send:e,recv:n,sendrecv:i}=t;if(!i){if(!e||!n)throw new Error("cannot merge rtp capabilities because one of send or recv is empty!");return{send:e,recv:n}}let r,o;return e?(r={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},r.audioCodecs=[...e.audioCodecs,...i.audioCodecs],r.videoCodecs=[...e.videoCodecs,...i.videoCodecs],r.audioExtensions=[...e.audioExtensions,...i.audioExtensions],r.videoExtensions=[...e.videoExtensions,...i.videoExtensions]):r=i,n?(o={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},o.audioCodecs=[...n.audioCodecs,...i.audioCodecs],o.videoCodecs=[...n.videoCodecs,...i.videoCodecs],o.audioExtensions=[...n.audioExtensions,...i.audioExtensions],o.videoExtensions=[...n.videoExtensions,...i.videoExtensions]):o=i,{send:r,recv:o}}function _o(t){t.media.mediaType==="audio"&&t.attributes.payloads.filter(e=>{var n;return((n=e.rtpMap)===null||n===void 0?void 0:n.encodingName.toLowerCase())==="opus"}).forEach(e=>{e.fmtp||(e.fmtp={parameters:{}}),e.fmtp.parameters.stereo="1",e.fmtp.parameters["sprop-stereo"]="1"})}function Lf(t){t.mediaDescriptions.forEach(e=>{e.media.mediaType!=="video"&&e.media.mediaType!=="audio"||e.attributes.payloads.forEach(n=>{n.rtcpFeedbacks.findIndex(i=>i.type==="rrtr")===-1&&n.rtcpFeedbacks.push({type:"rrtr"})})})}function ic(t,e,n,i){let r=[];if(t===_t.VIDEO){if(N("H264_PROFILE_LEVEL_ID")&&i==="h264"&&(r=e.videoCodecs.filter(o=>{var s;return it(s=o.rtpMap&&o.rtpMap.encodingName.toLowerCase()||"").call(s,i)&&o&&o.fmtp&&o.fmtp.parameters["profile-level-id"]===N("H264_PROFILE_LEVEL_ID")})),!Array.isArray(r)||r.length===0){let o=[];const s=[],a=[],c=[];if(n.videoCodecs.forEach(d=>{const u=d.rtpMap&&d.rtpMap.encodingName.toLowerCase()||"";it(u).call(u,i)?o.push(d):it(u).call(u,"vp9")?s.push(d):it(u).call(u,"vp8")?a.push(d):it(u).call(u,"h264")&&c.push(d)}),o.length===0){let d="";s.length!==0?(o=s,d="vp9"):a.length!==0?(o=a,d="vp8"):c.length!==0&&(o=c,d="h264"),E.warning("codec ".concat(i," not included in rtpCapabilities, fallback to default payloads: ").concat(d))}o.length!==0&&(r=e.videoCodecs.filter(d=>o.some(u=>u.payloadType===d.payloadType)))}if(r.length===0&&(E.warning("codec ".concat(i," not included in rtpCapabilities, fallback to default payloads: ").concat(e.videoCodecs[0].rtpMap&&e.videoCodecs[0].rtpMap.encodingName)),r=e.videoCodecs),N("USE_PUB_RTX")||N("USE_SUB_RTX")){const o=UT(r,e.videoCodecs);r=[...r,...o]}}else r=e.audioCodecs.filter(o=>{var s;return it(s=o.rtpMap&&o.rtpMap.encodingName.toLowerCase()||"").call(s,i)}),r.length===0&&(E.warning("codec ".concat(i," not included in rtpCapabilities, fallback to opus")),r=e.audioCodecs.filter(o=>{var s;return it(s=o.rtpMap&&o.rtpMap.encodingName.toLowerCase()||"").call(s,"opus")}));return r}function UT(t,e){const n=t.map(i=>i.payloadType.toString());return e.filter(i=>i.rtpMap&&i.rtpMap.encodingName==="rtx"&&i.fmtp&&i.fmtp.parameters.apt&&it(n).call(n,i.fmtp&&i.fmtp.parameters.apt))}let B0=class{get localCapabilities(){return Ne(this._localCapabilities)}get rtpCapabilities(){return Ne(this._rtpCapabilities)}get candidates(){return Ne(this._candidates)}get iceParameters(){return Ne(this._iceParameters)}get dtlsParameters(){return Ne(this._dtlsParameters)}constructor(t){R(this,"sessionDesc",void 0),R(this,"_localCapabilities",void 0),R(this,"_rtpCapabilities",void 0),R(this,"_candidates",void 0),R(this,"_iceParameters",void 0),R(this,"_dtlsParameters",void 0),R(this,"setup",void 0),R(this,"currentMidIndex",void 0),R(this,"cname","o/i14u9pJrxRKAsu"),R(this,"firefoxSsrcMidMap",new Map),t=Ne(t);const{remoteIceParameters:e,remoteDtlsParameters:n,candidates:i,remoteRTPCapabilities:r,localCapabilities:o,direction:s,setup:a,videoCodec:c,audioCodec:d}=t;let u;this.setup=a,u=s===mi.RECEIVE_ONLY?je.parse(`v=0
o=- 0 0 IN IP4 127.0.0.1
s=AgoraGateway
t=0 0
a=group:BUNDLE 0 1
a=msid-semantic: WMS
a=extmap-allow-mixed
m=video 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendonly
a=rtcp-mux
a=rtcp-rsize
a=mid:0
m=audio 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendonly
a=rtcp-mux
a=rtcp-rsize
a=mid:1
`):je.parse(`v=0
o=- 0 0 IN IP4 127.0.0.1
s=AgoraGateway
t=0 0
a=group:BUNDLE 0 1
a=msid-semantic: WMS
a=extmap-allow-mixed
m=video 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=recvonly
a=rtcp-mux
a=rtcp-rsize
a=mid:0
m=audio 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=recvonly
a=rtcp-mux
a=rtcp-rsize
a=mid:1
`),this._rtpCapabilities=r,this._candidates=i,this._iceParameters=e,this._dtlsParameters=n,this._localCapabilities=o;const l=s===mi.RECEIVE_ONLY?this.rtpCapabilities.send:this.rtpCapabilities.recv,p=s===mi.RECEIVE_ONLY?this._localCapabilities.recv:this._localCapabilities.send,f=s===mi.RECEIVE_ONLY?r.send.videoCodecs:ic(_t.VIDEO,l,p,c),C=s===mi.RECEIVE_ONLY?r.send.audioCodecs:ic(_t.AUDIO,l,p,d);for(const m of u.mediaDescriptions)m.attributes.iceUfrag=e.iceUfrag,m.attributes.icePwd=e.icePwd,m.attributes.fingerprints=n.fingerprints,m.attributes.candidates=i,m.attributes.setup=this.setup,m.media.mediaType==="application"&&(m.attributes.sctpPort="5000"),m.media.mediaType==="video"&&(m.media.fmts=f.map(g=>g.payloadType.toString(10)),m.attributes.payloads=f,m.attributes.extmaps=l.videoExtensions),m.media.mediaType==="audio"&&(m.media.fmts=C.map(g=>g.payloadType.toString(10)),m.attributes.payloads=C,m.attributes.extmaps=l.audioExtensions,_o(m));this.sessionDesc=u,this.currentMidIndex=u.mediaDescriptions.length-1}toString(){return je.print(this.sessionDesc)}hasMid(t){return Array.isArray(t)?t.every(e=>this.hasMid(e)):this.sessionDesc.mediaDescriptions.some(e=>e.attributes.mid===t)}send(t,e,n,i,r){n=n.replace(/ /g,"-");const{ssrcs:o,ssrcGroups:s}=ar(e,this.cname,N("SYNC_GROUP")?n:void 0),a=this.findPreloadMediaDesc(o);if(a){if(ye()&&this.firefoxSsrcMidMap.set(o[0].ssrcId,a.attributes.mid),r&&(r.twcc||r.remb)){const c=this.sessionDesc.mediaDescriptions.indexOf(a);return this.sessionDesc.mediaDescriptions[c]=this.mungSendMediaDesc(a,r),{mid:a.attributes.mid,needExchangeSDP:!0}}return{mid:a.attributes.mid,needExchangeSDP:!1}}{const c=this.findAvailableMediaIndex(t,o,i);let d;return c===-1?(d=this.createOrRecycleSendMedia(t,o,s,"sendonly",i,r),this.updateBundleMids()):(d=Ne(this.sessionDesc.mediaDescriptions[c]),d.attributes.direction="sendonly",d.attributes.ssrcs=o,d.attributes.ssrcGroups=s,this.sessionDesc.mediaDescriptions[c]=this.mungSendMediaDesc(d,r)),ye()&&this.firefoxSsrcMidMap.set(o[0].ssrcId,d.attributes.mid),{needExchangeSDP:!0,mid:d.attributes.mid}}}stopSending(t){const e=this.sessionDesc.mediaDescriptions.filter(n=>n.attributes.mid&&t.indexOf(n.attributes.mid)!==-1);if(e.length!==t.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.stopSending.");e.forEach(n=>{n.attributes.ssrcs=[]}),this.updateBundleMids()}receive(t,e,n){const i=[];return t.forEach(r=>{const o=r._mediaStreamTrack.kind,s=this.findAvailableRecvMediaIndex(o);let a,c=!1;s===-1?(c=!0,a=this.createOrRecycleRecvMedia(r,[],"recvonly",e,n),this.updateBundleMids()):(a=Ne(this.sessionDesc.mediaDescriptions[s]),a.attributes.direction="recvonly"),i.push({mid:a.attributes.mid,needCreateTransceiver:c})}),i}stopReceiving(t){const e=this.sessionDesc.mediaDescriptions.filter(n=>t.indexOf(n.attributes.mid)!==-1);if(e.length!==t.length)throw new Error("MediaDescriptions' length doesn't match mids's length when calling RemoteSDP.receive.");e.forEach(n=>{n.media.port="0",n.attributes.direction="inactive"}),this.updateBundleMids()}addRemoteCandidate(t){const{foundation:e,protocol:n,address:i,port:r,type:o,relatedAddress:s,relatedPort:a,priority:c}=new RTCIceCandidate(t),d={foundation:e!=null?e:"",componentId:"1",transport:n!=null?n:"",priority:c?c+"":"",connectionAddress:i!=null?i:"",port:r?r+"":"",type:o?o+"":"",relAddr:s!=null?s:"",relPort:a?a+"":"",extension:{}};this.candidates.some(u=>u.priority===d.priority&&u.connectionAddress===d.connectionAddress&&u.port===d.port)||(this._candidates.push(d),this.sessionDesc.mediaDescriptions.forEach(u=>{u.attributes.candidates=this.candidates}))}clearRemoteCandidate(){this._candidates=[],this.sessionDesc.mediaDescriptions[0].attributes.candidates=this._candidates}createOrRecycleRecvMedia(t,e,n,i,r){const o=t._mediaStreamTrack.kind,s=this.rtpCapabilities.recv,a=ic(o,s,this.localCapabilities.send,o===_t.AUDIO?r:i),c=o===_t.VIDEO?s.videoExtensions:s.audioExtensions,d="".concat(++this.currentMidIndex);let u={media:{mediaType:o,port:"9",protos:["UDP","TLS","RTP","SAVPF"],fmts:a.map(p=>p.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:[],extmaps:c,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:e,ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:a,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:n,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(d)}};u=this.mungRecvMediaDsec(u,t);const l=this.findFirstClosedMedia(o);if(l){const p=this.sessionDesc.mediaDescriptions.indexOf(l);this.sessionDesc.mediaDescriptions[p]=u}else this.sessionDesc.mediaDescriptions.push(u);return u}muteRemote(t){const e=this.sessionDesc.mediaDescriptions.filter(n=>it(t).call(t,n.attributes.mid||""));if(e.length!==t.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");e.forEach(n=>{n.attributes.direction="inactive"})}unmuteRemote(t){const e=this.sessionDesc.mediaDescriptions.filter(n=>it(t).call(t,n.attributes.mid||""));if(e.length!==t.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");e.forEach(n=>{n.attributes.direction="recvonly"})}findAvailableMediaIndex(t,e,n){return this.sessionDesc.mediaDescriptions.findIndex(i=>{const r=i.media.mediaType===t&&i.media.port!=="0"&&(i.attributes.direction==="sendonly"||i.attributes.direction==="sendrecv")&&i.attributes.ssrcs.length===0;if(ye()){if(r){const o=this.firefoxSsrcMidMap.get(e[0].ssrcId);return!(o||i.attributes.mid!=="0"&&i.attributes.mid!=="1")||!(!o||o!==i.attributes.mid)}return!1}return r&&i.attributes.mid===n})}findAvailableRecvMediaIndex(t){return this.sessionDesc.mediaDescriptions.findIndex(e=>{const n=e.media.mediaType===t&&e.media.port!=="0"&&(e.attributes.direction==="recvonly"||e.attributes.direction==="sendrecv");return e.attributes.mid!=="0"&&e.attributes.mid!=="1"&&n})}predictReceivingMids(t){const e=[];for(let n=0;n<t;n++)e.push((this.currentMidIndex+n+1).toString(10));return e}restartICE(t){t=Ne(t),this._iceParameters=t,this.sessionDesc.mediaDescriptions.forEach(e=>{e.attributes.iceUfrag=t.iceUfrag,e.attributes.icePwd=t.icePwd})}createOrRecycleSendMedia(t,e,n,i,r,o){const s=this.rtpCapabilities.send,a=t===_t.VIDEO?s.videoCodecs:s.audioCodecs,c=t===_t.VIDEO?s.videoExtensions:s.audioExtensions;ye()&&(r="".concat(++this.currentMidIndex));let d={media:{mediaType:t,port:"9",protos:["UDP","TLS","RTP","SAVPF"],fmts:a.map(l=>l.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:[],extmaps:c,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:e,ssrcGroups:n,rtcpFeedbackWildcards:[],payloads:a,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:i,rtcpMux:!0,rtcpRsize:!0,mid:r}};d=this.mungSendMediaDesc(d,o);const u=this.findFirstClosedMedia(t);if(u){const l=this.sessionDesc.mediaDescriptions.indexOf(u);this.sessionDesc.mediaDescriptions[l]=d}else this.sessionDesc.mediaDescriptions.push(d);return d}mungRecvMediaDsec(t,e,n){const i=Ne(t);return Df(i),ra(i,e),Pf(i,e),LT(i),Dd(i,n,this.localCapabilities.send),i}mungSendMediaDesc(t,e){const n=Ne(t);return Dd(n,e,this.localCapabilities.recv),_o(n),n}updateRecvMedia(t,e){const n=this.sessionDesc.mediaDescriptions.findIndex(i=>i.attributes.mid===t);if(n!==-1){const i=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[n],e);this.sessionDesc.mediaDescriptions[n]=i}}updateBundleMids(){this.sessionDesc.attributes.groups[0].identificationTag=this.sessionDesc.mediaDescriptions.filter(t=>t.media.port!=="0").map(t=>t.attributes.mid)}findPreloadMediaDesc(t){return this.sessionDesc.mediaDescriptions.find(e=>{var n;return((n=e.attributes)===null||n===void 0||(n=n.ssrcs[0])===null||n===void 0?void 0:n.ssrcId)===t[0].ssrcId})}findFirstClosedMedia(t){return this.sessionDesc.mediaDescriptions.find(e=>ye()?e.media.port==="0"&&e.media.mediaType===t:e.media.port==="0")}};const i3=["sdp"];var ke;function G0(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),n.push.apply(n,i)}return n}function oa(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?G0(Object(n),!0).forEach(function(i){R(t,i,n[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):G0(Object(n)).forEach(function(i){Object.defineProperty(t,i,Object.getOwnPropertyDescriptor(n,i))})}return t}let W0=(ke=class Bd extends yb{get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get dtlsTransportState(){var e,n;return(e=(n=this.peerConnection.getReceivers()[0])===null||n===void 0||(n=n.transport)===null||n===void 0?void 0:n.state)!==null&&e!==void 0?e:null}get localCodecs(){return[]}set isInRestartIce(e){this._isInRestartIce=e}get isInRestartIce(){return this._isInRestartIce}constructor(e,n,i){super(e,n),R(this,"direction",void 0),R(this,"name",void 0),R(this,"store",void 0),R(this,"spec",void 0),R(this,"peerConnection",void 0),R(this,"initialOffer",void 0),R(this,"transport",void 0),R(this,"statsFilter",void 0),R(this,"localCandidateCount",0),R(this,"_isInRestartIce",!1),R(this,"mutex",new kn("P2PConnection-mutex")),R(this,"onLocalCandidate",void 0),R(this,"remoteSDP",void 0),R(this,"pendingCandidates",[]),R(this,"localCapabilities",void 0),R(this,"isReady",!1),R(this,"restartCnt",0),R(this,"curTurnServerIndex",0),this.store=n,this.spec=e,this.peerConnection=new RTCPeerConnection(Bd.resolvePCConfiguration(e,n.p2pTransport),{optional:[{googDscp:!0}]}),this.direction=i!=null?i:mi.SEND_ONLY,this.name=this.direction===mi.SEND_ONLY?"sendP2PConnection":"recvP2PConnection",this.statsFilter=Nf(this.peerConnection,N("STATS_UPDATE_INTERVAL"),void 0,ye()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1}async establish(e){try{const n=await MT();if(this.localCapabilities=Pd(n),e){const{sdp:i}=e,r=$W(e,i3),o=function(){const u={audioCodecs:[],videoCodecs:[],audioExtensions:[],videoExtensions:[]},l=Dl(arguments.length>2?arguments[2]:void 0,arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},"sendonly"),p={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},f={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},C={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]};if(Yr(l,u,"videoExtensions",p,f,C),Yr(l,u,"videoCodecs",p,f,C),Yr(l,u,"audioExtensions",p,f,C),Yr(l,u,"audioCodecs",p,f,C),N("RAISE_H264_BASELINE_PRIORITY")){const m=C.videoCodecs.findIndex(g=>g.rtpMap&&g.rtpMap.encodingName.toLocaleLowerCase()==="h264"&&g.fmtp&&g.fmtp.parameters["profile-level-id"]==="42001f");if(m!==-1){const g=C.videoCodecs.findIndex(y=>y.rtpMap&&y.rtpMap.encodingName.toLocaleLowerCase()==="h264");if(g<m){E.debug("raising H264 baseline profile priority");const y=C.videoCodecs[m];C.videoCodecs.splice(m,1),C.videoCodecs.splice(g,0,y)}g!==-1&&N("FILTER_SEND_H264_BASELINE")&&(p.videoCodecs=p.videoCodecs.filter(y=>!(y.rtpMap&&y.rtpMap.encodingName.toLocaleLowerCase()==="h264"&&y.fmtp&&y.fmtp.parameters["profile-level-id"]!=="42001f")))}}return{send:p,recv:f,sendrecv:C}}({},{},i);this.remoteSDP=new B0({remoteIceParameters:r.iceParameters,remoteDtlsParameters:r.dtlsParameters,candidates:[],remoteRTPCapabilities:o,localCapabilities:this.localCapabilities,direction:this.direction,setup:"actpass",videoCodec:this.store.codec,audioCodec:this.store.audioCodec}),await this.setRemoteDescription({type:"offer",sdp:this.remoteSDP.toString()}),this.isReady=!0;const s=await this.peerConnection.createAnswer();if(!s.sdp)throw new Error("Cannot get answer sdp when trying to establish PeerConnection.");const a=fo(s.sdp);await this.peerConnection.setLocalDescription(s);const c=await j0({},{},s.sdp);this.localCapabilities=Pd(c);const d=this.peerConnection.getTransceivers()[0];return d!=null&&d.receiver&&d.receiver.transport&&this.tryBindTransportEvents(d.receiver.transport),oa(oa({},a),{},{sdp:s.sdp})}{this.peerConnection.addTransceiver("video",{direction:"sendonly"}),this.peerConnection.addTransceiver("audio",{direction:"sendonly"});const i=await this.peerConnection.createOffer();if(!i.sdp)throw new Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");const r=fo(i.sdp);return this.initialOffer=i,oa(oa({},r),{},{sdp:i.sdp})}}catch(n){throw new G(b.GET_LOCAL_CONNECTION_PARAMS_FAILED,n.toString())}}async connect(e){try{if(!this.initialOffer)throw new Error("Cannot establish P2PConnection without initial offer.");await this.peerConnection.setLocalDescription(this.initialOffer);const{sdp:n,iceParameters:i,dtlsParameters:r}=e,o=await j0({},{},n);this.remoteSDP=new B0({remoteIceParameters:i,remoteDtlsParameters:r,candidates:[],remoteRTPCapabilities:o,localCapabilities:this.localCapabilities,direction:this.direction,setup:"active",videoCodec:this.store.codec,audioCodec:this.store.audioCodec}),await this.setRemoteDescription({type:"answer",sdp:this.remoteSDP.toString()});const s=this.peerConnection.getTransceivers()[0];s!=null&&s.sender&&s.sender.transport&&this.tryBindTransportEvents(s.sender.transport)}catch(n){throw new G(b.EXCHANGE_SDP_FAILED,"P2PConnection.connect failed; ".concat(n.toString()))}}async addRemoteCandidate(e){try{e&&this.pendingCandidates.push(e),this.peerConnection.remoteDescription&&this.isReady&&(this.pendingCandidates.forEach(n=>{this.peerConnection.addIceCandidate(n)}),this.pendingCandidates=[])}catch(n){throw new G(b.ADD_CANDIDATE_FAILED,"P2PConnection.addRemoteCandidate failed; ".concat(n.toString()))}}send(e,n,i){var r=this;return Hi(function*(){const o=yield Mt(r.mutex.lock("From P2PConnection.send"));try{if(!r.remoteSDP)throw new Error("Cannot call P2PConnection.send before remote SDP created");const s=[],a=r.remoteSDP.receive(e,n,i);e.forEach((g,y)=>{if(a[y].needCreateTransceiver){const A=r.peerConnection.addTransceiver(g._mediaStreamTrack,{direction:"sendonly"});s.push(A),g._updateRtpTransceiver(A)}else{const A=r.peerConnection.getTransceivers().find(k=>k.mid===a[y].mid);if(!A)throw new Error("cannot find transceiver when sendPeerconnection send, mid is ".concat(a[y].mid));s.push(A),g._updateRtpTransceiver(A)}}),ye()&&N("SIMULCAST")===!0&&(yield Mt(r.applySimulcastForFirefox(s,e)));const c=a.map(g=>g.mid),d=yield Mt(r.peerConnection.createOffer()),u=r.mungSendOfferSDP(d.sdp,e,c),l=je.parse(u),p=c.map(g=>{const y=l.mediaDescriptions.find(A=>A.attributes.mid===g);if(!y)throw new Error("Cannot extract ssrc from mediaDescription.");return PT(y,N("USE_PUB_RTX"))}),f=s.map((g,y)=>{const A=c[y];return{localSSRC:p[y],id:A}});yield Mt(r.peerConnection.setLocalDescription({type:"offer",sdp:u}));try{yield f}catch(g){const y=r.remoteSDP.toString();throw yield Mt(r.peerConnection.setLocalDescription({type:"offer",sdp:u})),yield Mt(r.peerConnection.setRemoteDescription({type:"answer",sdp:y})),yield Mt(r.stopSending(c,!0)),g}yield Mt(r.applySimulcastEncodings(s,e)),yield Mt(r.applySendEncodings(s,e));const C=r.remoteSDP.toString(),m=r.logSDPExchange(u,"offer","local","send");return m==null||m(C),yield Mt(r.setRemoteDescription({type:"answer",sdp:C})),s.map((g,y)=>{const A=c[y];return{localSSRC:p[y],id:A}})}catch(s){throw s instanceof G?s:new G(b.EXCHANGE_SDP_FAILED,"P2PConnection.send failed; ".concat(s.toString()))}finally{o()}})()}async stopSending(e,n){const i=n?void 0:await this.mutex.lock("From P2PConnection.stopSending");try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopSending before remote SDP created");const r=this.peerConnection.getTransceivers().filter(c=>e.indexOf(c.mid)!==-1);if(r.length!==e.length)throw new Error("Transceivers' length (".concat(r.length,") doesn't match mids' length (").concat(e.length,") when trying to call P2PConnection.stopSending."));r.map(c=>{var d;c.direction="inactive",(d=c.stop)===null||d===void 0||d.call(c)});const o=await this.peerConnection.createOffer(),s=this.logSDPExchange(o.sdp||"","offer","local","stopSending");await this.peerConnection.setLocalDescription(o),this.remoteSDP.stopReceiving(e);const a=this.remoteSDP.toString();s==null||s(a),await this.setRemoteDescription({type:"answer",sdp:a})}catch(r){throw new G(b.EXCHANGE_SDP_FAILED,"P2PConnection.stopSending failed; ".concat(r.toString()))}finally{i&&i()}}async receive(e,n,i,r){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.receive ".concat(e," before remoteSDP created."));const{mid:o,needExchangeSDP:s}=this.remoteSDP.send(e,n,i,r);if(s){const c=this.remoteSDP.toString(),d=this.logSDPExchange(c,"offer","remote","receive");await this.setRemoteDescription({type:"offer",sdp:c});const u=await this.peerConnection.createAnswer(),l=this.mungReceiveAnswerSDP(u.sdp,o,e);d==null||d(l||""),await this.peerConnection.setLocalDescription({type:"answer",sdp:l}),E.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(e," by exchanging SDP."))}else E.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(e," no need to exchange SDP."));const a=this.peerConnection.getTransceivers().find(c=>c.mid===o);if(!a||a.mid===null)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:a.receiver.track,mid:a.mid,transceiver:a}}catch(o){throw new G(b.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(o.toString()))}}async mockReceive(e,n,i,r){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.receive ".concat(e," before remoteSDP created."));const{mid:o,needExchangeSDP:s}=this.remoteSDP.send(e,n,i,r);if(s){const a=this.remoteSDP.toString(),c=this.logSDPExchange(a,"offer","remote","receive");await this.setRemoteDescription({type:"offer",sdp:a});const d=await this.peerConnection.createAnswer(),u=this.mungReceiveAnswerSDP(d.sdp,o,e);c==null||c(u||""),await this.peerConnection.setLocalDescription({type:"answer",sdp:u}),E.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(e," by exchanging SDP."))}else E.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(e," no need to exchange SDP."))}catch(o){throw new G(b.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(o.toString()))}}async stopReceiving(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopReceiving before remote SDP created.");this.remoteSDP.stopSending(e);const n=this.remoteSDP.toString(),i=this.logSDPExchange(n,"offer","remote","stopReceiving");await this.setRemoteDescription({type:"offer",sdp:n});const r=await this.peerConnection.createAnswer();i==null||i(r.sdp||""),await this.peerConnection.setLocalDescription(r)}catch(n){throw new G(b.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(n.toString()))}}async restartICE(e){try{if(this.store.p2pTransport===Fa.Auto&&(this.store.p2pTransport=Fa.SdRtn,zt().supportPCSetConfiguration&&this.peerConnection.setConfiguration(Bd.resolvePCConfiguration(this.spec,this.store.p2pTransport))),this.restartCnt>3&&(this.restartCnt=0,zt().supportPCSetConfiguration&&this.peerConnection.setConfiguration(Bd.resolvePCConfiguration(this.spec,this.store.p2pTransport,++this.curTurnServerIndex))),!e){this.restartCnt++,this.isReady=!1;const n=await this.peerConnection.createOffer({iceRestart:!0});if(!n.sdp)throw new Error("Cannot restartICE because restart offer SDP does not exist.");const{iceParameters:i}=fo(n.sdp);return this.store.descriptionStart(),this.direction===mi.SEND_ONLY&&await this.peerConnection.setLocalDescription(n),i}if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopReceiving before remote SDP created.");if(this.remoteSDP.restartICE(e),this.store.descriptionStart(),this.direction===mi.RECEIVE_ONLY){this.restartCnt++,await this.setRemoteDescription({type:"offer",sdp:this.remoteSDP.toString()});const n=await this.peerConnection.createAnswer();if(!n.sdp)throw new Error("Cannot get answer sdp when trying to iceRestart.");const{iceParameters:i}=fo(n.sdp);return await this.peerConnection.setLocalDescription(n),i}await this.setRemoteDescription({type:"answer",sdp:this.remoteSDP.toString()}),this.isReady=!0}catch(n){throw new G(b.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(n.toString()))}}close(){var e;this.peerConnection.close(),this.peerConnection.onicecandidate=null,(e=this.onConnectionStateChange)===null||e===void 0||e.call(this,"closed"),this.tryUnbindTransportEvents(),this.unbindPCEvents(),this.unbindStatsEvents(),this.transport=void 0,this.statsFilter.destroy()}getStats(){return this.statsFilter.getStats()}getRemoteVideoIsReady(e){return this.statsFilter.getVideoIsReady(e)}async updateEncoderConfig(e,n){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.updateEncoderConfig before remote SDP created.");const i=await this.peerConnection.createOffer(),r=this.mungSendOfferSDP(i.sdp,[n],[e]);this.remoteSDP.updateRecvMedia(e,n);const o=this.remoteSDP.toString(),s=this.logSDPExchange(r,"offer","local","updateEncoderConfig");await this.peerConnection.setLocalDescription({type:"offer",sdp:r}),s==null||s(o),await this.peerConnection.setRemoteDescription({type:"answer",sdp:o})}catch(i){throw new G(b.EXCHANGE_SDP_FAILED,i.toString())}}async updateSendParameters(e,n){const i=this.peerConnection.getTransceivers().filter(r=>r.mid===e);i.length===1&&(this.isVP8Simulcast(n)?ye()||await this.applySimulcastEncodings(i,[n]):await this.applySendEncodings(i,[n]))}setStatsRemoteVideoIsReady(e,n){this.statsFilter.setVideoIsReady2(e,n)}async replaceTrack(e,n){const i=this.peerConnection.getTransceivers().find(r=>r.mid===n);i&&await i.sender.replaceTrack(e._mediaStreamTrack)}async getSelectedCandidatePair(){const e=this.peerConnection.getReceivers();if(e.length>0&&e[0].transport&&e[0].transport.iceTransport&&e[0].transport.iceTransport.getSelectedCandidatePair&&e[0].transport.iceTransport.getSelectedCandidatePair()){const n=e[0].transport.iceTransport,{local:i,remote:r}=n.getSelectedCandidatePair();return{local:oa(oa({},Yo),{},{candidateType:i.type,protocol:i.protocol,address:i.address,port:i.port}),remote:oa(oa({},Yo),{},{candidateType:r.type,protocol:r.protocol,address:r.address,port:r.port})}}return this.statsFilter.getSelectedCandidatePair()}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var e,n;it(e=["connected","completed"]).call(e,this.peerConnection.iceConnectionState)&&(this.isReady=!1),(n=this.onICEConnectionStateChange)===null||n===void 0||n.call(this,this.peerConnection.iceConnectionState)},this.peerConnection.onconnectionstatechange=()=>{var e;this.peerConnection.connectionState==="connected"&&(this.restartCnt=0),(e=this.onConnectionStateChange)===null||e===void 0||e.call(this,this.peerConnection.connectionState)},this.startICECandidate()}startICECandidate(){this.peerConnection.onicecandidate||(this.localCandidateCount=0,this.peerConnection.onicecandidate=e=>{if(e.candidate){var n;e.candidate.candidate&&((n=this.onLocalCandidate)===null||n===void 0||n.call(this,e.candidate.toJSON())),this.localCandidateCount+=1}else E.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount)})}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null}static resolvePCConfiguration(e,n){let i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:0;const r={iceServers:[]};var o;return e.iceServers?r.iceServers=e.iceServers:e.turnServer&&e.turnServer.mode!=="off"&&(Zc(e.turnServer.servers)?r.iceServers=e.turnServer.servers:(r.iceServers&&r.iceServers.push(...Bd.turnServerConfigToIceServers(e.turnServer.servers,n,i)),N("USE_TURN_SERVER_OF_GATEWAY")&&r.iceServers&&e.turnServer.serversFromGateway&&r.iceServers.push(...Bd.turnServerConfigToIceServers(e.turnServer.serversFromGateway,n,i)),it(o=[Fa.Relay,Fa.SdRtn]).call(o,n)&&(r.iceTransportPolicy="relay"),N("FORCE_TURN_TCP")?r.iceTransportPolicy="relay":e.turnServer.servers.concat(e.turnServer.serversFromGateway||[]).forEach(s=>{s.forceturn&&(r.iceTransportPolicy="relay")}))),N("ENABLE_ENCODED_TRANSFORM")&&zt().supportWebRTCEncodedTransform&&(r.encodedInsertableStreams=!0),E.debug("P2PConnection p2pTransport is ".concat(n)),r}static turnServerConfigToIceServers(e,n){let i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:0;const r=[],o=e.filter(a=>a.tcpport);E.debug("P2PConnection turnServers is ".concat(o,", current index is ").concat(i));const s=o.length>i?o[i]:o[0];switch(n){case Fa.SdRtn:const a=e.filter(d=>{var u;return it(u=d.username).call(u,"glb:")&&d.turnServerURL==d.turnServerURL}),c=a.length>i?a[i]:a[0];c&&(r.push({username:c.username,credential:c.password,credentialType:"password",urls:"turn:".concat(Xs(c.turnServerURL),":").concat(c.tcpport,"?transport=udp")}),r.push({username:c.username,credential:c.password,credentialType:"password",urls:"turns:".concat(Xs(c.turnServerURL),":").concat(c.tcpport,"?transport=tcp")}));break;case Fa.Relay:s&&(r.push({username:s.username,credential:s.password,credentialType:"password",urls:"turn:".concat(s.turnServerURL,":").concat(s.tcpport,"?transport=udp")}),r.push({username:s.username,credential:s.password,credentialType:"password",urls:"turns:".concat(Xs(s.turnServerURL),":").concat(s.tcpport,"?transport=tcp")}));break;default:s&&(r.push({username:s.username,credential:s.password,credentialType:"password",urls:"turn:".concat(s.turnServerURL,":").concat(s.tcpport,"?transport=udp")}),r.push({username:s.username,credential:s.password,credentialType:"password",urls:"turns:".concat(Xs(s.turnServerURL),":").concat(s.tcpport,"?transport=tcp")}),r.push({username:s.username,credential:s.password,credentialType:"password",urls:"stun:".concat(s.turnServerURL,":").concat(s.tcpport)}))}return r}tryBindTransportEvents(e){if(e){this.transport=e,e.onstatechange=()=>{var i;e!=null&&e.state&&((i=this.onDTLSTransportStateChange)===null||i===void 0||i.call(this,e.state))},e.onerror=i=>{var r;(r=this.onDTLSTransportError)===null||r===void 0||r.call(this,"error"in i?i.error:i)};const n=e.iceTransport;n&&(n.onstatechange=()=>{const i=e==null?void 0:e.iceTransport.state;var r;i&&((r=this.onICETransportStateChange)===null||r===void 0||r.call(this,i))},n.getSelectedCandidatePair&&(n.onselectedcandidatepairchange=()=>{if(n.getSelectedCandidatePair()){const{local:i,remote:r}=n.getSelectedCandidatePair();E.info("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] selectedcandidatepairchange: local ").concat(JSON.stringify({candidateType:i.type,protocol:i.protocol}),", remote ").concat(JSON.stringify({candidateType:r.type,protocol:r.protocol,address:r.address,port:r.port})," )"))}}))}}tryUnbindTransportEvents(){this.transport&&(this.transport.onstatechange=null,this.transport.onerror=null,this.transport.iceTransport&&(this.transport.iceTransport.onstatechange=null))}async updateRtpSenderEncodings(e,n){var i;if(n||(n=this.peerConnection.getSenders().find(u=>u.track===e._mediaStreamTrack)),!n)return E.warn("[".concat(e.getTrackId(),"] no rtpSender found}"));if(this.isVP8Simulcast(e))return E.warn("[updateRtpSenderEncodings] Track is VP8 simulcast, please apply simulcast encodings");if(!zt().supportSetRtpSenderParameters)return E.warn("[updateRtpSenderEncodings] Browser not support set rtp-sender parameters");const r={},o={};switch(e._optimizationMode){case"motion":r.degradationPreference="maintain-framerate";break;case"detail":r.degradationPreference="maintain-resolution";break;default:r.degradationPreference="balanced"}if(e._encoderConfig){var s;const{bitrateMax:u,frameRate:l,scaleResolutionDownBy:p}=e._encoderConfig;u&&(o.maxBitrate=1e3*u),it(s=e._hints).call(s,De.LOW_STREAM)&&(l&&(o.maxFramerate=Pi(l)),p&&p>=1&&(o.scaleResolutionDownBy=p))}if(N("DSCP_TYPE")&&Ws()){var a;const u=N("DSCP_TYPE");it(a=["very-low","low","medium","high"]).call(a,u)&&(o.networkPriority=u)}const c=n.getParameters(),d=(i=c.encodings)===null||i===void 0?void 0:i[0];ye()&&!d&&(r.encodings=[o]),d&&Object.assign(d,o),Object.assign(c,r),E.debug("[".concat(e.getTrackId(),"] updateRtpSenderEncodings: ").concat(JSON.stringify(c.encodings))),await n.setParameters(c)}async applySendEncodings(e,n){try{if(!zt().supportSetRtpSenderParameters||e.length!==n.length)return;for(let i=0;i<e.length;i++){const r=e[i],o=n[i];o instanceof Ae&&!this.isVP8Simulcast(o)&&await this.updateRtpSenderEncodings(o,r.sender)}}catch{E.debug("[".concat(this.store.clientId,"] Apply RTPSendEncodings failed."))}}mungSendOfferSDP(e,n,i){const r=je.parse(e);return n.forEach((o,s)=>{const a=i[s],c=r.mediaDescriptions.find(d=>d.attributes.mid===a);c&&(ra(c,o),kT(c,o,this.store.codec))}),je.print(r)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=e=>{var n;(n=this.onFirstAudioReceived)===null||n===void 0||n.call(this,e)},this.statsFilter.onFirstVideoReceived=e=>{var n;(n=this.onFirstVideoReceived)===null||n===void 0||n.call(this,e)},this.statsFilter.onFirstAudioDecoded=e=>{var n;(n=this.onFirstAudioDecoded)===null||n===void 0||n.call(this,e)},this.statsFilter.onFirstVideoDecoded=(e,n,i)=>{var r;(r=this.onFirstVideoDecoded)===null||r===void 0||r.call(this,e,n,i)},this.statsFilter.onSelectedLocalCandidateChanged=(e,n)=>{var i;(i=this.onSelectedLocalCandidateChanged)===null||i===void 0||i.call(this,e,n)},this.statsFilter.onSelectedRemoteCandidateChanged=(e,n)=>{var i;(i=this.onSelectedRemoteCandidateChanged)===null||i===void 0||i.call(this,e,n)},this.statsFilter.onFirstVideoDecodedTimeout=e=>{var n;(n=this.onFirstVideoDecodedTimeout)===null||n===void 0||n.call(this,e)}}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0,this.statsFilter.onFirstVideoDecodedTimeout=void 0}async applySimulcastForFirefox(e,n){if(e.length===n.length)for(let c=0;c<e.length;c++){var i,r,o,s,a;const d=e[c],u=n[c];if(u instanceof Ae&&!it(i=u._hints).call(i,De.LOW_STREAM)&&(r=u._encoderConfig)!==null&&r!==void 0&&r.bitrateMax&&((o=u._encoderConfig)===null||o===void 0?void 0:o.bitrateMax)>200&&(s=u._scalabilityMode)!==null&&s!==void 0&&s.numSpatialLayers&&((a=u._scalabilityMode)===null||a===void 0?void 0:a.numSpatialLayers)>1&&this.store.codec==="vp8"){const l={},p={high:1e3*(u._encoderConfig.bitrateMax-50),medium:5e4};l.encodings=[{rid:"m",active:!0,maxBitrate:p.medium,scaleResolutionDownBy:4},{rid:"h",active:!0,maxBitrate:p.high}];const f=d.sender.getParameters();await d.sender.setParameters(Object.assign(f,l))}}}async applySimulcastEncodings(e,n){if(!ye()&&e.length===n.length)for(let i=0;i<e.length;i++){const r=n[i];if(r instanceof Ae&&this.isVP8Simulcast(r)){const o=e[i],s={},a={high:1e3*(r._encoderConfig.bitrateMax-50),medium:5e4};s.encodings=[{active:!0,adaptivePtime:!1,networkPriority:"high",priority:"high",maxBitrate:a.high},{active:!0,adaptivePtime:!1,networkPriority:"low",priority:"low",maxBitrate:a.medium,scaleResolutionDownBy:4}];const c=o.sender.getParameters();await o.sender.setParameters(Object.assign(c,s))}}}isVP8Simulcast(e){var n,i,r,o,s;return!!(e instanceof Ae&&N("SIMULCAST")&&this.store.codec==="vp8"&&!it(n=e._hints).call(n,De.LOW_STREAM)&&(i=e._encoderConfig)!==null&&i!==void 0&&i.bitrateMax&&((r=e._encoderConfig)===null||r===void 0?void 0:r.bitrateMax)>200&&(o=e._scalabilityMode)!==null&&o!==void 0&&o.numSpatialLayers&&((s=e._scalabilityMode)===null||s===void 0?void 0:s.numSpatialLayers)>1)}logSDPExchange(e,n,i,r){if(N("SDP_LOGGING"))return E.upload("[".concat(this.store.clientId,"] exchanging ").concat(i," ").concat(n," SDP during P2PConnection.").concat(r,`
`),e),n==="offer"?o=>{this.logSDPExchange(o,"answer",i==="local"?"remote":"local",r)}:void 0}async muteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.muteLocal before remote SDP created.");const n=this.peerConnection.getTransceivers().filter(s=>s.mid&&e.indexOf(s.mid)!==-1);if(n.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length.");n.map(s=>{s.direction="inactive"});const i=await this.peerConnection.createOffer(),r=this.logSDPExchange(i.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(i),this.remoteSDP.muteRemote(e);const o=this.remoteSDP.toString();r==null||r(o),await this.setRemoteDescription({type:"answer",sdp:o})}catch(n){throw new G(b.EXCHANGE_SDP_FAILED,"P2PConnection.muteLocal failed; ".concat(n.toString()))}}async unmuteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteLocal before remote SDP created.");const n=this.peerConnection.getTransceivers().filter(s=>s.mid&&e.indexOf(s.mid)!==-1);if(n.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length.");n.map(async s=>{s.direction="sendonly"});const i=await this.peerConnection.createOffer(),r=this.logSDPExchange(i.sdp||"","offer","local","unmuteLocal");await this.peerConnection.setLocalDescription(i),this.remoteSDP.unmuteRemote(e);const o=this.remoteSDP.toString();r==null||r(o),await this.setRemoteDescription({type:"answer",sdp:o})}catch(n){throw new G(b.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteLocal failed; ".concat(n.toString()))}}async getRemoteSSRC(e,n){var i,r;if(n=(i=n)!==null&&i!==void 0?i:(r=this.currentRemoteDescription)===null||r===void 0?void 0:r.sdp){var o;const s=(o=je.parse(n).mediaDescriptions.find(a=>a.attributes.mid===e))===null||o===void 0?void 0:o.attributes.ssrcs;return s==null?void 0:s[0].ssrcId}}async setRemoteDescription(e){var n;await this.peerConnection.setRemoteDescription(e),it(n=["connected","completed"]).call(n,this.peerConnection.iceConnectionState)||(this.isReady=!0,this.addRemoteCandidate())}mungReceiveAnswerSDP(e,n,i){const r=je.parse(e),o=r.mediaDescriptions.find(s=>s.attributes.mid===n);return o&&i===_t.AUDIO&&o.media.mediaType==="audio"&&_o(o),je.print(r)}},nt(ke.prototype,"establish",[zr],Object.getOwnPropertyDescriptor(ke.prototype,"establish"),ke.prototype),nt(ke.prototype,"connect",[zr],Object.getOwnPropertyDescriptor(ke.prototype,"connect"),ke.prototype),nt(ke.prototype,"receive",[zr],Object.getOwnPropertyDescriptor(ke.prototype,"receive"),ke.prototype),nt(ke.prototype,"mockReceive",[zr],Object.getOwnPropertyDescriptor(ke.prototype,"mockReceive"),ke.prototype),nt(ke.prototype,"stopReceiving",[zr],Object.getOwnPropertyDescriptor(ke.prototype,"stopReceiving"),ke.prototype),nt(ke.prototype,"restartICE",[zr],Object.getOwnPropertyDescriptor(ke.prototype,"restartICE"),ke.prototype),nt(ke.prototype,"close",[zr],Object.getOwnPropertyDescriptor(ke.prototype,"close"),ke.prototype),nt(ke.prototype,"updateEncoderConfig",[zr],Object.getOwnPropertyDescriptor(ke.prototype,"updateEncoderConfig"),ke.prototype),nt(ke.prototype,"updateSendParameters",[zr],Object.getOwnPropertyDescriptor(ke.prototype,"updateSendParameters"),ke.prototype),nt(ke.prototype,"replaceTrack",[zr],Object.getOwnPropertyDescriptor(ke.prototype,"replaceTrack"),ke.prototype),nt(ke.prototype,"muteLocal",[zr],Object.getOwnPropertyDescriptor(ke.prototype,"muteLocal"),ke.prototype),nt(ke.prototype,"unmuteLocal",[zr],Object.getOwnPropertyDescriptor(ke.prototype,"unmuteLocal"),ke.prototype),ke);function zr(t,e,n){const i=t[e];if(typeof i!="function")throw new Error("Cannot use mutex on object property.");return n.value=async function(){const r=this.mutex,o=await r.lock("From P2PConnection.".concat(e));try{for(var s=arguments.length,a=new Array(s),c=0;c<s;c++)a[c]=arguments[c];return await i.apply(this,a)}finally{o()}},n}function xT(t,e){let n=document.createElement("video"),i=document.createElement("canvas");n.setAttribute("style","display:none"),i.setAttribute("style","display:none"),n.setAttribute("muted",""),n.muted=!0,n.setAttribute("autoplay",""),n.autoplay=!0,n.setAttribute("playsinline",""),i.width=Pi(e.width),i.height=Pi(e.height);const r=Pi(e.framerate||15);document.body.append(n),document.body.append(i);let o=t._mediaStreamTrack;n.srcObject=new MediaStream([o]),n.play();const s=i.getContext("2d");if(!s)throw new U(b.UNEXPECTED_ERROR,"can not get canvas context");const a=zt(),c=i.captureStream(a.supportRequestFrame?0:r).getVideoTracks()[0];c.canvas||(c.canvas=i),i.startCapture=()=>{if(!n)return i.stopCapture&&i.stopCapture();if(n.paused&&n.play(),n.videoHeight>2&&n.videoWidth>2){const u=n.videoWidth,l=n.videoHeight/u,p=i.width*l;Math.abs(p-i.height)>=2&&(E.debug("adjust low stream resolution","".concat(i.width,"x").concat(i.height," -> ").concat(i.width,"x").concat(p)),i.height=p)}s.drawImage(n,0,0,i.width,i.height),c.requestFrame&&c.requestFrame(),o!==t._mediaStreamTrack&&(o=t._mediaStreamTrack,n.srcObject=new MediaStream([o]))},i.stopCapture=gT(()=>i.startCapture&&i.startCapture(),r);const d=c.stop;return c.stop=()=>{d.call(c),n&&(n.remove(),n.srcObject=null,n=null),i&&(i.width=0,i.remove(),i.stopCapture&&i.stopCapture(),i.startCapture=void 0,i.stopCapture=void 0,i=null),E.debug("clean low stream renderer")},c}var kf=function(t){return t[t.HEIGHT=2033]="HEIGHT",t[t.FRAME_RATE=2034]="FRAME_RATE",t[t.WIDTH=2035]="WIDTH",t}(kf||{}),Nn=function(t){return t[t.FRAME_RATE=2002]="FRAME_RATE",t[t.WIDTH=2003]="WIDTH",t[t.HEIGHT=2004]="HEIGHT",t[t.PACKAGE_LOST=2005]="PACKAGE_LOST",t[t.AVG_ENCODE=2007]="AVG_ENCODE",t[t.NACKS=2009]="NACKS",t[t.PLIS=2010]="PLIS",t[t.FIRS=2011]="FIRS",t[t.BITRATE=2012]="BITRATE",t[t.PACKAGE_RATE=2031]="PACKAGE_RATE",t[t.ADAPTATION=2032]="ADAPTATION",t[t.ACTUAL_ENCODED=2060]="ACTUAL_ENCODED",t[t.BANDWIDTH=2061]="BANDWIDTH",t[t.RETRANSMIT=2062]="RETRANSMIT",t[t.TARGET_ENCODED=2064]="TARGET_ENCODED",t[t.TRANSMIT=2066]="TRANSMIT",t[t.FREEZE=2082]="FREEZE",t[t.DISABLED=2095]="DISABLED",t[t.PLAYER_STATUS=2128]="PLAYER_STATUS",t[t.QP_SUM=2143]="QP_SUM",t}(Nn||{}),rc=function(t){return t[t.BITRATE=2069]="BITRATE",t[t.PACKAGE_LOST=2070]="PACKAGE_LOST",t[t.PACKAGE_RATE=2071]="PACKAGE_RATE",t[t.HEIGHT=2073]="HEIGHT",t[t.FRAME_RATE=2075]="FRAME_RATE",t[t.WIDTH=2077]="WIDTH",t}(rc||{}),ei=function(t){return t[t.JITTER=-1]="JITTER",t[t.PACKAGE_LOST=2014]="PACKAGE_LOST",t[t.WIDTH=2018]="WIDTH",t[t.HEIGHT=2019]="HEIGHT",t[t.FRAME_RATE=2020]="FRAME_RATE",t[t.JITTER_BUFFER=2023]="JITTER_BUFFER",t[t.CURRENT_DELAY=2024]="CURRENT_DELAY",t[t.NACKS=2026]="NACKS",t[t.PLIS=2027]="PLIS",t[t.FIRS=2028]="FIRS",t[t.BITRATE=2029]="BITRATE",t[t.PACKAGE_RATE=2078]="PACKAGE_RATE",t[t.FREEZE=2084]="FREEZE",t[t.DISABLED=2101]="DISABLED",t[t.PLAYER_STATUS=2129]="PLAYER_STATUS",t[t.QP_SUM=2144]="QP_SUM",t[t.I_FRAME_DELAY=2149]="I_FRAME_DELAY",t}(ei||{}),oc=function(t){return t[t.FRAME_RATE_DECODE=2021]="FRAME_RATE_DECODE",t[t.FRAME_RATE_RENDER=2022]="FRAME_RATE_RENDER",t[t.FRAME_RATE_OUTPUT=2155]="FRAME_RATE_OUTPUT",t[t.FREEZE_TIME=2109]="FREEZE_TIME",t[t.FREEZE_TIME_RENDER=2147]="FREEZE_TIME_RENDER",t[t.FREEZE_DURATION=2156]="FREEZE_DURATION",t}(oc||{}),H0=function(t){return t[t.PCM_LEVEL=2104]="PCM_LEVEL",t}(H0||{}),sa=function(t){return t[t.PACKAGE_LOST=-1]="PACKAGE_LOST",t[t.LEVEL=2038]="LEVEL",t[t.BITRATE=2039]="BITRATE",t[t.PACKAGE_RATE=2040]="PACKAGE_RATE",t[t.AEC_RETURN_LOSS=2041]="AEC_RETURN_LOSS",t[t.AEC_RETURN_LOSS_ENH=2042]="AEC_RETURN_LOSS_ENH",t[t.FREEZE=2081]="FREEZE",t[t.DISABLED=2096]="DISABLED",t}(sa||{}),Jr=function(t){return t[t.BITRATE=2044]="BITRATE",t[t.PACKAGE_LOST=2045]="PACKAGE_LOST",t[t.PACKAGE_RATE=2046]="PACKAGE_RATE",t[t.CURRENT_DELAY=2047]="CURRENT_DELAY",t[t.JITTER_BUFFER=2054]="JITTER_BUFFER",t[t.JITTER=2055]="JITTER",t[t.FREEZE=2083]="FREEZE",t[t.DISABLED=2102]="DISABLED",t[t.PCM_LEVEL=2105]="PCM_LEVEL",t[t.PLAYER_STATUS=2130]="PLAYER_STATUS",t[t.CONCEALED_SAMPLES=2148]="CONCEALED_SAMPLES",t}(Jr||{}),K0=function(t){return t[t.FREEZE_TIME=-1]="FREEZE_TIME",t[t.LEVEL=2043]="LEVEL",t}(K0||{}),Tr=function(t){return t[t.RTT=2006]="RTT",t[t.CONN_TYPE=801]="CONN_TYPE",t}(Tr||{});const vs=1e3,sc=3;function Ft(t,e,n){n!=null&&Number.isFinite(n)&&(t[e]=Math.round(Math.max(0,n)))}function q0(t){const e={[Tr.CONN_TYPE]:0,[Tr.RTT]:t.rtt};switch(t.selectedCandidatePair.localCandidate.candidateType){case"relay":{const n=t.selectedCandidatePair.localCandidate.relayProtocol;n==="udp"&&(e[Tr.CONN_TYPE]=1),n==="tcp"&&(e[Tr.CONN_TYPE]=3),n==="tls"&&(e[Tr.CONN_TYPE]=4);break}case"srflx":e[Tr.CONN_TYPE]=2}return e}function Y0(t){let e=0;switch(t){case"none":e=0;break;case"cpu":e=1;break;case"bandwidth":e=2;break;case"other":e=3}return e}class z0 extends Ve{constructor(e){super(),R(this,"store",void 0),R(this,"uploadWRTCStatsTimer",void 0),R(this,"uploadOutboundDenoiserStatsTimer",void 0),R(this,"uploadExtStatsTimer",void 0),R(this,"uploadExtUsageStatsTimer",void 0),R(this,"uploadInboundExtStatsTimer",void 0),R(this,"requestStats",void 0),R(this,"requestTransportStats",void 0),R(this,"requestLocalMedia",void 0),R(this,"requestRemoteMedia",void 0),R(this,"requestAllTracks",void 0),R(this,"requestVideoIsReady",void 0),R(this,"requestUploadStats",void 0),R(this,"requestUpload",void 0),R(this,"uploadOutboundStarted",!1),R(this,"uploadInboundStarted",!1),R(this,"uploadTransportStarted",!1),R(this,"uploadExtensionUsageStarted",!1),R(this,"lastRecvStats",void 0),R(this,"lastSendStats",void 0),R(this,"lastFullRecvStats",void 0),R(this,"lastFullSendStats",void 0),R(this,"needUploadRenderFreezeTime",!0),this.store=e}uploadWRTCStats(e){if(!this.requestStats||!this.requestUploadStats)return;let n,i;if(this.uploadTransportStarted&&(n=this.requestStats(),this.store.useP2P&&(i=this.requestStats(!0))),!n&&this.uploadOutboundStarted&&(n=this.requestStats()),!i&&this.uploadInboundStarted&&(i=this.requestStats(!0)),n||i){const r={};if(this.uploadTransportStarted&&n){const o=this.getTransportStats(n,i,e);o&&(r.misc=[o])}if(this.uploadOutboundStarted&&n){const o=this.getOutboundStats(n,e?this.lastSendStats:this.lastFullSendStats,e);o&&(r.outbound=[o])}if(this.uploadInboundStarted&&i){const o=this.getInboundStats(i,e?this.lastRecvStats:this.lastFullRecvStats,e);o&&(r.inbound=o)}this.requestUploadStats(r)}this.lastRecvStats=i,this.lastSendStats=n,e||(this.lastFullRecvStats=i,this.lastFullSendStats=n)}startUploadWRTCStats(){if(this.uploadWRTCStatsTimer)return;let e=1;this.uploadWRTCStatsTimer=window.setInterval(()=>{if(!this.uploadTransportStarted&&!this.uploadInboundStarted&&!this.uploadOutboundStarted)return this.stopUploadWRTCStats();this.uploadWRTCStats(e!==sc),++e===sc+1&&(e=1)},vs)}stopUploadWRTCStats(){window.clearInterval(this.uploadWRTCStatsTimer),this.uploadWRTCStatsTimer=void 0,this.lastSendStats&&(this.lastSendStats.videoSend=[],this.lastSendStats.audioSend=[],this.lastSendStats=void 0),this.lastRecvStats&&(this.lastRecvStats.videoRecv=[],this.lastRecvStats.audioRecv=[],this.lastRecvStats=void 0)}getTransportStats(e,n,i){if(!this.requestStats)return;if(i)return e.rtt==null?void 0:{addition:{[Tr.RTT]:e.rtt,[Tr.CONN_TYPE]:void 0}};const r=q0(e);if(this.store.useP2P){if(n){const o=q0(n);r[Tr.CONN_TYPE]+=o[Tr.CONN_TYPE]<<3}r[Tr.CONN_TYPE]+=110}else r[Tr.CONN_TYPE]+=100;return{addition:r}}getOutboundStats(e,n,i){if(!this.requestUploadStats||!this.requestLocalMedia)return;const r=this.requestLocalMedia();if(!r||r.length===0)return;let o,s,a;return r.forEach(c=>{let[d,{track:u,ssrcs:l}]=c;switch(d){case X.LocalVideoLowTrack:case X.LocalVideoTrack:if(d===X.LocalVideoTrack){const p=function(m,g,y,A,k){const M=g.videoSend.find(lt=>lt.ssrc===m);if(!M)return;const V={},{sentFrame:B,inputFrame:K}=M;if(K&&B){const lt=K.frameRate,Yt=B.frameRate;V[Nn.FREEZE]=function(de,Pe){let hn=!0;return hn=!(de<=5)&&(de<=10?Pe<3:de<=20?Pe<4:Pe<5),hn}(lt,Yt)?1:0}if(Ft(V,Nn.QP_SUM,M.qpSumPerFrame),k)return V;switch(B&&(Ft(V,Nn.HEIGHT,B.height),Ft(V,Nn.WIDTH,B.width),Ft(V,Nn.FRAME_RATE,B.frameRate)),V[Nn.DISABLED]=A._originMediaStreamTrack&&!A._originMediaStreamTrack.enabled||A._mediaStreamTrack&&!A._mediaStreamTrack.enabled?1:0,M.adaptionChangeReason){case"none":V[Nn.ADAPTATION]=0;break;case"cpu":V[Nn.ADAPTATION]=1;break;case"bandwidth":V[Nn.ADAPTATION]=2;break;case"other":V[Nn.ADAPTATION]=3}let Y=0;M.adaptionChangeReason&&(Y+=Y0(M.adaptionChangeReason)),g.qualityLimitationReason&&(Y+=Y0(g.qualityLimitationReason)<<3),V[Nn.ADAPTATION]=Y,V[Nn.PLAYER_STATUS]=ET[A._player?A._player.videoElementStatus:"uninit"],Ft(V,Nn.NACKS,M.nacksCount),Ft(V,Nn.PLIS,M.plisCount),Ft(V,Nn.FIRS,M.firsCount),Ft(V,Nn.AVG_ENCODE,M.avgEncodeMs);const J=y&&y.videoSend.find(lt=>lt.ssrc===m);if(J){let lt=k?vs:vs*sc;J.timestamp&&M.timestamp&&(lt=M.timestamp-J.timestamp),J.packets!=null&&M.packets!=null&&Ft(V,Nn.PACKAGE_RATE,1e3*(M.packets-J.packets)/lt),M.packetsLost!=null&&J.packetsLost!=null&&Ft(V,Nn.PACKAGE_LOST,M.packetsLost-J.packetsLost),J.bytes!=null&&M.bytes!=null&&Ft(V,Nn.BITRATE,8*(M.bytes-J.bytes)/lt)}return V}(l[0].ssrcId,e,n,u,i),f=i?null:function(m,g,y){const A=g.videoSend.find(Y=>Y.ssrc===m);if(!A)return null;const k={},M=A.inputFrame,V=M&&M.height||y&&y.videoHeight||0,B=M&&M.width||y&&y.videoWidth||0,K=M&&M.frameRate||0;return Ft(k,kf.HEIGHT,V),Ft(k,kf.WIDTH,B),Ft(k,kf.FRAME_RATE,K),k}(l[0].ssrcId,e,u),C=i?null:function(m){const g={};return Ft(g,Nn.RETRANSMIT,m.bitrate.retransmit),Ft(g,Nn.TARGET_ENCODED,m.bitrate.targetEncoded),Ft(g,Nn.ACTUAL_ENCODED,m.bitrate.actualEncoded),Ft(g,Nn.TRANSMIT,m.bitrate.transmit),Ft(g,Nn.BANDWIDTH,m.sendBandwidth),g}(e);s=Object.assign({},p,f,C)}else a=i?void 0:function(p,f,C){const m=f.videoSend.find(A=>A.ssrc===p);if(!m)return;const g={},y=m.sentFrame;if(y&&(Ft(g,rc.HEIGHT,y.height),Ft(g,rc.WIDTH,y.width),Ft(g,rc.FRAME_RATE,y.frameRate)),C){const A=C.videoSend.find(k=>k.ssrc===p);if(A){let k=vs*sc;A.timestamp&&m.timestamp&&(k=m.timestamp-A.timestamp),A.packets!=null&&m.packets!=null&&Ft(g,rc.PACKAGE_RATE,1e3*(m.packets-A.packets)/k),m.packetsLost!=null&&A.packetsLost!=null&&Ft(g,rc.PACKAGE_LOST,m.packetsLost-A.packetsLost),A.bytes!=null&&m.bytes!=null&&Ft(g,rc.BITRATE,8*(m.bytes-A.bytes)/k)}}return g}(l[0].ssrcId,e,n);break;case X.LocalAudioTrack:o=i?void 0:function(p,f,C,m){const g=f.audioSend.find(V=>V.ssrc===p);if(!g)return;const y={};y[sa.DISABLED]=m._originMediaStreamTrack&&!m._originMediaStreamTrack.enabled||m._mediaStreamTrack&&!m._mediaStreamTrack.enabled?1:0;const A=100*m._source.getAccurateVolumeLevel(),k=g.inputLevel;if(k!=null){const V=Math.ceil(50*Math.log10(100*k+1));Ft(y,sa.LEVEL,V)}Ft(y,H0.PCM_LEVEL,A),Ft(y,sa.AEC_RETURN_LOSS,g.aecReturnLoss),Ft(y,sa.AEC_RETURN_LOSS_ENH,g.aecReturnLossEnhancement),y[sa.FREEZE]=0;const M=C&&C.audioSend.find(V=>V.ssrc===p);if(M){let V=vs*sc;M.timestamp&&g.timestamp&&(V=g.timestamp-M.timestamp),M.bytes!=null&&g.bytes!=null&&Ft(y,sa.BITRATE,8*(g.bytes-M.bytes)/V),M.packets!=null&&g.packets!=null&&Ft(y,sa.PACKAGE_RATE,1e3*(g.packets-M.packets)/V)}return y}(l[0].ssrcId,e,n,u)}}),{high:s,low:a,audio:o}}getInboundStats(e,n,i){if(!this.requestRemoteMedia)return;const r=this.requestRemoteMedia()||[],o=[];return r.forEach(s=>{let[a,c]=s;const d={peer:a.uid};if(c.has(_t.VIDEO)&&a.videoTrack){const u=a._videoSSRC&&this.requestVideoIsReady&&this.requestVideoIsReady(a._videoSSRC)||!1,l=a.videoTrack?function(p,f,C,m,g,y,A){var k;const M=f.videoRecv.find(Yt=>Yt.ssrc===p);if(!M)return;const V={},{receivedFrame:B,outputFrame:K,decodeFrameRate:Y}=M,J=C&&C.videoRecv.find(Yt=>Yt.ssrc===p);if(V[ei.FREEZE]=g&&Pl.isRemoteVideoFreeze(m,M,J)?1:0,Ft(V,oc.FRAME_RATE_DECODE,Y),Ft(V,ei.QP_SUM,M.qpSumPerFrame),M.framesRateFirefox&&Ft(V,ei.FRAME_RATE,M.framesRateFirefox),B&&Ft(V,ei.FRAME_RATE,B.frameRate),J){const Yt=f.timestamp-C.timestamp||(A?vs:sc*vs);M.packetsLost!=null&&J.packetsLost!=null&&Ft(V,ei.PACKAGE_LOST,M.packetsLost-J.packetsLost),J.bytes!=null&&M.bytes!=null&&Ft(V,ei.BITRATE,8*(M.bytes-J.bytes)/Yt),J.packets!=null&&M.packets!=null&&Ft(V,ei.PACKAGE_RATE,1e3*(M.packets-J.packets)/Yt)}if(A)return V;B?(Ft(V,ei.HEIGHT,B.height),Ft(V,ei.WIDTH,B.width)):m&&(Ft(V,ei.HEIGHT,m._videoHeight||0),Ft(V,ei.WIDTH,m._videoWidth||0)),K&&Ft(V,oc.FRAME_RATE_OUTPUT,K.frameRate);const lt=(k=m._player)===null||k===void 0?void 0:k.rendFrameRate.toFixed(0);if(lt&&Ft(V,oc.FRAME_RATE_RENDER,+lt),Ft(V,ei.JITTER_BUFFER,M.jitterBufferMs),Ft(V,ei.CURRENT_DELAY,M.currentDelayMs),Ft(V,ei.FIRS,M.firsCount),Ft(V,ei.NACKS,M.nacksCount),Ft(V,ei.PLIS,M.plisCount),m){V[ei.DISABLED]=m._originMediaStreamTrack.enabled&&m._mediaStreamTrack.enabled?0:1;const Yt=m._player;if(Yt){const{freezeTimeCounterList:de,renderFreezeAccTime:Pe,videoElementStatus:hn}=Yt;if(de&&de.length>0&&Ft(V,oc.FREEZE_TIME,de.splice(0,1)[0]),y&&Cs.visibility==="visible"&&hn===di.PLAYING&&zt().supportRequestVideoFrameCallback){const qe=Math.min(6e3,Pe);Yt.renderFreezeAccTime=Math.max(0,Pe-qe),Ft(V,oc.FREEZE_TIME_RENDER,qe)}if(typeof M.totalFreezesDuration=="number"){const qe=J&&J.totalFreezesDuration?M.totalFreezesDuration-J.totalFreezesDuration:M.totalFreezesDuration;Ft(V,oc.FREEZE_DURATION,1e3*qe)}}}if(V[ei.PLAYER_STATUS]=ET[m._player?m._player.videoElementStatus:"uninit"],J&&M.totalInterFrameDelay!==void 0&&M.totalSquaredInterFrameDelay!==void 0&&J.totalInterFrameDelay!==void 0&&J.totalSquaredInterFrameDelay!==void 0){const Yt=M.totalInterFrameDelay-J.totalInterFrameDelay,de=M.totalSquaredInterFrameDelay-J.totalSquaredInterFrameDelay,Pe=M.framesDecodeCount-J.framesDecodeCount,hn=Yt/Pe*1e3,qe=Math.round(1e3*Math.sqrt((de-Math.pow(Yt,2)/Pe)/Pe));!isNaN(qe)&&hn+qe>Math.max(3*hn,hn+150)&&(V[ei.I_FRAME_DELAY]=qe)}return V}(a._videoSSRC,e,n,a.videoTrack,u===!0,this.needUploadRenderFreezeTime,i):void 0;l&&(d.video=l)}if(c.has(_t.AUDIO)&&a.audioTrack){const u=a.audioTrack?function(l,p,f,C,m){const g=p.audioRecv.find(J=>J.ssrc===l);if(!g)return;const y={},A=f&&f.audioRecv.find(J=>J.ssrc===l),{receivedFrames:k,droppedFrames:M}=g;var V,B;if(Ft(y,Jr.JITTER,g.jitterMs),k!=null&&M!=null&&(y[Jr.FREEZE]=(B=M,(V=k)===0||100*B/V>20?1:0)),A){const J=p.timestamp-f.timestamp||(m?vs:vs*sc);g.packets!=null&&A.packets!=null&&Ft(y,Jr.PACKAGE_RATE,1e3*(g.packets-A.packets)/J),A.bytes!=null&&g.bytes!=null&&Ft(y,Jr.BITRATE,8*(g.bytes-A.bytes)/J),g.packetsLost!=null&&A.packetsLost!=null&&Ft(y,Jr.PACKAGE_LOST,g.packetsLost-A.packetsLost)}if(m)return y;const K=100*C._source.getAccurateVolumeLevel(),Y=g.outputLevel;if(Y!=null){const J=Math.ceil(50*Math.log10(100*Y+1));Ft(y,K0.LEVEL,J)}if(Ft(y,Jr.PCM_LEVEL,K),C&&(y[Jr.DISABLED]=C._originMediaStreamTrack.enabled&&C._mediaStreamTrack.enabled?0:1),Ft(y,Jr.JITTER_BUFFER,g.jitterBufferMs),Ft(y,Jr.CURRENT_DELAY,g.jitterBufferMs),y[Jr.PLAYER_STATUS]=ET[bi.getPlayerState(C.getTrackId())],A){const J=g.concealedSamples-A.concealedSamples;J>0&&Ft(y,Jr.CONCEALED_SAMPLES,J)}return y}(a._audioSSRC,e,n,a.audioTrack,i):void 0;u&&(d.audio=u)}(d.video||d.audio)&&o.push(d)}),this.needUploadRenderFreezeTime=!this.needUploadRenderFreezeTime,o}startUploadTransportStats(){this.uploadTransportStarted=!0,this.uploadWRTCStatsTimer||this.startUploadWRTCStats()}stopUploadTransportStats(){this.uploadTransportStarted=!1}startUploadOutboundStats(){this.uploadOutboundStarted||(this.uploadOutboundStarted=!0,this.uploadWRTCStatsTimer||this.startUploadWRTCStats(),this.uploadOutboundDenoiserStatsTimer&&window.clearInterval(this.uploadOutboundDenoiserStatsTimer),this.uploadOutboundDenoiserStatsTimer=window.setInterval(()=>{if(!this.requestAllTracks||!this.requestUpload)return;const e=(this.requestAllTracks()||[]).find(n=>n instanceof If);if(e&&e._external.getDenoiserStats){const n=e._external.getDenoiserStats();n&&this.requestUpload(Ba.DENOISER_STATS,n)}},2e3),this.uploadExtStatsTimer&&window.clearInterval(this.uploadExtStatsTimer),this.uploadExtStatsTimer=window.setInterval(()=>{!this.requestAllTracks||!this.requestUpload||this.requestAllTracks().forEach(e=>{e.getProcessorStats().forEach(n=>{this.requestUpload&&this.requestUpload(n.type,n.stats)})})},2e3))}stopUploadOutboundStats(){this.uploadOutboundStarted&&(this.uploadOutboundStarted=!1,this.lastSendStats&&(this.lastSendStats.videoSend=[],this.lastSendStats.audioSend=[],this.lastSendStats=void 0),this.uploadOutboundDenoiserStatsTimer&&window.clearInterval(this.uploadOutboundDenoiserStatsTimer),this.uploadOutboundDenoiserStatsTimer=void 0)}startUploadInboundStats(){this.uploadInboundStarted||(this.uploadInboundStarted=!0,this.uploadWRTCStatsTimer||this.startUploadWRTCStats(),this.uploadInboundExtStatsTimer&&window.clearInterval(this.uploadInboundExtStatsTimer),this.uploadInboundExtStatsTimer=window.setInterval(()=>{!this.requestUpload||!this.requestRemoteMedia||(this.requestRemoteMedia()||[]).forEach(e=>{let[n,i]=e;i.has(_t.VIDEO)&&n.videoTrack&&n.videoTrack.getProcessorStats().forEach(r=>{this.requestUpload&&this.requestUpload(r.type,r.stats)}),i.has(_t.AUDIO)&&n.audioTrack&&n.audioTrack.getProcessorStats().forEach(r=>{this.requestUpload&&this.requestUpload(r.type,r.stats)})})},2e3))}stopUploadInboundStats(){this.uploadInboundStarted&&(this.uploadInboundStarted=!1,this.lastRecvStats&&(this.lastRecvStats.videoRecv=[],this.lastRecvStats.audioRecv=[],this.lastRecvStats=void 0))}startUploadExtensionUsageStats(){if(this.uploadExtensionUsageStarted)return;this.uploadExtensionUsageStarted=!0,this.uploadExtUsageStatsTimer&&window.clearInterval(this.uploadExtUsageStatsTimer);const e=new Map;this.uploadExtUsageStatsTimer=window.setInterval(async()=>{const n=Date.now(),i={connectionInterval:N("EXTENSION_USAGE_UPLOAD_INTERVAL")/1e3,details:[],lts:n};let r=[];const o=this.requestAllTracks&&this.requestAllTracks()||[];for(const d of o)!d.muted&&d.enabled&&(r=r.concat(await d.getProcessorUsage()));const s=this.requestRemoteMedia&&this.requestRemoteMedia()||[];for(const[d,u]of s)u.has(_t.VIDEO)&&d.videoTrack&&(r=r.concat(await d.videoTrack.getProcessorUsage())),u.has(_t.AUDIO)&&d.audioTrack&&(r=r.concat(await d.audioTrack.getProcessorUsage()));if(r.length===0)return;i.details=function(d,u){const l={};for(const{id:m,value:g,level:y,direction:A}of d){var p;const k=(p=u.get(m))!==null&&p!==void 0?p:0,M=g===2?k+N("EXTENSION_USAGE_UPLOAD_INTERVAL")/1e3:k;var f,C;u.set(m,M),l[m]?(g===2&&(l[m].value=g),y>l[m].level&&(l[m].level=y),A==="remote"&&(l[m].remoteUidCount+=1),l[m].totalTs=(f=u.get(m))!==null&&f!==void 0?f:0):l[m]={value:g,level:y,remoteUidCount:A==="local"?0:1,totalTs:(C=u.get(m))!==null&&C!==void 0?C:0}}return Object.keys(l).map(m=>{const{level:g,value:y,totalTs:A}=l[m];return{id:m,level:g,value:y,totalTs:A}})}(r,e);const a=Date.now(),c=a>n?a:n+1;this.requestUpload&&this.requestUpload(Ba.EXTENSION_USAGE_STATS,{usageStats:i,sendTs:c})},N("EXTENSION_USAGE_UPLOAD_INTERVAL"))}stopUploadExtensionUsageStats(){this.uploadExtensionUsageStarted&&(this.uploadExtensionUsageStarted=!1,this.uploadExtUsageStatsTimer&&window.clearInterval(this.uploadExtUsageStatsTimer),this.uploadExtUsageStatsTimer=void 0)}}class aa{get hasVideo(){return this._video_enabled_&&!this._video_muted_&&this._video_added_}get hasAudio(){return this._audio_enabled_&&!this._audio_muted_&&this._audio_added_}get audioTrack(){if(this.hasAudio||this._audio_pre_subscribed)return this._audioTrack}get videoTrack(){if(this.hasVideo||this._video_pre_subscribed)return this._videoTrack}get dataChannels(){return this._dataChannels}constructor(e,n){R(this,"uid",void 0),R(this,"_uintid",void 0),R(this,"_trust_in_room_",!0),R(this,"_trust_audio_enabled_state_",!0),R(this,"_trust_video_enabled_state_",!0),R(this,"_trust_audio_mute_state_",!0),R(this,"_trust_video_mute_state_",!0),R(this,"_audio_muted_",!1),R(this,"_video_muted_",!1),R(this,"_audio_enabled_",!0),R(this,"_video_enabled_",!0),R(this,"_audio_added_",!1),R(this,"_video_added_",!1),R(this,"_is_pre_created",!1),R(this,"_video_pre_subscribed",!1),R(this,"_audio_pre_subscribed",!1),R(this,"_trust_video_stream_added_state_",!0),R(this,"_trust_audio_stream_added_state_",!0),R(this,"_audioTrack",void 0),R(this,"_videoTrack",void 0),R(this,"_dataChannels",[]),R(this,"_audioSSRC",void 0),R(this,"_videoSSRC",void 0),R(this,"_audioOrtc",void 0),R(this,"_videoOrtc",void 0),R(this,"_cname",void 0),R(this,"_rtxSsrcId",void 0),R(this,"_videoMid",void 0),R(this,"_audioMid",void 0),this.uid=e,this._uintid=n}}let Eo=function(t){return t.SEND_ONLY="SEND_ONLY",t.RECEIVE_ONLY="RECEIVE_ONLY",t}({});function r3(t,e){var n;let i;switch(e){case X.LocalAudioTrack:i=le.Audio;break;case X.LocalVideoTrack:i=it(n=t._hints).call(n,De.SCREEN_TRACK)?le.Screen:le.High;break;case X.LocalVideoLowTrack:i=le.Low}return i}function VT(t){const e=zt();if(t.some(n=>n._bypassWebAudio))throw new G(b.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio");if(!e.webAudioMediaStreamDest)throw new G(b.NOT_SUPPORTED,"cannot publish multiple tracks because your browser does not support audio mixing")}function FT(t,e){VT(t);const n=e||new vn;return t.forEach(i=>n.addAudioTrack(i)),n}var J0,X0,Q0,Z0,$0,tN,eN,nN,iN,rN,oN,Be;function sN(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),n.push.apply(n,i)}return n}function Mf(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?sN(Object(n),!0).forEach(function(i){R(t,i,n[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):sN(Object(n)).forEach(function(i){Object.defineProperty(t,i,Object.getOwnPropertyDescriptor(n,i))})}return t}let Ki=(J0=mo(Eo.SEND_ONLY),X0=mo(Eo.SEND_ONLY),Q0=mo(),Z0=mo(Eo.RECEIVE_ONLY),$0=mo(Eo.RECEIVE_ONLY),tN=mo(Eo.RECEIVE_ONLY),eN=mo(Eo.RECEIVE_ONLY),nN=mo(Eo.RECEIVE_ONLY),iN=mo(Eo.RECEIVE_ONLY),rN=mo(),oN=mo(Eo.RECEIVE_ONLY),Be=class extends Ve{get state(){return this._state}set state(t){const e=this._state;this._state=t,this.emit(yt.StateChange,e,this._state)}constructor(t,e){super(),R(this,"store",void 0),R(this,"statsUploader",void 0),R(this,"sendConnection",void 0),R(this,"recvConnection",void 0),R(this,"localTrackMap",new Map),R(this,"remoteUserMap",new Map),R(this,"localDataChannels",[]),R(this,"pendingLocalTracks",[]),R(this,"pendingRemoteTracks",[]),R(this,"statsCollector",void 0),R(this,"dtlsFailedCount",0),R(this,"sendMutex",new kn("P2PChannel2-send-mutex")),R(this,"recvMutex",new kn("P2PChannel2-recv-mutex")),R(this,"_state",he.Disconnected),R(this,"_restartStates",["disconnected","failed"]),R(this,"reconnectInterval",void 0),R(this,"uploadUnplinkStarted",!1),R(this,"uploadDownlinkStarted",!1),R(this,"uplinkStateUploadInterval",void 0),R(this,"downlinkStatsUploadInterval",void 0),R(this,"handleMuteLocalTrack",async(n,i,r)=>{const o=await this.sendMutex.lock("Locking from P2PChannel2.handleMuteLocalTrack");try{if(!this.sendConnection||this.state!==he.Connected)return void r(new G(b.INVALID_OPERATION,"Cannot call P2PChannel2.handleMuteLocalTrack before sendConnection established."));const c=this.filterTobeMutedTracks(n);if(c.length===0)return void i();const d=c.find(f=>f[0]==="videoLowTrack");d&&d[1].track._originMediaStreamTrack.stop(),await this.sendConnection.muteLocal(c.map(f=>{let[,{id:C}]=f;return C}));let u=!1;var s,a;n.trackMediaType==="video"?u=!((s=this.localTrackMap.get(X.LocalAudioTrack))===null||s===void 0||!s.track._muted):u=((a=this.localTrackMap.get(X.LocalVideoTrack))===null||a===void 0?void 0:a.id)===void 0;const l=this.createMuteMessage(c);await Ie(this,yt.RequestMuteLocal,l);const p=n.trackMediaType==="video"?Js.MUTE_LOCAL_VIDEO:Js.MUTE_LOCAL_AUDIO;await Ie(this,yt.RequestP2PMuteLocal,{action:p,message:l,isMuteAll:u}),i()}catch(c){r(c)}finally{o()}}),R(this,"handleUnmuteLocalTrack",async(n,i,r)=>{const o=await this.sendMutex.lock("Locking from P2PChannel2.handleUnmuteLocalTrack");try{if(!this.sendConnection||this.state!==he.Connected)return void r(new G(b.INVALID_OPERATION,"Cannot call P2PChannel2.handleUnmuteLocalTrack before sendConnection established."));const s=this.filterTobeUnmutedTracks(n);if(s.length===0)return void i();await this.sendConnection.unmuteLocal(s.map(d=>{let[,{id:u}]=d;return u}));const a=this.createUnmuteMessage(s),c=n.trackMediaType==="video"?Js.UNMUTE_LOCAL_VIDEO:Js.UNMUTE_LOCAL_AUDIO;await Ie(this,yt.RequestP2PMuteLocal,{action:c,message:a}),i()}catch(s){r(s)}finally{o()}}),R(this,"handleUpdateVideoEncoder",async(n,i,r)=>{const o=await this.sendMutex.lock("Locking from P2PChannel2.handleSetVideoEncoder");try{const s=this.localTrackMap.get(X.LocalVideoTrack);if(!this.sendConnection||!s||s.track!==n||this.state!==he.Connected)return void i();const{id:a,track:c}=s;a&&(await this.sendConnection.updateSendParameters(a,c),await this.sendConnection.updateEncoderConfig(a,c),this.emit(yt.UpdateVideoEncoder,c)),i()}catch(s){r(s)}finally{o()}}),R(this,"handleUpdateVideoSendParameters",async(n,i,r)=>{const o=await this.sendMutex.lock("Locking from P2PChannel2.handleUpdateVideoSendParameters");try{const s=this.localTrackMap.get(X.LocalVideoTrack);if(!this.sendConnection||!s||s.track!==n||this.state!==he.Connected)return void i();const{id:a,track:c}=s;a&&await this.sendConnection.updateSendParameters(a,c),i()}catch(s){r(s)}finally{o()}}),R(this,"handleReplaceTrack",async(n,i,r,o)=>{let s;E.debug("[".concat(this.store.clientId,"] P2PChannel2 handleReplaceTrack for [track-id-").concat(n.getTrackId(),"]")),typeof o=="boolean"&&o||(s=await this.sendMutex.lock("From P2PChannel2.handleReplaceTrack"));try{var a;const d=Array.from(this.localTrackMap.entries()).find(u=>{let[,{track:l}]=u;return n===l});if(!this.sendConnection||!d||d[1].id===void 0||this.state!==he.Connected)return void i();if(await((a=this.sendConnection)===null||a===void 0?void 0:a.replaceTrack(n,d[1].id)),d[0]===X.LocalVideoTrack&&zt().supportDualStreamEncoding){const u=this.localTrackMap.get(X.LocalVideoLowTrack);if(u){const l=n._mediaStreamTrack.clone();u.track._originMediaStreamTrack.stop(),u.track._mediaStreamTrack=l,u.track._originMediaStreamTrack=l,await new ot((p,f)=>{this.handleReplaceTrack(u.track,p,f,!0)})}}i()}catch(d){r(d)}finally{var c;(c=s)===null||c===void 0||c()}}),R(this,"handleGetLocalVideoStats",n=>{n(this.statsCollector.getLocalVideoTrackStats())}),R(this,"handleGetLocalAudioStats",n=>{n(this.statsCollector.getLocalAudioTrackStats())}),R(this,"handleGetRemoteVideoStats",n=>this.statsCollector.getRemoteVideoTrackStats(n.uid)[n.uid]),R(this,"handleGetRemoteAudioStats",n=>this.statsCollector.getRemoteAudioTrackStats(n.uid)[n.uid]),this.store=t,this.statsCollector=e,this.statsCollector.addP2PChannel(this),this.statsUploader=new z0(t),this.bindStatsUploaderEvents(),this.reconnectInterval=window.setInterval(()=>{[this.sendConnection,this.recvConnection].forEach(n=>{n&&(n.iceConnectionState!=="disconnected"&&n.iceConnectionState!=="failed"||this.handleDisconnect(n.direction))})},N("ICE_RESTART_INTERVAL"))}async startP2PConnection(t,e){throw new G(b.NOT_SUPPORTED,"p2p mode does not support startP2PConnection.")}async connect(t,e,n,i,r,o){throw new G(b.NOT_SUPPORTED,"p2p mode does not support connect.")}async startP2P(t,e){let n;try{if(e){this.recvConnection&&(E.warning("[".concat(this.store.clientId,"] P2PChannel.startP2P reset recvConnection.")),this.recvConnection.close(),this.unbindConnectionEvents(this.recvConnection)),n=await this.recvMutex.lock("From P2PChannel.startP2P"),this.recvConnection=new W0(t,this.store,mi.RECEIVE_ONLY),this.bindConnectionEvents(this.recvConnection);const i=await this.recvConnection.establish(e);return{iceParameters:i.iceParameters,dtlsParameters:i.dtlsParameters,sdp:i.sdp}}{this.state=he.New,this.sendConnection&&(E.warning("[".concat(this.store.clientId,"] P2PChannel.startP2P reset sendConnection.")),this.sendConnection.close(),this.unbindConnectionEvents(this.sendConnection)),n=await this.sendMutex.lock("From P2PChannel.startP2P"),this.sendConnection=new W0(t,this.store),this.store.peerConnectionStart(),this.bindConnectionEvents(this.sendConnection);const i=await this.sendConnection.establish();return{iceParameters:i.iceParameters,dtlsParameters:i.dtlsParameters,sdp:i.sdp}}}finally{n&&n()}}async p2pConnect(t){if(!this.sendConnection)throw new G(b.UNEXPECTED_ERROR,"Cannot P2PChannel2.p2pConnect before P2PChannel2.startP2PConnection .");this.store.peerConnectionStart(),await this.sendConnection.connect(t),this.statsUploader.startUploadTransportStats(),this.statsUploader.startUploadExtensionUsageStats(),this.state=he.Connected}async addRemoteCandidate(t,e){if(e===mi.RECEIVE_ONLY){if(!this.sendConnection)throw new G(b.UNEXPECTED_ERROR,"Cannot P2PChannel2.connect before P2PChannel2.addRemoteCandidate .");await this.sendConnection.addRemoteCandidate(t)}else{if(!this.recvConnection)throw new G(b.UNEXPECTED_ERROR,"Cannot P2PChannel2.connect before P2PChannel2.addRemoteCandidate .");await this.recvConnection.addRemoteCandidate(t)}}publish(t,e,n){var i=this;return Hi(function*(){const r=yield Mt(i.sendMutex.lock("From P2PChannel.publish"));try{if(!i.sendConnection||i.state!==he.Connected){i.throwIfTrackTypeNotMatch(t);const d=t.filter(u=>i.pendingLocalTracks.indexOf(u)===-1);return void(i.pendingLocalTracks=i.pendingLocalTracks.concat(d))}i.store.pubId=i.store.pubId+1,$n.markPublishStart(i.store.clientId,i.store.pubId);const o=i.filterTobePublishedTracks(t,e,n);if(o.length===0)return void(yield Mt(i.tryToUnmuteAudio(t)));o.forEach(d=>{let{track:u,type:l}=d;const p=Date.now();i.store.publish(u.getTrackId(),l===X.LocalAudioTrack?"audio":"video",p)}),i.bindLocalTrackEvents(o);const s=yield Mt(i.sendConnection.send(o.map(d=>{let{track:u}=d;return u}),i.store.codec,i.store.audioCodec)),a=(yield Mt(s.next())).value,c=i.createGatewayPublishMessage(o,a);try{yield c}catch(d){throw s.throw(d),(d==null?void 0:d.code)===b.WS_ABORT&&o.forEach(u=>{let{track:l}=u;i.pendingLocalTracks.indexOf(l)===-1&&i.pendingLocalTracks.push(l)}),i.unbindLocalTrackEvents(o),d}yield Mt(s.next()),o.forEach(d=>{let{type:u}=d;i.statsCollector.addLocalStats(u)}),i.statsUploader.startUploadOutboundStats(),i.assignLocalTracks(o,a),o.forEach(d=>{let{track:u,type:l}=d;const p=Date.now();i.store.publish(u.getTrackId(),l===X.LocalAudioTrack?"audio":"video",void 0,p)}),i.startUploadUplinkState()}finally{r()}})()}async unpublish(t){if(!this.sendConnection||this.state!==he.Connected)return void(t.length===0?this.pendingLocalTracks.length=0:this.pendingLocalTracks=this.pendingLocalTracks.filter(r=>!it(t).call(t,r)));const e=this.filterTobeUnpublishedTracks(t);if(e.length===0)return;const n=e.find(r=>r[0]==="videoLowTrack");n&&n[1].track.close();const i=this.createGatewayUnpublishMessage(e);if(await this.sendConnection.stopSending(e.map(r=>{let[,{id:o}]=r;return o})),this.withdrawLocalTracks(e),this.unbindLocalTrackEvents(e.map(r=>{let[o,{track:s}]=r;return{type:o,track:s}})),e.forEach(r=>{let[o]=r;this.statsCollector.removeLocalStats(o)}),this.localTrackMap.size===0&&(this.statsUploader.stopUploadOutboundStats(),this.stopUploadUplinkState()),this.sendConnection&&this.state===he.Connected)return n&&n[1].track.close(),i;t.forEach(r=>{const o=this.pendingLocalTracks.indexOf(r);o!==-1&&this.pendingLocalTracks.splice(o,1)})}startUploadUplinkState(){if(this.uploadUnplinkStarted)return;this.uploadUnplinkStarted=!0,this.uplinkStateUploadInterval&&window.clearInterval(this.uplinkStateUploadInterval);const t=()=>{const e=[],n=[];Array.from(this.localTrackMap.entries()).forEach(i=>{let[r,{track:o,ssrcs:s}]=i;const a={stream_type:r3(o,r),ssrcs:s};o._muted||!o._enabled?e.push(a):n.push(a)}),e.length>0&&e.forEach(i=>{Ie(this,yt.RequestMuteLocal,[i])}),n.length>0&&n.forEach(i=>{Ie(this,yt.RequestUnmuteLocal,[i])})};t(),this.uplinkStateUploadInterval=window.setInterval(()=>{t()},3e3)}stopUploadUplinkState(){this.uploadUnplinkStarted&&(this.uploadUnplinkStarted=!1,this.uplinkStateUploadInterval&&window.clearInterval(this.uplinkStateUploadInterval))}publishLowStream(t){return Hi(function*(){throw new G(b.NOT_SUPPORTED,"p2p mode does not support publishLowStream.")})()}async republish(){this.pendingLocalTracks.length>0&&(E.debug("[".concat(this.store.clientId,"] Emit P2PChannelEvents.RequestRePublish to republish tracks.")),await En(this,yt.RequestRePublish,this.pendingLocalTracks),this.emit(yt.MediaReconnectEnd,this.store.uid),this.pendingLocalTracks=[])}async unpublishLowStream(){throw new G(b.NOT_SUPPORTED,"p2p mode does not support unpublishLowStream.")}async subscribe(t,e,n,i){var r;if(!this.recvConnection)throw new G(b.INVALID_OPERATION,"Cannot subscribe remote user when recvConnection disconnected.");if((r=this.remoteUserMap.get(t))!==null&&r!==void 0&&r.has(e))return;const{track:o,mid:s,transceiver:a}=await this.recvConnection.receive(e,[{ssrcId:n}],String(t.uid),i);e===_t.AUDIO?(t._audioTrack?t._audioTrack._updateOriginMediaStreamTrack(o):(t._audioTrack=new Nd(o,t.uid,t._uintid,this.store),E.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote audio track: ").concat(t._audioTrack.getTrackId()))),a&&t._audioTrack._updateRtpTransceiver(a),this.bindRemoteTrackEvents(t,t._audioTrack)):(t._videoSSRC=n,t._videoTrack?t._videoTrack._updateOriginMediaStreamTrack(o):(t._videoTrack=new Od(o,t.uid,t._uintid,this.store),E.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote video track: ").concat(t._videoTrack.getTrackId()))),a&&t._videoTrack._updateRtpTransceiver(a),this.bindRemoteTrackEvents(t,t._videoTrack));const c=this.remoteUserMap.get(t);c?c.set(e,s):this.remoteUserMap.set(t,new Map([[e,s]])),this.statsCollector.addRemoteStats(t.uid),this.statsUploader.startUploadInboundStats(),this.startUploadDownlinkState();const d=this.pendingRemoteTracks.findIndex(u=>{let{user:l,kind:p}=u;return l.uid===t.uid&&e===p});d!==-1&&(this.pendingRemoteTracks.splice(d,1),this.emit(yt.MediaReconnectEnd,t.uid))}async mockSubscribe(t,e,n,i){if(!this.recvConnection)throw new G(b.INVALID_OPERATION,"Cannot subscribe remote user when recvConnection disconnected.");await this.recvConnection.mockReceive(e,[{ssrcId:n}],String(t.uid),i)}async unsubscribe(t,e,n){const i=this.pendingRemoteTracks.filter(o=>{let{user:s,kind:a}=o;return e!==void 0?s.uid===t.uid&&e===a:s.uid===t.uid});if(i.forEach(o=>{const s=this.pendingRemoteTracks.indexOf(o);this.pendingRemoteTracks.splice(s,1)}),this.recvConnection||n||i.forEach(o=>{let{kind:s}=o;var a;if(s===_t.AUDIO)(a=t._audioTrack)===null||a===void 0||a._destroy(),t._audioTrack=void 0;else if(s===_t.VIDEO){var c;(c=t._videoTrack)===null||c===void 0||c._destroy(),t._videoTrack=void 0}}),!this.recvConnection)return;const r=this.filterTobeUnSubscribedTracks(t,e);r.length!==0&&(await this.recvConnection.stopReceiving(r.map(o=>{let[,{id:s}]=o;return s})),this.withdrawRemoteTracks(r),this.remoteUserMap.size===0&&(this.statsUploader.stopUploadInboundStats(),this.stopUploadDownlinkState()),r.forEach(o=>{let[s,{kind:a}]=o;var c,d;if(a===_t.VIDEO&&s._videoSSRC&&((c=this.recvConnection)===null||c===void 0||c.setStatsRemoteVideoIsReady(s._videoSSRC,!1)),a===_t.VIDEO)this.unbindRemoteTrackEvents(s._videoTrack),n||((d=s._videoTrack)===null||d===void 0||d._destroy(),s._videoTrack=void 0);else if(a===_t.AUDIO){var u;this.unbindRemoteTrackEvents(s._audioTrack),!n&&((u=s._audioTrack)===null||u===void 0||u._destroy(),s._audioTrack=void 0)}}),r.forEach(o=>{let[,{kind:s}]=o;Ie(this,yt.RequestP2PMuteRemote,s)}))}startUploadDownlinkState(){if(this.uploadDownlinkStarted)return;this.uploadDownlinkStarted=!0,this.downlinkStatsUploadInterval&&window.clearInterval(this.downlinkStatsUploadInterval);const t=()=>Array.from(this.remoteUserMap.entries()).forEach(e=>{let[,n]=e;[_t.VIDEO,_t.AUDIO].forEach(i=>{n.has(i)?Ie(this,yt.RequestP2PUnmuteRemote,i):Ie(this,yt.RequestP2PMuteRemote,i)})});t(),this.downlinkStatsUploadInterval=window.setInterval(()=>{t()},3e3)}stopUploadDownlinkState(){this.uploadDownlinkStarted&&(this.uploadDownlinkStarted=!1,this.downlinkStatsUploadInterval&&window.clearInterval(this.downlinkStatsUploadInterval))}getAllDataChannels(){return this.localDataChannels}async massSubscribe(t){throw new G(b.NOT_SUPPORTED,"p2p mode does not support massSubscribe.")}async massSubscribeNoLock(t){throw new G(b.NOT_SUPPORTED,"p2p mode does not support massSubscribeNoLock.")}async massUnsubscribe(t){throw new G(b.NOT_SUPPORTED,"p2p mode does not support massUnsubscribe.")}async massUnsubscribeNoLock(t){throw new G(b.NOT_SUPPORTED,"p2p mode does not support massUnsubscribeNoLock.")}async muteRemote(t,e){if(!this.recvConnection)return;const n=this.remoteUserMap.get(t);if(!n)return void E.warning("[".concat(this.store.clientId,"] P2PChannel2.muteRemote has no remote user ").concat(t.uid,"."));if(!n.get(e))return void E.warning("[".concat(this.store.clientId,"] P2PChannel2.muteRemote has no remote user ").concat(t.uid," media type ").concat(e,"."));const i=e===_t.VIDEO?t._videoSSRC:t._audioSSRC;i!==void 0&&this.recvConnection.setStatsRemoteVideoIsReady(i,!1)}async unmuteRemote(t,e){return this.unmuteRemoteNoLock(t,e)}async unmuteRemoteNoLock(t,e){if(!this.recvConnection)return;const n=this.remoteUserMap.get(t);if(!n)return void E.warning("[".concat(this.store.clientId,"] P2PChannel2.unmuteRemote has no remote user ").concat(t.uid,"."));n.get(e)||E.warning("[".concat(this.store.clientId,"] P2PChannel2.unmuteRemote has no remote user ").concat(t.uid," media type ").concat(e,"."))}getAllTracks(t){const e=this.localTrackMap.get(X.LocalAudioTrack);if((e==null?void 0:e.track)instanceof vn){const n=e.track;return Array.from(this.localTrackMap.entries()).filter(i=>{let[r]=i;return r!==X.LocalAudioTrack}).filter(i=>{let[r]=i;return!(t&&r===X.LocalVideoLowTrack)}).map(i=>{let[,{track:r}]=i;return r}).concat(n.trackList)}return Array.from(this.localTrackMap.entries()).filter(n=>{let[i]=n;return!(t&&i===X.LocalVideoLowTrack)}).map(n=>{let[,{track:i}]=n;return i})}reportPublishEvent(t,e,n,i,r){if(t){const s=this.localTrackMap.get(X.LocalAudioTrack),a=i?this.localTrackMap.get(X.LocalVideoLowTrack):this.localTrackMap.get(X.LocalVideoTrack);Et.publish(this.store.sessionId,{eventElapse:$n.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:t,ec:e,audioName:s==null?void 0:s.track.getTrackLabel(),videoName:a==null?void 0:a.track.getTrackLabel(),screenshare:(a==null?void 0:a.track._hints.indexOf(De.SCREEN_TRACK))!==-1,audio:!!s,video:!!a,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:r})}else{var o;n||(n=[]);const s=n.find(c=>c instanceof Qe),a=i?(o=this.localTrackMap.get(X.LocalVideoTrack))===null||o===void 0?void 0:o.track:n.find(c=>c instanceof Ae);Et.publish(this.store.sessionId,{eventElapse:$n.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:t,ec:e,audioName:s==null?void 0:s.getTrackLabel(),videoName:a==null?void 0:a.getTrackLabel(),screenshare:(a==null?void 0:a._hints.indexOf(De.SCREEN_TRACK))!==-1,audio:!!s,video:!!a,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:r})}}reportSubscribeEvent(t,e,n,i){const r=i===_t.VIDEO?n._videoSSRC:n._audioSSRC;r&&Et.subscribe(this.store.sessionId,{succ:t,ec:e,video:i===_t.VIDEO,audio:i===_t.AUDIO,peerid:n.uid,subscribeRequestid:i===_t.VIDEO?n._videoSSRC:n._audioSSRC,p2pid:this.store.p2pId,eventElapse:$n.measureFromSubscribeStart(this.store.clientId,r)})}reset(){E.debug("[".concat(this.store.clientId,"] P2PChannel2.reset")),this.sendMutex=new kn("P2PChannel2-send-mutex"),this.sendMutex=new kn("P2PChannel2-recv-mutex"),this.sendConnection&&(this.sendConnection.close(),this.unbindConnectionEvents(this.sendConnection),this.sendConnection=void 0),this.recvConnection&&(this.recvConnection.close(),this.unbindConnectionEvents(this.recvConnection),this.recvConnection=void 0),this.statsUploader.stopUploadOutboundStats(),this.statsUploader.stopUploadInboundStats(),this.statsUploader.stopUploadTransportStats(),this.statsUploader.stopUploadExtensionUsageStats(),this.stopUploadUplinkState(),this.stopUploadDownlinkState(),this.unbindLocalTrackEvents(),this.unbindAllRemoteTrackEvents(),this.unbindRtpTransceiver();const t=this.localTrackMap.get(X.LocalAudioTrack);if((t==null?void 0:t.track)instanceof vn){if(t.track.trackList.length>0){const e=t.track;t.track.trackList.forEach(n=>{e.removeAudioTrack(n)})}t.track.close()}this.localTrackMap.clear(),this.remoteUserMap.clear(),this.statsCollector.removeRemoteStats(),this.statsCollector.removeLocalStats(),this.dtlsFailedCount=0,this.pendingLocalTracks=[],this.pendingRemoteTracks=[],this.reconnectInterval&&(window.clearInterval(this.reconnectInterval),this.reconnectInterval=void 0),this.state=he.Disconnected}getStats(t){var e,n;return t?(n=this.recvConnection)===null||n===void 0?void 0:n.getStats():(e=this.sendConnection)===null||e===void 0?void 0:e.getStats()}getRemoteVideoIsReady(t){var e;return((e=this.recvConnection)===null||e===void 0?void 0:e.getRemoteVideoIsReady(t))||!1}getLocalAudioVolume(){const t=this.localTrackMap.get(X.LocalAudioTrack);if(t)return t.track.getVolumeLevel()}getLocalVideoSize(){const t=this.localTrackMap.get(X.LocalVideoTrack);if(t)return{width:t.track.videoWidth||0,height:t.track.videoHeight||0}}getEncoderConfig(t){const e=this.localTrackMap.get(t);return e&&e.track instanceof Ae||e&&e.track instanceof Qe?e.track._encoderConfig:void 0}getLocalMedia(t){return this.localTrackMap.get(t)}hasLocalMedia(){return this.localTrackMap.size>0}hasRemoteMedia(t,e){if(!t)return this.remoteUserMap.size>0;const n=this.remoteUserMap.get(t);return!!n&&(!e||n.has(e))}async hasRemoteMediaWithLock(t,e){if(!t)return this.remoteUserMap.size>0;const n=this.remoteUserMap.get(t);return!!n&&(!e||n.has(e))}getRemoteMedia(t){var e;const n=Array.from(Xi(e=this.remoteUserMap).call(e)).find(i=>i.uid===t);return n?{audioTrack:n.audioTrack,audioSSRC:n._audioSSRC,videoTrack:n.videoTrack,videoSSRC:n._videoSSRC}:{}}getAudioLevels(){let t=Array.from(this.remoteUserMap.entries()).map(n=>{let[i]=n;return{uid:i.uid,level:i.audioTrack?100*i.audioTrack._source.getAccurateVolumeLevel():0}});const e=this.localTrackMap.get(X.LocalAudioTrack);return e&&t.push({level:100*e.track._source.getAccurateVolumeLevel(),uid:this.store.uid}),t=Du(t).call(t,(n,i)=>n.level-i.level),t}async disconnectForReconnect(){this.sendConnection&&this.recvConnection&&(E.debug("[".concat(this.store.clientId,"] P2PChannel2.disconnectForReconnect closing P2PConnection")),this.state=he.Reconnecting,N("KEEP_LAST_FRAME")&&this.remoteUserMap.size!==0&&Array.from(this.remoteUserMap.entries()).forEach(t=>{let[e]=t;var n;e._videoTrack&&e._videoTrack._player&&((n=e._videoTrack._player.getVideoElement())===null||n===void 0||n.pause(),e._videoTrack._player.isKeepLastFrame=!0,e._videoTrack._originMediaStreamTrack.stop())}),this.sendConnection.close(),this.unbindConnectionEvents(this.sendConnection),this.sendConnection=void 0,this.recvConnection.close(),this.unbindConnectionEvents(this.recvConnection),this.recvConnection=void 0,this.localTrackMap.size!==0&&(Array.from(this.localTrackMap.entries()).forEach(t=>{var e;let[n,{track:i}]=t;switch(n){case X.LocalVideoTrack:it(e=i._hints).call(e,De.LOW_STREAM)?i.close():this.pendingLocalTracks.push(i);break;case X.LocalAudioTrack:i instanceof vn?this.pendingLocalTracks=this.pendingLocalTracks.concat(i.trackList):this.pendingLocalTracks.push(i);case X.LocalVideoLowTrack:}}),this.emit(yt.MediaReconnectStart,this.store.uid)),this.unbindLocalTrackEvents(),this.localTrackMap.clear(),this.remoteUserMap.size!==0&&Array.from(this.remoteUserMap.entries()).forEach(t=>{let[e,n]=t;Array.from(Xi(n).call(n)).forEach(i=>{this.setPendingRemoteMedia(e,i)}),this.emit(yt.MediaReconnectStart,e.uid)}),this.unbindAllRemoteTrackEvents(),this.remoteUserMap.clear(),this.stopUploadUplinkState(),this.stopUploadDownlinkState(),this.statsUploader.stopUploadOutboundStats(),this.statsUploader.stopUploadInboundStats(),this.statsUploader.stopUploadTransportStats(),E.debug("[".concat(this.store.clientId,"] P2PChannel2 disconnected, waiting to reconnect.")))}hasPendingRemoteMedia(t,e){for(const n of this.pendingRemoteTracks){const{user:i,kind:r}=n;if((t instanceof aa?t.uid:t)===i.uid&&e===r)return!0}return!1}setPendingRemoteMedia(t,e){this.hasPendingRemoteMedia(t,e)||this.pendingRemoteTracks.push({user:t,kind:e})}async restartICE(t,e){let n,i;if(t===mi.SEND_ONLY){if(!this.sendConnection)throw new G(b.INVALID_OPERATION,"Cannot call P2PChannel2.handleMuteLocalTrack before sendConnection established.");n=await this.sendMutex.lock("From P2PChannel.restartICE"),i=this.sendConnection}else{if(!this.recvConnection)throw new G(b.INVALID_OPERATION,"Cannot call P2PChannel2.handleMuteLocalTrack before recvConnection established.");n=await this.recvMutex.lock("From P2PChannel.restartICE"),i=this.recvConnection}try{if(e){const r=await i.restartICE(e);return i.isInRestartIce=!1,r}{const r=await i.restartICE();if(r){const o=await En(this,yt.RequestP2PRestartICE,{direction:mi.RECEIVE_ONLY,iceParameter:r});await i.restartICE(o),i.isInRestartIce=!1}}}finally{n()}}getUplinkNetworkQuality(){if(!this.sendConnection)return 0;const t=this.sendConnection.getStats(),e=this.localTrackMap.get(X.LocalVideoTrack),n=this.localTrackMap.get(X.LocalAudioTrack),i=t.videoSend.find(f=>{var C;return f.ssrc===(e==null||(C=e.ssrcs)===null||C===void 0?void 0:C[0].ssrcId)}),r=t.audioSend.find(f=>{var C;return f.ssrc===(n==null||(C=n.ssrcs)===null||C===void 0?void 0:C[0].ssrcId)});if(!i||!r)return 1;const o=Gi(this,yt.NeedSignalRTT),s=i?i.rttMs:void 0,a=r?r.rttMs:void 0,c=s&&a?(s+a)/2:s||a,d=(c&&o?(c+o)/2:c||o)||0,u=100*t.sendPacketLossRate*.7/50+.3*d/1500,l=u<.17?1:u<.36?2:u<.59?3:u<.1?4:5,p=e==null?void 0:e.track;if(p&&p._encoderConfig&&p._hints.indexOf(De.SCREEN_TRACK)===-1){const f=p._encoderConfig.bitrateMax,C=t.bitrate.actualEncoded;if(f&&C){const m=(1e3*f-C)/(1e3*f);return pb[m<.15?0:m<.3?1:m<.45?2:m<.6?3:4][l]}}return l}getDownlinkNetworkQuality(){if(!this.recvConnection)return 0;const t=this.recvConnection.getStats();let e=0;return Array.from(this.remoteUserMap.entries()).forEach(n=>{let[i]=n;const r=i._audioSSRC,o=i._videoSSRC,s=t.audioRecv.find(C=>C.ssrc===r),a=t.videoRecv.find(C=>C.ssrc===o);if(!s&&!a)return void(e+=1);const c=Gi(this,yt.NeedSignalRTT),d=t.rtt,u=(d&&c?(d+c)/2:d||c)||0,l=s?s.jitterMs:void 0,p=t.recvPacketLossRate;let f=.7*p*100/50+.3*u/1500;l&&(f=.6*p*100/50+.2*u/1500+.2*l/400),e+=f<.1?1:f<.17?2:f<.36?3:f<.59?4:5}),this.remoteUserMap.size>0?Math.round(e/this.remoteUserMap.size):e}async muteLocalTrack(t){return new ot((e,n)=>{this.handleMuteLocalTrack(t,e,n)})}filterTobePublishedTracks(t,e,n){const i=[],r=zt(),o=this.getAllTracks();t=$c(t=t.filter(c=>o.indexOf(c)===-1));let s=!1,a=!1;for(const c of t){if(c instanceof Ae&&(this.localTrackMap.has(X.LocalVideoTrack)||s?new G(b.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS).throw():(i.push({track:c,type:X.LocalVideoTrack}),s=!0),e)){const d=this.getLowVideoTrack(c,n);i.push({track:d,type:X.LocalVideoLowTrack})}if(c instanceof Qe){const d=this.localTrackMap.get(X.LocalAudioTrack);if(d){if(!(d.track instanceof vn))throw new G(b.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser does not support audio mixing");if(c._bypassWebAudio)throw new G(b.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio");d.track.addAudioTrack(c),this.bindLocalAudioTrackEvents(c,!0)}else if(a){const u=i.find(l=>{let{type:p}=l;return p===X.LocalAudioTrack});if(!(u.track instanceof vn))throw new G(b.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser does not support audio mixing");if(c._bypassWebAudio)throw new G(b.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio");u.track.addAudioTrack(c)}else{if(!r.webAudioMediaStreamDest||c instanceof vn||c._bypassWebAudio)i.push({track:c,type:X.LocalAudioTrack});else{const u=new vn;u.addAudioTrack(c),i.push({track:u,type:X.LocalAudioTrack})}a=!0}}}return i}filterTobeUnpublishedTracks(t){const e=[],n=this.getAllTracks();t=$c(t=t.filter(i=>n.indexOf(i)!==-1));for(const i of t){if(i instanceof Qe){const r=this.localTrackMap.get(X.LocalAudioTrack);if(!r)continue;r.track instanceof vn?(r.track.removeAudioTrack(i),this.unbindLocalAudioTrackEvents(i),r.track.trackList.length===0&&(e.push([X.LocalAudioTrack,r]),r.track.close())):e.push([X.LocalAudioTrack,r])}if(i instanceof Ae){const r=this.localTrackMap.get(X.LocalVideoTrack);if(!r)continue;e.push([X.LocalVideoTrack,r]);const o=this.localTrackMap.get(X.LocalVideoLowTrack);o&&e.push([X.LocalVideoLowTrack,o])}}return e}bindLocalTrackEvents(t){t.forEach(e=>{let{track:n,type:i}=e;switch(i){case X.LocalVideoTrack:n.addListener(ut.GET_STATS,this.handleGetLocalVideoStats),n.addListener(ut.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),n.addListener(ut.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),n.addListener(ut.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),n.addListener(ut.NEED_UPDATE_VIDEO_SEND_PARAMETERS,this.handleUpdateVideoSendParameters),n.addListener(ut.NEED_REPLACE_TRACK,this.handleReplaceTrack),n.addListener(ut.NEED_MUTE_TRACK,this.handleMuteLocalTrack),n.addListener(ut.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case X.LocalAudioTrack:this.bindLocalAudioTrackEvents(n);case X.LocalVideoLowTrack:}})}bindLocalAudioTrackEvents(t,e){t instanceof vn?t.trackList.forEach(n=>{n.addListener(ut.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),n.addListener(ut.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),n.addListener(ut.GET_STATS,this.handleGetLocalAudioStats),n.addListener(ut.NEED_MUTE_TRACK,this.handleMuteLocalTrack),n.addListener(ut.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack)}):(t.addListener(ut.GET_STATS,this.handleGetLocalAudioStats),t.addListener(ut.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),t.addListener(ut.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),t.addListener(ut.NEED_MUTE_TRACK,this.handleMuteLocalTrack),t.addListener(ut.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack),e||t.addListener(ut.NEED_REPLACE_TRACK,this.handleReplaceTrack))}unbindLocalTrackEvents(t){t||(t=Array.from(this.localTrackMap.entries()).map(e=>{let[n,{track:i}]=e;return{track:i,type:n}})),t.forEach(e=>{let{track:n,type:i}=e;switch(i){case X.LocalVideoTrack:n.off(ut.GET_STATS,this.handleGetLocalVideoStats),n.off(ut.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),n.off(ut.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),n.off(ut.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),n.off(ut.NEED_UPDATE_VIDEO_SEND_PARAMETERS,this.handleUpdateVideoSendParameters),n.off(ut.NEED_REPLACE_TRACK,this.handleReplaceTrack),n.off(ut.NEED_MUTE_TRACK,this.handleMuteLocalTrack),n.off(ut.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case X.LocalAudioTrack:this.unbindLocalAudioTrackEvents(n);case X.LocalVideoLowTrack:}})}unbindLocalAudioTrackEvents(t){t instanceof vn?t.trackList.forEach(e=>{e.off(ut.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),e.off(ut.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),e.off(ut.GET_STATS,this.handleGetLocalAudioStats),e.off(ut.NEED_MUTE_TRACK,this.handleMuteLocalTrack),e.off(ut.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack)}):(t.off(ut.GET_STATS,this.handleGetLocalAudioStats),t.off(ut.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),t.off(ut.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),t.off(ut.NEED_REPLACE_TRACK,this.handleReplaceTrack),t.off(ut.NEED_MUTE_TRACK,this.handleMuteLocalTrack),t.off(ut.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack))}bindRemoteTrackEvents(t,e){e instanceof Od&&e.addListener(ut.GET_STATS,n=>{n(this.handleGetRemoteVideoStats(t))}),e instanceof Nd&&e.addListener(ut.GET_STATS,n=>{n(this.handleGetRemoteAudioStats(t))})}unbindRemoteTrackEvents(t){t&&t.removeAllListeners(ut.GET_STATS)}unbindAllRemoteTrackEvents(){Array.from(this.remoteUserMap.entries()).forEach(t=>{let[e,n]=t;n.has(_t.AUDIO)&&this.unbindRemoteTrackEvents(e._audioTrack),n.has(_t.VIDEO)&&this.unbindRemoteTrackEvents(e._videoTrack)})}createGatewayPublishMessage(t,e){return t.map((n,i)=>{var r;let o,{track:s,type:a}=n;switch(a){case X.LocalAudioTrack:o=le.Audio;break;case X.LocalVideoTrack:o=it(r=s._hints).call(r,De.SCREEN_TRACK)?le.Screen:le.High;break;case X.LocalVideoLowTrack:o=le.Low}return{kind:a===X.LocalAudioTrack?_t.AUDIO:_t.VIDEO,stream_type:o,mid:e[i].id,ssrcs:e[i].localSSRC,isMuted:s.muted||!s.enabled}})}createGatewayUnpublishMessage(t){return t.map(e=>{var n;let i,[r,{track:o,ssrcs:s,id:a}]=e;switch(r){case X.LocalVideoTrack:i=it(n=o._hints).call(n,De.SCREEN_TRACK)?le.Screen:le.High;break;case X.LocalAudioTrack:i=le.Audio;break;case X.LocalVideoLowTrack:i=le.Low}return{stream_type:i,ssrcs:s,mid:a}})}assignLocalTracks(t,e){t.forEach((n,i)=>{let{track:r,type:o}=n;this.localTrackMap.set(o,{track:r,id:e[i].id,ssrcs:e[i].localSSRC})})}withdrawLocalTracks(t){t.forEach(e=>{let[n]=e;this.localTrackMap.delete(n)})}bindConnectionEvents(t){t.onConnectionStateChange=async e=>{var n;E.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: ").concat(t.name,".onConnectionStateChange(").concat(e,")")),this.emit(yt.PeerConnectionStateChange,e),e!=="connected"||this.store.keyMetrics.peerConnectionEnd||this.store.peerConnectionEnd(),e==="connected"&&(t.isInRestartIce=!1),it(n=this._restartStates).call(n,e)&&!t.isInRestartIce&&(e==="disconnected"&&await wn(800),t.iceConnectionState!=="disconnected"&&t.iceConnectionState!=="failed"||this.handleDisconnect(t.direction))},t.onICEConnectionStateChange=e=>{e!=="connected"||this.store.keyMetrics.iceConnectionEnd||this.store.iceConnectionEnd(),E.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICEConnectionStateChange(").concat(e,")")),Et.reportApiInvoke(this.store.sessionId,{name:"ICEConnectionStateChange",options:e,tag:Je.TRACER}).onSuccess(),this.emit(yt.IceConnectionStateChange,e)},t.onICETransportStateChange=e=>{E.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICETransportStateChange(").concat(e,")"))},t.onDTLSTransportStateChange=e=>{E.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportStateChange(").concat(e,")"))},t.onDTLSTransportError=e=>{E.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportError(").concat(e,")"))},t.onFirstAudioDecoded=e=>{var n;const i=Array.from(Xi(n=this.remoteUserMap).call(n)).find(o=>o._audioSSRC===e);var r;i&&(this.store.subscribe(i.uid,"audio",void 0,void 0,void 0,Date.now()),(r=i.audioTrack)===null||r===void 0||r.emit(Id.FIRST_FRAME_DECODED),Et.firstRemoteFrame(this.store.sessionId,Mn.FIRST_AUDIO_DECODE,He.FIRST_AUDIO_DECODE,{peer:i._uintid,subscribeElapse:$n.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId}))},t.onFirstAudioReceived=e=>{var n;const i=Array.from(Xi(n=this.remoteUserMap).call(n)).find(r=>r._audioSSRC===e);i&&Et.firstRemoteFrame(this.store.sessionId,Mn.FIRST_AUDIO_RECEIVED,He.FIRST_AUDIO_RECEIVED,{peer:i._uintid,subscribeElapse:$n.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId})},t.onFirstVideoDecoded=(e,n,i)=>{this.reportVideoFirstFrameDecoded(e,n,i)},t.onFirstVideoReceived=e=>{var n;const i=Array.from(Xi(n=this.remoteUserMap).call(n)).find(r=>r._videoSSRC===e);i&&Et.firstRemoteFrame(this.store.sessionId,Mn.FIRST_VIDEO_RECEIVED,He.FIRST_VIDEO_RECEIVED,{peer:i._uintid,subscribeElapse:$n.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId})},t.onSelectedLocalCandidateChanged=(e,n)=>{const i=e.candidateType==="relay",r=n.candidateType==="relay";n.candidateType!=="unknown"&&i===r||this.emit(yt.ConnectionTypeChange,i),E.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.SelectedLocalCandidateChanged(").concat(JSON.stringify(Qs(n))," -> ").concat(JSON.stringify(Qs(e)),")"))},t.onSelectedRemoteCandidateChanged=(e,n)=>{E.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.SelectedRemoteCandidateChanged(").concat(JSON.stringify(Qs(n))," -> ").concat(JSON.stringify(Qs(e)),")"))},t.onFirstVideoDecodedTimeout=e=>{this.reportVideoFirstFrameDecoded(e,void 0,void 0,!0)},t.onLocalCandidate=e=>{this.emit(yt.LocalCandidate,{candidate:e,direction:t.direction})}}unbindConnectionEvents(t){t.onConnectionStateChange=void 0,t.onICEConnectionStateChange=void 0,t.onICETransportStateChange=void 0,t.onDTLSTransportStateChange=void 0,t.onDTLSTransportError=void 0,t.onFirstAudioDecoded=void 0,t.onFirstAudioReceived=void 0,t.onFirstVideoDecoded=void 0,t.onFirstVideoReceived=void 0,t.onSelectedLocalCandidateChanged=void 0,t.onSelectedRemoteCandidateChanged=void 0,t.onFirstVideoDecodedTimeout=void 0,t.onLocalCandidate=void 0}async handleDisconnect(t){const e=t===mi.SEND_ONLY?this.sendConnection:this.recvConnection;e&&!e.isInRestartIce&&(e.isInRestartIce=!0,E.debug("[".concat(this.store.clientId,"] [P2PChannel-").concat(e.name,"] start use restartICE")),t===mi.SEND_ONLY?this.restartICE(t):En(this,yt.RequestP2PRestartICE,{direction:mi.SEND_ONLY}))}filterTobeMutedTracks(t){const e=[];if(this.getAllTracks().indexOf(t)===-1)return e;const n=this.localTrackMap.get(X.LocalAudioTrack);if(t instanceof Qe&&(n==null?void 0:n.track)instanceof vn)return n.track.isActive||e.push([X.LocalAudioTrack,n]),e;const i=Array.from(this.localTrackMap.entries()).find(r=>{let[,{track:o}]=r;return t===o});if(i&&(e.push(i),i[0]===X.LocalVideoTrack)){const r=this.localTrackMap.get(X.LocalVideoLowTrack);r&&e.push([X.LocalVideoLowTrack,r])}return e}filterTobeUnmutedTracks(t){const e=[],n=this.localTrackMap.get(X.LocalAudioTrack);if(t instanceof Qe&&(n==null?void 0:n.track)instanceof vn)return n.track.isActive&&e.push([X.LocalAudioTrack,n]),e;const i=Array.from(this.localTrackMap.entries()).find(r=>{let[,{track:o}]=r;return t===o});if(i)if(i[0]===X.LocalVideoTrack){e.push(i);const r=this.localTrackMap.get(X.LocalVideoLowTrack);r&&e.push([X.LocalVideoLowTrack,r])}else e.push(i);return e}createMuteMessage(t){return t.map(e=>{var n;let i,[r,{track:o,ssrcs:s,id:a}]=e;switch(r){case X.LocalAudioTrack:i=le.Audio;break;case X.LocalVideoTrack:i=it(n=o._hints).call(n,De.SCREEN_TRACK)?le.Screen:le.High;break;case X.LocalVideoLowTrack:i=le.Low}return{stream_type:i,ssrcs:s,mid:a}})}createUnmuteMessage(t){return t.map(e=>{var n;let i,[r,{track:o,ssrcs:s,id:a}]=e;switch(r){case X.LocalAudioTrack:i=le.Audio;break;case X.LocalVideoTrack:i=it(n=o._hints).call(n,De.SCREEN_TRACK)?le.Screen:le.High;break;case X.LocalVideoLowTrack:i=le.Low}return{stream_type:i,ssrcs:s,mid:a}})}filterTobeUnSubscribedTracks(t,e){const n=[],i=this.remoteUserMap.get(t);if(!i)return n;if(e){const r=i.get(e);if(!r)return n;n.push([t,{kind:e,id:r}])}else Array.from(i.entries()).forEach(r=>{let[o,s]=r;n.push([t,{kind:o,id:s}])});return n}createUnsubscribeMessage(t){const e=[];return t.forEach(n=>{let[i,{kind:r,id:o}]=n;switch(r){case _t.VIDEO:return void(i._videoSSRC&&e.push({stream_type:_t.VIDEO,ssrcId:i._videoSSRC}));case _t.AUDIO:return void(i._audioSSRC&&e.push({stream_type:_t.AUDIO,ssrcId:i._audioSSRC}))}}),e}withdrawRemoteTracks(t){t.forEach(e=>{let[n,{kind:i}]=e;const r=this.remoteUserMap.get(n);r&&(r.delete(i),Array.from(r.entries()).length===0&&this.remoteUserMap.delete(n))})}async updateBitrateLimit(t){const e=this.localTrackMap.get(X.LocalVideoTrack),n=this.localTrackMap.get(X.LocalVideoLowTrack);e&&await e.track.setBitrateLimit(t.uplink),n&&t.low_stream_uplink&&await n.track.setBitrateLimit({max_bitrate:t.low_stream_uplink.bitrate,min_bitrate:t.low_stream_uplink.bitrate||0})}isP2PDisconnected(){if(this.sendConnection&&this.recvConnection){const t=this.sendConnection.peerConnectionState,e=this.recvConnection.peerConnectionState;return t!=="connected"&&e!=="connected"}return!0}async tryToUnmuteAudio(t){for(let e=0;e<t.length;e++)if(t[e]instanceof Qe){const n=this.filterTobeUnmutedTracks(t[e]);if(n.length===0)continue;const i=this.createUnmuteMessage(n);return void await Ie(this,yt.RequestUnmuteLocal,i)}}bindStatsUploaderEvents(){this.statsUploader.requestStats=t=>this.getStats(t),this.statsUploader.requestLocalMedia=()=>Array.from(this.localTrackMap.entries()).filter(t=>{let[,{ssrcs:e}]=t;return!!e}),this.statsUploader.requestRemoteMedia=()=>Array.from(this.remoteUserMap.entries()),this.statsUploader.requestVideoIsReady=t=>{var e;return!((e=this.recvConnection)===null||e===void 0||!e.getRemoteVideoIsReady(t))},this.statsUploader.requestUpload=(t,e)=>this.emit(yt.RequestUpload,t,e),this.statsUploader.requestUploadStats=t=>this.emit(yt.RequestUploadStats,t),this.statsUploader.requestAllTracks=()=>this.getAllTracks()}unbindStatsUploaderEvents(){this.statsUploader.requestStats=void 0,this.statsUploader.requestLocalMedia=void 0,this.statsUploader.requestRemoteMedia=void 0,this.statsUploader.requestVideoIsReady=void 0}async requestReconnect(){this.dtlsFailedCount+=1,await wn(xp(this.dtlsFailedCount,dn)),this.emit(yt.RequestReconnect)}async reconnectP2P(){}canPublishLowStream(){return this.localTrackMap.has(X.LocalVideoTrack)||this.pendingLocalTracks.some(t=>t instanceof Ae)}throwIfTrackTypeNotMatch(t){if(t.filter(e=>e instanceof Ae).length>1)throw new G(b.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(t.filter(e=>e instanceof Qe).length>1&&(t.some(e=>e instanceof Qe&&e._bypassWebAudio)||!zt().webAudioMediaStreamDest))throw new G(b.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode");for(const e of t){if(e instanceof Ae&&this.pendingLocalTracks.some(n=>n instanceof Ae))throw new G(b.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(e instanceof Qe&&this.pendingLocalTracks.some(n=>n instanceof Qe)&&(!zt().webAudioMediaStreamDest||e._bypassWebAudio||this.pendingLocalTracks.some(n=>n instanceof Qe&&n._bypassWebAudio)))throw new G(b.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode")}}getLowVideoTrack(t,e){const n=!N("DISABLE_DUAL_STREAM_USE_ENCODING")&&zt().supportDualStreamEncoding,i=Mf(Mf({},{width:160,height:120,framerate:15,bitrate:50}),e);let r;r=n?t._mediaStreamTrack.clone():xT(t,i);const o=be(8,"track-low-"),s=new Ae(r,Mf(Mf({},n&&{scaleResolutionDownBy:pg(i,t)}),{},{frameRate:i.framerate,bitrateMax:i.bitrate,bitrateMin:i.bitrate}),void 0,void 0,o);return s.on($a.TRANSCEIVER_UPDATED,a=>{t._updateRtpTransceiver(a,vd.LOW_STREAM)}),s._hints.push(De.LOW_STREAM),t.addListener(ut.NEED_CLOSE,()=>{s.close()}),s}async globalLock(){return this.recvMutex.lock("From P2PChannel2.globalLock")}reportVideoFirstFrameDecoded(t,e,n,i){var r;const o=Array.from(Xi(r=this.remoteUserMap).call(r)).find(s=>s._videoSSRC===t);if(o){i||this.store.subscribe(o.uid,"video",void 0,void 0,void 0,void 0,Date.now());const s=this.store.keyMetrics,a=s.subscribe.find(c=>c.userId===o.uid&&c.type==="video");Et.firstRemoteVideoDecode(this.store.sessionId,Mn.FIRST_VIDEO_DECODE,He.FIRST_VIDEO_DECODE,{peer:o._uintid,videowidth:e,videoheight:n,subscribeElapse:$n.measureFromSubscribeStart(this.store.clientId,t),subscribeRequestid:t,p2pid:this.store.p2pId,apEnd:s.requestAPEnd||0,apStart:s.requestAPStart||0,joinGwEnd:s.joinGatewayEnd||0,joinGwStart:s.joinGatewayStart||0,pcEnd:s.peerConnectionEnd||0,pcStart:s.peerConnectionStart||0,subscriberEnd:(a==null?void 0:a.subscribeEnd)||0,subscriberStart:(a==null?void 0:a.subscribeStart)||0,videoAddNotify:(a==null?void 0:a.streamAdded)||0,state:i?1:0})}}async remoteMediaSsrcChanged(t,e,n){if(!this.recvConnection)return!1;const i=this.remoteUserMap.get(t);if(!i)return!1;const r=i.get(e);if(!r)return!1;const o=await this.recvConnection.getRemoteSSRC(r);return o!==void 0&&o!==n}resetConnection(t){E.debug("[".concat(this.store.clientId,"] [P2PChannel2] reset connection to ").concat(t)),this.state===he.Connected?(E.debug("[".concat(this.store.clientId,"] [P2PChannel2] fallback to websocket but P2PChannel2 state still connected, disconnect first")),this.disconnectForReconnect()):(this.sendConnection&&(this.sendConnection.close(),this.unbindConnectionEvents(this.sendConnection),this.sendConnection=void 0),this.recvConnection&&(this.recvConnection.close(),this.unbindConnectionEvents(this.recvConnection),this.recvConnection=void 0))}async publishDataChannel(t){throw new G(b.NOT_SUPPORTED)}async unpublishDataChannel(t){throw new G(b.NOT_SUPPORTED)}async subscribeDataChannel(t,e){throw new G(b.NOT_SUPPORTED)}async unsubscribeDataChannel(t,e){throw new G(b.NOT_SUPPORTED)}hasPendingRemoteDataChannel(t,e){throw new G(b.NOT_SUPPORTED)}setPendingRemoteDataChannel(t,e){throw new G(b.NOT_SUPPORTED)}async preConnect(t,e,n,i,r,o){throw new G(b.NOT_SUPPORTED)}getEstablishParams(){throw new G(b.NOT_SUPPORTED)}async reSubscribe(t){throw new G(b.NOT_SUPPORTED)}async updateVideoStreamParameter(t,e){throw new G(b.NOT_SUPPORTED)}unbindRtpTransceiver(){this.localTrackMap.size!==0&&Array.from(this.localTrackMap.entries()).forEach(t=>{let[e,{track:n}]=t;e===X.LocalVideoLowTrack?n._updateRtpTransceiver(void 0,vd.LOW_STREAM):n._updateRtpTransceiver(void 0)})}},nt(Be.prototype,"p2pConnect",[J0],Object.getOwnPropertyDescriptor(Be.prototype,"p2pConnect"),Be.prototype),nt(Be.prototype,"unpublish",[X0],Object.getOwnPropertyDescriptor(Be.prototype,"unpublish"),Be.prototype),nt(Be.prototype,"unpublishLowStream",[Q0],Object.getOwnPropertyDescriptor(Be.prototype,"unpublishLowStream"),Be.prototype),nt(Be.prototype,"subscribe",[Z0],Object.getOwnPropertyDescriptor(Be.prototype,"subscribe"),Be.prototype),nt(Be.prototype,"mockSubscribe",[$0],Object.getOwnPropertyDescriptor(Be.prototype,"mockSubscribe"),Be.prototype),nt(Be.prototype,"unsubscribe",[tN],Object.getOwnPropertyDescriptor(Be.prototype,"unsubscribe"),Be.prototype),nt(Be.prototype,"muteRemote",[eN],Object.getOwnPropertyDescriptor(Be.prototype,"muteRemote"),Be.prototype),nt(Be.prototype,"unmuteRemote",[nN],Object.getOwnPropertyDescriptor(Be.prototype,"unmuteRemote"),Be.prototype),nt(Be.prototype,"hasRemoteMediaWithLock",[iN],Object.getOwnPropertyDescriptor(Be.prototype,"hasRemoteMediaWithLock"),Be.prototype),nt(Be.prototype,"disconnectForReconnect",[rN],Object.getOwnPropertyDescriptor(Be.prototype,"disconnectForReconnect"),Be.prototype),nt(Be.prototype,"remoteMediaSsrcChanged",[oN],Object.getOwnPropertyDescriptor(Be.prototype,"remoteMediaSsrcChanged"),Be.prototype),Be);function mo(t){return function(e,n,i){const r=e[n];if(typeof r!="function")throw new Error("Cannot use mutex on object property.");return i.value=async function(){for(var o=arguments.length,s=new Array(o),a=0;a<o;a++)s[a]=arguments[a];switch(t){case Eo.SEND_ONLY:{const c=await this.sendMutex.lock("From P2PChannel2.".concat(n));try{return await r.apply(this,s)}finally{c()}}case Eo.RECEIVE_ONLY:{const c=await this.recvMutex.lock("From P2PChannel2.".concat(n));try{return await r.apply(this,s)}finally{c()}}default:{const c=await this.sendMutex.lock("From P2PChannel2.".concat(n)),d=await this.recvMutex.lock("From P2PChannel2.".concat(n));try{return await r.apply(this,s)}finally{c(),d()}}}},i}}function aN(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),n.push.apply(n,i)}return n}function ac(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?aN(Object(n),!0).forEach(function(i){R(t,i,n[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):aN(Object(n)).forEach(function(i){Object.defineProperty(t,i,Object.getOwnPropertyDescriptor(n,i))})}return t}class Pl{constructor(e){R(this,"store",void 0),R(this,"onStatsException",void 0),R(this,"onUploadPublishDuration",void 0),R(this,"onStatsChanged",void 0),R(this,"localStats",new Map),R(this,"remoteStats",new Map),R(this,"updateStatsInterval",void 0),R(this,"trafficStats",void 0),R(this,"trafficStatsPeerList",[]),R(this,"uplinkStats",void 0),R(this,"exceptionMonitor",void 0),R(this,"p2pChannel",void 0),R(this,"scalabilityMode",Vj.L1T1),R(this,"updateStats",()=>{this.p2pChannel&&(this.updateRemoteStats(this.p2pChannel),this.updateLocalStats(this.p2pChannel))}),this.store=e,this.exceptionMonitor=new jW,this.exceptionMonitor.on("exception",(n,i,r)=>{this.onStatsException&&this.onStatsException(n,i,r)})}startUpdateStats(){this.updateStatsInterval||(this.updateStatsInterval=window.setInterval(this.updateStats,1e3))}stopUpdateStats(){this.updateStatsInterval&&(window.clearInterval(this.updateStatsInterval),this.updateStatsInterval=void 0)}reset(){this.localStats=new Map,this.remoteStats=new Map,this.trafficStats=void 0,this.trafficStatsPeerList=[],this.uplinkStats=void 0}getLocalAudioTrackStats(){return this.localStats.get(X.LocalAudioTrack)||ac({},fT)}getLocalVideoTrackStats(){return this.localStats.get(X.LocalVideoTrack)||ac({},_T)}getRemoteAudioTrackStats(e){const n=(o,s)=>{if(!this.trafficStats)return s;const a=this.trafficStats.peer_delay.find(c=>c.peer_uid===o);return a&&(s.publishDuration=a.B_ppad+(Date.now()-this.trafficStats.timestamp)),s},i={};if(e){var r;const o=(r=this.remoteStats.get(e))===null||r===void 0?void 0:r.audioStats;o&&(i[e]=n(e,o))}else Array.from(this.remoteStats.entries()).forEach(o=>{let[s,{audioStats:a}]=o;a&&(i[s]=n(s,a))});return i}getRemoteNetworkQualityStats(e){const n={};if(e){var i;const r=(i=this.remoteStats.get(e))===null||i===void 0?void 0:i.networkStats;r&&(n[e]=r)}else Array.from(this.remoteStats.entries()).forEach(r=>{let[o,{networkStats:s}]=r;s&&(n[o]=s)});return n}getRemoteVideoTrackStats(e){const n=(o,s)=>{if(!this.trafficStats)return s;const a=this.trafficStats.peer_delay.find(c=>c.peer_uid===o);return a&&(s.publishDuration=a.B_ppvd+(Date.now()-this.trafficStats.timestamp)),s},i={};if(e){var r;const o=(r=this.remoteStats.get(e))===null||r===void 0?void 0:r.videoStats;o&&(i[e]=n(e,o))}else Array.from(this.remoteStats.entries()).forEach(o=>{let[s,{videoStats:a}]=o;a&&(i[s]=n(s,a))});return i}getRTCStats(){let e=0,n=0,i=0,r=0;const o=this.localStats.get(X.LocalAudioTrack);o&&(e+=o.sendBytes,n+=o.sendBitrate);const s=this.localStats.get(X.LocalVideoTrack);s&&(e+=s.sendBytes,n+=s.sendBitrate);const a=this.localStats.get(X.LocalVideoLowTrack);a&&(e+=a.sendBytes,n+=a.sendBitrate),this.remoteStats.forEach(d=>{let{audioStats:u,videoStats:l}=d;u&&(i+=u.receiveBytes,r+=u.receiveBitrate),l&&(i+=l.receiveBytes,r+=l.receiveBitrate)});let c=1;return this.trafficStats&&(c+=this.trafficStats.peer_delay.length),{Duration:0,UserCount:c,SendBitrate:n,SendBytes:e,RecvBytes:i,RecvBitrate:r,OutgoingAvailableBandwidth:this.uplinkStats?this.uplinkStats.B_uab/1e3:0,RTT:this.trafficStats?2*this.trafficStats.B_acd:0}}addLocalStats(e){this.localStats.set(e,void 0)}removeLocalStats(e){e?this.localStats.delete(e):this.localStats.clear()}addRemoteStats(e){this.remoteStats.set(e,{})}removeRemoteStats(e){e?this.remoteStats.delete(e):this.remoteStats.clear()}addP2PChannel(e){this.p2pChannel=e}updateTrafficStats(e){e.peer_delay=e.peer_delay.filter(n=>n.B_ppad!==void 0||n.B_ppvd!==void 0),e.peer_delay.filter(n=>this.trafficStatsPeerList.indexOf(n.peer_uid)===-1).forEach(n=>{var i;const r=(i=this.p2pChannel)===null||i===void 0?void 0:i.getRemoteMedia(n.peer_uid),o=r!=null&&r.videoSSRC?$n.measureFromSubscribeStart(this.store.clientId,r.videoSSRC):0,s=r!=null&&r.audioSSRC?$n.measureFromSubscribeStart(this.store.clientId,r.audioSSRC):0;n.B_ppad!==void 0&&n.B_ppvd!==void 0&&(this.onUploadPublishDuration&&this.onUploadPublishDuration(n.peer_uid,n.B_ppad,n.B_ppvd,o>s?o:s),this.trafficStatsPeerList.push(n.peer_uid))}),this.trafficStats=e}updateUplinkStats(e){this.uplinkStats&&this.uplinkStats.B_fir!==e.B_fir&&E.debug("[".concat(this.store.clientId,"]: Period fir changes to ").concat(e.B_fir)),this.uplinkStats=e}static isRemoteVideoFreeze(e,n,i){if(!e)return!1;const r=!!i&&n.framesDecodeFreezeTime>i.framesDecodeFreezeTime,o=!i||n.framesDecodeCount>i.framesDecodeCount;return r||!o}static isRemoteAudioFreeze(e){return!!e&&e._isFreeze()}isLocalVideoFreeze(e){return!(!e.inputFrame||!e.sentFrame)&&e.inputFrame.frameRate>5&&e.sentFrame.frameRate<3}updateLocalStats(e){Array.from(this.localStats.entries()).forEach(n=>{let[i,r]=n;switch(i){case X.LocalVideoTrack:case X.LocalVideoLowTrack:{const s=r,a=ac({},_T),c=e.getStats(),d=e.getLocalMedia(i);if(c){const u=c.videoSend.find(l=>l.ssrc===(d==null?void 0:d.ssrcs[0].ssrcId));if(u){const l=e.getLocalVideoSize(),p=e.getEncoderConfig(X.LocalVideoTrack);u.codec!=="H264"&&u.codec!=="H265"&&u.codec!=="VP8"&&u.codec!=="VP9"&&u.codec!=="AV1X"&&u.codec!=="AV1"||(a.codecType=u.codec),a.sendBytes=u.bytes,a.sendBitrate=s?8*Math.max(0,a.sendBytes-s.sendBytes):0,u.inputFrame?(a.captureFrameRate=u.inputFrame.frameRate,a.captureResolutionHeight=u.inputFrame.height,a.captureResolutionWidth=u.inputFrame.width):l&&(a.captureResolutionWidth=l.width,a.captureResolutionHeight=l.height),u.sentFrame?(a.sendFrameRate=u.sentFrame.frameRate,a.sendResolutionHeight=u.sentFrame.height,a.sendResolutionWidth=u.sentFrame.width):l&&(a.sendResolutionWidth=l.width,a.sendResolutionHeight=l.height),u.avgEncodeMs&&(a.encodeDelay=u.avgEncodeMs),p&&p.bitrateMax&&(a.targetSendBitrate=1e3*p.bitrateMax),a.sendPackets=u.packets,a.sendPacketsLost=u.packetsLost,a.sendJitterMs=u.jitterMs,a.sendRttMs=u.rttMs,a.totalDuration=s?s.totalDuration+1:1,a.totalFreezeTime=s?s.totalFreezeTime:0,this.isLocalVideoFreeze(u)&&(a.totalFreezeTime+=1),u.scalabilityMode&&this.scalabilityMode!==u.scalabilityMode&&(E.debug("[".concat(this.store.clientId,"]: The scalabilityMode of the video sending stream is ").concat(u.scalabilityMode)),this.scalabilityMode=u.scalabilityMode)}this.trafficStats&&(a.currentPacketLossRate=(this.trafficStats.B_pvlr4||0)/100)}var o;this.localStats.set(i,a),((s==null?void 0:s.sendResolutionWidth)!==a.sendResolutionWidth||(s==null?void 0:s.sendResolutionHeight)!==a.sendResolutionHeight)&&((o=this.onStatsChanged)===null||o===void 0||o.call(this,"resolution",{width:a.sendResolutionWidth,height:a.sendResolutionHeight})),a&&d&&this.exceptionMonitor.setLocalVideoStats(this.store.uid,d.track,a);break}case X.LocalAudioTrack:{const s=r,a=ac({},fT),c=e.getStats(),d=e.getLocalMedia(i);if(c){const u=c.audioSend.find(l=>l.ssrc===(d==null?void 0:d.ssrcs[0].ssrcId));if(u){if(u.codec!=="opus"&&u.codec!=="aac"&&u.codec!=="PCMU"&&u.codec!=="PCMA"&&u.codec!=="G722"||(a.codecType=u.codec),u.inputLevel)a.sendVolumeLevel=Math.round(32767*u.inputLevel);else{const l=e.getLocalAudioVolume();l&&(a.sendVolumeLevel=Math.round(32767*l))}a.sendBytes=u.bytes,a.sendPackets=u.packets,a.sendPacketsLost=u.packetsLost,a.sendJitterMs=u.jitterMs,a.sendRttMs=u.rttMs,a.sendBitrate=s?8*Math.max(0,a.sendBytes-s.sendBytes):0}}this.trafficStats&&(a.currentPacketLossRate=(this.trafficStats.B_palr4||0)/100),this.localStats.set(X.LocalAudioTrack,a),a&&d&&this.exceptionMonitor.setLocalAudioStats(this.store.uid,d.track,a);break}}})}updateRemoteStats(e){Array.from(this.remoteStats.entries()).forEach(n=>{var i,r;let[o,{videoStats:s,audioStats:a,videoPcStats:c}]=n;const d=a,u=s,l=c,p=ac({},Sw),f=ac({},Rw),C=ac({},wW),{audioTrack:m,videoTrack:g,audioSSRC:y,videoSSRC:A}=e.getRemoteMedia(o);let k;k=e instanceof Ki?e.getStats(!0):e.getStats();const M=(i=k)===null||i===void 0?void 0:i.audioRecv.find(K=>K.ssrc===y),V=(r=k)===null||r===void 0?void 0:r.videoRecv.find(K=>K.ssrc===A),B=this.trafficStats&&this.trafficStats.peer_delay.find(K=>K.peer_uid===o);if(M&&(M.codec!=="opus"&&M.codec!=="aac"&&M.codec!=="PCMU"&&M.codec!=="PCMA"&&M.codec!=="G722"||(p.codecType=M.codec),M.outputLevel?p.receiveLevel=Math.round(32767*M.outputLevel):m&&(p.receiveLevel=Math.round(32767*m.getVolumeLevel())),p.receiveBytes=M.bytes,p.receivePackets=M.packets,p.receivePacketsLost=M.packetsLost,p.packetLossRate=p.receivePacketsLost/(p.receivePackets+p.receivePacketsLost),p.receiveBitrate=d?8*Math.max(0,p.receiveBytes-d.receiveBytes):0,p.totalDuration=d?d.totalDuration+1:1,p.totalFreezeTime=d?d.totalFreezeTime:0,p.freezeRate=p.totalFreezeTime/p.totalDuration,p.receiveDelay=M.jitterBufferMs,p.totalDuration>10&&Pl.isRemoteAudioFreeze(m)&&(p.totalFreezeTime+=1)),V){V.codec!=="H264"&&V.codec!=="H265"&&V.codec!=="VP8"&&V.codec!=="VP9"&&V.codec!=="AV1X"&&V.codec!=="AV1"||(f.codecType=V.codec),f.receiveBytes=V.bytes,f.receiveBitrate=u?8*Math.max(0,f.receiveBytes-u.receiveBytes):0,f.decodeFrameRate=V.decodeFrameRate<0?0:V.decodeFrameRate,f.renderFrameRate=V.decodeFrameRate<0?0:V.decodeFrameRate,V.outputFrame&&(f.renderFrameRate=V.outputFrame.frameRate),V.receivedFrame?(f.receiveFrameRate=V.receivedFrame.frameRate,f.receiveResolutionHeight=V.receivedFrame.height,f.receiveResolutionWidth=V.receivedFrame.width):g&&(f.receiveResolutionHeight=g._videoHeight||0,f.receiveResolutionWidth=g._videoWidth||0),V.framesRateFirefox!==void 0&&(f.receiveFrameRate=Math.round(V.framesRateFirefox)),f.receivePackets=V.packets,f.receivePacketsLost=V.packetsLost,f.packetLossRate=f.receivePacketsLost/(f.receivePackets+f.receivePacketsLost),f.totalDuration=u?u.totalDuration+1:1,f.totalFreezeTime=u?u.totalFreezeTime:0,f.receiveDelay=V.jitterBufferMs||0;const K=!!A&&e.getRemoteVideoIsReady(A);g&&K&&Pl.isRemoteVideoFreeze(g,V,l)&&(f.totalFreezeTime+=1),f.freezeRate=f.totalFreezeTime/f.totalDuration}B&&(p.end2EndDelay=B.B_ad,f.end2EndDelay=B.B_vd,p.transportDelay=B.B_ed,f.transportDelay=B.B_ed,p.currentPacketLossRate=B.B_ealr4/100,f.currentPacketLossRate=B.B_evlr4/100,C.uplinkNetworkQuality=B.B_punq?B.B_punq:0,C.downlinkNetworkQuality=B.B_pdnq?B.B_pdnq:0),this.remoteStats.set(o,{audioStats:p,videoStats:f,videoPcStats:V,networkStats:C}),m&&this.exceptionMonitor.setRemoteAudioStats(m,p),g&&this.exceptionMonitor.setRemoteVideoStats(g,f)})}}function cN(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),n.push.apply(n,i)}return n}function Ll(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?cN(Object(n),!0).forEach(function(i){R(t,i,n[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):cN(Object(n)).forEach(function(i){Object.defineProperty(t,i,Object.getOwnPropertyDescriptor(n,i))})}return t}class o3 extends Ve{constructor(e,n,i,r){super(),R(this,"spec",void 0),R(this,"token",void 0),R(this,"websocket",void 0),R(this,"pingpongTimer",void 0),R(this,"reconnectMode","retry"),R(this,"serviceMode",void 0),R(this,"reqId",0),R(this,"commandReqId",0),R(this,"handleWebSocketOpen",()=>{this.reconnectMode="retry",this.startPingPong()}),R(this,"handleWebSocketMessage",o=>{if(!o.data)return;const s=JSON.parse(o.data);s.requestId?this.emit("@".concat(s.requestId,"-").concat(s.sid),s):this.serviceMode===Un.INJECT?this.emit(xo.INJECT_STREAM_STATUS,s):(Et.workerEvent(this.spec.sid,{actionType:"status",serverCode:s.code,workerType:this.serviceMode===Un.TRANSCODE?1:2}),this.emit(xo.PUBLISH_STREAM_STATUS,s))}),this.spec=n,this.token=e,this.serviceMode=r,this.websocket=new tl("live-streaming",i),this.websocket.on(It.CONNECTED,this.handleWebSocketOpen),this.websocket.on(It.ON_MESSAGE,this.handleWebSocketMessage),this.websocket.on(It.REQUEST_NEW_URLS,(o,s)=>{En(this,xo.REQUEST_NEW_ADDRESS).then(o).catch(s)}),this.websocket.on(It.RECONNECTING,()=>{this.websocket.reconnectMode=this.reconnectMode})}init(e){return this.websocket.init(e)}async request(e,n,i,r){this.reqId+=1,e==="request"&&(this.commandReqId+=1);const o=this.commandReqId,s=this.reqId;if(!s||!this.websocket)throw new U(b.UNEXPECTED_ERROR);const a=Ll({command:e,sdkVersion:pr==="4.21.0"?"0.0.1":pr,seq:s,requestId:s,allocate:i,cname:this.spec.cname,appId:this.spec.appId,sid:this.spec.sid,uid:this.spec.uid.toString(),ts:Math.floor(Date.now()/1e3)},n);if(this.websocket.state==="closed")throw new U(b.WS_DISCONNECT);const c=()=>new ot((p,f)=>{this.websocket.once(It.CLOSED,()=>f(new U(b.WS_ABORT))),this.websocket.once(It.CONNECTED,p)});this.websocket.state!=="connected"&&await c(),a.clientRequest&&(a.clientRequest.workerToken=this.token);const d=new ot((p,f)=>{const C=()=>{f(new U(b.WS_ABORT))};this.websocket.once(It.RECONNECTING,C),this.websocket.once(It.CLOSED,C),this.once("@".concat(s,"-").concat(this.spec.sid),m=>{p(m)})});r&&Et.workerEvent(this.spec.sid,Ll(Ll({},r),{},{requestId:o,actionType:"request",payload:JSON.stringify(n.clientRequest),serverCode:0,code:0}));const u=Date.now();this.websocket.sendMessage(a);let l=null;try{l=await d}catch(p){if(this.websocket.state==="closed")throw p;return await c(),await this.request(e,n,i)}return r&&Et.workerEvent(this.spec.sid,Ll(Ll({},r),{},{requestId:o,actionType:"response",payload:JSON.stringify(l.serverResponse),serverCode:l.code,success:l.code===200,responseTime:Date.now()-u})),l.code!==200&&this.handleResponseError(l),l}tryNextAddress(){this.reconnectMode="tryNext",this.websocket.reconnect("tryNext")}close(){const e=pr==="4.21.0"?"0.0.1":pr;this.reqId+=1,this.websocket.state==="connected"?(this.websocket.sendMessage({command:"request",appId:this.spec.appId,cname:this.spec.cname,uid:this.spec.uid.toString(),sdkVersion:e,sid:this.spec.sid,seq:this.reqId,ts:Math.floor(Date.now()/1e3),requestId:this.reqId,clientRequest:{command:"DestroyWorker"}}),this.websocket.close(!1,!0)):this.websocket.close(!1),this.pingpongTimer&&(window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0)}handleResponseError(e){switch(e.code){case Cn.LIVE_STREAM_RESPONSE_ALREADY_EXISTS_STREAM:return void E.warning("live stream response already exists stream");case Cn.LIVE_STREAM_RESPONSE_TRANSCODING_PARAMETER_ERROR:case Cn.LIVE_STREAM_RESPONSE_BAD_STREAM:case Cn.LIVE_STREAM_RESPONSE_WM_PARAMETER_ERROR:return new U(b.LIVE_STREAMING_INVALID_ARGUMENT,"",{code:e.code}).throw();case Cn.LIVE_STREAM_RESPONSE_WM_WORKER_NOT_EXIST:if(e.serverResponse.command==="UnpublishStream"||e.serverResponse.command==="UninjectStream")return;throw new U(b.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"live stream response wm worker not exist",{retry:!0});case Cn.LIVE_STREAM_RESPONSE_NOT_AUTHORIZED:return new U(b.LIVE_STREAMING_PUBLISH_STREAM_NOT_AUTHORIZED,"",{code:e.code}).throw();case Cn.LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE:{const n=new U(b.LIVE_STREAMING_WARN_FAILED_LOAD_IMAGE);return this.emit(xo.WARNING,n,e.serverResponse.url)}case Cn.LIVE_STREAM_RESPONSE_REQUEST_TOO_OFTEN:{const n=new U(b.LIVE_STREAMING_WARN_FREQUENT_REQUEST);return this.emit(xo.WARNING,n,e.serverResponse.url)}case Cn.LIVE_STREAM_RESPONSE_NOT_FOUND_PUBLISH:throw new U(b.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"live stream response wm worker not exist",{retry:!0});case Cn.LIVE_STREAM_RESPONSE_NOT_SUPPORTED:return new U(b.LIVE_STREAMING_TRANSCODING_NOT_SUPPORTED,"",{code:e.code}).throw();case Cn.LIVE_STREAM_RESPONSE_MAX_STREAM_NUM:{const n=new U(b.LIVE_STREAMING_WARN_STREAM_NUM_REACH_LIMIT);return this.emit(xo.WARNING,n,e.serverResponse.url)}case Cn.LIVE_STREAM_RESPONSE_INTERNAL_SERVER_ERROR:return new U(b.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"",{code:e.code}).throw();case Cn.LIVE_STREAM_RESPONSE_RESOURCE_LIMIT:throw new U(b.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"live stream resource limit",{retry:!0,changeAddress:!0});case Cn.LIVE_STREAM_RESPONSE_WORKER_LOST:case Cn.LIVE_STREAM_RESPONSE_WORKER_QUIT:if(e.serverResponse.command==="UnpublishStream"||e.serverResponse.command==="UninjectStream")return;throw new U(b.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"error fail send message",{retry:!0,changeAddress:!0});case Cn.ERROR_FAIL_SEND_MESSAGE:if(e.serverResponse.command==="UnpublishStream"||e.serverResponse.command==="UninjectStream")return;if(e.serverResponse.command==="UpdateTranscoding"||e.serverResponse.command==="ControlStream")return new U(b.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"error fail send message",{code:e.code}).throw();throw new U(b.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"error fail send message",{retry:!0,changeAddress:!0});case Cn.PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN:case Cn.PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT:case Cn.PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE:case Cn.PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH:return new U(b.LIVE_STREAMING_CDN_ERROR,"",{code:e.code}).throw()}}startPingPong(){this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(()=>{this.websocket.state==="connected"&&this.request("ping",{}).catch(Mp)},6e3)}}function dN(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),n.push.apply(n,i)}return n}function Ai(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?dN(Object(n),!0).forEach(function(i){R(t,i,n[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):dN(Object(n)).forEach(function(i){Object.defineProperty(t,i,Object.getOwnPropertyDescriptor(n,i))})}return t}class s3 extends Ve{constructor(e){let n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:dn,i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:dn;super(),R(this,"onLiveStreamWarning",void 0),R(this,"onLiveStreamError",void 0),R(this,"onInjectStatusChange",void 0),R(this,"spec",void 0),R(this,"retryTimeout",1e4),R(this,"connection",void 0),R(this,"httpRetryConfig",void 0),R(this,"wsRetryConfig",void 0),R(this,"streamingTasks",new Map),R(this,"isStartingStreamingTask",!1),R(this,"taskMutex",new kn("live-streaming")),R(this,"cancelToken",yi.CancelToken.source()),R(this,"transcodingConfig",void 0),R(this,"injectConfig",Ai({},Bj)),R(this,"injectLoopTimes",0),R(this,"uapResponse",void 0),R(this,"lastTaskId",1),R(this,"statusError",new Map),this.spec=e,this.httpRetryConfig=i,this.wsRetryConfig=n}async setTranscodingConfig(e){const n=Ai(Ai({},jj),e);n.videoCodecProfile!==66&&n.videoCodecProfile!==77&&n.videoCodecProfile!==100&&(E.debug("[".concat(this.spec.clientId,"] set transcoding config, fix video codec profile: ").concat(n.videoCodecProfile," -> 100")),n.videoCodecProfile=100),n.transcodingUsers||(n.transcodingUsers=n.userConfigs),n.transcodingUsers&&(n.transcodingUsers=n.transcodingUsers.map(s=>Ai(Ai(Ai({},Fj),s),{},{zOrder:s.zOrder?s.zOrder+1:1}))),function(s){ze(s.width)||Se(s.width,"config.width",0,1e4),ze(s.height)||Se(s.height,"config.height",0,1e4),ze(s.videoBitrate)||Se(s.videoBitrate,"config.videoBitrate",1,1e6),ze(s.videoFrameRate)||Se(s.videoFrameRate,"config.videoFrameRate"),ze(s.lowLatency)||hs(s.lowLatency,"config.lowLatency"),ze(s.audioSampleRate)||yn(s.audioSampleRate,"config.audioSampleRate",[32e3,44100,48e3]),ze(s.audioBitrate)||Se(s.audioBitrate,"config.audioBitrate",1,128),ze(s.audioChannels)||yn(s.audioChannels,"config.audioChannels",[1,2,3,4,5]),ze(s.videoGop)||Se(s.videoGop,"config.videoGop"),ze(s.videoCodecProfile)||yn(s.videoCodecProfile,"config.videoCodecProfile",[66,77,100]),ze(s.userCount)||Se(s.userCount,"config.userCount",0,17),ze(s.backgroundColor)||Se(s.backgroundColor,"config.backgroundColor",0,16777215),ze(s.userConfigExtraInfo)||Fn(s.userConfigExtraInfo,"config.userConfigExtraInfo",0,4096,!1),s.transcodingUsers&&!ze(s.transcodingUsers)&&(ps(s.transcodingUsers,"config.transcodingUsers"),s.transcodingUsers.forEach((a,c)=>{Wp(a.uid),ze(a.x)||Se(a.x,"transcodingUser[".concat(c,"].x"),0,1e4),ze(a.y)||Se(a.y,"transcodingUser[".concat(c,"].y"),0,1e4),ze(a.width)||Se(a.width,"transcodingUser[".concat(c,"].width"),0,1e4),ze(a.height)||Se(a.height,"transcodingUser[".concat(c,"].height"),0,1e4),ze(a.zOrder)||Se(a.zOrder-1,"transcodingUser[".concat(c,"].zOrder"),0,100),ze(a.alpha)||Se(a.alpha,"transcodingUser[".concat(c,"].alpha"),0,1,!1)})),ze(s.watermark)||dg(s.watermark,"watermark"),ze(s.backgroundImage)||dg(s.backgroundImage,"backgroundImage"),s.images&&!ze(s.images)&&(ps(s.images,"config.images"),s.images.forEach((a,c)=>{dg(a,"images[".concat(c,"]"))}))}(n);const i=[];n.images&&i.push(...n.images.map(s=>Ai(Ai(Ai({},cg),s),{},{zOrder:255}))),n.backgroundImage&&(i.push(Ai(Ai(Ai({},cg),n.backgroundImage),{},{zOrder:0})),delete n.backgroundImage),n.watermark&&(i.push(Ai(Ai(Ai({},cg),n.watermark),{},{zOrder:255})),delete n.watermark),n.images=i,n.transcodingUsers&&(n.userConfigs=n.transcodingUsers.map(s=>Ai({},s)),n.userCount=n.transcodingUsers.length,delete n.transcodingUsers);const r=(n.userConfigs||[]).map(s=>typeof s.uid=="number"?ot.resolve(s.uid):Yb(s.uid,this.spec,this.cancelToken.token,this.httpRetryConfig));if((await ot.all(r)).forEach((s,a)=>{n.userConfigs&&n.userConfigs[a]&&(n.userConfigs[a].uid=s)}),this.transcodingConfig=n,this.connection)try{var o;const s=await this.connection.request("request",{clientRequest:{command:"UpdateTranscoding",transcodingConfig:this.transcodingConfig}},!1,{command:"UpdateTranscoding",workerType:1,requestByUser:!0,tid:Array.from(ao(o=this.streamingTasks).call(o)).map(a=>a.taskId).join("#")});E.debug("[".concat(this.spec.clientId,"] update live transcoding config success, code: ").concat(s.code,", config:"),JSON.stringify(this.transcodingConfig))}catch(s){if(!s.data||!s.data.retry)throw s;s.data.changeAddress&&this.connection.tryNextAddress(),this.streamingTasks.forEach(a=>{E.warning("[".concat(this.spec.clientId,"] live streaming receive error"),s.toString(),"try to republish",a.url),this.startLiveStreamingTask(a.url,a.mode,s).then(()=>{E.debug("[".concat(this.spec.clientId,"] live streaming republish ").concat(a.url," success"))}).catch(c=>{E.error("[".concat(this.spec.clientId,"] live streaming republish failed"),a.url,c.toString()),this.onLiveStreamError&&this.onLiveStreamError(a.url,c)})})}}setInjectStreamConfig(e,n){this.injectConfig=Object.assign({},this.injectConfig,e),this.injectLoopTimes=n}async startLiveStreamingTask(e,n,i){var r;if(Array.from(ao(r=this.streamingTasks).call(r)).find(d=>d.mode===Un.INJECT)&&n===Un.INJECT)return new U(b.LIVE_STREAMING_TASK_CONFLICT,"inject stream over limit").throw();if(!this.transcodingConfig&&n===Un.TRANSCODE)throw new U(b.INVALID_OPERATION,"[LiveStreaming] no transcoding config found, can not start transcoding streaming task");let s={command:"PublishStream",ts:Date.now(),url:e,uid:this.spec.uid.toString(),autoDestroyTime:100,acceptImageTimeout:!0};E.debug("[".concat(this.spec.clientId,"] start live streaming ").concat(e,", mode: ").concat(n));const a=await this.taskMutex.lock();if(!this.connection&&i)return void a();if(this.streamingTasks.get(e)&&!i)return a(),new U(b.LIVE_STREAMING_TASK_CONFLICT).throw();try{this.connection||(this.connection=await this.connect(n))}catch(d){throw a(),d}switch(n){case Un.TRANSCODE:s.transcodingConfig=Ai({},this.transcodingConfig);break;case Un.RAW:break;case Un.INJECT:s={cname:this.spec.cname,command:"InjectStream",sid:this.spec.sid,transcodingConfig:this.injectConfig,ts:Date.now(),url:e,loopTimes:this.injectLoopTimes}}this.uapResponse&&this.uapResponse.vid&&(s.vid=this.uapResponse.vid),this.isStartingStreamingTask=!0;const c=this.lastTaskId++;try{const d=new ot((l,p)=>{wn(this.retryTimeout).then(()=>{if(i)return p(i);const f=this.statusError.get(e);return f?(this.statusError.delete(e),p(f)):void 0})}),u=await ot.race([this.connection.request("request",{clientRequest:s},!0,{url:e,command:"PublishStream",workerType:n===Un.TRANSCODE?1:2,requestByUser:!i,tid:c.toString()}),d]);this.isStartingStreamingTask=!1,E.debug("[".concat(this.spec.clientId,"] live streaming started, code: ").concat(u.code)),this.streamingTasks.set(e,{clientRequest:s,mode:n,url:e,taskId:c}),a()}catch(d){if(a(),this.isStartingStreamingTask=!1,!d.data||!d.data.retry||i)throw d;return d.data.changeAddress?(this.connection.tryNextAddress(),await this.startLiveStreamingTask(e,n,d)):await this.startLiveStreamingTask(e,n,d)}}stopLiveStreamingTask(e){return new ot((n,i)=>{const r=this.streamingTasks.get(e);if(!r||!this.connection)return new U(b.UNEXPECTED_ERROR,"can not find streaming task to stop").throw();const o=r.mode;r.abortTask=()=>{E.debug("[".concat(this.spec.clientId,"] stop live streaming success(worker exception)")),this.streamingTasks.delete(e),n()},this.connection.request("request",{clientRequest:{command:o===Un.INJECT?"UninjectStream":"UnpublishStream",url:r.url}},!1,{url:e,command:"UnPublishStream",workerType:o===Un.TRANSCODE?1:2,requestByUser:!0,tid:(this.lastTaskId++).toString()}).then(s=>{E.debug("[".concat(this.spec.clientId,"] stop live streaming success, code: ").concat(s.code)),this.streamingTasks.delete(e),this.streamingTasks.size===0&&o!==Un.INJECT&&(this.connection&&this.connection.close(),this.connection=void 0),n(),o===Un.INJECT&&this.onInjectStatusChange&&this.onInjectStatusChange(id.INJECT_STREAM_STATUS_STOP_SUCCESS,this.spec.uid,e)}).catch(i)})}async controlInjectStream(e,n,i,r){const o=this.streamingTasks.get(e);if(!o||!this.connection||o.mode!==Un.INJECT)throw new U(b.INVALID_OPERATION,"can not find inject stream task to control");return(await this.connection.request("request",{clientRequest:{command:"ControlStream",url:e,control:n,audioVolume:i,position:r}})).serverResponse}resetAllTask(){var e;const n=Array.from(ao(e=this.streamingTasks).call(e));this.terminate();for(const i of n)this.startLiveStreamingTask(i.url,i.mode).catch(r=>{this.onLiveStreamError&&this.onLiveStreamError(i.url,r)})}terminate(){this.cancelToken&&this.cancelToken.cancel(),this.streamingTasks=new Map,this.isStartingStreamingTask=!1,this.statusError=new Map,this.cancelToken=yi.CancelToken.source(),this.uapResponse=void 0,this.connection&&this.connection.close(),this.connection=void 0}async connect(e){if(this.connection)throw new U(b.UNEXPECTED_ERROR,"live streaming connection has already connected");const n=await En(this,Hp.REQUEST_WORKER_MANAGER_LIST,e);return this.uapResponse=n,this.connection=new o3(n.workerToken,this.spec,this.wsRetryConfig,e),this.connection.on(xo.WARNING,(i,r)=>this.onLiveStreamWarning&&this.onLiveStreamWarning(r,i)),this.connection.on(xo.PUBLISH_STREAM_STATUS,i=>this.handlePublishStreamServer(i)),this.connection.on(xo.INJECT_STREAM_STATUS,i=>this.handleInjectStreamServerStatus(i)),this.connection.on(xo.REQUEST_NEW_ADDRESS,(i,r)=>{if(!this.connection)return r(new U(b.UNEXPECTED_ERROR,"can not get new live streaming address list"));En(this,Hp.REQUEST_WORKER_MANAGER_LIST,e).then(o=>{this.uapResponse=o,i(o.addressList)}).catch(r)}),await this.connection.init(n.addressList),this.connection}handlePublishStreamServer(e){const n=e.serverStatus&&e.serverStatus.url||"empty_url",i=this.streamingTasks.get(n),r=e.reason;switch(e.code){case Cn.PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN:case Cn.PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT:case Cn.PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE:case Cn.PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH:{const s=new U(b.LIVE_STREAMING_CDN_ERROR,"",{code:e.code});if(i)return E.error(s.toString()),this.onLiveStreamError&&this.onLiveStreamError(n,s);if(!this.isStartingStreamingTask)return;this.statusError.set(n,s)}case Cn.LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE:{const s=new U(b.LIVE_STREAMING_WARN_FAILED_LOAD_IMAGE,r);return this.onLiveStreamWarning&&this.onLiveStreamWarning(n,s)}case Cn.LIVE_STREAM_RESPONSE_WORKER_LOST:case Cn.LIVE_STREAM_RESPONSE_WORKER_QUIT:{var o;if(!this.connection)return;this.connection.tryNextAddress();const s=Array.from(ao(o=this.streamingTasks).call(o));for(const a of s)a.abortTask?a.abortTask():(E.warning("[".concat(this.spec.clientId,"] publish stream status code"),e.code,"try to republish",a.url),this.startLiveStreamingTask(a.url,a.mode,new U(b.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"",{code:e.code})).then(()=>{E.debug("[".concat(this.spec.clientId,"] republish live stream success"),a.url)}).catch(c=>{E.error(c.toString()),this.onLiveStreamError&&this.onLiveStreamError(a.url,c)}));return}}}handleInjectStreamServerStatus(e){const n=Number(e.uid),i=e.serverStatus&&e.serverStatus.url;switch(e.code){case 200:return void(this.onInjectStatusChange&&this.onInjectStatusChange(id.INJECT_STREAM_STATUS_START_SUCCESS,n,i));case 451:return this.onInjectStatusChange&&this.onInjectStatusChange(id.INJECT_STREAM_STATUS_START_ALREADY_EXISTS,n,i),void this.streamingTasks.delete(i);case 453:return this.onInjectStatusChange&&this.onInjectStatusChange(id.INJECT_STREAM_STATUS_START_UNAUTHORIZED,n,i),void this.streamingTasks.delete(i);case 470:return this.onInjectStatusChange&&this.onInjectStatusChange(id.INJECT_STREAM_STATUS_BROKEN,n,i),void this.streamingTasks.delete(i);case 499:return this.onInjectStatusChange&&this.onInjectStatusChange(id.INJECT_STREAM_STATUS_START_TIMEOUT,n,i),void this.streamingTasks.delete(i);default:return void E.debug("inject stream server status",e)}}hasUrl(e){return this.streamingTasks.has(e)}}class uN{constructor(){R(this,"destChannelMediaInfos",new Map),R(this,"srcChannelMediaInfo",void 0)}setSrcChannelInfo(e){Rb(e),this.srcChannelMediaInfo=e}addDestChannelInfo(e){Rb(e),this.destChannelMediaInfos.set(e.channelName,e)}removeDestChannelInfo(e){Gp(e),this.destChannelMediaInfos.delete(e)}getSrcChannelMediaInfo(){return this.srcChannelMediaInfo}getDestChannelMediaInfo(){return this.destChannelMediaInfos}}function lN(t){if(!(t instanceof uN))return new U(b.INVALID_PARAMS,"Config should be instance of [ChannelMediaRelayConfiguration]").throw();const e=t.getSrcChannelMediaInfo(),n=t.getDestChannelMediaInfo();if(!e)return new U(b.INVALID_PARAMS,"srcChannelMediaInfo should not be empty").throw();if(n.size===0)return new U(b.INVALID_PARAMS,"destChannelMediaInfo should not be empty").throw()}class a3 extends Ve{constructor(e,n,i){super(),R(this,"ws",void 0),R(this,"requestId",1),R(this,"heartBeatTimer",void 0),R(this,"joinInfo",void 0),R(this,"clientId",void 0),R(this,"onOpen",()=>{this.emit("open"),this.startHeartBeatCheck()}),R(this,"onClose",r=>{this.emit("close"),this.dispose()}),R(this,"onMessage",r=>{const o=JSON.parse(r.data);if(!o||o.command!=="serverResponse"||!o.requestId)return o&&o.command==="serverStatus"&&o.serverStatus&&o.serverStatus.command?(this.emit("status",o.serverStatus),void this.emit(o.serverStatus.command,o.serverStatus)):void 0;this.emit("req_".concat(o.requestId),o)}),this.joinInfo=e,this.clientId=n,this.ws=new tl("cross-channel-".concat(this.clientId),i),this.ws.on(It.RECONNECTING,()=>{this.ws.reconnectMode="retry",this.emit("reconnecting")}),this.ws.on(It.CONNECTED,this.onOpen),this.ws.on(It.ON_MESSAGE,this.onMessage),this.ws.on(It.CLOSED,this.onClose)}isConnect(){return this.ws.state==="connected"}sendMessage(e){const n=this.requestId++;return e.requestId=n,e.seq=n,this.ws.sendMessage(e),n}waitStatus(e){return new ot((n,i)=>{const r=window.setTimeout(()=>{i(new U(b.TIMEOUT,"wait status timeout, status: ".concat(e)))},5e3);this.once(e,o=>{window.clearTimeout(r),o.state&&o.state!==0?i(new U(b.CROSS_CHANNEL_WAIT_STATUS_ERROR,"wait status error, status: ".concat(e))):n(void 0)}),this.once("dispose",()=>{window.clearTimeout(r),i(new U(b.WS_ABORT))})})}async request(e){if(this.ws.state==="closed")throw new U(b.WS_DISCONNECT);const n=()=>new ot((s,a)=>{this.ws.once(It.CLOSED,()=>a(new U(b.WS_ABORT))),this.ws.once(It.CONNECTED,s)});this.ws.state!=="connected"&&await n();const i=this.sendMessage(e),r=new ot((s,a)=>{const c=()=>{a(new U(b.WS_ABORT))};this.ws.once(It.RECONNECTING,c),this.ws.once(It.CLOSED,c),this.once("req_".concat(i),s),wn(3e3).then(()=>{this.removeAllListeners("req_".concat(i)),this.ws.off(It.RECONNECTING,c),this.ws.off(It.CLOSED,c),a(new U(b.TIMEOUT,"cross channel ws request timeout"))})}),o=await r;if(!o||o.code!==200)throw new U(b.CROSS_CHANNEL_SERVER_ERROR_RESPONSE,"response: ".concat(JSON.stringify(o)));return o}async connect(e){this.ws.removeAllListeners(It.REQUEST_NEW_URLS),this.ws.on(It.REQUEST_NEW_URLS,n=>{n(e)}),await this.ws.init(e)}dispose(){this.clearHeartBeatCheck(),this.emit("dispose"),this.removeAllListeners(),this.ws.close()}sendPing(e){const n=this.requestId++;return e.requestId=n,this.ws.sendMessage(e),n}startHeartBeatCheck(){this.heartBeatTimer&&window.clearInterval(this.heartBeatTimer),this.heartBeatTimer=window.setInterval(()=>{this.sendPing({command:"ping",appId:this.joinInfo.appId,cname:this.joinInfo.cname,uid:this.joinInfo.uid.toString(),sid:this.joinInfo.sid,ts:+new Date,requestId:0})},3e3)}clearHeartBeatCheck(){window.clearInterval(this.heartBeatTimer),this.heartBeatTimer=void 0}}class c3 extends Ve{set state(e){e!==this._state&&(e!==Di.RELAY_STATE_FAILURE&&(this.errorCode=rd.RELAY_OK),this.emit("state",e,this.errorCode),this._state=e)}get state(){return this._state}constructor(e,n,i,r,o){super(),R(this,"joinInfo",void 0),R(this,"sid",void 0),R(this,"clientId",void 0),R(this,"cancelToken",yi.CancelToken.source()),R(this,"workerToken",void 0),R(this,"requestId",0),R(this,"signal",void 0),R(this,"prevChannelMediaConfig",void 0),R(this,"httpRetryConfig",void 0),R(this,"_resolution",void 0),R(this,"_state",Di.RELAY_STATE_IDLE),R(this,"errorCode",rd.RELAY_OK),R(this,"onStatus",s=>{E.debug("[".concat(this.clientId,"] ChannelMediaStatus: ").concat(JSON.stringify(s))),s&&s.command&&(s.command==="onAudioPacketReceived"&&this.emit("event",fs.PACKET_RECEIVED_AUDIO_FROM_SRC),s.command==="onVideoPacketReceived"&&this.emit("event",fs.PACKET_RECEIVED_VIDEO_FROM_SRC),s.command==="onSrcTokenPrivilegeDidExpire"&&(this.errorCode=rd.SRC_TOKEN_EXPIRED,this.state=Di.RELAY_STATE_FAILURE),s.command==="onDestTokenPrivilegeDidExpire"&&(this.errorCode=rd.DEST_TOKEN_EXPIRED,this.state=Di.RELAY_STATE_FAILURE))}),R(this,"onReconnect",async()=>{E.debug("[".concat(this.clientId,"] ChannelMediaSocket disconnect, reconnecting")),this.emit("event",fs.NETWORK_DISCONNECTED),this.state=Di.RELAY_STATE_IDLE,this.prevChannelMediaConfig&&this.sendStartRelayMessage(this.prevChannelMediaConfig).catch(s=>{this.state!==Di.RELAY_STATE_IDLE&&(E.error("auto restart channel media relay failed",s.toString()),this.errorCode=rd.SERVER_CONNECTION_LOST,this.state=Di.RELAY_STATE_FAILURE)})}),this.joinInfo=e,this.clientId=n,this.sid=Ju(),this.signal=new a3(this.joinInfo,this.clientId,i),this.httpRetryConfig=r,this._resolution=o}async startChannelMediaRelay(e){if(this.state!==Di.RELAY_STATE_IDLE)throw new U(b.INVALID_OPERATION);this.state=Di.RELAY_STATE_CONNECTING,await this.connect(),E.debug("[".concat(this.clientId,"] startChannelMediaRelay: connect success"));try{await this.sendStartRelayMessage(e)}catch(n){throw n.data&&n.data.serverResponse&&n.data.serverResponse.command==="SetSourceChannel"?new U(b.CROSS_CHANNEL_FAILED_JOIN_SRC):n.data&&n.data.serverResponse&&n.serverResponse.command==="SetDestChannelStatus"?new U(b.CROSS_CHANNEL_FAILED_JOIN_DEST):n.data&&n.data.serverResponse&&n.serverResponse.command==="StartPacketTransfer"?new U(b.CROSS_CHANNEL_FAILED_PACKET_SENT_TO_DEST):n}this.prevChannelMediaConfig=e}async updateChannelMediaRelay(e){if(this.state!==Di.RELAY_STATE_RUNNING)throw new U(b.INVALID_OPERATION);await this.sendUpdateMessage(e),this.prevChannelMediaConfig=e}async setVideoProfile(e){if(this._resolution=e,this.state!==Di.RELAY_STATE_RUNNING)throw new U(b.INVALID_OPERATION);const n=this.genMessage(gi.SetVideoProfile);await this.signal.request(n),E.debug("[".concat(this.clientId,"] startChannelMediaRelay: setVideoProfile success"))}async stopChannelMediaRelay(){await this.sendStopRelayMessage(),E.debug("[".concat(this.clientId,"] stopChannelMediaRelay: send stop message success")),this.state=Di.RELAY_STATE_IDLE,this.dispose()}dispose(){E.debug("[".concat(this.clientId,"] disposeChannelMediaRelay")),this.cancelToken.cancel(),this.cancelToken=yi.CancelToken.source(),this.state=Di.RELAY_STATE_IDLE,this.emit("dispose"),this.signal.dispose(),this.prevChannelMediaConfig=void 0}async connect(){const e=await aB(this.joinInfo,this.cancelToken.token,this.httpRetryConfig);this.workerToken=e.workerToken,await this.signal.connect(e.addressList),this.emit("event",fs.NETWORK_CONNECTED),this.signal.on("status",this.onStatus),this.signal.on("reconnecting",this.onReconnect)}async sendStartRelayMessage(e){const n=this.genMessage(gi.StopPacketTransfer);await this.signal.request(n),await this.signal.waitStatus("Normal Quit"),E.debug("[".concat(this.clientId,"] startChannelMediaRelay: StopPacketTransfer success"));const i=this.genMessage(gi.SetSdkProfile,e);await this.signal.request(i),E.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetSdkProfile success"));const r=this.genMessage(gi.SetSourceChannel,e);await this.signal.request(r),await this.signal.waitStatus("SetSourceChannelStatus"),this.emit("event",fs.PACKET_JOINED_SRC_CHANNEL),E.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetSourceChannel success"));const o=this.genMessage(gi.SetSourceUserId,e);await this.signal.request(o),E.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetSourceUserId success"));const s=this.genMessage(gi.SetDestChannel,e);await this.signal.request(s),await this.signal.waitStatus("SetDestChannelStatus"),this.emit("event",fs.PACKET_JOINED_DEST_CHANNEL),E.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetDestChannel success"));const a=this.genMessage(gi.StartPacketTransfer,e);await this.signal.request(a),this.emit("event",fs.PACKET_SENT_TO_DEST_CHANNEL),this.state=Di.RELAY_STATE_RUNNING,E.debug("[".concat(this.clientId,"] startChannelMediaRelay: StartPacketTransfer success")),this.setVideoProfile(this._resolution)}async sendUpdateMessage(e){const n=this.genMessage(gi.UpdateDestChannel,e);await this.signal.request(n),this.emit("event",fs.PACKET_UPDATE_DEST_CHANNEL),E.debug("[".concat(this.clientId,"] sendUpdateMessage: UpdateDestChannel success"))}async sendStopRelayMessage(){const e=this.genMessage(gi.StopPacketTransfer);await this.signal.request(e),E.debug("[".concat(this.clientId,"] sendStopRelayMessage: StopPacketTransfer success"))}genMessage(e,n){const i=[],r=[],o=[];this.requestId+=1;const s={appId:this.joinInfo.appId,cname:this.joinInfo.cname,uid:this.joinInfo.uid.toString(),sdkVersion:pr,sid:this.sid,ts:Date.now(),requestId:this.requestId,seq:this.requestId,allocate:!0,clientRequest:{}};s.sdkVersion==="4.21.0"&&(s.sdkVersion="0.0.1");let a=null,c=null;switch(e){case gi.SetSdkProfile:return s.clientRequest={command:"SetSdkProfile",type:"multi_channel"},s;case gi.SetSourceChannel:if(c=n&&n.getSrcChannelMediaInfo(),!c)throw new U(b.UNEXPECTED_ERROR,"can not find source config");return s.clientRequest={command:"SetSourceChannel",uid:"0",channelName:c.channelName,token:c.token||this.joinInfo.appId},s;case gi.SetSourceUserId:if(c=n&&n.getSrcChannelMediaInfo(),!c)throw new U(b.UNEXPECTED_ERROR,"can not find source config");return s.clientRequest={command:"SetSourceUserId",uid:c.uid+""},s;case gi.SetDestChannel:if(a=n&&n.getDestChannelMediaInfo(),!a)throw new U(b.UNEXPECTED_ERROR,"can not find dest config");return a.forEach(d=>{i.push(d.channelName),r.push(d.uid+""),o.push(d.token||this.joinInfo.appId)}),s.clientRequest={command:"SetDestChannel",channelName:i,uid:r,token:o},s;case gi.StartPacketTransfer:return s.clientRequest={command:"StartPacketTransfer"},s;case gi.Reconnect:return s.clientRequest={command:"Reconnect"},s;case gi.StopPacketTransfer:return s.clientRequest={command:"StopPacketTransfer"},s;case gi.UpdateDestChannel:if(a=n&&n.getDestChannelMediaInfo(),!a)throw new U(b.UNEXPECTED_ERROR,"can not find dest config");return a.forEach(d=>{i.push(d.channelName),r.push(d.uid+""),o.push(d.token||this.joinInfo.appId)}),s.clientRequest={command:"UpdateDestChannel",channelName:i,uid:r,token:o},s;case gi.SetVideoProfile:s.clientRequest={command:"SetVideoProfile",width:this._resolution.width,height:this._resolution.height}}return s}}function Uf(t){var e={},n=!1;function i(r,o){return n=!0,{done:!1,value:new bT(o=new AT(function(s){s(t[r](o))}),1)}}return e[Kc!==void 0&&ky||"@@iterator"]=function(){return this},e.next=function(r){return n?(n=!1,r):i("next",r)},typeof t.throw=="function"&&(e.throw=function(r){if(n)throw n=!1,r;return i("throw",r)}),typeof t.return=="function"&&(e.return=function(r){return n?(n=!1,r):i("return",r)}),e}var hN=Dt(C0);function pN(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),n.push.apply(n,i)}return n}function fN(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?pN(Object(n),!0).forEach(function(i){R(t,i,n[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):pN(Object(n)).forEach(function(i){Object.defineProperty(t,i,Object.getOwnPropertyDescriptor(n,i))})}return t}var we;function _N(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),n.push.apply(n,i)}return n}function EN(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?_N(Object(n),!0).forEach(function(i){R(t,i,n[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):_N(Object(n)).forEach(function(i){Object.defineProperty(t,i,Object.getOwnPropertyDescriptor(n,i))})}return t}let Ld=(we=class jl extends qp{get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get localCodecs(){return[...new Set(this.localCapabilities&&this.localCapabilities.videoCodecs.map(e=>e.rtpMap&&e.rtpMap.encodingName.toLowerCase()||"").filter(e=>{var n;return it(n=Object.keys(ed)).call(n,e)}))]}constructor(e,n){super(e,n),R(this,"store",void 0),R(this,"peerConnection",void 0),R(this,"remoteSDP",void 0),R(this,"initialOffer",void 0),R(this,"statsFilter",void 0),R(this,"useRTX",!1),R(this,"localCapabilities",void 0),R(this,"localCandidateCount",0),R(this,"allCandidatesReceived",!1),R(this,"establishPromise",void 0),R(this,"mutex",new kn("P2PConnection-mutex")),this.store=n,this.peerConnection=new RTCPeerConnection(jl.resolvePCConfiguration(e),{optional:[{googDscp:!0}]}),this.statsFilter=Nf(this.peerConnection,N("STATS_UPDATE_INTERVAL"),void 0,ye()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1,this.establishPromise=this.establish()}async establish(){try{const e=await this.peerConnection.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0});if(!e.sdp)throw new Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");const n=fo(e.sdp),i=Dl(e.sdp,{filterRTX:!this.useRTX,filterVideoFec:N("FILTER_VIDEO_FEC"),filterAudioFec:N("FILTER_AUDIO_FEC"),filterAudioCodec:["opus"]});return this.localCapabilities=i,this.initialOffer=e,EN(EN({},n),{},{rtpCapabilities:{send:{audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},recv:{audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},sendrecv:i},offerSDP:e.sdp})}catch(e){throw new G(b.GET_LOCAL_CONNECTION_PARAMS_FAILED,e.toString())}}async connect(e,n,i,r,o,s){try{if(!this.initialOffer)throw new Error("Cannot establish P2PConnection without initial offer.");this.remoteSDP=new class{constructor(c){R(this,"sessionDesc",void 0),R(this,"localCapabilities",void 0),R(this,"rtpCapabilities",void 0),R(this,"candidates",void 0),R(this,"iceParameters",void 0),R(this,"dtlsParameters",void 0),R(this,"setup",void 0),R(this,"currentMidIndex",void 0),R(this,"cname",void 0),c=Ne(c);const{remoteIceParameters:d,remoteDtlsParameters:u,candidates:l,remoteRTPCapabilities:p,remoteSetup:f,localCapabilities:C,sdkCodec:m,cname:g}=c,y=je.parse(`v=0
o=- 0 0 IN IP4 127.0.0.1
s=AgoraGateway
t=0 0
a=group:BUNDLE audio video
a=msid-semantic: WMS
a=ice-lite
m=audio 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendrecv
a=rtcp-mux
a=rtcp-rsize
a=mid:audio
m=video 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendrecv
a=rtcp-mux
a=rtcp-rsize
a=mid:video
`);this.rtpCapabilities=p,this.candidates=l,this.iceParameters=d,this.dtlsParameters=u,this.setup=f,this.localCapabilities=C,this.cname=g;for(let A=0;A<y.mediaDescriptions.length;A++){const k=y.mediaDescriptions[A];if(k.attributes.iceUfrag=d.iceUfrag,k.attributes.icePwd=d.icePwd,k.attributes.fingerprints=u.fingerprints,k.attributes.candidates=l,k.attributes.setup=f,k.media.mediaType==="video"){k.media.fmts=p.videoCodecs.map(V=>V.payloadType.toString(10));let M=p.videoCodecs.filter(V=>{var B,K;return(B=V.rtpMap)===null||B===void 0?void 0:it(K=B.encodingName.toLowerCase()).call(K,m)});M.length===0&&(M=p.videoCodecs),k.attributes.payloads=M,k.attributes.extmaps=p.videoExtensions}k.media.mediaType==="audio"&&(k.media.fmts=p.audioCodecs.map(M=>M.payloadType.toString(10)),k.attributes.payloads=p.audioCodecs,k.attributes.extmaps=p.audioExtensions),y.mediaDescriptions[A]=this.mungMediaDesc(k)}this.sessionDesc=y,this.currentMidIndex=y.mediaDescriptions.length-1}toString(){return je.print(this.sessionDesc)}send(c,d,u){const{ssrcs:l,ssrcGroups:p}=ar(d,this.cname),f=this.sessionDesc.mediaDescriptions.find(g=>c===_t.VIDEO?g.media.mediaType==="video":g.media.mediaType==="audio"),C=l[0].attributes.label,m=l[0].attributes.mslabel;return f.attributes.ssrcs=f.attributes.ssrcs.concat(l),f.attributes.ssrcGroups=f.attributes.ssrcGroups.concat(p),{id:C,mslabel:m}}batchSend(c){return c.map(d=>{let{kind:u,ssrcMsg:l}=d;return this.send(u,l,void 0)})}stopSending(c){this.sessionDesc.mediaDescriptions.forEach(d=>{const u=[],l=[],p=[];d.attributes.ssrcs.forEach(f=>{it(c).call(c,f.attributes.label||"")?p.push(f):u.push(f)}),d.attributes.ssrcGroups.forEach(f=>{var C;it(C=p.map(m=>m.ssrcId)).call(C,f.ssrcIds[0])||l.push(f)}),d.attributes.ssrcs=u,d.attributes.ssrcGroups=l})}mute(c){const d=this.sessionDesc.mediaDescriptions.find(u=>u.attributes.mid===c);if(!d)throw new Error("mediaDescription not found with ".concat(c," in remote SDP when calling RemoteSDP.mute."));d.attributes.direction="inactive"}unmute(c){const d=this.sessionDesc.mediaDescriptions.find(u=>u.attributes.mid===c);if(!d)throw new Error("mediaDescription not found with ".concat(c," in remote SDP when calling RemoteSDP.unmute."));d.attributes.direction="sendonly"}receive(c,d,u){c.forEach((l,p)=>{const f=l._mediaStreamTrack,C=this.sessionDesc.mediaDescriptions.findIndex(g=>g.attributes.mid===f.kind),m=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[C],l);this.sessionDesc.mediaDescriptions[C]=m})}stopReceiving(c){}updateCandidates(c){c===ai.TCP?this.candidates.forEach(d=>{this.candidates.findIndex(u=>u.transport==="tcp"&&u.connectionAddress===d.connectionAddress&&u.port===d.port)===-1&&this.candidates.push(fN(fN({},d),{},{foundation:"tcpcandidate",priority:Number(d.priority)-1+"",transport:"tcp",port:Number(d.port)+90+""}))}):this.candidates=this.candidates.filter(d=>d.transport!=="tcp");for(const d of this.sessionDesc.mediaDescriptions)d.attributes.candidates=this.candidates}restartICE(c){c=Ne(c),this.iceParameters=c,this.sessionDesc.mediaDescriptions.forEach(d=>{d.attributes.iceUfrag=c.iceUfrag,d.attributes.icePwd=c.icePwd})}predictReceivingMids(c){const d=[];for(let u=0;u<c;u++)d.push((this.currentMidIndex+u+1).toString(10));return d}mungRecvMediaDsec(c,d){const u=Ne(c);return ra(u,d),Pf(u,d),u}updateRecvMedia(c,d){const u=this.sessionDesc.mediaDescriptions.findIndex(l=>l.attributes.mid===c);if(u!==-1){const l=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[u],d);this.sessionDesc.mediaDescriptions[u]=l}}bumpMid(c){this.currentMidIndex+=c}updateTrackLabel(c,d,u){const l=this.sessionDesc.mediaDescriptions.find(f=>c===_t.VIDEO?f.attributes.mid==="video":f.attributes.mid==="audio");if(l){const f=l.attributes.ssrcs.find(C=>C.attributes.label===d);var p;f&&(f.attributes.label=u,(p=f.attributes.msid)===null||p===void 0||p.replace(d,u))}}mungMediaDesc(c){const d=Ne(c);return Df(d),function(u){const l=u.attributes.extmaps.find(p=>p.extensionName==="http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01");l&&u.attributes.extmaps.splice(u.attributes.extmaps.indexOf(l),1),u.attributes.payloads.forEach(p=>{const f=p.rtcpFeedbacks.findIndex(C=>C.type==="transport-cc");f!==-1&&p.rtcpFeedbacks.splice(f,1)})}(d),d}getSSRC(c){for(const d of this.sessionDesc.mediaDescriptions)for(const u of d.attributes.ssrcs)if(u.attributes.label===c)return[u]}}({remoteIceParameters:e,remoteDtlsParameters:n,candidates:i,remoteRTPCapabilities:r.send,remoteSetup:o,localCapabilities:this.localCapabilities,sdkCodec:this.store.codec,cname:s});const a=this.remoteSDP.toString();await this.peerConnection.setLocalDescription(this.initialOffer),await this.peerConnection.setRemoteDescription({type:"answer",sdp:a})}catch(a){throw new G(b.EXCHANGE_SDP_FAILED,"P2PConnection.connect failed; ".concat(a.toString()))}}async updateRemoteRTPCapabilities(e,n){throw new G(b.NOT_SUPPORTED,"Planb mode does not support createDataChannels.")}send(e,n){var i=this;return Hi(function*(){const r=yield Mt(i.mutex.lock());try{if(!i.remoteSDP)throw new Error("Cannot call P2PConnection.send before remote SDP created");const o=e.map(p=>i.peerConnection.addTrack(p._mediaStreamTrack)),s=yield Mt(i.peerConnection.createOffer()),a=je.parse(s.sdp),c=e.map(p=>{const f=p._mediaStreamTrack,C=a.mediaDescriptions.find(m=>m.attributes.mid===f.kind);if(!C)throw new Error("Cannot extract ssrc from mediaDescription.");return function(m,g,y){const A=m.attributes.ssrcs.filter(M=>M.attributes.label===g),k=m.attributes.ssrcGroups;if(A.length===0)throw new Error("Cannot extract ssrc from plan-b SDP.");if(k&&A.length>1){const M=k.find(V=>V.ssrcIds.indexOf(A[0].ssrcId)!==-1);return M?[{ssrcId:M.ssrcIds[0],rtx:y?M.ssrcIds[1]:void 0}]:[{ssrcId:A[0].ssrcId}]}return[{ssrcId:A[0].ssrcId}]}(C,f.id,i.useRTX)});let d;try{d=yield c}catch(p){throw o.forEach(f=>{An()&&f.replaceTrack(null),i.peerConnection.removeTrack(f)}),p}const u=i.mungSendOfferSDP(s.sdp,e);i.remoteSDP.receive(e,n,d);const l=i.remoteSDP.toString();return yield Mt(i.peerConnection.setLocalDescription({type:"offer",sdp:u})),yield Mt(i.applySendEncodings(o,e)),yield Mt(i.peerConnection.setRemoteDescription({type:"answer",sdp:l})),e.map((p,f)=>{const C=p._mediaStreamTrack.id;return{localSSRC:c[f],id:C}})}catch(o){throw new G(b.EXCHANGE_SDP_FAILED,"P2PConnection.send failed; ".concat(o.toString()))}finally{r()}})()}async stopSending(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopSending before remote SDP created");const n=this.peerConnection.getSenders().filter(o=>{var s;return e.indexOf(((s=o.track)===null||s===void 0?void 0:s.id)||"")!==-1});if(n.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length when trying to call P2PConnection.stopSending.");n.map(o=>{An()&&o.replaceTrack(null),this.peerConnection.removeTrack(o)});const i=await this.peerConnection.createOffer();await this.peerConnection.setLocalDescription(i),this.remoteSDP.stopReceiving(e);const r=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"answer",sdp:r})}catch(n){throw new G(b.EXCHANGE_SDP_FAILED,"P2PConnection.stopSending failed; ".concat(n.toString()))}}async receive(e,n,i,r){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.receive ".concat(e," before remoteSDP created."));const{id:o,mslabel:s}=this.remoteSDP.send(e,n,r),a=new ot((u,l)=>{const p=setTimeout(()=>{l(new Error("Cannot receive track, id: ".concat(o)))},1e4),f=C=>{const m=Zt();if((m.name==="Safari"&&Number(m.version)===11||Qn())&&C.track.id!==o&&C.streams[0].id===s){var g;const y=C.streams[0].getTracks()[0];return(g=this.remoteSDP)===null||g===void 0||g.updateTrackLabel(e,o,C.track.id),this.peerConnection.removeEventListener("track",f),clearTimeout(p),void u(y)}if(C.track.id===o)return this.peerConnection.removeEventListener("track",f),clearTimeout(p),void u(C.track)};this.peerConnection.addEventListener("track",f)}),c=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:c});const d=await this.peerConnection.createAnswer();return await this.peerConnection.setLocalDescription(d),{track:await a,id:o}}catch(o){throw new G(b.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(o.toString()))}}async stopReceiving(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopReceiving before remote SDP created.");this.remoteSDP.stopSending(e);const n=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:n});const i=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(i)}catch(n){throw new G(b.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(n.toString()))}}async muteRemote(e){}async unmuteRemote(e){}async muteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.muteLocal before remote SDP created.");const n=this.peerConnection.getSenders().filter(i=>{var r;return e.indexOf(((r=i.track)===null||r===void 0?void 0:r.id)||"")!==-1});if(n.length!==e.length)throw new Error("sender' length doesn't match mids' length.");n.map(i=>{if(An()&&i.track)i.track.enabled=!1;else{const r=i.getParameters();r.encodings.forEach(o=>o.active=!1),i.setParameters(r)}})}catch(n){throw new G(b.EXCHANGE_SDP_FAILED,"P2PConnection.muteLocal failed; ".concat(n.toString()))}}async unmuteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteLocal before remote SDP created.");const n=this.peerConnection.getSenders().filter(o=>{var s;return e.indexOf(((s=o.track)===null||s===void 0?void 0:s.id)||"")!==-1});if(n.length!==e.length)throw new Error("Senders' length doesn't match mids' length.");n.map(async o=>{if(An()&&o.track)o.track.enabled=!0;else{const s=o.getParameters();s.encodings.forEach(a=>a.active=!0),await o.setParameters(s)}});const i=await this.peerConnection.createOffer();await this.peerConnection.setLocalDescription(i);const r=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"answer",sdp:r})}catch(n){throw new G(b.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteLocal failed; ".concat(n.toString()))}}restartICE(e){var n=this;return Hi(function*(){const i=yield Mt(n.mutex.lock("From P2PConnection.restartICE"));try{if(!n.remoteSDP)throw new Error("Cannot restartICE before remoteSDP created.");if(zt().supportPCSetConfiguration){const c=n.peerConnection.getConfiguration(),d=e===ai.RELAY?"relay":"all";c.iceTransportPolicy!==d&&(E.debug("[".concat(n.store.clientId,"] restartICE change iceTransportPolicy from [").concat(c.iceTransportPolicy,"] to [").concat(d,"]")),c.iceTransportPolicy=d,n.peerConnection.setConfiguration(c))}else if(e===ai.RELAY)return;e!==ai.RELAY&&n.remoteSDP.updateCandidates(e);const r=yield Mt(n.peerConnection.createOffer({iceRestart:!0}));if(!r.sdp)throw new Error("Cannot restartICE because restart offer SDP does not exist.");const o=fo(r.sdp),{remoteIceParameters:s}=yield o.iceParameters;n.remoteSDP.restartICE(s);const a=n.remoteSDP.toString();yield Mt(n.peerConnection.setLocalDescription(r)),yield Mt(n.peerConnection.setRemoteDescription({type:"answer",sdp:a}))}catch(r){E.warning("[".concat(n.store.clientId,"] restart ICE failed, abort operation"),r)}finally{i()}})()}close(){var e;this.peerConnection.close(),(e=this.onConnectionStateChange)===null||e===void 0||e.call(this,"closed"),this.unbindPCEvents(),this.unbindStatsEvents(),this.removeAllListeners(),this.statsFilter.destroy()}getStats(){return this.statsFilter.getStats()}getRemoteVideoIsReady(e){return this.statsFilter.getVideoIsReady(e)}async updateEncoderConfig(e,n){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.updateEncoderConfig before remote SDP created.");const i=await this.peerConnection.createOffer(),r=this.mungSendOfferSDP(i.sdp,[n]);this.remoteSDP.updateRecvMedia(n._mediaStreamTrack.kind,n);const o=this.remoteSDP.toString();await this.peerConnection.setLocalDescription({type:"offer",sdp:r}),await this.peerConnection.setRemoteDescription({type:"answer",sdp:o})}catch(i){throw new G(b.EXCHANGE_SDP_FAILED,i.toString())}}async updateSendParameters(e,n){const i=this.peerConnection.getSenders().filter(r=>{var o;return((o=r.track)===null||o===void 0?void 0:o.id)===e});i.length===1&&await this.applySendEncodings(i,[n])}setStatsRemoteVideoIsReady(e,n){this.statsFilter.setVideoIsReady2(e,n)}async replaceTrack(e,n){const i=this.peerConnection.getSenders().find(r=>{var o;return((o=r.track)===null||o===void 0?void 0:o.id)===n});i&&await i.replaceTrack(e._mediaStreamTrack)}createDataChannels(e,n){throw new G(b.NOT_SUPPORTED,"Planb mode does not support createDataChannels.")}stopDataChannels(e){throw new G(b.NOT_SUPPORTED,"Planb mode does not support stopDataChannels.")}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var e;(e=this.onICEConnectionStateChange)===null||e===void 0||e.call(this,this.peerConnection.iceConnectionState)},this.peerConnection.onconnectionstatechange=()=>{var e;(e=this.onConnectionStateChange)===null||e===void 0||e.call(this,this.peerConnection.connectionState)},this.peerConnection.onicecandidate=e=>{e.candidate?this.localCandidateCount+=1:(this.peerConnection.onicecandidate=null,this.allCandidatesReceived=!0,E.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount))},setTimeout(()=>{this.allCandidatesReceived||(this.allCandidatesReceived=!0,E.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] onicecandidate timeout, local candidate count"),this.localCandidateCount))},N("CANDIDATE_TIMEOUT"))}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null}static resolvePCConfiguration(e){const n={iceServers:[],sdpSemantics:"plan-b"};return e.iceServers?n.iceServers=e.iceServers:e.turnServer&&e.turnServer.mode!=="off"&&(Zc(e.turnServer.servers)?n.iceServers=e.turnServer.servers:(n.iceServers&&n.iceServers.push(...jl.turnServerConfigToIceServers(e.turnServer.servers)),N("USE_TURN_SERVER_OF_GATEWAY")&&n.iceServers&&e.turnServer.serversFromGateway&&n.iceServers.push(...jl.turnServerConfigToIceServers(e.turnServer.serversFromGateway)),e.turnServer.servers.concat(e.turnServer.serversFromGateway||[]).forEach(i=>{i.forceturn&&(n.iceTransportPolicy="relay")}))),n}static turnServerConfigToIceServers(e){const n=[];return e.forEach(i=>{i.security?i.tcpport&&n.push({username:i.username,credential:i.password,credentialType:"password",urls:"turns:".concat(i.turnServerURL,":").concat(i.tcpport,"?transport=tcp")}):(i.udpport&&n.push({username:i.username,credential:i.password,credentialType:"password",urls:"turn:".concat(i.turnServerURL,":").concat(i.udpport,"?transport=udp")}),i.tcpport&&n.push({username:i.username,credential:i.password,credentialType:"password",urls:"turn:".concat(i.turnServerURL,":").concat(i.tcpport,"?transport=tcp")}))}),n}async updateRtpSenderEncodings(e,n){var i;if(n||(n=this.peerConnection.getSenders().find(d=>{var u;return((u=d.track)===null||u===void 0?void 0:u.id)===e._mediaStreamTrack.id})),!n)return E.warn("[".concat(e.getTrackId(),"] no rtpSender found}"));if(!zt().supportSetRtpSenderParameters)return E.warn("Browser not support set rtp-sender parameters");const r={},o={};if(e instanceof Ae)switch(e._optimizationMode){case"motion":r.degradationPreference="maintain-framerate";break;case"detail":r.degradationPreference="maintain-resolution";break;default:r.degradationPreference="balanced"}if(N("DSCP_TYPE")&&Ws()){var s;const d=N("DSCP_TYPE");it(s=["very-low","low","medium","high"]).call(s,d)&&(o.networkPriority=d)}const a=n.getParameters(),c=(i=a.encodings)===null||i===void 0?void 0:i[0];c&&Object.assign(c,o),Object.assign(a,r),E.debug("[".concat(e.getTrackId(),"] updateRtpSenderEncodings: ").concat(JSON.stringify(a.encodings))),await n.setParameters(a)}async applySendEncodings(e,n){try{if(!zt().supportSetRtpSenderParameters||e.length!==n.length)return;for(let i=0;i<e.length;i++){const r=e[i],o=n[i];r&&o&&await this.updateRtpSenderEncodings(o,r)}}catch{E.debug("[".concat(this.store.clientId,"] Apply RTPSendEncodings failed."))}}mungSendOfferSDP(e,n){const i=je.parse(e);return n.forEach((r,o)=>{const s=r._mediaStreamTrack,a=i.mediaDescriptions.find(c=>c.attributes.mid===s.kind);a&&ra(a,r)}),je.print(i)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=e=>{var n;(n=this.onFirstAudioReceived)===null||n===void 0||n.call(this,e)},this.statsFilter.onFirstVideoReceived=e=>{var n;(n=this.onFirstVideoReceived)===null||n===void 0||n.call(this,e)},this.statsFilter.onFirstAudioDecoded=e=>{var n;(n=this.onFirstAudioDecoded)===null||n===void 0||n.call(this,e)},this.statsFilter.onFirstVideoDecoded=(e,n,i)=>{var r;(r=this.onFirstVideoDecoded)===null||r===void 0||r.call(this,e,n,i)},this.statsFilter.onSelectedLocalCandidateChanged=(e,n)=>{var i;(i=this.onSelectedLocalCandidateChanged)===null||i===void 0||i.call(this,e,n)},this.statsFilter.onSelectedRemoteCandidateChanged=(e,n)=>{var i;(i=this.onSelectedRemoteCandidateChanged)===null||i===void 0||i.call(this,e,n)}}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0}async batchReceive(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.batchReceive before remoteSDP created.");const n=this.remoteSDP.batchSend(e).map((o,s)=>{let{id:a,mslabel:c}=o;const{kind:d}=e[s];return new ot((u,l)=>{const p=setTimeout(()=>{l(new Error("Cannot receive track, id: ".concat(a)))},1e4),f=C=>{const m=Zt();if(m.name==="Safari"&&Number(m.version)===11&&C.track.id!==a&&C.streams[0].id===c){var g;const y=C.streams[0].getTracks()[0];return(g=this.remoteSDP)===null||g===void 0||g.updateTrackLabel(d,a,C.track.id),this.peerConnection.removeEventListener("track",f),clearTimeout(p),void u({track:y,id:a})}if(C.track.id===a)return this.peerConnection.removeEventListener("track",f),clearTimeout(p),void u({track:C.track,id:a})};this.peerConnection.addEventListener("track",f)})}),i=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:i});const r=await this.peerConnection.createAnswer();return await this.peerConnection.setLocalDescription(r),await ot.all(n)}catch(n){throw new G(b.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(n.toString()))}}async getRemoteSSRC(e){if(!this.remoteSDP)return;const n=this.remoteSDP.getSSRC(e);return n==null?void 0:n[0].ssrcId}setConfiguration(e){if(zt().supportPCSetConfiguration){const n=jl.resolvePCConfiguration(e);this.peerConnection.setConfiguration(n)}}},nt(we.prototype,"connect",[Sr],Object.getOwnPropertyDescriptor(we.prototype,"connect"),we.prototype),nt(we.prototype,"stopSending",[Sr],Object.getOwnPropertyDescriptor(we.prototype,"stopSending"),we.prototype),nt(we.prototype,"receive",[Sr],Object.getOwnPropertyDescriptor(we.prototype,"receive"),we.prototype),nt(we.prototype,"stopReceiving",[Sr],Object.getOwnPropertyDescriptor(we.prototype,"stopReceiving"),we.prototype),nt(we.prototype,"muteRemote",[Sr],Object.getOwnPropertyDescriptor(we.prototype,"muteRemote"),we.prototype),nt(we.prototype,"unmuteRemote",[Sr],Object.getOwnPropertyDescriptor(we.prototype,"unmuteRemote"),we.prototype),nt(we.prototype,"muteLocal",[Sr],Object.getOwnPropertyDescriptor(we.prototype,"muteLocal"),we.prototype),nt(we.prototype,"unmuteLocal",[Sr],Object.getOwnPropertyDescriptor(we.prototype,"unmuteLocal"),we.prototype),nt(we.prototype,"close",[Sr],Object.getOwnPropertyDescriptor(we.prototype,"close"),we.prototype),nt(we.prototype,"updateEncoderConfig",[Sr],Object.getOwnPropertyDescriptor(we.prototype,"updateEncoderConfig"),we.prototype),nt(we.prototype,"updateSendParameters",[Sr],Object.getOwnPropertyDescriptor(we.prototype,"updateSendParameters"),we.prototype),nt(we.prototype,"replaceTrack",[Sr],Object.getOwnPropertyDescriptor(we.prototype,"replaceTrack"),we.prototype),nt(we.prototype,"getRemoteSSRC",[Sr],Object.getOwnPropertyDescriptor(we.prototype,"getRemoteSSRC"),we.prototype),we);function Sr(t,e,n){const i=t[e];if(typeof i!="function")throw new Error("Cannot use mutex on object property.");return n.value=async function(){const r=this.mutex,o=await r.lock("Locking from P2PConnection.".concat(e));try{for(var s=arguments.length,a=new Array(s),c=0;c<s;c++)a[c]=arguments[c];return await i.apply(this,a)}finally{o()}},n}function mN(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),n.push.apply(n,i)}return n}function ca(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?mN(Object(n),!0).forEach(function(i){R(t,i,n[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):mN(Object(n)).forEach(function(i){Object.defineProperty(t,i,Object.getOwnPropertyDescriptor(n,i))})}return t}const kl="9",gN=4e4;function TN(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),n.push.apply(n,i)}return n}function ys(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?TN(Object(n),!0).forEach(function(i){R(t,i,n[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):TN(Object(n)).forEach(function(i){Object.defineProperty(t,i,Object.getOwnPropertyDescriptor(n,i))})}return t}let xf=function(t){return t.BANDWIDTH="bandwidth",t.CPU="cpu",t.NONE="none",t.OTHER="other",t}({});var kd=function(t){return t[t.DOWN=0]="DOWN",t[t.UP=1]="UP",t}(kd||{});const Vf=new Map;function SN(t,e,n,i){let{scale:r}=t;if(r===0&&i===kd.UP||r>=e.length-1&&i===kd.DOWN)return t;let o=ys(ys({},t),{},{scale:i===kd.DOWN?++r:--r});switch(n){case"maintain-framerate":o=ys(ys({},o),e[r].motion);break;case"maintain-resolution":o=ys(ys({},o),e[r].detail);break;case"balanced":o=ys(ys({},o),e[r].balanced)}return o}function RN(t,e){if(e){const n={overUse:0,underUse:0,adaptationList:CN(e)};Vf.set(t,n)}else Vf.delete(t)}function CN(t){const e=ys({},t),{bitrateMax:n,frameRate:i,scaleResolutionDownBy:r,bitrateMin:o}=e,{MIN_FRAME_RATE:s,MAX_THRESHOLD_FRAMERATE:a,MAX_SCALE:c,BITRATE_MIN_THRESHOLD:d,BITRATE_MAX_THRESHOLD:u,BWE_SCALE_UP_THRESHOLD:l,BWE_SCALE_DOWN_THRESHOLD:p,PERF_SCALE_DOWN_THRESHOLD:f,PERF_SCALE_UP_THRESHOLD:C,BALANCE_BITRATE_FACTOR:m,BALANCE_FRAMERATE_FACTOR:g,BALANCE_RESOLUTION_FACTOR:y,MOTION_RESOLUTION_FACTOR:A,MOTION_BITRATE_FACTOR:k,DETAIL_FRAMERATE_FACTOR:M,DETAIL_BITRATE_FACTOR:V}=$m,B=Math.min(e.frameRate,a),K=[{scale:0,threshold:{bwe_down:Math.round(Math.pow(p,1)*n),bwe_up:n,fps_down:Math.round(Math.pow(f,1)*B),fps_up:i},balanced:{scaleResolutionDownBy:1,frameRate:i,bitrateMax:n,bitrateMin:o},motion:{scaleResolutionDownBy:1,frameRate:i,bitrateMax:n,bitrateMin:o},detail:{scaleResolutionDownBy:1,frameRate:i,bitrateMax:n,bitrateMin:o}}];for(let Y=1;Y<=c;Y++){const J={bwe_up:Math.round(Math.pow(l,Y)*n),bwe_down:Math.round(Math.pow(p,Y+1)*n),fps_up:Math.round(Math.pow(C,Y)*B),fps_down:Math.round(Math.pow(f,Y+1)*B)},lt={scaleResolutionDownBy:r/Math.pow(y,Y),frameRate:Math.max(Math.round(Math.pow(g,Y)*i),s),bitrateMax:Math.max(Math.round(Math.pow(m,Y)*n),u),bitrateMin:Math.max(Math.round(Math.pow(m,Y)*o),d)},Yt={scaleResolutionDownBy:r/Math.pow(A,Y),frameRate:i,bitrateMax:Math.max(Math.round(Math.pow(k,Y)*n),u),bitrateMin:Math.max(Math.round(Math.pow(k,Y)*o),d)},de={scaleResolutionDownBy:1,frameRate:Math.max(Math.round(Math.pow(M,Y)*i),s),bitrateMax:Math.max(Math.round(Math.pow(V,Y)*n),u),bitrateMin:Math.max(Math.round(Math.pow(V,Y)*o),d)};K.push({scale:Y,threshold:J,balanced:lt,motion:Yt,detail:de})}return K}function d3(t,e,n,i,r,o){const s=Vf.get(t)||{overUse:0,underUse:0,adaptationList:CN(r)},{adaptationList:a}=s;Vf.set(t,s);const{OVERUSE_TIMES_THRESHOLD:c,UNDERUSE_TIMES_THRESHOLD:d}=$m,{scale:u}=i;let l,p;return typeof e=="number"&&e>0&&function(f,C,m,g){if(C>=m.length)return!1;let{threshold:{fps_down:y}}=m[C];return N("FORCE_AG_HIGH_FRAMERATE")&&g==="maintain-framerate"&&(y=m[0].threshold.fps_down),f<y}(e,u,a,o)&&(s.overUse++,p=xf.CPU,s.overUse>c)||typeof n=="number"&&n>0&&function(f,C,m){if(C>=m.length)return!1;const{threshold:{bwe_down:g}}=m[C];return f<g}(n,u,a)&&(s.overUse++,p=xf.BANDWIDTH,s.overUse>c)?(s.overUse=0,s.underUse=0,l=SN(i,a,o,kd.DOWN),[l,p]):(typeof e=="number"&&e>0&&typeof n=="number"&&n>0&&function(f,C,m,g){if(C===0)return;let{threshold:{fps_up:y}}=m[C];return N("FORCE_AG_HIGH_FRAMERATE")&&g==="maintain-framerate"&&(y=m[1].threshold.fps_up),f>y}(e,u,a,o)&&function(f,C,m){if(C===0)return;const{threshold:{bwe_up:g}}=m[C];return f>g}(n,u,a)&&(s.underUse++,s.underUse>d&&(s.overUse=0,s.underUse=0,l=SN(i,a,o,kd.UP),l.scale===0&&(p=xf.NONE))),[l,p])}function vN(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),n.push.apply(n,i)}return n}function jT(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?vN(Object(n),!0).forEach(function(i){R(t,i,n[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):vN(Object(n)).forEach(function(i){Object.defineProperty(t,i,Object.getOwnPropertyDescriptor(n,i))})}return t}function u3(t){var e;return!!N("ENABLE_AG_ADAPTATION")&&!!(t instanceof yT||it(e=t._hints).call(e,De.CUSTOM_TRACK))&&(!!N("FORCE_SUPPORT_AG_ADAPTATION")||!!(function(n){const i=Zt();if(i.os!==bn.IOS||!i.osVersion)return!1;const r=i.osVersion.split(".");return Number(r[0])>=n}(14)&&LI(17,4,!0)||PI(14)&&kI(17,4,!0)))}const Ff=new Map;function jf(t){const e=Ff.get(t);if(e){const{timer:n,adaptationFunc:i,originConfig:r}=e;window.clearTimeout(n),i(r),Ff.delete(t)}RN(t)}var ee;function yN(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),n.push.apply(n,i)}return n}function da(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?yN(Object(n),!0).forEach(function(i){R(t,i,n[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):yN(Object(n)).forEach(function(i){Object.defineProperty(t,i,Object.getOwnPropertyDescriptor(n,i))})}return t}let go=(ee=class Bl extends qp{get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get dtlsTransportState(){var e,n;return(e=(n=this.peerConnection.getReceivers()[0])===null||n===void 0||(n=n.transport)===null||n===void 0?void 0:n.state)!==null&&e!==void 0?e:null}get localCodecs(){return[...new Set(this.localCapabilities&&this.localCapabilities.send.videoCodecs.map(e=>e.rtpMap&&e.rtpMap.encodingName.toLowerCase()||"").filter(e=>{var n;return it(n=Object.keys(ed)).call(n,e)}))]}constructor(e,n){super(e,n),R(this,"store",void 0),R(this,"peerConnection",void 0),R(this,"id",be(5,"connection-")),R(this,"remoteSDP",void 0),R(this,"initialOffer",void 0),R(this,"transportEventReceiver",void 0),R(this,"statsFilter",void 0),R(this,"useXR",N("USE_XR")),R(this,"localCapabilities",void 0),R(this,"remoteCodecs",void 0),R(this,"localCandidateCount",0),R(this,"allCandidatesReceived",!1),R(this,"dataStreamChannelMap",new Map),R(this,"establishPromise",void 0),R(this,"recoveredDataChannelIds",[]),R(this,"currentDataChannelId",1),R(this,"mutex",new kn("P2PConnection-mutex")),R(this,"qualityLimitationReason",xf.NONE),this.store=n,this.peerConnection=new RTCPeerConnection(Bl.resolvePCConfiguration(e),{optional:[{googDscp:!0}]}),this.statsFilter=Nf(this.peerConnection,N("STATS_UPDATE_INTERVAL"),void 0,ye()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1,this.establishPromise=this.establish()}async updateRemoteRTPCapabilities(e,n){if(this.remoteCodecs=n,!this.remoteSDP)return void E.debug("[P2PConnection] cannot updateRemoteRTPCapabilities before remote SDP created, local codecs: ".concat(this.localCodecs,", codecs: ").concat(n));if(this.remoteSDP.updateRemoteCodec(e,n,this.store.codec)){const i=await this.peerConnection.createOffer(),r=this.logSDPExchange(i.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(i);const o=this.remoteSDP.toString();r==null||r(o),await this.peerConnection.setRemoteDescription({type:"answer",sdp:o})}else E.debug("[P2PConnection] updateRemoteRTPCapabilities no need to exchange SDP.")}async establish(){try{this.peerConnection.addTransceiver("video",{direction:"recvonly"}),this.peerConnection.addTransceiver("audio",{direction:"recvonly"});const e=await this.peerConnection.createOffer();if(!e.sdp)throw new Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");const n=fo(e.sdp),i=await MT({filterRTX:!N("USE_PUB_RTX")&&!N("USE_SUB_RTX"),filterVideoFec:N("FILTER_VIDEO_FEC"),filterAudioFec:N("FILTER_AUDIO_FEC"),filterVideoCodec:N("FILTER_VIDEO_CODEC")},{useXR:this.useXR});return this.localCapabilities=Pd(i),this.initialOffer=e,da(da({},n),{},{rtpCapabilities:i,offerSDP:e.sdp})}catch(e){throw new G(b.GET_LOCAL_CONNECTION_PARAMS_FAILED,e.toString())}}async connect(e,n,i,r,o,s){try{if(!this.initialOffer)throw new Error("Cannot establish P2PConnection without initial offer.");this.remoteSDP=new class{get localCapabilities(){return Ne(this._localCapabilities)}get rtpCapabilities(){return Ne(this._rtpCapabilities)}get candidates(){return Ne(this._candidates)}get iceParameters(){return Ne(this._iceParameters)}get dtlsParameters(){return Ne(this._dtlsParameters)}constructor(f){R(this,"sessionDesc",void 0),R(this,"_localCapabilities",void 0),R(this,"_rtpCapabilities",void 0),R(this,"_candidates",void 0),R(this,"_iceParameters",void 0),R(this,"_dtlsParameters",void 0),R(this,"setup",void 0),R(this,"currentMidIndex",void 0),R(this,"cname",void 0),R(this,"firefoxSsrcMidMap",new Map),f=Ne(f);const{remoteIceParameters:C,remoteDtlsParameters:m,candidates:g,remoteRTPCapabilities:y,remoteSetup:A,localCapabilities:k,cname:M}=f,V=je.parse(`v=0
o=- 0 0 IN IP4 127.0.0.1
s=AgoraGateway
t=0 0
a=group:BUNDLE 0 1
a=msid-semantic: WMS
a=ice-lite
m=video 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendonly
a=rtcp-mux
a=rtcp-rsize
a=mid:0
m=audio 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendonly
a=rtcp-mux
a=rtcp-rsize
a=mid:1
`);this._rtpCapabilities=y,this._candidates=g,this._iceParameters=C,this._dtlsParameters=m,this._localCapabilities=k,this.setup=A,this.cname=M;const B=this.rtpCapabilities.send;for(const K of V.mediaDescriptions){if(K.attributes.iceUfrag=C.iceUfrag,K.attributes.icePwd=C.icePwd,K.attributes.fingerprints=m.fingerprints,K.attributes.candidates=g,K.attributes.setup=A,K.media.mediaType==="video"&&(K.media.fmts=B.videoCodecs.map(Y=>Y.payloadType.toString(10)),K.attributes.payloads=B.videoCodecs,K.attributes.extmaps=B.videoExtensions,N("PRELOAD_MEDIA_COUNT")>0)){const{ssrcs:Y,ssrcGroups:J}=ar([{ssrcId:gN,rtx:N("USE_SUB_RTX")?40001:void 0}],this.cname);K.attributes.ssrcs=Y,K.attributes.ssrcGroups=J}if(K.media.mediaType==="audio"&&(K.media.fmts=B.audioCodecs.map(Y=>Y.payloadType.toString(10)),K.attributes.payloads=B.audioCodecs,K.attributes.extmaps=B.audioExtensions,_o(K),N("PRELOAD_MEDIA_COUNT")>0)){const{ssrcs:Y,ssrcGroups:J}=ar([{ssrcId:2e4}],this.cname);K.attributes.ssrcs=Y,K.attributes.ssrcGroups=J}}this.sessionDesc=V,this.currentMidIndex=V.mediaDescriptions.length-1}preloadRemoteMedia(){const f=N("PRELOAD_MEDIA_COUNT");this.rtpCapabilities;const C=this.candidates,m=this.dtlsParameters,g=this.iceParameters,y=this.rtpCapabilities.send;for(let A=1;A<f;A++){const k=2*A+2e4,M=2*A+gN,{ssrcs:V,ssrcGroups:B}=ar([{ssrcId:k}],this.cname),{ssrcs:K,ssrcGroups:Y}=ar([{ssrcId:M,rtx:N("USE_SUB_RTX")?M+1:void 0}],this.cname);this.sessionDesc.mediaDescriptions.push({media:{mediaType:"video",port:kl,protos:["UDP","TLS","RTP","SAVPF"],fmts:y.videoCodecs.map(J=>J.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:g.iceUfrag,icePwd:g.icePwd,unrecognized:[],candidates:C,extmaps:y.videoExtensions,fingerprints:m.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:K,ssrcGroups:Y,rtcpFeedbackWildcards:[],payloads:y.videoCodecs,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:"sendonly",rtcpMux:!0,rtcpRsize:!0,mid:"".concat(2*A)}}),this.sessionDesc.mediaDescriptions.push({media:{mediaType:"audio",port:kl,protos:["UDP","TLS","RTP","SAVPF"],fmts:y.audioCodecs.map(J=>J.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:g.iceUfrag,icePwd:g.icePwd,unrecognized:[],candidates:C,extmaps:y.audioExtensions,fingerprints:m.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:V,ssrcGroups:B,rtcpFeedbackWildcards:[],payloads:y.audioCodecs,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:"sendonly",rtcpMux:!0,rtcpRsize:!0,mid:"".concat(2*A+1)}}),this.currentMidIndex+=2}this.updateBundleMids()}toString(){return je.print(this.sessionDesc)}send(f,C,m,g){const{ssrcs:y,ssrcGroups:A}=ar(C,this.cname,N("SYNC_GROUP")?m:void 0),k=this.findPreloadMediaDesc(y);if(k){if(ye()&&this.firefoxSsrcMidMap.set(y[0].ssrcId,k.attributes.mid),g&&(g.twcc||g.remb)){const M=this.sessionDesc.mediaDescriptions.indexOf(k);return this.sessionDesc.mediaDescriptions[M]=this.mungSendMediaDesc(k,g),{mid:k.attributes.mid,needExchangeSDP:!0}}return{mid:k.attributes.mid,needExchangeSDP:!1}}{const M=this.findAvailableMediaIndex(f,y);let V;return M===-1||M===1&&(An()||UI())||M===0&&N("USE_SUB_RTX")||xI()?(V=this.createOrRecycleSendMedia(f,y,A,"sendonly",g),this.updateBundleMids()):(V=Ne(this.sessionDesc.mediaDescriptions[M]),V.attributes.direction="sendonly",V.attributes.ssrcs=y,V.attributes.ssrcGroups=A,this.sessionDesc.mediaDescriptions[M]=this.mungSendMediaDesc(V,g)),ye()&&this.firefoxSsrcMidMap.set(y[0].ssrcId,V.attributes.mid),{mid:V.attributes.mid,needExchangeSDP:!0}}}sendDataChannel(){const{mediaDesc:f,needExchangeSDP:C}=this.createOrRecycleDataChannel();return this.updateBundleMids(),{mid:f.attributes.mid,needExchangeSDP:C}}batchSend(f){const C=f.map(y=>{let{kind:A,ssrcMsg:k,mslabel:M}=y;return this.send(A,k,M)}),m=[];let g=!1;return C.forEach(y=>{let{mid:A,needExchangeSDP:k}=y;k&&(g=!0),m.push(A)}),{mids:m,needExchangeSDP:g}}stopSending(f){const C=this.sessionDesc.mediaDescriptions.filter(m=>m.attributes.mid&&f.indexOf(m.attributes.mid)!==-1);if(C.length!==f.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.stopSending.");C.forEach(m=>{m.attributes.mid==="0"||ye()||xI()?m.attributes.ssrcs=[]:(m.attributes.ssrcs=[],m.attributes.direction="inactive",m.media.port="0")}),this.updateBundleMids()}mute(f){const C=this.sessionDesc.mediaDescriptions.find(m=>m.attributes.mid===f);if(!C)throw new Error("mediaDescription not found with ".concat(f," in remote SDP when calling RemoteSDP.mute."));C.attributes.direction="inactive"}unmute(f){const C=this.sessionDesc.mediaDescriptions.find(m=>m.attributes.mid===f);if(!C)throw new Error("mediaDescription not found with ".concat(f," in remote SDP when calling RemoteSDP.unmute."));C.attributes.direction="sendonly"}muteRemote(f){const C=this.sessionDesc.mediaDescriptions.filter(m=>it(f).call(f,m.attributes.mid||""));if(C.length!==f.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");C.forEach(m=>{m.attributes.direction="inactive"})}unmuteRemote(f){const C=this.sessionDesc.mediaDescriptions.filter(m=>it(f).call(f,m.attributes.mid||""));if(C.length!==f.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");C.forEach(m=>{m.attributes.direction="recvonly"})}receive(f,C,m,g){f.forEach((y,A)=>{this.createOrRecycleRecvMedia(y,[],"recvonly",C,m,g[A])}),this.updateBundleMids()}stopReceiving(f){const C=this.sessionDesc.mediaDescriptions.filter(m=>f.indexOf(m.attributes.mid)!==-1);if(C.length!==f.length)throw new Error("MediaDescriptions' length doesn't match mids's length when calling RemoteSDP.receive.");C.forEach(m=>{m.media.port="0",m.attributes.direction="inactive"}),this.updateBundleMids()}updateCandidates(f){const C=this._candidates.filter(m=>m.transport==="udp");if(f===ai.TCP){if(C.length===0)return;if(N("TCP_CANDIDATE_ONLY")){const m=this._candidates.filter(g=>g.transport==="tcp");C.forEach(g=>{m.findIndex(y=>y.connectionAddress===g.connectionAddress)===-1&&m.push(ca(ca({},g),{},{foundation:"tcpcandidate",priority:Number(g.priority)-1+"",transport:"tcp",port:Number(g.port)+90+""}))}),this._candidates=m}else{const m=[];C.forEach(g=>{m.push(ca(ca({},g),{},{foundation:"tcpcandidate",priority:Number(g.priority)-1+"",transport:"tcp",port:Number(g.port)+90+""}))}),this._candidates=[...C,...m]}}else if(f===ai.RELAY){if(C.length!==0)return;{const m=this._candidates.filter(g=>g.transport==="tcp");m.forEach(g=>{C.push(ca(ca({},g),{},{foundation:"udpcandidate",priority:Number(g.priority)+1+"",transport:"udp",port:Number(g.port)-90+""}))}),this._candidates=[...C,...m]}}else C.length===0?(this._candidates.filter(m=>m.transport==="tcp").forEach(m=>{C.push(ca(ca({},m),{},{foundation:"udpcandidate",priority:Number(m.priority)+1+"",transport:"udp",port:Number(m.port)-90+""}))}),this._candidates=C):this._candidates=this._candidates.filter(m=>m.transport!=="tcp");for(const m of this.sessionDesc.mediaDescriptions)m.attributes.candidates=this.candidates}restartICE(f){f=Ne(f),this._iceParameters=f,this.sessionDesc.mediaDescriptions.forEach(C=>{C.attributes.iceUfrag=f.iceUfrag,C.attributes.icePwd=f.icePwd})}predictReceivingMids(f){const C=[];for(let m=0;m<f;m++)C.push((this.currentMidIndex+m+1).toString(10));return C}findAvailableMediaIndex(f,C){return this.sessionDesc.mediaDescriptions.findIndex(m=>{const g=m.media.mediaType===f&&m.media.port!=="0"&&(m.attributes.direction==="sendonly"||m.attributes.direction==="sendrecv")&&m.attributes.ssrcs.length===0;if(ye()){if(g){const y=this.firefoxSsrcMidMap.get(C[0].ssrcId);return!(y||m.attributes.mid!=="0"&&m.attributes.mid!=="1")||!(!y||y!==m.attributes.mid)}return!1}return g})}createOrRecycleDataChannel(){for(const m of this.sessionDesc.mediaDescriptions)if(m.media.mediaType==="application")return{mediaDesc:m,needExchangeSDP:!1};this.currentMidIndex+=1;const f="".concat(this.currentMidIndex),C={media:{mediaType:"application",port:kl,protos:["UDP","DTLS","SCTP"],fmts:["webrtc-datachannel"]},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:[],fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:[],ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:[],rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,mid:"".concat(f),sctpPort:"5000"}};return this.sessionDesc.mediaDescriptions.push(C),{mediaDesc:C,needExchangeSDP:!0}}createOrRecycleRecvMedia(f,C,m,g,y,A){const k=f._mediaStreamTrack.kind,M=this.rtpCapabilities.recv,V=ic(k,M,this.localCapabilities.send,k===_t.VIDEO?g:y),B=k===_t.VIDEO?M.videoExtensions:M.audioExtensions;this.currentMidIndex+=1;const K="".concat(this.currentMidIndex);let Y={media:{mediaType:k,port:kl,protos:["UDP","TLS","RTP","SAVPF"],fmts:V.map(lt=>lt.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:B,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:C,ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:V,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:m,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(K)}};Y=this.mungRecvMediaDsec(Y,f,A);const J=this.findFirstClosedMedia(k);if(J){const lt=this.sessionDesc.mediaDescriptions.indexOf(J);this.sessionDesc.mediaDescriptions[lt]=Y}else this.sessionDesc.mediaDescriptions.push(Y);return Y}updateRemoteCodec(f,C,m){const g=[...new Set(this._rtpCapabilities.recv.videoCodecs.map(Y=>Y.rtpMap&&Y.rtpMap.encodingName.toLowerCase()||"").filter(Y=>{var J;return it(J=Object.keys(ed)).call(J,Y)}))],y=new Set(C);if(g.every(Y=>y.has(Y)))return E.debug("codecs has not changed, no need to updateRemoteCodec, codecs: ".concat(C)),!1;const A=this._rtpCapabilities.recv.videoCodecs.filter(Y=>C.some(J=>{var lt;return it(lt=Y.rtpMap&&Y.rtpMap.encodingName.toLowerCase()||"").call(lt,J)}));if(A.length===0)return E.debug("updateRemoteCodec failed, because cannot find matched codec, remoteCapabilities codecs: ".concat(g," codecs: ").concat(C)),!1;const k=[...new Set(A.map(Y=>Y.rtpMap&&Y.rtpMap.encodingName.toLowerCase()||""))];let M;if(E.debug("updateRemoteCodec, from ".concat(g," to ").concat(k)),f.length===0)M=this.sessionDesc.mediaDescriptions.filter(Y=>Y.media.mediaType==="video"&&Y.attributes.direction==="recvonly");else if(M=this.sessionDesc.mediaDescriptions.filter(Y=>Y.attributes.mid&&it(f).call(f,Y.attributes.mid)&&Y.attributes.direction==="recvonly"),M.length!==f.length)return E.debug("updateRemoteCodec failed, because cannot find mids, mids: ".concat(f,", codecs: ").concat(C)),!1;if(N("USE_PUB_RTX")||N("USE_SUB_RTX")){const Y=UT(A,this.rtpCapabilities.recv.videoCodecs);A.push(...Y)}this._rtpCapabilities.recv.videoCodecs=A;const V=this.localCapabilities.send,B=this.rtpCapabilities.recv,K=ic(_t.VIDEO,B,V,m);return M.forEach(Y=>{const J=K.map(lt=>lt.payloadType.toString(10));E.debug("updateRemoteCodec mid: ".concat(Y.attributes.mid,", from ").concat(Y.attributes.payloads," to ").concat(K)),Y.attributes.payloads=K,Y.media.fmts=J}),!0}createOrRecycleSendMedia(f,C,m,g,y){const A=this.rtpCapabilities.send,k=f===_t.VIDEO?A.videoCodecs:A.audioCodecs,M=f===_t.VIDEO?A.videoExtensions:A.audioExtensions;this.currentMidIndex+=1;const V="".concat(this.currentMidIndex);let B={media:{mediaType:f,port:kl,protos:["UDP","TLS","RTP","SAVPF"],fmts:k.map(Y=>Y.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:M,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:C,ssrcGroups:m,rtcpFeedbackWildcards:[],payloads:k,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:g,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(V)}};B=this.mungSendMediaDesc(B,y);const K=this.findFirstClosedMedia(f);if(K){const Y=this.sessionDesc.mediaDescriptions.indexOf(K);this.sessionDesc.mediaDescriptions[Y]=B}else this.sessionDesc.mediaDescriptions.push(B);return B}updateBundleMids(){this.sessionDesc.attributes.groups[0].identificationTag=this.sessionDesc.mediaDescriptions.filter(f=>f.media.port!=="0").map(f=>f.attributes.mid)}mungRecvMediaDsec(f,C,m){const g=Ne(f);return Df(g),ra(g,C),Pf(g,C),LT(g),Dd(g,m,this.localCapabilities.send),g}mungSendMediaDesc(f,C){const m=Ne(f);return Dd(m,C,this.localCapabilities.recv),_o(m),m}updateRecvMedia(f,C){const m=this.sessionDesc.mediaDescriptions.findIndex(g=>g.attributes.mid===f);if(m!==-1){const g=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[m],C);this.sessionDesc.mediaDescriptions[m]=g}}bumpMid(f){this.currentMidIndex+=f}findFirstClosedMedia(f){return this.sessionDesc.mediaDescriptions.find(C=>ye()?C.media.port==="0"&&C.media.mediaType===f:C.media.port==="0")}findPreloadMediaDesc(f){return this.sessionDesc.mediaDescriptions.find(C=>{var m;return((m=C.attributes)===null||m===void 0||(m=m.ssrcs[0])===null||m===void 0?void 0:m.ssrcId)===f[0].ssrcId})}getSSRC(f){var C;return(C=this.sessionDesc.mediaDescriptions.find(m=>m.attributes.mid===f))===null||C===void 0?void 0:C.attributes.ssrcs}}({remoteIceParameters:e,remoteDtlsParameters:n,candidates:i,remoteRTPCapabilities:r,remoteSetup:o,localCapabilities:this.localCapabilities,cname:s}),Array.isArray(this.remoteCodecs)&&this.remoteCodecs.length>0&&this.remoteSDP.updateRemoteCodec([],this.remoteCodecs,this.store.codec);const a=this.remoteSDP.toString(),c=je.parse(this.initialOffer.sdp),d=c.mediaDescriptions.find(f=>f.media.mediaType==="audio");d&&_o(d),this.useXR&&Lf(c);const u=je.print(c),l=this.logSDPExchange(u||"","offer","local","connect");this.store.descriptionStart(),await this.peerConnection.setLocalDescription({type:"offer",sdp:u}),l==null||l(a),await this.peerConnection.setRemoteDescription({type:"answer",sdp:a});const p=this.peerConnection.getTransceivers()[0];if(p!=null&&p.receiver&&this.tryBindTransportEvents(p.receiver),N("PRELOAD_MEDIA_COUNT")>0){this.remoteSDP.preloadRemoteMedia();const f=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:f});const C=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(C)}}catch(a){throw new G(b.EXCHANGE_SDP_FAILED,"P2PConnection.connect failed; ".concat(a.toString()))}}send(e,n,i){var r=this;return Hi(function*(){const o=yield Mt(r.mutex.lock("From P2PConnection.send"));try{if(!r.remoteSDP)throw new Error("Cannot call P2PConnection.send before remote SDP created");const s=[];e.forEach(m=>{const g=r.peerConnection.addTransceiver(m._mediaStreamTrack,{direction:"sendonly"});s.push(g),m._updateRtpTransceiver(g)}),ye()&&N("SIMULCAST")===!0&&(yield Mt(r.applySimulcastForFirefox(s,e)));const a=yield Mt(r.peerConnection.createOffer()),c=r.remoteSDP.predictReceivingMids(e.length),d=r.mungSendOfferSDP(a.sdp,e,c),u=je.parse(d),l=c.map(m=>{const g=u.mediaDescriptions.find(y=>y.attributes.mid===m);if(!g)throw new Error("Cannot extract ssrc from mediaDescription.");return PT(g,N("USE_PUB_RTX"))});let p;try{p=yield l}catch(m){p=[],r.remoteSDP.receive(e,n,i,p);const g=r.remoteSDP.toString();throw yield Mt(r.peerConnection.setLocalDescription({type:"offer",sdp:d})),yield Mt(r.peerConnection.setRemoteDescription({type:"answer",sdp:g})),yield Mt(r.stopSending(c,!0)),m}r.remoteSDP.receive(e,n,i,p);const f=r.remoteSDP.toString(),C=r.logSDPExchange(d,"offer","local","send");return yield Mt(r.peerConnection.setLocalDescription({type:"offer",sdp:d})),yield Mt(r.applySimulcastEncodings(s,e)),yield Mt(r.applySendEncodings(s,e)),C==null||C(f),yield Mt(r.peerConnection.setRemoteDescription({type:"answer",sdp:f})),s.map((m,g)=>{const y=c[g];return{localSSRC:l[g],id:y,transceiver:m}})}catch(s){throw s instanceof G?s:new G(b.EXCHANGE_SDP_FAILED,"P2PConnection.send failed; ".concat(s.toString()))}finally{o()}})()}async createDataChannels(e,n){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.createDataChannels before remote SDP created");let i=this.dataStreamChannelMap.get(e);if(i&&i.readyState==="open")E.debug("[P2PConnection] Channels are already available and can be reused directly.");else{const o=this.currentDataChannelId<1023?this.currentDataChannelId++:this.recoveredDataChannelIds.shift();if(typeof o!="number")throw new Error("create DataChannel error, because cannot get dc id");i=this.peerConnection.createDataChannel("datastream-channel",{id:o,negotiated:!0,ordered:!1,maxRetransmits:N("DATASTREAM_MAX_RETRANSMITS")}),i.binaryType="arraybuffer",this.dataStreamChannelMap.set(e,i)}n.forEach(o=>{o._updateOriginDataChannel(i)});const{needExchangeSDP:r}=this.remoteSDP.sendDataChannel();if(r){const o=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:o});const s=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(s),E.debug("[P2PConnection] createDataChannels by exchanging SDP.")}else E.debug("[P2PConnection] createDataChannels no need to exchange SDP.");return}catch(i){throw i instanceof G?i:new G(b.EXCHANGE_SDP_FAILED,"P2PConnection.createDataChannels failed; ".concat(i.toString()))}}async stopDataChannels(e){try{const n=this.dataStreamChannelMap.get(e);return n&&(n.id&&this.recoveredDataChannelIds.push(n.id),n.close()),void this.dataStreamChannelMap.delete(e)}catch(n){throw n instanceof G?n:new G(b.DATACHANNEL_FAILED,"P2PConnection.stopDataChannels failed; ".concat(n.toString()))}}async stopSending(e,n){const i=n?void 0:await this.mutex.lock("From P2PConnection.stopSending");try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopSending before remote SDP created");const r=this.peerConnection.getTransceivers().filter(c=>e.indexOf(c.mid)!==-1);if(r.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length when trying to call P2PConnection.stopSending.");r.map(c=>{var d;jf(this.id+c.mid),c.direction="inactive",(d=c.stop)===null||d===void 0||d.call(c)});const o=await this.peerConnection.createOffer(),s=this.logSDPExchange(o.sdp||"","offer","local","stopSending");await this.peerConnection.setLocalDescription(o),this.remoteSDP.stopReceiving(e);const a=this.remoteSDP.toString();s==null||s(a),await this.peerConnection.setRemoteDescription({type:"answer",sdp:a})}catch(r){throw new G(b.EXCHANGE_SDP_FAILED,"P2PConnection.stopSending failed; ".concat(r.toString()))}finally{i&&i()}}async receive(e,n,i,r){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.receive ".concat(e," before remoteSDP created."));const{mid:o,needExchangeSDP:s}=this.remoteSDP.send(e,n,i,r);if(s){const c=this.remoteSDP.toString(),d=this.logSDPExchange(c,"offer","remote","receive");await this.peerConnection.setRemoteDescription({type:"offer",sdp:c});const u=await this.peerConnection.createAnswer(),l=this.mungReceiveAnswerSDP(u.sdp,o,e);d==null||d(l||""),await this.peerConnection.setLocalDescription({type:"answer",sdp:l}),E.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(e," by exchanging SDP."))}else E.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(e," no need to exchange SDP."));const a=this.peerConnection.getTransceivers().find(c=>c.mid===o);if(!a)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:a.receiver.track,id:o,transceiver:a}}catch(o){throw new G(b.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(o.toString()))}}async batchReceive(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.batchReceive before remoteSDP created.");const{mids:n,needExchangeSDP:i}=this.remoteSDP.batchSend(e);if(i){const r=this.remoteSDP.toString(),o=this.logSDPExchange(r,"offer","remote","receive");await this.peerConnection.setRemoteDescription({type:"offer",sdp:r});const s=await this.peerConnection.createAnswer();o==null||o(s.sdp||""),await this.peerConnection.setLocalDescription(s),E.debug("[".concat(this.store.clientId,"] [P2PConnection] batchReceive by exchanging SDP."))}else E.debug("[".concat(this.store.clientId,"] [P2PConnection] batchReceive no need to exchange SDP."));return n.map(r=>{const o=this.peerConnection.getTransceivers().find(s=>s.mid===r);if(!o)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:o.receiver.track,id:r,transceiver:o}})}catch(n){throw new G(b.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(n.toString()))}}async stopReceiving(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopReceiving before remote SDP created.");this.remoteSDP.stopSending(e);const n=this.remoteSDP.toString(),i=this.logSDPExchange(n,"offer","remote","stopReceiving");await this.peerConnection.setRemoteDescription({type:"offer",sdp:n});const r=await this.peerConnection.createAnswer();i==null||i(r.sdp||""),await this.peerConnection.setLocalDescription(r)}catch(n){throw new G(b.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(n.toString()))}}async muteRemote(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.muteRemote mid=".concat(e," before remote SDP created."));this.remoteSDP.mute(e);const n=this.remoteSDP.toString(),i=this.logSDPExchange(n,"offer","remote","muteRemote");await this.peerConnection.setRemoteDescription({type:"offer",sdp:n});const r=await this.peerConnection.createAnswer();i==null||i(r.sdp||""),await this.peerConnection.setLocalDescription(r)}catch(n){throw new G(b.EXCHANGE_SDP_FAILED,"P2PConnection.muteRemote failed; ".concat(n.toString()))}}async unmuteRemote(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteRemote mid=".concat(e," before remote SDP created."));this.remoteSDP.unmute(e);const n=this.remoteSDP.toString(),i=this.logSDPExchange(n,"offer","remote","unmuteRemote");await this.peerConnection.setRemoteDescription({type:"offer",sdp:n});const r=await this.peerConnection.createAnswer();i==null||i(r.sdp||""),await this.peerConnection.setLocalDescription(r)}catch(n){throw new G(b.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteRemote failed; ".concat(n.toString()))}}async muteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.muteLocal before remote SDP created.");const n=this.peerConnection.getTransceivers().filter(s=>s.mid&&e.indexOf(s.mid)!==-1);if(n.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length.");n.map(s=>{s.direction="inactive"});const i=await this.peerConnection.createOffer(),r=this.logSDPExchange(i.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(i),this.remoteSDP.muteRemote(e);const o=this.remoteSDP.toString();r==null||r(o),await this.peerConnection.setRemoteDescription({type:"answer",sdp:o})}catch(n){throw new G(b.EXCHANGE_SDP_FAILED,"P2PConnection.muteLocal failed; ".concat(n.toString()))}}async unmuteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteLocal before remote SDP created.");const n=this.peerConnection.getTransceivers().filter(s=>s.mid&&e.indexOf(s.mid)!==-1);if(n.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length.");n.map(async(s,a)=>{s.direction="sendonly"});const i=await this.peerConnection.createOffer(),r=this.logSDPExchange(i.sdp||"","offer","local","unmuteLocal");await this.peerConnection.setLocalDescription(i),this.remoteSDP.unmuteRemote(e);const o=this.remoteSDP.toString();r==null||r(o),await this.peerConnection.setRemoteDescription({type:"answer",sdp:o})}catch(n){throw new G(b.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteLocal failed; ".concat(n.toString()))}}restartICE(e){var n=this;return Hi(function*(){const i=yield Mt(n.mutex.lock("From P2PConnection.restartICE"));try{if(!n.remoteSDP)throw new Error("Cannot restartICE before remoteSDP created.");if(zt().supportPCSetConfiguration){const d=n.peerConnection.getConfiguration(),u=e===ai.RELAY?"relay":"all";d.iceTransportPolicy!==u&&(E.debug("[".concat(n.store.clientId,"] restartICE change iceTransportPolicy from [").concat(d.iceTransportPolicy,"] to [").concat(u,"]")),d.iceTransportPolicy=u,n.peerConnection.setConfiguration(d))}else if(e===ai.RELAY)return;n.remoteSDP.updateCandidates(e);const r=yield Mt(n.peerConnection.createOffer({iceRestart:!0}));if(!r.sdp)throw new Error("Cannot restartICE because restart offer SDP does not exist.");const o=fo(r.sdp),{remoteIceParameters:s}=yield o.iceParameters;n.remoteSDP.restartICE(s);const a=n.remoteSDP.toString(),c=n.logSDPExchange(r.sdp||"","offer","local","restartICE");n.store.descriptionStart(),yield Mt(n.peerConnection.setLocalDescription(r)),c==null||c(a),yield Mt(n.peerConnection.setRemoteDescription({type:"answer",sdp:a}))}catch(r){E.warning("[".concat(n.store.clientId,"] restart ICE failed, abort operation"),r)}finally{i()}})()}close(){var e;this.peerConnection.getTransceivers().forEach(n=>{jf(this.id+n.mid)}),this.peerConnection.close(),(e=this.onConnectionStateChange)===null||e===void 0||e.call(this,"closed"),this.tryUnbindTransportEvents(),this.unbindPCEvents(),this.unbindStatsEvents(),this.removeAllListeners(),this.transportEventReceiver=void 0,this.statsFilter.destroy(),this.dataStreamChannelMap.clear(),this.recoveredDataChannelIds=[],this.currentDataChannelId=1}getStats(){return da(da({},this.statsFilter.getStats()),{},{qualityLimitationReason:this.qualityLimitationReason})}getRemoteVideoIsReady(e){return this.statsFilter.getVideoIsReady(e)}async updateEncoderConfig(e,n){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.updateEncoderConfig before remote SDP created.");const i=await this.peerConnection.createOffer(),r=this.mungSendOfferSDP(i.sdp,[n],[e]);this.remoteSDP.updateRecvMedia(e,n);const o=this.remoteSDP.toString(),s=this.logSDPExchange(r,"offer","local","updateEncoderConfig");await this.peerConnection.setLocalDescription({type:"offer",sdp:r}),s==null||s(o),await this.peerConnection.setRemoteDescription({type:"answer",sdp:o})}catch(i){throw new G(b.EXCHANGE_SDP_FAILED,i.toString())}}async updateSendParameters(e,n){const i=this.peerConnection.getTransceivers().filter(r=>r.mid===e);i.length===1&&(this.isVP8Simulcast(n)?ye()||await this.applySimulcastEncodings(i,[n]):await this.applySendEncodings(i,[n]))}setStatsRemoteVideoIsReady(e,n){this.statsFilter.setVideoIsReady2(e,n)}async replaceTrack(e,n){const i=this.peerConnection.getTransceivers().find(r=>r.mid===n);i&&await i.sender.replaceTrack(e._mediaStreamTrack)}async getSelectedCandidatePair(){const e=this.peerConnection.getReceivers();if(e.length>0&&e[0].transport&&e[0].transport.iceTransport&&e[0].transport.iceTransport.getSelectedCandidatePair&&e[0].transport.iceTransport.getSelectedCandidatePair()){const n=e[0].transport.iceTransport,{local:i,remote:r}=n.getSelectedCandidatePair();return{local:da(da({},Yo),{},{candidateType:i.type,protocol:i.protocol,address:i.address,port:i.port}),remote:da(da({},Yo),{},{candidateType:r.type,protocol:r.protocol,address:r.address,port:r.port})}}return this.statsFilter.getSelectedCandidatePair()}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var e;(e=this.onICEConnectionStateChange)===null||e===void 0||e.call(this,this.peerConnection.iceConnectionState)},this.peerConnection.onconnectionstatechange=()=>{var e;(e=this.onConnectionStateChange)===null||e===void 0||e.call(this,this.peerConnection.connectionState)},this.peerConnection.onicecandidate=e=>{e.candidate?this.localCandidateCount+=1:(this.peerConnection.onicecandidate=null,this.allCandidatesReceived=!0,E.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount))},setTimeout(()=>{this.allCandidatesReceived||(this.allCandidatesReceived=!0,E.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] onicecandidate timeout, local candidate count"),this.localCandidateCount))},N("CANDIDATE_TIMEOUT"))}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null}static resolvePCConfiguration(e){const n={iceServers:[]};return e.iceServers?n.iceServers=e.iceServers:e.turnServer&&e.turnServer.mode!=="off"&&(Zc(e.turnServer.servers)?n.iceServers=e.turnServer.servers:(n.iceServers&&n.iceServers.push(...Bl.turnServerConfigToIceServers(e.turnServer.servers)),N("USE_TURN_SERVER_OF_GATEWAY")&&n.iceServers&&e.turnServer.serversFromGateway&&n.iceServers.push(...Bl.turnServerConfigToIceServers(e.turnServer.serversFromGateway)),N("FORCE_TURN_TCP")?n.iceTransportPolicy="relay":e.turnServer.servers.concat(e.turnServer.serversFromGateway||[]).forEach(i=>{i.forceturn&&(n.iceTransportPolicy="relay")}))),N("ENABLE_ENCODED_TRANSFORM")&&zt().supportWebRTCEncodedTransform&&(n.encodedInsertableStreams=!0),n}static turnServerConfigToIceServers(e){const n=[];return e.forEach(i=>{i.security?i.tcpport&&n.push({username:i.username,credential:i.password,credentialType:"password",urls:"turns:".concat(Xs(i.turnServerURL),":").concat(i.tcpport,"?transport=tcp")}):(i.udpport&&!N("FORCE_TURN_TCP")&&n.push({username:i.username,credential:i.password,credentialType:"password",urls:"turn:".concat(i.turnServerURL,":").concat(i.udpport,"?transport=udp")}),i.tcpport&&n.push({username:i.username,credential:i.password,credentialType:"password",urls:"turn:".concat(i.turnServerURL,":").concat(i.tcpport,"?transport=tcp")}))}),n}tryBindTransportEvents(e){const n=e.transport;if(n){this.transportEventReceiver=e,n.onstatechange=()=>{var r;n!=null&&n.state&&((r=this.onDTLSTransportStateChange)===null||r===void 0||r.call(this,n.state))},n.onerror=r=>{var o;(o=this.onDTLSTransportError)===null||o===void 0||o.call(this,"error"in r?r.error:r)};const i=n.iceTransport;i&&(i.onstatechange=()=>{const r=n==null?void 0:n.iceTransport.state;var o;r&&((o=this.onICETransportStateChange)===null||o===void 0||o.call(this,r))},i.getSelectedCandidatePair&&(i.onselectedcandidatepairchange=()=>{if(i.getSelectedCandidatePair()){const{local:r,remote:o}=i.getSelectedCandidatePair();E.info("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] selectedcandidatepairchange: local ").concat(JSON.stringify({candidateType:r.type,protocol:r.protocol}),", remote ").concat(JSON.stringify({candidateType:o.type,protocol:o.protocol,address:o.address,port:o.port})," )"))}}))}}tryUnbindTransportEvents(){this.transportEventReceiver&&this.transportEventReceiver.transport&&(this.transportEventReceiver.transport.onstatechange=null,this.transportEventReceiver.transport.onerror=null,this.transportEventReceiver.transport.iceTransport&&(this.transportEventReceiver.transport.iceTransport.onstatechange=null))}async updateRtpSenderEncodings(e,n){var i,r;if(n||(n=this.peerConnection.getSenders().find(g=>g.track===e._mediaStreamTrack)),!n)return E.warn("[".concat(e.getTrackId(),"] no rtpSender found}"));if(this.isVP8Simulcast(e))return E.warn("[updateRtpSenderEncodings] Track is VP8 simulcast, please apply simulcast encodings");if(!zt().supportSetRtpSenderParameters)return E.warn("[updateRtpSenderEncodings] Browser not support set rtp-sender parameters");const o={},s={};switch(e._optimizationMode){case"motion":o.degradationPreference="maintain-framerate";break;case"detail":o.degradationPreference="maintain-resolution";break;case"balanced":o.degradationPreference="balanced"}const a=function(m,g){return m.getTransceivers().find(y=>y.sender.track===g||y.receiver.track===g)}(this.peerConnection,e._mediaStreamTrack),c=LW(e);if(u3(e)&&a&&n&&c&&this.getLocalVideoStats&&it(i=["vp8","vp9"]).call(i,this.store.codec)){var d;const m=o.degradationPreference||(it(d=e._hints).call(d,De.CUSTOM_TRACK)?N("CUSTOM_ADAPTATION_DEFAULT_MODE"):"maintain-framerate");(function(g,y,A,k,M,V){if(jf(g),k!=="balanced"&&k!=="maintain-framerate"&&k!=="maintain-resolution")return;let B=-1;RN(g,y);const K=window.setInterval(()=>{const J=Ff.get(g);if(!N("ENABLE_AG_ADAPTATION")||!J)return void jf(g);const lt=V();if(lt.sendPackets>0&&lt.OutgoingAvailableBandwidth>0){if(B===-1)return void(B=Date.now());if(Date.now()-B<1e3)return;const Yt=lt.sendFrameRate,de=lt.OutgoingAvailableBandwidth,[Pe,hn]=d3(g,Yt,de,J.adaptationConfig,y,k);hn&&(A.qualityLimitationReason=hn),Pe&&J.adaptationConfig.scale!==Pe.scale&&(E.debug("[".concat(g,"] applyAdaptation: ").concat(A.qualityLimitationReason,`
           sendFps `).concat(Yt,", bwe ").concat(de,", switch from ").concat(J.adaptationConfig.scale," to ").concat(Pe.scale," ")),J.adaptationConfig=jT(jT({},J.adaptationConfig),Pe),M(Pe))}},N("CHECK_LOCAL_STATS_INTERVAL")),Y=jT({},y);Ff.set(g,{timer:K,adaptationConfig:Y,originConfig:y,adaptationFunc:M}),E.debug("[".concat(g,"] start adaptation, originConfig: ").concat(JSON.stringify(y),", degradationPreference: ").concat(k))})(this.id+a.mid,c,this,m,g=>{n&&this.updateAdaptation(n,g)},this.getLocalVideoStats.bind(this))}if(e._encoderConfig){var u;const{bitrateMax:m,frameRate:g,scaleResolutionDownBy:y}=e._encoderConfig;m&&(s.maxBitrate=1e3*m),(it(u=e._hints).call(u,De.LOW_STREAM)||e.isUseScaleResolutionDownBy)&&(g&&(s.maxFramerate=Pi(g)),y&&y>=1&&(s.scaleResolutionDownBy=y))}const{maxFramerate:l}=N("ENCODER_CONFIG_LIMIT");if(l&&typeof l=="number"&&(s.maxFramerate=s.maxFramerate?Math.min(s.maxFramerate,l):l),N("DSCP_TYPE")&&Ws()){var p;const m=N("DSCP_TYPE");it(p=["very-low","low","medium","high"]).call(p,m)&&(s.networkPriority=m)}const f=n.getParameters(),C=(r=f.encodings)===null||r===void 0?void 0:r[0];ye()&&!C&&(o.encodings=[s]),C&&Object.assign(C,s),Object.assign(f,o),E.debug("[".concat(e.getTrackId(),"] updateRtpSenderEncodings: ").concat(JSON.stringify(f.encodings))),await n.setParameters(f)}async updateAdaptation(e,n){var i,r;if(!e)return E.debug("[updateAdaptation] no rtpSender found");if(!zt().supportSetRtpSenderParameters)return E.debug("[updateAdaptation] Browser not support set rtp-sender parameters");const o={},{bitrateMax:s,frameRate:a,scaleResolutionDownBy:c}=n;s&&(o.maxBitrate=1e3*s),a&&(o.maxFramerate=Pi(a)),c&&c>=1&&it(i=["vp8","vp9"]).call(i,this.store.codec)&&(o.scaleResolutionDownBy=c);const d=e.getParameters(),u=(r=d.encodings)===null||r===void 0?void 0:r[0];u&&Object.assign(u,o),Object.assign(d,{});try{await e.setParameters(d),E.debug("[updateAdaptation] updateRtpSenderEncodings: ".concat(JSON.stringify(d.encodings)))}catch(l){!("transport"in e)||e.transport&&e.transport.state==="connected"?this.peerConnectionState!=="connected"?E.debug("[updateAdaptation] peerConnection not connected}"):E.debug("[updateAdaptation] updateRtpSenderEncodings failed",l):E.debug("[updateAdaptation] rtpSender transport not connected}")}}async applySendEncodings(e,n){try{if(!zt().supportSetRtpSenderParameters||e.length!==n.length)return;for(let i=0;i<e.length;i++){const r=e[i],o=n[i];o instanceof Ae&&!this.isVP8Simulcast(o)&&await this.updateRtpSenderEncodings(o,r.sender)}}catch{E.debug("[".concat(this.store.clientId,"] Apply RTPSendEncodings failed."))}}mungSendOfferSDP(e,n,i){const r=je.parse(e);return n.forEach((o,s)=>{const a=i[s],c=r.mediaDescriptions.find(d=>d.attributes.mid===a);c&&(ra(c,o),kT(c,o,this.store.codec))}),je.print(r)}mungReceiveAnswerSDP(e,n,i){const r=je.parse(e),o=r.mediaDescriptions.find(s=>s.attributes.mid===n);return o&&(i===_t.AUDIO&&o.media.mediaType==="audio"&&_o(o),this.useXR&&Lf(r)),je.print(r)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=e=>{var n;(n=this.onFirstAudioReceived)===null||n===void 0||n.call(this,e)},this.statsFilter.onFirstVideoReceived=e=>{var n;(n=this.onFirstVideoReceived)===null||n===void 0||n.call(this,e)},this.statsFilter.onFirstAudioDecoded=e=>{var n;(n=this.onFirstAudioDecoded)===null||n===void 0||n.call(this,e)},this.statsFilter.onFirstVideoDecoded=(e,n,i)=>{var r;(r=this.onFirstVideoDecoded)===null||r===void 0||r.call(this,e,n,i)},this.statsFilter.onSelectedLocalCandidateChanged=(e,n)=>{var i;(i=this.onSelectedLocalCandidateChanged)===null||i===void 0||i.call(this,e,n)},this.statsFilter.onSelectedRemoteCandidateChanged=(e,n)=>{var i;(i=this.onSelectedRemoteCandidateChanged)===null||i===void 0||i.call(this,e,n)},this.statsFilter.onFirstVideoDecodedTimeout=e=>{var n;(n=this.onFirstVideoDecodedTimeout)===null||n===void 0||n.call(this,e)}}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0,this.statsFilter.onFirstVideoDecodedTimeout=void 0}async applySimulcastForFirefox(e,n){if(e.length===n.length)for(let c=0;c<e.length;c++){var i,r,o,s,a;const d=e[c],u=n[c];if(u instanceof Ae&&!it(i=u._hints).call(i,De.LOW_STREAM)&&(r=u._encoderConfig)!==null&&r!==void 0&&r.bitrateMax&&((o=u._encoderConfig)===null||o===void 0?void 0:o.bitrateMax)>200&&(s=u._scalabilityMode)!==null&&s!==void 0&&s.numSpatialLayers&&((a=u._scalabilityMode)===null||a===void 0?void 0:a.numSpatialLayers)>1&&this.store.codec==="vp8"){const l={},p={high:1e3*(u._encoderConfig.bitrateMax-50),medium:5e4};l.encodings=[{rid:"m",active:!0,maxBitrate:p.medium,scaleResolutionDownBy:4},{rid:"h",active:!0,maxBitrate:p.high}];const f=d.sender.getParameters();await d.sender.setParameters(Object.assign(f,l))}}}async applySimulcastEncodings(e,n){if(!ye()&&e.length===n.length)for(let i=0;i<e.length;i++){const r=n[i];if(r instanceof Ae&&this.isVP8Simulcast(r)){const o=e[i],s={},a={high:1e3*(r._encoderConfig.bitrateMax-50),medium:5e4};s.encodings=[{active:!0,adaptivePtime:!1,networkPriority:"high",priority:"high",maxBitrate:a.high},{active:!0,adaptivePtime:!1,networkPriority:"low",priority:"low",maxBitrate:a.medium,scaleResolutionDownBy:4}];const c=o.sender.getParameters();await o.sender.setParameters(Object.assign(c,s))}}}isVP8Simulcast(e){var n,i,r,o,s;return!!(e instanceof Ae&&N("SIMULCAST")&&this.store.codec==="vp8"&&!it(n=e._hints).call(n,De.LOW_STREAM)&&(i=e._encoderConfig)!==null&&i!==void 0&&i.bitrateMax&&((r=e._encoderConfig)===null||r===void 0?void 0:r.bitrateMax)>200&&(o=e._scalabilityMode)!==null&&o!==void 0&&o.numSpatialLayers&&((s=e._scalabilityMode)===null||s===void 0?void 0:s.numSpatialLayers)>1)}logSDPExchange(e,n,i,r){if(N("SDP_LOGGING"))return E.upload("[".concat(this.store.clientId,"] exchanging ").concat(i," ").concat(n," SDP during P2PConnection.").concat(r,`
`),e),n==="offer"?o=>{this.logSDPExchange(o,"answer",i==="local"?"remote":"local",r)}:void 0}async getRemoteSSRC(e){if(!this.remoteSDP)return;const n=this.remoteSDP.getSSRC(e);return n==null?void 0:n[0].ssrcId}setConfiguration(e){if(zt().supportPCSetConfiguration){const n=Bl.resolvePCConfiguration(e);this.peerConnection.setConfiguration(n)}}},nt(ee.prototype,"updateRemoteRTPCapabilities",[Li],Object.getOwnPropertyDescriptor(ee.prototype,"updateRemoteRTPCapabilities"),ee.prototype),nt(ee.prototype,"connect",[Li],Object.getOwnPropertyDescriptor(ee.prototype,"connect"),ee.prototype),nt(ee.prototype,"createDataChannels",[Li],Object.getOwnPropertyDescriptor(ee.prototype,"createDataChannels"),ee.prototype),nt(ee.prototype,"receive",[Li],Object.getOwnPropertyDescriptor(ee.prototype,"receive"),ee.prototype),nt(ee.prototype,"batchReceive",[Li],Object.getOwnPropertyDescriptor(ee.prototype,"batchReceive"),ee.prototype),nt(ee.prototype,"stopReceiving",[Li],Object.getOwnPropertyDescriptor(ee.prototype,"stopReceiving"),ee.prototype),nt(ee.prototype,"muteRemote",[Li],Object.getOwnPropertyDescriptor(ee.prototype,"muteRemote"),ee.prototype),nt(ee.prototype,"unmuteRemote",[Li],Object.getOwnPropertyDescriptor(ee.prototype,"unmuteRemote"),ee.prototype),nt(ee.prototype,"muteLocal",[Li],Object.getOwnPropertyDescriptor(ee.prototype,"muteLocal"),ee.prototype),nt(ee.prototype,"unmuteLocal",[Li],Object.getOwnPropertyDescriptor(ee.prototype,"unmuteLocal"),ee.prototype),nt(ee.prototype,"close",[Li],Object.getOwnPropertyDescriptor(ee.prototype,"close"),ee.prototype),nt(ee.prototype,"updateEncoderConfig",[Li],Object.getOwnPropertyDescriptor(ee.prototype,"updateEncoderConfig"),ee.prototype),nt(ee.prototype,"updateSendParameters",[Li],Object.getOwnPropertyDescriptor(ee.prototype,"updateSendParameters"),ee.prototype),nt(ee.prototype,"replaceTrack",[Li],Object.getOwnPropertyDescriptor(ee.prototype,"replaceTrack"),ee.prototype),nt(ee.prototype,"updateAdaptation",[Li],Object.getOwnPropertyDescriptor(ee.prototype,"updateAdaptation"),ee.prototype),nt(ee.prototype,"getRemoteSSRC",[Li],Object.getOwnPropertyDescriptor(ee.prototype,"getRemoteSSRC"),ee.prototype),ee);function Li(t,e,n){const i=t[e];if(typeof i!="function")throw new Error("Cannot use mutex on object property.");return n.value=async function(){const r=this.mutex,o=await r.lock("From P2PConnection.".concat(e));try{for(var s=arguments.length,a=new Array(s),c=0;c<s;c++)a[c]=arguments[c];return await i.apply(this,a)}finally{o()}},n}function IN(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),n.push.apply(n,i)}return n}function bN(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?IN(Object(n),!0).forEach(function(i){R(t,i,n[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):IN(Object(n)).forEach(function(i){Object.defineProperty(t,i,Object.getOwnPropertyDescriptor(n,i))})}return t}const AN=`v=0
o=- 0 0 IN IP4 127.0.0.1
s=AgoraGateway
t=0 0
a=group:BUNDLE 0
a=msid-semantic: WMS
a=ice-lite
m=application 9 UDP/DTLS/SCTP webrtc-datachannel
c=IN IP4 127.0.0.1
a=mid:0
`,Bf="9",BT=2e4,GT=4e4;class l3{get localCapabilities(){return Ne(this._localCapabilities)}get rtpCapabilities(){return Ne(this._rtpCapabilities)}get candidates(){return Ne(this._candidates)}get iceParameters(){return Ne(this._iceParameters)}get dtlsParameters(){return Ne(this._dtlsParameters)}constructor(e){R(this,"sessionDesc",void 0),R(this,"_localCapabilities",void 0),R(this,"_rtpCapabilities",void 0),R(this,"_candidates",void 0),R(this,"_iceParameters",void 0),R(this,"_dtlsParameters",void 0),R(this,"setup",void 0),R(this,"currentMidIndex",void 0),R(this,"cname",void 0),R(this,"firefoxSsrcMidMap",new Map),e=Ne(e);const{remoteIceParameters:n,remoteDtlsParameters:i,candidates:r,remoteRTPCapabilities:o,remoteSetup:s,localCapabilities:a,cname:c}=e,d=je.parse(AN);this._rtpCapabilities=o,this._candidates=r,this._iceParameters=n,this._dtlsParameters=i,this._localCapabilities=a,this.setup=s,this.cname=c;const u=this.rtpCapabilities.send;for(const l of d.mediaDescriptions){if(l.attributes.iceUfrag=n.iceUfrag,l.attributes.icePwd=n.icePwd,l.attributes.fingerprints=i.fingerprints,l.attributes.candidates=r,l.attributes.setup=s,l.media.mediaType==="application"&&(l.attributes.sctpPort="5000"),l.media.mediaType==="video"&&(l.media.fmts=u.videoCodecs.map(p=>p.payloadType.toString(10)),l.attributes.payloads=u.videoCodecs,l.attributes.extmaps=u.videoExtensions,N("PRELOAD_MEDIA_COUNT")>0)){const{ssrcs:p,ssrcGroups:f}=ar([{ssrcId:GT,rtx:N("USE_SUB_RTX")?40001:void 0}],this.cname);l.attributes.ssrcs=p,l.attributes.ssrcGroups=f}if(l.media.mediaType==="audio"&&(l.media.fmts=u.audioCodecs.map(p=>p.payloadType.toString(10)),l.attributes.payloads=u.audioCodecs,l.attributes.extmaps=u.audioExtensions,_o(l),N("PRELOAD_MEDIA_COUNT")>0)){const{ssrcs:p,ssrcGroups:f}=ar([{ssrcId:BT}],this.cname);l.attributes.ssrcs=p,l.attributes.ssrcGroups=f}}this.sessionDesc=d,this.currentMidIndex=d.mediaDescriptions.length-1}updateRemoteRTPCapabilities(e){const n=je.parse(AN);this._rtpCapabilities=e;const i=this.rtpCapabilities.send;for(const r of n.mediaDescriptions){if(r.attributes.iceUfrag=this._iceParameters.iceUfrag,r.attributes.icePwd=this._iceParameters.icePwd,r.attributes.fingerprints=this._dtlsParameters.fingerprints,r.attributes.candidates=this._candidates,r.attributes.setup=this.setup,r.media.mediaType==="application"&&(r.attributes.sctpPort="5000"),r.media.mediaType==="video"&&(r.media.fmts=i.videoCodecs.map(o=>o.payloadType.toString(10)),r.attributes.payloads=i.videoCodecs,r.attributes.extmaps=i.videoExtensions,N("PRELOAD_MEDIA_COUNT")>0)){const{ssrcs:o,ssrcGroups:s}=ar([{ssrcId:GT,rtx:N("USE_SUB_RTX")?40001:void 0}],this.cname);r.attributes.ssrcs=o,r.attributes.ssrcGroups=s}if(r.media.mediaType==="audio"&&(r.media.fmts=i.audioCodecs.map(o=>o.payloadType.toString(10)),r.attributes.payloads=i.audioCodecs,r.attributes.extmaps=i.audioExtensions,N("PRELOAD_MEDIA_COUNT")>0)){const{ssrcs:o,ssrcGroups:s}=ar([{ssrcId:BT}],this.cname);r.attributes.ssrcs=o,r.attributes.ssrcGroups=s}}this.sessionDesc=n,this.currentMidIndex=n.mediaDescriptions.length-1}preloadRemoteMedia(e){this.rtpCapabilities;const n=this.candidates,i=this.dtlsParameters,r=this.iceParameters,o=this.rtpCapabilities.send;for(let s=1;s<e;s++){const a=2*s+BT,c=2*s+GT,{ssrcs:d,ssrcGroups:u}=ar([{ssrcId:a}],this.cname),{ssrcs:l,ssrcGroups:p}=ar([{ssrcId:c,rtx:N("USE_SUB_RTX")?c+1:void 0}],this.cname);this.sessionDesc.mediaDescriptions.push({media:{mediaType:"video",port:Bf,protos:["UDP","TLS","RTP","SAVPF"],fmts:o.videoCodecs.map(f=>f.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:r.iceUfrag,icePwd:r.icePwd,unrecognized:[],candidates:n,extmaps:o.videoExtensions,fingerprints:i.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:l,ssrcGroups:p,rtcpFeedbackWildcards:[],payloads:o.videoCodecs,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:"sendonly",rtcpMux:!0,rtcpRsize:!0,mid:"".concat(2*s-1)}}),this.sessionDesc.mediaDescriptions.push({media:{mediaType:"audio",port:Bf,protos:["UDP","TLS","RTP","SAVPF"],fmts:o.audioCodecs.map(f=>f.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:r.iceUfrag,icePwd:r.icePwd,unrecognized:[],candidates:n,extmaps:o.audioExtensions,fingerprints:i.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:d,ssrcGroups:u,rtcpFeedbackWildcards:[],payloads:o.audioCodecs,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:"sendonly",rtcpMux:!0,rtcpRsize:!0,mid:"".concat(2*s)}}),this.currentMidIndex+=2}this.updateBundleMids()}toString(){return je.print(this.sessionDesc)}send(e,n,i,r){const{ssrcs:o,ssrcGroups:s}=ar(n,this.cname,N("SYNC_GROUP")?i:void 0),a=this.findPreloadMediaDesc(o);if(a){if(ye()&&this.firefoxSsrcMidMap.set(o[0].ssrcId,a.attributes.mid),r&&(r.twcc||r.remb)){const c=this.sessionDesc.mediaDescriptions.indexOf(a);return this.sessionDesc.mediaDescriptions[c]=this.mungSendMediaDesc(a,r),{mid:a.attributes.mid,needExchangeSDP:!0}}return{mid:a.attributes.mid,needExchangeSDP:!1}}{const c=this.findAvailableMediaIndex(e,o);let d;return c===-1||An()||Qn()||UI()||c===0&&N("USE_SUB_RTX")?(d=this.createOrRecycleSendMedia(e,o,s,"sendonly",r),this.updateBundleMids()):(d=Ne(this.sessionDesc.mediaDescriptions[c]),d.attributes.direction="sendonly",d.attributes.ssrcs=o,d.attributes.ssrcGroups=s,this.sessionDesc.mediaDescriptions[c]=this.mungSendMediaDesc(d,r)),ye()&&this.firefoxSsrcMidMap.set(o[0].ssrcId,d.attributes.mid),{mid:d.attributes.mid,needExchangeSDP:!0}}}batchSend(e){const n=e.map(o=>{let{kind:s,ssrcMsg:a,mslabel:c}=o;return this.send(s,a,c)}),i=[];let r=!1;return n.forEach(o=>{let{mid:s,needExchangeSDP:a}=o;a&&(r=!0),i.push(s)}),{mids:i,needExchangeSDP:r}}stopSending(e){const n=this.sessionDesc.mediaDescriptions.filter(i=>i.attributes.mid&&e.indexOf(i.attributes.mid)!==-1);if(n.length!==e.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.stopSending.");n.forEach(i=>{i.attributes.mid==="0"||ye()||An()||Qn()?i.attributes.ssrcs=[]:(i.attributes.ssrcs=[],i.attributes.direction="inactive",i.media.port="0")}),this.updateBundleMids()}mute(e){const n=this.sessionDesc.mediaDescriptions.find(i=>i.attributes.mid===e);if(!n)throw new Error("mediaDescription not found with ".concat(e," in remote SDP when calling RemoteSDP.mute."));n.attributes.direction="inactive"}unmute(e){const n=this.sessionDesc.mediaDescriptions.find(i=>i.attributes.mid===e);if(!n)throw new Error("mediaDescription not found with ".concat(e," in remote SDP when calling RemoteSDP.unmute."));n.attributes.direction="sendonly"}muteRemote(e){const n=this.sessionDesc.mediaDescriptions.filter(i=>it(e).call(e,i.attributes.mid||""));if(n.length!==e.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");n.forEach(i=>{i.attributes.direction="inactive"})}unmuteRemote(e){const n=this.sessionDesc.mediaDescriptions.filter(i=>it(e).call(e,i.attributes.mid||""));if(n.length!==e.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");n.forEach(i=>{i.attributes.direction="recvonly"})}receive(e,n,i,r){e.forEach((o,s)=>{this.createOrRecycleRecvMedia(o,[],"recvonly",n,i,r[s])}),this.updateBundleMids()}stopReceiving(e){const n=this.sessionDesc.mediaDescriptions.filter(i=>e.indexOf(i.attributes.mid)!==-1);if(n.length!==e.length)throw new Error("MediaDescriptions' length doesn't match mids's length when calling RemoteSDP.receive.");n.forEach(i=>{i.media.port="0",i.attributes.direction="inactive"}),this.updateBundleMids()}updateCandidates(e){e===ai.TCP?this._candidates.forEach(n=>{this._candidates.findIndex(i=>i.transport==="tcp"&&i.connectionAddress===n.connectionAddress&&i.port===n.port)===-1&&this._candidates.push(bN(bN({},n),{},{foundation:"tcpcandidate",priority:Number(n.priority)-1+"",transport:"tcp",port:Number(n.port)+90+""}))}):this._candidates=this._candidates.filter(n=>n.transport!=="tcp");for(const n of this.sessionDesc.mediaDescriptions)n.attributes.candidates=this.candidates}restartICE(e){e=Ne(e),this._iceParameters=e,this.sessionDesc.mediaDescriptions.forEach(n=>{n.attributes.iceUfrag=e.iceUfrag,n.attributes.icePwd=e.icePwd})}predictReceivingMids(e){const n=[];for(let i=0;i<e;i++)n.push((this.currentMidIndex+i+1).toString(10));return n}findAvailableMediaIndex(e,n){return this.sessionDesc.mediaDescriptions.findIndex(i=>{const r=i.media.mediaType===e&&i.media.port!=="0"&&(i.attributes.direction==="sendonly"||i.attributes.direction==="sendrecv")&&i.attributes.ssrcs.length===0;if(ye()){if(r){const o=this.firefoxSsrcMidMap.get(n[0].ssrcId);return!(o||i.attributes.mid!=="0"&&i.attributes.mid!=="1")||!(!o||o!==i.attributes.mid)}return!1}return r})}createOrRecycleRecvMedia(e,n,i,r,o,s){const a=e._mediaStreamTrack.kind,c=this.rtpCapabilities.recv,d=ic(a,c,this.localCapabilities.send,a===_t.VIDEO?r:o),u=a===_t.VIDEO?c.videoExtensions:c.audioExtensions;this.currentMidIndex+=1;const l="".concat(this.currentMidIndex);let p={media:{mediaType:a,port:Bf,protos:["UDP","TLS","RTP","SAVPF"],fmts:d.map(C=>C.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:u,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:n,ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:d,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:i,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(l)}};p=this.mungRecvMediaDsec(p,e,s);const f=this.findFirstClosedMedia(a);if(f){const C=this.sessionDesc.mediaDescriptions.indexOf(f);this.sessionDesc.mediaDescriptions[C]=p}else this.sessionDesc.mediaDescriptions.push(p);return p}updateRemoteCodec(e,n,i){const r=[...new Set(this._rtpCapabilities.recv.videoCodecs.map(p=>p.rtpMap&&p.rtpMap.encodingName.toLowerCase()||"").filter(p=>{var f;return it(f=Object.keys(ed)).call(f,p)}))],o=new Set(n);if(r.every(p=>o.has(p)))return E.debug("codecs has not changed, no need to updateRemoteCodec, codecs: ".concat(n)),!1;const s=this._rtpCapabilities.recv.videoCodecs.filter(p=>n.some(f=>{var C;return it(C=p.rtpMap&&p.rtpMap.encodingName.toLowerCase()||"").call(C,f)}));if(s.length===0)return E.debug("updateRemoteCodec failed, because cannot find matched codec, remoteCapabilities codecs: ".concat(r," codecs: ").concat(n)),!1;const a=[...new Set(s.map(p=>p.rtpMap&&p.rtpMap.encodingName.toLowerCase()||""))];let c;if(E.debug("updateRemoteCodec, from ".concat(r," to ").concat(a)),e.length===0)c=this.sessionDesc.mediaDescriptions.filter(p=>p.media.mediaType==="video"&&p.attributes.direction==="recvonly");else if(c=this.sessionDesc.mediaDescriptions.filter(p=>p.attributes.mid&&it(e).call(e,p.attributes.mid)&&p.attributes.direction==="recvonly"),c.length!==e.length)return E.debug("updateRemoteCodec failed, because cannot find mids, mids: ".concat(e,", codecs: ").concat(n)),!1;this._rtpCapabilities.recv.videoCodecs=s;const d=this.localCapabilities.send,u=this.rtpCapabilities.recv,l=ic(_t.VIDEO,u,d,i);return c.forEach(p=>{const f=l.map(C=>C.payloadType.toString(10));E.debug("updateRemoteCodec mid: ".concat(p.attributes.mid,", from ").concat(p.attributes.payloads," to ").concat(l)),p.attributes.payloads=l,p.media.fmts=f}),!0}createOrRecycleSendMedia(e,n,i,r,o){const s=this.rtpCapabilities.send,a=e===_t.VIDEO?s.videoCodecs:s.audioCodecs,c=e===_t.VIDEO?s.videoExtensions:s.audioExtensions;this.currentMidIndex+=1;const d="".concat(this.currentMidIndex);let u={media:{mediaType:e,port:Bf,protos:["UDP","TLS","RTP","SAVPF"],fmts:a.map(p=>p.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:c,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:n,ssrcGroups:i,rtcpFeedbackWildcards:[],payloads:a,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:r,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(d)}};u=this.mungSendMediaDesc(u,o);const l=this.findFirstClosedMedia(e);if(l){const p=this.sessionDesc.mediaDescriptions.indexOf(l);this.sessionDesc.mediaDescriptions[p]=u}else this.sessionDesc.mediaDescriptions.push(u);return u}updateBundleMids(){this.sessionDesc.attributes.groups[0].identificationTag=this.sessionDesc.mediaDescriptions.filter(e=>e.media.port!=="0").map(e=>e.attributes.mid)}mungRecvMediaDsec(e,n,i){const r=Ne(e);return Df(r),ra(r,n),Pf(r,n),LT(r),Dd(r,i,this.localCapabilities.send),r}mungSendMediaDesc(e,n){const i=Ne(e);return Dd(i,n,this.localCapabilities.recv),_o(i),i}updateRecvMedia(e,n){const i=this.sessionDesc.mediaDescriptions.findIndex(r=>r.attributes.mid===e);if(i!==-1){const r=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[i],n);this.sessionDesc.mediaDescriptions[i]=r}}bumpMid(e){this.currentMidIndex+=e}findFirstClosedMedia(e){return this.sessionDesc.mediaDescriptions.find(n=>ye()?n.media.port==="0"&&n.media.mediaType===e:n.media.port==="0")}findPreloadMediaDesc(e){return this.sessionDesc.mediaDescriptions.find(n=>{var i;return((i=n.attributes)===null||i===void 0||(i=i.ssrcs[0])===null||i===void 0?void 0:i.ssrcId)===e[0].ssrcId})}getSSRC(e){var n;return(n=this.sessionDesc.mediaDescriptions.find(i=>i.attributes.mid===e))===null||n===void 0?void 0:n.attributes.ssrcs}}var ne;function wN(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),n.push.apply(n,i)}return n}function Gf(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?wN(Object(n),!0).forEach(function(i){R(t,i,n[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):wN(Object(n)).forEach(function(i){Object.defineProperty(t,i,Object.getOwnPropertyDescriptor(n,i))})}return t}let h3=(ne=class e_ extends qp{get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get localCodecs(){let e;return this.localCapabilities&&(e=Pd(this.localCapabilities)),[...new Set(e&&e.send.videoCodecs.map(n=>n.rtpMap&&n.rtpMap.encodingName.toLowerCase()||"").filter(n=>{var i;return it(i=Object.keys(ed)).call(i,n)}))]}constructor(e,n,i){super(e,n),R(this,"store",void 0),R(this,"peerConnection",void 0),R(this,"remoteSDP",void 0),R(this,"initialOffer",void 0),R(this,"transportEventReceiver",void 0),R(this,"statsFilter",void 0),R(this,"useXR",N("USE_XR")),R(this,"localCapabilities",void 0),R(this,"localCandidateCount",0),R(this,"allCandidatesReceived",!1),R(this,"remoteCodecs",void 0),R(this,"dataStreamChannelMap",new Map),R(this,"establishPromise",void 0),R(this,"mutex",new kn("NVExtentionsConnection-mutex")),R(this,"rtcMedia",void 0),this.store=n,this.peerConnection=i,this.statsFilter=Nf(this.peerConnection,N("STATS_UPDATE_INTERVAL"),void 0,ye()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1,this.establishPromise=this.establish()}async establish(e){try{const n=await this.peerConnection.createOffer();if(!n.sdp)throw new Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");const i=fo(n.sdp),r=await MT({filterRTX:!N("USE_PUB_RTX")&&!N("USE_SUB_RTX"),filterVideoFec:N("FILTER_VIDEO_FEC"),filterAudioFec:N("FILTER_AUDIO_FEC"),filterVideoCodec:N("FILTER_VIDEO_CODEC")},{useXR:this.useXR});return this.localCapabilities=r,this.initialOffer=n,Gf(Gf({},i),{},{rtpCapabilities:r,offerSDP:n.sdp})}catch(n){throw new U(b.GET_LOCAL_CONNECTION_PARAMS_FAILED,n.toString())}}async connect(e,n,i,r,o,s){try{if(!this.initialOffer)throw new Error("Cannot establish NVConnection without initial offer.");this.remoteSDP=new l3({remoteIceParameters:e,remoteDtlsParameters:n,candidates:i,remoteRTPCapabilities:r,remoteSetup:o,localCapabilities:Pd(this.localCapabilities),cname:s});const a=this.remoteSDP.toString(),c=je.parse(this.initialOffer.sdp),d=c.mediaDescriptions.find(p=>p.media.mediaType==="audio");d&&_o(d),this.useXR&&Lf(c);const u=je.print(c),l=this.logSDPExchange(u||"","offer","local","connect");await this.peerConnection.setLocalDescription({type:"offer",sdp:u}),l==null||l(a),await this.peerConnection.setRemoteDescription({type:"answer",sdp:a})}catch(a){throw new U(b.EXCHANGE_SDP_FAILED,"NV.connect failed; ".concat(a.toString()))}}async updateRemoteRTPCapabilities(e,n){if(this.remoteCodecs=n,!this.remoteSDP)return void E.debug("[P2PConnection] cannot updateRemoteRTPCapabilities before remote SDP created, local codecs: ".concat(this.localCodecs,", codecs: ").concat(n));if(this.remoteSDP.updateRemoteCodec(e,n,this.store.codec)){const i=await this.peerConnection.createOffer(),r=this.logSDPExchange(i.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(i);const o=this.remoteSDP.toString();r==null||r(o),await this.peerConnection.setRemoteDescription({type:"answer",sdp:o})}else E.debug("[P2PConnection] updateRemoteRTPCapabilities no need to exchange SDP.")}async updateRemoteConnect(e){var n,i,r,o;(n=this.remoteSDP)===null||n===void 0||n.updateRemoteRTPCapabilities(e),Array.isArray(this.remoteCodecs)&&this.remoteCodecs.length>0&&((o=this.remoteSDP)===null||o===void 0||o.updateRemoteCodec([],this.remoteCodecs,this.store.codec)),(i=this.remoteSDP)===null||i===void 0||i.preloadRemoteMedia(2);const s=(r=this.remoteSDP)===null||r===void 0?void 0:r.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:s});const a=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(a),E.debug("[NVExtentionsConnection] updateRemoteRTPCapabilities by exchanging SDP.")}send(e,n,i){var r=this;return Hi(function*(){const o=yield Mt(r.mutex.lock("From NVExtentionsConnection.send"));try{if(!r.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.send before remote SDP created");const s=[];e.forEach(m=>{const g=r.peerConnection.addTransceiver(m._mediaStreamTrack,{direction:"sendonly"});s.push(g)}),ye()&&N("SIMULCAST")===!0&&(yield Mt(r.applySimulcastForFirefox(s,e)));const a=yield Mt(r.peerConnection.createOffer()),c=r.remoteSDP.predictReceivingMids(e.length),d=r.mungSendOfferSDP(a.sdp,e,c),u=je.parse(d),l=c.map(m=>{const g=u.mediaDescriptions.find(y=>y.attributes.mid===m);if(!g)throw new Error("Cannot extract ssrc from mediaDescription.");return PT(g,N("USE_PUB_RTX"))});let p;try{p=yield l}catch(m){p=[],r.remoteSDP.receive(e,n,i,p);const g=r.remoteSDP.toString();throw yield Mt(r.peerConnection.setLocalDescription({type:"offer",sdp:d})),yield Mt(r.peerConnection.setRemoteDescription({type:"answer",sdp:g})),yield Mt(r.stopSending(c,!0)),m}r.remoteSDP.receive(e,n,i,p);const f=r.remoteSDP.toString(),C=r.logSDPExchange(d,"offer","local","send");return yield Mt(r.peerConnection.setLocalDescription({type:"offer",sdp:d})),yield Mt(r.applySimulcastEncodings(s,e)),yield Mt(r.applySendEncodings(s,e)),C==null||C(f),yield Mt(r.peerConnection.setRemoteDescription({type:"answer",sdp:f})),s.map((m,g)=>{const y=c[g];return{localSSRC:l[g],id:y,transceiver:m}})}catch(s){throw s instanceof U?s:new U(b.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.send failed; ".concat(s.toString()))}finally{o()}})()}async stopSending(e,n){const i=n?void 0:await this.mutex.lock("From NVExtentionsConnection.stopSending");try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.stopSending before remote SDP created");const r=this.peerConnection.getTransceivers().filter(c=>e.indexOf(c.mid)!==-1);if(r.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length when trying to call NVExtentionsConnection.stopSending.");r.map(c=>{var d;c.direction="inactive",(d=c.stop)===null||d===void 0||d.call(c)});const o=await this.peerConnection.createOffer(),s=this.logSDPExchange(o.sdp||"","offer","local","stopSending");await this.peerConnection.setLocalDescription(o),this.remoteSDP.stopReceiving(e);const a=this.remoteSDP.toString();s==null||s(a),await this.peerConnection.setRemoteDescription({type:"answer",sdp:a})}catch(r){throw new U(b.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.stopSending failed; ".concat(r.toString()))}finally{i&&i()}}async createDataChannels(e,n){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.createDataChannels before remote SDP created");let i=this.dataStreamChannelMap.get(e);return i&&i.readyState==="open"?E.debug("[P2PConnection] Channels are already available and can be reused directly."):(i=this.peerConnection.createDataChannel("datastream-channel",{ordered:!1,maxRetransmits:N("DATASTREAM_MAX_RETRANSMITS")}),i.binaryType="arraybuffer",this.dataStreamChannelMap.set(e,i)),void n.forEach(r=>{r._updateOriginDataChannel(i)})}catch(i){throw i instanceof U?i:new U(b.DATACHANNEL_FAILED,"NVExtentionsConnection.createDataChannels failed; ".concat(i.toString()))}}async stopDataChannels(e){try{const n=this.dataStreamChannelMap.get(e);return n==null||n.close(),void this.dataStreamChannelMap.delete(e)}catch(n){throw n instanceof U?n:new U(b.DATACHANNEL_FAILED,"NVExtentionsConnection.stopDataChannels failed; ".concat(n.toString()))}}async receive(e,n,i,r){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.receive ".concat(e," before remoteSDP created."));const{mid:o,needExchangeSDP:s}=this.remoteSDP.send(e,n,i,r);if(s){const c=this.remoteSDP.toString(),d=this.logSDPExchange(c,"offer","remote","receive");await this.peerConnection.setRemoteDescription({type:"offer",sdp:c});const u=await this.peerConnection.createAnswer(),l=this.mungReceiveAnswerSDP(u.sdp,o,e);d==null||d(l||""),await this.peerConnection.setLocalDescription({type:"answer",sdp:l}),E.debug("[NVExtentionsConnection] receive ".concat(e," by exchanging SDP."))}else E.debug("[NVExtentionsConnection] receive ".concat(e," no need to exchange SDP."));const a=this.peerConnection.getTransceivers().find(c=>c.mid===o);if(!a)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:a.receiver.track,id:o}}catch(o){throw new U(b.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.receive failed; ".concat(o.toString()))}}async batchReceive(e){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.batchReceive before remoteSDP created.");const{mids:n,needExchangeSDP:i}=this.remoteSDP.batchSend(e);if(i){const r=this.remoteSDP.toString(),o=this.logSDPExchange(r,"offer","remote","receive");await this.peerConnection.setRemoteDescription({type:"offer",sdp:r});const s=await this.peerConnection.createAnswer();o==null||o(s.sdp||""),await this.peerConnection.setLocalDescription(s),E.debug("[NVExtentionsConnection] batchReceive by exchanging SDP.")}else E.debug("[NVExtentionsConnection] batchReceive no need to exchange SDP.");return n.map(r=>{const o=this.peerConnection.getTransceivers().find(s=>s.mid===r);if(!o)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:o.receiver.track,id:r}})}catch(n){throw new U(b.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.receive failed; ".concat(n.toString()))}}async stopReceiving(e){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.stopReceiving before remote SDP created.");this.remoteSDP.stopSending(e);const n=this.remoteSDP.toString(),i=this.logSDPExchange(n,"offer","remote","stopReceiving");await this.peerConnection.setRemoteDescription({type:"offer",sdp:n});const r=await this.peerConnection.createAnswer();i==null||i(r.sdp||""),await this.peerConnection.setLocalDescription(r)}catch(n){throw new U(b.EXCHANGE_SDP_FAILED,"NVExtentionsConnection stopReceiving failed; ".concat(n.toString()))}}async muteRemote(e){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.muteRemote mid=".concat(e," before remote SDP created."));this.remoteSDP.mute(e);const n=this.remoteSDP.toString(),i=this.logSDPExchange(n,"offer","remote","muteRemote");await this.peerConnection.setRemoteDescription({type:"offer",sdp:n});const r=await this.peerConnection.createAnswer();i==null||i(r.sdp||""),await this.peerConnection.setLocalDescription(r)}catch(n){throw new U(b.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.muteRemote failed; ".concat(n.toString()))}}async unmuteRemote(e){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.unmuteRemote mid=".concat(e," before remote SDP created."));this.remoteSDP.unmute(e);const n=this.remoteSDP.toString(),i=this.logSDPExchange(n,"offer","remote","unmuteRemote");await this.peerConnection.setRemoteDescription({type:"offer",sdp:n});const r=await this.peerConnection.createAnswer();i==null||i(r.sdp||""),await this.peerConnection.setLocalDescription(r)}catch(n){throw new U(b.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.unmuteRemote failed; ".concat(n.toString()))}}async muteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.muteLocal before remote SDP created.");const n=this.peerConnection.getTransceivers().filter(s=>s.mid&&e.indexOf(s.mid)!==-1);if(n.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length.");n.map(s=>{s.direction="inactive"});const i=await this.peerConnection.createOffer(),r=this.logSDPExchange(i.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(i),this.remoteSDP.muteRemote(e);const o=this.remoteSDP.toString();r==null||r(o),await this.peerConnection.setRemoteDescription({type:"answer",sdp:o})}catch(n){throw new U(b.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.muteLocal failed; ".concat(n.toString()))}}async unmuteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.unmuteLocal before remote SDP created.");const n=this.peerConnection.getTransceivers().filter(s=>s.mid&&e.indexOf(s.mid)!==-1);if(n.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length.");n.map(async(s,a)=>{s.direction="sendonly"});const i=await this.peerConnection.createOffer(),r=this.logSDPExchange(i.sdp||"","offer","local","unmuteLocal");await this.peerConnection.setLocalDescription(i),this.remoteSDP.unmuteRemote(e);const o=this.remoteSDP.toString();r==null||r(o),await this.peerConnection.setRemoteDescription({type:"answer",sdp:o})}catch(n){throw new U(b.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.unmuteLocal failed; ".concat(n.toString()))}}restartICE(e){var n=this;return Hi(function*(){const i=yield Mt(n.mutex.lock("From NVExtentionsConnection.restartICE"));try{if(!n.remoteSDP)throw new Error("Cannot restartICE before remoteSDP created.");if(zt().supportPCSetConfiguration){const d=n.peerConnection.getConfiguration(),u=e===ai.RELAY?"relay":"all";d.iceTransportPolicy!==u&&(E.debug("restartICE change iceTransportPolicy from [".concat(d.iceTransportPolicy,"] to [").concat(u,"]")),d.iceTransportPolicy=u,n.peerConnection.setConfiguration(d))}else if(e===ai.RELAY)return;e!==ai.RELAY&&n.remoteSDP.updateCandidates(e);const r=yield Mt(n.peerConnection.createOffer({iceRestart:!0}));if(!r.sdp)throw new Error("Cannot restartICE because restart offer SDP does not exist.");const o=fo(r.sdp),{remoteIceParameters:s}=yield o.iceParameters;n.remoteSDP.restartICE(s);const a=n.remoteSDP.toString(),c=n.logSDPExchange(r.sdp||"","offer","local","restartICE");yield Mt(n.peerConnection.setLocalDescription(r)),c==null||c(a),yield Mt(n.peerConnection.setRemoteDescription({type:"answer",sdp:a}))}catch(r){E.warning("restart ICE failed, abort operation",r)}finally{i()}})()}close(){var e;(e=this.onConnectionStateChange)===null||e===void 0||e.call(this,"closed"),this.unbindPCEvents(),this.unbindStatsEvents(),this.removeAllListeners(),this.transportEventReceiver=void 0,this.statsFilter.destroy(),this.dataStreamChannelMap.clear()}getStats(){return this.statsFilter.getStats()}getRemoteVideoIsReady(e){return this.statsFilter.getVideoIsReady(e)}async updateEncoderConfig(e,n){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.updateEncoderConfig before remote SDP created.");const i=await this.peerConnection.createOffer(),r=this.mungSendOfferSDP(i.sdp,[n],[e]);this.remoteSDP.updateRecvMedia(e,n);const o=this.remoteSDP.toString(),s=this.logSDPExchange(r,"offer","local","updateEncoderConfig");await this.peerConnection.setLocalDescription({type:"offer",sdp:r}),s==null||s(o),await this.peerConnection.setRemoteDescription({type:"answer",sdp:o})}catch(i){throw new U(b.EXCHANGE_SDP_FAILED,i.toString())}}async updateSendParameters(e,n){const i=this.peerConnection.getTransceivers().filter(r=>r.mid===e);i.length===1&&(this.isVP8Simulcast(n)?ye()||await this.applySimulcastEncodings(i,[n]):await this.applySendEncodings(i,[n]))}setStatsRemoteVideoIsReady(e,n){this.statsFilter.setVideoIsReady2(e,n)}async replaceTrack(e,n){const i=this.peerConnection.getTransceivers().find(r=>r.mid===n);i&&await i.sender.replaceTrack(e._mediaStreamTrack)}getP2PConnectionParams(){var e;if((e=this.peerConnection.currentLocalDescription)===null||e===void 0||!e.sdp||!this.localCapabilities)throw new Error;return Gf(Gf({},fo(this.peerConnection.currentLocalDescription.sdp)),{},{rtpCapabilities:this.localCapabilities})}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var e;(e=this.onICEConnectionStateChange)===null||e===void 0||e.call(this,this.peerConnection.iceConnectionState)},this.peerConnection.onconnectionstatechange=()=>{var e;(e=this.onConnectionStateChange)===null||e===void 0||e.call(this,this.peerConnection.connectionState)},this.peerConnection.onicecandidate=e=>{e.candidate?this.localCandidateCount+=1:(this.peerConnection.onicecandidate=null,this.allCandidatesReceived=!0,E.debug("[pc-".concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount))},setTimeout(()=>{this.allCandidatesReceived||(this.allCandidatesReceived=!0,E.debug("[pc-".concat(this.store.p2pId,"] onicecandidate timeout, local candidate count"),this.localCandidateCount))},N("CANDIDATE_TIMEOUT"))}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null}static resolvePCConfiguration(e){const n={iceServers:[]};return e.iceServers?n.iceServers=e.iceServers:e.turnServer&&e.turnServer.mode!=="off"&&(Zc(e.turnServer.servers)?n.iceServers=e.turnServer.servers:(n.iceServers&&n.iceServers.push(...e_.turnServerConfigToIceServers(e.turnServer.servers)),N("USE_TURN_SERVER_OF_GATEWAY")&&n.iceServers&&e.turnServer.serversFromGateway&&n.iceServers.push(...e_.turnServerConfigToIceServers(e.turnServer.serversFromGateway)),N("FORCE_TURN_TCP")?n.iceTransportPolicy="relay":e.turnServer.servers.concat(e.turnServer.serversFromGateway||[]).forEach(i=>{i.forceturn&&(n.iceTransportPolicy="relay")}))),n}static turnServerConfigToIceServers(e){const n=[];return e.forEach(i=>{i.security?i.tcpport&&n.push({username:i.username,credential:i.password,credentialType:"password",urls:"turns:".concat(Xs(i.turnServerURL),":").concat(i.tcpport,"?transport=tcp")}):(i.udpport&&!N("FORCE_TURN_TCP")&&n.push({username:i.username,credential:i.password,credentialType:"password",urls:"turn:".concat(i.turnServerURL,":").concat(i.udpport,"?transport=udp")}),i.tcpport&&n.push({username:i.username,credential:i.password,credentialType:"password",urls:"turn:".concat(i.turnServerURL,":").concat(i.tcpport,"?transport=tcp")}))}),n}async applySendEncodings(e,n){try{if(!zt().supportSetRtpSenderParameters||e.length!==n.length)return;for(let l=0;l<e.length;l++){const p=e[l],f=n[l];if(f&&f instanceof Ae){var i,r,o;if(this.isVP8Simulcast(f))continue;const C={},m={};switch(f._optimizationMode){case"motion":C.degradationPreference="maintain-framerate";break;case"detail":C.degradationPreference="maintain-resolution";break;default:C.degradationPreference="balanced"}var s,a,c,d;if((i=f._encoderConfig)!==null&&i!==void 0&&i.bitrateMax&&(m.maxBitrate=1e3*((s=f._encoderConfig)===null||s===void 0?void 0:s.bitrateMax)),it(r=f._hints).call(r,De.LOW_STREAM)&&((a=f._encoderConfig)!==null&&a!==void 0&&a.frameRate&&(m.maxFramerate=Pi(f._encoderConfig.frameRate)),(c=f._encoderConfig)!==null&&c!==void 0&&c.scaleResolutionDownBy&&((d=f._encoderConfig)===null||d===void 0?void 0:d.scaleResolutionDownBy)>1&&(m.scaleResolutionDownBy=f._encoderConfig.scaleResolutionDownBy)),N("DSCP_TYPE")&&Ws()){var u;const A=N("DSCP_TYPE");it(u=["very-low","low","medium","high"]).call(u,A)&&(m.networkPriority=A)}const g=p.sender.getParameters(),y=(o=g.encodings)===null||o===void 0?void 0:o[0];ye()&&!y&&(C.encodings=[m]),y&&Object.assign(y,m),Object.assign(g,C),await p.sender.setParameters(g)}}}catch{E.debug("Apply RTPSendEncodings failed.")}}mungSendOfferSDP(e,n,i){const r=je.parse(e);return n.forEach((o,s)=>{const a=i[s],c=r.mediaDescriptions.find(d=>d.attributes.mid===a);c&&(ra(c,o),kT(c,o,this.store.codec))}),je.print(r)}mungReceiveAnswerSDP(e,n,i){const r=je.parse(e),o=r.mediaDescriptions.find(s=>s.attributes.mid===n);return o&&i===_t.AUDIO&&o.media.mediaType==="audio"&&_o(o),this.useXR&&Lf(r),je.print(r)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=e=>{var n;(n=this.onFirstAudioReceived)===null||n===void 0||n.call(this,e)},this.statsFilter.onFirstVideoReceived=e=>{var n;(n=this.onFirstVideoReceived)===null||n===void 0||n.call(this,e)},this.statsFilter.onFirstAudioDecoded=e=>{var n;(n=this.onFirstAudioDecoded)===null||n===void 0||n.call(this,e)},this.statsFilter.onFirstVideoDecoded=(e,n,i)=>{var r;(r=this.onFirstVideoDecoded)===null||r===void 0||r.call(this,e,n,i)},this.statsFilter.onSelectedLocalCandidateChanged=(e,n)=>{var i;(i=this.onSelectedLocalCandidateChanged)===null||i===void 0||i.call(this,e,n)},this.statsFilter.onSelectedRemoteCandidateChanged=(e,n)=>{var i;(i=this.onSelectedRemoteCandidateChanged)===null||i===void 0||i.call(this,e,n)},this.statsFilter.onFirstVideoDecodedTimeout=e=>{var n;(n=this.onFirstVideoDecodedTimeout)===null||n===void 0||n.call(this,e)}}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0,this.statsFilter.onFirstVideoDecodedTimeout=void 0}async applySimulcastForFirefox(e,n){if(e.length===n.length)for(let c=0;c<e.length;c++){var i,r,o,s,a;const d=e[c],u=n[c];if(u instanceof Ae&&!it(i=u._hints).call(i,De.LOW_STREAM)&&(r=u._encoderConfig)!==null&&r!==void 0&&r.bitrateMax&&((o=u._encoderConfig)===null||o===void 0?void 0:o.bitrateMax)>200&&(s=u._scalabilityMode)!==null&&s!==void 0&&s.numSpatialLayers&&((a=u._scalabilityMode)===null||a===void 0?void 0:a.numSpatialLayers)>1&&this.store.codec==="vp8"){const l={},p={high:1e3*(u._encoderConfig.bitrateMax-50),medium:5e4};l.encodings=[{rid:"m",active:!0,maxBitrate:p.medium,scaleResolutionDownBy:4},{rid:"h",active:!0,maxBitrate:p.high}];const f=d.sender.getParameters();await d.sender.setParameters(Object.assign(f,l))}}}async applySimulcastEncodings(e,n){if(!ye()&&e.length===n.length)for(let i=0;i<e.length;i++){const r=n[i];if(r instanceof Ae&&this.isVP8Simulcast(r)){const o=e[i],s={},a={high:1e3*(r._encoderConfig.bitrateMax-50),medium:5e4};s.encodings=[{active:!0,adaptivePtime:!1,networkPriority:"high",priority:"high",maxBitrate:a.high},{active:!0,adaptivePtime:!1,networkPriority:"low",priority:"low",maxBitrate:a.medium,scaleResolutionDownBy:4}];const c=o.sender.getParameters();await o.sender.setParameters(Object.assign(c,s))}}}isVP8Simulcast(e){var n,i,r,o,s;return!!(e instanceof Ae&&N("SIMULCAST")&&this.store.codec==="vp8"&&!it(n=e._hints).call(n,De.LOW_STREAM)&&(i=e._encoderConfig)!==null&&i!==void 0&&i.bitrateMax&&((r=e._encoderConfig)===null||r===void 0?void 0:r.bitrateMax)>200&&(o=e._scalabilityMode)!==null&&o!==void 0&&o.numSpatialLayers&&((s=e._scalabilityMode)===null||s===void 0?void 0:s.numSpatialLayers)>1)}logSDPExchange(e,n,i,r){if(N("SDP_LOGGING"))return E.upload("exchanging ".concat(i," ").concat(n," SDP during NVExtentionsConnection.").concat(r,`
`),e),n==="offer"?o=>{this.logSDPExchange(o,"answer",i==="local"?"remote":"local",r)}:void 0}async getRemoteSSRC(e){if(!this.remoteSDP)return;const n=this.remoteSDP.getSSRC(e);return n==null?void 0:n[0].ssrcId}setConfiguration(e){if(zt().supportPCSetConfiguration){const n=e_.resolvePCConfiguration(e);this.peerConnection.setConfiguration(n)}}},nt(ne.prototype,"connect",[ki],Object.getOwnPropertyDescriptor(ne.prototype,"connect"),ne.prototype),nt(ne.prototype,"updateRemoteRTPCapabilities",[ki],Object.getOwnPropertyDescriptor(ne.prototype,"updateRemoteRTPCapabilities"),ne.prototype),nt(ne.prototype,"updateRemoteConnect",[ki],Object.getOwnPropertyDescriptor(ne.prototype,"updateRemoteConnect"),ne.prototype),nt(ne.prototype,"createDataChannels",[ki],Object.getOwnPropertyDescriptor(ne.prototype,"createDataChannels"),ne.prototype),nt(ne.prototype,"receive",[ki],Object.getOwnPropertyDescriptor(ne.prototype,"receive"),ne.prototype),nt(ne.prototype,"batchReceive",[ki],Object.getOwnPropertyDescriptor(ne.prototype,"batchReceive"),ne.prototype),nt(ne.prototype,"stopReceiving",[ki],Object.getOwnPropertyDescriptor(ne.prototype,"stopReceiving"),ne.prototype),nt(ne.prototype,"muteRemote",[ki],Object.getOwnPropertyDescriptor(ne.prototype,"muteRemote"),ne.prototype),nt(ne.prototype,"unmuteRemote",[ki],Object.getOwnPropertyDescriptor(ne.prototype,"unmuteRemote"),ne.prototype),nt(ne.prototype,"muteLocal",[ki],Object.getOwnPropertyDescriptor(ne.prototype,"muteLocal"),ne.prototype),nt(ne.prototype,"unmuteLocal",[ki],Object.getOwnPropertyDescriptor(ne.prototype,"unmuteLocal"),ne.prototype),nt(ne.prototype,"close",[ki],Object.getOwnPropertyDescriptor(ne.prototype,"close"),ne.prototype),nt(ne.prototype,"updateEncoderConfig",[ki],Object.getOwnPropertyDescriptor(ne.prototype,"updateEncoderConfig"),ne.prototype),nt(ne.prototype,"updateSendParameters",[ki],Object.getOwnPropertyDescriptor(ne.prototype,"updateSendParameters"),ne.prototype),nt(ne.prototype,"replaceTrack",[ki],Object.getOwnPropertyDescriptor(ne.prototype,"replaceTrack"),ne.prototype),nt(ne.prototype,"getRemoteSSRC",[ki],Object.getOwnPropertyDescriptor(ne.prototype,"getRemoteSSRC"),ne.prototype),ne);function ki(t,e,n){const i=t[e];if(typeof i!="function")throw new Error("Cannot use mutex on object property.");return n.value=async function(){const r=this.mutex,o=await r.lock("From NVExtentionsConnection.".concat(e));try{for(var s=arguments.length,a=new Array(s),c=0;c<s;c++)a[c]=arguments[c];return await i.apply(this,a)}finally{o()}},n}var pe;function ON(t){var e,n,i,r=2;for(typeof Symbol!="undefined"&&(n=hN,i=Symbol.iterator);r--;){if(n&&(e=t[n])!=null)return e.call(t);if(i&&(e=t[i])!=null)return new Wf(e.call(t));n="@@asyncIterator",i="@@iterator"}throw new TypeError("Object is not async iterable")}function Wf(t){function e(n){if(Object(n)!==n)return ot.reject(new TypeError(n+" is not an object."));var i=n.done;return ot.resolve(n.value).then(function(r){return{value:r,done:i}})}return Wf=function(n){this.s=n,this.n=n.next},Wf.prototype={s:null,n:null,next:function(){return e(this.n.apply(this.s,arguments))},return:function(n){var i=this.s.return;return i===void 0?ot.resolve({value:n,done:!0}):e(i.apply(this.s,arguments))},throw:function(n){var i=this.s.return;return i===void 0?ot.reject(n):e(i.apply(this.s,arguments))}},new Wf(t)}let ua=(pe=class n_ extends qp{get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get localCodecs(){return this._p2pConnection.localCodecs}constructor(e,n){super(e,n),R(this,"store",void 0),R(this,"peerConnection",void 0),R(this,"cname",void 0),R(this,"mutex",new kn("DataChannelConnection-mutex")),R(this,"dataChannel",void 0),R(this,"_p2pConnection",void 0),R(this,"establishPromise",void 0),R(this,"_nvMedia",void 0),this.store=n,this.store.dcId=this.store.dcId+1,this.peerConnection=new RTCPeerConnection(n_.resolvePCConfiguration(e),{optional:[{googDscp:!0}]}),this.dataChannel=this.peerConnection.createDataChannel("agora-signal",{ordered:!1,maxPacketLifeTime:50}),this.dataChannel.binaryType="arraybuffer",this._p2pConnection=new h3(e,n,this.peerConnection),this.bindPCEvents(),this.establishPromise=this._p2pConnection.establishPromise}async establish(){var e;const n=(e=this._nvMedia)===null||e===void 0?void 0:e.getLocalRtpCapabilities();return await this._p2pConnection.establish(n)}getP2PConnectionParams(){return this._p2pConnection.getP2PConnectionParams()}async connect(e,n,i,r,o,s){return this.cname=s,await this._p2pConnection.connect(e,n,i,r,o,s),await new ot((a,c)=>{const d=setTimeout(()=>{this.closeSignal(),c(new U(b.DATACHANNEL_CONNECTION_TIMEOUT,"Datachannel connection timed out, candidates: ".concat(JSON.stringify(i))))},2e3);this.dataChannel.onopen=()=>{if(this.dataChannel.readyState==="open")return clearTimeout(d),void a()},this.dataChannel.onerror=u=>{this.closeSignal(),c(u)}}),{transmitter:this.dataChannel,close:this.closeSignal.bind(this)}}async updateRemoteRTPCapabilities(e,n){return this._p2pConnection.updateRemoteRTPCapabilities(e,n)}send(e,n,i){var r=this;return Hi(function*(){const o=yield Mt(r.mutex.lock("From DataChannelConnection.send"));try{return yield*Uf(ON(r._p2pConnection.send(e,n,i)))}finally{o()}})()}async stopSending(e,n){return this._p2pConnection.stopSending(e,n)}async createDataChannels(e,n){return this._p2pConnection.createDataChannels(e,n)}async stopDataChannels(e){return this._p2pConnection.stopDataChannels(e)}async receive(e,n,i,r){return this._nvMedia?(E.debug("[DataChannelConnection] receive ".concat(e," by DataChannel.")),await this._nvMedia.reveiveByRTCMedia(e,n,this.cname)):(E.debug("[DataChannelConnection] receive ".concat(e," by WebRTC.")),await this._p2pConnection.receive(e,n,i,r))}async batchReceive(e){return[...await this._p2pConnection.batchReceive(e)]}async stopReceiving(e){return await this._p2pConnection.stopReceiving(e)}async muteRemote(e){return await this._p2pConnection.muteRemote(e)}async unmuteRemote(e){return await this._p2pConnection.unmuteRemote(e)}async muteLocal(e){return await this._p2pConnection.muteLocal(e)}async unmuteLocal(e){return await this._p2pConnection.unmuteLocal(e)}restartICE(e){var n=this;return Hi(function*(){return yield*Uf(ON(n._p2pConnection.restartICE(e)))})()}close(){var e;(e=this._nvMedia)===null||e===void 0||e.close(),this._p2pConnection.close(),this.unbindConnectionEvents(this._p2pConnection)}getStats(){return this._p2pConnection.getStats()}getRemoteVideoIsReady(e){return this._p2pConnection.getRemoteVideoIsReady(e)}updateRemoteConnect(e){var n;(n=this._nvMedia)===null||n===void 0||n.setRemoteRtpCapabilities(e),this._p2pConnection.updateRemoteConnect(e)}async updateEncoderConfig(e,n){return await this._p2pConnection.updateEncoderConfig(e,n)}async updateSendParameters(e,n){return await this._p2pConnection.updateSendParameters(e,n)}setStatsRemoteVideoIsReady(e,n){this._p2pConnection.setStatsRemoteVideoIsReady(e,n)}async replaceTrack(e,n){return await this._p2pConnection.replaceTrack(e,n)}async getRemoteSSRC(e){return this._p2pConnection.getRemoteSSRC(e)}logSDPExchange(e,n,i,r){if(N("SDP_LOGGING"))return E.upload("exchanging ".concat(i," ").concat(n," SDP during DataChannelConnection.").concat(r,`
`),e),n==="offer"?o=>{this.logSDPExchange(o,"answer",i==="local"?"remote":"local",r)}:void 0}static resolvePCConfiguration(e){const n={iceServers:[]};return e.iceServers?n.iceServers=e.iceServers:e.turnServer&&e.turnServer.mode!=="off"&&(Zc(e.turnServer.servers)?n.iceServers=e.turnServer.servers:(n.iceServers&&n.iceServers.push(...n_.turnServerConfigToIceServers(e.turnServer.servers)),N("USE_TURN_SERVER_OF_GATEWAY")&&n.iceServers&&e.turnServer.serversFromGateway&&n.iceServers.push(...n_.turnServerConfigToIceServers(e.turnServer.serversFromGateway)),N("FORCE_TURN_TCP")?n.iceTransportPolicy="relay":e.turnServer.servers.concat(e.turnServer.serversFromGateway||[]).forEach(i=>{i.forceturn&&(n.iceTransportPolicy="relay")}))),n}static turnServerConfigToIceServers(e){const n=[];return e.forEach(i=>{i.security?i.tcpport&&n.push({username:i.username,credential:i.password,credentialType:"password",urls:"turns:".concat(Xs(i.turnServerURL),":").concat(i.tcpport,"?transport=tcp")}):(i.udpport&&!N("FORCE_TURN_TCP")&&n.push({username:i.username,credential:i.password,credentialType:"password",urls:"turn:".concat(i.turnServerURL,":").concat(i.udpport,"?transport=udp")}),i.tcpport&&n.push({username:i.username,credential:i.password,credentialType:"password",urls:"turn:".concat(i.turnServerURL,":").concat(i.tcpport,"?transport=tcp")}))}),n}bindPCEvents(){this._p2pConnection.onICEConnectionStateChange=e=>{var n;return(n=this.onICEConnectionStateChange)===null||n===void 0?void 0:n.call(this,e)},this._p2pConnection.onConnectionStateChange=e=>{var n;return(n=this.onConnectionStateChange)===null||n===void 0?void 0:n.call(this,e)},this._p2pConnection.onDTLSTransportStateChange=e=>{var n;return(n=this.onDTLSTransportStateChange)===null||n===void 0?void 0:n.call(this,e)},this._p2pConnection.onDTLSTransportError=e=>{var n;return(n=this.onDTLSTransportError)===null||n===void 0?void 0:n.call(this,e)},this._p2pConnection.onICETransportStateChange=e=>{var n;return(n=this.onICETransportStateChange)===null||n===void 0?void 0:n.call(this,e)},this._p2pConnection.onFirstAudioReceived=e=>{var n;return(n=this.onFirstAudioReceived)===null||n===void 0?void 0:n.call(this,e)},this._p2pConnection.onFirstVideoReceived=e=>{var n;return(n=this.onFirstVideoReceived)===null||n===void 0?void 0:n.call(this,e)},this._p2pConnection.onFirstAudioDecoded=e=>{var n;return(n=this.onFirstAudioDecoded)===null||n===void 0?void 0:n.call(this,e)},this._p2pConnection.onFirstVideoDecoded=(e,n,i)=>{var r;return(r=this.onFirstVideoDecoded)===null||r===void 0?void 0:r.call(this,e,n,i)},this._p2pConnection.onFirstVideoDecodedTimeout=e=>{var n;return(n=this.onFirstVideoDecodedTimeout)===null||n===void 0?void 0:n.call(this,e)},this._p2pConnection.onSelectedLocalCandidateChanged=(e,n)=>{var i;return(i=this.onSelectedLocalCandidateChanged)===null||i===void 0?void 0:i.call(this,e,n)},this._p2pConnection.onSelectedRemoteCandidateChanged=(e,n)=>{var i;return(i=this.onSelectedRemoteCandidateChanged)===null||i===void 0?void 0:i.call(this,e,n)}}closeSignal(){this.dataChannel.close(),this.peerConnection.close()}unbindConnectionEvents(e){e.onConnectionStateChange=void 0,e.onICEConnectionStateChange=void 0,e.onICETransportStateChange=void 0,e.onDTLSTransportStateChange=void 0,e.onDTLSTransportError=void 0,e.onFirstAudioDecoded=void 0,e.onFirstAudioReceived=void 0,e.onFirstVideoDecoded=void 0,e.onFirstVideoReceived=void 0,e.onSelectedLocalCandidateChanged=void 0,e.onSelectedRemoteCandidateChanged=void 0,e.onFirstVideoDecodedTimeout=void 0}setConfiguration(e){this._p2pConnection.setConfiguration(e)}},nt(pe.prototype,"connect",[cr],Object.getOwnPropertyDescriptor(pe.prototype,"connect"),pe.prototype),nt(pe.prototype,"updateRemoteRTPCapabilities",[cr],Object.getOwnPropertyDescriptor(pe.prototype,"updateRemoteRTPCapabilities"),pe.prototype),nt(pe.prototype,"createDataChannels",[cr],Object.getOwnPropertyDescriptor(pe.prototype,"createDataChannels"),pe.prototype),nt(pe.prototype,"receive",[cr],Object.getOwnPropertyDescriptor(pe.prototype,"receive"),pe.prototype),nt(pe.prototype,"stopReceiving",[cr],Object.getOwnPropertyDescriptor(pe.prototype,"stopReceiving"),pe.prototype),nt(pe.prototype,"muteRemote",[cr],Object.getOwnPropertyDescriptor(pe.prototype,"muteRemote"),pe.prototype),nt(pe.prototype,"unmuteRemote",[cr],Object.getOwnPropertyDescriptor(pe.prototype,"unmuteRemote"),pe.prototype),nt(pe.prototype,"muteLocal",[cr],Object.getOwnPropertyDescriptor(pe.prototype,"muteLocal"),pe.prototype),nt(pe.prototype,"unmuteLocal",[cr],Object.getOwnPropertyDescriptor(pe.prototype,"unmuteLocal"),pe.prototype),nt(pe.prototype,"close",[cr],Object.getOwnPropertyDescriptor(pe.prototype,"close"),pe.prototype),nt(pe.prototype,"updateEncoderConfig",[cr],Object.getOwnPropertyDescriptor(pe.prototype,"updateEncoderConfig"),pe.prototype),nt(pe.prototype,"updateSendParameters",[cr],Object.getOwnPropertyDescriptor(pe.prototype,"updateSendParameters"),pe.prototype),nt(pe.prototype,"replaceTrack",[cr],Object.getOwnPropertyDescriptor(pe.prototype,"replaceTrack"),pe.prototype),nt(pe.prototype,"getRemoteSSRC",[cr],Object.getOwnPropertyDescriptor(pe.prototype,"getRemoteSSRC"),pe.prototype),pe);function cr(t,e,n){const i=t[e];if(typeof i!="function")throw new Error("Cannot use mutex on object property.");return n.value=async function(){const r=this.mutex,o=await r.lock("From DataChannelConnection.".concat(e));try{for(var s=arguments.length,a=new Array(s),c=0;c<s;c++)a[c]=arguments[c];return await i.apply(this,a)}finally{o()}},n}var Vt;function NN(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),n.push.apply(n,i)}return n}function zo(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?NN(Object(n),!0).forEach(function(i){R(t,i,n[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):NN(Object(n)).forEach(function(i){Object.defineProperty(t,i,Object.getOwnPropertyDescriptor(n,i))})}return t}function DN(t){var e,n,i,r=2;for(typeof Symbol!="undefined"&&(n=hN,i=Symbol.iterator);r--;){if(n&&(e=t[n])!=null)return e.call(t);if(i&&(e=t[i])!=null)return new Hf(e.call(t));n="@@asyncIterator",i="@@iterator"}throw new TypeError("Object is not async iterable")}function Hf(t){function e(n){if(Object(n)!==n)return ot.reject(new TypeError(n+" is not an object."));var i=n.done;return ot.resolve(n.value).then(function(r){return{value:r,done:i}})}return Hf=function(n){this.s=n,this.n=n.next},Hf.prototype={s:null,n:null,next:function(){return e(this.n.apply(this.s,arguments))},return:function(n){var i=this.s.return;return i===void 0?ot.resolve({value:n,done:!0}):e(i.apply(this.s,arguments))},throw:function(n){var i=this.s.return;return i===void 0?ot.reject(n):e(i.apply(this.s,arguments))}},new Hf(t)}let Kf=(Vt=class extends Ve{get state(){return this._state}set state(t){const e=this._state;this._state=t,this.emit(yt.StateChange,e,this._state)}constructor(t,e){super(),R(this,"store",void 0),R(this,"statsUploader",void 0),R(this,"connection",void 0),R(this,"localTrackMap",new Map),R(this,"remoteUserMap",new Map),R(this,"localDataChannels",[]),R(this,"remoteDataChannelMap",new Map),R(this,"pendingLocalTracks",[]),R(this,"pendingRemoteTracks",[]),R(this,"pendingLocalDataChannels",[]),R(this,"pendingRemoteDataChannels",[]),R(this,"statsCollector",void 0),R(this,"isPlanB",!1),R(this,"shouldForwardP2PCreation",void 0),R(this,"iceFailedCount",0),R(this,"dtlsFailedCount",0),R(this,"mutex",new kn("P2PChannel-mutex")),R(this,"_state",he.Disconnected),R(this,"_pcStatsUploadType",N("NEW_ICE_RESTART")?_s.FIRST_CONNECTION:_s.OLD_FIRST_CONNECTION),R(this,"_isInRestartIce",!1),R(this,"_isStartRestartIce",!1),R(this,"_restartStates",["disconnected","failed"]),R(this,"_restartTimer",void 0),R(this,"_isFirstConnected",!0),R(this,"handleMuteLocalTrack",async(n,i,r)=>{const o=await this.mutex.lock("Locking from P2PChannel.handleMuteLocalTrack");try{if(!this.connection||this.state!==he.Connected)return void r(new G(b.INVALID_OPERATION,"Cannot call P2PChannel.handleMuteLocalTrack before connection established."));const s=this.filterTobeMutedTracks(n);if(s.length===0)return void i();const a=s.find(d=>d[0]==="videoLowTrack");a&&a[1].track._originMediaStreamTrack.stop(),await this.connection.muteLocal(s.map(d=>{let[,{id:u}]=d;return u}));const c=this.createMuteMessage(s);await Ie(this,yt.RequestMuteLocal,c),i()}catch(s){r(s)}finally{o()}}),R(this,"handleUnmuteLocalTrack",async(n,i,r)=>{const o=await this.mutex.lock("Locking from P2PChannel.handleUnmuteLocalTrack");try{if(!this.connection||this.state!==he.Connected)return void r(new G(b.INVALID_OPERATION,"Cannot call P2PChannel.handleUnmuteLocalTrack before connection established."));const s=this.filterTobeUnmutedTracks(n);if(s.length===0)return void i();const a=s.find(d=>d[0]==="videoLowTrack");if(a){const d=a[1];if(d.track._originMediaStreamTrack.stop(),!N("DISABLE_DUAL_STREAM_USE_ENCODING")&&zt().supportDualStreamEncoding){const u=n._mediaStreamTrack.clone();d.track._mediaStreamTrack=u,d.track._originMediaStreamTrack=u}else{const u=xT(n,Ua(this,yt.RequestLowStreamParameter));d.track._mediaStreamTrack=u,d.track._originMediaStreamTrack=u}await new ot((u,l)=>{this.handleReplaceTrack(d.track,u,l,!0)})}await this.connection.unmuteLocal(s.map(d=>{let[,{id:u}]=d;return u}));const c=this.createUnmuteMessage(s);await Ie(this,yt.RequestUnmuteLocal,c),i()}catch(s){r(s)}finally{o()}}),R(this,"handleUpdateVideoEncoder",async(n,i,r)=>{const o=await this.mutex.lock("Locking from P2PChannel.handleSetVideoEncoder");try{const s=this.localTrackMap.get(X.LocalVideoTrack);if(!this.connection||!s||s.track!==n||this.state!==he.Connected)return void i();const{id:a,track:c}=s;await this.connection.updateSendParameters(a,c),await this.connection.updateEncoderConfig(a,c),this.emit(yt.UpdateVideoEncoder,c),i()}catch(s){r(s)}finally{o()}}),R(this,"handleUpdateVideoSendParameters",async(n,i,r)=>{const o=await this.mutex.lock("Locking from P2PChannel.handleUpdateVideoSendParameters");try{const s=this.localTrackMap.get(X.LocalVideoTrack);if(!this.connection||!s||s.track!==n||this.state!==he.Connected)return void i();const{id:a,track:c}=s;await this.connection.updateSendParameters(a,c),i()}catch(s){r(s)}finally{o()}}),R(this,"handleReplaceMixingTrack",async(n,i,r,o)=>{if(!this.connection||this.state!==he.Connected)return void i();const s=FT([n]);let a;E.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection will replace audioTrack [").concat(s.getTrackId(),"]")),typeof o=="boolean"&&o||(a=await this.mutex.lock("From P2PChannel.handleReplaceMixingTrack"));try{await this.replaceTrack(n,s),i()}catch(d){r(d)}finally{var c;(c=a)===null||c===void 0||c()}}),R(this,"handleReplaceTrack",async(n,i,r,o)=>{let s;E.debug("[".concat(this.store.clientId,"] P2PChannel handleReplaceTrack for [track-id-").concat(n.getTrackId(),"]")),typeof o=="boolean"&&o||(s=await this.mutex.lock("From P2PChannel.handleReplaceTrack"));try{var a;const d=Array.from(this.localTrackMap.entries()).find(u=>{let[,{track:l}]=u;return n===l});if(!this.connection||!d||this.state!==he.Connected)return void i();if(await((a=this.connection)===null||a===void 0?void 0:a.replaceTrack(n,d[1].id)),this.isPlanB){const u=d[1];u.id=n._mediaStreamTrack.id,this.localTrackMap.set(d[0],u)}if(d[0]===X.LocalVideoTrack&&!N("DISABLE_DUAL_STREAM_USE_ENCODING")&&zt().supportDualStreamEncoding){const u=this.localTrackMap.get(X.LocalVideoLowTrack);if(u){const l=n._mediaStreamTrack.clone();u.track._originMediaStreamTrack.stop(),u.track._mediaStreamTrack=l,u.track._originMediaStreamTrack=l,await new ot((p,f)=>{this.handleReplaceTrack(u.track,p,f,!0)})}}i()}catch(d){r(d)}finally{var c;(c=s)===null||c===void 0||c()}}),R(this,"handleGetRTCStats",n=>{n(this.statsCollector.getRTCStats())}),R(this,"handleGetLocalVideoStats",n=>{n(this.statsCollector.getLocalVideoTrackStats())}),R(this,"handleGetLocalAudioStats",n=>{n(this.statsCollector.getLocalAudioTrackStats())}),R(this,"handleGetRemoteVideoStats",n=>this.statsCollector.getRemoteVideoTrackStats(n.uid)[n.uid]),R(this,"handleGetRemoteAudioStats",n=>this.statsCollector.getRemoteAudioTrackStats(n.uid)[n.uid]),this.store=t,this.statsCollector=e,this.statsCollector.addP2PChannel(this),this.statsUploader=new z0(this.store),this.bindStatsUploaderEvents(),this.isPlanB=!zt().supportUnifiedPlan||N("CHROME_FORCE_PLAN_B")&&Ws(),this.shouldForwardP2PCreation=N("FORWARD_P2P_CREATION")&&zt().supportPCSetConfiguration&&Gm(),this.shouldForwardP2PCreation&&(this.connection=this.store.useDataChannel?new ua({},this.store):this.isPlanB?new Ld({},this.store):new go({},this.store),this.bindConnectionEvents(this.connection))}async startP2PConnection(t,e){var n;this.state=he.New;const i=this.shouldForwardP2PCreation&&((n=this.connection)===null||n===void 0?void 0:n.peerConnectionState)==="closed";if(this.shouldForwardP2PCreation&&!i||(i&&this.connection&&(E.warning("[".concat(this.store.clientId,"] P2PChannel.startP2PConnection ForwardP2P closed.")),this.connection.close(),this.unbindConnectionEvents(this.connection)),this.connection=this.store.useDataChannel?new ua(t,this.store):this.isPlanB?new Ld(t,this.store):new go(t,this.store),this.bindConnectionEvents(this.connection)),!this.connection)throw new G(b.UNEXPECTED_ERROR,"Cannot P2PChannel.startConnection before P2PConnection initialization .");return this._pcStatsUploadType=N("NEW_ICE_RESTART")?_s.FIRST_CONNECTION:_s.OLD_FIRST_CONNECTION,this._isFirstConnected=!0,this._isInRestartIce=!1,this._isStartRestartIce=!1,this.connection.setConfiguration(t),this.connection.establishPromise}async connect(t,e,n,i,r,o){if(!this.connection)throw new G(b.UNEXPECTED_ERROR,"Cannot P2PChannel.connect before P2PChannel.startP2PConnection .");this.connection instanceof ua?this.connection.updateRemoteConnect(i):(this.store.peerConnectionStart(),await this.connection.connect(t,e,n,i,r,o),this.statsUploader.startUploadTransportStats(),this.statsUploader.startUploadExtensionUsageStats(),this.state=he.Connected)}updateRemoteRTPCapabilities(t){const e=Array.from(this.localTrackMap.entries()).filter(r=>{var o;let[s]=r;return it(o=[X.LocalVideoLowTrack,X.LocalVideoTrack]).call(o,s)}),n=e.map(r=>{let[,{id:o}]=r;return o}),i=e.map(r=>{let[o]=r;return o});if(this.connection instanceof go){if(Et.updateRemoteRTPCapabilities(this.store.sessionId,{trackTypes:JSON.stringify(i),localCodecs:JSON.stringify(this.connection.localCodecs),remoteCodecs:JSON.stringify(t)}),!it(t).call(t,this.store.codec)){const r=["vp9","vp8","h264"].find(o=>it(t).call(t,o));r&&(this.store.codec=r,E.debug("[".concat(this.store.clientId,"] [").concat(this.store.p2pId," updateRemoteRTPCapabilities] default codec is not available, hence the fallback to ").concat(r,".")))}this.connection.updateRemoteRTPCapabilities(n,t)}}async preConnect(t,e,n,i,r,o){if(!this.connection)throw new G(b.UNEXPECTED_ERROR,"Cannot P2PChannel.connect before P2PChannel.startP2PConnection .");this.store.peerConnectionStart();const s=await this.connection.connect(t,e,n,i,r,o);return this.statsUploader.startUploadTransportStats(),this.statsUploader.startUploadExtensionUsageStats(),this.state=he.Connected,s}getEstablishParams(){if(this.connection instanceof ua)return this.connection.getP2PConnectionParams();throw new Error("Only DataChannelConnection needs to obtain establishParams")}async publishDataChannel(t){if(!this.connection||this.state!==he.Connected){if(this.state===he.Disconnected)throw new G(b.UNEXPECTED_ERROR,"PeerConnection already disconnected.");return void t.forEach(n=>{var i;it(i=this.pendingLocalDataChannels).call(i,n)||this.pendingLocalDataChannels.push(n)})}const e=this.filterTobePublishedDataChannels(t);e.length!==0&&(e.forEach(n=>{const i=Date.now();this.store.publish(n.id.toString(),"datachannel",i)}),await this.connection.createDataChannels(this.store.uid,e),e.forEach(n=>{this.localDataChannels.push(n);const i=Date.now();this.store.publish(n.id+"","datachannel",void 0,i)}))}publish(t,e,n){var i=this;return Hi(function*(){const r=yield Mt(i.mutex.lock("From P2PChannel.publish"));try{if(!i.connection||i.state!==he.Connected){if(i.state===he.Disconnected)throw new G(b.UNEXPECTED_ERROR,"PeerConnection already disconnected.");i.throwIfTrackTypeNotMatch(t);const s=t.filter(a=>i.pendingLocalTracks.indexOf(a)===-1);return void(i.pendingLocalTracks=i.pendingLocalTracks.concat(s))}i.store.pubId=i.store.pubId+1,$n.markPublishStart(i.store.clientId,i.store.pubId);const o=i.filterTobePublishedTracks(t,e,n);if(o.length===0)return void(yield Mt(i.tryToUnmuteAudio(t)));yield*Uf(DN(i.doPublish(i.connection,o)))}finally{r()}})()}doPublish(t,e){var n=this;return Hi(function*(){e.forEach(l=>{let{track:p,type:f}=l;const C=Date.now();n.store.publish(p.getTrackId(),f===X.LocalAudioTrack?"audio":"video",C)}),n.bindLocalTrackEvents(e);const i=e.map(l=>{let{track:p}=l;return p}),r=yield Mt(t.send(e.map(l=>{let{track:p}=l;return p}),n.store.codec,n.store.audioCodec)),o=(yield Mt(r.next())).value,s=n.createGatewayPublishMessage(e,o);let a;try{a=yield s}catch(l){throw r.throw(l),(l==null?void 0:l.code)===b.WS_ABORT&&e.forEach(p=>{let{track:f}=p;n.pendingLocalTracks.indexOf(f)===-1&&n.pendingLocalTracks.push(f)}),n.unbindLocalTrackEvents(e),l}const c=n.mapPubResToRemoteConfig(s,a),d=(yield Mt(r.next(c))).value,u=N("ENABLE_VIDEO_SEI");i.forEach(async l=>{const p=l.getRTCRtpTransceiver();p&&u&&(l.trackMediaType===_t.VIDEO?await VW(p.sender,l):l.trackMediaType===_t.AUDIO&&await async function(f){if(!zt().supportWebRTCEncodedTransform)return void E.warning("browser not support audio encoded transform");if(Af.has(f)||!f.track)return;const C={track:f.track};if(Gs()){if(!f.createEncodedStreams)return void E.warning("browser not support createEncodedStreams() API");let g=null;try{g=f.createEncodedStreams()}catch(A){return void E.error("create audio-encoded-streams error",A&&A.message)}const y=new TransformStream({transform(A,k){C.controller||(C.controller=k),f.track&&f.track.id!==C.track.id&&(E.debug("audio track changed: ".concat(C.track.id," => ").concat(f.track.id)),C.track.removeEventListener("ended",m),C.track=f.track,C.track.addEventListener("ended",m)),k.enqueue(A)}});g.readable.pipeThrough(y).pipeTo(g.writable)}else if(An()){if(typeof RTCRtpScriptTransform=="undefined")return void E.warning("browser not support RTCRtpScriptTransform");const g=bf(),y=new MessageChannel;await new ot(k=>g.onmessage=M=>{M.data==="registered"&&k(void 0)});const A=new RTCRtpScriptTransform(g,{name:"tx",port:y.port2},[y.port2]);f.transform=A,await new ot(k=>g.onmessage=M=>{M.data==="started"&&k(void 0)}),y.port1.onmessage=k=>{var M;k.data.transformed&&f.track&&((M=f.track)===null||M===void 0?void 0:M.id)!==C.track.id&&(E.debug("audio track changed: ".concat(C.track.id," => ").concat(f.track.id)),C.track.removeEventListener("ended",m),C.track=f.track,C.track.addEventListener("ended",m))},C.worker=g}function m(){if(f.track){if(this.id!==f.track.id)return;f.track.removeEventListener("ended",m)}const g=Af.get(f);if(g){Af.delete(f);try{var y,A;(y=g.controller)===null||y===void 0||y.terminate(),(A=g.worker)===null||A===void 0||A.terminate()}catch(k){E.warning(k&&k.message)}}}Af.set(f,C),f.track.addEventListener("ended",m)}(p.sender))}),e.forEach(l=>{let{type:p}=l;n.statsCollector.addLocalStats(p)}),n.assignLocalTracks(e,d),n.statsUploader.startUploadOutboundStats(),e.forEach(l=>{let{track:p,type:f}=l;const C=Date.now();n.store.publish(p.getTrackId(),f===X.LocalAudioTrack?"audio":"video",void 0,C)})})()}async updateVideoStreamParameter(t,e){const n=this.localTrackMap.get(e);if(!n)return;if(!(n.track instanceof Ae))return E.warn("[updateVideoStreamParameter]: track is not an instance of LocalVideoTrack");if(!(this.connection instanceof go||this.connection instanceof Ld))return E.warn("[updateVideoStreamParameter]: connection is not P2PConnection or P2PConnectionPlanB");const{track:i}=n,r=function(o,s){const a={};return o.height&&o.width&&(a.scaleResolutionDownBy=pg(o,s)),a.maxFramerate=o.framerate?Pi(o.framerate):void 0,a.maxBitrate=o.bitrate?1e3*o.bitrate:void 0,a}(t,i);if(i._encoderConfig||(i._encoderConfig={}),e!==X.LocalVideoLowTrack||!N("DISABLE_DUAL_STREAM_USE_ENCODING")&&zt().supportDualStreamEncoding)r.scaleResolutionDownBy!=null&&(i._encoderConfig.scaleResolutionDownBy=r.scaleResolutionDownBy);else{const o=i._originMediaStreamTrack;if(!o.canvas)return E.warn("[".concat(i.getTrackId(),"] no canvas on track"));(function(s,a){const c=s.canvas;a.width&&(c.width=Pi(a.width)),a.height&&(c.height=Pi(a.height)),a.framerate&&(c.stopCapture&&c.stopCapture(),c.stopCapture=gT(()=>{!c.startCapture&&c.stopCapture&&c.stopCapture(),c.startCapture&&c.startCapture()},Pi(a.framerate)))})(o,t)}r.maxBitrate!=null&&(i._encoderConfig.bitrateMax=r.maxBitrate/1e3),r.maxFramerate!=null&&(i._encoderConfig.frameRate&&typeof i._encoderConfig.frameRate=="object"?i._encoderConfig.frameRate.max=r.maxFramerate:i._encoderConfig.frameRate={max:r.maxFramerate}),E.debug("[".concat(i.getTrackId(),"] LowStreamEncoderConfig: , ").concat(JSON.stringify(i._encoderConfig))),await this.connection.updateRtpSenderEncodings(i)}publishLowStream(t){var e=this;return Hi(function*(){if(!e.connection||e.state!==he.Connected)return;const n=yield Mt(e.mutex.lock("Locking from P2PChannel.publishLowStream"));try{const r=e.localTrackMap.get(X.LocalVideoTrack);if(!r)throw new G(b.UNEXPECTED_ERROR,"Could not find high stream");if(e.localTrackMap.has(X.LocalVideoLowTrack))throw new G(b.UNEXPECTED_ERROR,"[".concat(e.store.clientId,"] Can't publish low stream when stream already publish"));const o=[{track:e.getLowVideoTrack(r.track,t),type:X.LocalVideoLowTrack}];if(yield*Uf(DN(e.doPublish(e.connection,o))),r.track.muted||!r.track.enabled){var i;const s=(i=e.localTrackMap.get(X.LocalVideoLowTrack))===null||i===void 0?void 0:i.id;s!==void 0&&(yield Mt(e.connection.muteLocal([s])))}}finally{n()}})()}async republish(){this.pendingLocalTracks.length>0&&(E.debug("[".concat(this.store.clientId,"] Emit P2PChannelEvents.RequestRePublish to republish tracks.")),await En(this,yt.RequestRePublish,this.pendingLocalTracks),this.emit(yt.MediaReconnectEnd,this.store.uid),this.pendingLocalTracks=[]),this.pendingLocalDataChannels.length>0&&(E.debug("Emit P2PChannelEvents.RequestRePublishDataChannel to republish datachannels."),await En(this,yt.RequestRePublishDataChannel,this.pendingLocalDataChannels),this.pendingLocalDataChannels=[])}async reSubscribe(t){for(let e=this.pendingRemoteTracks.length-1;e>=0;e--){const{user:n,kind:i}=this.pendingRemoteTracks[e];(i!==_t.AUDIO||n._audio_added_&&n._audioSSRC)&&(i!==_t.VIDEO||n._video_added_&&n._videoSSRC)||this.pendingRemoteTracks.splice(e,1)}if(t)await En(this,yt.RequestReSubscribe,this.pendingRemoteTracks);else for(const{user:e,kind:n}of this.pendingRemoteTracks)await this.subscribe(e,n,n===_t.VIDEO?e._videoSSRC:e._audioSSRC);this.pendingRemoteTracks.forEach(e=>{let{user:n}=e;this.emit(yt.MediaReconnectEnd,n.uid)}),this.pendingRemoteTracks=[]}async unpublish(t){if(!this.connection||this.state!==he.Connected)return void t.forEach(i=>{const r=this.pendingLocalTracks.indexOf(i);r!==-1&&this.pendingLocalTracks.splice(r,1)});const e=this.filterTobeUnpublishedTracks(t);if(e.length===0)return;const n=e.find(i=>i[0]==="videoLowTrack");return n&&n[1].track.close(),this.doUnpublish(this.connection,e)}async unpublishDataChannel(t){if(!this.connection||this.state!==he.Connected)return void t.forEach(n=>{const i=this.pendingLocalDataChannels.indexOf(n);i!==-1&&this.pendingLocalDataChannels.splice(i,1)});const e=this.filterTobeUnpublishedDataChannels(t);return e.length!==0?(e.forEach(n=>{const i=this.localDataChannels.indexOf(n);i!==-1&&this.localDataChannels.splice(i,1)}),this.localDataChannels.length===0&&await this.connection.stopDataChannels(this.store.uid),e.map(n=>n.id)):void 0}async unpublishLowStream(){if(!this.connection||this.state!==he.Connected)return;const t=this.localTrackMap.get(X.LocalVideoLowTrack);if(!t)return;t.track.close();const e=[[X.LocalVideoLowTrack,t]];return this.doUnpublish(this.connection,e)}async doUnpublish(t,e){const n=this.createGatewayUnpublishMessage(e);return await t.stopSending(e.map(i=>{let[,{id:r}]=i;return r})),this.withdrawLocalTracks(e),this.unbindLocalTrackEvents(e.map(i=>{let[r,{track:o}]=i;return{type:r,track:o}})),e.forEach(i=>{let[r]=i;this.statsCollector.removeLocalStats(r)}),this.localTrackMap.size===0&&this.statsUploader.stopUploadOutboundStats(),n}async subscribeDataChannel(t,e){if(!this.connection||this.state!==he.Connected)throw new G(b.INVALID_OPERATION,"Cannot subscribe remote user when peerConnection disconnected.");const n=e.filter(i=>{var r;return!((r=this.remoteDataChannelMap.get(t))!==null&&r!==void 0&&r.get(i.id))});if(n.length!==0)return await this.connection.createDataChannels(t.uid,n),n.forEach(i=>{var r;this.remoteDataChannelMap.has(t)?(r=this.remoteDataChannelMap.get(t))===null||r===void 0||r.set(i.id,i):this.remoteDataChannelMap.set(t,new Map([[i.id,i]]));const o=this.pendingRemoteDataChannels.findIndex(s=>{let{user:a,id:c}=s;return a.uid===t.uid&&c===i.id});o!==-1&&this.pendingRemoteDataChannels.splice(o,1)}),n.map(i=>i.id)}async subscribe(t,e,n,i,r){var o;if(!this.connection||this.state!==he.Connected)throw new G(b.INVALID_OPERATION,"Cannot subscribe remote user when peerConnection disconnected.");if((o=this.remoteUserMap.get(t))!==null&&o!==void 0&&o.has(e))return;let s,a,c;if(r){const l=r.find(f=>{let{stream_type:C}=f;return C===e});if(!l)throw new G(b.UNEXPECTED_ERROR,"Cannot subscribe to remote ".concat(e," for user: ").concat(t.uid," because subscribe answer from gateway does not contain stream_type: ").concat(e,"."));const p=await this.connection.receive(e,l.ssrcs,String(t._uintid),l.attributes);this.connection instanceof go&&(c=p.transceiver),s=p.track,a=p.id}else{const l=await this.connection.receive(e,[{ssrcId:n,rtx:i}],String(t._uintid),void 0);this.connection instanceof go&&(c=l.transceiver),s=l.track,a=l.id}e===_t.AUDIO?(t._audioTrack?t._audioTrack._updateOriginMediaStreamTrack(s):(t._audioTrack=new Nd(s,t.uid,t._uintid,this.store),E.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote audio track: ").concat(t._audioTrack.getTrackId()))),c&&t._audioTrack._updateRtpTransceiver(c),this.bindRemoteTrackEvents(t,t._audioTrack)):(t._videoTrack?t._videoTrack._updateOriginMediaStreamTrack(s):(t._videoTrack=new Od(s,t.uid,t._uintid,this.store),E.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote video track: ").concat(t._videoTrack.getTrackId()))),c&&t._videoTrack._updateRtpTransceiver(c),this.bindRemoteTrackEvents(t,t._videoTrack)),N("ENABLE_VIDEO_SEI")&&c&&(e==_t.VIDEO?await FW(c.receiver,{onSei:l=>{var p;(p=t._videoTrack)===null||p===void 0||p._onSei(l)}}):e==_t.AUDIO&&await async function(l){if(!zt().supportWebRTCEncodedTransform)return void E.warning("browser not support audio encoded transform");if(wf.has(l))return;const p={track:l.track};if(Gs()){if(!l.createEncodedStreams)return void E.warning("browser not support createEncodedStreams() API");let C=null;try{C=l.createEncodedStreams()}catch(g){return void E.error("create audio-encoded-streams error",g&&g.message)}const m=new TransformStream({transform(g,y){p.controller||(p.controller=y),l.track&&l.track.id!==p.track.id&&(E.debug("audio track changed: ".concat(p.track.id," => ").concat(l.track.id)),p.track.removeEventListener("ended",f),p.track=l.track,p.track.addEventListener("ended",f)),y.enqueue(g)}});C.readable.pipeThrough(m).pipeTo(C.writable)}else if(An()){if(typeof RTCRtpScriptTransform=="undefined")return void E.warning("browser not support RTCRtpScriptTransform");const C=bf(),m=new MessageChannel;await new ot(y=>C.onmessage=A=>{A.data==="registered"&&y(void 0)});const g=new RTCRtpScriptTransform(C,{name:"rx",port:m.port2},[m.port2]);l.transform=g,await new ot(y=>C.onmessage=A=>{A.data==="started"&&y(void 0)}),m.port1.onmessage=y=>{var A;y.data.transformed&&l.track&&((A=l.track)===null||A===void 0?void 0:A.id)!==p.track.id&&(E.debug("audio track changed: ".concat(p.track.id," => ").concat(l.track.id)),p.track.removeEventListener("ended",f),p.track=l.track,p.track.addEventListener("ended",f))},p.worker=C}function f(){l.track.removeEventListener("ended",f),function(C){const m=wf.get(C);if(m){wf.delete(C);try{var g,y;(g=m.controller)===null||g===void 0||g.terminate(),(y=m.worker)===null||y===void 0||y.terminate()}catch(A){E.warning(A&&A.message)}}}(l)}wf.set(l,p),l.track.addEventListener("ended",f)}(c.receiver));const d=this.remoteUserMap.get(t);d?d.set(e,a):this.remoteUserMap.set(t,new Map([[e,a]])),this.statsCollector.addRemoteStats(t.uid),this.statsUploader.startUploadInboundStats();const u=this.pendingRemoteTracks.findIndex(l=>{let{user:p,kind:f}=l;return p.uid===t.uid&&e===f});u!==-1&&(this.pendingRemoteTracks.splice(u,1),this.emit(yt.MediaReconnectEnd,t.uid))}async massSubscribe(t){return this.massSubscribeNoLock(t)}async massSubscribeNoLock(t){if(!this.connection||this.state!==he.Connected)throw new G(b.INVALID_OPERATION,"Cannot subscribeAll remote users when peerConnection disconnected.");t=t.filter(n=>{var i;let{user:r,mediaType:o}=n;return!((i=this.remoteUserMap.get(r))!==null&&i!==void 0&&i.has(o))});const e=await this.connection.batchReceive(t.map(n=>{let{user:i,mediaType:r,ssrcId:o,rtxSsrcId:s}=n;return{kind:r,ssrcMsg:[{ssrcId:o,rtx:s}],mslabel:String(i._uintid)}}));t.forEach((n,i)=>{let{user:r,mediaType:o}=n;const{track:s,id:a,transceiver:c}=e[i];o===_t.AUDIO?(r._audioTrack?r._audioTrack._updateOriginMediaStreamTrack(s):(r._audioTrack=new Nd(s,r.uid,r._uintid,this.store),E.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote audio track: ").concat(r._audioTrack.getTrackId()))),c&&r._audioTrack._updateRtpTransceiver(c),this.bindRemoteTrackEvents(r,r._audioTrack)):(r._videoTrack?r._videoTrack._updateOriginMediaStreamTrack(s):(r._videoTrack=new Od(s,r.uid,r._uintid,this.store),E.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote video track: ").concat(r._videoTrack.getTrackId()))),c&&r._videoTrack._updateRtpTransceiver(c),this.bindRemoteTrackEvents(r,r._videoTrack));const d=this.remoteUserMap.get(r);d?d.set(o,a):this.remoteUserMap.set(r,new Map([[o,a]])),this.statsCollector.addRemoteStats(r.uid),this.statsUploader.startUploadInboundStats();const u=this.pendingRemoteTracks.findIndex(l=>{let{user:p,kind:f}=l;return p.uid===r.uid&&o===f});u!==-1&&(this.pendingRemoteTracks.splice(u,1),this.emit(yt.MediaReconnectEnd,r.uid))})}async unsubscribe(t,e,n){const i=this.pendingRemoteTracks.filter(s=>{let{user:a,kind:c}=s;return e!==void 0?a.uid===t.uid&&e===c:a.uid===t.uid});if(i.forEach(s=>{const a=this.pendingRemoteTracks.indexOf(s);this.pendingRemoteTracks.splice(a,1)}),this.connection&&this.state===he.Connected||n||i.forEach(s=>{let{kind:a}=s;var c;if(a===_t.AUDIO)(c=t._audioTrack)===null||c===void 0||c._destroy(),t._audioTrack=void 0;else if(a===_t.VIDEO){var d;(d=t._videoTrack)===null||d===void 0||d._destroy(),t._videoTrack=void 0}}),!this.connection||this.state!==he.Connected)return;const r=this.filterTobeUnSubscribedTracks(t,e);if(r.length===0)return;await this.connection.stopReceiving(r.map(s=>{let[,{id:a}]=s;return a}));const o=this.createUnsubscribeMessage(r);return this.withdrawRemoteTracks(r),this.remoteUserMap.size===0&&this.statsUploader.stopUploadInboundStats(),r.forEach(s=>{let[a,{kind:c}]=s;var d,u;if(c===_t.VIDEO&&a._videoSSRC&&((d=this.connection)===null||d===void 0||d.setStatsRemoteVideoIsReady(a._videoSSRC,!1)),c===_t.VIDEO)this.unbindRemoteTrackEvents(a._videoTrack),n||((u=a._videoTrack)===null||u===void 0||u._destroy(),a._videoTrack=void 0);else if(c===_t.AUDIO){var l;this.unbindRemoteTrackEvents(a._audioTrack),!n&&((l=a._audioTrack)===null||l===void 0||l._destroy(),a._audioTrack=void 0)}}),o}async unsubscribeDataChannel(t,e){if(e.forEach(r=>{const o=this.pendingRemoteDataChannels.findIndex(s=>s.id===r.id);o!==-1&&this.pendingRemoteDataChannels.splice(o,1)}),!this.connection)return;const n=this.filterTobeUnSubscribedDataChannels(t,e);if(n.length===0)return;e.forEach(r=>{r._close()});const i=this.remoteDataChannelMap.get(t);return n.forEach(r=>{i&&i.delete(r.id)}),i&&i.size===0&&(this.remoteDataChannelMap.delete(t),await this.connection.stopDataChannels(t.uid)),n.map(r=>r.id)}async massUnsubscribe(t){return this.massUnsubscribeNoLock(t)}async massUnsubscribeNoLock(t){let e=[];for(const{user:r,mediaType:o}of t){const s=this.pendingRemoteTracks.filter(a=>{let{user:c,kind:d}=a;return o!==void 0?c.uid===r.uid&&o===d:c.uid===r.uid});s.forEach(a=>{const c=this.pendingRemoteTracks.indexOf(a);this.pendingRemoteTracks.splice(c,1)}),e=e.concat(s)}if(!this.connection||this.state!==he.Connected)return void e.forEach(r=>{let{user:o,kind:s}=r;var a;if(s===_t.AUDIO)(a=o._audioTrack)===null||a===void 0||a._destroy(),o._audioTrack=void 0;else if(s===_t.VIDEO){var c;(c=o._videoTrack)===null||c===void 0||c._destroy(),o._videoTrack=void 0}});const n=io(t).call(t,(r,o)=>{let{user:s,mediaType:a}=o;const c=this.filterTobeUnSubscribedTracks(s,a);return r.concat(c)},[]);if(n.length===0)return;await this.connection.stopReceiving(n.map(r=>{let[,{id:o}]=r;return o}));const i=this.createUnsubscribeAllMessage(n);return this.withdrawRemoteTracks(n),this.remoteUserMap.size===0&&this.statsUploader.stopUploadInboundStats(),n.forEach(r=>{let[o,{kind:s}]=r;var a,c;if(s===_t.VIDEO&&o._videoSSRC&&((a=this.connection)===null||a===void 0||a.setStatsRemoteVideoIsReady(o._videoSSRC,!1)),s===_t.VIDEO)this.unbindRemoteTrackEvents(o._videoTrack),(c=o._videoTrack)===null||c===void 0||c._destroy(),o._videoTrack=void 0;else if(s===_t.AUDIO){var d;this.unbindRemoteTrackEvents(o._audioTrack),(d=o._audioTrack)===null||d===void 0||d._destroy(),o._audioTrack=void 0}}),i}async muteRemote(t,e){if(!this.connection)return;const n=this.remoteUserMap.get(t);if(!n)return void E.warning("[".concat(this.store.clientId,"] P2PChannel.muteRemote has no remote user ").concat(t.uid,"."));if(!n.get(e))return void E.warning("[".concat(this.store.clientId,"] P2PChannel.muteRemote has no remote user ").concat(t.uid," media type ").concat(e,"."));const i=e===_t.VIDEO?t._videoSSRC:t._audioSSRC;i!==void 0&&this.connection.setStatsRemoteVideoIsReady(i,!1)}async unmuteRemote(t,e){return this.unmuteRemoteNoLock(t,e)}async unmuteRemoteNoLock(t,e){if(!this.connection)return;const n=this.remoteUserMap.get(t);if(!n)return void E.warning("[".concat(this.store.clientId,"] P2PChannel.unmuteRemote has no remote user ").concat(t.uid,"."));n.get(e)||E.warning("[".concat(this.store.clientId,"] P2PChannel.unmuteRemote has no remote user ").concat(t.uid," media type ").concat(e,"."))}getAllTracks(t){const e=this.localTrackMap.get(X.LocalAudioTrack);if((e==null?void 0:e.track)instanceof vn){const n=e.track;return Array.from(this.localTrackMap.entries()).filter(i=>{let[r]=i;return r!==X.LocalAudioTrack}).filter(i=>{let[r]=i;return!(t&&r===X.LocalVideoLowTrack)}).map(i=>{let[,{track:r}]=i;return r}).concat(n.trackList)}return Array.from(this.localTrackMap.entries()).filter(n=>{let[i]=n;return!(t&&i===X.LocalVideoLowTrack)}).map(n=>{let[,{track:i}]=n;return i})}getAllDataChannels(){return this.localDataChannels}reportPublishEvent(t,e,n,i,r){if(t){const s=this.localTrackMap.get(X.LocalAudioTrack),a=i?this.localTrackMap.get(X.LocalVideoLowTrack):this.localTrackMap.get(X.LocalVideoTrack);Et.publish(this.store.sessionId,{eventElapse:$n.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:t,ec:e,audioName:s==null?void 0:s.track.getTrackLabel(),videoName:a==null?void 0:a.track.getTrackLabel(),screenshare:(a==null?void 0:a.track._hints.indexOf(De.SCREEN_TRACK))!==-1,audio:!!s,video:!!a,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:r})}else{var o;n||(n=[]);const s=n.find(c=>c instanceof Qe),a=i?(o=this.localTrackMap.get(X.LocalVideoTrack))===null||o===void 0?void 0:o.track:n.find(c=>c instanceof Ae);Et.publish(this.store.sessionId,{eventElapse:$n.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:t,ec:e,audioName:s==null?void 0:s.getTrackLabel(),videoName:a==null?void 0:a.getTrackLabel(),screenshare:(a==null?void 0:a._hints.indexOf(De.SCREEN_TRACK))!==-1,audio:!!s,video:!!a,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:r})}}reportSubscribeEvent(t,e,n,i){const r=i===_t.VIDEO?n._videoSSRC:n._audioSSRC;r&&Et.subscribe(this.store.sessionId,{succ:t,ec:e,video:i===_t.VIDEO,audio:i===_t.AUDIO,peerid:n.uid,subscribeRequestid:i===_t.VIDEO?n._videoSSRC:n._audioSSRC,p2pid:this.store.p2pId,eventElapse:$n.measureFromSubscribeStart(this.store.clientId,r)})}reset(){E.debug("[".concat(this.store.clientId,"] P2PChannel.reset")),this.mutex=new kn("P2PChannel-mutex"),this.connection&&(this.connection.close(),this.unbindConnectionEvents(this.connection),this.connection=void 0),this.shouldForwardP2PCreation&&(this.connection=this.store.useDataChannel?new ua({},this.store):this.isPlanB?new Ld({},this.store):new go({},this.store),this.bindConnectionEvents(this.connection)),this.statsUploader.stopUploadOutboundStats(),this.statsUploader.stopUploadInboundStats(),this.statsUploader.stopUploadTransportStats(),this.statsUploader.stopUploadExtensionUsageStats(),this.unbindLocalTrackEvents(),this.unbindAllRemoteTrackEvents(),this.unbindRtpTransceiver();const t=this.localTrackMap.get(X.LocalAudioTrack);if((t==null?void 0:t.track)instanceof vn){if(t.track.trackList.length>0){const e=t.track;t.track.trackList.forEach(n=>{e.removeAudioTrack(n)})}t.track.close()}this.localTrackMap.clear(),this.remoteUserMap.clear(),this.statsCollector.removeRemoteStats(),this.statsCollector.removeLocalStats(),this.iceFailedCount=0,this.dtlsFailedCount=0,this.pendingLocalTracks=[],this.pendingRemoteTracks=[],this.localDataChannels=[],this.remoteDataChannelMap.clear(),this.pendingLocalDataChannels=[],this.pendingRemoteDataChannels=[],this.state=he.Disconnected}getStats(){var t;return(t=this.connection)===null||t===void 0?void 0:t.getStats()}getRemoteVideoIsReady(t){var e;return((e=this.connection)===null||e===void 0?void 0:e.getRemoteVideoIsReady(t))||!1}getLocalAudioVolume(){const t=this.localTrackMap.get(X.LocalAudioTrack);if(t)return t.track.getVolumeLevel()}getLocalVideoSize(){const t=this.localTrackMap.get(X.LocalVideoTrack);if(t)return{width:t.track.videoWidth||0,height:t.track.videoHeight||0}}getEncoderConfig(t){const e=this.localTrackMap.get(t);return e&&e.track instanceof Ae||e&&e.track instanceof Qe?e.track._encoderConfig:void 0}getLocalMedia(t){return this.localTrackMap.get(t)}hasLocalMedia(){return this.localTrackMap.size>0}hasRemoteMedia(t,e){if(!t)return this.remoteUserMap.size>0;const n=this.remoteUserMap.get(t);return!!n&&(!e||n.has(e))}async hasRemoteMediaWithLock(t,e){if(!t)return this.remoteUserMap.size>0;const n=this.remoteUserMap.get(t);return!!n&&(!e||n.has(e))}getRemoteMedia(t){var e;const n=Array.from(Xi(e=this.remoteUserMap).call(e)).find(i=>i.uid===t);return n?{audioTrack:n.audioTrack,audioSSRC:n._audioSSRC,videoTrack:n.videoTrack,videoSSRC:n._videoSSRC}:{}}getAudioLevels(){let t=Array.from(this.remoteUserMap.entries()).map(n=>{let[i]=n;return{uid:i.uid,level:i.audioTrack?100*i.audioTrack._source.getAccurateVolumeLevel():0}});const e=this.localTrackMap.get(X.LocalAudioTrack);return e&&t.push({level:100*e.track._source.getAccurateVolumeLevel(),uid:this.store.uid}),t=Du(t).call(t,(n,i)=>n.level-i.level),t}async disconnectForReconnect(){this.connection&&(E.debug("[".concat(this.store.clientId,"] P2PChannel.disconnectForReconnect closing P2PConnection")),this.state=he.Reconnecting,N("KEEP_LAST_FRAME")&&this.remoteUserMap.size!==0&&Array.from(this.remoteUserMap.entries()).forEach(t=>{let[e]=t;var n;e._videoTrack&&e._videoTrack._player&&((n=e._videoTrack._player.getVideoElement())===null||n===void 0||n.pause(),e._videoTrack._player.isKeepLastFrame=!0,e._videoTrack._originMediaStreamTrack.stop())}),this.connection.close(),this.unbindConnectionEvents(this.connection),this.connection=void 0,this.shouldForwardP2PCreation&&(this.connection=this.store.useDataChannel?new ua({},this.store):this.isPlanB?new Ld({},this.store):new go({},this.store),this.bindConnectionEvents(this.connection)),this.localTrackMap.size!==0&&(Array.from(this.localTrackMap.entries()).forEach(t=>{var e;let[n,{track:i}]=t;switch(n){case X.LocalVideoTrack:it(e=i._hints).call(e,De.LOW_STREAM)?i.close():this.pendingLocalTracks.push(i);break;case X.LocalAudioTrack:i instanceof vn?this.pendingLocalTracks=this.pendingLocalTracks.concat(i.trackList):this.pendingLocalTracks.push(i);case X.LocalVideoLowTrack:}}),this.emit(yt.MediaReconnectStart,this.store.uid)),this.unbindLocalTrackEvents(),this.localTrackMap.clear(),this.remoteUserMap.size!==0&&Array.from(this.remoteUserMap.entries()).forEach(t=>{let[e,n]=t;Array.from(Xi(n).call(n)).forEach(i=>{this.setPendingRemoteMedia(e,i)}),this.emit(yt.MediaReconnectStart,e.uid)}),this.unbindAllRemoteTrackEvents(),this.remoteUserMap.clear(),this.localDataChannels.length!==0&&(this.localDataChannels.forEach(t=>{this.pendingLocalDataChannels.push(t)}),this.localDataChannels.length=0),this.remoteDataChannelMap.size!==0&&(Array.from(this.remoteDataChannelMap.entries()).forEach(t=>{let[e,n]=t;Array.from(Xi(n).call(n)).forEach(i=>{this.setPendingRemoteDataChannel(e,i)})}),this.remoteDataChannelMap.clear()),this.statsUploader.stopUploadOutboundStats(),this.statsUploader.stopUploadInboundStats(),this.statsUploader.stopUploadTransportStats(),E.debug("[".concat(this.store.clientId,"] P2PChannel disconnected, waiting to reconnect.")))}hasPendingRemoteDataChannel(t,e){for(const n of this.pendingRemoteDataChannels){const{user:i,id:r}=n;if((t instanceof aa?t.uid:t)===i.uid&&r===e)return!0}return!1}setPendingRemoteDataChannel(t,e){this.hasPendingRemoteDataChannel(t,e)||this.pendingRemoteDataChannels.push({user:t,id:e})}hasPendingRemoteMedia(t,e){for(const n of this.pendingRemoteTracks){const{user:i,kind:r}=n;if((t instanceof aa?t.uid:t)===i.uid&&e===r)return!0}return!1}setPendingRemoteMedia(t,e){this.hasPendingRemoteMedia(t,e)||this.pendingRemoteTracks.push({user:t,kind:e})}restartICE(t){var e=this;return Hi(function*(){if(!e.connection||e.state!==he.Connected||e.connection instanceof ua)return;const n=yield Mt(e.mutex.lock("From P2PChannel.restartICE"));let i;try{i=yield Mt(e.connection.restartICE(t));const o=yield Mt(i.next());if(o.done)return;const s=o.value,a=yield s;switch(e.reportPCDisconnectedOrFailed(t),t){case ai.TCP:e._pcStatsUploadType=_s.TCP_RESTART;break;case ai.RELAY:e._pcStatsUploadType=_s.RELAY_RESTART;break;default:e._pcStatsUploadType=_s.OLD_RESTART}e._isInRestartIce=!0,i.next(a)}catch(o){var r;(r=i)===null||r===void 0||r.throw(o)}finally{n()}})()}getUplinkNetworkQuality(){if(!this.connection)return 0;const t=this.connection.getStats(),e=this.localTrackMap.get(X.LocalVideoTrack),n=this.localTrackMap.get(X.LocalAudioTrack),i=t.videoSend.find(f=>f.ssrc===(e==null?void 0:e.ssrcs[0].ssrcId)),r=t.audioSend.find(f=>f.ssrc===(n==null?void 0:n.ssrcs[0].ssrcId));if(!i||!r)return 1;const o=Gi(this,yt.NeedSignalRTT),s=i?i.rttMs:void 0,a=r?r.rttMs:void 0,c=s&&a?(s+a)/2:s||a,d=(c&&o?(c+o)/2:c||o)||0,u=100*t.sendPacketLossRate*.7/50+.3*d/1500,l=u<.17?1:u<.36?2:u<.59?3:u<.1?4:5,p=e==null?void 0:e.track;if(p&&p._encoderConfig&&p._hints.indexOf(De.SCREEN_TRACK)===-1){const f=p._encoderConfig.bitrateMax,C=t.bitrate.actualEncoded;if(f&&C){const m=(1e3*f-C)/(1e3*f);return pb[m<.15?0:m<.3?1:m<.45?2:m<.6?3:4][l]}}return l}getDownlinkNetworkQuality(){if(!this.connection)return 0;const t=this.connection.getStats();let e=0;return Array.from(this.remoteUserMap.entries()).forEach(n=>{let[i]=n;const r=i._audioSSRC,o=i._videoSSRC,s=t.audioRecv.find(C=>C.ssrc===r),a=t.videoRecv.find(C=>C.ssrc===o);if(!s&&!a)return void(e+=1);const c=Gi(this,yt.NeedSignalRTT),d=t.rtt,u=(d&&c?(d+c)/2:d||c)||0,l=s?s.jitterMs:void 0,p=t.recvPacketLossRate;let f=.7*p*100/50+.3*u/1500;l&&(f=.6*p*100/50+.2*u/1500+.2*l/400),e+=f<.1?1:f<.17?2:f<.36?3:f<.59?4:5}),this.remoteUserMap.size>0?Math.round(e/this.remoteUserMap.size):e}async muteLocalTrack(t){return new ot((e,n)=>{this.handleMuteLocalTrack(t,e,n)})}async replaceTrack(t,e){var n;if(E.debug("[".concat(this.store.clientId,"] P2PChannel replaceTrack from [").concat(t.getTrackId(),"] to [").concat(e.getTrackId(),"]")),!this.connection||this.state!==he.Connected)return;const i=Array.from(this.localTrackMap.entries()).find(o=>{let[,{track:s}]=o;return t===s});if(!i)return;const r=i[0];if(t!==e&&(this.unbindLocalTrackEvents([{track:t,type:r}]),this.bindLocalTrackEvents([{track:e,type:r}]),i[1].track=e),await((n=this.connection)===null||n===void 0?void 0:n.replaceTrack(e,i[1].id)),this.isPlanB){const o=i[1];o.id=e._mediaStreamTrack.id,this.localTrackMap.set(r,o)}if(r===X.LocalVideoTrack&&!N("DISABLE_DUAL_STREAM_USE_ENCODING")&&zt().supportDualStreamEncoding){const o=this.localTrackMap.get(X.LocalVideoLowTrack);if(o){const s=t._mediaStreamTrack.clone();o.track._originMediaStreamTrack.stop(),o.track._mediaStreamTrack=s,o.track._originMediaStreamTrack=s,await new ot((a,c)=>{this.handleReplaceTrack(o.track,a,c,!0)})}}}filterTobePublishedTracks(t,e,n){const i=[],r=this.getAllTracks();t=$c(t=t.filter(c=>r.indexOf(c)===-1));let o,s=!1;const a=this.localTrackMap.get(X.LocalAudioTrack);for(const c of t){if(c instanceof Ae&&(this.localTrackMap.has(X.LocalVideoTrack)||s?new G(b.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS).throw():(i.push({track:c,type:X.LocalVideoTrack}),s=!0),e)){const d=this.getLowVideoTrack(c,n);i.push({track:d,type:X.LocalVideoLowTrack})}if(c instanceof Qe)if(a){const d=a.track;if(d instanceof vn)VT([c]),d.addAudioTrack(c),this.bindLocalAudioTrackEvents(c,!0);else{const u=FT([d,c]);E.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection will replace audioTrack [").concat(u.getTrackId(),"]")),this.replaceTrack(d,u)}}else o instanceof vn?(VT([c]),o.addAudioTrack(c)):o||!c._useAudioElement&&zt().webAudioMediaStreamDest&&!c._bypassWebAudio?o=FT(o?[c,o]:[c]):o=c}return o&&(E.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection will send audioTrack [").concat(o.getTrackId(),"]")),i.push({track:o,type:X.LocalAudioTrack})),i}filterTobeUnpublishedTracks(t){const e=[],n=this.getAllTracks();t=$c(t=t.filter(i=>n.indexOf(i)!==-1));for(const i of t){if(i instanceof Qe){const r=this.localTrackMap.get(X.LocalAudioTrack);if(!r)continue;r.track instanceof vn?(r.track.removeAudioTrack(i),this.unbindLocalAudioTrackEvents(i),r.track.trackList.length===0&&(e.push([X.LocalAudioTrack,r]),r.track.close())):e.push([X.LocalAudioTrack,r])}if(i instanceof Ae){const r=this.localTrackMap.get(X.LocalVideoTrack);if(!r)continue;e.push([X.LocalVideoTrack,r]);const o=this.localTrackMap.get(X.LocalVideoLowTrack);o&&e.push([X.LocalVideoLowTrack,o])}}return e}filterTobePublishedDataChannels(t){return t=(t=$c(t)).filter(e=>this.localDataChannels.findIndex(n=>n.id===e.id)===-1)}filterTobeUnpublishedDataChannels(t){return t=(t=(t=$c(t)).filter(e=>this.localDataChannels.indexOf(e)!==-1)).filter(e=>e._originDataChannel)}bindLocalTrackEvents(t){t.forEach(e=>{let{track:n,type:i}=e;switch(i){case X.LocalVideoTrack:n.addListener(ut.GET_STATS,this.handleGetLocalVideoStats),n.addListener(ut.GET_RTC_STATS,this.handleGetRTCStats),n.addListener(ut.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),n.addListener(ut.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),n.addListener(ut.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),n.addListener(ut.NEED_UPDATE_VIDEO_SEND_PARAMETERS,this.handleUpdateVideoSendParameters),n.addListener(ut.NEED_REPLACE_TRACK,this.handleReplaceTrack),n.addListener(ut.NEED_MUTE_TRACK,this.handleMuteLocalTrack),n.addListener(ut.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case X.LocalAudioTrack:this.bindLocalAudioTrackEvents(n);case X.LocalVideoLowTrack:}})}bindLocalAudioTrackEvents(t,e){t instanceof vn?t.trackList.forEach(n=>{n.addListener(ut.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),n.addListener(ut.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),n.addListener(ut.GET_STATS,this.handleGetLocalAudioStats),n.addListener(ut.NEED_MUTE_TRACK,this.handleMuteLocalTrack),n.addListener(ut.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack)}):(t.addListener(ut.GET_STATS,this.handleGetLocalAudioStats),t.addListener(ut.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),t.addListener(ut.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),t.addListener(ut.NEED_MUTE_TRACK,this.handleMuteLocalTrack),t.addListener(ut.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack),e||(t.addListener(ut.NEED_REPLACE_TRACK,this.handleReplaceTrack),t.addListener(ut.NEED_REPLACE_MIXING_TRACK,this.handleReplaceMixingTrack)))}unbindLocalTrackEvents(t){t||(t=Array.from(this.localTrackMap.entries()).map(e=>{let[n,{track:i}]=e;return{track:i,type:n}})),t.forEach(e=>{let{track:n,type:i}=e;switch(i){case X.LocalVideoTrack:n.off(ut.GET_STATS,this.handleGetLocalVideoStats),n.off(ut.GET_RTC_STATS,this.handleGetRTCStats),n.off(ut.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),n.off(ut.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),n.off(ut.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),n.off(ut.NEED_UPDATE_VIDEO_SEND_PARAMETERS,this.handleUpdateVideoSendParameters),n.off(ut.NEED_REPLACE_TRACK,this.handleReplaceTrack),n.off(ut.NEED_MUTE_TRACK,this.handleMuteLocalTrack),n.off(ut.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case X.LocalAudioTrack:this.unbindLocalAudioTrackEvents(n);case X.LocalVideoLowTrack:}})}unbindLocalAudioTrackEvents(t){t instanceof vn?t.trackList.forEach(e=>{e.off(ut.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),e.off(ut.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),e.off(ut.GET_STATS,this.handleGetLocalAudioStats),e.off(ut.NEED_MUTE_TRACK,this.handleMuteLocalTrack),e.off(ut.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack)}):(t.off(ut.GET_STATS,this.handleGetLocalAudioStats),t.off(ut.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),t.off(ut.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),t.off(ut.NEED_REPLACE_TRACK,this.handleReplaceTrack),t.off(ut.NEED_REPLACE_MIXING_TRACK,this.handleReplaceMixingTrack),t.off(ut.NEED_MUTE_TRACK,this.handleMuteLocalTrack),t.off(ut.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack))}bindRemoteTrackEvents(t,e){e instanceof Od&&e.addListener(ut.GET_STATS,n=>{n(this.handleGetRemoteVideoStats(t))}),e instanceof Nd&&e.addListener(ut.GET_STATS,n=>{n(this.handleGetRemoteAudioStats(t))})}unbindRemoteTrackEvents(t){t&&t.removeAllListeners(ut.GET_STATS)}unbindAllRemoteTrackEvents(){Array.from(this.remoteUserMap.entries()).forEach(t=>{let[e,n]=t;n.has(_t.AUDIO)&&this.unbindRemoteTrackEvents(e._audioTrack),n.has(_t.VIDEO)&&this.unbindRemoteTrackEvents(e._videoTrack)})}createGatewayPublishMessage(t,e){return t.map((n,i)=>{var r;let o,s,{track:a,type:c}=n;switch(c){case X.LocalAudioTrack:o=le.Audio,s={dtx:a instanceof If&&a._config.DTX,hq:!1,lq:!1,stereo:!1,speech:!1};break;case X.LocalVideoTrack:o=it(r=a._hints).call(r,De.SCREEN_TRACK)?le.Screen:le.High,s=zo(zo({},Pb(a)),{},{codec:this.store.codec});break;case X.LocalVideoLowTrack:o=le.Low,s=zo(zo({},Pb(a)),{},{codec:this.store.codec})}return{stream_type:o,attributes:s,ssrcs:e[i]}})}createGatewayUnpublishMessage(t){return t.map(e=>{var n;let i,[r,{track:o,ssrcs:s,id:a}]=e;switch(r){case X.LocalVideoTrack:i=it(n=o._hints).call(n,De.SCREEN_TRACK)?le.Screen:le.High;break;case X.LocalAudioTrack:i=le.Audio;break;case X.LocalVideoLowTrack:i=le.Low}return{stream_type:i,ssrcs:s,mid:a}})}assignLocalTracks(t,e){t.forEach((n,i)=>{let{track:r,type:o}=n;this.localTrackMap.set(o,{track:r,id:e[i].id,ssrcs:e[i].localSSRC})})}withdrawLocalTracks(t){t.forEach(e=>{let[n]=e;this.localTrackMap.delete(n)})}bindConnectionEvents(t){t.onConnectionStateChange=async e=>{if(E.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onConnectionStateChange(").concat(e,")")),this.emit(yt.PeerConnectionStateChange,e),e!=="connected"||this.store.keyMetrics.peerConnectionEnd||this.store.peerConnectionEnd(),e==="connected"&&(this._restartTimer&&(clearTimeout(this._restartTimer),this._restartTimer=void 0),(this._isFirstConnected||this._isInRestartIce)&&this.reportPCStats(Date.now(),!0,this._pcStatsUploadType),this._isInRestartIce=!1,this._isFirstConnected=!1,this._isStartRestartIce=!1),N("NEW_ICE_RESTART")){var n;if(it(n=this._restartStates).call(n,e)){if(this._isStartRestartIce)return;this._isStartRestartIce=!0;const i=s=>{(t.iceConnectionState==="disconnected"||t.iceConnectionState==="checking"||t.iceConnectionState==="failed")&&(E.debug("[".concat(this.store.clientId,"] [P2PChannel] start use restartICE, type is ").concat(s)),Gi(this,yt.QueryClientConnectionState)==="CONNECTED"&&this.emit(yt.RequestRestartICE,s))},r=()=>{t.iceConnectionState!=="disconnected"&&t.iceConnectionState!=="checking"&&t.iceConnectionState!=="failed"||(this.reportPCStats(Date.now(),!1,this._pcStatsUploadType),E.debug("[".concat(this.store.clientId,"] P2PConnection disconnected timeout, force reconnect")),setTimeout(()=>this.emit(yt.P2PLost),0),this.iceFailedCount+=1,this.requestReconnect())},o=N("ICE_RESTART_INTERVAL");return void(this._restartTimer=window.setTimeout(()=>{if(N("JOIN_WITH_FALLBACK_MEDIA_PROXY_FORCE")&&zt().supportPCSetConfiguration)i(ai.RELAY),this._restartTimer=window.setTimeout(r,o);else if(ye())i(ai.UDP),this._restartTimer=window.setTimeout(r,4e3);else{if(i(ai.TCP),zt().supportPCSetConfiguration)return void(this._restartTimer=window.setTimeout(()=>{i(ai.RELAY),this._restartTimer=window.setTimeout(r,o)},o));this._restartTimer=window.setTimeout(r,o)}},800))}}else{if(e==="disconnected"&&t.iceConnectionState==="disconnected")return setTimeout(()=>{t.iceConnectionState==="disconnected"&&N("ICE_RESTART")&&Gi(this,yt.QueryClientConnectionState)==="CONNECTED"&&this.emit(yt.RequestRestartICE)},800),void setTimeout(()=>{t.peerConnectionState==="disconnected"&&(E.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection disconnected timeout 4000ms, force reconnect")),this.reportPCStats(Date.now(),!1,this._pcStatsUploadType),this._isInRestartIce=!1,setTimeout(()=>this.emit(yt.P2PLost),0),this.iceFailedCount+=1,this.requestReconnect())},4e3);e==="failed"&&(E.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection state failed, force reconnect")),this.reportPCDisconnectedOrFailed(),setTimeout(()=>this.emit(yt.P2PLost),0),this.iceFailedCount+=1,await this.requestReconnect())}},t.onICEConnectionStateChange=e=>{e!=="connected"||this.store.keyMetrics.iceConnectionEnd||this.store.iceConnectionEnd(),E.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICEConnectionStateChange(").concat(e,")")),Et.reportApiInvoke(this.store.sessionId,{name:"ICEConnectionStateChange",options:e,tag:Je.TRACER}).onSuccess(),this.emit(yt.IceConnectionStateChange,e)},t.onICETransportStateChange=e=>{E.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICETransportStateChange(").concat(e,")"))},t.onDTLSTransportStateChange=e=>{E.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportStateChange(").concat(e,")"))},t.onDTLSTransportError=e=>{E.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportError(").concat(e,")"))},t.onFirstAudioDecoded=e=>{var n;const i=Array.from(Xi(n=this.remoteUserMap).call(n)).find(o=>o._audioSSRC===e);var r;i&&(this.store.subscribe(i.uid,"audio",void 0,void 0,void 0,Date.now()),(r=i.audioTrack)===null||r===void 0||r.emit(Id.FIRST_FRAME_DECODED),Et.firstRemoteFrame(this.store.sessionId,Mn.FIRST_AUDIO_DECODE,He.FIRST_AUDIO_DECODE,{peer:i._uintid,subscribeElapse:$n.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId}))},t.onFirstAudioReceived=e=>{var n;const i=Array.from(Xi(n=this.remoteUserMap).call(n)).find(r=>r._audioSSRC===e);i&&Et.firstRemoteFrame(this.store.sessionId,Mn.FIRST_AUDIO_RECEIVED,He.FIRST_AUDIO_RECEIVED,{peer:i._uintid,subscribeElapse:$n.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId})},t.onFirstVideoDecoded=(e,n,i)=>{this.reportVideoFirstFrameDecoded(e,n,i)},t.onFirstVideoReceived=e=>{var n;const i=Array.from(Xi(n=this.remoteUserMap).call(n)).find(r=>r._videoSSRC===e);i&&Et.firstRemoteFrame(this.store.sessionId,Mn.FIRST_VIDEO_RECEIVED,He.FIRST_VIDEO_RECEIVED,{peer:i._uintid,subscribeElapse:$n.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId})},t.onSelectedLocalCandidateChanged=(e,n)=>{const i=e.candidateType==="relay",r=n.candidateType==="relay";n.candidateType!=="unknown"&&i===r||this.emit(yt.ConnectionTypeChange,i),E.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.SelectedLocalCandidateChanged(").concat(JSON.stringify(Qs(n))," -> ").concat(JSON.stringify(Qs(e)),")"))},t.onSelectedRemoteCandidateChanged=(e,n)=>{E.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.SelectedRemoteCandidateChanged(").concat(JSON.stringify(Qs(n))," -> ").concat(JSON.stringify(Qs(e)),")"))},t.onFirstVideoDecodedTimeout=e=>{this.reportVideoFirstFrameDecoded(e,void 0,void 0,!0)},t.getLocalVideoStats=()=>{const e=this.statsCollector.getLocalVideoTrackStats(),n=this.statsCollector.getRTCStats();return zo(zo({},e),n)}}unbindConnectionEvents(t){t.onConnectionStateChange=void 0,t.onICEConnectionStateChange=void 0,t.onICETransportStateChange=void 0,t.onDTLSTransportStateChange=void 0,t.onDTLSTransportError=void 0,t.onFirstAudioDecoded=void 0,t.onFirstAudioReceived=void 0,t.onFirstVideoDecoded=void 0,t.onFirstVideoReceived=void 0,t.onSelectedLocalCandidateChanged=void 0,t.onSelectedRemoteCandidateChanged=void 0,t.onFirstVideoDecodedTimeout=void 0,t.getLocalVideoStats=void 0}filterTobeMutedTracks(t){const e=[];if(this.getAllTracks().indexOf(t)===-1)return e;const n=this.localTrackMap.get(X.LocalAudioTrack);if(t instanceof Qe&&(n==null?void 0:n.track)instanceof vn)return n.track.isActive||e.push([X.LocalAudioTrack,n]),e;const i=Array.from(this.localTrackMap.entries()).find(r=>{let[,{track:o}]=r;return t===o});if(i&&(e.push(i),i[0]===X.LocalVideoTrack)){const r=this.localTrackMap.get(X.LocalVideoLowTrack);r&&e.push([X.LocalVideoLowTrack,r])}return e}filterTobeUnmutedTracks(t){const e=[],n=this.localTrackMap.get(X.LocalAudioTrack);if(t instanceof Qe&&(n==null?void 0:n.track)instanceof vn)return n.track.isActive&&e.push([X.LocalAudioTrack,n]),e;const i=Array.from(this.localTrackMap.entries()).find(r=>{let[,{track:o}]=r;return t===o});if(i)if(i[0]===X.LocalVideoTrack){e.push(i);const r=this.localTrackMap.get(X.LocalVideoLowTrack);r&&e.push([X.LocalVideoLowTrack,r])}else e.push(i);return e}createMuteMessage(t){return t.map(e=>{var n;let i,[r,{track:o,ssrcs:s,id:a}]=e;switch(r){case X.LocalAudioTrack:i=le.Audio;break;case X.LocalVideoTrack:i=it(n=o._hints).call(n,De.SCREEN_TRACK)?le.Screen:le.High;break;case X.LocalVideoLowTrack:i=le.Low}return{stream_type:i,ssrcs:s,mid:a}})}createUnmuteMessage(t){return t.map(e=>{var n;let i,[r,{track:o,ssrcs:s,id:a}]=e;switch(r){case X.LocalAudioTrack:i=le.Audio;break;case X.LocalVideoTrack:i=it(n=o._hints).call(n,De.SCREEN_TRACK)?le.Screen:le.High;break;case X.LocalVideoLowTrack:i=le.Low}return{stream_type:i,ssrcs:s,mid:a}})}filterTobeUnSubscribedTracks(t,e){const n=[],i=this.remoteUserMap.get(t);if(!i)return n;if(e){const r=i.get(e);if(!r)return n;n.push([t,{kind:e,id:r}])}else Array.from(i.entries()).forEach(r=>{let[o,s]=r;n.push([t,{kind:o,id:s}])});return n}filterTobeUnSubscribedDataChannels(t,e){const n=[];return e.forEach(i=>{var r;(r=this.remoteDataChannelMap.get(t))!==null&&r!==void 0&&r.has(i.id)&&n.push(i)}),n}createUnsubscribeMessage(t){const e=[];return t.forEach(n=>{let[i,{kind:r,id:o}]=n;switch(r){case _t.VIDEO:return void(i._videoSSRC&&e.push({stream_type:_t.VIDEO,ssrcId:i._videoSSRC}));case _t.AUDIO:return void(i._audioSSRC&&e.push({stream_type:_t.AUDIO,ssrcId:i._audioSSRC}))}}),e}createUnsubscribeAllMessage(t){const e=new Map;return t.forEach(n=>{let[i,{kind:r}]=n;if(e.has(i)){let o=e.get(i);r===_t.VIDEO?o|=On.Video:o|=On.Audio,e.set(i,o)}else r===_t.VIDEO?e.set(i,On.Video):e.set(i,On.Audio)}),{users:Array.from(e.entries()).map(n=>{let[i,r]=n;return{stream_id:i.uid,stream_type:r}})}}withdrawRemoteTracks(t){t.forEach(e=>{let[n,{kind:i}]=e;const r=this.remoteUserMap.get(n);r&&(r.delete(i),Array.from(r.entries()).length===0&&this.remoteUserMap.delete(n))})}async updateBitrateLimit(t){const e=this.localTrackMap.get(X.LocalVideoTrack),n=this.localTrackMap.get(X.LocalVideoLowTrack);e&&await e.track.setBitrateLimit(t.uplink),n&&t.low_stream_uplink&&await n.track.setBitrateLimit({max_bitrate:t.low_stream_uplink.bitrate,min_bitrate:t.low_stream_uplink.bitrate||0})}isP2PDisconnected(){return this.connection?this.connection.peerConnectionState!=="connected":!0}mapPubResToRemoteConfig(t,e){return t.map((n,i)=>{var r;let{stream_type:o}=n;return(r=e.find(s=>{let{stream_type:a}=s;return o===a}))===null||r===void 0?void 0:r.attributes})}async tryToUnmuteAudio(t){for(let n=0;n<t.length;n++)if(t[n]instanceof Qe){var e;const i=this.filterTobeUnmutedTracks(t[n]);if(i.length===0)continue;await((e=this.connection)===null||e===void 0?void 0:e.unmuteLocal(i.map(o=>{let[,{id:s}]=o;return s})));const r=this.createUnmuteMessage(i);return void await Ie(this,yt.RequestUnmuteLocal,r)}}bindStatsUploaderEvents(){this.statsUploader.requestStats=()=>this.getStats(),this.statsUploader.requestLocalMedia=()=>Array.from(this.localTrackMap.entries()),this.statsUploader.requestRemoteMedia=()=>Array.from(this.remoteUserMap.entries()),this.statsUploader.requestVideoIsReady=t=>{var e;return!((e=this.connection)===null||e===void 0||!e.getRemoteVideoIsReady(t))},this.statsUploader.requestUpload=(t,e)=>this.emit(yt.RequestUpload,t,e),this.statsUploader.requestUploadStats=t=>this.emit(yt.RequestUploadStats,t),this.statsUploader.requestAllTracks=()=>this.getAllTracks()}unbindStatsUploaderEvents(){this.statsUploader.requestStats=void 0,this.statsUploader.requestLocalMedia=void 0,this.statsUploader.requestRemoteMedia=void 0,this.statsUploader.requestVideoIsReady=void 0}async requestReconnect(){this.dtlsFailedCount+=1,await wn(xp(this.dtlsFailedCount,dn)),this.emit(yt.RequestReconnect)}async reconnectP2P(){const t=Array.from(this.localTrackMap.entries()),e=this.createGatewayUnpublishMessage(t);Array.from(this.remoteUserMap.entries()),e.length>0&&await En(this,yt.RequestUnpublishForReconnectPC,e),this.disconnectForReconnect(),this.emit(yt.RequestReconnectPC)}canPublishLowStream(){return this.localTrackMap.has(X.LocalVideoTrack)||this.pendingLocalTracks.some(t=>t instanceof Ae)}throwIfTrackTypeNotMatch(t){if(t.filter(e=>e instanceof Ae).length>1)throw new G(b.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(t.filter(e=>e instanceof Qe).length>1&&(t.some(e=>e instanceof Qe&&e._bypassWebAudio)||!zt().webAudioMediaStreamDest))throw new G(b.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode");for(const e of t){if(e instanceof Ae&&this.pendingLocalTracks.some(n=>n instanceof Ae))throw new G(b.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(e instanceof Qe&&this.pendingLocalTracks.some(n=>n instanceof Qe)&&(!zt().webAudioMediaStreamDest||e._bypassWebAudio||this.pendingLocalTracks.some(n=>n instanceof Qe&&n._bypassWebAudio)))throw new G(b.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode")}}getLowVideoTrack(t,e){const n=!N("DISABLE_DUAL_STREAM_USE_ENCODING")&&zt().supportDualStreamEncoding,i=zo(zo({},{width:160,height:120,framerate:15,bitrate:50}),e);let r;r=n?t._mediaStreamTrack.clone():xT(t,i);const o=be(8,"track-low-"),s=new Ae(r,zo(zo({},n&&{scaleResolutionDownBy:pg(i,t)}),{},{frameRate:i.framerate,bitrateMax:i.bitrate,bitrateMin:i.bitrate}),void 0,void 0,o);return s.on($a.TRANSCEIVER_UPDATED,a=>{t._updateRtpTransceiver(a,vd.LOW_STREAM)}),s._hints.push(De.LOW_STREAM),t.on("sei-to-send",a=>{s.emit("sei-to-send",a)}),t.addListener(ut.NEED_CLOSE,()=>{s.close()}),s}async globalLock(){return this.mutex.lock("From P2PChannel.globalLock")}async reportPCStats(t,e,n){let i=arguments.length>3&&arguments[3]!==void 0?arguments[3]:null;if(this.connection&&this.connection instanceof go){var r,o,s,a;const c=this.store.keyMetrics.descriptionStart||0,{iceConnectionState:d,dtlsTransportState:u,peerConnectionState:l}=this.connection,{local:p,remote:f}=await this.connection.getSelectedCandidatePair();Et.pcStats(this.store.sessionId,{startTime:c,eventElapse:t-c||0,iceconnectionsate:d,dtlsstate:u,connectionstate:l,intSucc:e?1:2,error:i,selectedLocalCandidateProtocol:(r=p==null?void 0:p.protocol)!==null&&r!==void 0?r:"",selectedLocalCandidateType:(o=p.candidateType)!==null&&o!==void 0?o:"",selectedLocalCandidateAddress:"".concat(p.address,":").concat(p.port),selectedRemoteCandidateProtocol:(s=f.protocol)!==null&&s!==void 0?s:"",selectedRemoteCandidateType:(a=f.candidateType)!==null&&a!==void 0?a:"",selectedRemoteCandidateAddress:"".concat(f.address,":").concat(f.port),restartCnt:n})}}reportVideoFirstFrameDecoded(t,e,n,i){var r;const o=Array.from(Xi(r=this.remoteUserMap).call(r)).find(s=>s._videoSSRC===t);if(o){i||this.store.subscribe(o.uid,"video",void 0,void 0,void 0,void 0,Date.now());const s=this.store.keyMetrics,a=s.subscribe.find(c=>c.userId===o.uid&&c.type==="video");Et.firstRemoteVideoDecode(this.store.sessionId,Mn.FIRST_VIDEO_DECODE,He.FIRST_VIDEO_DECODE,{peer:o._uintid,videowidth:e,videoheight:n,subscribeElapse:$n.measureFromSubscribeStart(this.store.clientId,t),subscribeRequestid:t,p2pid:this.store.p2pId,apEnd:s.requestAPEnd||0,apStart:s.requestAPStart||0,joinGwEnd:s.joinGatewayEnd||0,joinGwStart:s.joinGatewayStart||0,pcEnd:s.peerConnectionEnd||0,pcStart:s.peerConnectionStart||0,subscriberEnd:(a==null?void 0:a.subscribeEnd)||0,subscriberStart:(a==null?void 0:a.subscribeStart)||0,videoAddNotify:(a==null?void 0:a.streamAdded)||0,state:i?1:0})}}async remoteMediaSsrcChanged(t,e,n){if(!this.connection)return!1;const i=this.remoteUserMap.get(t);if(!i)return!1;const r=i.get(e);if(!r)return!1;const o=await this.connection.getRemoteSSRC(r);return o!==void 0&&o!==n}resetConnection(t){E.debug("[".concat(this.store.clientId,"] [P2PChannel] reset connection to ").concat(t)),this.state===he.Connected?(E.debug("[".concat(this.store.clientId,"] [P2PChannel] fallback to websocket but P2PChannel state still connected, disconnect first")),this.disconnectForReconnect()):(this.connection&&(this.connection.close(),this.unbindConnectionEvents(this.connection),this.connection=void 0),this.shouldForwardP2PCreation&&(this.connection=t===Cb.datachannel?new ua({},this.store):this.isPlanB?new Ld({},this.store):new go({},this.store),this.bindConnectionEvents(this.connection)))}unbindRtpTransceiver(){this.localTrackMap.size!==0&&Array.from(this.localTrackMap.entries()).forEach(t=>{let[e,{track:n}]=t;e===X.LocalVideoLowTrack?n._updateRtpTransceiver(void 0,vd.LOW_STREAM):n._updateRtpTransceiver(void 0)})}reportPCDisconnectedOrFailed(t){this.connection&&this.connection instanceof go&&(this.connection.iceConnectionState!=="disconnected"&&this.connection.iceConnectionState!=="checking"&&this.connection.iceConnectionState!=="failed"||(this._isFirstConnected?(this.reportPCStats(Date.now(),!1,this._pcStatsUploadType),this._isFirstConnected=!1):this._pcStatsUploadType===_s.TCP_RESTART&&t===ai.RELAY?this.reportPCStats(Date.now(),!1,this._pcStatsUploadType):this.reportPCStats(Date.now(),!1,_s.DISCONNECTED_OR_FAILED)))}},nt(Vt.prototype,"startP2PConnection",[ni],Object.getOwnPropertyDescriptor(Vt.prototype,"startP2PConnection"),Vt.prototype),nt(Vt.prototype,"connect",[ni],Object.getOwnPropertyDescriptor(Vt.prototype,"connect"),Vt.prototype),nt(Vt.prototype,"updateRemoteRTPCapabilities",[ni],Object.getOwnPropertyDescriptor(Vt.prototype,"updateRemoteRTPCapabilities"),Vt.prototype),nt(Vt.prototype,"preConnect",[ni],Object.getOwnPropertyDescriptor(Vt.prototype,"preConnect"),Vt.prototype),nt(Vt.prototype,"publishDataChannel",[ni],Object.getOwnPropertyDescriptor(Vt.prototype,"publishDataChannel"),Vt.prototype),nt(Vt.prototype,"unpublish",[ni],Object.getOwnPropertyDescriptor(Vt.prototype,"unpublish"),Vt.prototype),nt(Vt.prototype,"unpublishDataChannel",[ni],Object.getOwnPropertyDescriptor(Vt.prototype,"unpublishDataChannel"),Vt.prototype),nt(Vt.prototype,"unpublishLowStream",[ni],Object.getOwnPropertyDescriptor(Vt.prototype,"unpublishLowStream"),Vt.prototype),nt(Vt.prototype,"subscribeDataChannel",[ni],Object.getOwnPropertyDescriptor(Vt.prototype,"subscribeDataChannel"),Vt.prototype),nt(Vt.prototype,"subscribe",[ni],Object.getOwnPropertyDescriptor(Vt.prototype,"subscribe"),Vt.prototype),nt(Vt.prototype,"massSubscribe",[ni],Object.getOwnPropertyDescriptor(Vt.prototype,"massSubscribe"),Vt.prototype),nt(Vt.prototype,"unsubscribe",[ni],Object.getOwnPropertyDescriptor(Vt.prototype,"unsubscribe"),Vt.prototype),nt(Vt.prototype,"unsubscribeDataChannel",[ni],Object.getOwnPropertyDescriptor(Vt.prototype,"unsubscribeDataChannel"),Vt.prototype),nt(Vt.prototype,"massUnsubscribe",[ni],Object.getOwnPropertyDescriptor(Vt.prototype,"massUnsubscribe"),Vt.prototype),nt(Vt.prototype,"muteRemote",[ni],Object.getOwnPropertyDescriptor(Vt.prototype,"muteRemote"),Vt.prototype),nt(Vt.prototype,"unmuteRemote",[ni],Object.getOwnPropertyDescriptor(Vt.prototype,"unmuteRemote"),Vt.prototype),nt(Vt.prototype,"hasRemoteMediaWithLock",[ni],Object.getOwnPropertyDescriptor(Vt.prototype,"hasRemoteMediaWithLock"),Vt.prototype),nt(Vt.prototype,"disconnectForReconnect",[ni],Object.getOwnPropertyDescriptor(Vt.prototype,"disconnectForReconnect"),Vt.prototype),nt(Vt.prototype,"updateBitrateLimit",[ni],Object.getOwnPropertyDescriptor(Vt.prototype,"updateBitrateLimit"),Vt.prototype),nt(Vt.prototype,"remoteMediaSsrcChanged",[ni],Object.getOwnPropertyDescriptor(Vt.prototype,"remoteMediaSsrcChanged"),Vt.prototype),Vt);function ni(t,e,n){const i=t[e];if(typeof i!="function")throw new Error("Cannot use mutex on object property.");return n.value=async function(){const r=this.mutex,o=await r.lock("From P2PChannel.".concat(e));try{for(var s=arguments.length,a=new Array(s),c=0;c<s;c++)a[c]=arguments[c];return await i.apply(this,a)}finally{o()}},n}function p3(t){let e=kN();return function(n,i){let r=n.appId;r!==void 0&&(fe(i,10),Jo(i,r));let o=n.cid;o!==void 0&&(fe(i,16),fe(i,o));let s=n.cname;s!==void 0&&(fe(i,26),Jo(i,s));let a=n.deviceId;a!==void 0&&(fe(i,34),Jo(i,a));let c=n.elapse;c!==void 0&&(fe(i,40),la(i,c));let d=n.fileSize;d!==void 0&&(fe(i,48),la(i,Md(d)));let u=n.height;u!==void 0&&(fe(i,56),la(i,Md(u)));let l=n.jpg;l!==void 0&&(fe(i,66),fe(i,l.length),function(Qr,z){let tt=Ud(Qr,z.length);Qr.bytes.set(z,tt)}(i,l));let p=n.networkType;p!==void 0&&(fe(i,72),la(i,Md(p)));let f=n.osType;f!==void 0&&(fe(i,80),la(i,Md(f)));let C=n.requestId;C!==void 0&&(fe(i,90),Jo(i,C));let m=n.sdkVersion;m!==void 0&&(fe(i,98),Jo(i,m));let g=n.sequence;g!==void 0&&(fe(i,104),la(i,Md(g)));let y=n.sid;y!==void 0&&(fe(i,114),Jo(i,y));let A=n.timestamp;A!==void 0&&(fe(i,120),la(i,A));let k=n.uid;k!==void 0&&(fe(i,128),fe(i,k));let M=n.vid;M!==void 0&&(fe(i,136),fe(i,M));let V=n.width;V!==void 0&&(fe(i,144),la(i,Md(V)));let B=n.service;B!==void 0&&(fe(i,152),fe(i,B));let K=n.callbackData;K!==void 0&&(fe(i,162),Jo(i,K));let Y=n.jpgEncryption;Y!==void 0&&(fe(i,168),fe(i,Y));let J=n.requestType;J!==void 0&&(fe(i,176),fe(i,J));let lt=n.scorePorn;lt!==void 0&&(fe(i,185),YT(i,lt));let Yt=n.scoreSexy;Yt!==void 0&&(fe(i,193),YT(i,Yt));let de=n.scoreNeutral;de!==void 0&&(fe(i,201),YT(i,de));let Pe=n.scene;Pe!==void 0&&(fe(i,208),fe(i,Pe));let hn=n.ossFilePrefix;hn!==void 0&&(fe(i,218),Jo(i,hn));let qe=n.serviceVendor;if(qe!==void 0)for(let Qr of qe){fe(i,226);let z=kN();E3(Qr,z),fe(i,z.limit),S3(i,z),T3(z)}}(t,e),function(n){let i=n.bytes,r=n.limit;return i.length===r?i:i.subarray(0,r)}(e)}function f3(t){return function(n){let i={};t:for(;!MN(n);){let r=Xo(n);switch(r>>>3){case 0:break t;case 1:i.code=Xo(n);break;case 2:i.msg=UN(n,Xo(n));break;case 3:{let o=m3(n);i.data=_3(n),n.limit=o;break}default:PN(n,7&r)}}return i}({bytes:e=t,offset:0,limit:e.length});var e}function _3(t){let e={};t:for(;!MN(t);){let n=Xo(t);switch(n>>>3){case 0:break t;case 1:e.requestId=UN(t,Xo(t));break;case 2:e.requestType=Xo(t)>>>0;break;case 3:e.scorePorn=qT(t);break;case 4:e.scoreSexy=qT(t);break;case 5:e.scoreNeutral=qT(t);break;case 6:e.requestScene=Xo(t)>>>0;break;case 7:e.scene=Xo(t)>>>0;break;default:PN(t,7&n)}}return e}function E3(t,e){let n=t.service;n!==void 0&&(fe(e,8),fe(e,n));let i=t.vendor;i!==void 0&&(fe(e,16),fe(e,i));let r=t.token;r!==void 0&&(fe(e,26),Jo(e,r));let o=t.callbackUrl;o!==void 0&&(fe(e,34),Jo(e,o))}function m3(t){let e=Xo(t),n=t.limit;return t.limit=t.offset+e,n}function PN(t,e){switch(e){case 0:for(;128&xN(t););break;case 2:HT(t,Xo(t));break;case 5:HT(t,4);break;case 1:HT(t,8);break;default:throw new Error("Unimplemented type: "+e)}}let g3=new Float32Array(1);new Uint8Array(g3.buffer);let WT=new Float64Array(1),Mi=new Uint8Array(WT.buffer);function Md(t){return{low:t|=0,high:t>>31,unsigned:t>=0}}let LN=[];function kN(){const t=LN.pop();return t?(t.offset=t.limit=0,t):{bytes:new Uint8Array(64),offset:0,limit:0}}function T3(t){LN.push(t)}function HT(t,e){if(t.offset+e>t.limit)throw new Error("Skip past limit");t.offset+=e}function MN(t){return t.offset>=t.limit}function Ud(t,e){let n=t.bytes,i=t.offset,r=t.limit,o=i+e;if(o>n.length){let s=new Uint8Array(2*o);s.set(n),t.bytes=s}return t.offset=o,o>r&&(t.limit=o),i}function KT(t,e){let n=t.offset;if(n+e>t.limit)throw new Error("Read past limit");return t.offset+=e,n}function UN(t,e){let n=KT(t,e),i=String.fromCharCode,r=t.bytes,o="\uFFFD",s="";for(let a=0;a<e;a++){let c,d,u,l,p=r[a+n];(128&p)==0?s+=i(p):(224&p)==192?a+1>=e?s+=o:(c=r[a+n+1],(192&c)!=128?s+=o:(l=(31&p)<<6|63&c,l<128?s+=o:(s+=i(l),a++))):(240&p)==224?a+2>=e?s+=o:(c=r[a+n+1],d=r[a+n+2],(49344&(c|d<<8))!=32896?s+=o:(l=(15&p)<<12|(63&c)<<6|63&d,l<2048||l>=55296&&l<=57343?s+=o:(s+=i(l),a+=2))):(248&p)==240?a+3>=e?s+=o:(c=r[a+n+1],d=r[a+n+2],u=r[a+n+3],(12632256&(c|d<<8|u<<16))!=8421504?s+=o:(l=(7&p)<<18|(63&c)<<12|(63&d)<<6|63&u,l<65536||l>1114111?s+=o:(l-=65536,s+=i(55296+(l>>10),56320+(1023&l)),a+=3))):s+=o}return s}function Jo(t,e){let n=e.length,i=0;for(let s=0;s<n;s++){let a=e.charCodeAt(s);a>=55296&&a<=56319&&s+1<n&&(a=(a<<10)+e.charCodeAt(++s)-56613888),i+=a<128?1:a<2048?2:a<65536?3:4}fe(t,i);let r=Ud(t,i),o=t.bytes;for(let s=0;s<n;s++){let a=e.charCodeAt(s);a>=55296&&a<=56319&&s+1<n&&(a=(a<<10)+e.charCodeAt(++s)-56613888),a<128?o[r++]=a:(a<2048?o[r++]=a>>6&31|192:(a<65536?o[r++]=a>>12&15|224:(o[r++]=a>>18&7|240,o[r++]=a>>12&63|128),o[r++]=a>>6&63|128),o[r++]=63&a|128)}}function S3(t,e){let n=Ud(t,e.limit),i=t.bytes,r=e.bytes;for(let o=0,s=e.limit;o<s;o++)i[o+n]=r[o]}function xN(t){return t.bytes[KT(t,1)]}function VN(t,e){let n=Ud(t,1);t.bytes[n]=e}function qT(t){let e=KT(t,8),n=t.bytes;return Mi[0]=n[e++],Mi[1]=n[e++],Mi[2]=n[e++],Mi[3]=n[e++],Mi[4]=n[e++],Mi[5]=n[e++],Mi[6]=n[e++],Mi[7]=n[e++],WT[0]}function YT(t,e){let n=Ud(t,8),i=t.bytes;WT[0]=e,i[n++]=Mi[0],i[n++]=Mi[1],i[n++]=Mi[2],i[n++]=Mi[3],i[n++]=Mi[4],i[n++]=Mi[5],i[n++]=Mi[6],i[n++]=Mi[7]}function Xo(t){let e,n=0,i=0;do e=xN(t),n<32&&(i|=(127&e)<<n),n+=7;while(128&e);return i}function fe(t,e){for(e>>>=0;e>=128;)VN(t,127&e|128),e>>>=7;VN(t,e)}function la(t,e){let n=e.low>>>0,i=(e.low>>>28|e.high<<4)>>>0,r=e.high>>>24,o=r===0?i===0?n<16384?n<128?1:2:n<1<<21?3:4:i<16384?i<128?5:6:i<1<<21?7:8:r<128?9:10,s=Ud(t,o),a=t.bytes;switch(o){case 10:a[s+9]=r>>>7&1;case 9:a[s+8]=o!==9?128|r:127&r;case 8:a[s+7]=o!==8?i>>>21|128:i>>>21&127;case 7:a[s+6]=o!==7?i>>>14|128:i>>>14&127;case 6:a[s+5]=o!==6?i>>>7|128:i>>>7&127;case 5:a[s+4]=o!==5?128|i:127&i;case 4:a[s+3]=o!==4?n>>>21|128:n>>>21&127;case 3:a[s+2]=o!==3?n>>>14|128:n>>>14&127;case 2:a[s+1]=o!==2?n>>>7|128:n>>>7&127;case 1:a[s]=o!==1?128|n:127&n}}function FN(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),n.push.apply(n,i)}return n}const R3=new Map([["moderation",1],["supervise",2]]);class qf extends Ve{get connectionState(){return this._connectionState}set connectionState(e){if(this._connectionState===e)return;const n=this._connectionState;this._connectionState=e,this.emit(xn.CONNECTION_STATE_CHANGE,n,e)}get inspectType(){return this._inspectType}set inspectType(e){var n;this._inspectMode=io(n=e.map(i=>R3.get(i)||0)).call(n,(i,r)=>i+r),this._inspectType=e}get quality(){return this._quality}set quality(e){this._quality=e>1?1:e<.1?.1:e,this.qualityTimer&&(window.clearTimeout(this.qualityTimer),this.qualityTimer=null),this._quality>=1||(this.qualityTimer=window.setTimeout(()=>{this.quality=this._quality/this.qualityRatio},6e4))}constructor(e){super(),R(this,"name","AgoraRTCVideoContentInspect"),R(this,"_connectionState",Mr.CONNECTING),R(this,"_innerConnectionState",void 0),R(this,"sequence",0),R(this,"inspectStartTime",void 0),R(this,"workerManagerConnection",void 0),R(this,"workerConnection",void 0),R(this,"workerMessageLengthLimit",void 0),R(this,"inspectIntervalMinimum",void 0),R(this,"qualityRatio",void 0),R(this,"_connectInfo",void 0),R(this,"_cancelTokenSource",yi.CancelToken.source()),R(this,"_retryConfig",void 0),R(this,"wmSequence",0),R(this,"inspectInterval",void 0),R(this,"inspectTimer",null),R(this,"ossFilePrefix",void 0),R(this,"extraInfo",void 0),R(this,"_inspectType",void 0),R(this,"_inspectMode",void 0),R(this,"_quality",1),R(this,"qualityTimer",null),R(this,"_inspectId",void 0),R(this,"_needWorkUrlOnly",!1),R(this,"inspectImage",()=>{if(this.connectionState!==Mr.CONNECTED)throw new U(b.OPERATION_ABORTED,"content inspect service connection status is ".concat(this.connectionState));this.inspectTimer&&(window.clearInterval(this.inspectTimer),this.inspectTimer=null),this.inspectTimer=window.setInterval(()=>{this.connectionState===Mr.CONNECTED?this.requestToInspectImage():E.debug("[".concat(this._inspectId,"] Inspect State is not connected , "),this.connectionState)},this.inspectInterval<this.inspectIntervalMinimum?this.inspectIntervalMinimum:this.inspectInterval),this.requestToInspectImage()}),this._inspectId=be(5,"inspect-"),this.workerMessageLengthLimit=N("VIDEO_INSPECT_WORKER_MESSAGE_LENGTH_LIMIT"),this.inspectIntervalMinimum=N("VIDEO_INSPECT_INTERVAL_MINIMUM"),this.qualityRatio=N("VIDEO_INSPECT_QUALITY_RATIO"),this.inspectInterval=e.interval,this.ossFilePrefix=e.ossFilePrefix,this.extraInfo=e.extraInfo,this.inspectType=e.inspectType,this.inspectStartTime=Number(Date.now()),this.workerManagerConnection=new tl("worker-manager-"+this._inspectId,dn),this.on(xn.STATE_CHANGE,(n,i)=>{this._innerConnectionState=n,E.debug("[".concat(this._inspectId,"] Inspect operation :").concat(Ur[n]," ").concat(i||""))}),this.handleWorkerManagerEvents(),this.workerConnection=new tl("worker-"+this._inspectId,dn),this.handleWorkerEvents()}async init(e,n){this.emit(xn.STATE_CHANGE,Ur.CONNECT_AP),this._connectInfo=e;const i=this._cancelTokenSource.token;return this._retryConfig=n,new ot((r,o)=>{this.on(xn.CONNECTION_STATE_CHANGE,(s,a)=>{a===Mr.CONNECTED&&r()}),this.requestAP(e,i,n).then(s=>{this.connectWorkerManager(s)}).catch(s=>{o(s)})})}async requestAP(e,n,i){const r=N("WEBCS_DOMAIN").map(a=>"https://".concat(a,"/api/v1")),o=await function(a,c,d,u){let{appId:l,areaCode:p,cname:f,sid:C,token:m,uid:g}=c;cd++;const y="image_moderation_api",A={service_name:y,json_body:JSON.stringify({appId:l,areaCode:p,cname:f,command:"allocateEdge",requestId:cd,seq:cd,sid:C,token:m,ts:Date.now(),uid:g+""})};let k,M,V=a[0];return so(async()=>{k=Date.now();const B=await lo(V,{data:A,cancelToken:d,headers:{"X-Packet-Service-Type":"0","X-Packet-URI":"61"},params:{action:"wrtc_gateway"}});if(M=Date.now()-k,B.code!==0){const lt=new U(b.UNEXPECTED_RESPONSE,"image inspect ap error, code"+B.code,{retry:!0,responseTime:M});throw E.error(lt.toString()),lt}const K=JSON.parse(B.json_body);if(K.code!==200){const lt=new U(b.UNEXPECTED_RESPONSE,"image inspect ap error, code: ".concat(K.code,", reason: ").concat(K.reason),{code:K.code,responseTime:M});throw E.error(lt.toString()),lt}if(!K.servers||!Array.isArray(K.servers)||K.servers.length===0){const lt=new U(b.UNEXPECTED_RESPONSE,"image inspect ap empty server",{code:K.code,responseTime:M});throw E.error(lt.toString()),lt}const Y=N("VIDEO_INSPECT_WORKER_MANAGER_HOST"),J=N("VIDEO_INSPECT_WORKER_MANAGER_PORT");return{addressList:K.servers.map(lt=>{let{address:Yt,wss:de}=lt;if(Yt&&de)return"wss://".concat(Yt.replace(/\./g,"-"),".").concat(Y,":").concat(J||de)}).filter(lt=>!!lt),workerToken:K.workerToken,vid:K.vid,responseTime:M}},(B,K)=>(Et.apworkerEvent(C,{success:!0,sc:200,serviceName:y,responseDetail:JSON.stringify(B.addressList),firstSuccess:K===0,responseTime:M,serverIp:a[K%a.length]}),!1),(B,K)=>(Et.apworkerEvent(C,{success:!1,sc:B.data&&B.data.code||200,serviceName:y,responseTime:M,serverIp:a[K%a.length]}),!!(B.code!==b.OPERATION_ABORTED&&B.code!==b.UNEXPECTED_RESPONSE||B.data&&B.data.retry)&&(V=a[(K+1)%a.length],!0)),u)}(r,e,n,i);this.emit(xn.STATE_CHANGE,Ur.AP_CONNECTED);const{addressList:s}=o;return this.wmSequence++,s}async connectWorkerManager(e){let n=arguments.length>1&&arguments[1]!==void 0&&arguments[1];this._needWorkUrlOnly=n,this.emit(xn.STATE_CHANGE,Ur.CONNECT_WORKER_MANAGER),await this.workerManagerConnection.init(e,1e4)}async connectWorker(e){await this.workerConnection.init([e])}handleWorkerManagerEvents(){this.workerManagerConnection.on(It.CONNECTED,async()=>{this.emit(xn.STATE_CHANGE,Ur.WORKER_MANAGER_CONNECTED,this.workerManagerConnection.url),this.workerManagerConnection.sendMessage({appId:this._connectInfo.appId,cname:this._connectInfo.cname,uid:this._connectInfo.uid+"",sdkVersion:"4.21.0",sid:this._connectInfo.sid,seq:this.wmSequence,ts:Number(Date.now()),requestId:Math.floor(1e12*Math.random()),allocate:!0,clientRequest:{command:"join"}},!0)}),this.workerManagerConnection.on(It.CLOSED,()=>{this._innerConnectionState<Ur.GET_WORKER_MANAGER_RESPONSE&&E.debug("[".concat(this._inspectId,"] Inspect worker manager is closed before connecting worker"))}),this.workerManagerConnection.on(It.FAILED,()=>{this._innerConnectionState<Ur.GET_WORKER_MANAGER_RESPONSE&&E.debug("[".concat(this._inspectId,"] Connecting inspect worker manager is failed before connecting worker"))}),this.workerManagerConnection.on(It.RECONNECTING,()=>{this._innerConnectionState<Ur.GET_WORKER_MANAGER_RESPONSE&&E.debug("[".concat(this._inspectId,"] Inspect worker manager is reconnecting before connecting worker"))}),this.workerManagerConnection.on(It.ON_MESSAGE,async e=>{this.emit(xn.STATE_CHANGE,Ur.GET_WORKER_MANAGER_RESPONSE);const n=this.workerManagerConnection.url;this.workerManagerConnection.close();const i=JSON.parse(e.data);if(i.code!==200)throw E.error("[".concat(this._inspectId,"] Unexpected code ").concat(i.code," from worker manager")),new U(b.UNEXPECTED_RESPONSE,"response code of worker is unexpected",i);if(!(i.serverResponse&&i.serverResponse.portWss&&n))throw E.error("[".concat(this._inspectId,"] Unexpected content from worker manager : ").concat(JSON.stringify(i))),new U(b.UNEXPECTED_RESPONSE,"response content of worker is unexpected",i);{const r=N("VIDEO_INSPECT_WORKER_PORT")||i.serverResponse.portWss,o=n.replace(/:\d+\/?$/,":".concat(r));this.emit(xn.STATE_CHANGE,Ur.CONNECT_WORKER,o),this._needWorkUrlOnly?this.emit(xn.REQUEST_NEW_WORKER_URL,o):await this.connectWorker(o)}}),this.workerManagerConnection.on(It.WILL_RECONNECT,(e,n,i)=>{i(e)}),this.workerManagerConnection.on(It.REQUEST_NEW_URLS,(e,n)=>{this.requestAP(this._connectInfo,this._cancelTokenSource.token,this._retryConfig).then(e).catch(n)})}handleWorkerEvents(){this.workerConnection.on(It.CONNECTED,async()=>{this.emit(xn.STATE_CHANGE,Ur.WORKER_CONNECTED,this.workerConnection.url),this.connectionState=Mr.CONNECTED}),this.workerConnection.on(It.ON_MESSAGE,async e=>{if(e.data instanceof ArrayBuffer){const i=f3(new Uint8Array(e.data));if(N("SHOW_VIDEO_INSPECT_WORKER_MESSAGE")&&E.debug("[".concat(this._inspectId,"] Response message for worker of inspect content "),JSON.stringify(i)),i.code===200){if(Array.isArray(this.inspectType)&&this.inspectType.length===1&&this.inspectType[0]==="supervise")return void this.emit(xn.INSPECT_RESULT,void 0,void 0);if(i.data&&i.data.scorePorn&&i.data.scoreSexy&&i.data.scoreNeutral){var n;const r={porn:i.data.scorePorn,sexy:i.data.scoreSexy,neutral:i.data.scoreNeutral},o=io(n=Object.keys(r)).call(n,(a,c)=>r[a]>r[c]?a:c,"porn"),s=Object.keys(r).find(a=>a===o);this.emit(xn.INSPECT_RESULT,s)}else this.emit(xn.INSPECT_RESULT,void 0,new U(b.UNEXPECTED_RESPONSE,i.code+"","There is an unexpected data on message"))}else this.emit(xn.INSPECT_RESULT,void 0,new U(b.UNEXPECTED_RESPONSE,i.code+"",i.msg))}else E.error("[".concat(this._inspectId,"] Unexpected message type from worker")),this.emit(xn.INSPECT_RESULT,void 0,new U(b.UNEXPECTED_RESPONSE,"invalid worker message type"))}),this.workerConnection.on(It.CLOSED,()=>{this.connectionState=Mr.CLOSED}),this.workerConnection.on(It.FAILED,()=>{this.connectionState=Mr.CLOSED}),this.workerConnection.on(It.RECONNECTING,()=>{this.connectionState=this.connectionState===Mr.CONNECTED?Mr.RECONNECTING:Mr.CONNECTING}),this.workerConnection.on(It.WILL_RECONNECT,(e,n,i)=>{e==="recover"&&i(e),i("tryNext")}),this.workerConnection.on(It.REQUEST_NEW_URLS,(e,n)=>{this.workerManagerConnection.close(),this.once(xn.REQUEST_NEW_WORKER_URL,i=>{e([i])}),this.requestAP(this._connectInfo,this._cancelTokenSource.token,this._retryConfig).then(i=>{this.connectWorkerManager(i,!0)}).catch(i=>{n(i)})})}static intToLong(e){return{low:e|=0,high:e>>31,unsigned:e>=0}}async requestToInspectImage(){this.sequence++;const e=Gi(this,xn.CLIENT_LOCAL_VIDEO_TRACK),n={appId:this._connectInfo.appId,cname:this._connectInfo.cname,cid:this._connectInfo.cid,sid:this._connectInfo.sid,uid:this._connectInfo.uid,vid:this._connectInfo.vid};if(e){if(!e.isPlaying)return void this.emit(xn.INSPECT_RESULT,void 0,new U(b.INVALID_OPERATION,"Only the track being played can be inspected"));const i=await this.generateRequestData(e,n);this.workerConnection.sendMessage(i,!0,!0)}else this.emit(xn.INSPECT_RESULT,void 0,new U(b.INVALID_OPERATION,"Only the track being published can be inspected"))}async generateRequestData(e,n){let{appId:i,cname:r,cid:o,vid:s,sid:a,uid:c}=n;const d=Date.now(),u=await e.getCurrentFrameImage("image/jpeg",this.quality),l=await jw(u,i,r),p=this.sequence+"-"+o+"-"+c+"-"+d+"-"+be(12,""),f={appId:i,cid:o,cname:r,deviceId:"",elapse:qf.intToLong(Number(d-this.inspectStartTime)),fileSize:l.byteLength,jpgEncryption:2,height:u.height,width:u.width,jpg:l,networkType:6,osType:7,requestId:p,sdkVersion:"4.21.0",sequence:this.sequence,sid:a,timestamp:qf.intToLong(d),uid:c,vid:s,service:this._inspectMode,callbackData:this.extraInfo,ossFilePrefix:this.ossFilePrefix};this.extraInfo===void 0&&delete f.callbackData,this.ossFilePrefix===void 0&&delete f.ossFilePrefix;const C=p3(f);if(C.byteLength<this.workerMessageLengthLimit){if(N("SHOW_VIDEO_INSPECT_WORKER_MESSAGE")){const m=function(g){for(var y=1;y<arguments.length;y++){var A=arguments[y]!=null?arguments[y]:{};y%2?FN(Object(A),!0).forEach(function(k){R(g,k,A[k])}):Object.getOwnPropertyDescriptors?Object.defineProperties(g,Object.getOwnPropertyDescriptors(A)):FN(Object(A)).forEach(function(k){Object.defineProperty(g,k,Object.getOwnPropertyDescriptor(A,k))})}return g}({},f);delete m.jpg,E.debug("[".concat(this._inspectId,"] Request message for worker of inspect content "),JSON.stringify(m))}return C}{const m=this.quality*this.qualityRatio;return this.quality=m,await this.generateRequestData(e,{appId:i,cname:r,cid:o,vid:s,sid:a,uid:c})}}close(){this._cancelTokenSource.cancel(),this._cancelTokenSource=yi.CancelToken.source(),this.workerManagerConnection&&this.workerManagerConnection.close(),this.workerConnection&&this.workerConnection.close(),this.inspectTimer&&window.clearInterval(this.inspectTimer),this.inspectTimer=null,this.connectionState=Mr.CLOSED,this.emit(xn.STATE_CHANGE,Ur.CLOSED)}}function C3(t){let e=function(){const n=I3.pop();return n?(n.offset=n.limit=0,n):{bytes:new Uint8Array(64),offset:0,limit:0}}();return function(n,i){let r=n.appId;r!==void 0&&(ln(i,10),ha(i,r));let o=n.cid;o!==void 0&&(ln(i,16),ln(i,o));let s=n.cname;s!==void 0&&(ln(i,26),ha(i,s));let a=n.deviceId;a!==void 0&&(ln(i,34),ha(i,a));let c=n.elapse;c!==void 0&&(ln(i,40),pa(i,c));let d=n.fileSize;d!==void 0&&(ln(i,48),pa(i,xd(d)));let u=n.height;u!==void 0&&(ln(i,56),pa(i,xd(u)));let l=n.jpg;l!==void 0&&(ln(i,66),ln(i,l.length),BN(i,l));let p=n.networkType;p!==void 0&&(ln(i,72),pa(i,xd(p)));let f=n.osType;f!==void 0&&(ln(i,80),pa(i,xd(f)));let C=n.requestId;C!==void 0&&(ln(i,90),ha(i,C));let m=n.sdkVersion;m!==void 0&&(ln(i,98),ha(i,m));let g=n.sequence;g!==void 0&&(ln(i,104),pa(i,xd(g)));let y=n.sid;y!==void 0&&(ln(i,114),ha(i,y));let A=n.timestamp;A!==void 0&&(ln(i,120),pa(i,A));let k=n.uid;k!==void 0&&(ln(i,128),ln(i,k));let M=n.vid;M!==void 0&&(ln(i,136),ln(i,M));let V=n.width;V!==void 0&&(ln(i,144),pa(i,xd(V)));let B=n.service;B!==void 0&&(ln(i,152),ln(i,B));let K=n.callbackData;K!==void 0&&(ln(i,162),ln(i,K.length),BN(i,K));let Y=n.ticket;Y!==void 0&&(ln(i,170),ha(i,Y));let J=n.vendorConfigs;J!==void 0&&(ln(i,178),ha(i,J))}(t,e),function(n){let i=n.bytes,r=n.limit;return i.length===r?i:i.subarray(0,r)}(e)}function v3(t){return function(n){let i={};t:for(;!b3(n);){let r=Ml(n);switch(r>>>3){case 0:break t;case 1:i.code=Ml(n);break;case 2:i.msg=GN(n,Ml(n));break;case 3:i.requestId=GN(n,Ml(n));break;case 4:i.timestamp=A3(n,!1);break;default:y3(n,7&r)}}return i}({bytes:e=t,offset:0,limit:e.length});var e}function y3(t,e){switch(e){case 0:for(;128&Xr(t););break;case 2:zT(t,Ml(t));break;case 5:zT(t,4);break;case 1:zT(t,8);break;default:throw new Error("Unimplemented type: "+e)}}function xd(t){return{low:t|=0,high:t>>31,unsigned:t>=0}}let I3=[];function zT(t,e){if(t.offset+e>t.limit)throw new Error("Skip past limit");t.offset+=e}function b3(t){return t.offset>=t.limit}function Yf(t,e){let n=t.bytes,i=t.offset,r=t.limit,o=i+e;if(o>n.length){let s=new Uint8Array(2*o);s.set(n),t.bytes=s}return t.offset=o,o>r&&(t.limit=o),i}function jN(t,e){let n=t.offset;if(n+e>t.limit)throw new Error("Read past limit");return t.offset+=e,n}function BN(t,e){let n=Yf(t,e.length);t.bytes.set(e,n)}function GN(t,e){let n=jN(t,e),i=String.fromCharCode,r=t.bytes,o="\uFFFD",s="";for(let a=0;a<e;a++){let c,d,u,l,p=r[a+n];(128&p)==0?s+=i(p):(224&p)==192?a+1>=e?s+=o:(c=r[a+n+1],(192&c)!=128?s+=o:(l=(31&p)<<6|63&c,l<128?s+=o:(s+=i(l),a++))):(240&p)==224?a+2>=e?s+=o:(c=r[a+n+1],d=r[a+n+2],(49344&(c|d<<8))!=32896?s+=o:(l=(15&p)<<12|(63&c)<<6|63&d,l<2048||l>=55296&&l<=57343?s+=o:(s+=i(l),a+=2))):(248&p)==240?a+3>=e?s+=o:(c=r[a+n+1],d=r[a+n+2],u=r[a+n+3],(12632256&(c|d<<8|u<<16))!=8421504?s+=o:(l=(7&p)<<18|(63&c)<<12|(63&d)<<6|63&u,l<65536||l>1114111?s+=o:(l-=65536,s+=i(55296+(l>>10),56320+(1023&l)),a+=3))):s+=o}return s}function ha(t,e){let n=e.length,i=0;for(let s=0;s<n;s++){let a=e.charCodeAt(s);a>=55296&&a<=56319&&s+1<n&&(a=(a<<10)+e.charCodeAt(++s)-56613888),i+=a<128?1:a<2048?2:a<65536?3:4}ln(t,i);let r=Yf(t,i),o=t.bytes;for(let s=0;s<n;s++){let a=e.charCodeAt(s);a>=55296&&a<=56319&&s+1<n&&(a=(a<<10)+e.charCodeAt(++s)-56613888),a<128?o[r++]=a:(a<2048?o[r++]=a>>6&31|192:(a<65536?o[r++]=a>>12&15|224:(o[r++]=a>>18&7|240,o[r++]=a>>12&63|128),o[r++]=a>>6&63|128),o[r++]=63&a|128)}}function Xr(t){return t.bytes[jN(t,1)]}function WN(t,e){let n=Yf(t,1);t.bytes[n]=e}function Ml(t){let e,n=0,i=0;do e=Xr(t),n<32&&(i|=(127&e)<<n),n+=7;while(128&e);return i}function ln(t,e){for(e>>>=0;e>=128;)WN(t,127&e|128),e>>>=7;WN(t,e)}function A3(t,e){let n,i=0,r=0,o=0;return n=Xr(t),i=127&n,128&n&&(n=Xr(t),i|=(127&n)<<7,128&n&&(n=Xr(t),i|=(127&n)<<14,128&n&&(n=Xr(t),i|=(127&n)<<21,128&n&&(n=Xr(t),r=127&n,128&n&&(n=Xr(t),r|=(127&n)<<7,128&n&&(n=Xr(t),r|=(127&n)<<14,128&n&&(n=Xr(t),r|=(127&n)<<21,128&n&&(n=Xr(t),o=127&n,128&n&&(n=Xr(t),o|=(127&n)<<7))))))))),{low:i|r<<28,high:r>>>4|o<<24,unsigned:e}}function pa(t,e){let n=e.low>>>0,i=(e.low>>>28|e.high<<4)>>>0,r=e.high>>>24,o=r===0?i===0?n<16384?n<128?1:2:n<1<<21?3:4:i<16384?i<128?5:6:i<1<<21?7:8:r<128?9:10,s=Yf(t,o),a=t.bytes;switch(o){case 10:a[s+9]=r>>>7&1;case 9:a[s+8]=o!==9?128|r:127&r;case 8:a[s+7]=o!==8?i>>>21|128:i>>>21&127;case 7:a[s+6]=o!==7?i>>>14|128:i>>>14&127;case 6:a[s+5]=o!==6?i>>>7|128:i>>>7&127;case 5:a[s+4]=o!==5?128|i:127&i;case 4:a[s+3]=o!==4?n>>>21|128:n>>>21&127;case 3:a[s+2]=o!==3?n>>>14|128:n>>>14&127;case 2:a[s+1]=o!==2?n>>>7|128:n>>>7&127;case 1:a[s]=o!==1?128|n:127&n}}const HN={},KN={},zf=4294967296,qN=zf*zf,YN=qN/2,JT=JN(0,!0),zN=JN(0),w3=Vd(0,-2147483648,!1),O3=Vd(-1,2147483647,!1),N3=Vd(-1,-1,!0);function JN(t,e){let n,i,r;return e?(r=0<=(t>>>=0)&&t<256)&&(i=KN[t],i)?i:(n=Vd(t,0,!0),r&&(KN[t]=n),n):(r=-128<=(t|=0)&&t<128)&&(i=HN[t],i)?i:(n=Vd(t,t<0?-1:0,!1),r&&(HN[t]=n),n)}function Vd(t,e,n){return{low:0|t,high:0|e,unsigned:!!n}}function D3(t,e){if(isNaN(t))return e?JT:zN;if(e){if(t<0)return JT;if(t>=qN)return N3}else{if(t<=-YN)return w3;if(t+1>=YN)return O3}return t<0?e?JT:zN:Vd(t%zf|0,t/zf|0,e)}function XN(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),n.push.apply(n,i)}return n}class XT extends Ve{get connectionState(){return this._connectionState}set connectionState(e){if(this._connectionState===e)return;const n=this._connectionState;this._connectionState=e,this.emit(co.CONNECTION_STATE_CHANGE,e,n)}get quality(){return this._quality}set quality(e){this._quality=e>1?1:e<.1?.1:e,this._qualityTimer&&(window.clearTimeout(this._qualityTimer),this._qualityTimer=null),this._quality>=1||(this._qualityTimer=window.setTimeout(()=>{this.quality=this._quality/this._qualityRatio},6e4))}constructor(e){var n;super(),R(this,"name","AgoraRTCImageModeration"),R(this,"_connectionState",_r.CONNECTING),R(this,"_sequence",0),R(this,"_moderationStartTime",void 0),R(this,"_workerConnection",void 0),R(this,"_workerMessageLengthLimit",void 0),R(this,"_qualityRatio",void 0),R(this,"_connectInfo",void 0),R(this,"_cancelTokenSource",yi.CancelToken.source()),R(this,"_retryConfig",void 0),R(this,"_moderationInterval",void 0),R(this,"_moderationTimer",null),R(this,"_moderationMode",1),R(this,"_quality",1),R(this,"_qualityTimer",null),R(this,"_ticket",void 0),R(this,"_moderationIntervalMinimum",void 0),R(this,"_uploadFailedNum",0),R(this,"_uploadNum",0),R(this,"_uploadTimer",null),R(this,"_extraInfo",void 0),R(this,"_vendor",""),R(this,"_encoder",new TextEncoder),R(this,"_moderationId",void 0),R(this,"inspectImage",()=>{if(this.connectionState!==_r.CONNECTED)throw new U(b.OPERATION_ABORTED,"image moderation service connection status is ".concat(this.connectionState));this._moderationTimer&&(window.clearInterval(this._moderationTimer),this._moderationTimer=null),this._moderationTimer=window.setInterval(()=>{this.connectionState===_r.CONNECTED?this.requestToInspectImage():E.debug("[".concat(this._moderationId,"] Moderation State is not connected , "),this.connectionState)},this._moderationInterval<this._moderationIntervalMinimum?this._moderationIntervalMinimum:this._moderationInterval),this.requestToInspectImage()}),this._moderationId=be(5,"image-moderation-"),this._workerMessageLengthLimit=N("IMAGE_MODERATION_WORKER_MESSAGE_LENGTH_LIMIT"),this._moderationIntervalMinimum=N("IMAGE_MODERATION_INTERVAL_MINIMUM"),this._moderationInterval=(n=e.interval)!==null&&n!==void 0?n:1e3,e.extraInfo&&(this._extraInfo=this._encoder.encode(e.extraInfo)),e.vendor&&(this._vendor=e.vendor),this._qualityRatio=N("IMAGE_MODERATION_QUALITY_RATIO"),this._moderationStartTime=Number(Date.now()),this._workerConnection=new tl("worker-"+this._moderationId,dn),this.on(co.STATE_CHANGE,(i,r)=>{E.debug("[".concat(this._moderationId,"] Moderation operation :").concat(od[i]," ").concat(r||""))}),this.handleWorkerEvents()}async init(e,n){this.emit(co.STATE_CHANGE,od.CONNECT_AP),this._connectInfo=e;const i=this._cancelTokenSource.token;return this._retryConfig=n,new ot((r,o)=>{this.on(co.CONNECTION_STATE_CHANGE,(s,a)=>{s===_r.CONNECTED&&r()}),this.requestAP(e,i,n).then(s=>{this.connectWorker(s)}).catch(s=>{o(s)})})}updateConfig(e){var n;this._moderationInterval=(n=e.interval)!==null&&n!==void 0?n:1e3,e.extraInfo&&(this._extraInfo=this._encoder.encode(e.extraInfo)),e.vendor&&(this._vendor=e.vendor),E.debug("[".concat(this._moderationId,"] updateConfig: ").concat(JSON.stringify(e))),this.connectionState===_r.CONNECTED&&this.inspectImage()}async requestAP(e,n,i){const r=N("WEBCS_DOMAIN").map(c=>"https://".concat(c,"/api/v1")),o=await function(c,d,u,l){let{appId:p,areaCode:f,cname:C,sid:m,token:g,uid:y}=d;cd++;const A="moderation_plugin",k={service_name:A,json_body:JSON.stringify({appId:p,areaCode:f,cname:C,command:"allocateEdge",requestId:cd,seq:cd,sid:m,appToken:g,ts:Date.now(),uid:y+""})};let M,V,B=c[0];return so(async()=>{M=Date.now();const K=await lo(B,{data:k,cancelToken:u,headers:{"X-Packet-Service-Type":"0","X-Packet-URI":"61"},params:{action:"wrtc_gateway"}});if(V=Date.now()-M,K.code!==0){const lt=new U(b.UNEXPECTED_RESPONSE,"moderation plugin ap error, code"+K.code,{retry:!0,responseTime:V});throw E.error(lt.toString()),lt}const Y=JSON.parse(K.json_body);if(Y.code!==200){const lt=new U(b.UNEXPECTED_RESPONSE,"moderation plugin ap error, code: ".concat(Y.code,", reason: ").concat(Y.reason),{code:Y.code,responseTime:V});throw E.error(lt.toString()),lt}if(!Y.servers||!Array.isArray(Y.servers)||Y.servers.length===0){const lt=new U(b.UNEXPECTED_RESPONSE,"moderation plugin ap empty server",{code:Y.code,responseTime:V});throw E.error(lt.toString()),lt}if(!Y.servers.some(lt=>!!lt.wss)){const lt=new U(b.UNEXPECTED_RESPONSE,"moderation plugin ap empty port",{code:Y.code,responseTime:V});throw E.error(lt.toString()),lt}const J=N("IMAGE_MODERATION_WORKER_HOST");return{addressList:Y.servers.map(lt=>{let{address:Yt,wss:de}=lt;if(Yt&&de)return"wss://".concat(Yt.replace(/\./g,"-"),".").concat(J,":").concat(de,"/moderation")}).filter(lt=>!!lt),workerToken:Y.workerToken,vid:Y.vid,ticket:Y.appTicket,responseTime:V}},(K,Y)=>(Et.apworkerEvent(m,{success:!0,sc:200,serviceName:A,responseDetail:JSON.stringify(K.addressList),firstSuccess:Y===0,responseTime:V,serverIp:c[Y%c.length]}),!1),(K,Y)=>(Et.apworkerEvent(m,{success:!1,sc:K.data&&K.data.code||200,serviceName:A,responseTime:V,serverIp:c[Y%c.length]}),!!(K.code!==b.OPERATION_ABORTED&&K.code!==b.UNEXPECTED_RESPONSE||K.data&&K.data.retry)&&(B=c[(Y+1)%c.length],!0)),l)}(r,e,n,i);this.emit(co.STATE_CHANGE,od.AP_CONNECTED);const{addressList:s,ticket:a}=o;return this._ticket=a,s}async connectWorker(e){this.emit(co.STATE_CHANGE,od.CONNECT_WORKER),await this._workerConnection.init(e,1e4)}handleWorkerEvents(){this._workerConnection.on(It.CONNECTED,async()=>{this.emit(co.STATE_CHANGE,od.WORKER_CONNECTED,this._workerConnection.url),this.connectionState=_r.CONNECTED}),this._workerConnection.on(It.CLOSED,()=>{this.connectionState=_r.CLOSED}),this._workerConnection.on(It.FAILED,()=>{this.connectionState=_r.CLOSED}),this._workerConnection.on(It.RECONNECTING,()=>{this.connectionState=this.connectionState===_r.CONNECTED?_r.RECONNECTING:_r.CONNECTING}),this._workerConnection.on(It.ON_MESSAGE,async e=>{if(e.data instanceof ArrayBuffer){const n=v3(new Uint8Array(e.data));N("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")&&E.debug("[".concat(this._moderationId,"] Response message for worker of image moderation "),JSON.stringify(n)),this._uploadNum++,n.code===void 0||n.code===0||(this._uploadFailedNum++,E.error("[".concat(this._moderationId,"] Error response from worke, code is ").concat(n.code,", msg is ").concat(n.msg)),this._uploadTimer||(this._uploadTimer=window.setTimeout(()=>{Et.reportApiInvoke(this._connectInfo.sid||null,{name:_n.IMAGE_MODERATION_UPLOAD,options:[this._uploadFailedNum,this._uploadNum,n.code],tag:Je.TRACER}).onError(new U(b.IMAGE_MODERATION_UPLOAD_FAILED,n.msg)),this._uploadTimer=null},N("IMAGE_MODERATION_UPLOAD_REPORT_INTERVAL"))))}else E.error("[".concat(this._moderationId,"] Unexpected message type from worker"))}),this._workerConnection.on(It.WILL_RECONNECT,(e,n,i)=>{e==="recover"&&i(e),i("tryNext")}),this._workerConnection.on(It.REQUEST_NEW_URLS,(e,n)=>{this.requestAP(this._connectInfo,this._cancelTokenSource.token,this._retryConfig).then(e).catch(n)})}static intToLong(e){return{low:e|=0,high:e>>31,unsigned:e>=0}}async requestToInspectImage(){const e=Gi(this,co.CLIENT_LOCAL_VIDEO_TRACK),n={appId:this._connectInfo.appId,cname:this._connectInfo.cname,cid:this._connectInfo.cid,sid:this._connectInfo.sid,uid:this._connectInfo.uid,vid:this._connectInfo.vid};if(e){if(!e.isPlaying)return void(N("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")&&E.debug("Only the track being played can be inspected"));this._sequence++;const i=await this.generateRequestData(e,n);this._workerConnection.sendMessage(i,!0,!0)}else N("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")&&E.debug("Only the track being published can be inspected")}async generateRequestData(e,n){let{appId:i,cname:r,cid:o,vid:s,sid:a,uid:c}=n;const d=Date.now(),u=await e.getCurrentFrameImage("image/jpeg",this.quality),l=await jw(u,i,r),p=this._sequence+"-"+o+"-"+c+"-"+d+"-"+be(12,""),f={appId:i,cid:o,cname:r,deviceId:"",elapse:XT.intToLong(Number(d-this._moderationStartTime)),fileSize:u.buffer.byteLength,height:u.height,width:u.width,jpg:l,networkType:6,osType:7,requestId:p,sdkVersion:"4.21.0",sequence:this._sequence,sid:a,timestamp:D3(d),uid:c,vid:s,service:this._moderationMode,ticket:this._ticket,callbackData:this._extraInfo,vendorConfigs:this._vendor};this._extraInfo===void 0&&delete f.callbackData;const C=C3(f);if(C.byteLength<this._workerMessageLengthLimit){if(N("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")){const m=function(g){for(var y=1;y<arguments.length;y++){var A=arguments[y]!=null?arguments[y]:{};y%2?XN(Object(A),!0).forEach(function(k){R(g,k,A[k])}):Object.getOwnPropertyDescriptors?Object.defineProperties(g,Object.getOwnPropertyDescriptors(A)):XN(Object(A)).forEach(function(k){Object.defineProperty(g,k,Object.getOwnPropertyDescriptor(A,k))})}return g}({},f);delete m.jpg,E.debug("[".concat(this._moderationId,"] Request message for worker of image moderation service: "),JSON.stringify(m))}return C}{const m=this.quality*this._qualityRatio;return this.quality=m,await this.generateRequestData(e,{appId:i,cname:r,cid:o,vid:s,sid:a,uid:c})}}close(){this._cancelTokenSource.cancel(),this._cancelTokenSource=yi.CancelToken.source(),this._workerConnection&&this._workerConnection.close(),this._moderationTimer&&window.clearInterval(this._moderationTimer),this._moderationTimer=null,this._uploadTimer&&window.clearTimeout(this._uploadTimer),this._uploadTimer=null,this.connectionState=_r.CLOSED,this.emit(co.STATE_CHANGE,od.CLOSED)}}function QN(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),n.push.apply(n,i)}return n}function ZN(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?QN(Object(n),!0).forEach(function(i){R(t,i,n[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):QN(Object(n)).forEach(function(i){Object.defineProperty(t,i,Object.getOwnPropertyDescriptor(n,i))})}return t}const P3=Date.now(),L3=20,QT=new Map,Jf=new Map;async function $N(t){const e=QT.get(t),n=Array.isArray(e)&&e[e.length-1],i=Jf.get(t);if(!n)return void(i.isSyncing=!1);const r={uid:n.uid,payload:n.payload};i.firstRecvTs===0&&(i.firstRecvTs=n.recvTs,i.firstSendTs=n.sendTs);const o=n.sendTs-i.firstSendTs,s=o-(Date.now()-i.firstRecvTs);s>0&&(i.firstRecvTs=Date.now()-o);let a=n.mediaDelay+s;a<=0?(e.pop(),tD(n.context,r),a=0):a=Math.min(a,L3),setTimeout(()=>e.length&&$N(t),a)}function tD(t,e){t.safeEmit(Kt.STREAM_MESSAGE,e.uid,e.payload),t.onStreamMessage&&t.onStreamMessage(e)}function k3(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:0,n=arguments.length>2?arguments[2]:void 0;if(!t.syncWithAudio)return tD(n,{uid:t.uid,payload:t.payload});const i="".concat(n.id,"-").concat(t.uid),r=QT.get(i)||[],o=r.findIndex(d=>t.sendTs>=d.sendTs),s=ZN(ZN({},t),{},{context:n,mediaDelay:e,recvTs:Date.now()});o===-1?r.push(s):r.splice(o,0,s),QT.set(i,r);let a=!1;var c;Jf.has(i)?a=!((c=Jf.get(i))===null||c===void 0||!c.isSyncing):Jf.set(i,{isSyncing:a,firstRecvTs:0,firstSendTs:0}),a||$N(i)}const M3=Zt().name;function eD(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),n.push.apply(n,i)}return n}function nD(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?eD(Object(n),!0).forEach(function(i){R(t,i,n[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):eD(Object(n)).forEach(function(i){Object.defineProperty(t,i,Object.getOwnPropertyDescriptor(n,i))})}return t}const Fd="websdk_ng_cache_parameter",U3=N("MAX_PRELOAD_ASYNC_LENGTH"),x3=1e4,cc=new Map,dc=[];let ZT=null,$T=0,tS=0;const Xf=new Map,V3=function(t,e){const n=[];let i=0;const r=async()=>{const o=n.shift();o&&await o(),n.length>0&&i<e?r():i--};return async function(){for(var o=arguments.length,s=new Array(o),a=0;a<o;a++)s[a]=arguments[a];return new ot(async(c,d)=>{n.push(async()=>{try{const u=await t(...s);c(u)}catch(u){d(u)}}),i<e&&(i++,r())})}}(iD,U3),eS=yi.CancelToken.source();async function iD(t,e,n,i,r){try{if(!N("ENABLE_PRELOAD"))return;if(!zt().supportWebCrypto)return void Hs(()=>{E.warn("Your browser does not support preloading, this feature  be run in a secure environment")},"preload_webcrypto_not_supported");if(!n&&n!==null)throw new G(b.INVALID_PARAMS,"Invalid token: ".concat(n,". If you don not use token, set it to null"));n&&Fn(n,"token",1,2047),Fn(t,"appid",1,2047),Gp(e),i&&Wp(i);const o=Ju();E.debug("preload channel ".concat(e,", uid is ").concat(i));const s={appId:t,cname:e,token:n||t,uid:typeof i!="string"?i:null,sid:o,proxyServer:r};let a,c;typeof i=="string"?(s.stringUid=i,[c,a]=await ot.all([oB(i,{sid:o,appId:t},eS.token),zb(nD(nD({},s),{},{token:n||t,uid:0}),eS.token)]),s.uid=c.uid,a.gatewayInfo.uid=s.uid,a.gatewayInfo.res.uid=s.uid):a=await zb(s,eS.token);const d={sid:o,appId:t,cname:e,token:n||t,uid:s.stringUid||i,intUid:s.uid||a.gatewayInfo.uid,stringUid:s.stringUid,ts:Date.now(),sua:c,ap:a};await async function(u){let l;try{u.uid&&oD({appId:u.appId,cname:u.cname,token:u.token,uid:u.uid,stringUid:u.stringUid});const p=dD(u),f=await async function(m,g){try{const y=await window.crypto.subtle.importKey("raw",ZI(g),"AES-GCM",!1,["encrypt"]),A=await window.crypto.subtle.encrypt({name:"AES-GCM",iv:new Uint8Array(1)},y,Va(window.btoa(JSON.stringify(m))));return Ks(new Uint8Array(A))}catch{return}}(u,u.token||u.appId);if(!f)return;l=cD(Fd);const C=l?JSON.parse(l):[];C.push({[p]:f}),C.length>N("AP_CACHE_NUM")&&C.shift(),Qf(Fd,JSON.stringify(C))}catch(p){E.warn("Error caching server parameters:",p.message),Qf(Fd,"")}}(d),$T++}catch(o){throw tS++,function(s){ZT||(ZT=window.setTimeout(()=>{let c="";Xf.forEach((d,u)=>{c+="".concat(u,": ").concat(d," ;")}),Et.reportApiInvoke(null,{name:_n.PRELOAD,options:{success:$T,failed:tS,err:c}}).onError(s),$T=0,tS=0,Xf.clear(),ZT=null},x3));const a=Xf.get(s.code)||0;Xf.set(s.code,a+1)}(o),o}}async function rD(t){try{const e=oD(t);if(!e||t.cloudProxyServer!=="disabled")return;const n=await async function(i,r){try{const o=await window.crypto.subtle.importKey("raw",ZI(r),"AES-GCM",!1,["decrypt"]),s=await window.crypto.subtle.decrypt({name:"AES-GCM",iv:new Uint8Array(1)},o,Va(i));return JSON.parse(window.atob(Ks(new Uint8Array(s))))}catch{return}}(e,t.token||t.appId);if(!n||!function(i,r){return i.cname===r.cname&&i.appId===r.appId&&i.token===r.token?r.stringUid?i.stringUid===r.stringUid:typeof r.uid=="number"?i.uid===r.uid:i.uid==r.uid:!1}(n,t))return;if(n&&Date.now()-n.ts<N("AP_CACHE_LIFETIME"))return n}catch(e){E.warn("Error get preloadInfo",e.message)}}function oD(t){let e;try{if(e=cD(Fd),!e)return;const n=JSON.parse(e),i=dD(t),r=function(s,a){for(let c=s.length-1;c>=0;c--)if(a(s[c]))return c;return-1}(n,s=>i in s);if(r===-1)return;const o=n.splice(r,1)[0];return Qf(Fd,JSON.stringify(n)),o[i]}catch(n){E.warn("Error delete preload info: ".concat(e),n.message),Qf(Fd,"")}}function nS(t){if(t){let e=cc.get(t);e&&(window.clearTimeout(e),e=null,cc.delete(t)),it(dc).call(dc,t)||t.cloudProxyServer!=="disabled"||dc.push(t)}if(cc.size<N("AP_CACHE_NUM")&&dc.length>0){const e=dc.shift();cc.set(e,window.setTimeout(async()=>{const{appId:n,cname:i,token:r,uid:o,proxyServer:s}=e;try{await V3(n,i,r,o,s),cc.has(e)&&nS(e)}catch(a){E.warn("update preload failed",a.message),sD(e)}},N("AP_UPDATE_INTERVAL")))}}function sD(t){const e=dc.indexOf(t);e!==-1&&dc.splice(e,1);let n=cc.get(t);n&&(window.clearTimeout(n),n=null,cc.delete(t),nS())}function aD(t,e){const n=t.sua,i=t.ap;e&&n&&Et.reqUserAccount(t.sid,{lts:n.requestTime,elapse:n.elapse,success:!0,serverAddr:n.url,stringUid:e,uid:t.intUid,errorCode:null,extend:n.req}),Et.reportResourceTiming(t.ap.url,t.sid),Et.joinWebProxyAP(t.sid,{lts:i.requestTime,elapse:i.elapse,sucess:1,apServerAddr:i.url,turnServerAddrList:i.proxyInfo.addresses.map(r=>r.ip).join(","),eventType:"disabled",unilbsServerIds:[un.CHOOSE_SERVER,un.CLOUD_PROXY_FALLBACK].toString()}),Et.joinChooseServer(t.sid,{lts:i.requestTime,elapse:i.elapse,succ:!0,csAddr:i.url,opid:i.opid,serverList:i.gatewayInfo.gatewayAddrs.map(r=>r.address),ec:null,cid:i.gatewayInfo.cid.toString(),uid:i.gatewayInfo.uid.toString(),csIp:i.gatewayInfo.csIp,unilbsServerIds:[un.CHOOSE_SERVER].toString(),isHttp3:i.isHttp3})}function cD(t){return window.atob(window.localStorage.getItem(t)||"")}function Qf(t,e){window.localStorage.setItem(t,window.btoa(e))}function dD(t){let e="".concat(t.appId,"_").concat(t.cname);return typeof t.uid=="string"&&(e+="_s_".concat(t.uid)),typeof t.uid=="number"&&(e+="_".concat(t.uid)),t.token&&(e+="_".concat(t.token)),ob(e)}var uD,lD,hD,pD,fD,_D,ED,mD,gD,TD,SD,RD,CD,vD,yD,ID,bD,AD,wD,OD,ND,DD,PD,LD,kD,MD,UD,xD,VD,FD,jD,BD,GD,WD,HD,KD,qD,YD,zD,JD,XD,QD,at;function ZD(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),n.push.apply(n,i)}return n}function Rr(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?ZD(Object(n),!0).forEach(function(i){R(t,i,n[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):ZD(Object(n)).forEach(function(i){Object.defineProperty(t,i,Object.getOwnPropertyDescriptor(n,i))})}return t}kn.setLogger(E);let F3=(uD=Ct(),lD=Ct({argsMap:(t,e)=>{if(!Array.isArray(e)){if(!(e instanceof bd))return[e];e=[e]}return e.map(n=>n?Object(n).toString():"null")}}),hD=Ct({argsMap:(t,e)=>(e||(e=[]),e instanceof S0?[e.getChannelId()]:(Array.isArray(e)||(e=[e]),e.map(n=>n.getTrackId())))}),pD=Ct({argsMap:(t,e,n,i)=>[typeof e=="object"?e.uid:e,n,i]}),fD=Ct({argsMap:(t,e,n)=>[e,n]}),_D=Ct({argsMap:(t,e)=>e.map(n=>{let{user:i,mediaType:r}=n;return[i==null?void 0:i.uid,r]})}),ED=Ct({argsMap:(t,e,n,i)=>[typeof e=="object"?e.uid:e,n,i]}),mD=Ct({argsMap:(t,e)=>e.map(n=>{let{user:i,mediaType:r}=n;return{uid:i==null?void 0:i.uid,mediaType:r}})}),gD=Ct(),TD=Ct(),SD=Ct(),RD=Ct(),CD=Ct(),vD=Ct(),yD=Ct(),ID=Ct(),bD=Ct(),AD=Ct(),wD=Ct(),OD=Ct(),ND=Ct(),DD=Ct(),PD=Ct({argsMap:(t,e)=>[e]}),LD=Ct(),kD=Ct(),MD=Ct(),UD=Ct(),xD=Ct(),VD=Ct(),FD=Ct(),jD=Ct(),BD=Ct(),GD=Ct(),WD=Ct({argsMap:(t,e)=>(Array.isArray(e)||(e=[e]),[JSON.stringify(e)])}),HD=Ct(),KD=Ct(),qD=Ct(),YD=Ct(),zD=Ct(),JD=Ct(),XD=Ct({reportResult:!0}),QD=Ct(),at=class extends Ve{get connectionState(){return this._gateway.state}get remoteUsers(){return this._users}get localTracks(){return this._p2pChannel.getAllTracks(!0)}get uid(){return this._uid}get channelName(){return this._channelName}get localDataChannels(){return this._p2pChannel.getAllDataChannels()}get mode(){return this._config.mode}get role(){var t;return((t=this._config)===null||t===void 0?void 0:t.role)||"audience"}get codec(){return this._config.codec}get audioCodec(){return this._config.audioCodec||"opus"}get isStringUID(){return!!this._joinInfo&&!!this._joinInfo.stringUid}get __className__(){return"Client"}constructor(t){let e;if(super(),R(this,"store",void 0),R(this,"_uid",void 0),R(this,"_channelName",void 0),R(this,"_uintUid",void 0),R(this,"_users",[]),R(this,"_config",void 0),R(this,"_clientId",void 0),R(this,"_appId",void 0),R(this,"_sessionId",null),R(this,"_key",void 0),R(this,"_rtmConfig",{}),R(this,"_joinInfo",void 0),R(this,"_gateway",void 0),R(this,"_statsCollector",void 0),R(this,"_configDistribute",void 0),R(this,"_leaveMutex",new kn("client-leave")),R(this,"_publishMutex",new kn("client-publish")),R(this,"_renewTokenMutex",new kn("client-renewtoken")),R(this,"_subscribeMutex",new kn("client-subscribe")),R(this,"_encryptionMode","none"),R(this,"_encryptionSecret",null),R(this,"_encryptionSalt",null),R(this,"_encryptDataStream",!1),R(this,"_encryptDataStreamKey",null),R(this,"_encryptDataStreamIv",null),R(this,"_proxyServer",void 0),R(this,"_turnServer",{servers:[],mode:"auto"}),R(this,"_cloudProxyServerMode","disabled"),R(this,"_isDualStreamEnabled",!1),R(this,"_defaultStreamFallbackType",void 0),R(this,"_lowStreamParameter",void 0),R(this,"_streamFallbackTypeCacheMap",new Map),R(this,"_remoteStreamTypeCacheMap",new Map),R(this,"_axiosCancelSource",yi.CancelToken.source()),R(this,"_audioVolumeIndicationInterval",void 0),R(this,"_networkQualityInterval",void 0),R(this,"_userOfflineTimeout",void 0),R(this,"_streamRemovedTimeout",void 0),R(this,"_injectStreamingClient",void 0),R(this,"_liveTranscodeStreamingClient",void 0),R(this,"_liveRawStreamingClient",void 0),R(this,"_channelMediaRelayClient",void 0),R(this,"_networkQualitySensitivity","normal"),R(this,"_p2pChannel",void 0),R(this,"_useLocalAccessPoint",!1),R(this,"_setLocalAPVersion",void 0),R(this,"_joinAndNotLeaveYet",!1),R(this,"_numberOfJoinCount",0),R(this,"_remoteDefaultVideoStreamType",void 0),R(this,"_inspect",void 0),R(this,"_moderation",void 0),R(this,"_license",void 0),R(this,"_pendingPublishedUsers",[]),R(this,"ntpAlignErrorCount",0),R(this,"remoteInboundOffset",0),R(this,"_handleLocalTrackEnable",(n,i,r)=>{this.publish(n,!1).then(i).catch(r)}),R(this,"_handleLocalTrackDisable",(n,i,r)=>{this.unpublish(n).then(i).catch(r)}),R(this,"_handleUserOnline",n=>{if(N("BLOCK_LOCAL_CLIENT")&&ja(n.uid,this.channelName))return void E.debug("[".concat(n.uid,"] will be ignored in local"));this.isStringUID&&typeof n.uid!="string"&&E.error("[".concat(this._clientId,"] StringUID is Mixed with UintUID"));const i=this._users.find(r=>r.uid===n.uid);if(i)i._trust_in_room_=!0,i._is_pre_created&&(i._is_pre_created=!1,this.safeEmit(Kt.USER_JOINED,i));else{const r=new aa(n.uid,n.uint_id||n.uid);this._users.push(r),E.debug("[".concat(this._clientId,"] user online"),n.uid),this.safeEmit(Kt.USER_JOINED,r)}}),R(this,"_handleUserOffline",n=>{if(N("BLOCK_LOCAL_CLIENT")&&ja(n.uid,this.channelName))return;const i=this._users.find(r=>r.uid===n.uid);i&&(this._handleRemoveStream(n),this._handleRemoveDataChannels(n),i._audio_pre_subscribed||i._video_pre_subscribed?i._is_pre_created=!0:Lp(this._users,i),this._remoteStreamTypeCacheMap.delete(i.uid),this._streamFallbackTypeCacheMap.delete(i.uid),E.debug("[".concat(this._clientId,"] user offline"),n.uid,"reason:",n.reason),this.safeEmit(Kt.USER_LEAVED,i,n.reason))}),R(this,"_handleAddAudioOrVideoStream",(n,i,r,o,s,a,c)=>{if(N("BLOCK_LOCAL_CLIENT")&&ja(i,this.channelName))return;const d=this._users.find(l=>l.uid===i);if(!d)return void E.error("[".concat(this._clientId,"] can not find target user!(on_add_stream)"));E.debug("[".concat(this._clientId,"] stream added with uid ").concat(i,", type ").concat(n)),this.store.subscribe(d.uid,n,void 0,void 0,void 0,Date.now());const u=n==="audio"?d.hasAudio:d.hasVideo;d._uintid||(d._uintid=s||i),n==="audio"?d._trust_audio_stream_added_state_=!0:d._trust_video_stream_added_state_=!0,n==="audio"?(d._audio_added_=!0,r!==void 0&&(d._audioSSRC=r),o!==void 0&&(d._cname=o),a&&(d._audioOrtc=a)):(d._video_added_=!0,r!==void 0&&(d._videoSSRC=r),o!==void 0&&(d._cname=o),c!==void 0&&(d._rtxSsrcId=c),a&&(d._videoOrtc=a)),(n==="audio"?d.hasAudio:d.hasVideo)&&!u&&(E.info("[".concat(this._clientId,"] remote user ").concat(d.uid," published ").concat(n)),this.safeEmit(Kt.USER_PUBLISHED,d,n)),n==="video"?Et.onGatewayStream(this._sessionId,Mn.ON_ADD_VIDEO_STREAM,He.ON_ADD_VIDEO_STREAM,{peer:s||i,ssrc:d._videoSSRC}):Et.onGatewayStream(this._sessionId,Mn.ON_ADD_AUDIO_STREAM,He.ON_ADD_AUDIO_STREAM,{peer:s||i,ssrc:d._audioSSRC}),this._p2pChannel.remoteMediaSsrcChanged(d,n,r).then(l=>{if(l&&(E.debug("[".concat(this._clientId,"] resubscribe ").concat(n," for user ").concat(d.uid," after rejoin because SSRC id changed.")),this._p2pChannel instanceof Kf))return this._p2pChannel.unsubscribe(d,n,!0).then(()=>this._subscribe(d,n,!0).catch(p=>{E.error("[".concat(this._clientId,"] resubscribe error"),p.toString())}))}),this._p2pChannel.hasPendingRemoteMedia(d,n)&&(E.debug("[".concat(this._clientId,"] resubscribe ").concat(n," for user ").concat(d.uid," after reconnect.")),this._subscribe(d,n,!0).catch(l=>{E.error("[".concat(this._clientId,"] resubscribe error"),l.toString())}))}),R(this,"_handleRemoveStream",n=>{if(N("BLOCK_LOCAL_CLIENT")&&ja(n.uid,this.channelName))return;const i=this._users.find(o=>o.uid===n.uid);if(!i)return void E.warning("[".concat(this._clientId,"] can not find target user!(on_remove_stream)"));E.debug("[".concat(this._clientId,"] stream removed with uid ").concat(n.uid));let r=()=>{};i.hasAudio&&i.hasVideo?r=()=>{E.info("[".concat(this._clientId,"] remote user ").concat(i.uid," unpublished audio track")),this.safeEmit(Kt.USER_UNPUBLISHED,i,"audio"),E.info("[".concat(this._clientId,"] remote user ").concat(i.uid," unpublished video track")),this.safeEmit(Kt.USER_UNPUBLISHED,i,"video")}:i.hasVideo?r=()=>{E.info("[".concat(this._clientId,"] remote user ").concat(i.uid," unpublished video track")),this.safeEmit(Kt.USER_UNPUBLISHED,i,"video")}:i.hasAudio&&(r=()=>{E.info("[".concat(this._clientId,"] remote user ").concat(i.uid," unpublished audio track")),this.safeEmit(Kt.USER_UNPUBLISHED,i,"audio")}),i._video_pre_subscribed||i._audio_pre_subscribed||(i._trust_audio_stream_added_state_=!0,i._trust_video_stream_added_state_=!0,i._audio_added_=!1,i._video_added_=!1,this._p2pChannel instanceof Kf&&this._p2pChannel.unsubscribe(i).then(o=>{if(o)return this._gateway.unsubscribe(o,i.uid)}),i._audioSSRC=void 0,i._videoSSRC=void 0,i._audioOrtc=void 0,i._videoOrtc=void 0,i._rtxSsrcId=void 0),Et.onGatewayStream(this._sessionId,Mn.ON_REMOVE_STREAM,He.ON_REMOVE_STREAM,{peer:n.uint_id||n.uid}),r()}),R(this,"_handleSetStreamLocalEnable",(n,i,r)=>{if(N("BLOCK_LOCAL_CLIENT")&&ja(i,this.channelName))return;const o=this._users.find(c=>c.uid===i);if(!o)return void E.error("[".concat(this._clientId,"] can not find target user!(disable_local)"));E.debug("[".concat(this._clientId,"] local ").concat(n," ").concat(r?"enabled":"disabled"," with uid ").concat(i));const s=n==="audio"?o.hasAudio:o.hasVideo;if(n==="audio"){o._trust_audio_enabled_state_=!0;const c=o._audio_enabled_;if(o._audio_enabled_=r,o._audio_enabled_===c)return;{const d=o._audio_enabled_?"enable-local-audio":"disable-local-audio";E.debug("[".concat(this._clientId,"] user-info-updated, uid: ").concat(i,", msg: ").concat(d)),this.safeEmit(Kt.USER_INFO_UPDATED,i,d)}}else{o._trust_video_enabled_state_=!0;const c=o._video_enabled_;if(o._video_enabled_=r,o._video_enabled_===c)return;{const d=o._video_enabled_?"enable-local-video":"disable-local-video";E.debug("[".concat(this._clientId,"] user-info-update, uid: ").concat(i,", msg: ").concat(d)),this.safeEmit(Kt.USER_INFO_UPDATED,i,d)}}const a=n==="audio"?o.hasAudio:o.hasVideo;return s!==a?!s&&a?(E.info("[".concat(this._clientId,"] remote user ").concat(i," published ").concat(n)),void this.safeEmit(Kt.USER_PUBLISHED,o,n)):(n==="video"&&o._videoTrack&&o._videoTrack._destroy(),n==="audio"&&o._audioTrack,this._p2pChannel.muteRemote(o,n),E.info("[".concat(this._clientId,"] remote user ").concat(i," unpublished ").concat(n)),void this.safeEmit(Kt.USER_UNPUBLISHED,o,n)):void 0}),R(this,"_handleMuteStream",(n,i,r)=>{if(N("BLOCK_LOCAL_CLIENT")&&ja(n,this.channelName))return;E.debug("[".concat(this._clientId,"] receive mute message"),n,i,r);const o=this._users.find(c=>c.uid===n);if(!o)return void E.warning("[".concat(this._clientId,"] can not find remote user, ignore mute event, uid: ").concat(n));const s=i==="audio"?o.hasAudio:o.hasVideo;if(i==="audio"){o._trust_audio_mute_state_=!0;const c=o._audio_muted_;if(o._audio_muted_=r,o._audio_muted_===c)return;{const d=o._audio_muted_?"mute-audio":"unmute-audio";E.debug("[".concat(this._clientId,"] user-info-update, uid: ").concat(n,", msg: ").concat(d)),this.safeEmit(Kt.USER_INFO_UPDATED,n,d)}}else{o._trust_video_mute_state_=!0;const c=o._video_muted_;if(o._video_muted_=r,o._video_muted_===c)return;{const d=o._video_muted_?"mute-video":"unmute-video";E.debug("[".concat(this._clientId,"] user-info-update, uid: ").concat(n,", msg: ").concat(d)),this.safeEmit(Kt.USER_INFO_UPDATED,n,d)}}const a=i==="audio"?o.hasAudio:o.hasVideo;if(s!==a){if(!s&&a)return(i==="audio"?o._audioSSRC:o._videoSSRC)?(E.info("[".concat(this._clientId,"] remote user ").concat(n," published ").concat(i)),void this.safeEmit(Kt.USER_PUBLISHED,o,i)):void E.warning("[".concat(this._clientId,"] remote user ").concat(n," receive ").concat(i," unmute message  before add stream message, ").concat(i," SSRC doesn't exist yet."));i==="video"&&o._videoTrack&&!o._video_pre_subscribed&&o._videoTrack._destroy(),i==="audio"&&o._audioTrack,this._p2pChannel.muteRemote(o,i),E.info("[".concat(this._clientId,"] remote user ").concat(n," unpublished ").concat(i)),this.safeEmit(Kt.USER_UNPUBLISHED,o,i)}}),R(this,"_handleP2PLost",async n=>{E.debug("[".concat(this._clientId,"] receive p2p lost"),n),parseInt(n.p2pid,10)===this.store.p2pId?await this._p2pChannel.requestReconnect():E.warning("[".concat(this._clientId,"] P2PLost stream not found"),n)}),R(this,"_handleTokenWillExpire",()=>{E.debug("[".concat(this._clientId,"] received message onTokenPrivilegeWillExpire")),this.safeEmit(Kt.ON_TOKEN_PRIVILEGE_WILL_EXPIRE)}),R(this,"_handleBeforeUnload",n=>{n.type==="beforeunload"&&n.returnValue!==void 0&&n.returnValue!==""||(this.leave(),E.info("[".concat(this._clientId,"] auto leave onbeforeunload or pagehide")))}),R(this,"_handleUpdateNetworkQuality",()=>{if(this._networkQualitySensitivity==="normal")return;if(navigator&&navigator.onLine!==void 0&&!navigator.onLine)return void this.safeEmit(Kt.NETWORK_QUALITY,{downlinkNetworkQuality:6,uplinkNetworkQuality:6});const n={downlinkNetworkQuality:0,uplinkNetworkQuality:0};n.uplinkNetworkQuality=this._p2pChannel.getUplinkNetworkQuality(),n.downlinkNetworkQuality=this._p2pChannel.getDownlinkNetworkQuality(),this.safeEmit(Kt.NETWORK_QUALITY,n)}),R(this,"_handleP2PAddAudioOrVideoStream",(n,i,r,o)=>{const s=this._users.find(c=>c.uid===i);if(!s)return void E.error("[".concat(this._clientId,"] can not find target user!(on_add_stream)"));E.debug("[".concat(this._clientId,"] stream added with uid ").concat(i,", type ").concat(n)),this.store.subscribe(s.uid,n,void 0,void 0,void 0,Date.now());const a=n==="audio"?s.hasAudio:s.hasVideo;n==="audio"?s._trust_audio_stream_added_state_=!0:s._trust_video_stream_added_state_=!0,n==="audio"?(s._audio_added_=!0,r!==void 0&&(s._audioSSRC=r),o!==void 0&&(s._audioMid=o)):(s._video_added_=!0,r!==void 0&&(s._videoSSRC=r),o!==void 0&&(s._videoMid=o)),(n==="audio"?s.hasAudio:s.hasVideo)&&!a&&(E.info("[".concat(this._clientId,"] remote user ").concat(s.uid," published ").concat(n)),this.safeEmit(Kt.USER_PUBLISHED,s,n)),this._p2pChannel.hasPendingRemoteMedia(s,n)&&(E.debug("[".concat(this._clientId,"] resubscribe ").concat(n," for user ").concat(s.uid," after reconnect.")),this._subscribe(s,n,!0).catch(c=>{E.error("[".concat(this._clientId,"] resubscribe error"),c.toString())}))}),this._config=t,this._clientId=be(5,"client-"),this.store=new WF(t.codec,t.audioCodec,t.mode,this._clientId),this.store.clientCreated(),t.proxyServer&&this.setProxyServer(t.proxyServer,!0),t.turnServer&&this.setTurnServer(t.turnServer,!0),E.info("[".concat(this._clientId,"] Initializing AgoraRTC client v").concat(pr," build: ").concat(tg,", mode: ").concat(this.mode,", codec: ").concat(this.codec)),t.clientRoleOptions)try{XI(t.clientRoleOptions),e=Object.assign({},t.clientRoleOptions)}catch(n){E.warning("[".concat(this._clientId,"] ").concat(n.toString()))}this._statsCollector=new Pl(this.store),this._statsCollector.onStatsException=(n,i,r)=>{E.debug("[".concat(this._clientId,"] receive exception msg, code: ").concat(n,", msg: ").concat(i,", uid: ").concat(r)),this.safeEmit(Kt.EXCEPTION,{code:n,msg:i,uid:r})},this._statsCollector.onUploadPublishDuration=(n,i,r,o)=>{const s=this._users.find(a=>a.uid===n);s&&Et.peerPublishStatus(this._sessionId,{subscribeElapse:o,audioPublishDuration:i,videoPublishDuration:r,peer:s._uintid})},this.store.useDataChannel=zt().supportDataChannel&&N("SIGNAL_CHANNEL"),this.store.useP2P=t.mode==="p2p",this._gateway=new $j(this.store,{clientId:this._clientId,mode:this.mode,codec:this.codec,websocketRetryConfig:t.websocketRetryConfig||dn,httpRetryConfig:t.httpRetryConfig||dn,forceWaitGatewayResponse:t.forceWaitGatewayResponse===void 0||t.forceWaitGatewayResponse,statsCollector:this._statsCollector,role:t.role,clientRoleOptions:e}),this._configDistribute=new dB,this.store.useP2P?(this._p2pChannel=new Ki(this.store,this._statsCollector),this._handleP2PEvents()):this._p2pChannel=new Kf(this.store,this._statsCollector),this._handleP2PChannelEvents(),this._handleGatewayEvents(),this._handleGatewaySignalEvents()}async joinMeta(t,e,n,i,r){let o=!(arguments.length>5&&arguments[5]!==void 0)||arguments[5],s=arguments.length>6&&arguments[6]!==void 0&&arguments[6];Re("JOIN_GATEWAY_USE_443PORT_ONLY",o),Re("JOIN_GATEWAY_USE_DUAL_DOMAIN",s);const a=this._gateway.signal.websocket;return a instanceof $u&&(a.use443PortOnly=o,a.tryDoubleDomain=s),async function(c,d,u){wp.get(c)||wp.set(c,[]),Op.get(c)||Op.set(c,d),Mo.get(c)||Mo.set(c,0);const l=wp.get(c),p=Op.get(c);if(!l||!p)throw new Error("concurrent: deferQueue or maxConcurrency is null");if(Mo.get(c)===p){const y=Ku();l.push(y),await y.promise}Mo.set(c,Mo.get(c)+1);for(var f=arguments.length,C=new Array(f>3?f-3:0),m=3;m<f;m++)C[m-3]=arguments[m];const g=await u(...C);return Mo.set(c,Mo.get(c)-1),Mo.get(c)===p-1&&l.length>0&&(l[0].resolve(),l.shift()),Mo.get(c)===0&&(wp.set(c,[]),Op.set(c,0),Mo.set(c,0)),g}("client.join",N("JOIN_MAX_CONCURRENCY"),this.join.bind(this),t,e,n,i,r)}async join(t,e,n,i,r){const o=++this._numberOfJoinCount;this.store.joinStart(),i&&(this.store.uid=i);const s=(Vp||Vp||(Vp=(window.location.protocol.split(":")[0]||"").toUpperCase(),Vp))==="HTTPS",a=sb()?window.isSecureContext:"Browser Not Support";if(!sb()&&!s||!window.isSecureContext){const m="The website must be running in a secure context (About secure context: https://developer.mozilla.org/en-US/docs/Web/Security/Secure_Contexts ), otherwise the media collection will be restricted by the browser";E.warning(m)}this.connectionState==="DISCONNECTED"&&(this.store.avoidJoinStart=Math.round(Date.now()),E.debug("[".concat(this._clientId,"] set avoidJoinStart to ").concat(this.store.avoidJoinStart))),Et.setAppId(t);try{if(!n&&n!==null)throw new U(b.INVALID_PARAMS,"Invalid token: ".concat(n,". If you don not use token, set it to null"));n&&Fn(n,"token",1,2047),Fn(t,"appid",1,2047),Gp(e),i&&Wp(i),r&&Fn(r,"optionalInfo",1,2047)}catch(m){throw Et.reportApiInvoke(Ju(),{name:_n.JOIN,options:[t,e,n,i],states:{isHttps:s,isSecureContext:a},tag:Je.TRACER}).onError(m),m}const c=await rD({appId:t,cname:e,uid:i,stringUid:typeof i=="string"?i:void 0,token:n||t,cloudProxyServer:this._cloudProxyServerMode}),d=(c==null?void 0:c.sid)||Ju(),u=Et.reportApiInvoke(d,{name:_n.JOIN,options:[t,e,n,i],states:{isHttps:s,isSecureContext:a},tag:Je.TRACER});if(E.info("[".concat(this._clientId,"] start join channel ").concat(e,", join number: ").concat(o)),this._leaveMutex.isLocked&&(E.debug("[".concat(this._clientId,"] join: waiting leave operation")),(await this._leaveMutex.lock())(),E.debug("[".concat(this._clientId,"] join: continue"))),this._joinAndNotLeaveYet=!0,this.connectionState!=="DISCONNECTED"){const m=new U(b.INVALID_OPERATION,"[".concat(this._clientId,"] Client already in connecting/connected state"));throw u.onError(m),m}this._sessionId||(this._sessionId=d,this.store.sessionId=this._sessionId),this._gateway.state="CONNECTING";const l=Rr(Rr({},this._rtmConfig),{},{clientId:this._clientId,appId:t,sid:this._sessionId,cname:e,uid:typeof i!="string"?i:null,turnServer:this._turnServer,proxyServer:this._proxyServer,token:n||t,cloudProxyServer:this._cloudProxyServerMode,optionalInfo:r,license:this._license,useLocalAccessPoint:this._useLocalAccessPoint,preload:!!c},this._remoteDefaultVideoStreamType!==void 0&&{defaultVideoStream:this._remoteDefaultVideoStreamType});if(this._useLocalAccessPoint&&(l.setLocalAPVersion=this._setLocalAPVersion),typeof i=="string"&&(l.stringUid=i,this._uintUid?(l.uid=this._uintUid,this._uintUid=void 0):l.uid=0),this._encryptionMode!=="none"&&this._encryptionSecret){if(l.aesmode=this._encryptionMode,l.aespassword=await(async m=>{const g=function(M){const V=window.atob(`MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQDCMnXAHkKIGAM+x4N22gCI+Wyu
STM9ztkT3uYslTT2PuKmZfPzhH6kVdO7PTjGCOZnAsyb3oTtWat0KcxQ4jxvqQV+
HvYl3iI1Yd4vl2c3qRMJPLtRDfNxa2Mcxgq7e9aEUibzdd0st+OJAy3tOj/Y0aVy
xQiYDz3vqa6bP29adwIDAQAB`),B=new Uint8Array(new ArrayBuffer(V.length));for(let K=0;K<V.length;K+=1)B[K]=V.charCodeAt(K);return B}(),y=await window.crypto.subtle.importKey("spki",g,{name:"RSA-OAEP",hash:"SHA-256"},!0,["encrypt"]),A=Km(m),k=await window.crypto.subtle.encrypt({name:"RSA-OAEP"},y,A);return function(M){let V="";for(let B=0;B<M.length;B+=1)V+=String.fromCharCode(M[B]);return window.btoa(V)}(new Uint8Array(k))})(this._encryptionSecret),!this._joinAndNotLeaveYet)throw new U(b.INVALID_OPERATION,"[".concat(this._clientId,"] Client already left"));this._encryptionSalt&&(l.aessalt=this._encryptionSalt)}if(this._encryptDataStream&&(this._encryptionMode==="aes-128-gcm2"||this._encryptionMode==="aes-256-gcm2"))if(this._encryptionSalt&&this._encryptionSecret)if(window.crypto.subtle){const m=new TextEncoder,g=N("USE_PURE_ENCRYPTION_MASTER_KEY")?m.encode(l.appId+this._encryptionSecret+this._encryptionSecret):m.encode(l.appId+l.cname+this._encryptionSecret);this._encryptDataStreamIv=await async function(y,A,k){const M=await window.crypto.subtle.importKey("raw",A,"PBKDF2",!1,["deriveBits","deriveKey"]),V=y==="aes-128-gcm2"?128:256,B=await window.crypto.subtle.deriveBits({name:"PBKDF2",iterations:cb,hash:"SHA-256",salt:k},M,V+HF);return new Uint8Array(B).subarray(V/8)}(this._encryptionMode,g,Va(this._encryptionSalt)),this._encryptDataStreamKey=await async function(y,A,k){const M=await window.crypto.subtle.importKey("raw",A,"PBKDF2",!1,["deriveBits","deriveKey"]),V=y==="aes-128-gcm2"?128:256;return await window.crypto.subtle.deriveKey({name:"PBKDF2",iterations:cb,hash:"SHA-256",salt:k},M,{name:"AES-GCM",length:V},!0,["encrypt","decrypt"])}(this._encryptionMode,g,Va(this._encryptionSalt))}else a?E.warning("[".concat(this._clientId,"] encrypt datastream must be running in a secure context, fallback to plain data stream")):E.warning("[".concat(this._clientId,"] current browser do not support WebCrypto ,fallback to plain data stream")),this._encryptDataStream=!1;else this._encryptDataStream=!1,E.debug("[".concat(this._clientId,"] no salt / secret, cannot support encrypt data stream, fallback to plain data stream"));this._startSession(this._sessionId,{channel:e,appId:t,stringUid:l.stringUid,preload:l.preload});const p=this._sessionId;setTimeout(()=>{this.connectionState==="CONNECTING"&&p===this._sessionId&&Et.joinChannelTimeout(this._sessionId,5)},5e3);try{var f;let m;const g=l.cloudProxyServer;if(it(f=["proxy3","proxy4","proxy5"]).call(f,g)){const V=N("PROXY_SERVER_TYPE3");Array.isArray(V)?l.proxyServer=V[0]:l.proxyServer=V}if(Et.setProxyServer(l.proxyServer),E.setProxyServer(l.proxyServer),this.store.requestAPStart(),c){if(E.debug("[".concat(this._clientId,"] get serverInfo Success from Preload Cache ").concat(l.stringUid?", ".concat(l.stringUid," => ").concat(c.intUid):""," ")),l.stringUid&&!l.uid&&(l.uid=c.intUid),m={gatewayInfo:c.ap.gatewayInfo},N("JOIN_WITH_FALLBACK_MEDIA_PROXY")&&l.turnServer.mode==="auto")if(c.ap.proxyInfo.addresses.length===0)E.warning("no edge services in ap response of proxy fallback, will not set proxy in iceServers");else{const V=(await kb(c.ap.proxyInfo,c.ap.gatewayInfo.uid)).map(B=>({turnServerURL:B.address,tcpport:B.tcpport||qn.tcpport,udpport:B.udpport||qn.udpport,username:B.username||qn.username,password:B.password||qn.password,forceturn:!1,security:!0}));l.turnServer={mode:"manual",servers:V}}aD(c,l.stringUid)}else{if(l.stringUid&&!l.uid){let V;[V,m]=await ot.all([Yb(l.stringUid,l,this._axiosCancelSource.token,this._config.httpRetryConfig||dn,this.store),qb(l,this._axiosCancelSource.token,this._config.httpRetryConfig||dn,!0,this.store)]),E.debug("[".concat(this._clientId,"] getUserAccount Success ").concat(l.stringUid," => ").concat(V)),l.uid=V,m.gatewayInfo.uid=V,m.gatewayInfo.res.uid=V}else m=await qb(l,this._axiosCancelSource.token,this._config.httpRetryConfig||dn,!0,this.store);if(!this._joinAndNotLeaveYet)throw new U(b.INVALID_OPERATION,"[".concat(this._clientId,"] Client already left"))}this.store.requestAPEnd(),setTimeout(()=>{this._configDistribute.startGetConfigDistribute(l,this._axiosCancelSource.token),this._configDistribute.on(ug.UPDATE_BITRATE_LIMIT,V=>{this._p2pChannel.updateBitrateLimit(V)})},0),this._key=n||t;const y=m.gatewayInfo,A=l.uid?l.uid:y.uid;this._joinInfo=Rr(Rr({},l),{},{cid:y.cid,uid:A,vid:y.vid,apResponse:y.res,uni_lbs_ip:y.uni_lbs_ip,gatewayAddrs:y.gatewayAddrs}),this.store.intUid=A;const k=await this._joinGateway();if(!this._joinAndNotLeaveYet)throw new U(b.INVALID_OPERATION,"[".concat(this._clientId,"] Client already left"));u.onSuccess(k),this._appId=t,this._channelName=l.cname,this._uid=k,this.store.uid=k,setTimeout(()=>{this._networkQualityInterval&&window.clearInterval(this._networkQualityInterval),this._networkQualityInterval=window.setInterval(this._handleUpdateNetworkQuality,2e3),window.addEventListener(An()?"beforeunload":"pagehide",this._handleBeforeUnload),this._statsCollector.startUpdateStats()},0);const M=l.stringUid?"string uid: ".concat(l.stringUid,",uid: ").concat(l.uid):"uid: ".concat(this._uid);return E.info("[".concat(this._clientId,"] Joining channel success: channel: ").concat(e,",").concat(M)),setTimeout(()=>{E.startUpload()},5e3),this.store.joinEnd(),C=this,it(Ys).call(Ys,C)||Ys.push(C),this._cloudProxyServerMode==="disabled"&&zt().supportWebCrypto&&N("ENABLE_PRELOAD")&&nS(this._joinInfo),k}catch(m){const g=Array.isArray(m)?m[0]:m;throw g&&g.code===b.OPERATION_ABORTED?E.warning("[".concat(this._clientId,"] join number: ").concat(o,", Joining channel failed, rollback"),g):E.error("[".concat(this._clientId,"] join number: ").concat(o,", Joining channel failed, rollback"),g),g.code!==b.OPERATION_ABORTED&&this._numberOfJoinCount===o&&(this._gateway.state="DISCONNECTED",this._reset()),u.onError(g),g}var C}_joinGateway(){if(!this._joinInfo||!this._key)throw new U(b.INVALID_OPERATION);return this._gateway.join(this._joinInfo,this._key,!(this._joinInfo.cloudProxyServer!=="disabled"||this._joinInfo.proxyServer||!N("JOIN_WITH_FALLBACK_SIGNAL_PROXY"))).then(t=>t).catch(t=>{if(t.code===b.INIT_WEBSOCKET_TIMEOUT)return this._gateway.leave(!0,Ht.FALLBACK),t;if(t.code===b.INIT_DATACHANNEL_TIMEOUT)return this._gateway.leave(!0,Ht.FALLBACK),t;throw t}).then(t=>{if(t instanceof U){if(t.code===b.INIT_WEBSOCKET_TIMEOUT){if(E.info("[".concat(this._clientId,"] join timeout, fallback to proxy")),!this._joinInfo||!this._key)throw new U(b.INVALID_OPERATION);this._joinInfo.cloudProxyServer="fallback",this._cloudProxyServerMode="fallback",this.store.cloudProxyServerMode="fallback";const e=N("PROXY_SERVER_TYPE3");if(Array.isArray(e))if(this._joinInfo.apUrl){const i=/^https?:\/\/(.+?)(\/.*)?$/.exec(this._joinInfo.apUrl)[1].split("."),r=i.slice(i.length-2).join(".");e.forEach(o=>{this._joinInfo&&it(o).call(o,r)&&(this._joinInfo.proxyServer=o)}),this._joinInfo.proxyServer||(this._joinInfo.proxyServer=e[0])}else this._joinInfo.proxyServer=e[0];else this._joinInfo.proxyServer=e;const n=N("LOG_UPLOAD_SERVER").match(/.+:(\d{1,5})$/);return n&&n[1]&&n[1]!=="443"&&E.setProxyServer(this._joinInfo.proxyServer),N("STATS_COLLECTOR_PORT").toString()!=="443"&&Et.setProxyServer(this._joinInfo.proxyServer),Et.reportApiInvoke(this._sessionId,{name:_n.JOIN_FALLBACK_TO_PROXY,options:[this._joinInfo.proxyServer],tag:Je.TRACER}).onSuccess(),this.safeEmit(Kt.JOIN_FALLBACK_TO_PROXY,this._joinInfo.proxyServer),N("JOIN_WITH_FALLBACK_MEDIA_PROXY_FORCE")&&this._joinInfo.turnServer.servers.forEach(i=>{"forceturn"in i&&(i.forceturn=!0)}),this._gateway.join(this._joinInfo,this._key)}if(E.info("[".concat(this._clientId,"] join by datachannel timeout, fallback to websocket")),!this._joinInfo||!this._key)throw new U(b.INVALID_OPERATION);return Et.reportApiInvoke(this._sessionId,{name:_n.DATACHANNEL_FAILBACK,options:[this.store.clientId],tag:Je.TRACER}).onSuccess(),this._joinGateway()}return t}).then(t=>t)}async leave(){E.info("[".concat(this._clientId,"] Leaving channel")),window.removeEventListener(An()?"beforeunload":"pagehide",this._handleBeforeUnload),this._reset(),function(e){const n=Ys.indexOf(e);n!==-1&&Ys.splice(n,1)}(this),this._statsCollector.stopUpdateStats();const t=await this._leaveMutex.lock();if(this.connectionState==="DISCONNECTED")return E.info("[".concat(this._clientId,"] Leaving channel repeated, success")),void t();await this._gateway.leave(this.connectionState!=="CONNECTED"),E.info("[".concat(this._clientId,"] Leaving channel success")),this._joinAndNotLeaveYet=!1,this.store.resetJoinChannelServiceRecords(),t()}async publish(t){let e=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1];if(!Array.isArray(t)){if(!(t instanceof bd))return this._publishDataChannel(t);t=[t]}if(t.length===0)throw new U(b.INVALID_PARAMS,"param list is empty");const n=t;if(this._gateway.role==="audience")throw new U(b.INVALID_OPERATION,"audience can not publish stream");for(const r of n){if(!(r instanceof bd))throw new U(b.INVALID_PARAMS,"parameter is not local track");if(!r._enabled&&e)throw new U(b.TRACK_IS_DISABLED,"can not publish a disabled track: ".concat(r.getTrackId()))}E.info("[".concat(this._clientId,"] Publishing tracks, id ").concat(n.map(r=>"".concat(r.getTrackId()," "))));const i=await this._publishMutex.lock();await this._configDistribute.awaitConfigDistributeComplete(),e&&n.forEach(r=>{const o=this._configDistribute.getBitrateLimit();r instanceof Ae&&o&&r.setBitrateLimit(o.uplink)});try{await this._publishHighStream(n),E.info("[".concat(this._clientId,"] Publish success, id ").concat(n.map(r=>"".concat(r.getTrackId()," "))))}catch(r){throw E.error("[".concat(this._clientId,"] publish error"),r.toString()),r}finally{i()}}async _publishDataChannel(t){Se(t.id,"id",0,65535,!0),hs(t.ordered,"ordered"),Fn(t.metadata,"metadata",0,512),E.info("[".concat(this._clientId,"] Publishing datachannels, id ").concat(t.id));const e=await this._publishMutex.lock();try{if(this._p2pChannel.getAllDataChannels().findIndex(i=>i.id===t.id)!==-1)throw new U(b.INVALID_PARAMS,"Invalid id: ".concat(t.id,". If you want to republish the datachannel, unpublish first"));if(!this._joinInfo||this._uid===void 0)throw new U(b.INVALID_OPERATION,"Can't publish datachannel, haven't joined yet!");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new U(b.INVALID_OPERATION,"can not publish datachannel in ".concat(this.connectionState," state"));if(this._turnServer.mode==="auto"&&N("FORCE_TURN")&&!N("TURN_ENABLE_TCP")&&!N("TURN_ENABLE_UDP"))throw new U(b.UNEXPECTED_ERROR,"force TURN With No TURN Configuration");const n=new S0(t);if(await this._p2pChannel.publishDataChannel([n]),!this._p2pChannel.isP2PDisconnected()){if(typeof n._originDataChannelId!="number")throw E.error("[".concat(this._clientId,"] can not publish with mediaType datachannel, cannot get RTCDatachannel id")),new U(b.CREATE_DATACHANNEL_ERROR);try{const i={streamId:t.id,ordered:t.ordered,maxRetransmits:N("DATASTREAM_MAX_RETRANSMITS"),metadata:t.metadata,channelId:n._originDataChannelId};await this._gateway.publishDataChannel(this._uid,i,!0),await n._waitTillOpen()}catch(i){if(i.code!==b.DISCONNECT_P2P)throw i}}return E.info("[".concat(this._clientId,"] Publish dataChannels success, id ").concat(n.id)),n}catch(n){throw E.error("[".concat(this._clientId,"] publish datachannels error"),n.toString()),n}finally{e()}}async unpublish(t){if(!this._joinInfo||this._uid===void 0)throw new U(b.INVALID_OPERATION,"Can't unpublish stream, haven't joined yet!");let e=[];if(t)if(Array.isArray(t))e=t;else{if(!(t instanceof bd))return this._unpublishDataChannel([t]);e=[t]}else this.store.useP2P||await this._unpublishDataChannel(),e=this._p2pChannel.getAllTracks(!0);E.info("[".concat(this._clientId,"] Unpublish tracks, tracks ").concat(e.map(i=>"".concat(i.getTrackId()," "))," "));const n=await this._publishMutex.lock();try{if(this._p2pChannel instanceof Ki){const i=await this._p2pChannel.unpublish(e);i&&await this._gateway.sendExtensionMessage(rn.UNPUBLISH,{unpubMsg:i},!0)}else{const i=await this._p2pChannel.unpublish(e);i&&await this._gateway.unpublish(i,this._uid),E.info("[".concat(this._clientId,"] Unpublish success,tracks ").concat(e.map(r=>"".concat(r.getTrackId()))))}}catch(i){throw E.error("[".concat(this._clientId,"] unpublish error"),i.toString()),i}finally{n&&n()}}async _unpublishDataChannel(t){t!==void 0&&t.length!==0||(t=this._p2pChannel.getAllDataChannels()),E.info("[".concat(this._clientId,"] Unpublish datachannels, datachannels ").concat(t.map(n=>"".concat(n.id," "))," "));const e=await this._publishMutex.lock();try{const n=await this._p2pChannel.unpublishDataChannel(t);n&&await this._gateway.unpublishDataChannel(n),E.info("[".concat(this._clientId,"] Unpublish dataChannel success,dataChannel ").concat(t.map(i=>"".concat(i.id))))}catch(n){throw E.error("[".concat(this._clientId,"] unpublish dataChannel error"),n.toString()),n}finally{e&&e()}}async subscribe(t,e,n){if(!(t instanceof aa)){const i=this.remoteUsers.find(r=>r.uid===t);if(!i)throw new U(b.INVALID_REMOTE_USER,"user is not in the channel");t=i}return e==="datachannel"?this._subscribeDataChannel(t,n):this._subscribe(t,e)}async presubscribe(t,e){if(yn(e,"mediaType",["audio","video"]),this._p2pChannel instanceof Ki)throw new U(b.INVALID_OPERATION,"can't presub at p2p mode");if(!this._joinInfo)throw new U(b.INVALID_OPERATION,"can't presub when not join");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new U(b.INVALID_OPERATION,"can't presub in ".concat(this.connectionState," state"));const n=e===_t.AUDIO,i=e===_t.VIDEO,r=await this._subscribeMutex.lock();try{const{ssrcId:o,ortc:s,rtxSsrcId:a,cname:c,uint_id:d}=await this._gateway.presubscribe(t,e,!0);if(o==null)throw new U(b.UNEXPECTED_RESPONSE,"no ssrc id");let u=this._users.find(p=>p.uid===t);u||(u=new aa(t,d||t),u._is_pre_created=!0,this._users.push(u)),c&&(u._cname=c),u._uintid||(u._uintid=d||t),n&&(u._audioSSRC=o,u._audio_pre_subscribed=!0,s&&(u._audioOrtc=s)),i&&(u._videoSSRC=o,u._video_pre_subscribed=!0,s&&(u._videoOrtc=s),a!=null&&(u._rtxSsrcId=a)),E.info("[".concat(this._clientId,"] presub succeed ssrc: ").concat(o)),await this._p2pChannel.subscribe(u,e,o,a,s);const l=n?u._audioTrack:u._videoTrack;if(!l)throw new U(b.UNEXPECTED_ERROR,"can not find remote track in user");return n&&(u._trust_audio_stream_added_state_=!0,u._audio_added_=!0),i&&(u._trust_video_stream_added_state_=!0,u._video_added_=!0),l}catch(o){throw E.error("[".concat(this._clientId,"] presub user ").concat(t," error"),o),o}finally{r()}}async _subscribeDataChannel(t,e){var n;if(Se(e,"channelId",0,65535,!0),!this._joinInfo)throw new U(b.INVALID_OPERATION,"Can't subscribe datachannel, not joined");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new U(b.INVALID_OPERATION,"Can't subscribe datachannel in ".concat(this.connectionState," state"));if(!this._users.find(a=>a===t))throw E.error("[".concat(this._clientId,"] can not subscribe ").concat(t.uid,", this user is not in the channel")),new U(b.INVALID_REMOTE_USER,"user is not in the channel");if(!t.hasAudio&&!t.hasVideo&&t._dataChannels.length===0)throw E.error("[".concat(this._clientId,"] can not subscribe ").concat(t.uid,", user is not published")),new U(b.INVALID_REMOTE_USER,"user is not published");const r=(n=t._dataChannels)===null||n===void 0?void 0:n.find(a=>a.id===e);if(!r)throw E.error("[".concat(this._clientId,"] can not subscribe ").concat(t.uid," with mediaType datachannel, remote datachannel is not published")),new U(b.REMOTE_USER_IS_NOT_PUBLISHED);const o=await this._subscribeMutex.lock();E.info("[".concat(this._clientId,"] subscribe user ").concat(t.uid,", mediaType: datachannel"));try{const a=await this._p2pChannel.subscribeDataChannel(t,[r]);if(a&&it(a).call(a,r.id))try{var s;if(typeof r._originDataChannelId!="number")throw E.error("[".concat(this._clientId,"] can not subscribe ").concat(t.uid," with mediaType datachannel, cannot get RTCDatachannel")),new U(b.CREATE_DATACHANNEL_ERROR);const c={id:r.id,datachannelId:r._originDataChannelId,ordered:r.ordered,maxRetransmits:r.maxRetransmits,metadata:(s=r.metadata)!==null&&s!==void 0?s:""};await this._gateway.subscribeDataChannel(t.uid,c,!0),await r._waitTillOpen()}catch(c){if((c==null?void 0:c.code)!==b.WS_ABORT)throw await this._p2pChannel.unsubscribeDataChannel(t,[r]),c;await this._p2pChannel.unsubscribeDataChannel(t,[r]),this._p2pChannel.setPendingRemoteDataChannel(t,r.id)}return E.info("[".concat(this._clientId,"] subscribe success user ").concat(t.uid,", mediaType: datachannel")),r}finally{o()}}async _p2pSubscribe(t,e,n){if(yn(e,"mediaType",["audio","video"]),!this._joinInfo)throw new U(b.INVALID_OPERATION,"Can't subscribe stream, not joined");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new U(b.INVALID_OPERATION,"Can't subscribe stream in ".concat(this.connectionState," state"));if(!this._users.find(o=>o===t)){const o=new U(b.INVALID_REMOTE_USER,"user is not in the channel");throw E.error("[".concat(this._clientId,"] can not subscribe ").concat(t.uid,", this user is not in the channel")),o}if(!t.hasAudio&&!t.hasVideo){const o=new U(b.INVALID_REMOTE_USER,"user is not published");throw E.error("[".concat(this._clientId,"] can not subscribe ").concat(t.uid,", user is not published")),o}if(!n&&(e==="audio"&&!t.hasAudio||e==="video"&&!t.hasVideo)){const o=new U(b.REMOTE_USER_IS_NOT_PUBLISHED);throw E.error("[".concat(this._clientId,"] can not subscribe ").concat(t.uid," with mediaType ").concat(e,", remote track is not published")),o}const r=await this._subscribeMutex.lock();E.info("[".concat(this._clientId,"] subscribe user ").concat(t.uid,", mediaType: ").concat(e));try{if(await this._p2pChannel.hasRemoteMediaWithLock(t,e))await this._p2pChannel.unmuteRemote(t,e);else try{const s=e==="audio"?t._audioSSRC:t._videoSSRC,a=e==="audio"?t._audioMid:t._videoMid;this.store.subscribe(t.uid,e,Date.now()),this._p2pChannel instanceof Ki&&await this._p2pChannel.subscribe(t,e,s,a)}catch(s){throw s}E.info("[".concat(this._clientId,"] subscribe success user ").concat(t.uid,", mediaType: ").concat(e)),this._defaultStreamFallbackType&&this.setStreamFallbackOption(t.uid,this._defaultStreamFallbackType).catch(s=>{E.warning("[".concat(this._clientId,"] auto set fallback failed"),s)});const o=e==="audio"?t._audioTrack:t._videoTrack;if(!o)throw new U(b.UNEXPECTED_ERROR,"can not find remote track in user object");return o}catch(o){throw E.error("[".concat(this._clientId,"] subscribe user ").concat(t.uid," error"),o),o}finally{r()}}async _subscribe(t,e,n){if(this._p2pChannel instanceof Ki)return this._p2pSubscribe(t,e);if(yn(e,"mediaType",["audio","video"]),!this._joinInfo)throw new U(b.INVALID_OPERATION,"Can't subscribe stream, not joined");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new U(b.INVALID_OPERATION,"Can't subscribe stream in ".concat(this.connectionState," state"));if(!this._users.find(d=>d===t)){const d=new U(b.INVALID_REMOTE_USER,"user is not in the channel");throw E.error("[".concat(this._clientId,"] can not subscribe ").concat(t.uid,", this user is not in the channel")),d}if(!t.hasAudio&&!t.hasVideo){const d=new U(b.INVALID_REMOTE_USER,"user is not published");throw E.error("[".concat(this._clientId,"] can not subscribe ").concat(t.uid,", user is not published")),d}if(!(n||(e!=="audio"||t.hasAudio&&t._audioSSRC!==void 0)&&(e!=="video"||t.hasVideo&&t._videoSSRC!==void 0))){const d=new U(b.REMOTE_USER_IS_NOT_PUBLISHED);throw E.error("[".concat(this._clientId,"] can not subscribe ").concat(t.uid," with mediaType ").concat(e,", remote track is not published")),d}let r=e==="audio"?t._audioSSRC:t._videoSSRC,o=e==="audio"?t._audioOrtc:t._videoOrtc,s=e==="video"?t._rtxSsrcId:void 0,a={stream_type:e==="audio"?_t.AUDIO:_t.VIDEO,ssrcId:r};const c=await this._subscribeMutex.lock();E.info("[".concat(this._clientId,"] subscribe user ").concat(t.uid,", mediaType: ").concat(e));try{if(await this._p2pChannel.hasRemoteMediaWithLock(t,e))await this._p2pChannel.unmuteRemote(t,e);else try{const u=e==="audio"?t._audioSSRC:t._videoSSRC;u!==void 0&&u!==r&&(r=u,o=e==="audio"?t._audioOrtc:t._videoOrtc,s=e==="video"?t._rtxSsrcId:void 0,a={stream_type:e==="audio"?_t.AUDIO:_t.VIDEO,ssrcId:r}),$n.markSubscribeStart(this.store.clientId,r),this.store.subscribe(t.uid,e,Date.now()),await this._p2pChannel.subscribe(t,e,r,s,o);try{await this._gateway.subscribe(t.uid,a,!0)}catch(l){if((l==null?void 0:l.code)!==b.WS_ABORT)throw await this._p2pChannel.unsubscribe(t,e),l;await this._p2pChannel.unsubscribe(t,e,!0),this._p2pChannel.setPendingRemoteMedia(t,e)}this.store.subscribe(t.uid,e,void 0,Date.now()),this._p2pChannel.reportSubscribeEvent(!0,null,t,e)}catch(u){throw this._p2pChannel.reportSubscribeEvent(!1,u==null?void 0:u.code,t,e),u}E.info("[".concat(this._clientId,"] subscribe success user ").concat(t.uid,", mediaType: ").concat(e)),this._defaultStreamFallbackType&&this.setStreamFallbackOption(t.uid,this._defaultStreamFallbackType).catch(u=>{E.warning("[".concat(this._clientId,"] auto set fallback failed"),u)});const d=e==="audio"?t._audioTrack:t._videoTrack;if(!d)throw new U(b.UNEXPECTED_ERROR,"can not find remote track in user object");return d}catch(d){throw E.error("[".concat(this._clientId,"] subscribe user ").concat(t.uid," error"),d),d}finally{c()}}async massSubscribe(t){if(ps(t,"subscribeList"),!this._joinInfo)throw new U(b.INVALID_OPERATION,"Can't subscribe stream, not joined");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new U(b.INVALID_OPERATION,"Can't subscribe stream in ".concat(this.connectionState," state"));const e=Date.now(),n=new Map,i=await this._subscribeMutex.lock();E.info("[".concat(this._clientId,"]start massSubscribe user ").concat(t.map(a=>{let{user:c,mediaType:d}=a;return"user: ".concat(c==null?void 0:c.uid,", mediaType: ").concat(d)}).join("; ")));const r=(t=[...t]).map(a=>{let{user:c,mediaType:d}=a;return{user:c,mediaType:d}}),o=await this._p2pChannel.globalLock();try{var s;for(let c=t.length-1;c>=0;c--){const d=t[c],{user:u,mediaType:l}=d;if(yn(l,"mediaType",["audio","video"]),!u){const m=new U(b.INVALID_PARAMS,"user property does not exist in subscribeList item");throw E.error("[".concat(this._clientId,"] user property does not exist in subscribeList item")),m}if(!this._users.find(m=>m===u)){const m=new U(b.INVALID_REMOTE_USER,"user is not in the channel");E.error("[".concat(this._clientId,"] can not massSubscribe ").concat(u.uid,", this user is not in the channel")),r[c].error=m,t.splice(c,1);continue}if(l==="audio"&&(!u.hasAudio||u._audioSSRC===void 0)||l==="video"&&(!u.hasVideo||u._videoSSRC===void 0)){const m=new U(b.REMOTE_USER_IS_NOT_PUBLISHED);E.error("[".concat(this._clientId,"] can not subscribe ").concat(u.uid," with mediaType ").concat(l,", remote user is not published")),r[c].error=m,t.splice(c,1);continue}const f=On.Video|On.LwoVideo,C=n.get(u);if(C){if(l==="video"?C&f:C&On.Audio){t.splice(c,1),E.warning("[".concat(this._clientId,"] repeat massSubscribe user:").concat(u.uid,", mediaType:").concat(l," twice"));continue}n.set(u,C|(l==="video"?f:On.Audio))}else n.set(u,l==="video"?f:On.Audio)}for(let c=t.length-1;c>=0;c--){const d=t[c],{user:u,mediaType:l}=d,p=On.Video|On.LwoVideo;if(this._p2pChannel.hasRemoteMedia(u,l)){await this._p2pChannel.unmuteRemoteNoLock(u,l);const f=n.get(u);n.set(u,l==="video"?f^p:f^On.Audio),t.splice(c,1)}}this.store.massSubscribe(t.map(c=>({userId:c.user.uid,type:c.mediaType})),e);const a=io(s=Array.from(n.entries())).call(s,(c,d)=>{let[u,l]=d;if(l===0)return c;const p={stream_id:u.uid,stream_type:l};return l&On.Audio&&(p.audio_ssrc=u._audioSSRC),l&On.Video&&(p.video_ssrc=u._videoSSRC),c.push(p),c},[]);try{t.length>0&&await this._p2pChannel.massSubscribeNoLock(t.map(d=>{let{user:u,mediaType:l}=d;return{user:u,mediaType:l,ssrcId:l===_t.VIDEO?u._videoSSRC:u._audioSSRC,rtxSsrcId:l===_t.VIDEO?u._rtxSsrcId:void 0}}));const c=new Map;if(a.length>0){const d=await this._gateway.subscribeAll(a,!0);((d==null?void 0:d.users)||[]).forEach(u=>{let{stream_id:l,video_error_code:p,audio_error_code:f,error_code:C}=u;(p||f||C)&&c.set(l,{video_error_code:p,audio_error_code:f,error_code:C})})}if(Array.from(c.entries()).length>0){const d=[];Array.from(c.entries()).forEach(u=>{let[l,p]=u;const f=this.remoteUsers.find(C=>C.uid===l);if(f){let C;p.error_code||p.video_error_code&&p.audio_error_code?C=void 0:p.video_error_code?C=_t.VIDEO:p.audio_error_code&&(C=_t.AUDIO),d.push({user:f,mediaType:C})}}),d.length>0&&await this._p2pChannel.massUnsubscribeNoLock(d)}for(const d of r){const u=c.get(d.user.uid);if(u){const l=u.error_code||d.mediaType==="audio"&&u.audio_error_code||d.mediaType==="video"&&u.video_error_code;if(l){const p=Ga(l);E.error("user:".concat(d.user.uid," mediaType:").concat(d.mediaType," has massSubscribe error ").concat(p.desc)),d.error=new U(b.SUBSCRIBE_FAILED,"code ".concat(l,": ").concat(p.desc))}}d.error||(d.mediaType==="video"?d.track=d.user.videoTrack:d.track=d.user.audioTrack)}return this.store.massSubscribe(r.filter(d=>!d.error).map(d=>({userId:d.user.uid,type:d.mediaType})),void 0,Date.now()),r.forEach(d=>{var u;Et.subscribe(this.store.sessionId,{succ:!!d.error,ec:((u=d.error)===null||u===void 0?void 0:u.code)||null,video:d.mediaType===_t.VIDEO,audio:d.mediaType===_t.AUDIO,peerid:d.user.uid,subscribeRequestid:d.mediaType===_t.VIDEO?d.user._videoSSRC:d.user._audioSSRC,p2pid:this.store.p2pId,eventElapse:Math.floor(performance.now()-e)},!0)}),E.info("[".concat(this._clientId,"] massSubscribe success ").concat(t.map(d=>{let{user:u,mediaType:l}=d;return"user: ".concat(u==null?void 0:u.uid,", mediaType: ").concat(l)}).join("; "))),r}catch(c){throw await this._p2pChannel.massUnsubscribeNoLock(t),c}}finally{o(),i()}}async unsubscribe(t,e,n){if(!(t instanceof aa)){const o=this.remoteUsers.find(s=>s.uid===t);if(!o)throw new U(b.INVALID_REMOTE_USER,"user is not in the channel");t=o}if(e||this.store.useP2P){if(e==="datachannel")return this._unsubscribeDataChannel(t,n)}else await this._unsubscribeDataChannel(t,n);if(e&&yn(e,"mediaType",["audio","video"]),!this._joinInfo)throw new U(b.INVALID_OPERATION,"Can't unsubscribe stream, haven't joined yet!");if(!this._users.find(o=>o===t)){const o=new U(b.INVALID_REMOTE_USER,"user is not in the channel");throw E.error("[".concat(this._clientId,"] can not unsubscribe ").concat(t.uid,", user is not in the channel")),o}E.info("[".concat(this._clientId,"] unsubscribe uid: ").concat(t.uid,", mediaType: ").concat(e));const r=await this._subscribeMutex.lock();try{if(this._p2pChannel instanceof Ki)await this._p2pChannel.unsubscribe(t,e);else{const o=await this._p2pChannel.unsubscribe(t,e);o&&await this._gateway.unsubscribe(o,t.uid),e&&e!=="audio"||(t._audio_pre_subscribed=!1),e&&e!=="video"||(t._video_pre_subscribed=!1),t._is_pre_created&&Lp(this._users,t),E.info("[".concat(this._clientId,"] unsubscribe success uid: ").concat(t.uid,", mediaType: ").concat(e))}}catch(o){if(o.code===b.DISCONNECT_P2P)return void E.warning("disconnecting p2p, abort unsubscribe request.");throw E.error("[".concat(this._clientId,"] unsubscribe user ").concat(t.uid," error"),o.toString()),o}finally{r()}}async _unsubscribeDataChannel(t,e){if(e&&Se(e,"id",0,65535,!0),!this._joinInfo)throw new U(b.INVALID_OPERATION,"Can't unsubscribe datachannel, haven't joined yet!");if(!this._users.find(r=>r===t)){const r=new U(b.INVALID_REMOTE_USER,"user is not in the channel");throw E.error("[".concat(this._clientId,"] can not unsubscribe ").concat(t.uid,", user is not in the channel")),r}let i;if(typeof e=="number"){const r=t._dataChannels.find(o=>o.id===e);r&&(i=[r])}else i=t._dataChannels;if(i===void 0){const r=new U(b.REMOTE_USER_IS_NOT_PUBLISHED);throw E.error("[".concat(this._clientId,"] can not unsubscribe ").concat(t.uid," with channelId ").concat(e,", remote datachannel is not published")),r}E.info("[".concat(this._clientId,"] unsubscribe uid: ").concat(t.uid,", mediaType: datachannel, ids: ").concat(i.map(r=>r.id)));try{const r=await this._p2pChannel.unsubscribeDataChannel(t,i);r&&await this._gateway.unsubscribeDataChannel(r,t.uid),E.info("[".concat(this._clientId,"] unsubscribe datachannel success uid: ").concat(t.uid,", mediaType: datachannel, ids: ").concat(r))}catch(r){if(r.code===b.DISCONNECT_P2P)return void E.warning("disconnecting p2p, abort unsubscribe request.");throw E.error("[".concat(this._clientId,"] unsubscribe user ").concat(t.uid," error"),r.toString()),r}}async massUnsubscribe(t){if(ps(t,"unsubscribeList"),!this._joinInfo)throw new U(b.INVALID_OPERATION,"Can't unsubscribeAll stream, haven't joined yet!");E.info("[".concat(this._clientId,"] start massUnsubscribe ").concat(t.map(n=>{let{user:i,mediaType:r}=n;return"user: ".concat(i==null?void 0:i.uid,", mediaType: ").concat(r,";")}).join())),t=[...t];const e=new Map;for(let n=t.length-1;n>=0;n--){const{user:i,mediaType:r}=t[n];if(!i){const a=new U(b.INVALID_PARAMS,"user property does not exist in unsubscribeList item");throw E.error("[".concat(this._clientId,"] user property does not exist in unsubscribeList item")),a}if(yn(r,"mediaType",["video","audio",void 0]),!this._users.find(a=>a===i)){E.warning("[".concat(this._clientId,"] can not unsubscribe ").concat(i.uid,", user is not in the channel")),t.splice(n,1);continue}const s=On.Video|On.LwoVideo;if(e.has(i)){const a=e.get(i);let c;switch(r){case"video":c=a&s;break;case"audio":c=a&On.Audio;break;default:c=a&(On.Audio|s)}if(c){E.warning("[".concat(this._clientId,"] repeat massUnsubscribe user:").concat(i.uid,",mediaType:").concat(r," twice.")),t.splice(n,1);continue}r?r==="audio"?e.set(i,a|On.Audio):r==="video"&&e.set(i,a|s):e.set(i,a|On.Audio|s)}else r?r==="audio"?e.set(i,On.Audio):r==="video"&&e.set(i,s):e.set(i,On.Audio|s)}try{const n=await this._p2pChannel.massUnsubscribe(t);n&&await this._gateway.massUnsubscribe(n),E.info("[".concat(this._clientId,"] massUnsubscribe success ").concat(t.map(i=>{let{user:r,mediaType:o}=i;return"user: ".concat(r==null?void 0:r.uid,", mediaType: ").concat(o,";")}).join()))}catch(n){if(n.code===b.DISCONNECT_P2P)return void E.warning("[".concat(this._clientId,"] disconnecting p2p, abort unsubscribe request."));throw E.error("[".concat(this._clientId,"] massUnsubscribe error"),n.toString()),n}}async setLowStreamParameter(t){(function(n){if(!n)throw new G(b.INVALID_PARAMS);ze(n.width)||Wm(n.width,"streamParameter.width"),ze(n.height)||Wm(n.height,"streamParameter.height"),ze(n.framerate)||Wm(n.framerate,"streamParameter.framerate"),ze(n.bitrate)||Se(n.bitrate,"streamParameter.bitrate")})(t),(!t.width&&t.height||t.width&&!t.height)&&E.warning("[".concat(this._clientId,"] The width and height parameters take effect only when both are set")),E.info("[".concat(this._clientId,"] set low stream parameter to"),JSON.stringify(t));const e=this._configDistribute.getLowStreamConfigDistribute();if(e&&e.bitrate&&t.bitrate&&e.bitrate<t.bitrate&&(t.bitrate=e.bitrate),this._lowStreamParameter=t,this._isDualStreamEnabled)return this._p2pChannel.updateVideoStreamParameter(t,X.LocalVideoLowTrack)}async enableDualStream(){if(!zt().supportDualStream)throw Et.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!0,succ:!1}),new U(b.NOT_SUPPORTED,"Your browser is not support dual stream");if(this._isDualStreamEnabled)throw new U(b.INVALID_OPERATION,"Dual stream is already enabled");if(this._p2pChannel.canPublishLowStream())try{await this._publishLowStream()}catch(t){throw Et.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!0,succ:!1}),t}this._isDualStreamEnabled=!0,Et.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!0,succ:!0}),E.info("[".concat(this._clientId,"] enable dual stream"))}async disableDualStream(){if(this._isDualStreamEnabled){if(!this._joinInfo)throw new U(b.INVALID_OPERATION,"Can't publish stream, haven't joined yet!");if(this._p2pChannel.getLocalMedia(X.LocalVideoLowTrack))try{const t=await this._p2pChannel.unpublishLowStream();t&&await this._gateway.unpublish(t,this._joinInfo.stringUid||this._joinInfo.uid)}catch(t){throw Et.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!1,succ:!1}),t}this._isDualStreamEnabled=!1,Et.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!1,succ:!0}),E.info("[".concat(this._clientId,"] disable dual stream"))}}async setClientRole(t,e){if(function(n){yn(n,"role",["audience","host"])}(t),e&&XI(e),this.mode==="rtc"||this.mode==="p2p")throw E.warning("[".concat(this._clientId,"]").concat(this.mode," mode can not use setClientRole")),new U(b.INVALID_OPERATION,"".concat(this.mode," mode can not use setClientRole"));if(e&&e.level&&t==="host")throw new U(b.INVALID_OPERATION,"host mode can not set audience latency level");if(t==="audience"&&this._p2pChannel.hasLocalMedia())throw new U(b.INVALID_OPERATION,"can not set client role to audience when publishing stream");await this._gateway.setClientRole(t,e),this._config.role=t,E.info("[".concat(this._clientId,"] set client role to ").concat(t,", level: ").concat(e&&e.level))}getRemoteInboundOffset(){var t;const e=(t=this._p2pChannel.getStats())===null||t===void 0?void 0:t.audioSend[0];if(!e||!e.timestamp)return 0;const n=e.timestamp-Date.now();return Math.abs(n)>1e3+e.rttMs+100?this.ntpAlignErrorCount+=1:this.ntpAlignErrorCount=0,this.ntpAlignErrorCount>=3?n:0}getNtpWallTimeInMs(){return document.visibilityState==="visible"&&(this.remoteInboundOffset=this.getRemoteInboundOffset()),this.remoteInboundOffset+Date.now()+this._gateway.ntpOffset}setProxyServer(t,e){if(Fn(t,"proxyServer"),!e){if(this.connectionState!=="DISCONNECTED")throw new U(b.INVALID_OPERATION,"Set proxy server before join channel");if(this._cloudProxyServerMode!=="disabled"||this._useLocalAccessPoint)throw new U(b.INVALID_OPERATION,"You have already set the proxy")}this._proxyServer=t,Et.setProxyServer(this._proxyServer),E.setProxyServer(this._proxyServer),E.info("[".concat(this._clientId,"] Set proxy server ").concat(e?"by initialize call":""," success."))}setTurnServer(t,e){if(Array.isArray(t)||(t=[t]),!e){if(this.connectionState!=="DISCONNECTED")throw new U(b.INVALID_OPERATION,"Set turn server before join channel");if(this._cloudProxyServerMode!=="disabled"||this._useLocalAccessPoint)throw new U(b.INVALID_OPERATION,"You have already set the proxy")}if(Zc(t))return this._turnServer={servers:t,mode:"original-manual"},void E.info("[".concat(this._clientId,"] Set original turnserver ").concat(e?"by initialize call":""," success: ").concat(t.map(n=>n.urls).join(","),"."));t.forEach(n=>JI(n)),this._turnServer={servers:t,mode:"manual"},E.info("[".concat(this._clientId,"] Set turnserver ").concat(e?"by initialize call":""," success."))}setLicense(t){if(this.connectionState!=="DISCONNECTED")throw new U(b.INVALID_OPERATION,"you should set license before join channel");if(Fn(t,"license",32,32),!/^[A-Za-z\d]+$/.test(t))throw new U(b.INVALID_PARAMS,"license should only contains characters from A-Z a-z 0-9");this._license=t,E.info("[".concat(this._clientId,"] set license success"),t)}startProxyServer(t){if(this.connectionState!=="DISCONNECTED")throw new U(b.INVALID_OPERATION,"Start proxy server before join channel");if(this._proxyServer||this._turnServer.mode==="manual"||this._useLocalAccessPoint)throw new U(b.INVALID_OPERATION,"You have already set the proxy");const e=[3,4,5];let n;switch(t===void 0&&(t=3),t){case 1:case 2:throw new U(b.NOT_SUPPORTED,"proxy mode 1/2 has been deprecated and not supported.");case 3:n="proxy3";break;case 4:n="proxy4";break;case 5:n="proxy5";break;default:throw new U(b.INVALID_PARAMS,"proxy server mode must be ".concat(e.join("|")))}this._cloudProxyServerMode=n,this.store.cloudProxyServerMode=n,E.info("[".concat(this._clientId,"] set cloud proxy server mode to"),this._cloudProxyServerMode)}stopProxyServer(){if(this.connectionState!=="DISCONNECTED")throw new U(b.INVALID_OPERATION,"Stop proxy server after leave channel");Et.setProxyServer(),E.setProxyServer(),this._cloudProxyServerMode="disabled",this.store.cloudProxyServerMode="disabled",E.info("[".concat(this._clientId,"] set cloud proxy server mode to"),this._cloudProxyServerMode),this._proxyServer=void 0,this._turnServer={mode:"auto",servers:[]}}setLocalAccessPointsV2(t){if(!t.accessPoints)throw new U(b.INVALID_PARAMS,"accessPoints is required.");ps(t.accessPoints.serverList,"accessPoints.serverList"),Fn(t.accessPoints.domain,"accessPoints.domain");const e=(p,f)=>{Se(p,f,0,65535,!0)};let n=443;if(t.accessPoints.port&&(e(t.accessPoints.port,"accessPoints.port"),n=t.accessPoints.port),this._proxyServer||this._cloudProxyServerMode!=="disabled")throw new U(b.INVALID_OPERATION,"set local access point failed, You have already set the cloud proxy");N("CLOSE_AFB_FOR_LOCAL_AP")&&(Re("JOIN_WITH_FALLBACK_SIGNAL_PROXY",!1),Re("JOIN_WITH_FALLBACK_MEDIA_PROXY",!1));const i=/^((\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.){3}(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])$/,r=t.accessPoints.domain,o=t.accessPoints.serverList.map(p=>i.test(p)?"".concat(p.replace(/\./g,"-"),".").concat(r):p),s=o.map(p=>"".concat(p,":").concat(n));this._useLocalAccessPoint=!0,this._setLocalAPVersion=2,Re("WEBCS_DOMAIN",s),Re("WEBCS_DOMAIN_BACKUP_LIST",s),Re("GATEWAY_DOMAINS",[r]),t.report&&t.report.hostname&&Array.isArray(t.report.hostname)&&t.report.hostname.length?(ps(t.report.hostname,"report.hostname"),Re("EVENT_REPORT_DOMAIN",t.report.hostname[0]),Re("EVENT_REPORT_BACKUP_DOMAIN",t.report.hostname[1]||t.report.hostname[0])):(Re("EVENT_REPORT_DOMAIN",o[0]),Re("EVENT_REPORT_BACKUP_DOMAIN",o[1]||o[0]));let a=6443;t.report&&t.report.port&&(e(t.report.port,"report.port"),a=t.report.port),Re("STATS_COLLECTOR_PORT",a),t.report?Re("ENABLE_EVENT_REPORT",!0):Re("ENABLE_EVENT_REPORT",!1);let c="";t.log&&t.log.hostname&&Array.isArray(t.log.hostname)&&t.log.hostname.length?(ps(t.log.hostname,"log.hostname"),c=t.log.hostname[0]):c=o[0];let d=6444;t.log&&t.log.port&&(e(t.log.port,"log.port"),d=t.log.port),Re("LOG_UPLOAD_SERVER","".concat(c,":").concat(d));let u=[];t.cds&&t.cds.hostname&&Array.isArray(t.cds.hostname)&&t.cds.hostname.length?(ps(t.cds.hostname,"cds.hostname"),u=t.cds.hostname):u=o;let l=443;t.cds&&t.cds.port&&(e(t.cds.port,"cds.port"),l=t.cds.port),Re("CDS_AP",u.map(p=>"".concat(p,":").concat(l))),t.cds?Re("ENABLE_CONFIG_DISTRIBUTE",!0):Re("ENABLE_CONFIG_DISTRIBUTE",!1),E.info("set local access point v2 success")}setLocalAccessPoints(t,e){if(ps(t,"serverList"),Fn(e,"domain"),this._proxyServer||this._cloudProxyServerMode!=="disabled")throw new U(b.INVALID_OPERATION,"set local access point failed, You have already set the cloud proxy");const n=/^(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])$/;t=t.map(i=>n.test(i)?"".concat(i.replace(/\./g,"-"),".").concat(e):i),this._useLocalAccessPoint=!0,this._setLocalAPVersion=1,Re("WEBCS_DOMAIN",t),Re("WEBCS_DOMAIN_BACKUP_LIST",t),Re("GATEWAY_DOMAINS",[e]),Re("EVENT_REPORT_DOMAIN",t[0]),Re("EVENT_REPORT_BACKUP_DOMAIN",t[1]||t[0]),Re("LOG_UPLOAD_SERVER","".concat(t[0],":6444")),E.info("[".concat(this._clientId,"] set local access point success"))}async setRemoteDefaultVideoStreamType(t){if(yn(t,"streamType",[0,1]),this._remoteDefaultVideoStreamType=t,this._joinInfo)try{await this._gateway.setDefaultRemoteVideoStreamType(t),this._joinInfo.defaultVideoStream=this._remoteDefaultVideoStreamType}catch(e){throw E.error("[".concat(this._clientId,"] set default remote video stream type error"),e.toString()),e}else E.debug("[".concat(this._clientId,"] haven't joined yet, cache remoteDefaultVideoStreamType ").concat(t))}async setRemoteVideoStreamType(t,e){yn(e,"streamType",[0,1]);try{await this._gateway.setRemoteVideoStreamType(t,e),setTimeout(()=>{const n=this._users.find(i=>i.uid===t);n&&n.videoTrack&&n.videoTrack.updateMediaStreamTrackResolution()},2e3)}catch(n){throw E.error("[".concat(this._clientId,"] set remote video stream type error"),n.toString()),n}E.info("[".concat(this._clientId,"] set remote ").concat(t," video stream type to ").concat(e)),this._remoteStreamTypeCacheMap.set(t,e)}async setStreamFallbackOption(t,e){yn(e,"fallbackType",[0,1,2]);try{await this._gateway.setStreamFallbackOption(t,e)}catch(n){throw E.error("[".concat(this._clientId,"] set stream fallback option"),n.toString()),n}E.info("[".concat(this._clientId,"] set remote ").concat(t," stream fallback type to ").concat(e)),this._streamFallbackTypeCacheMap.set(t,e)}setEncryptionConfig(t,e,n,i){(function(o){yn(o,"encryptionMode",["aes-128-xts","aes-256-xts","aes-128-ecb","sm4-128-ecb","aes-128-gcm","aes-256-gcm","aes-128-gcm2","aes-256-gcm2","none"])})(t),Fn(e,"secret");const r=["aes-128-gcm2","aes-256-gcm2"];if(it(r).call(r,t)){if(!n||!(n instanceof Uint8Array&&n.length===32))throw new U(b.INVALID_PARAMS,"salt must be an Uint8Array and exactly equal to 32 bytes")}else if(n)throw new U(b.INVALID_PARAMS,"current encrypt mode does not need salt");if(i){if(hs(i,"encryptDataStream"),!it(r).call(r,t))throw new U(b.INVALID_PARAMS,"current encrypt mode does not support data stream");this._encryptDataStream=!0}new RegExp(`^(?=.*[a-z])(?=.*[A-Z])(?=.*[0-9])(?=.*[!@#$%^&*,.<>?/:;'"|{}\\[\\]])(?=.{8,})`).test(e)||E.warning(`The secret is not strong:
      The secret must contain at least 1 lowercase alphabetical character,
      The secret must contain at least 1 uppercase alphabetical character,
      The secret must contain at least 1 numeric character,
      The secret must contain at least one special character,
      The secret must be eight characters or longer.
      `),this._encryptionMode=t,this._encryptionSecret=e,n&&(this._encryptionSalt=Ks(n))}async renewToken(t){if(Fn(t,"token",1,2047),!this._key||!this._joinInfo)throw new U(b.INVALID_OPERATION,"renewToken should not be called before user join");const e=this._key;this._key=t,this._joinInfo&&(this._joinInfo.token=t);const n=await this._renewTokenMutex.lock();try{if(N("USE_NEW_TOKEN")){E.debug("[".concat(this._clientId,"] start renew token with ticket from unilbs"));const i=await cB(this._joinInfo,this._axiosCancelSource.token,this._config.httpRetryConfig||dn);E.debug("[".concat(this._clientId,"] get ticket from unilbs success")),await this._gateway.renewToken({token:t,ticket:i})}else E.debug("[".concat(this._clientId,"] start renew token without ticket")),await this._gateway.renewToken({token:t});E.debug("[".concat(this._clientId,"] renewToken success"))}catch(i){throw this._key=e,this._joinInfo.token=e,E.error("[".concat(this._clientId,"] renewToken failed"),i.toString()),i}finally{n()}}enableAudioVolumeIndicator(){this._audioVolumeIndicationInterval?E.warning("you have already enabled audio volume indicator!"):this._audioVolumeIndicationInterval=window.setInterval(()=>{const t=this._p2pChannel.getAudioLevels();this.safeEmit(Kt.VOLUME_INDICATOR,t)},N("AUDIO_VOLUME_INDICATION_INTERVAL")||2e3)}getRTCStats(){const t=this._statsCollector.getRTCStats(),e=this._gateway.getInChannelInfo();return t.Duration=Math.round(e.duration/1e3),t}async startLiveStreaming(t,e){if(!e){if(this.codec!=="h264")throw new U(b.LIVE_STREAMING_INVALID_RAW_STREAM,"raw streaming is only support h264");if(!this._p2pChannel.hasLocalMedia())throw new U(b.LIVE_STREAMING_INVALID_RAW_STREAM,"can not find stream to raw streaming")}if(this._liveRawStreamingClient&&this._liveRawStreamingClient.hasUrl(t)||this._liveTranscodeStreamingClient&&this._liveTranscodeStreamingClient.hasUrl(t))throw new U(b.LIVE_STREAMING_TASK_CONFLICT);const n=e?Un.TRANSCODE:Un.RAW;return this._createLiveStreamingClient(n).startLiveStreamingTask(t,n)}setLiveTranscoding(t){return this._createLiveStreamingClient(Un.TRANSCODE).setTranscodingConfig(t)}async stopLiveStreaming(t){const e=[this._liveRawStreamingClient,this._liveTranscodeStreamingClient].filter(n=>n&&n.hasUrl(t));if(!e.length)throw new U(b.INVALID_PARAMS,"can not find live streaming url to stop");await ot.all(e.map(n=>n&&n.stopLiveStreamingTask(t)))}async addInjectStreamUrl(t,e){if(!this._joinInfo)throw new U(b.INVALID_OPERATION,"can not addInjectStreamUrl, no joininfo");const n=this._createLiveStreamingClient(Un.INJECT);n.setInjectStreamConfig(e,0),await n.startLiveStreamingTask(t,Un.INJECT)}async removeInjectStreamUrl(){var t;const e=this._createLiveStreamingClient(Un.INJECT),n=Array.from(ao(t=e.streamingTasks).call(t)).find(i=>i.mode===Un.INJECT);if(!this._joinInfo||!n)throw new U(b.INVALID_OPERATION,"can remove addInjectStreamUrl, no joininfo or inject task");await e.stopLiveStreamingTask(n.url)}async startChannelMediaRelay(t){lN(t),await this._createChannelMediaRelayClient().startChannelMediaRelay(t)}async updateChannelMediaRelay(t){lN(t),await this._createChannelMediaRelayClient().updateChannelMediaRelay(t)}async stopChannelMediaRelay(){await this._createChannelMediaRelayClient().stopChannelMediaRelay(),this._statsCollector.onStatsChanged&&(this._statsCollector.onStatsChanged=void 0)}async sendStreamMessage(t){var e;let n=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1];if(!this._joinInfo)throw new U(b.INVALID_OPERATION,"can not send data stream, not joined");if((typeof t=="string"||t instanceof Uint8Array)&&(t={payload:t}),typeof t.payload=="string"){const r=new TextEncoder;t.payload=r.encode(t.payload)}let i=!1;if(this._encryptDataStream&&this._encryptDataStreamIv&&this._encryptDataStreamKey&&window.crypto.subtle&&it(e=["aes-128-gcm2","aes-256-gcm2"]).call(e,this._encryptionMode)&&(i=!0,t.payload=await async function(r,o,s){var a;const c=io(a=Array.from(s)).call(a,(m,g)=>m+g,0),d={serverTs:0,seq:KF++,length:s.length,checkSum:c},u=new Uint8Array(rb(c,2)),l=new ArrayBuffer(nd),p=new DataView(l);p.setUint32(0,d.serverTs),p.setUint16(4,d.seq),p.setUint16(6,d.length),p.setUint16(8,d.checkSum);const f=16-s.length%16;s=$I(s,new Uint8Array(f));const C=await window.crypto.subtle.encrypt({name:"AES-GCM",iv:r,tagLength:ab,additionalData:u},o,s);return $I(new Uint8Array(l),new Uint8Array(C))}(this._encryptDataStreamIv,this._encryptDataStreamKey,t.payload)),new Blob([t.payload]).size>1024)throw new U(b.INVALID_PARAMS,i?"encrypted stream message out of range.":"stream message out of range.");return this._gateway.signal.request(Tt.DATA_STREAM,{payload:Ks(t.payload),syncWithAudio:t.syncWithAudio,sendTs:Date.now()-P3},!n)}sendMetadata(t){if(!this._joinInfo)throw new U(b.INVALID_OPERATION,"can not send metadata, not joined");if(new Blob([t]).size>1024)throw new U(b.METADATA_OUT_OF_RANGE);return this._gateway.signal.request(Tt.SEND_METADATA,{session_id:this._joinInfo.sid,metadata:Ks(t)})}async sendCustomReportMessage(t){if(Array.isArray(t)||(t=[t]),t.forEach(YF),!this._joinInfo)throw new U(b.INVALID_OPERATION,"can not send custom report, not joined");await Et.sendCustomReportMessage(this._joinInfo.sid,t)}getLocalAudioStats(){return this._statsCollector.getLocalAudioTrackStats()}getRemoteAudioStats(){return this._statsCollector.getRemoteAudioTrackStats()}getLocalVideoStats(){return this._statsCollector.getLocalVideoTrackStats()}getRemoteVideoStats(){return this._statsCollector.getRemoteVideoTrackStats()}getRemoteNetworkQuality(){return this._statsCollector.getRemoteNetworkQualityStats()}async pickSVCLayer(t,e){yn(e.spatialLayer,"spatialLayer",[0,1,2,3]),yn(e.temporalLayer,"temporalLayer",[0,1,2,3]);try{await this._gateway.pickSVCLayer(t,e)}catch(n){throw E.error("[".concat(this._clientId,"] pick SVC layer failed"),n.toString()),n}}async setRTMConfig(t){const{apRTM:e=!1,rtmFlag:n}=t;if(hs(e,"apRTM"),Se(n,"rtmFlag",0),this._rtmConfig.apRTM=e,this._rtmConfig.rtmFlag=n,E.debug("[".concat(this._clientId,"] setRTMconfig ").concat(JSON.stringify(t)," in ").concat(this.connectionState," state")),(this.connectionState==="CONNECTED"||this.connectionState==="RECONNECTING")&&this._joinInfo)return this._joinInfo.apRTM=e,this._joinInfo.rtmFlag=n,this._gateway.setRTM2Flag(n)}_reset(){if(E.debug("[".concat(this._clientId,"] reset client")),this._axiosCancelSource.cancel(),this._axiosCancelSource=yi.CancelToken.source(),this._streamFallbackTypeCacheMap=new Map,this._remoteStreamTypeCacheMap=new Map,this._configDistribute.stopGetConfigDistribute(),this._joinInfo&&sD(this._joinInfo),this._joinInfo=void 0,this._proxyServer=void 0,this._defaultStreamFallbackType=void 0,this._sessionId=null,this.store.sessionId=null,this._statsCollector.reset(),this._key=void 0,this._appId=void 0,this._uid=void 0,this.store.uid=void 0,this._channelName=void 0,this._encryptionMode="none",this._encryptionSecret=null,this._encryptionSalt=null,this._encryptDataStreamKey=null,this._encryptDataStreamIv=null,this._pendingPublishedUsers=[],this._users.forEach(t=>{t._audioTrack&&t._audioTrack._destroy(),t._videoTrack&&t._videoTrack._destroy(),t._dataChannels&&(t._dataChannels.forEach(e=>e._close()),t._dataChannels.length=0)}),this._users=[],this._audioVolumeIndicationInterval&&(window.clearInterval(this._audioVolumeIndicationInterval),this._audioVolumeIndicationInterval=void 0),this._cloudProxyServerMode==="fallback"&&(this._cloudProxyServerMode="disabled",this.store.cloudProxyServerMode="disabled"),this._p2pChannel.reset(),this._publishMutex=new kn("client-publish"),this._subscribeMutex=new kn("client-subscribe"),this._networkQualityInterval&&(window.clearInterval(this._networkQualityInterval),this._networkQualityInterval=void 0),this._injectStreamingClient&&(this._injectStreamingClient.terminate(),this._injectStreamingClient.removeAllListeners(),this._injectStreamingClient=void 0),this._liveRawStreamingClient&&(this._liveRawStreamingClient.terminate(),this._liveRawStreamingClient.removeAllListeners(),this._liveRawStreamingClient=void 0),this._liveTranscodeStreamingClient&&(this._liveTranscodeStreamingClient.terminate(),this._liveTranscodeStreamingClient.removeAllListeners(),this._liveTranscodeStreamingClient=void 0),this._channelMediaRelayClient&&(this._channelMediaRelayClient.dispose(),this._channelMediaRelayClient=void 0),this._inspect)try{this._inspect.close(),this._inspect=void 0}catch{}if(this._moderation)try{this.setImageModeration(!1)}catch{}}_startSession(t,e){var n;const i=t||Ju();t?E.debug("[".concat(this._clientId,"] new Session ").concat(i)):E.debug("[".concat(this._clientId,"] renewSession ").concat(this._sessionId," => ").concat(i));const r=t?"":this._sessionId||"";this._sessionId=i,this.store.sessionId=i;const o={lts:new Date().getTime(),mode:this.mode,buildFormat:1,stringUid:(e==null?void 0:e.stringUid)||((n=this._joinInfo)===null||n===void 0?void 0:n.stringUid),channelProfile:this.mode==="live"?1:0,channelMode:0,isABTestSuccess:Number(this._configDistribute.isSuccess),lsid:r,clientRole:this.role==="audience"?2:1};e?Et.sessionInit(this._sessionId,Rr({cname:e.channel,appid:e.appId,preload:e.preload},o)):this._joinInfo?Et.sessionInit(this._sessionId,Rr({cname:this._joinInfo.cname,appid:this._joinInfo.appId,preload:!!this._joinInfo.recoverPreloadCache},o)):this._gateway.joinInfo&&Et.sessionInit(this._sessionId,Rr({cname:this._gateway.joinInfo.cname,appid:this._gateway.joinInfo.appId},o)),this._joinInfo&&(this._joinInfo.sid=i),this._gateway.joinInfo&&(this._gateway.joinInfo.sid=i)}async _publishHighStream(t){if(!this._joinInfo||this._uid===void 0)throw new U(b.INVALID_OPERATION,"Can't publish stream, haven't joined yet!");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new U(b.INVALID_OPERATION,"can not publish stream in ".concat(this.connectionState," state"));if(this._turnServer.mode==="auto"&&N("FORCE_TURN")&&!N("TURN_ENABLE_TCP")&&!N("TURN_ENABLE_UDP"))throw new U(b.UNEXPECTED_ERROR,"force TURN With No TURN Configuration");E.debug("[".concat(this._clientId,"] publish high stream"));try{const n=await this._p2pChannel.publish(t,this._isDualStreamEnabled,this._lowStreamParameter);if(this._p2pChannel instanceof Ki){const i=(await n.next()).value;if(i){try{await this._gateway.sendExtensionMessage(rn.PUBLISH,i,!0)}catch(r){throw n.throw(r),r}await n.next()}this._p2pChannel.reportPublishEvent(!0,null)}else{const i=(await n.next()).value;if(i){var e;let r;try{r=await this._gateway.publish(this._uid,i,!0)}catch(o){if(o.code!==b.DISCONNECT_P2P)throw n.throw(o),o}await n.next(((e=r)===null||e===void 0?void 0:e.ortc)||[])}this._p2pChannel.reportPublishEvent(!0,null);for(const r of t)r instanceof Ae&&r._encoderConfig&&this._gateway.setVideoProfile(r._encoderConfig),!r.muted&&r.enabled||await this._p2pChannel.muteLocalTrack(r)}}catch(n){if(this._p2pChannel.reportPublishEvent(!1,n==null?void 0:n.code,t),(n==null?void 0:n.code)===b.WS_ABORT)return;throw n}}async _publishLowStream(){if(!this._joinInfo||this._uid===void 0)throw new U(b.INVALID_OPERATION,"Can't publish stream, haven't joined yet!");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new U(b.INVALID_OPERATION,"can not publish stream in ".concat(this.connectionState," state"));E.debug("[".concat(this._clientId,"] publish low stream"));const t=this._configDistribute.getLowStreamConfigDistribute();t&&t.bitrate&&(this._lowStreamParameter||(this._lowStreamParameter={width:160,height:120,framerate:15,bitrate:50}),this._lowStreamParameter&&this._lowStreamParameter.bitrate&&t.bitrate<this._lowStreamParameter.bitrate&&(this._lowStreamParameter.bitrate=t.bitrate));try{const n=await this._p2pChannel.publishLowStream(this._lowStreamParameter),i=(await n.next()).value;if(i){var e;let r;try{r=await this._gateway.publish(this._uid,i,!0)}catch(o){if(o.code!==b.DISCONNECT_P2P)throw n.throw(o),o}n.next(((e=r)===null||e===void 0?void 0:e.ortc)||[]),this._p2pChannel.reportPublishEvent(!0,null,void 0,!0)}}catch(n){if(this._p2pChannel.reportPublishEvent(!1,n==null?void 0:n.code,void 0,!0),(n==null?void 0:n.code)===b.WS_ABORT)return;throw n}}_createLiveStreamingClient(t){if(!this._joinInfo||!this._appId)return new U(b.INVALID_OPERATION,"can not create live streaming client, please join channel first").throw();const e=()=>new s3(this._joinInfo,this._config.websocketRetryConfig||dn,this._config.httpRetryConfig||dn),n=i=>{i.onLiveStreamError=(r,o)=>{Et.reportApiInvoke(this._sessionId,{name:_n.ON_LIVE_STREAM_ERROR,options:[r,o],tag:Je.TRACER}).onSuccess(),this.safeEmit(Kt.LIVE_STREAMING_ERROR,r,o)},i.onLiveStreamWarning=(r,o)=>{Et.reportApiInvoke(this._sessionId,{name:_n.ON_LIVE_STREAM_WARNING,options:[r,o],tag:Je.TRACER}).onSuccess(),this.safeEmit(Kt.LIVE_STREAMING_WARNING,r,o)},i.on(Hp.REQUEST_WORKER_MANAGER_LIST,(r,o,s)=>{if(!this._joinInfo)return s(new U(b.INVALID_OPERATION,"can not find join info to get worker manager"));Xb(r,this._joinInfo,this._axiosCancelSource.token,dn).then(o).catch(s)})};switch(t){case Un.RAW:return this._liveRawStreamingClient||(this._liveRawStreamingClient=e(),n(this._liveRawStreamingClient)),this._liveRawStreamingClient;case Un.TRANSCODE:return this._liveTranscodeStreamingClient||(this._liveTranscodeStreamingClient=e(),n(this._liveTranscodeStreamingClient)),this._liveTranscodeStreamingClient;case Un.INJECT:return this._injectStreamingClient||(this._injectStreamingClient=e(),this._injectStreamingClient.on(Hp.REQUEST_WORKER_MANAGER_LIST,(i,r,o)=>{if(!this._joinInfo)return o(new U(b.INVALID_OPERATION,"can not find join info to get worker manager"));Xb(i,this._joinInfo,this._axiosCancelSource.token,dn).then(r).catch(o)}),this._injectStreamingClient.onInjectStatusChange=(i,r,o)=>{this.safeEmit(Kt.INJECT_STREAM_STATUS,i,r,o)}),this._injectStreamingClient}}_createChannelMediaRelayClient(){if(!this._joinInfo)return new U(b.INVALID_OPERATION,"can not create channel media relay client, please join channel first").throw();if(!this._channelMediaRelayClient){const{sendResolutionWidth:t,sendResolutionHeight:e}=this.getLocalVideoStats(),n={width:t,height:e};this._channelMediaRelayClient=new c3(this._joinInfo,this._clientId,this._config.websocketRetryConfig||dn,this._config.httpRetryConfig||dn,n),this._channelMediaRelayClient.on("state",i=>{i===Di.RELAY_STATE_FAILURE&&this._channelMediaRelayClient&&this._channelMediaRelayClient.dispose(),this.safeEmit(Kt.CHANNEL_MEDIA_RELAY_STATE,i)}),this._channelMediaRelayClient.on("event",i=>{this.safeEmit(Kt.CHANNEL_MEDIA_RELAY_EVENT,i)}),this._statsCollector.onStatsChanged=(i,r)=>{var o;i==="resolution"&&((o=this._channelMediaRelayClient)===null||o===void 0||o.setVideoProfile(r))}}return this._channelMediaRelayClient}_handleUpdateDataChannel(t,e){const{added:n,deleted:i}=t,r=[];Array.isArray(n)&&n.length>0&&n.forEach(o=>{const{uid:s,stream_id:a,ordered:c,max_retrans_times:d,metadata:u}=o,l=this._users.find(p=>p._uintid===s);if(!l)return void E.error("[".concat(this._clientId,"] can not find target user!(on_add_data_channel)"));if(E.debug("[".concat(this._clientId,"] data_channel added with uid ").concat(s)),it(r).call(r,l)||r.push(l),l._uintid||(l._uintid=s),l._dataChannels.findIndex(p=>p.id===o.stream_id)===-1){const p={id:a,ordered:!!c,maxRetransmits:d,metadata:u},f=new xW(p);l._dataChannels.push(f),E.info("[".concat(this._clientId,"] remote user ").concat(l.uid," published datachannel")),e||this.safeEmit(Kt.USER_PUBLISHED,l,"datachannel",p)}this._p2pChannel.hasPendingRemoteDataChannel(l,o.stream_id)&&(E.debug("[".concat(this._clientId,"] resubscribe datachannel for user ").concat(l.uid," after reconnect.")),this._subscribeDataChannel(l,o.stream_id).catch(p=>{E.error("[".concat(this._clientId,"] resubscribe datachannel error"),p.toString())}))}),e&&(this.safeEmit(Kt.PUBLISHED_USER_LIST,this._pendingPublishedUsers),this._pendingPublishedUsers=[]),Array.isArray(i)&&i.length>0&&i.forEach(o=>{const{uid:s,stream_id:a}=o,c=this._users.find(u=>u._uintid===s);if(!c)return void E.error("[".concat(this._clientId,"] can not find target user!(on_delete_data_channel)"));const d=c._dataChannels.find(u=>u.id===o.stream_id);d&&(E.debug("[".concat(this._clientId,"] data_stream delete with uid ").concat(s)),this._p2pChannel.unsubscribeDataChannel(c,[d]).then(u=>{if(c._dataChannels=c._dataChannels.filter(l=>l!==d),u)return this._gateway.unsubscribeDataChannel(u,c.uid)}),E.info("[".concat(this._clientId,"] remote user ").concat(s," unpublished datachannel ,id:").concat(d.id)),this.safeEmit(Kt.USER_UNPUBLISHED,c,"datachannel",d._config))})}_handleRemoveDataChannels(t){const e=this._users.find(n=>n.uid===t.uid);if(e){if(e._dataChannels!==void 0&&e._dataChannels.length>0){E.debug("[".concat(this._clientId,"] datachannel removed with uid ").concat(t.uid));const n=()=>{E.info("[".concat(this._clientId,"] remote user ").concat(e.uid," unpublished datachannel")),e._dataChannels.forEach(i=>{this.safeEmit(Kt.USER_UNPUBLISHED,e,"datachannel",i._config)})};this._p2pChannel.unsubscribeDataChannel(e,e._dataChannels).then(i=>{if(i)return this._gateway.unsubscribeDataChannel(i,e.uid)}),n()}}else E.warning("[".concat(this._clientId,"] can not find target user!(on_remove_datachannel)"))}_handleGatewayEvents(){this._gateway.on(nn.DISCONNECT_P2P,async()=>{await this._p2pChannel.disconnectForReconnect()}),this._gateway.on(nn.CONNECTION_STATE_CHANGE,(t,e,n)=>{var i;if(n===Ht.FALLBACK)return;const r=()=>{this.safeEmit(Kt.CONNECTION_STATE_CHANGE,t,e,n)};if(Et.reportApiInvoke(this._sessionId||((i=this._gateway.joinInfo)===null||i===void 0?void 0:i.sid)||null,{name:_n.CONNECTION_STATE_CHANGE,options:[t,e,n],tag:Je.TRACER}).onSuccess(JSON.stringify({cur:t,prev:e,reason:n})),E.info("[".concat(this._clientId,"] connection state change: ").concat(e," -> ").concat(t)),t==="DISCONNECTED")return this._reset(),void r();if(t==="RECONNECTING")this._users.forEach(s=>{s._trust_in_room_=!1,s._trust_audio_enabled_state_=!1,s._trust_video_enabled_state_=!1,s._trust_audio_mute_state_=!1,s._trust_video_mute_state_=!1,s._trust_audio_stream_added_state_=!1,s._trust_video_stream_added_state_=!1,s._is_pre_created||(s._audio_pre_subscribed||(s._audioSSRC=void 0,s._audioOrtc=void 0),s._video_pre_subscribed||(s._videoSSRC=void 0,s._videoOrtc=void 0,s._rtxSsrcId=void 0),s._cname=void 0)}),this._userOfflineTimeout&&window.clearTimeout(this._userOfflineTimeout),this._streamRemovedTimeout&&window.clearTimeout(this._streamRemovedTimeout),this._userOfflineTimeout=void 0,this._streamRemovedTimeout=void 0;else if(t==="CONNECTED"){var o;this._streamFallbackTypeCacheMap.forEach((s,a)=>{this._gateway.setStreamFallbackOption(a,s).catch(c=>{E.warning("[".concat(this._clientId,"] auto set stream fallback option failed"),c)})}),this._remoteStreamTypeCacheMap.forEach((s,a)=>{this._gateway.setRemoteVideoStreamType(a,s).catch(c=>{E.warning("[".concat(this._clientId,"] auto set remote stream type failed"),c)})}),this._remoteDefaultVideoStreamType!==void 0&&((o=this._joinInfo)===null||o===void 0?void 0:o.defaultVideoStream)===void 0&&this.setRemoteDefaultVideoStreamType(this._remoteDefaultVideoStreamType).then(()=>{E.debug("[".concat(this._clientId,"] setRemoteDefaultVideoStreamType after gateway connected"))}).catch(s=>{E.error("[".concat(this._clientId,"] setRemoteDefaultVideoStreamType after gateway failed, ").concat(s))}),this.store.useP2P||(this._p2pChannel.republish(),this._userOfflineTimeout=window.setTimeout(()=>{this.connectionState==="CONNECTED"&&(this._userOfflineTimeout=void 0,this._users.filter(s=>!s._trust_in_room_).forEach(s=>{E.debug("[".concat(this._clientId,"] user offline timeout, emit user offline ").concat(s.uid)),this._handleUserOffline({uid:s.uid})}))},3e3),this._streamRemovedTimeout=window.setTimeout(()=>{this.connectionState==="CONNECTED"&&(this._streamRemovedTimeout=void 0,this._users.forEach(s=>{s._trust_audio_mute_state_||(E.debug("[".concat(this._clientId,"] auto dispatch audio unmute event ").concat(s.uid)),this._handleMuteStream(s.uid,_t.AUDIO,!1)),s._trust_video_mute_state_||(E.debug("[".concat(this._clientId,"] auto dispatch video unmute event ").concat(s.uid)),this._handleMuteStream(s.uid,_t.VIDEO,!1)),s._trust_audio_enabled_state_||(E.debug("[".concat(this._clientId,"] auto dispatch enable local audio ").concat(s.uid)),this._handleSetStreamLocalEnable("audio",s.uid,!0)),s._trust_video_enabled_state_||(E.debug("[".concat(this._clientId,"] auto dispatch enable local video ").concat(s.uid)),this._handleSetStreamLocalEnable("video",s.uid,!0)),s._trust_video_stream_added_state_||(E.debug("[".concat(this._clientId,"] auto dispatch reset video stream added ").concat(s.uid)),this._handleResetAddStream(s,"video")),s._trust_audio_stream_added_state_||(E.debug("[".concat(this._clientId,"] auto dispatch reset audio stream added ").concat(s.uid)),this._handleResetAddStream(s,"audio")),s._video_added_||s._audio_added_||(E.debug("[".concat(this._clientId,"] auto dispatch stream remove ").concat(s.uid)),this._handleRemoveStream({uid:s.uid,uint_id:s._uintid}))}))},1e3))}r()}),this._gateway.on(nn.REQUEST_NEW_GATEWAY_LIST,async(t,e)=>{if(!this._joinInfo)return e(new U(b.UNEXPECTED_ERROR,"can not recover, no join info"));try{let n;this._joinInfo.recoverPreloadCache?(n=this._joinInfo.recoverPreloadCache.ap,aD(this._joinInfo.recoverPreloadCache),this._joinInfo.recoverPreloadCache=void 0):n=await vg(this._joinInfo,this._axiosCancelSource.token,this._config.httpRetryConfig||dn,this.store),this._joinInfo&&(this._joinInfo.apResponse=n.gatewayInfo.res,this._joinInfo.gatewayAddrs=n.gatewayInfo.gatewayAddrs,this._joinInfo.uni_lbs_ip=n.gatewayInfo.uni_lbs_ip);const i=[];n.gatewayInfo.gatewayAddrs.forEach(r=>{let{address:o}=r;const[s,a]=o.split(":");this._joinInfo&&this._joinInfo.proxyServer?i.push({proxy:this._joinInfo.proxyServer,host:s,port:a}):i.push({host:s,port:a})}),t(i)}catch(n){e(n)}}),this._gateway.on(nn.NETWORK_QUALITY,t=>{this._networkQualitySensitivity==="normal"&&this.safeEmit(Kt.NETWORK_QUALITY,t)}),this._gateway.on(nn.STREAM_TYPE_CHANGE,(t,e)=>{this.safeEmit(Kt.STREAM_TYPE_CHANGED,t,e),Et.reportApiInvoke(this._sessionId,{name:_n.STREAM_TYPE_CHANGE,options:[t,e],tag:Je.TRACER}).onSuccess(JSON.stringify({uid:t,streamType:e}))}),this._gateway.on(nn.IS_P2P_DISCONNECTED,t=>{this._p2pChannel.isP2PDisconnected()?t(!0):this._p2pChannel.hasLocalMedia()||this._p2pChannel.hasRemoteMedia()?t(!1):t(!0)}),this._gateway.on(nn.NEED_RENEW_SESSION,async t=>{if(t==="recover"&&this._joinInfo){const e=await rD(Rr(Rr({},this._joinInfo),{},{uid:this._joinInfo.uid,stringUid:void 0}));this._joinInfo.recoverPreloadCache=e,this._startSession(e==null?void 0:e.sid)}else this._startSession()}),this._gateway.on(nn.REQUEST_P2P_CONNECTION_PARAMS,async(t,e,n)=>{try{e(await this._p2pChannel.startP2PConnection(t))}catch(i){n(i)}}),this._gateway.on(nn.JOIN_RESPONSE,(t,e)=>{if(this.store.useP2P)return;const{dtlsParameters:n,iceParameters:i,candidates:r,rtpCapabilities:o,setup:s,cname:a}=F0(t.ortc,e);this._p2pChannel.connect(i,n,r,o,s,a)}),this._gateway.on(nn.REQUEST_DC_CONNECTION_PARAMS,t=>{t(this._p2pChannel.getEstablishParams())}),this._gateway.on(nn.RESET_SIGNAL,t=>{this._p2pChannel.resetConnection(t),this._handleGatewaySignalEvents()}),this._gateway.on(nn.DATACHANNEL_FAILBACK,()=>{this._joinGateway()}),this._gateway.on(nn.DATACHANNEL_PRECONNECT,async(t,e,n,i)=>{var r,o,s,a,c,d;await this._p2pChannel.startP2PConnection({turnServer:(r=this._joinInfo)===null||r===void 0?void 0:r.turnServer},!0);const u=function(l,p){let f;return p&&p.ip&&typeof p.port=="number"?(f=[{foundation:"udpcandidate",componentId:"1",transport:"udp",priority:"2103266323",connectionAddress:p.ip,port:p.port.toString(),type:"host",extension:{}}],E.debug("Using remote candidate from AP ".concat(p.ip,":").concat(p.port)),p.ip6&&(f.push({foundation:"udpcandidate",componentId:"1",transport:"udp",priority:"2103266323",connectionAddress:p.ip6,port:p.port.toString(),type:"host",extension:{}}),E.debug("Using IPV6 remote candidate from AP ".concat(p.ip6,":").concat(p.port)))):f=[{foundation:"udpcandidate",componentId:"1",transport:"udp",priority:"2103266323",connectionAddress:l.ip,port:l.port.toString(),type:"host",extension:{}}],f}(t,e);return this._p2pChannel.preConnect({iceUfrag:"".concat((o=this._joinInfo)===null||o===void 0?void 0:o.apResponse.cid,"_").concat((s=this._joinInfo)===null||s===void 0?void 0:s.apResponse.cert),icePwd:"".concat((a=this._joinInfo)===null||a===void 0?void 0:a.apResponse.cid,"_").concat((c=this._joinInfo)===null||c===void 0?void 0:c.apResponse.cert)},{fingerprints:[{hashFunction:"sha-256",fingerprint:(d=N("FINGERPRINT"))!==null&&d!==void 0?d:t.fingerprint}]},u,{send:{audioCodecs:[],videoCodecs:[],audioExtensions:[],videoExtensions:[]},recv:{audioCodecs:[],videoCodecs:[],audioExtensions:[],videoExtensions:[]}},"active","o/i14u9pJrxRKAsu").then(n).catch(i)})}_handleGatewaySignalEvents(){this._gateway.signal.on(Nt.ON_USER_ONLINE,this._handleUserOnline),this._gateway.signal.on(Nt.ON_USER_OFFLINE,this._handleUserOffline),this._gateway.signal.on(Nt.ON_ADD_AUDIO_STREAM,t=>this._handleAddAudioOrVideoStream("audio",t.uid,t.ssrcId,t.cname,t.uint_id,t.ortc)),this._gateway.signal.on(Nt.ON_ADD_VIDEO_STREAM,t=>this._handleAddAudioOrVideoStream("video",t.uid,t.ssrcId,t.cname,t.uint_id,t.ortc,t.rtxSsrcId)),this._gateway.signal.on(Nt.ON_REMOTE_DATASTREAM_UPDATE,t=>{this._handleUpdateDataChannel(t)}),this._gateway.signal.on(Nt.ON_REMOTE_FULL_DATASTREAM_INFO,t=>{this._handleUpdateDataChannel({added:t.datastreams,deleted:[]},!0)}),this._gateway.signal.on(Nt.ON_REMOVE_STREAM,this._handleRemoveStream),this._gateway.signal.on(Nt.ON_P2P_LOST,this._handleP2PLost),this._gateway.signal.on(Nt.MUTE_AUDIO,t=>this._handleMuteStream(t.uid,_t.AUDIO,!0)),this._gateway.signal.on(Nt.UNMUTE_AUDIO,t=>this._handleMuteStream(t.uid,_t.AUDIO,!1)),this._gateway.signal.on(Nt.MUTE_VIDEO,t=>this._handleMuteStream(t.uid,_t.VIDEO,!0)),this._gateway.signal.on(Nt.UNMUTE_VIDEO,t=>this._handleMuteStream(t.uid,_t.VIDEO,!1)),this._gateway.signal.on(Nt.RECEIVE_METADATA,t=>{const e=Va(t.metadata);this.safeEmit(Kt.RECEIVE_METADATA,t.uid,e)}),this._gateway.signal.on(Nt.ON_DATA_STREAM,async t=>{var e;if(!t)return;let n=Va(t.payload);if(this._encryptDataStream&&this._encryptDataStreamIv&&this._encryptDataStreamKey&&window.crypto.subtle&&it(e=["aes-128-gcm2","aes-256-gcm2"]).call(e,this._encryptionMode)){if(t.payload.length<nd)throw new U(b.UNEXPECTED_RESPONSE,"payload length ".concat(t.payload.length," is less than header length ").concat(nd));n=await async function(o,s,a){const c=a.subarray(0,nd),d=c.slice(8,nd),u=(d[0]<<8)+d[1],l=(c[6]<<8)+c[7],p=await window.crypto.subtle.decrypt({name:"AES-GCM",iv:o,tagLength:ab,additionalData:new Uint8Array(rb(u,2))},s,a.subarray(nd));return new Uint8Array(p).subarray(0,l)}(this._encryptDataStreamIv,this._encryptDataStreamKey,n)}let i=0;if(t.ordered||t.syncWithAudio){const r=this._p2pChannel.getStats(),o=this.remoteUsers.find(a=>a.uid===t.uid),s=r==null?void 0:r.audioRecv.find(a=>a.ssrc===(o==null?void 0:o._audioSSRC));i=s==null?void 0:s.jitterBufferMs}i==null&&(i=0),k3(Rr(Rr({},t),{},{payload:n}),i,{id:this._clientId,onStreamMessage:typeof this.onStreamMessage=="function"?this.onStreamMessage.bind(this):void 0,safeEmit:this.safeEmit.bind(this)})}),this._gateway.signal.on(Nt.ON_CRYPT_ERROR,()=>{Hs(()=>{E.warning("[".concat(this._clientId,"] on crypt error")),this.safeEmit(Kt.CRYPT_ERROR)},this._sessionId)}),this._gateway.signal.on(Nt.ON_TOKEN_PRIVILEGE_WILL_EXPIRE,this._handleTokenWillExpire),this._gateway.signal.on(Nt.ON_TOKEN_PRIVILEGE_DID_EXPIRE,()=>{E.warning("[".concat(this._clientId,"] received message onTokenPrivilegeDidExpire, please get new token and join again")),this._gateway.leave(!0,Ht.TOKEN_EXPIRE),this.safeEmit(Kt.ON_TOKEN_PRIVILEGE_DID_EXPIRE),this._reset()}),this._gateway.signal.on(Nt.ON_STREAM_FALLBACK_UPDATE,t=>{E.debug("[".concat(this._clientId,"] stream fallback peerId: ").concat(t.stream_id,", attr: ").concat(t.stream_type)),this.safeEmit(Kt.STREAM_FALLBACK,t.stream_id,t.stream_type===1?"fallback":"recover")}),this._gateway.signal.on(Nt.ON_PUBLISH_STREAM,t=>{this.uid===this._uid&&(this._p2pChannel.reportPublishEvent(!0,null,void 0,!1,JSON.stringify({proxy:t.proxy})),E.info("[".concat(this._clientId,"] on publish stream, ").concat(JSON.stringify(t))))}),this._gateway.signal.on(Nt.ENABLE_LOCAL_VIDEO,t=>{this._handleSetStreamLocalEnable("video",t.uid,!0)}),this._gateway.signal.on(Nt.DISABLE_LOCAL_VIDEO,t=>{this._handleSetStreamLocalEnable("video",t.uid,!1)}),this._gateway.signal.on(ht.REQUEST_TIMEOUT,(t,e)=>{if(this._joinInfo)switch(t){case Tt.PUBLISH:{if(!e)return;const r=e.ortc;if(r){var n,i;const o=r.some(c=>{let{stream_type:d}=c;return d===le.Audio}),s=r.some(c=>{let{stream_type:d}=c;return d!==le.Audio}),a=r.some(c=>{let{stream_type:d}=c;return d===le.Screen||d===le.ScreenLow});e.state==="offer"&&Et.publish(this._joinInfo.sid,{eventElapse:$n.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:!1,ec:b.TIMEOUT,audio:o,video:s,p2pid:e.p2p_id,publishRequestid:this.store.pubId,screenshare:a,audioName:o?(n=r.find(c=>{let{stream_type:d}=c;return d===le.Audio}))===null||n===void 0||(n=n.ssrcs[0])===null||n===void 0?void 0:n.ssrcId.toString():void 0,videoName:s?(i=r.find(c=>{let{stream_type:d}=c;return d!==le.Audio}))===null||i===void 0||(i=i.ssrcs[0])===null||i===void 0?void 0:i.ssrcId.toString():void 0})}break}case Tt.SUBSCRIBE:e&&Et.subscribe(this._joinInfo.sid,{succ:!1,ec:b.TIMEOUT,audio:e.stream_type===_t.AUDIO,video:e.stream_type===_t.VIDEO,peerid:e.stream_id,subscribeRequestid:e.ssrcId,p2pid:this.store.p2pId,eventElapse:$n.measureFromSubscribeStart(this.store.clientId,e.ssrcId)})}}),this._gateway.signal.on(Nt.ON_P2P_OK,t=>{this.uid,this._uid}),this._gateway.signal.on(Nt.ON_PUBLISHED_USER_LIST,t=>{if(t==null||!t.users)return;N("BLOCK_LOCAL_CLIENT")&&(t.users=t.users.filter(i=>!ja(i.string_id||i.stream_id,this.channelName)));const e=[],n=[];for(const i of t.users){let r=this._users.find(u=>u._uintid===i.stream_id);r?r._trust_in_room_=!0:(r=new aa(i.string_id||i.stream_id,i.stream_id),this._users.push(r),this.getListeners(Kt.PUBLISHED_USER_LIST).length===0&&(E.debug("[".concat(this._clientId,"] user online"),i.stream_id),this.safeEmit(Kt.USER_JOINED,r)));const o=On.Audio&i.stream_type,s=(On.Video|On.LwoVideo)&i.stream_type,a=(65280&i.stream_type)!=0,c=o&&r.hasAudio,d=s&&r.hasVideo;s&&(r._trust_video_stream_added_state_=!0,r._video_added_=!0,r._videoSSRC=i.video_ssrc,r._rtxSsrcId=i.video_rtx),o&&(r._trust_audio_stream_added_state_=!0,r._audio_added_=!0,r._audioSSRC=i.audio_ssrc),o&&!c&&this.getListeners(Kt.PUBLISHED_USER_LIST).length===0&&(E.info("[".concat(this._clientId,"] remote user ").concat(r.uid," published audio")),this.safeEmit(Kt.USER_PUBLISHED,r,"audio")),s&&!d&&this.getListeners(Kt.PUBLISHED_USER_LIST).length===0&&(E.info("[".concat(this._clientId,"] remote user ").concat(r.uid," published video")),this.safeEmit(Kt.USER_PUBLISHED,r,"video")),(o&&!c||s&&!d||a)&&e.push(r),s&&this._p2pChannel.hasPendingRemoteMedia(r,"video")&&n.push({user:r,mediaType:"video"}),o&&this._p2pChannel.hasPendingRemoteMedia(r,"audio")&&n.push({user:r,mediaType:"audio"})}n.length>0&&(E.debug("[".concat(this._clientId,"] RE massSubscribe after reconnect ").concat(n.map(i=>"user: ".concat(i.user.uid,", mediaType: ").concat(i.mediaType)).join("; ")," ")),this.massSubscribe(n).catch(i=>{E.error("[".concat(this._clientId,"] mass resubscribe error"),i.toString())})),this.getListeners(Kt.PUBLISHED_USER_LIST).length>0?N("ENABLE_DATASTREAM_2")?this._pendingPublishedUsers=e:(E.info("[".concat(this._clientId,"] client emit user-list event, users: ").concat(e.map(i=>i.uid).join(", "))),this.safeEmit(Kt.PUBLISHED_USER_LIST,e)):E.info("[".concat(this._clientId,"] client not emit user-list event case there is no user-list listener, users: ").concat(e.map(i=>i.uid).join(", ")))}),this._gateway.signal.on(Nt.ON_RTP_CAPABILITY_CHANGE,t=>{const{video_codec:e}=t;this._p2pChannel instanceof Kf&&this._p2pChannel.updateRemoteRTPCapabilities(e.map(n=>n.toLowerCase()).filter(n=>{var i;return it(i=Object.keys(ed)).call(i,n)}))})}_handleP2PEvents(){this._gateway.signal.on(Nt.ON_USER_OFFLINE,()=>{this._p2pChannel.disconnectForReconnect()}),this._gateway.signal.on(rn.PUBLISH,(t,e,n)=>{const{uid:i}=t;t.forEach(r=>{const{kind:o,ssrcs:s,mid:a,isMuted:c}=r;this._handleP2PAddAudioOrVideoStream(o,i,s[0].ssrcId,a);const d=this._users.find(u=>u.uid===i);return d&&this._p2pChannel instanceof Ki?this._p2pChannel.mockSubscribe(d,o,s[0].ssrcId,a).then(()=>{e()}).catch(n):e(),this._handleMuteStream(i,o,!!c)})}),this._gateway.signal.on(rn.CALL,async(t,e,n)=>{if(this._p2pChannel instanceof Ki)try{var i;e(await this._p2pChannel.startP2P({turnServer:(i=this._joinInfo)===null||i===void 0?void 0:i.turnServer},t))}catch(r){n(r)}}),this._gateway.signal.on(ht.P2P_CONNECTION,async t=>{this._p2pChannel instanceof Ki&&await this._p2pChannel.p2pConnect(t)}),this._gateway.signal.on(rn.UNPUBLISH,async(t,e,n)=>{if(this._p2pChannel instanceof Ki){const{unpubMsg:i,uid:r}=t,o=this._users.find(s=>s.uid===r);if(!o)return E.warning("[".concat(this._clientId,"] can not find remote user, ignore mute event, uid: ").concat(r)),void e();try{i.forEach(async s=>{let{stream_type:a}=s;const c=a===le.Audio?_t.AUDIO:_t.VIDEO;await this._p2pChannel.unsubscribe(o,c),this._handleMuteStream(r,c,!0)}),e()}catch(s){n(s)}}}),this._gateway.signal.on(rn.CONTROL,async(t,e)=>{const{action:n}=t;switch(n){case Js.MUTE_LOCAL_VIDEO:this._handleMuteStream(e,_t.VIDEO,!0);break;case Js.MUTE_LOCAL_AUDIO:this._handleMuteStream(e,_t.AUDIO,!0);break;case Js.UNMUTE_LOCAL_VIDEO:this._handleP2PAddAudioOrVideoStream("video",e),this._handleMuteStream(e,_t.VIDEO,!1);break;case Js.UNMUTE_LOCAL_AUDIO:this._handleP2PAddAudioOrVideoStream("audio",e),this._handleMuteStream(e,_t.AUDIO,!1)}}),this._gateway.signal.on(rn.RESTART_ICE,async(t,e,n)=>{if(this._p2pChannel instanceof Ki)try{const{direction:i,iceParameter:r}=t;i!==mi.SEND_ONLY||r?e(await this._p2pChannel.restartICE(i,r)):(this._p2pChannel.handleDisconnect(i),e())}catch(i){n(i)}}),this._gateway.signal.on(rn.CANDIDATE,t=>{if(this._p2pChannel instanceof Ki){const{candidate:e,direction:n}=t;this._p2pChannel.addRemoteCandidate(e,n)}}),this._p2pChannel.on(yt.RequestP2PRestartICE,async(t,e,n)=>{try{const{direction:i}=t;e(await this._gateway.sendExtensionMessage(rn.RESTART_ICE,t,i===mi.SEND_ONLY))}catch(i){n(i)}}),this._p2pChannel.on(yt.LocalCandidate,t=>{this._gateway.sendExtensionMessage(rn.CANDIDATE,JSON.stringify(t),!0)}),this._p2pChannel.on(yt.RequestP2PMuteLocal,async(t,e,n)=>{try{await this._gateway.sendExtensionMessage(rn.CONTROL,t,!0),e()}catch(i){n(i)}}),this._p2pChannel.on(yt.RequestP2PUnmuteRemote,async(t,e,n)=>{if(this._joinInfo)try{await this._gateway.unmuteRemote(t,this._joinInfo.stringUid||this._joinInfo.uid),e()}catch(i){i.code===b.DISCONNECT_P2P?e():n(i)}else e()}),this._p2pChannel.on(yt.RequestP2PMuteRemote,async(t,e,n)=>{if(this._joinInfo)try{await this._gateway.muteRemote(t,this._joinInfo.stringUid||this._joinInfo.uid),e()}catch(i){i.code===b.DISCONNECT_P2P?e():n(i)}else e()}),this._p2pChannel.on(yt.StateChange,(t,e)=>{e===he.Connected&&this._p2pChannel.republish()})}_handleP2PChannelEvents(){this._p2pChannel.on(yt.RequestMuteLocal,async(t,e,n)=>{if(this._joinInfo)try{await this._gateway.muteLocal(t,this._joinInfo.stringUid||this._joinInfo.uid),e()}catch(i){i.code===b.DISCONNECT_P2P?e():n(i)}else e()}),this._p2pChannel.on(yt.RequestUnmuteLocal,async(t,e,n)=>{if(this._joinInfo)try{await this._gateway.unmuteLocal(t,this._joinInfo.stringUid||this._joinInfo.uid),e()}catch(i){i.code===b.DISCONNECT_P2P?e():n(i)}else e()}),this._p2pChannel.on(yt.RequestRePublish,(t,e,n)=>{this.publish(t,!1).then(e).catch(n)}),this._p2pChannel.on(yt.RequestRePublishDataChannel,(t,e,n)=>{ot.all(t.map(async i=>{await this._p2pChannel.publishDataChannel([i]);const r={streamId:i.id,ordered:i.ordered,maxRetransmits:i.maxRetransmits,metadata:i.metadata,channelId:i._originDataChannelId};try{await this._gateway.publishDataChannel(this._uid,r,!0)}catch(o){if(o.code!==b.DISCONNECT_P2P)throw o}})).then(e).catch(n)}),this._p2pChannel.on(yt.RequestReSubscribe,async(t,e,n)=>{try{for(const{user:i,kind:r}of t)r===_t.VIDEO?await this.subscribe(i,"video"):await this.subscribe(i,"audio");e()}catch(i){n(i)}}),this._p2pChannel.on(yt.RequestUpload,(t,e)=>{this._gateway.upload(t,e)}),this._p2pChannel.on(yt.RequestUploadStats,t=>{this._gateway.uploadWRTCStats(t)}),this._p2pChannel.on(yt.MediaReconnectStart,t=>{this.safeEmit(Kt.MEDIA_RECONNECT_START,t)}),this._p2pChannel.on(yt.MediaReconnectEnd,t=>{this.safeEmit(Kt.MEDIA_RECONNECT_END,t)}),this._p2pChannel.on(yt.NeedSignalRTT,t=>{t(this._gateway.getSignalRTT())}),this._p2pChannel.on(yt.RequestRestartICE,async t=>{if(this._p2pChannel instanceof Ki)return;const e=await this._p2pChannel.restartICE(t),n=await e.next();if(n.done)return;const i=n.value;let r;try{r=await this._gateway.restartICE({iceParameters:i})}catch(s){return void e.throw(s)}const{iceParameters:o}=function(s){const a=s.iceParameters;return{iceParameters:{iceUfrag:a.iceUfrag,icePwd:a.icePwd}}}(r);await e.next({remoteIceParameters:o})}),this._p2pChannel.on(yt.RequestReconnect,async()=>{this._gateway.reconnect()}),this._p2pChannel.on(yt.RequestReconnectPC,async()=>{var t;const{iceParameters:e,dtlsParameters:n,rtpCapabilities:i}=await this._p2pChannel.startP2PConnection({turnServer:(t=this._joinInfo)===null||t===void 0?void 0:t.turnServer}),{gatewayEstablishParams:r,gatewayAddress:o}=await this._gateway.reconnectPC({iceParameters:e,dtlsParameters:n,rtpCapabilities:i}),{dtlsParameters:s,iceParameters:a,candidates:c,rtpCapabilities:d,setup:u,cname:l}=F0(r,o);await this._p2pChannel.connect(a,s,c,d,u,l),await this._p2pChannel.republish(),await this._p2pChannel.reSubscribe()}),this._p2pChannel.on(yt.RequestUnpublishForReconnectPC,async(t,e,n)=>{this._joinInfo&&this._uid!==void 0?(await this._gateway.unpublish(t,this._uid),e()):n()}),this._p2pChannel.on(yt.P2PLost,()=>{this.safeEmit(Kt.P2P_LOST,this.store.uid)}),this._p2pChannel.on(yt.UpdateVideoEncoder,t=>{t._encoderConfig&&this._gateway.setVideoProfile(t._encoderConfig)}),this._p2pChannel.on(yt.ConnectionTypeChange,t=>{this.safeEmit(Kt.IS_USING_CLOUD_PROXY,t)}),this._p2pChannel.on(yt.RequestLowStreamParameter,t=>{t(this._lowStreamParameter||{width:160,height:120,framerate:15,bitrate:50})}),this._p2pChannel.on(yt.QueryClientConnectionState,t=>{t(this.connectionState)})}getKeyMetrics(){return this.store.keyMetrics}async enableContentInspect(t){if(this.connectionState!=="CONNECTED"||!this._joinInfo)throw new U(b.INVALID_OPERATION,"[".concat(this._clientId,"] Client did not join channel"));if(this._inspect)throw new U(b.INVALID_OPERATION,"[".concat(this._clientId,"] Inspect content service already in connecting/connected state"));if(!t)throw new U(b.INVALID_PARAMS,"[".concat(this._clientId,"] inspectConfig is necessary"));if(!t.inspectType||!Array.isArray(t.inspectType))throw new U(b.INVALID_PARAMS,"[".concat(this._clientId,"] inspectConfig.inspectType is necessary and is an instance of Array."));{const e=[...new Set(t.inspectType)];e.forEach(n=>{var i;if(!it(i=["supervise","moderation"]).call(i,n))throw new U(b.INVALID_PARAMS,"[".concat(this._clientId,"] ").concat(n," is not a valid inspect type."))}),t.inspectType=e}if(t&&t.extraInfo&&t.extraInfo.length>1024)throw new U(b.INVALID_PARAMS,"[".concat(this._clientId,"] inspectConfig.extraInfo length cannot exceed 1024 bytes"));try{const e=new qf(t);this._inspect=e,this.handleVideoInspectEvents(this._inspect),await e.init({appId:this._joinInfo.appId,areaCode:"",cname:this._joinInfo.cname,sid:this._joinInfo.sid,token:this._joinInfo.token,uid:this._joinInfo.uid,cid:this._joinInfo.cid,vid:this._joinInfo.vid?Number(this._joinInfo.vid):0},dn)}catch(e){throw Array.isArray(e)?e[0]:e}}async disableContentInspect(){if(!this._inspect)throw new U(b.INVALID_OPERATION,"[".concat(this._clientId,"] inspectVideoContent not started"));try{this._inspect.close(),this._inspect=void 0}catch(t){throw Array.isArray(t)?t[0]:t}}async setImageModeration(t,e){if(hs(t,"enabled"),t){if(!e)throw new U(b.INVALID_PARAMS,"[".concat(this._clientId,"] config is necessary"));if(Se(e.interval,"interval",1e3,1/0),e&&e.extraInfo&&e.extraInfo.length>1024)throw new U(b.INVALID_PARAMS,"[".concat(this._clientId,"] config.extraInfo length cannot exceed 1024 bytes"));if(e&&e.vendor&&e.vendor.length>1024)throw new U(b.INVALID_PARAMS,"[".concat(this._clientId,"] config.vendor length cannot exceed 1024 bytes"));if(this.connectionState!=="CONNECTED"||!this._joinInfo)throw new U(b.INVALID_OPERATION,"[".concat(this._clientId,'] can not enable image moderation, not joined"'));try{if(this._moderation)return void this._moderation.updateConfig(e);const n=new XT(e);this._moderation=n,this.handleImageModerationEvents(this._moderation),await n.init({appId:this._joinInfo.appId,areaCode:"",cname:this._joinInfo.cname,sid:this._joinInfo.sid,token:this._joinInfo.token,uid:this._joinInfo.uid,cid:this._joinInfo.cid,vid:this._joinInfo.vid?Number(this._joinInfo.vid):0},dn)}catch(n){throw Array.isArray(n)?n[0]:n}}else{if(!this._moderation)throw new U(b.INVALID_OPERATION,"[".concat(this._clientId,"] image moderation not started"));try{this._moderation.close(),this._moderation.removeAllListeners(),this._moderation=void 0}catch(n){throw Array.isArray(n)?n[0]:n}}}setP2PTransport(t){if(function(e){yn(e,"transport",["default","auto","relay","sd-rtn"])}(t),this.mode!=="p2p")throw new U(b.INVALID_OPERATION,"only p2p mode can set p2pTransport");this.store.p2pTransport=t,E.info("[".concat(this._clientId,"] set client p2pTransport to ").concat(t))}handleImageModerationEvents(t){t.on(co.CONNECTION_STATE_CHANGE,(e,n)=>{if(this.safeEmit(Kt.IMAGE_MODERATION_CONNECTION_STATE_CHANGE,e,n),e===_r.CONNECTED){if(this.connectionState!=="CONNECTED")throw this.setImageModeration(!1),new U(b.OPERATION_ABORTED,"Image moderation was cancelled because it left the channel");t.inspectImage()}}),t.on(co.CLIENT_LOCAL_VIDEO_TRACK,e=>{e(this.localTracks.filter(n=>n.trackMediaType==="video")[0])})}handleVideoInspectEvents(t){t.on(xn.CONNECTION_STATE_CHANGE,(e,n)=>{if(this.safeEmit(Kt.CONTENT_INSPECT_CONNECTION_STATE_CHANGE,e,n),n===Mr.CONNECTED){if(this.connectionState!=="CONNECTED")return void this.safeEmit(Kt.CONTENT_INSPECT_ERROR,new U(b.OPERATION_ABORTED,"Content inspect was cancelled because it left the channel"));t.inspectImage()}}),t.on(xn.INSPECT_RESULT,(e,n)=>{var i;if((n==null?void 0:n.code)===b.INVALID_OPERATION&&this.connectionState==="DISCONNECTED")return E.debug("Stop inspect content because that has left channel"),this==null||(i=this._inspect)===null||i===void 0||i.close(),void(this._inspect=void 0);this.safeEmit(Kt.CONTENT_INSPECT_RESULT,e,n)}),t.on(xn.CLIENT_LOCAL_VIDEO_TRACK,e=>{e(this.localTracks.filter(n=>n.trackMediaType==="video")[0])})}getJoinChannelServiceRecords(){return E.debug("getJoinChannelServiceRecords"),this.store.joinChannelServiceRecords}async setPublishAudioFilterEnabled(t){hs(t,"enabled"),Re("ENABLE_PUBLISH_AUDIO_FILTER",t),this._joinInfo&&await this._gateway.setPublishAudioFilterEnabled(t)}_handleResetAddStream(t,e){switch(e){case"audio":t._audio_added_=!1,t._trust_audio_stream_added_state_=!0;break;case"video":t._video_added_=!1,t._trust_video_stream_added_state_=!0}}},nt(at.prototype,"leave",[uD],Object.getOwnPropertyDescriptor(at.prototype,"leave"),at.prototype),nt(at.prototype,"publish",[lD],Object.getOwnPropertyDescriptor(at.prototype,"publish"),at.prototype),nt(at.prototype,"unpublish",[hD],Object.getOwnPropertyDescriptor(at.prototype,"unpublish"),at.prototype),nt(at.prototype,"subscribe",[pD],Object.getOwnPropertyDescriptor(at.prototype,"subscribe"),at.prototype),nt(at.prototype,"presubscribe",[fD],Object.getOwnPropertyDescriptor(at.prototype,"presubscribe"),at.prototype),nt(at.prototype,"massSubscribe",[_D],Object.getOwnPropertyDescriptor(at.prototype,"massSubscribe"),at.prototype),nt(at.prototype,"unsubscribe",[ED],Object.getOwnPropertyDescriptor(at.prototype,"unsubscribe"),at.prototype),nt(at.prototype,"massUnsubscribe",[mD],Object.getOwnPropertyDescriptor(at.prototype,"massUnsubscribe"),at.prototype),nt(at.prototype,"setLowStreamParameter",[gD],Object.getOwnPropertyDescriptor(at.prototype,"setLowStreamParameter"),at.prototype),nt(at.prototype,"enableDualStream",[TD],Object.getOwnPropertyDescriptor(at.prototype,"enableDualStream"),at.prototype),nt(at.prototype,"disableDualStream",[SD],Object.getOwnPropertyDescriptor(at.prototype,"disableDualStream"),at.prototype),nt(at.prototype,"setClientRole",[RD],Object.getOwnPropertyDescriptor(at.prototype,"setClientRole"),at.prototype),nt(at.prototype,"setProxyServer",[CD],Object.getOwnPropertyDescriptor(at.prototype,"setProxyServer"),at.prototype),nt(at.prototype,"setTurnServer",[vD],Object.getOwnPropertyDescriptor(at.prototype,"setTurnServer"),at.prototype),nt(at.prototype,"setLicense",[yD],Object.getOwnPropertyDescriptor(at.prototype,"setLicense"),at.prototype),nt(at.prototype,"startProxyServer",[ID],Object.getOwnPropertyDescriptor(at.prototype,"startProxyServer"),at.prototype),nt(at.prototype,"stopProxyServer",[bD],Object.getOwnPropertyDescriptor(at.prototype,"stopProxyServer"),at.prototype),nt(at.prototype,"setLocalAccessPointsV2",[AD],Object.getOwnPropertyDescriptor(at.prototype,"setLocalAccessPointsV2"),at.prototype),nt(at.prototype,"setLocalAccessPoints",[wD],Object.getOwnPropertyDescriptor(at.prototype,"setLocalAccessPoints"),at.prototype),nt(at.prototype,"setRemoteDefaultVideoStreamType",[OD],Object.getOwnPropertyDescriptor(at.prototype,"setRemoteDefaultVideoStreamType"),at.prototype),nt(at.prototype,"setRemoteVideoStreamType",[ND],Object.getOwnPropertyDescriptor(at.prototype,"setRemoteVideoStreamType"),at.prototype),nt(at.prototype,"setStreamFallbackOption",[DD],Object.getOwnPropertyDescriptor(at.prototype,"setStreamFallbackOption"),at.prototype),nt(at.prototype,"setEncryptionConfig",[PD],Object.getOwnPropertyDescriptor(at.prototype,"setEncryptionConfig"),at.prototype),nt(at.prototype,"renewToken",[LD],Object.getOwnPropertyDescriptor(at.prototype,"renewToken"),at.prototype),nt(at.prototype,"enableAudioVolumeIndicator",[kD],Object.getOwnPropertyDescriptor(at.prototype,"enableAudioVolumeIndicator"),at.prototype),nt(at.prototype,"startLiveStreaming",[MD],Object.getOwnPropertyDescriptor(at.prototype,"startLiveStreaming"),at.prototype),nt(at.prototype,"setLiveTranscoding",[UD],Object.getOwnPropertyDescriptor(at.prototype,"setLiveTranscoding"),at.prototype),nt(at.prototype,"stopLiveStreaming",[xD],Object.getOwnPropertyDescriptor(at.prototype,"stopLiveStreaming"),at.prototype),nt(at.prototype,"addInjectStreamUrl",[VD],Object.getOwnPropertyDescriptor(at.prototype,"addInjectStreamUrl"),at.prototype),nt(at.prototype,"removeInjectStreamUrl",[FD],Object.getOwnPropertyDescriptor(at.prototype,"removeInjectStreamUrl"),at.prototype),nt(at.prototype,"startChannelMediaRelay",[jD],Object.getOwnPropertyDescriptor(at.prototype,"startChannelMediaRelay"),at.prototype),nt(at.prototype,"updateChannelMediaRelay",[BD],Object.getOwnPropertyDescriptor(at.prototype,"updateChannelMediaRelay"),at.prototype),nt(at.prototype,"stopChannelMediaRelay",[GD],Object.getOwnPropertyDescriptor(at.prototype,"stopChannelMediaRelay"),at.prototype),nt(at.prototype,"sendCustomReportMessage",[WD],Object.getOwnPropertyDescriptor(at.prototype,"sendCustomReportMessage"),at.prototype),nt(at.prototype,"pickSVCLayer",[HD],Object.getOwnPropertyDescriptor(at.prototype,"pickSVCLayer"),at.prototype),nt(at.prototype,"setRTMConfig",[KD],Object.getOwnPropertyDescriptor(at.prototype,"setRTMConfig"),at.prototype),nt(at.prototype,"enableContentInspect",[qD],Object.getOwnPropertyDescriptor(at.prototype,"enableContentInspect"),at.prototype),nt(at.prototype,"disableContentInspect",[YD],Object.getOwnPropertyDescriptor(at.prototype,"disableContentInspect"),at.prototype),nt(at.prototype,"setImageModeration",[zD],Object.getOwnPropertyDescriptor(at.prototype,"setImageModeration"),at.prototype),nt(at.prototype,"setP2PTransport",[JD],Object.getOwnPropertyDescriptor(at.prototype,"setP2PTransport"),at.prototype),nt(at.prototype,"getJoinChannelServiceRecords",[XD],Object.getOwnPropertyDescriptor(at.prototype,"getJoinChannelServiceRecords"),at.prototype),nt(at.prototype,"setPublishAudioFilterEnabled",[QD],Object.getOwnPropertyDescriptor(at.prototype,"setPublishAudioFilterEnabled"),at.prototype),at);class Ul{constructor(e,n){R(this,"id",0),R(this,"element",void 0),R(this,"peerPair",void 0),R(this,"context",void 0),R(this,"audioPlayerElement",void 0),R(this,"audioTrack",void 0),Ul.count+=1,this.id=Ul.count,this.element=e,this.context=n}initPeers(){this.peerPair=[new RTCPeerConnection,new RTCPeerConnection],this.peerPair[1].ontrack=e=>{const n=document.createElement("audio");n.srcObject=new MediaStream([e.track]),n.play(),this.audioPlayerElement=n}}async switchSdp(){if(!this.peerPair)return;const e=async(i,r)=>{const o=r==="offer"?await i.createOffer():await i.createAnswer();return await i.setLocalDescription(o),i.iceGatheringState==="complete"?i.localDescription:new ot(s=>{i.onicegatheringstatechange=()=>{i.iceGatheringState==="complete"&&s(i.localDescription)}})},n=async(i,r)=>await i.setRemoteDescription(r);try{const i=await e(this.peerPair[0],"offer");await n(this.peerPair[1],i);const r=await e(this.peerPair[1],"answer");await n(this.peerPair[0],r)}catch(i){throw new U(b.LOCAL_AEC_ERROR,i.toString()).print()}}async getTracksFromMediaElement(e){if(this.audioTrack)return this.audioTrack;let n;try{e instanceof HTMLVideoElement&&(e.captureStream?e.captureStream():e.mozCaptureStream()),n=this.context.createMediaStreamDestination(),this.context.createMediaElementSource(e).connect(n)}catch(r){throw new U(b.LOCAL_AEC_ERROR,r.toString()).print()}if(!n)throw new U(b.LOCAL_AEC_ERROR,"no dest node when local aec").print();const i=n.stream.getAudioTracks()[0];return this.audioTrack=i,i}getElement(){return this.element}async startEchoCancellation(){this.context.resume(),this.peerPair&&this.close(),this.initPeers();const e=this.element,n=await this.getTracksFromMediaElement(e);this.peerPair&&this.peerPair[0].addTrack(n),await this.switchSdp()}close(){E.debug("close echo cancellation unit, id is",this.id),this.audioPlayerElement&&this.audioPlayerElement.pause(),this.peerPair&&this.peerPair.forEach(e=>{e.close()}),this.peerPair=void 0,this.audioPlayerElement=void 0}}var $D,Zf;R(Ul,"count",0);const j3=window.AudioContext||window.webkitAudioContext,B3=new($D=Ct({report:Et}),nt((Zf=class{constructor(){R(this,"units",[]),R(this,"context",void 0)}processExternalMediaAEC(t){if(!this._doesEnvironmentNeedAEC())return E.debug("the system does not need to process local aec"),-1;this.context||(this.context=new j3);let e=this.units.find(n=>n&&n.getElement()===t);return e||(e=new Ul(t,this.context),this.units.push(e)),e.startEchoCancellation(),E.debug("start processing local audio echo cancellation, id is",e.id),e.id}_doesEnvironmentNeedAEC(){return Zt().name!==ue.SAFARI}}).prototype,"processExternalMediaAEC",[$D],Object.getOwnPropertyDescriptor(Zf.prototype,"processExternalMediaAEC"),Zf.prototype),Zf);function tP(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),n.push.apply(n,i)}return n}function eP(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?tP(Object(n),!0).forEach(function(i){R(t,i,n[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):tP(Object(n)).forEach(function(i){Object.defineProperty(t,i,Object.getOwnPropertyDescriptor(n,i))})}return t}const iS=window||document;function nP(t){let e=arguments.length>1&&arguments[1]!==void 0&&arguments[1];if(!iS)return;const n=gn._cspEventHandlerPointer;if(n&&e)return void console.error(n,e);const i=r=>{if(!(r&&r.blockedURI&&(gn.onSecurityPolicyViolation||gn.getListeners(Vo.SECURITY_POLICY_VIOLATION).length>0)))return;const o=r.blockedURI;N("CSP_DETECTED_HOSTNAME_LIST").some(s=>it(o).call(o,s))&&(gn.onSecurityPolicyViolation&&typeof gn.onSecurityPolicyViolation=="function"&&gn.onSecurityPolicyViolation(r),gn.getListeners(Vo.SECURITY_POLICY_VIOLATION).length>0&&gn.safeEmit(Vo.SECURITY_POLICY_VIOLATION,r))};n&&iS.removeEventListener("securitypolicyviolation",n),(e||t&&typeof t=="function"||gn.getListeners(Vo.SECURITY_POLICY_VIOLATION).length>0)&&iS.addEventListener("securitypolicyviolation",i),gn._cspEventHandlerPointer=i}Re("PROCESS_ID","process-".concat(be(8,""),"-").concat(be(4,""),"-").concat(be(4,""),"-").concat(be(4,""),"-").concat(be(12,""))),function(){let t;try{t=window.localStorage.getItem("websdk_ng_global_parameter")}catch(e){return void E.error("Error loading sdk config",e.message)}if(t)try{const e=JSON.parse(window.atob(t)),n=Date.now();E.debug("Loading global parameters from cache",e),Object.keys(e).forEach(i=>{if(Object.prototype.hasOwnProperty.call(Rn,i)){const{value:r,expires:o}=e[i];if(o&&o<=n)return;qs[i]=r,Rn[i]=r}})}catch(e){E.error("Error loading mutableParamsCache: ".concat(t),e.message)}}(),Array.isArray(qs.AREAS)&&qs.AREAS.length>0&&mg(qs.AREAS,!0);const iP=(t,e,n)=>{E.debug("setParameter key:".concat(t,", value:").concat(JSON.stringify(e))),Re(t,e,n)},gn=function(t){const e=new Ve,n=t,i={getListeners:e.getListeners.bind(e),on:(r,o)=>(function(s,a){s===Vo.SECURITY_POLICY_VIOLATION&&nP(a,!0)}(r,o),e.on.bind(e)(r,o)),addListener:e.addListener.bind(e),once:e.once.bind(e),off:e.off.bind(e),removeAllListeners:e.removeAllListeners.bind(e),emit:e.emit.bind(e),safeEmit:e.safeEmit.bind(e)};return eP(eP({},n),i)}({__TRACK_LIST__:Cd,VERSION:pr,BUILD:tg,ESM_BUNDLER:!1,ESM:!1,UMD:!0,DEV:!1,setParameter:iP,getParameter:N,getSupportedCodec:async function(){let t={audio:[],video:[]};try{let e=new RTCPeerConnection;const n=await async function(i){let r;return zt().supportUnifiedPlan?(i.addTransceiver("video",{direction:"recvonly"}),i.addTransceiver("audio",{direction:"recvonly"}),r=(await i.createOffer()).sdp):r=(await i.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0})).sdp,r}(e);if(!n)return t;e.close(),e=null,t=function(i){const r={video:[],audio:[]};return i.match(/ VP8/i)&&r.video.push("VP8"),i.match(/ VP9/i)&&r.video.push("VP9"),i.match(/ AV1/i)&&r.video.push("AV1"),i.match(/ H264/i)&&r.video.push("H264"),i.match(/ H265/i)&&r.video.push("H265"),i.match(/ opus/i)&&r.audio.push("OPUS"),i.match(/ PCMU/i)&&r.audio.push("PCMU"),i.match(/ PCMA/i)&&r.audio.push("PCMA"),i.match(/ G722/i)&&r.audio.push("G722"),r}(n)}catch(e){throw new U(b.CREATE_OFFER_FAILED,e.toString&&e.toString()).print()}return t},checkSystemRequirements:function(){const t=Et.reportApiInvoke(null,{name:_n.CHECK_SYSTEM_REQUIREMENTS,options:[],tag:Je.TRACER});let e=!1;try{const o=window.RTCPeerConnection,s=navigator.mediaDevices&&navigator.mediaDevices.getUserMedia,a=window.WebSocket;e=!!(o&&s&&a),e&&Gm()&&function(c){const d=Zt();return!(d.name!==ue.CHROME||!d.osVersion)&&Number(d.version)<c}(75)&&new o().close()}catch(o){return E.error("check system requirement failed: ",o),!1}let n=!1;const i=Zt();i.name===ue.CHROME&&Number(i.version)>=58&&(oo.engine.name!=="WebKit"||function(){const o=Zt();if(Dp()){if(o.os===bn.MAC_OS)return!0;if(o.os===bn.IOS){const s=oo.os.version&&oo.os.version.split(".");if(s&&Number(s[0])===14&&s[1]&&Number(s[1])>=3||s&&Number(s[0])>14)return!0}}return!1}())&&(n=!0),(i.name===ue.FIREFOX&&Number(i.version)>=56||i.name===ue.OPERA&&Number(i.version)>=45||i.name===ue.SAFARI&&Number(i.version)>=11||i.name==="WebKit"&&(Qn()||Lr())&&i.osVersion&&Number(i.osVersion.split(".")[0])>=11||FI()||Zt().name===ue.QQ)&&(n=!0),E.debug("checkSystemRequirements, api:",e,"browser",n);const r=e&&n;return t.onSuccess(r),r},getDevices:function(t){return rr.enumerateDevices(!0,!0,t)},getMicrophones:function(t){return rr.getRecordingDevices(t)},getCameras:function(t){return rr.getCamerasDevices(t)},getElectronScreenSources:Ow,getPlaybackDevices:function(t){return rr.getSpeakers(t)},createClient:function(){var t;let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{codec:"vp8",audioCodec:"opus",mode:"rtc"};const n=Et.reportApiInvoke(null,{name:_n.CREATE_CLIENT,options:[e],tag:Je.TRACER});try{(function(i){yn(i.codec,"config.codec",["vp8","vp9","av1","h264","h265"]),yn(i.mode,"config.mode",["rtc","live","p2p"]),i.audioCodec!==void 0&&yn(i.audioCodec,"config.audioCodec",["opus","pcmu","pcma","g722"]),i.proxyServer!==void 0&&Fn(i.proxyServer,"config.proxyServer",1,1e4),i.turnServer!==void 0&&JI(i.turnServer),i.httpRetryConfig!==void 0&&zI(i.httpRetryConfig),i.websocketRetryConfig!==void 0&&zI(i.websocketRetryConfig)})(e)}catch(i){throw n.onError(i),i}return(LI(16,0,!0)||kI(16,0,!0))&&(e.codec==="vp9"&&(e.codec="vp8",E.debug("browser not support vp9, force use vp8")),Re("UNSUPPORTED_VIDEO_CODEC",["vp9"])),e.audioCodec===void 0&&(e.audioCodec="opus"),n.onSuccess(),new F3(Rr(Rr({forceWaitGatewayResponse:!0},e),{},{role:it(t=["rtc","p2p"]).call(t,e.mode)?"host":e.role||"audience"}))},createCameraVideoTrack:async function(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};const e=N("CAMERA_CAPTURE_CONFIG"),n=Et.reportApiInvoke(null,{tag:Je.TRACER,name:_n.CREATE_CAM_VIDEO_TRACK,options:[Fe({},t),e]});e&&(t.encoderConfig=e);const i=yf(t),r=be(8,"track-cam-");let o=null;const s=t.encoderConfig==="720p_auto";E.info("start create camera video track with config",JSON.stringify(t),"trackId",r);try{o=(await ir({video:i},r)).getVideoTracks()[0]||null}catch(c){throw n.onError(c),c}if(!o){const c=new G(b.UNEXPECTED_ERROR,"can not find track in media stream");return n.onError(c),c.throw(E)}t.optimizationMode&&IT(r,o,t,Ho(t.encoderConfig));const a=new yT(o,t,i,t.scalabiltyMode?Sf(t.scalabiltyMode):{numSpatialLayers:1,numTemporalLayers:1},t.optimizationMode,r);return s&&a.startMonitorStats(),n.onSuccess(a.getTrackId()),E.info("create camera video success, trackId:",r),a},createCustomVideoTrack:function(t){const e=Et.reportApiInvoke(null,{tag:Je.TRACER,name:_n.CREATE_CUSTOM_VIDEO_TRACK,options:[t]}),n=new Ae(t.mediaStreamTrack,{width:t.width,height:t.height,frameRate:t.frameRate,bitrateMax:t.bitrateMax,bitrateMin:t.bitrateMin},t.scalabiltyMode?Sf(t.scalabiltyMode):{numSpatialLayers:1,numTemporalLayers:1},t.optimizationMode,be(8,"track-cus-"),[De.CUSTOM_TRACK]);return e.onSuccess(n.getTrackId()),E.info("create custom video track success with config",t,"trackId",n.getTrackId()),n},createScreenVideoTrack:async function(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"disable";const n=Et.reportApiInvoke(null,{tag:Je.TRACER,name:_n.CREATE_SCREEN_VIDEO_TRACK,options:[Fe({},t),e]}),i=t.encoderConfig==="720p_auto";t.encoderConfig?typeof t.encoderConfig=="string"||t.encoderConfig.width&&t.encoderConfig.height||(t.encoderConfig.width={max:1920},t.encoderConfig.height={max:1080}):t.encoderConfig="1080p_2";const r=function(l){const p={};l.screenSourceType&&(p.mediaSource=l.screenSourceType),l.extensionId&&Gs()&&(p.extensionId=l.extensionId);const{displaySurface:f,selfBrowserSurface:C,surfaceSwitching:m,systemAudio:g}=l;(jm(107)||DI(107)||MI(93))&&(f&&(yn(f,"displaySurface",["browser","window","monitor"]),p.displaySurface=f),C?(yn(C,"selfBrowserSurface",["exclude","include"]),p.selfBrowserSurface=C):p.selfBrowserSurface="include",m&&(yn(m,"surfaceSwitching",["exclude","include"]),p.surfaceSwitching=m)),(jm(105)||DI(105)||MI(91))&&g&&(yn(g,"systemAudio",["exclude","include"]),p.systemAudio=g),l.electronScreenSourceId&&(p.sourceId=l.electronScreenSourceId);const y=l.encoderConfig?pT(l.encoderConfig):null;return p.mandatory={chromeMediaSource:"desktop",maxWidth:y?y.width:void 0,maxHeight:y?y.height:void 0},y&&(y.frameRate&&(typeof y.frameRate=="number"?(p.mandatory.maxFrameRate=y.frameRate,p.mandatory.minFrameRate=y.frameRate):(p.mandatory.maxFrameRate=y.frameRate.max||y.frameRate.ideal||y.frameRate.exact||void 0,p.mandatory.minFrameRate=y.frameRate.min||y.frameRate.ideal||y.frameRate.exact||void 0),p.frameRate=y.frameRate),y.width&&(p.width=y.width),y.height&&(p.height=y.height)),p}(t),o=be(8,"track-scr-v-");let s=null,a=null;const c=zt();if(!c.supportShareAudio&&e==="enable"){const l=new G(b.NOT_SUPPORTED,"your browser or platform is not support share-screen with audio");return n.onError(l),l.throw(E)}E.info("start create screen video track with config",t,"withAudio",e,"trackId",o);try{const l=await ir({screen:r,screenAudio:e==="auto"?c.supportShareAudio:e==="enable"},o);s=l.getVideoTracks()[0]||null,a=l.getAudioTracks()[0]||null}catch(l){throw n.onError(l),l}if(!s){const l=new G(b.UNEXPECTED_ERROR,"can not find track in media stream");return n.onError(l),l.throw(E)}if(!a&&e==="enable"){s&&s.stop();const l=new G(b.SHARE_AUDIO_NOT_ALLOWED);return n.onError(l),l.throw(E)}t.optimizationMode||(t.optimizationMode="detail"),t.optimizationMode&&(IT(o,s,t,t.encoderConfig&&pT(t.encoderConfig)||void 0),t.encoderConfig&&typeof t.encoderConfig!="string"&&(t.encoderConfig.bitrateMin=t.encoderConfig.bitrateMax));const d=new Ae(s,t.encoderConfig?pT(t.encoderConfig):{},t.scalabiltyMode?Sf(t.scalabiltyMode):{numSpatialLayers:1,numTemporalLayers:1},t.optimizationMode,o,[De.SCREEN_TRACK]);if(i&&d.startMonitorStats(),!a)return n.onSuccess(d.getTrackId()),E.info("create screen video track success","video:",d.getTrackId()),d;const u=new Qe(a,void 0,be(8,"track-scr-a-"),!1);return n.onSuccess([d.getTrackId(),u.getTrackId()]),E.info("create screen video track success","video:",d.getTrackId(),"audio:",u.getTrackId()),[d,u]},createMicrophoneAndCameraTracks:async function(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};const n=N("CAMERA_CAPTURE_CONFIG"),i=Et.reportApiInvoke(null,{tag:Je.TRACER,name:_n.CREATE_MIC_AND_CAM_TRACKS,options:[t,e,n]});n&&(e.encoderConfig=n);const r=e.encoderConfig==="720p_auto",o=yf(e),s=Fw(t),a=be(8,"track-mic-"),c=be(8,"track-cam-");let d=null,u=null;E.info("start create camera video track(".concat(c,") and microphone audio track(").concat(a,") with config, audio: ").concat(JSON.stringify(t),", video: ").concat(JSON.stringify(e)));try{const f=await ir({audio:s,video:o},"".concat(a,"-").concat(c));d=f.getAudioTracks()[0],u=f.getVideoTracks()[0]}catch(f){throw i.onError(f),f}if(!d||!u){const f=new G(b.UNEXPECTED_ERROR,"can not find tracks in media stream");return i.onError(f),f.throw(E)}e.optimizationMode&&IT(c,u,e,Ho(e.encoderConfig));const l=new If(d,t,s,a),p=new yT(u,e,o,e.scalabiltyMode?Sf(e.scalabiltyMode):{numSpatialLayers:1,numTemporalLayers:1},e.optimizationMode,c);return r&&p.startMonitorStats(),i.onSuccess([l.getTrackId(),p.getTrackId()]),E.info("create camera video track(".concat(c,") and microphone audio track(").concat(a,") success")),[l,p]},createMicrophoneAudioTrack:async function(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};const e=Et.reportApiInvoke(null,{tag:Je.TRACER,name:_n.CREATE_MIC_AUDIO_TRACK,options:[t]}),n=Fw(t),i=be(8,"track-mic-");let r=null;E.info("start create microphone audio track with config",JSON.stringify(t),"trackId",i);try{r=(await ir({audio:n},i)).getAudioTracks()[0]||null}catch(s){throw e.onError(s),s}if(!r){const s=new G(b.UNEXPECTED_ERROR,"can not find track in media stream");return e.onError(s),s.throw(E)}const o=new If(r,t,n,i);return e.onSuccess(o.getTrackId()),E.info("create microphone audio track success, trackId:",i),o},createCustomAudioTrack:function(t){const e=Et.reportApiInvoke(null,{tag:Je.TRACER,name:_n.CREATE_CUSTOM_AUDIO_TRACK,options:[t]}),n=new Qe(t.mediaStreamTrack,t.encoderConfig?Rf(t.encoderConfig):{},be(8,"track-cus-"),!1);return E.info("create custom audio track success with config",t,"trackId",n.getTrackId()),e.onSuccess(n.getTrackId()),n},createBufferSourceAudioTrack:async function(t){var e;const{cacheOnlineFile:n,encoderConfig:i}=t;let{source:r}=t;const o={source:r instanceof AudioBuffer?"AudioBuffer":r instanceof File?(e=File.name)!==null&&e!==void 0?e:"File":r,cacheOnlineFile:n,encoderConfig:i},s=Et.reportApiInvoke(null,{tag:Je.TRACER,name:_n.CREATE_BUFFER_AUDIO_TRACK,options:[o]});if(N("DISABLE_WEBAUDIO"))throw new G(b.NOT_SUPPORTED,"can not create BufferSourceAudioTrack when WebAudio disabled");const a=be(8,"track-buf-");E.info("start create buffer source audio track with config",JSON.stringify(o),"trackId",a);const c=r;if(!(r instanceof AudioBuffer))try{r=await async function(l,p){let f=null;if(typeof l=="string"){const m=IO.get(l);if(m)return E.debug("use cached audio resource: ",l),m;try{f=(await so(()=>yi.get(l,{responseType:"arraybuffer"}),void 0,void 0,{maxRetryCount:3})).data}catch(g){throw new G(b.FETCH_AUDIO_FILE_FAILED,g.toString())}}else f=await new ot((g,y)=>{const A=new FileReader;A.onload=k=>{k.target?g(k.target.result):y(new G(b.READ_LOCAL_AUDIO_FILE_ERROR))},A.onerror=()=>{y(new G(b.READ_LOCAL_AUDIO_FILE_ERROR))},A.readAsArrayBuffer(l)});const C=await function(m){const g=Ad();return new ot((y,A)=>{g.decodeAudioData(m,k=>{y(k)},k=>{A(new G(b.DECODE_AUDIO_FILE_FAILED,k.toString()))})})}(f);return typeof l=="string"&&p&&IO.set(l,C),C}(r,n)}catch(l){return s.onError(l),l.throw(E)}const d=new MW(r),u=new kW(c,d,i?Rf(i):{},a);return E.info("create buffer source audio track success, trackId:",a),s.onSuccess(u.getTrackId()),u},setAppType:function(t){if(E.debug("setAppType: ".concat(t)),!(Number.isInteger(t)&&t>=0))throw E.debug("Invalid appType"),new U(b.INVALID_PARAMS,"invalid app type",t);Re("APP_TYPE",Math.floor(t))},setLogLevel:function(t){E.setLogLevel(t)},enableLogUpload:function(){N("USE_NEW_LOG")?Re("UPLOAD_LOG",!0):E.enableLogUpload()},disableLogUpload:function(){N("USE_NEW_LOG")?Re("UPLOAD_LOG",!1):E.disableLogUpload()},createChannelMediaRelayConfiguration:function(){return new uN},checkAudioTrackIsActive:async function(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:5e3;const n=Et.reportApiInvoke(null,{tag:Je.TRACER,name:_n.CHECK_AUDIO_TRACK_IS_ACTIVE,options:[e]});if(!(t instanceof Qe||t instanceof Nd)){const c=new U(b.INVALID_TRACK,"the parameter is not a audio track");return n.onError(c),c.throw()}e&&e<1e3&&(e=1e3);const i=t instanceof Qe?t.getTrackLabel():"remote_track",r=t.getVolumeLevel();let o=r,s=r;const a=Date.now();return new ot(c=>{const d=setInterval(()=>{const u=t.getVolumeLevel();o=u>o?u:o,s=u<s?u:s;const l=o-s>1e-4,p=Date.now()-a;if(l||p>e){clearInterval(d);const f=l,C={duration:p,deviceLabel:i,maxVolumeLevel:o,result:f};E.info("[track-".concat(t.getTrackId(),"] check audio track active completed. ").concat(JSON.stringify(C))),n.onSuccess(C),c(f)}},200)})},checkVideoTrackIsActive:async function(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:5e3;const n=Et.reportApiInvoke(null,{tag:Je.TRACER,name:_n.CHECK_VIDEO_TRACK_IS_ACTIVE,options:[e]});if(!(t instanceof Ae||t instanceof Od)){const l=new U(b.INVALID_TRACK,"the parameter is not a video track");return n.onError(l),l.throw()}e&&e<1e3&&(e=1e3);const i=t instanceof Ae?t.getTrackLabel():"remote_track",r=t.getMediaStreamTrack(!0),o=document.createElement("video");o.style.width="1px",o.style.height="1px",o.setAttribute("muted",""),o.muted=!0,o.setAttribute("playsinline",""),o.controls=!1,(An()||Dp())&&(o.style.opacity="0.01",o.style.position="fixed",o.style.left="0",o.style.top="0",document.body.appendChild(o)),o.srcObject=new MediaStream([r]),o.play();const s=document.createElement("canvas");s.width=160,s.height=120;let a=0,c=0;try{const l=Date.now();a=await function(p,f,C,m){let g,y=0,A=null;return new ot((k,M)=>{function V(){y>m&&g&&(g(),k(y));const B=C.getContext("2d");if(!B){const J=new U(b.UNEXPECTED_ERROR,"can not get canvas 2d context.");return E.error(J.toString()),void M(J)}B.drawImage(p,0,0,160,120);const K=B.getImageData(0,0,C.width,C.height),Y=Math.floor(K.data.length/3);if(A){for(let J=0;J<Y;J+=3)if(K.data[J]!==A[J])return y+=1,void(A=K.data);A=K.data}else A=K.data}setTimeout(()=>{g&&(g(),k(y))},f),g=gT(()=>{V()},30)})}(o,e,s,4),c=Date.now()-l}catch(l){throw n.onError(l),l}M3===ue.SAFARI&&(o.pause(),o.remove()),o.srcObject=null;const d=a>4,u={duration:c,changedPicNum:a,deviceLabel:i,result:d};return E.info("[track-".concat(t.getTrackId(),"] check video track active completed. ").concat(JSON.stringify(u))),n.onSuccess(u),d},setArea:mg,audioElementPlayCenter:bi,resumeAudioContext:function(){bi.autoResumeAfterInterruption(!0)},processExternalMediaAEC:function(t){B3.processExternalMediaAEC(t)},registerExtensions:function(t){const e=N("PLUGIN_INFO")||[];t.forEach(n=>{"name"in n&&!it(e).call(e,n.name)&&e.push(n.name);const i=n;i.__registered__=!0,i.logger.hookLog=E.extLog,i.reporter.hookApiInvoke=Et.extApiInvoke,i.parameters&&Object.keys(i.parameters).forEach(r=>{i.parameters[r]=N(r)})}),iP("PLUGIN_INFO",e)},ChannelMediaRelayError:rd,ChannelMediaRelayEvent:fs,ChannelMediaRelayState:Di,RemoteStreamFallbackType:AW,RemoteStreamType:bW,ConnectionDisconnectedReason:Ht,AudienceLatencyLevelType:FF,AREAS:re,preload:async function(t,e,n,i){return iD(t,e,n,i)}});return Object.defineProperties(gn,{onAudioAutoplayFailed:{get:()=>or.onAudioAutoplayFailed,set:t=>{or.onAudioAutoplayFailed=t}},onAutoplayFailed:{get:()=>or.onAutoplayFailed,set:t=>{or.onAutoplayFailed=t}},_onSecurityPolicyViolation:{value:void 0,writable:!0},_cspEventHandlerPointer:{value:void 0,writable:!0},onSecurityPolicyViolation:{get:()=>gn._onSecurityPolicyViolation,set(t){gn._onSecurityPolicyViolation=t,nP(t)}},__CLIENT_LIST__:{get:()=>N("SHOW_GLOBAL_CLIENT_LIST")?Ys:[]}}),rr.on(tc.CAMERA_DEVICE_CHANGED,t=>{E.info("camera device changed",JSON.stringify(t)),gn.onCameraChanged&&gn.onCameraChanged(t),gn.safeEmit(Vo.CAMERA_CHANGED,t)}),rr.on(tc.RECORDING_DEVICE_CHANGED,t=>{E.info("microphone device changed",JSON.stringify(t)),gn.onMicrophoneChanged&&gn.onMicrophoneChanged(t),gn.safeEmit(Vo.MICROPHONE_CHANGED,t)}),rr.on(tc.PLAYOUT_DEVICE_CHANGED,t=>{E.debug("playout device changed",JSON.stringify(t)),gn.onPlaybackDeviceChanged&&gn.onPlaybackDeviceChanged(t),gn.safeEmit(Vo.PLAYBACK_DEVICE_CHANGED,t)}),bi.onAutoplayFailed=()=>{E.info("detect audio element autoplay failed"),or.onAudioAutoplayFailed&&or.onAudioAutoplayFailed()},Ee.on("autoplay-failed",()=>{E.info("detect webaudio autoplay failed"),or.onAudioAutoplayFailed&&or.onAudioAutoplayFailed(),gn.safeEmit(Vo.AUTOPLAY_FAILED)}),Ee.on(jn.STATE_CHANGE,(t,e)=>{E.info("audio context state changed: ".concat(e," => ").concat(t)),gn.onAudioContextStateChanged&&gn.onAudioContextStateChanged(t,e),gn.safeEmit(Vo.AUDIO_CONTEXT_STATE_CHANGED,t,e)}),Xe.on(Ma.NETWORK_STATE_CHANGE,(t,e)=>{E.info("[network-indicator] network state changed, ".concat(e," => ").concat(t))}),window&&(window.__ARTC__=gn),gn})})(aP);var sS=K3(aP.exports),uP={exports:{}};/*!
 * jQuery JavaScript Library v3.7.1
 * https://jquery.com/
 *
 * Copyright OpenJS Foundation and other contributors
 * Released under the MIT license
 * https://jquery.org/license
 *
 * Date: 2023-08-28T13:37Z
 */(function(Qt){(function(gt,ge){Qt.exports=gt.document?ge(gt,!0):function(Ut){if(!Ut.document)throw new Error("jQuery requires a window with a document");return ge(Ut)}})(typeof window!="undefined"?window:Fl,function(gt,ge){var Ut=[],Dt=Object.getPrototypeOf,Pt=Ut.slice,wi=Ut.flat?function(h){return Ut.flat.call(h)}:function(h){return Ut.concat.apply([],h)},ma=Ut.push,vr=Ut.indexOf,bs={},Hl=bs.toString,Ge=bs.hasOwnProperty,Jn=Ge.toString,uc=Jn.call(Object),Lt={},_e=function(_){return typeof _=="function"&&typeof _.nodeType!="number"&&typeof _.item!="function"},Zo=function(_){return _!=null&&_===_.window},ce=gt.document,Kl={type:!0,src:!0,nonce:!0,noModule:!0};function lc(h,_,S){S=S||ce;var v,w,O=S.createElement("script");if(O.text=h,_)for(v in Kl)w=_[v]||_.getAttribute&&_.getAttribute(v),w&&O.setAttribute(v,w);S.head.appendChild(O).parentNode.removeChild(O)}function $o(h){return h==null?h+"":typeof h=="object"||typeof h=="function"?bs[Hl.call(h)]||"object":typeof h}var ql="3.7.1",i_=/HTML$/i,I=function(h,_){return new I.fn.init(h,_)};I.fn=I.prototype={jquery:ql,constructor:I,length:0,toArray:function(){return Pt.call(this)},get:function(h){return h==null?Pt.call(this):h<0?this[h+this.length]:this[h]},pushStack:function(h){var _=I.merge(this.constructor(),h);return _.prevObject=this,_},each:function(h){return I.each(this,h)},map:function(h){return this.pushStack(I.map(this,function(_,S){return h.call(_,S,_)}))},slice:function(){return this.pushStack(Pt.apply(this,arguments))},first:function(){return this.eq(0)},last:function(){return this.eq(-1)},even:function(){return this.pushStack(I.grep(this,function(h,_){return(_+1)%2}))},odd:function(){return this.pushStack(I.grep(this,function(h,_){return _%2}))},eq:function(h){var _=this.length,S=+h+(h<0?_:0);return this.pushStack(S>=0&&S<_?[this[S]]:[])},end:function(){return this.prevObject||this.constructor()},push:ma,sort:Ut.sort,splice:Ut.splice},I.extend=I.fn.extend=function(){var h,_,S,v,w,O,P=arguments[0]||{},j=1,F=arguments.length,q=!1;for(typeof P=="boolean"&&(q=P,P=arguments[j]||{},j++),typeof P!="object"&&!_e(P)&&(P={}),j===F&&(P=this,j--);j<F;j++)if((h=arguments[j])!=null)for(_ in h)v=h[_],!(_==="__proto__"||P===v)&&(q&&v&&(I.isPlainObject(v)||(w=Array.isArray(v)))?(S=P[_],w&&!Array.isArray(S)?O=[]:!w&&!I.isPlainObject(S)?O={}:O=S,w=!1,P[_]=I.extend(q,O,v)):v!==void 0&&(P[_]=v));return P},I.extend({expando:"jQuery"+(ql+Math.random()).replace(/\D/g,""),isReady:!0,error:function(h){throw new Error(h)},noop:function(){},isPlainObject:function(h){var _,S;return!h||Hl.call(h)!=="[object Object]"?!1:(_=Dt(h),_?(S=Ge.call(_,"constructor")&&_.constructor,typeof S=="function"&&Jn.call(S)===uc):!0)},isEmptyObject:function(h){var _;for(_ in h)return!1;return!0},globalEval:function(h,_,S){lc(h,{nonce:_&&_.nonce},S)},each:function(h,_){var S,v=0;if(Wd(h))for(S=h.length;v<S&&_.call(h[v],v,h[v])!==!1;v++);else for(v in h)if(_.call(h[v],v,h[v])===!1)break;return h},text:function(h){var _,S="",v=0,w=h.nodeType;if(!w)for(;_=h[v++];)S+=I.text(_);return w===1||w===11?h.textContent:w===9?h.documentElement.textContent:w===3||w===4?h.nodeValue:S},makeArray:function(h,_){var S=_||[];return h!=null&&(Wd(Object(h))?I.merge(S,typeof h=="string"?[h]:h):ma.call(S,h)),S},inArray:function(h,_,S){return _==null?-1:vr.call(_,h,S)},isXMLDoc:function(h){var _=h&&h.namespaceURI,S=h&&(h.ownerDocument||h).documentElement;return!i_.test(_||S&&S.nodeName||"HTML")},merge:function(h,_){for(var S=+_.length,v=0,w=h.length;v<S;v++)h[w++]=_[v];return h.length=w,h},grep:function(h,_,S){for(var v,w=[],O=0,P=h.length,j=!S;O<P;O++)v=!_(h[O],O),v!==j&&w.push(h[O]);return w},map:function(h,_,S){var v,w,O=0,P=[];if(Wd(h))for(v=h.length;O<v;O++)w=_(h[O],O,S),w!=null&&P.push(w);else for(O in h)w=_(h[O],O,S),w!=null&&P.push(w);return wi(P)},guid:1,support:Lt}),typeof Symbol=="function"&&(I.fn[Symbol.iterator]=Ut[Symbol.iterator]),I.each("Boolean Number String Function Array Date RegExp Object Error Symbol".split(" "),function(h,_){bs["[object "+_+"]"]=_.toLowerCase()});function Wd(h){var _=!!h&&"length"in h&&h.length,S=$o(h);return _e(h)||Zo(h)?!1:S==="array"||_===0||typeof _=="number"&&_>0&&_-1 in h}function Sn(h,_){return h.nodeName&&h.nodeName.toLowerCase()===_.toLowerCase()}var ga=Ut.pop,Hd=Ut.sort,hc=Ut.splice,tn="[\\x20\\t\\r\\n\\f]",pn=new RegExp("^"+tn+"+|((?:^|[^\\\\])(?:\\\\.)*)"+tn+"+$","g");I.contains=function(h,_){var S=_&&_.parentNode;return h===S||!!(S&&S.nodeType===1&&(h.contains?h.contains(S):h.compareDocumentPosition&&h.compareDocumentPosition(S)&16))};var Ta=/([\0-\x1f\x7f]|^-?\d)|^-$|[^\x80-\uFFFF\w-]/g;function Vi(h,_){return _?h==="\0"?"\uFFFD":h.slice(0,-1)+"\\"+h.charCodeAt(h.length-1).toString(16)+" ":"\\"+h}I.escapeSelector=function(h){return(h+"").replace(Ta,Vi)};var Zr=ce,As=ma;(function(){var h,_,S,v,w,O=As,P,j,F,q,rt,dt=I.expando,$=0,St=0,ie=wc(),Ce=wc(),Te=wc(),Pn=wc(),Wn=function(x,H){return x===H&&(w=!0),0},Ar="checked|selected|async|autofocus|autoplay|controls|defer|disabled|hidden|ismap|loop|multiple|open|readonly|required|scoped",$t="(?:\\\\[\\da-fA-F]{1,6}"+tn+"?|\\\\[^\\r\\n\\f]|[\\w-]|[^\0-\\x7f])+",Le="\\["+tn+"*("+$t+")(?:"+tn+"*([*^$|!~]?=)"+tn+`*(?:'((?:\\\\.|[^\\\\'])*)'|"((?:\\\\.|[^\\\\"])*)"|(`+$t+"))|)"+tn+"*\\]",as=":("+$t+`)(?:\\((('((?:\\\\.|[^\\\\'])*)'|"((?:\\\\.|[^\\\\"])*)")|((?:\\\\.|[^\\\\()[\\]]|`+Le+")*)|.*)\\)|)",xe=new RegExp(tn+"+","g"),Ln=new RegExp("^"+tn+"*,"+tn+"*"),cs=new RegExp("^"+tn+"*([>+~]|"+tn+")"+tn+"*"),pu=new RegExp(tn+"|>"),wr=new RegExp(as),Ia=new RegExp("^"+$t+"$"),zi={ID:new RegExp("^#("+$t+")"),CLASS:new RegExp("^\\.("+$t+")"),TAG:new RegExp("^("+$t+"|[*])"),ATTR:new RegExp("^"+Le),PSEUDO:new RegExp("^"+as),CHILD:new RegExp("^:(only|first|last|nth|nth-last)-(child|of-type)(?:\\("+tn+"*(even|odd|(([+-]|)(\\d*)n|)"+tn+"*(?:([+-]|)"+tn+"*(\\d+)|))"+tn+"*\\)|)","i"),bool:new RegExp("^(?:"+Ar+")$","i"),needsContext:new RegExp("^"+tn+"*[>+~]|:(even|odd|eq|gt|lt|nth|first|last)(?:\\("+tn+"*((?:-\\d)?\\d*)"+tn+"*\\)|)(?=[^-]|$)","i")},Ao=/^(?:input|select|textarea|button)$/i,wo=/^h\d$/i,ji=/^(?:#([\w-]+)|(\w+)|\.([\w-]+))$/,fu=/[+~]/,ri=new RegExp("\\\\[\\da-fA-F]{1,6}"+tn+"?|\\\\([^\\r\\n\\f])","g"),no=function(x,H){var Z="0x"+x.slice(1)-65536;return H||(Z<0?String.fromCharCode(Z+65536):String.fromCharCode(Z>>10|55296,Z&1023|56320))},b_=function(){Oo()},A_=Nc(function(x){return x.disabled===!0&&Sn(x,"fieldset")},{dir:"parentNode",next:"legend"});function Ih(){try{return P.activeElement}catch{}}try{O.apply(Ut=Pt.call(Zr.childNodes),Zr.childNodes),Ut[Zr.childNodes.length].nodeType}catch{O={apply:function(H,Z){As.apply(H,Pt.call(Z))},call:function(H){As.apply(H,Pt.call(arguments,1))}}}function Ye(x,H,Z,et){var ct,vt,bt,xt,At,Oe,te,ae=H&&H.ownerDocument,ve=H?H.nodeType:9;if(Z=Z||[],typeof x!="string"||!x||ve!==1&&ve!==9&&ve!==11)return Z;if(!et&&(Oo(H),H=H||P,F)){if(ve!==11&&(At=ji.exec(x)))if(ct=At[1]){if(ve===9)if(bt=H.getElementById(ct)){if(bt.id===ct)return O.call(Z,bt),Z}else return Z;else if(ae&&(bt=ae.getElementById(ct))&&Ye.contains(H,bt)&&bt.id===ct)return O.call(Z,bt),Z}else{if(At[2])return O.apply(Z,H.getElementsByTagName(x)),Z;if((ct=At[3])&&H.getElementsByClassName)return O.apply(Z,H.getElementsByClassName(ct)),Z}if(!Pn[x+" "]&&(!q||!q.test(x))){if(te=x,ae=H,ve===1&&(pu.test(x)||cs.test(x))){for(ae=fu.test(x)&&Oc(H.parentNode)||H,(ae!=H||!Lt.scope)&&((xt=H.getAttribute("id"))?xt=I.escapeSelector(xt):H.setAttribute("id",xt=dt)),Oe=Ps(x),vt=Oe.length;vt--;)Oe[vt]=(xt?"#"+xt:":scope")+" "+Ls(Oe[vt]);te=Oe.join(",")}try{return O.apply(Z,ae.querySelectorAll(te)),Z}catch{Pn(x,!0)}finally{xt===dt&&H.removeAttribute("id")}}}return wh(x.replace(pn,"$1"),H,Z,et)}function wc(){var x=[];function H(Z,et){return x.push(Z+" ")>_.cacheLength&&delete H[x.shift()],H[Z+" "]=et}return H}function lr(x){return x[dt]=!0,x}function oi(x){var H=P.createElement("fieldset");try{return!!x(H)}catch{return!1}finally{H.parentNode&&H.parentNode.removeChild(H),H=null}}function w_(x){return function(H){return Sn(H,"input")&&H.type===x}}function O_(x){return function(H){return(Sn(H,"input")||Sn(H,"button"))&&H.type===x}}function bh(x){return function(H){return"form"in H?H.parentNode&&H.disabled===!1?"label"in H?"label"in H.parentNode?H.parentNode.disabled===x:H.disabled===x:H.isDisabled===x||H.isDisabled!==!x&&A_(H)===x:H.disabled===x:"label"in H?H.disabled===x:!1}}function ds(x){return lr(function(H){return H=+H,lr(function(Z,et){for(var ct,vt=x([],Z.length,H),bt=vt.length;bt--;)Z[ct=vt[bt]]&&(Z[ct]=!(et[ct]=Z[ct]))})})}function Oc(x){return x&&typeof x.getElementsByTagName!="undefined"&&x}function Oo(x){var H,Z=x?x.ownerDocument||x:Zr;return Z==P||Z.nodeType!==9||!Z.documentElement||(P=Z,j=P.documentElement,F=!I.isXMLDoc(P),rt=j.matches||j.webkitMatchesSelector||j.msMatchesSelector,j.msMatchesSelector&&Zr!=P&&(H=P.defaultView)&&H.top!==H&&H.addEventListener("unload",b_),Lt.getById=oi(function(et){return j.appendChild(et).id=I.expando,!P.getElementsByName||!P.getElementsByName(I.expando).length}),Lt.disconnectedMatch=oi(function(et){return rt.call(et,"*")}),Lt.scope=oi(function(){return P.querySelectorAll(":scope")}),Lt.cssHas=oi(function(){try{return P.querySelector(":has(*,:jqfake)"),!1}catch{return!0}}),Lt.getById?(_.filter.ID=function(et){var ct=et.replace(ri,no);return function(vt){return vt.getAttribute("id")===ct}},_.find.ID=function(et,ct){if(typeof ct.getElementById!="undefined"&&F){var vt=ct.getElementById(et);return vt?[vt]:[]}}):(_.filter.ID=function(et){var ct=et.replace(ri,no);return function(vt){var bt=typeof vt.getAttributeNode!="undefined"&&vt.getAttributeNode("id");return bt&&bt.value===ct}},_.find.ID=function(et,ct){if(typeof ct.getElementById!="undefined"&&F){var vt,bt,xt,At=ct.getElementById(et);if(At){if(vt=At.getAttributeNode("id"),vt&&vt.value===et)return[At];for(xt=ct.getElementsByName(et),bt=0;At=xt[bt++];)if(vt=At.getAttributeNode("id"),vt&&vt.value===et)return[At]}return[]}}),_.find.TAG=function(et,ct){return typeof ct.getElementsByTagName!="undefined"?ct.getElementsByTagName(et):ct.querySelectorAll(et)},_.find.CLASS=function(et,ct){if(typeof ct.getElementsByClassName!="undefined"&&F)return ct.getElementsByClassName(et)},q=[],oi(function(et){var ct;j.appendChild(et).innerHTML="<a id='"+dt+"' href='' disabled='disabled'></a><select id='"+dt+"-\r\\' disabled='disabled'><option selected=''></option></select>",et.querySelectorAll("[selected]").length||q.push("\\["+tn+"*(?:value|"+Ar+")"),et.querySelectorAll("[id~="+dt+"-]").length||q.push("~="),et.querySelectorAll("a#"+dt+"+*").length||q.push(".#.+[+~]"),et.querySelectorAll(":checked").length||q.push(":checked"),ct=P.createElement("input"),ct.setAttribute("type","hidden"),et.appendChild(ct).setAttribute("name","D"),j.appendChild(et).disabled=!0,et.querySelectorAll(":disabled").length!==2&&q.push(":enabled",":disabled"),ct=P.createElement("input"),ct.setAttribute("name",""),et.appendChild(ct),et.querySelectorAll("[name='']").length||q.push("\\["+tn+"*name"+tn+"*="+tn+`*(?:''|"")`)}),Lt.cssHas||q.push(":has"),q=q.length&&new RegExp(q.join("|")),Wn=function(et,ct){if(et===ct)return w=!0,0;var vt=!et.compareDocumentPosition-!ct.compareDocumentPosition;return vt||(vt=(et.ownerDocument||et)==(ct.ownerDocument||ct)?et.compareDocumentPosition(ct):1,vt&1||!Lt.sortDetached&&ct.compareDocumentPosition(et)===vt?et===P||et.ownerDocument==Zr&&Ye.contains(Zr,et)?-1:ct===P||ct.ownerDocument==Zr&&Ye.contains(Zr,ct)?1:v?vr.call(v,et)-vr.call(v,ct):0:vt&4?-1:1)}),P}Ye.matches=function(x,H){return Ye(x,null,null,H)},Ye.matchesSelector=function(x,H){if(Oo(x),F&&!Pn[H+" "]&&(!q||!q.test(H)))try{var Z=rt.call(x,H);if(Z||Lt.disconnectedMatch||x.document&&x.document.nodeType!==11)return Z}catch{Pn(H,!0)}return Ye(H,P,null,[x]).length>0},Ye.contains=function(x,H){return(x.ownerDocument||x)!=P&&Oo(x),I.contains(x,H)},Ye.attr=function(x,H){(x.ownerDocument||x)!=P&&Oo(x);var Z=_.attrHandle[H.toLowerCase()],et=Z&&Ge.call(_.attrHandle,H.toLowerCase())?Z(x,H,!F):void 0;return et!==void 0?et:x.getAttribute(H)},Ye.error=function(x){throw new Error("Syntax error, unrecognized expression: "+x)},I.uniqueSort=function(x){var H,Z=[],et=0,ct=0;if(w=!Lt.sortStable,v=!Lt.sortStable&&Pt.call(x,0),Hd.call(x,Wn),w){for(;H=x[ct++];)H===x[ct]&&(et=Z.push(ct));for(;et--;)hc.call(x,Z[et],1)}return v=null,x},I.fn.uniqueSort=function(){return this.pushStack(I.uniqueSort(Pt.apply(this)))},_=I.expr={cacheLength:50,createPseudo:lr,match:zi,attrHandle:{},find:{},relative:{">":{dir:"parentNode",first:!0}," ":{dir:"parentNode"},"+":{dir:"previousSibling",first:!0},"~":{dir:"previousSibling"}},preFilter:{ATTR:function(x){return x[1]=x[1].replace(ri,no),x[3]=(x[3]||x[4]||x[5]||"").replace(ri,no),x[2]==="~="&&(x[3]=" "+x[3]+" "),x.slice(0,4)},CHILD:function(x){return x[1]=x[1].toLowerCase(),x[1].slice(0,3)==="nth"?(x[3]||Ye.error(x[0]),x[4]=+(x[4]?x[5]+(x[6]||1):2*(x[3]==="even"||x[3]==="odd")),x[5]=+(x[7]+x[8]||x[3]==="odd")):x[3]&&Ye.error(x[0]),x},PSEUDO:function(x){var H,Z=!x[6]&&x[2];return zi.CHILD.test(x[0])?null:(x[3]?x[2]=x[4]||x[5]||"":Z&&wr.test(Z)&&(H=Ps(Z,!0))&&(H=Z.indexOf(")",Z.length-H)-Z.length)&&(x[0]=x[0].slice(0,H),x[2]=Z.slice(0,H)),x.slice(0,3))}},filter:{TAG:function(x){var H=x.replace(ri,no).toLowerCase();return x==="*"?function(){return!0}:function(Z){return Sn(Z,H)}},CLASS:function(x){var H=ie[x+" "];return H||(H=new RegExp("(^|"+tn+")"+x+"("+tn+"|$)"))&&ie(x,function(Z){return H.test(typeof Z.className=="string"&&Z.className||typeof Z.getAttribute!="undefined"&&Z.getAttribute("class")||"")})},ATTR:function(x,H,Z){return function(et){var ct=Ye.attr(et,x);return ct==null?H==="!=":H?(ct+="",H==="="?ct===Z:H==="!="?ct!==Z:H==="^="?Z&&ct.indexOf(Z)===0:H==="*="?Z&&ct.indexOf(Z)>-1:H==="$="?Z&&ct.slice(-Z.length)===Z:H==="~="?(" "+ct.replace(xe," ")+" ").indexOf(Z)>-1:H==="|="?ct===Z||ct.slice(0,Z.length+1)===Z+"-":!1):!0}},CHILD:function(x,H,Z,et,ct){var vt=x.slice(0,3)!=="nth",bt=x.slice(-4)!=="last",xt=H==="of-type";return et===1&&ct===0?function(At){return!!At.parentNode}:function(At,Oe,te){var ae,ve,Wt,fn,it,pi=vt!==bt?"nextSibling":"previousSibling",Ji=At.parentNode,Nr=xt&&At.nodeName.toLowerCase(),ks=!te&&!xt,vi=!1;if(Ji){if(vt){for(;pi;){for(Wt=At;Wt=Wt[pi];)if(xt?Sn(Wt,Nr):Wt.nodeType===1)return!1;it=pi=x==="only"&&!it&&"nextSibling"}return!0}if(it=[bt?Ji.firstChild:Ji.lastChild],bt&&ks){for(ve=Ji[dt]||(Ji[dt]={}),ae=ve[x]||[],fn=ae[0]===$&&ae[1],vi=fn&&ae[2],Wt=fn&&Ji.childNodes[fn];Wt=++fn&&Wt&&Wt[pi]||(vi=fn=0)||it.pop();)if(Wt.nodeType===1&&++vi&&Wt===At){ve[x]=[$,fn,vi];break}}else if(ks&&(ve=At[dt]||(At[dt]={}),ae=ve[x]||[],fn=ae[0]===$&&ae[1],vi=fn),vi===!1)for(;(Wt=++fn&&Wt&&Wt[pi]||(vi=fn=0)||it.pop())&&!((xt?Sn(Wt,Nr):Wt.nodeType===1)&&++vi&&(ks&&(ve=Wt[dt]||(Wt[dt]={}),ve[x]=[$,vi]),Wt===At)););return vi-=ct,vi===et||vi%et===0&&vi/et>=0}}},PSEUDO:function(x,H){var Z,et=_.pseudos[x]||_.setFilters[x.toLowerCase()]||Ye.error("unsupported pseudo: "+x);return et[dt]?et(H):et.length>1?(Z=[x,x,"",H],_.setFilters.hasOwnProperty(x.toLowerCase())?lr(function(ct,vt){for(var bt,xt=et(ct,H),At=xt.length;At--;)bt=vr.call(ct,xt[At]),ct[bt]=!(vt[bt]=xt[At])}):function(ct){return et(ct,0,Z)}):et}},pseudos:{not:lr(function(x){var H=[],Z=[],et=gu(x.replace(pn,"$1"));return et[dt]?lr(function(ct,vt,bt,xt){for(var At,Oe=et(ct,null,xt,[]),te=ct.length;te--;)(At=Oe[te])&&(ct[te]=!(vt[te]=At))}):function(ct,vt,bt){return H[0]=ct,et(H,null,bt,Z),H[0]=null,!Z.pop()}}),has:lr(function(x){return function(H){return Ye(x,H).length>0}}),contains:lr(function(x){return x=x.replace(ri,no),function(H){return(H.textContent||I.text(H)).indexOf(x)>-1}}),lang:lr(function(x){return Ia.test(x||"")||Ye.error("unsupported lang: "+x),x=x.replace(ri,no).toLowerCase(),function(H){var Z;do if(Z=F?H.lang:H.getAttribute("xml:lang")||H.getAttribute("lang"))return Z=Z.toLowerCase(),Z===x||Z.indexOf(x+"-")===0;while((H=H.parentNode)&&H.nodeType===1);return!1}}),target:function(x){var H=gt.location&&gt.location.hash;return H&&H.slice(1)===x.id},root:function(x){return x===j},focus:function(x){return x===Ih()&&P.hasFocus()&&!!(x.type||x.href||~x.tabIndex)},enabled:bh(!1),disabled:bh(!0),checked:function(x){return Sn(x,"input")&&!!x.checked||Sn(x,"option")&&!!x.selected},selected:function(x){return x.parentNode&&x.parentNode.selectedIndex,x.selected===!0},empty:function(x){for(x=x.firstChild;x;x=x.nextSibling)if(x.nodeType<6)return!1;return!0},parent:function(x){return!_.pseudos.empty(x)},header:function(x){return wo.test(x.nodeName)},input:function(x){return Ao.test(x.nodeName)},button:function(x){return Sn(x,"input")&&x.type==="button"||Sn(x,"button")},text:function(x){var H;return Sn(x,"input")&&x.type==="text"&&((H=x.getAttribute("type"))==null||H.toLowerCase()==="text")},first:ds(function(){return[0]}),last:ds(function(x,H){return[H-1]}),eq:ds(function(x,H,Z){return[Z<0?Z+H:Z]}),even:ds(function(x,H){for(var Z=0;Z<H;Z+=2)x.push(Z);return x}),odd:ds(function(x,H){for(var Z=1;Z<H;Z+=2)x.push(Z);return x}),lt:ds(function(x,H,Z){var et;for(Z<0?et=Z+H:Z>H?et=H:et=Z;--et>=0;)x.push(et);return x}),gt:ds(function(x,H,Z){for(var et=Z<0?Z+H:Z;++et<H;)x.push(et);return x})}},_.pseudos.nth=_.pseudos.eq;for(h in{radio:!0,checkbox:!0,file:!0,password:!0,image:!0})_.pseudos[h]=w_(h);for(h in{submit:!0,reset:!0})_.pseudos[h]=O_(h);function Ah(){}Ah.prototype=_.filters=_.pseudos,_.setFilters=new Ah;function Ps(x,H){var Z,et,ct,vt,bt,xt,At,Oe=Ce[x+" "];if(Oe)return H?0:Oe.slice(0);for(bt=x,xt=[],At=_.preFilter;bt;){(!Z||(et=Ln.exec(bt)))&&(et&&(bt=bt.slice(et[0].length)||bt),xt.push(ct=[])),Z=!1,(et=cs.exec(bt))&&(Z=et.shift(),ct.push({value:Z,type:et[0].replace(pn," ")}),bt=bt.slice(Z.length));for(vt in _.filter)(et=zi[vt].exec(bt))&&(!At[vt]||(et=At[vt](et)))&&(Z=et.shift(),ct.push({value:Z,type:vt,matches:et}),bt=bt.slice(Z.length));if(!Z)break}return H?bt.length:bt?Ye.error(x):Ce(x,xt).slice(0)}function Ls(x){for(var H=0,Z=x.length,et="";H<Z;H++)et+=x[H].value;return et}function Nc(x,H,Z){var et=H.dir,ct=H.next,vt=ct||et,bt=Z&&vt==="parentNode",xt=St++;return H.first?function(At,Oe,te){for(;At=At[et];)if(At.nodeType===1||bt)return x(At,Oe,te);return!1}:function(At,Oe,te){var ae,ve,Wt=[$,xt];if(te){for(;At=At[et];)if((At.nodeType===1||bt)&&x(At,Oe,te))return!0}else for(;At=At[et];)if(At.nodeType===1||bt)if(ve=At[dt]||(At[dt]={}),ct&&Sn(At,ct))At=At[et]||At;else{if((ae=ve[vt])&&ae[0]===$&&ae[1]===xt)return Wt[2]=ae[2];if(ve[vt]=Wt,Wt[2]=x(At,Oe,te))return!0}return!1}}function _u(x){return x.length>1?function(H,Z,et){for(var ct=x.length;ct--;)if(!x[ct](H,Z,et))return!1;return!0}:x[0]}function Dc(x,H,Z){for(var et=0,ct=H.length;et<ct;et++)Ye(x,H[et],Z);return Z}function Pc(x,H,Z,et,ct){for(var vt,bt=[],xt=0,At=x.length,Oe=H!=null;xt<At;xt++)(vt=x[xt])&&(!Z||Z(vt,et,ct))&&(bt.push(vt),Oe&&H.push(xt));return bt}function Eu(x,H,Z,et,ct,vt){return et&&!et[dt]&&(et=Eu(et)),ct&&!ct[dt]&&(ct=Eu(ct,vt)),lr(function(bt,xt,At,Oe){var te,ae,ve,Wt,fn=[],it=[],pi=xt.length,Ji=bt||Dc(H||"*",At.nodeType?[At]:At,[]),Nr=x&&(bt||!H)?Pc(Ji,fn,x,At,Oe):Ji;if(Z?(Wt=ct||(bt?x:pi||et)?[]:xt,Z(Nr,Wt,At,Oe)):Wt=Nr,et)for(te=Pc(Wt,it),et(te,[],At,Oe),ae=te.length;ae--;)(ve=te[ae])&&(Wt[it[ae]]=!(Nr[it[ae]]=ve));if(bt){if(ct||x){if(ct){for(te=[],ae=Wt.length;ae--;)(ve=Wt[ae])&&te.push(Nr[ae]=ve);ct(null,Wt=[],te,Oe)}for(ae=Wt.length;ae--;)(ve=Wt[ae])&&(te=ct?vr.call(bt,ve):fn[ae])>-1&&(bt[te]=!(xt[te]=ve))}}else Wt=Pc(Wt===xt?Wt.splice(pi,Wt.length):Wt),ct?ct(null,xt,Wt,Oe):O.apply(xt,Wt)})}function mu(x){for(var H,Z,et,ct=x.length,vt=_.relative[x[0].type],bt=vt||_.relative[" "],xt=vt?1:0,At=Nc(function(ae){return ae===H},bt,!0),Oe=Nc(function(ae){return vr.call(H,ae)>-1},bt,!0),te=[function(ae,ve,Wt){var fn=!vt&&(Wt||ve!=S)||((H=ve).nodeType?At(ae,ve,Wt):Oe(ae,ve,Wt));return H=null,fn}];xt<ct;xt++)if(Z=_.relative[x[xt].type])te=[Nc(_u(te),Z)];else{if(Z=_.filter[x[xt].type].apply(null,x[xt].matches),Z[dt]){for(et=++xt;et<ct&&!_.relative[x[et].type];et++);return Eu(xt>1&&_u(te),xt>1&&Ls(x.slice(0,xt-1).concat({value:x[xt-2].type===" "?"*":""})).replace(pn,"$1"),Z,xt<et&&mu(x.slice(xt,et)),et<ct&&mu(x=x.slice(et)),et<ct&&Ls(x))}te.push(Z)}return _u(te)}function Or(x,H){var Z=H.length>0,et=x.length>0,ct=function(vt,bt,xt,At,Oe){var te,ae,ve,Wt=0,fn="0",it=vt&&[],pi=[],Ji=S,Nr=vt||et&&_.find.TAG("*",Oe),ks=$+=Ji==null?1:Math.random()||.1,vi=Nr.length;for(Oe&&(S=bt==P||bt||Oe);fn!==vi&&(te=Nr[fn])!=null;fn++){if(et&&te){for(ae=0,!bt&&te.ownerDocument!=P&&(Oo(te),xt=!F);ve=x[ae++];)if(ve(te,bt||P,xt)){O.call(At,te);break}Oe&&($=ks)}Z&&((te=!ve&&te)&&Wt--,vt&&it.push(te))}if(Wt+=fn,Z&&fn!==Wt){for(ae=0;ve=H[ae++];)ve(it,pi,bt,xt);if(vt){if(Wt>0)for(;fn--;)it[fn]||pi[fn]||(pi[fn]=ga.call(At));pi=Pc(pi)}O.apply(At,pi),Oe&&!vt&&pi.length>0&&Wt+H.length>1&&I.uniqueSort(At)}return Oe&&($=ks,S=Ji),it};return Z?lr(ct):ct}function gu(x,H){var Z,et=[],ct=[],vt=Te[x+" "];if(!vt){for(H||(H=Ps(x)),Z=H.length;Z--;)vt=mu(H[Z]),vt[dt]?et.push(vt):ct.push(vt);vt=Te(x,Or(ct,et)),vt.selector=x}return vt}function wh(x,H,Z,et){var ct,vt,bt,xt,At,Oe=typeof x=="function"&&x,te=!et&&Ps(x=Oe.selector||x);if(Z=Z||[],te.length===1){if(vt=te[0]=te[0].slice(0),vt.length>2&&(bt=vt[0]).type==="ID"&&H.nodeType===9&&F&&_.relative[vt[1].type]){if(H=(_.find.ID(bt.matches[0].replace(ri,no),H)||[])[0],H)Oe&&(H=H.parentNode);else return Z;x=x.slice(vt.shift().value.length)}for(ct=zi.needsContext.test(x)?0:vt.length;ct--&&(bt=vt[ct],!_.relative[xt=bt.type]);)if((At=_.find[xt])&&(et=At(bt.matches[0].replace(ri,no),fu.test(vt[0].type)&&Oc(H.parentNode)||H))){if(vt.splice(ct,1),x=et.length&&Ls(vt),!x)return O.apply(Z,et),Z;break}}return(Oe||gu(x,te))(et,H,!F,Z,!H||fu.test(x)&&Oc(H.parentNode)||H),Z}Lt.sortStable=dt.split("").sort(Wn).join("")===dt,Oo(),Lt.sortDetached=oi(function(x){return x.compareDocumentPosition(P.createElement("fieldset"))&1}),I.find=Ye,I.expr[":"]=I.expr.pseudos,I.unique=I.uniqueSort,Ye.compile=gu,Ye.select=wh,Ye.setDocument=Oo,Ye.tokenize=Ps,Ye.escape=I.escapeSelector,Ye.getText=I.text,Ye.isXML=I.isXMLDoc,Ye.selectors=I.expr,Ye.support=I.support,Ye.uniqueSort=I.uniqueSort})();var cn=function(h,_,S){for(var v=[],w=S!==void 0;(h=h[_])&&h.nodeType!==9;)if(h.nodeType===1){if(w&&I(h).is(S))break;v.push(h)}return v},Sa=function(h,_){for(var S=[];h;h=h.nextSibling)h.nodeType===1&&h!==_&&S.push(h);return S},Kd=I.expr.match.needsContext,qd=/^<([a-z][^\/\0>:\x20\t\r\n\f]*)[\x20\t\r\n\f]*\/?>(?:<\/\1>|)$/i;function Yd(h,_,S){return _e(_)?I.grep(h,function(v,w){return!!_.call(v,w,v)!==S}):_.nodeType?I.grep(h,function(v){return v===_!==S}):typeof _!="string"?I.grep(h,function(v){return vr.call(_,v)>-1!==S}):I.filter(_,h,S)}I.filter=function(h,_,S){var v=_[0];return S&&(h=":not("+h+")"),_.length===1&&v.nodeType===1?I.find.matchesSelector(v,h)?[v]:[]:I.find.matches(h,I.grep(_,function(w){return w.nodeType===1}))},I.fn.extend({find:function(h){var _,S,v=this.length,w=this;if(typeof h!="string")return this.pushStack(I(h).filter(function(){for(_=0;_<v;_++)if(I.contains(w[_],this))return!0}));for(S=this.pushStack([]),_=0;_<v;_++)I.find(h,w[_],S);return v>1?I.uniqueSort(S):S},filter:function(h){return this.pushStack(Yd(this,h||[],!1))},not:function(h){return this.pushStack(Yd(this,h||[],!0))},is:function(h){return!!Yd(this,typeof h=="string"&&Kd.test(h)?I(h):h||[],!1).length}});var $r,pc=/^(?:\s*(<[\w\W]+>)[^>]*|#([\w-]+))$/,Ro=I.fn.init=function(h,_,S){var v,w;if(!h)return this;if(S=S||$r,typeof h=="string")if(h[0]==="<"&&h[h.length-1]===">"&&h.length>=3?v=[null,h,null]:v=pc.exec(h),v&&(v[1]||!_))if(v[1]){if(_=_ instanceof I?_[0]:_,I.merge(this,I.parseHTML(v[1],_&&_.nodeType?_.ownerDocument||_:ce,!0)),qd.test(v[1])&&I.isPlainObject(_))for(v in _)_e(this[v])?this[v](_[v]):this.attr(v,_[v]);return this}else return w=ce.getElementById(v[2]),w&&(this[0]=w,this.length=1),this;else return!_||_.jquery?(_||S).find(h):this.constructor(_).find(h);else{if(h.nodeType)return this[0]=h,this.length=1,this;if(_e(h))return S.ready!==void 0?S.ready(h):h(I)}return I.makeArray(h,this)};Ro.prototype=I.fn,$r=I(ce);var r_=/^(?:parents|prev(?:Until|All))/,o_={children:!0,contents:!0,next:!0,prev:!0};I.fn.extend({has:function(h){var _=I(h,this),S=_.length;return this.filter(function(){for(var v=0;v<S;v++)if(I.contains(this,_[v]))return!0})},closest:function(h,_){var S,v=0,w=this.length,O=[],P=typeof h!="string"&&I(h);if(!Kd.test(h)){for(;v<w;v++)for(S=this[v];S&&S!==_;S=S.parentNode)if(S.nodeType<11&&(P?P.index(S)>-1:S.nodeType===1&&I.find.matchesSelector(S,h))){O.push(S);break}}return this.pushStack(O.length>1?I.uniqueSort(O):O)},index:function(h){return h?typeof h=="string"?vr.call(I(h),this[0]):vr.call(this,h.jquery?h[0]:h):this[0]&&this[0].parentNode?this.first().prevAll().length:-1},add:function(h,_){return this.pushStack(I.uniqueSort(I.merge(this.get(),I(h,_))))},addBack:function(h){return this.add(h==null?this.prevObject:this.prevObject.filter(h))}});function fc(h,_){for(;(h=h[_])&&h.nodeType!==1;);return h}I.each({parent:function(h){var _=h.parentNode;return _&&_.nodeType!==11?_:null},parents:function(h){return cn(h,"parentNode")},parentsUntil:function(h,_,S){return cn(h,"parentNode",S)},next:function(h){return fc(h,"nextSibling")},prev:function(h){return fc(h,"previousSibling")},nextAll:function(h){return cn(h,"nextSibling")},prevAll:function(h){return cn(h,"previousSibling")},nextUntil:function(h,_,S){return cn(h,"nextSibling",S)},prevUntil:function(h,_,S){return cn(h,"previousSibling",S)},siblings:function(h){return Sa((h.parentNode||{}).firstChild,h)},children:function(h){return Sa(h.firstChild)},contents:function(h){return h.contentDocument!=null&&Dt(h.contentDocument)?h.contentDocument:(Sn(h,"template")&&(h=h.content||h),I.merge([],h.childNodes))}},function(h,_){I.fn[h]=function(S,v){var w=I.map(this,_,S);return h.slice(-5)!=="Until"&&(v=S),v&&typeof v=="string"&&(w=I.filter(v,w)),this.length>1&&(o_[h]||I.uniqueSort(w),r_.test(h)&&w.reverse()),this.pushStack(w)}});var yr=/[^\x20\t\r\n\f]+/g;function _c(h){var _={};return I.each(h.match(yr)||[],function(S,v){_[v]=!0}),_}I.Callbacks=function(h){h=typeof h=="string"?_c(h):I.extend({},h);var _,S,v,w,O=[],P=[],j=-1,F=function(){for(w=w||h.once,v=_=!0;P.length;j=-1)for(S=P.shift();++j<O.length;)O[j].apply(S[0],S[1])===!1&&h.stopOnFalse&&(j=O.length,S=!1);h.memory||(S=!1),_=!1,w&&(S?O=[]:O="")},q={add:function(){return O&&(S&&!_&&(j=O.length-1,P.push(S)),function rt(dt){I.each(dt,function($,St){_e(St)?(!h.unique||!q.has(St))&&O.push(St):St&&St.length&&$o(St)!=="string"&&rt(St)})}(arguments),S&&!_&&F()),this},remove:function(){return I.each(arguments,function(rt,dt){for(var $;($=I.inArray(dt,O,$))>-1;)O.splice($,1),$<=j&&j--}),this},has:function(rt){return rt?I.inArray(rt,O)>-1:O.length>0},empty:function(){return O&&(O=[]),this},disable:function(){return w=P=[],O=S="",this},disabled:function(){return!O},lock:function(){return w=P=[],!S&&!_&&(O=S=""),this},locked:function(){return!!w},fireWith:function(rt,dt){return w||(dt=dt||[],dt=[rt,dt.slice?dt.slice():dt],P.push(dt),_||F()),this},fire:function(){return q.fireWith(this,arguments),this},fired:function(){return!!v}};return q};function dr(h){return h}function Ec(h){throw h}function Yl(h,_,S,v){var w;try{h&&_e(w=h.promise)?w.call(h).done(_).fail(S):h&&_e(w=h.then)?w.call(h,_,S):_.apply(void 0,[h].slice(v))}catch(O){S.apply(void 0,[O])}}I.extend({Deferred:function(h){var _=[["notify","progress",I.Callbacks("memory"),I.Callbacks("memory"),2],["resolve","done",I.Callbacks("once memory"),I.Callbacks("once memory"),0,"resolved"],["reject","fail",I.Callbacks("once memory"),I.Callbacks("once memory"),1,"rejected"]],S="pending",v={state:function(){return S},always:function(){return w.done(arguments).fail(arguments),this},catch:function(O){return v.then(null,O)},pipe:function(){var O=arguments;return I.Deferred(function(P){I.each(_,function(j,F){var q=_e(O[F[4]])&&O[F[4]];w[F[1]](function(){var rt=q&&q.apply(this,arguments);rt&&_e(rt.promise)?rt.promise().progress(P.notify).done(P.resolve).fail(P.reject):P[F[0]+"With"](this,q?[rt]:arguments)})}),O=null}).promise()},then:function(O,P,j){var F=0;function q(rt,dt,$,St){return function(){var ie=this,Ce=arguments,Te=function(){var Wn,Ar;if(!(rt<F)){if(Wn=$.apply(ie,Ce),Wn===dt.promise())throw new TypeError("Thenable self-resolution");Ar=Wn&&(typeof Wn=="object"||typeof Wn=="function")&&Wn.then,_e(Ar)?St?Ar.call(Wn,q(F,dt,dr,St),q(F,dt,Ec,St)):(F++,Ar.call(Wn,q(F,dt,dr,St),q(F,dt,Ec,St),q(F,dt,dr,dt.notifyWith))):($!==dr&&(ie=void 0,Ce=[Wn]),(St||dt.resolveWith)(ie,Ce))}},Pn=St?Te:function(){try{Te()}catch(Wn){I.Deferred.exceptionHook&&I.Deferred.exceptionHook(Wn,Pn.error),rt+1>=F&&($!==Ec&&(ie=void 0,Ce=[Wn]),dt.rejectWith(ie,Ce))}};rt?Pn():(I.Deferred.getErrorHook?Pn.error=I.Deferred.getErrorHook():I.Deferred.getStackHook&&(Pn.error=I.Deferred.getStackHook()),gt.setTimeout(Pn))}}return I.Deferred(function(rt){_[0][3].add(q(0,rt,_e(j)?j:dr,rt.notifyWith)),_[1][3].add(q(0,rt,_e(O)?O:dr)),_[2][3].add(q(0,rt,_e(P)?P:Ec))}).promise()},promise:function(O){return O!=null?I.extend(O,v):v}},w={};return I.each(_,function(O,P){var j=P[2],F=P[5];v[P[1]]=j.add,F&&j.add(function(){S=F},_[3-O][2].disable,_[3-O][3].disable,_[0][2].lock,_[0][3].lock),j.add(P[3].fire),w[P[0]]=function(){return w[P[0]+"With"](this===w?void 0:this,arguments),this},w[P[0]+"With"]=j.fireWith}),v.promise(w),h&&h.call(w,w),w},when:function(h){var _=arguments.length,S=_,v=Array(S),w=Pt.call(arguments),O=I.Deferred(),P=function(j){return function(F){v[j]=this,w[j]=arguments.length>1?Pt.call(arguments):F,--_||O.resolveWith(v,w)}};if(_<=1&&(Yl(h,O.done(P(S)).resolve,O.reject,!_),O.state()==="pending"||_e(w[S]&&w[S].then)))return O.then();for(;S--;)Yl(w[S],P(S),O.reject);return O.promise()}});var ws=/^(Eval|Internal|Range|Reference|Syntax|Type|URI)Error$/;I.Deferred.exceptionHook=function(h,_){gt.console&&gt.console.warn&&h&&ws.test(h.name)&&gt.console.warn("jQuery.Deferred exception: "+h.message,h.stack,_)},I.readyException=function(h){gt.setTimeout(function(){throw h})};var zd=I.Deferred();I.fn.ready=function(h){return zd.then(h).catch(function(_){I.readyException(_)}),this},I.extend({isReady:!1,readyWait:1,ready:function(h){(h===!0?--I.readyWait:I.isReady)||(I.isReady=!0,!(h!==!0&&--I.readyWait>0)&&zd.resolveWith(ce,[I]))}}),I.ready.then=zd.then;function mc(){ce.removeEventListener("DOMContentLoaded",mc),gt.removeEventListener("load",mc),I.ready()}ce.readyState==="complete"||ce.readyState!=="loading"&&!ce.documentElement.doScroll?gt.setTimeout(I.ready):(ce.addEventListener("DOMContentLoaded",mc),gt.addEventListener("load",mc));var li=function(h,_,S,v,w,O,P){var j=0,F=h.length,q=S==null;if($o(S)==="object"){w=!0;for(j in S)li(h,_,j,S[j],!0,O,P)}else if(v!==void 0&&(w=!0,_e(v)||(P=!0),q&&(P?(_.call(h,v),_=null):(q=_,_=function(rt,dt,$){return q.call(I(rt),$)})),_))for(;j<F;j++)_(h[j],S,P?v:v.call(h[j],j,_(h[j],S)));return w?h:q?_.call(h):F?_(h[0],S):O},zl=/^-ms-/,s_=/-([a-z])/g;function Oi(h,_){return _.toUpperCase()}function Bn(h){return h.replace(zl,"ms-").replace(s_,Oi)}var ts=function(h){return h.nodeType===1||h.nodeType===9||!+h.nodeType};function es(){this.expando=I.expando+es.uid++}es.uid=1,es.prototype={cache:function(h){var _=h[this.expando];return _||(_={},ts(h)&&(h.nodeType?h[this.expando]=_:Object.defineProperty(h,this.expando,{value:_,configurable:!0}))),_},set:function(h,_,S){var v,w=this.cache(h);if(typeof _=="string")w[Bn(_)]=S;else for(v in _)w[Bn(v)]=_[v];return w},get:function(h,_){return _===void 0?this.cache(h):h[this.expando]&&h[this.expando][Bn(_)]},access:function(h,_,S){return _===void 0||_&&typeof _=="string"&&S===void 0?this.get(h,_):(this.set(h,_,S),S!==void 0?S:_)},remove:function(h,_){var S,v=h[this.expando];if(v!==void 0){if(_!==void 0)for(Array.isArray(_)?_=_.map(Bn):(_=Bn(_),_=_ in v?[_]:_.match(yr)||[]),S=_.length;S--;)delete v[_[S]];(_===void 0||I.isEmptyObject(v))&&(h.nodeType?h[this.expando]=void 0:delete h[this.expando])}},hasData:function(h){var _=h[this.expando];return _!==void 0&&!I.isEmptyObject(_)}};var jt=new es,Ri=new es,Ci=/^(?:\{[\w\W]*\}|\[[\w\W]*\])$/,ns=/[A-Z]/g;function Jl(h){return h==="true"?!0:h==="false"?!1:h==="null"?null:h===+h+""?+h:Ci.test(h)?JSON.parse(h):h}function gc(h,_,S){var v;if(S===void 0&&h.nodeType===1)if(v="data-"+_.replace(ns,"-$&").toLowerCase(),S=h.getAttribute(v),typeof S=="string"){try{S=Jl(S)}catch{}Ri.set(h,_,S)}else S=void 0;return S}I.extend({hasData:function(h){return Ri.hasData(h)||jt.hasData(h)},data:function(h,_,S){return Ri.access(h,_,S)},removeData:function(h,_){Ri.remove(h,_)},_data:function(h,_,S){return jt.access(h,_,S)},_removeData:function(h,_){jt.remove(h,_)}}),I.fn.extend({data:function(h,_){var S,v,w,O=this[0],P=O&&O.attributes;if(h===void 0){if(this.length&&(w=Ri.get(O),O.nodeType===1&&!jt.get(O,"hasDataAttrs"))){for(S=P.length;S--;)P[S]&&(v=P[S].name,v.indexOf("data-")===0&&(v=Bn(v.slice(5)),gc(O,v,w[v])));jt.set(O,"hasDataAttrs",!0)}return w}return typeof h=="object"?this.each(function(){Ri.set(this,h)}):li(this,function(j){var F;if(O&&j===void 0)return F=Ri.get(O,h),F!==void 0||(F=gc(O,h),F!==void 0)?F:void 0;this.each(function(){Ri.set(this,h,j)})},null,_,arguments.length>1,null,!0)},removeData:function(h){return this.each(function(){Ri.remove(this,h)})}}),I.extend({queue:function(h,_,S){var v;if(h)return _=(_||"fx")+"queue",v=jt.get(h,_),S&&(!v||Array.isArray(S)?v=jt.access(h,_,I.makeArray(S)):v.push(S)),v||[]},dequeue:function(h,_){_=_||"fx";var S=I.queue(h,_),v=S.length,w=S.shift(),O=I._queueHooks(h,_),P=function(){I.dequeue(h,_)};w==="inprogress"&&(w=S.shift(),v--),w&&(_==="fx"&&S.unshift("inprogress"),delete O.stop,w.call(h,P,O)),!v&&O&&O.empty.fire()},_queueHooks:function(h,_){var S=_+"queueHooks";return jt.get(h,S)||jt.access(h,S,{empty:I.Callbacks("once memory").add(function(){jt.remove(h,[_+"queue",S])})})}}),I.fn.extend({queue:function(h,_){var S=2;return typeof h!="string"&&(_=h,h="fx",S--),arguments.length<S?I.queue(this[0],h):_===void 0?this:this.each(function(){var v=I.queue(this,h,_);I._queueHooks(this,h),h==="fx"&&v[0]!=="inprogress"&&I.dequeue(this,h)})},dequeue:function(h){return this.each(function(){I.dequeue(this,h)})},clearQueue:function(h){return this.queue(h||"fx",[])},promise:function(h,_){var S,v=1,w=I.Deferred(),O=this,P=this.length,j=function(){--v||w.resolveWith(O,[O])};for(typeof h!="string"&&(_=h,h=void 0),h=h||"fx";P--;)S=jt.get(O[P],h+"queueHooks"),S&&S.empty&&(v++,S.empty.add(j));return j(),w.promise(_)}});var Jd=/[+-]?(?:\d*\.|)\d+(?:[eE][+-]?\d+|)/.source,Os=new RegExp("^(?:([+-])=|)("+Jd+")([a-z%]*)$","i"),Ir=["Top","Right","Bottom","Left"],Co=ce.documentElement,Yi=function(h){return I.contains(h.ownerDocument,h)},Xl={composed:!0};Co.getRootNode&&(Yi=function(h){return I.contains(h.ownerDocument,h)||h.getRootNode(Xl)===h.ownerDocument});var Tc=function(h,_){return h=_||h,h.style.display==="none"||h.style.display===""&&Yi(h)&&I.css(h,"display")==="none"};function Ql(h,_,S,v){var w,O,P=20,j=v?function(){return v.cur()}:function(){return I.css(h,_,"")},F=j(),q=S&&S[3]||(I.cssNumber[_]?"":"px"),rt=h.nodeType&&(I.cssNumber[_]||q!=="px"&&+F)&&Os.exec(I.css(h,_));if(rt&&rt[3]!==q){for(F=F/2,q=q||rt[3],rt=+F||1;P--;)I.style(h,_,rt+q),(1-O)*(1-(O=j()/F||.5))<=0&&(P=0),rt=rt/O;rt=rt*2,I.style(h,_,rt+q),S=S||[]}return S&&(rt=+rt||+F||0,w=S[1]?rt+(S[1]+1)*S[2]:+S[2],v&&(v.unit=q,v.start=rt,v.end=w)),w}var is={};function Zl(h){var _,S=h.ownerDocument,v=h.nodeName,w=is[v];return w||(_=S.body.appendChild(S.createElement(v)),w=I.css(_,"display"),_.parentNode.removeChild(_),w==="none"&&(w="block"),is[v]=w,w)}function Ns(h,_){for(var S,v,w=[],O=0,P=h.length;O<P;O++)v=h[O],v.style&&(S=v.style.display,_?(S==="none"&&(w[O]=jt.get(v,"display")||null,w[O]||(v.style.display="")),v.style.display===""&&Tc(v)&&(w[O]=Zl(v))):S!=="none"&&(w[O]="none",jt.set(v,"display",S)));for(O=0;O<P;O++)w[O]!=null&&(h[O].style.display=w[O]);return h}I.fn.extend({show:function(){return Ns(this,!0)},hide:function(){return Ns(this)},toggle:function(h){return typeof h=="boolean"?h?this.show():this.hide():this.each(function(){Tc(this)?I(this).show():I(this).hide()})}});var Ra=/^(?:checkbox|radio)$/i,$l=/<([a-z][^\/\0>\x20\t\r\n\f]*)/i,th=/^$|^module$|\/(?:java|ecma)script/i;(function(){var h=ce.createDocumentFragment(),_=h.appendChild(ce.createElement("div")),S=ce.createElement("input");S.setAttribute("type","radio"),S.setAttribute("checked","checked"),S.setAttribute("name","t"),_.appendChild(S),Lt.checkClone=_.cloneNode(!0).cloneNode(!0).lastChild.checked,_.innerHTML="<textarea>x</textarea>",Lt.noCloneChecked=!!_.cloneNode(!0).lastChild.defaultValue,_.innerHTML="<option></option>",Lt.option=!!_.lastChild})();var hi={thead:[1,"<table>","</table>"],col:[2,"<table><colgroup>","</colgroup></table>"],tr:[2,"<table><tbody>","</tbody></table>"],td:[3,"<table><tbody><tr>","</tr></tbody></table>"],_default:[0,"",""]};hi.tbody=hi.tfoot=hi.colgroup=hi.caption=hi.thead,hi.th=hi.td,Lt.option||(hi.optgroup=hi.option=[1,"<select multiple='multiple'>","</select>"]);function Ni(h,_){var S;return typeof h.getElementsByTagName!="undefined"?S=h.getElementsByTagName(_||"*"):typeof h.querySelectorAll!="undefined"?S=h.querySelectorAll(_||"*"):S=[],_===void 0||_&&Sn(h,_)?I.merge([h],S):S}function vo(h,_){for(var S=0,v=h.length;S<v;S++)jt.set(h[S],"globalEval",!_||jt.get(_[S],"globalEval"))}var a_=/<|&#?\w+;/;function eh(h,_,S,v,w){for(var O,P,j,F,q,rt,dt=_.createDocumentFragment(),$=[],St=0,ie=h.length;St<ie;St++)if(O=h[St],O||O===0)if($o(O)==="object")I.merge($,O.nodeType?[O]:O);else if(!a_.test(O))$.push(_.createTextNode(O));else{for(P=P||dt.appendChild(_.createElement("div")),j=($l.exec(O)||["",""])[1].toLowerCase(),F=hi[j]||hi._default,P.innerHTML=F[1]+I.htmlPrefilter(O)+F[2],rt=F[0];rt--;)P=P.lastChild;I.merge($,P.childNodes),P=dt.firstChild,P.textContent=""}for(dt.textContent="",St=0;O=$[St++];){if(v&&I.inArray(O,v)>-1){w&&w.push(O);continue}if(q=Yi(O),P=Ni(dt.appendChild(O),"script"),q&&vo(P),S)for(rt=0;O=P[rt++];)th.test(O.type||"")&&S.push(O)}return dt}var nh=/^([^.]*)(?:\.(.+)|)/;function ii(){return!0}function Ds(){return!1}function Xd(h,_,S,v,w,O){var P,j;if(typeof _=="object"){typeof S!="string"&&(v=v||S,S=void 0);for(j in _)Xd(h,j,S,v,_[j],O);return h}if(v==null&&w==null?(w=S,v=S=void 0):w==null&&(typeof S=="string"?(w=v,v=void 0):(w=v,v=S,S=void 0)),w===!1)w=Ds;else if(!w)return h;return O===1&&(P=w,w=function(F){return I().off(F),P.apply(this,arguments)},w.guid=P.guid||(P.guid=I.guid++)),h.each(function(){I.event.add(this,_,w,v,S)})}I.event={global:{},add:function(h,_,S,v,w){var O,P,j,F,q,rt,dt,$,St,ie,Ce,Te=jt.get(h);if(!!ts(h))for(S.handler&&(O=S,S=O.handler,w=O.selector),w&&I.find.matchesSelector(Co,w),S.guid||(S.guid=I.guid++),(F=Te.events)||(F=Te.events=Object.create(null)),(P=Te.handle)||(P=Te.handle=function(Pn){return typeof I!="undefined"&&I.event.triggered!==Pn.type?I.event.dispatch.apply(h,arguments):void 0}),_=(_||"").match(yr)||[""],q=_.length;q--;)j=nh.exec(_[q])||[],St=Ce=j[1],ie=(j[2]||"").split(".").sort(),St&&(dt=I.event.special[St]||{},St=(w?dt.delegateType:dt.bindType)||St,dt=I.event.special[St]||{},rt=I.extend({type:St,origType:Ce,data:v,handler:S,guid:S.guid,selector:w,needsContext:w&&I.expr.match.needsContext.test(w),namespace:ie.join(".")},O),($=F[St])||($=F[St]=[],$.delegateCount=0,(!dt.setup||dt.setup.call(h,v,ie,P)===!1)&&h.addEventListener&&h.addEventListener(St,P)),dt.add&&(dt.add.call(h,rt),rt.handler.guid||(rt.handler.guid=S.guid)),w?$.splice($.delegateCount++,0,rt):$.push(rt),I.event.global[St]=!0)},remove:function(h,_,S,v,w){var O,P,j,F,q,rt,dt,$,St,ie,Ce,Te=jt.hasData(h)&&jt.get(h);if(!(!Te||!(F=Te.events))){for(_=(_||"").match(yr)||[""],q=_.length;q--;){if(j=nh.exec(_[q])||[],St=Ce=j[1],ie=(j[2]||"").split(".").sort(),!St){for(St in F)I.event.remove(h,St+_[q],S,v,!0);continue}for(dt=I.event.special[St]||{},St=(v?dt.delegateType:dt.bindType)||St,$=F[St]||[],j=j[2]&&new RegExp("(^|\\.)"+ie.join("\\.(?:.*\\.|)")+"(\\.|$)"),P=O=$.length;O--;)rt=$[O],(w||Ce===rt.origType)&&(!S||S.guid===rt.guid)&&(!j||j.test(rt.namespace))&&(!v||v===rt.selector||v==="**"&&rt.selector)&&($.splice(O,1),rt.selector&&$.delegateCount--,dt.remove&&dt.remove.call(h,rt));P&&!$.length&&((!dt.teardown||dt.teardown.call(h,ie,Te.handle)===!1)&&I.removeEvent(h,St,Te.handle),delete F[St])}I.isEmptyObject(F)&&jt.remove(h,"handle events")}},dispatch:function(h){var _,S,v,w,O,P,j=new Array(arguments.length),F=I.event.fix(h),q=(jt.get(this,"events")||Object.create(null))[F.type]||[],rt=I.event.special[F.type]||{};for(j[0]=F,_=1;_<arguments.length;_++)j[_]=arguments[_];if(F.delegateTarget=this,!(rt.preDispatch&&rt.preDispatch.call(this,F)===!1)){for(P=I.event.handlers.call(this,F,q),_=0;(w=P[_++])&&!F.isPropagationStopped();)for(F.currentTarget=w.elem,S=0;(O=w.handlers[S++])&&!F.isImmediatePropagationStopped();)(!F.rnamespace||O.namespace===!1||F.rnamespace.test(O.namespace))&&(F.handleObj=O,F.data=O.data,v=((I.event.special[O.origType]||{}).handle||O.handler).apply(w.elem,j),v!==void 0&&(F.result=v)===!1&&(F.preventDefault(),F.stopPropagation()));return rt.postDispatch&&rt.postDispatch.call(this,F),F.result}},handlers:function(h,_){var S,v,w,O,P,j=[],F=_.delegateCount,q=h.target;if(F&&q.nodeType&&!(h.type==="click"&&h.button>=1)){for(;q!==this;q=q.parentNode||this)if(q.nodeType===1&&!(h.type==="click"&&q.disabled===!0)){for(O=[],P={},S=0;S<F;S++)v=_[S],w=v.selector+" ",P[w]===void 0&&(P[w]=v.needsContext?I(w,this).index(q)>-1:I.find(w,this,null,[q]).length),P[w]&&O.push(v);O.length&&j.push({elem:q,handlers:O})}}return q=this,F<_.length&&j.push({elem:q,handlers:_.slice(F)}),j},addProp:function(h,_){Object.defineProperty(I.Event.prototype,h,{enumerable:!0,configurable:!0,get:_e(_)?function(){if(this.originalEvent)return _(this.originalEvent)}:function(){if(this.originalEvent)return this.originalEvent[h]},set:function(S){Object.defineProperty(this,h,{enumerable:!0,configurable:!0,writable:!0,value:S})}})},fix:function(h){return h[I.expando]?h:new I.Event(h)},special:{load:{noBubble:!0},click:{setup:function(h){var _=this||h;return Ra.test(_.type)&&_.click&&Sn(_,"input")&&rs(_,"click",!0),!1},trigger:function(h){var _=this||h;return Ra.test(_.type)&&_.click&&Sn(_,"input")&&rs(_,"click"),!0},_default:function(h){var _=h.target;return Ra.test(_.type)&&_.click&&Sn(_,"input")&&jt.get(_,"click")||Sn(_,"a")}},beforeunload:{postDispatch:function(h){h.result!==void 0&&h.originalEvent&&(h.originalEvent.returnValue=h.result)}}}};function rs(h,_,S){if(!S){jt.get(h,_)===void 0&&I.event.add(h,_,ii);return}jt.set(h,_,!1),I.event.add(h,_,{namespace:!1,handler:function(v){var w,O=jt.get(this,_);if(v.isTrigger&1&&this[_]){if(O)(I.event.special[_]||{}).delegateType&&v.stopPropagation();else if(O=Pt.call(arguments),jt.set(this,_,O),this[_](),w=jt.get(this,_),jt.set(this,_,!1),O!==w)return v.stopImmediatePropagation(),v.preventDefault(),w}else O&&(jt.set(this,_,I.event.trigger(O[0],O.slice(1),this)),v.stopPropagation(),v.isImmediatePropagationStopped=ii)}})}I.removeEvent=function(h,_,S){h.removeEventListener&&h.removeEventListener(_,S)},I.Event=function(h,_){if(!(this instanceof I.Event))return new I.Event(h,_);h&&h.type?(this.originalEvent=h,this.type=h.type,this.isDefaultPrevented=h.defaultPrevented||h.defaultPrevented===void 0&&h.returnValue===!1?ii:Ds,this.target=h.target&&h.target.nodeType===3?h.target.parentNode:h.target,this.currentTarget=h.currentTarget,this.relatedTarget=h.relatedTarget):this.type=h,_&&I.extend(this,_),this.timeStamp=h&&h.timeStamp||Date.now(),this[I.expando]=!0},I.Event.prototype={constructor:I.Event,isDefaultPrevented:Ds,isPropagationStopped:Ds,isImmediatePropagationStopped:Ds,isSimulated:!1,preventDefault:function(){var h=this.originalEvent;this.isDefaultPrevented=ii,h&&!this.isSimulated&&h.preventDefault()},stopPropagation:function(){var h=this.originalEvent;this.isPropagationStopped=ii,h&&!this.isSimulated&&h.stopPropagation()},stopImmediatePropagation:function(){var h=this.originalEvent;this.isImmediatePropagationStopped=ii,h&&!this.isSimulated&&h.stopImmediatePropagation(),this.stopPropagation()}},I.each({altKey:!0,bubbles:!0,cancelable:!0,changedTouches:!0,ctrlKey:!0,detail:!0,eventPhase:!0,metaKey:!0,pageX:!0,pageY:!0,shiftKey:!0,view:!0,char:!0,code:!0,charCode:!0,key:!0,keyCode:!0,button:!0,buttons:!0,clientX:!0,clientY:!0,offsetX:!0,offsetY:!0,pointerId:!0,pointerType:!0,screenX:!0,screenY:!0,targetTouches:!0,toElement:!0,touches:!0,which:!0},I.event.addProp),I.each({focus:"focusin",blur:"focusout"},function(h,_){function S(v){if(ce.documentMode){var w=jt.get(this,"handle"),O=I.event.fix(v);O.type=v.type==="focusin"?"focus":"blur",O.isSimulated=!0,w(v),O.target===O.currentTarget&&w(O)}else I.event.simulate(_,v.target,I.event.fix(v))}I.event.special[h]={setup:function(){var v;if(rs(this,h,!0),ce.documentMode)v=jt.get(this,_),v||this.addEventListener(_,S),jt.set(this,_,(v||0)+1);else return!1},trigger:function(){return rs(this,h),!0},teardown:function(){var v;if(ce.documentMode)v=jt.get(this,_)-1,v?jt.set(this,_,v):(this.removeEventListener(_,S),jt.remove(this,_));else return!1},_default:function(v){return jt.get(v.target,h)},delegateType:_},I.event.special[_]={setup:function(){var v=this.ownerDocument||this.document||this,w=ce.documentMode?this:v,O=jt.get(w,_);O||(ce.documentMode?this.addEventListener(_,S):v.addEventListener(h,S,!0)),jt.set(w,_,(O||0)+1)},teardown:function(){var v=this.ownerDocument||this.document||this,w=ce.documentMode?this:v,O=jt.get(w,_)-1;O?jt.set(w,_,O):(ce.documentMode?this.removeEventListener(_,S):v.removeEventListener(h,S,!0),jt.remove(w,_))}}}),I.each({mouseenter:"mouseover",mouseleave:"mouseout",pointerenter:"pointerover",pointerleave:"pointerout"},function(h,_){I.event.special[h]={delegateType:_,bindType:_,handle:function(S){var v,w=this,O=S.relatedTarget,P=S.handleObj;return(!O||O!==w&&!I.contains(w,O))&&(S.type=P.origType,v=P.handler.apply(this,arguments),S.type=_),v}}}),I.fn.extend({on:function(h,_,S,v){return Xd(this,h,_,S,v)},one:function(h,_,S,v){return Xd(this,h,_,S,v,1)},off:function(h,_,S){var v,w;if(h&&h.preventDefault&&h.handleObj)return v=h.handleObj,I(h.delegateTarget).off(v.namespace?v.origType+"."+v.namespace:v.origType,v.selector,v.handler),this;if(typeof h=="object"){for(w in h)this.off(w,_,h[w]);return this}return(_===!1||typeof _=="function")&&(S=_,_=void 0),S===!1&&(S=Ds),this.each(function(){I.event.remove(this,h,S,_)})}});var Qd=/<script|<style|<link/i,Zd=/checked\s*(?:[^=]|=\s*.checked.)/i,$d=/^\s*<!\[CDATA\[|\]\]>\s*$/g;function ih(h,_){return Sn(h,"table")&&Sn(_.nodeType!==11?_:_.firstChild,"tr")&&I(h).children("tbody")[0]||h}function rh(h){return h.type=(h.getAttribute("type")!==null)+"/"+h.type,h}function oh(h){return(h.type||"").slice(0,5)==="true/"?h.type=h.type.slice(5):h.removeAttribute("type"),h}function sh(h,_){var S,v,w,O,P,j,F;if(_.nodeType===1){if(jt.hasData(h)&&(O=jt.get(h),F=O.events,F)){jt.remove(_,"handle events");for(w in F)for(S=0,v=F[w].length;S<v;S++)I.event.add(_,w,F[w][S])}Ri.hasData(h)&&(P=Ri.access(h),j=I.extend({},P),Ri.set(_,j))}}function c_(h,_){var S=_.nodeName.toLowerCase();S==="input"&&Ra.test(h.type)?_.checked=h.checked:(S==="input"||S==="textarea")&&(_.defaultValue=h.defaultValue)}function os(h,_,S,v){_=wi(_);var w,O,P,j,F,q,rt=0,dt=h.length,$=dt-1,St=_[0],ie=_e(St);if(ie||dt>1&&typeof St=="string"&&!Lt.checkClone&&Zd.test(St))return h.each(function(Ce){var Te=h.eq(Ce);ie&&(_[0]=St.call(this,Ce,Te.html())),os(Te,_,S,v)});if(dt&&(w=eh(_,h[0].ownerDocument,!1,h,v),O=w.firstChild,w.childNodes.length===1&&(w=O),O||v)){for(P=I.map(Ni(w,"script"),rh),j=P.length;rt<dt;rt++)F=w,rt!==$&&(F=I.clone(F,!0,!0),j&&I.merge(P,Ni(F,"script"))),S.call(h[rt],F,rt);if(j)for(q=P[P.length-1].ownerDocument,I.map(P,oh),rt=0;rt<j;rt++)F=P[rt],th.test(F.type||"")&&!jt.access(F,"globalEval")&&I.contains(q,F)&&(F.src&&(F.type||"").toLowerCase()!=="module"?I._evalUrl&&!F.noModule&&I._evalUrl(F.src,{nonce:F.nonce||F.getAttribute("nonce")},q):lc(F.textContent.replace($d,""),F,q))}return h}function Sc(h,_,S){for(var v,w=_?I.filter(_,h):h,O=0;(v=w[O])!=null;O++)!S&&v.nodeType===1&&I.cleanData(Ni(v)),v.parentNode&&(S&&Yi(v)&&vo(Ni(v,"script")),v.parentNode.removeChild(v));return h}I.extend({htmlPrefilter:function(h){return h},clone:function(h,_,S){var v,w,O,P,j=h.cloneNode(!0),F=Yi(h);if(!Lt.noCloneChecked&&(h.nodeType===1||h.nodeType===11)&&!I.isXMLDoc(h))for(P=Ni(j),O=Ni(h),v=0,w=O.length;v<w;v++)c_(O[v],P[v]);if(_)if(S)for(O=O||Ni(h),P=P||Ni(j),v=0,w=O.length;v<w;v++)sh(O[v],P[v]);else sh(h,j);return P=Ni(j,"script"),P.length>0&&vo(P,!F&&Ni(h,"script")),j},cleanData:function(h){for(var _,S,v,w=I.event.special,O=0;(S=h[O])!==void 0;O++)if(ts(S)){if(_=S[jt.expando]){if(_.events)for(v in _.events)w[v]?I.event.remove(S,v):I.removeEvent(S,v,_.handle);S[jt.expando]=void 0}S[Ri.expando]&&(S[Ri.expando]=void 0)}}}),I.fn.extend({detach:function(h){return Sc(this,h,!0)},remove:function(h){return Sc(this,h)},text:function(h){return li(this,function(_){return _===void 0?I.text(this):this.empty().each(function(){(this.nodeType===1||this.nodeType===11||this.nodeType===9)&&(this.textContent=_)})},null,h,arguments.length)},append:function(){return os(this,arguments,function(h){if(this.nodeType===1||this.nodeType===11||this.nodeType===9){var _=ih(this,h);_.appendChild(h)}})},prepend:function(){return os(this,arguments,function(h){if(this.nodeType===1||this.nodeType===11||this.nodeType===9){var _=ih(this,h);_.insertBefore(h,_.firstChild)}})},before:function(){return os(this,arguments,function(h){this.parentNode&&this.parentNode.insertBefore(h,this)})},after:function(){return os(this,arguments,function(h){this.parentNode&&this.parentNode.insertBefore(h,this.nextSibling)})},empty:function(){for(var h,_=0;(h=this[_])!=null;_++)h.nodeType===1&&(I.cleanData(Ni(h,!1)),h.textContent="");return this},clone:function(h,_){return h=h==null?!1:h,_=_==null?h:_,this.map(function(){return I.clone(this,h,_)})},html:function(h){return li(this,function(_){var S=this[0]||{},v=0,w=this.length;if(_===void 0&&S.nodeType===1)return S.innerHTML;if(typeof _=="string"&&!Qd.test(_)&&!hi[($l.exec(_)||["",""])[1].toLowerCase()]){_=I.htmlPrefilter(_);try{for(;v<w;v++)S=this[v]||{},S.nodeType===1&&(I.cleanData(Ni(S,!1)),S.innerHTML=_);S=0}catch{}}S&&this.empty().append(_)},null,h,arguments.length)},replaceWith:function(){var h=[];return os(this,arguments,function(_){var S=this.parentNode;I.inArray(this,h)<0&&(I.cleanData(Ni(this)),S&&S.replaceChild(_,this))},h)}}),I.each({appendTo:"append",prependTo:"prepend",insertBefore:"before",insertAfter:"after",replaceAll:"replaceWith"},function(h,_){I.fn[h]=function(S){for(var v,w=[],O=I(S),P=O.length-1,j=0;j<=P;j++)v=j===P?this:this.clone(!0),I(O[j])[_](v),ma.apply(w,v.get());return this.pushStack(w)}});var Rc=new RegExp("^("+Jd+")(?!px)[a-z%]+$","i"),yo=/^--/,Cc=function(h){var _=h.ownerDocument.defaultView;return(!_||!_.opener)&&(_=gt),_.getComputedStyle(h)},ah=function(h,_,S){var v,w,O={};for(w in _)O[w]=h.style[w],h.style[w]=_[w];v=S.call(h);for(w in _)h.style[w]=O[w];return v},br=new RegExp(Ir.join("|"),"i");(function(){function h(){if(!!q){F.style.cssText="position:absolute;left:-11111px;width:60px;margin-top:1px;padding:0;border:0",q.style.cssText="position:relative;display:block;box-sizing:border-box;overflow:scroll;margin:auto;border:1px;padding:1px;width:60%;top:1%",Co.appendChild(F).appendChild(q);var rt=gt.getComputedStyle(q);S=rt.top!=="1%",j=_(rt.marginLeft)===12,q.style.right="60%",O=_(rt.right)===36,v=_(rt.width)===36,q.style.position="absolute",w=_(q.offsetWidth/3)===12,Co.removeChild(F),q=null}}function _(rt){return Math.round(parseFloat(rt))}var S,v,w,O,P,j,F=ce.createElement("div"),q=ce.createElement("div");!q.style||(q.style.backgroundClip="content-box",q.cloneNode(!0).style.backgroundClip="",Lt.clearCloneStyle=q.style.backgroundClip==="content-box",I.extend(Lt,{boxSizingReliable:function(){return h(),v},pixelBoxStyles:function(){return h(),O},pixelPosition:function(){return h(),S},reliableMarginLeft:function(){return h(),j},scrollboxSize:function(){return h(),w},reliableTrDimensions:function(){var rt,dt,$,St;return P==null&&(rt=ce.createElement("table"),dt=ce.createElement("tr"),$=ce.createElement("div"),rt.style.cssText="position:absolute;left:-11111px;border-collapse:separate",dt.style.cssText="box-sizing:content-box;border:1px solid",dt.style.height="1px",$.style.height="9px",$.style.display="block",Co.appendChild(rt).appendChild(dt).appendChild($),St=gt.getComputedStyle(dt),P=parseInt(St.height,10)+parseInt(St.borderTopWidth,10)+parseInt(St.borderBottomWidth,10)===dt.offsetHeight,Co.removeChild(rt)),P}}))})();function Ca(h,_,S){var v,w,O,P,j=yo.test(_),F=h.style;return S=S||Cc(h),S&&(P=S.getPropertyValue(_)||S[_],j&&P&&(P=P.replace(pn,"$1")||void 0),P===""&&!Yi(h)&&(P=I.style(h,_)),!Lt.pixelBoxStyles()&&Rc.test(P)&&br.test(_)&&(v=F.width,w=F.minWidth,O=F.maxWidth,F.minWidth=F.maxWidth=F.width=P,P=S.width,F.width=v,F.minWidth=w,F.maxWidth=O)),P!==void 0?P+"":P}function ch(h,_){return{get:function(){if(h()){delete this.get;return}return(this.get=_).apply(this,arguments)}}}var Dn=["Webkit","Moz","ms"],dh=ce.createElement("div").style,uh={};function d_(h){for(var _=h[0].toUpperCase()+h.slice(1),S=Dn.length;S--;)if(h=Dn[S]+_,h in dh)return h}function tu(h){var _=I.cssProps[h]||uh[h];return _||(h in dh?h:uh[h]=d_(h)||h)}var eu=/^(none|table(?!-c[ea]).+)/,u_={position:"absolute",visibility:"hidden",display:"block"},nu={letterSpacing:"0",fontWeight:"400"};function lh(h,_,S){var v=Os.exec(_);return v?Math.max(0,v[2]-(S||0))+(v[3]||"px"):_}function iu(h,_,S,v,w,O){var P=_==="width"?1:0,j=0,F=0,q=0;if(S===(v?"border":"content"))return 0;for(;P<4;P+=2)S==="margin"&&(q+=I.css(h,S+Ir[P],!0,w)),v?(S==="content"&&(F-=I.css(h,"padding"+Ir[P],!0,w)),S!=="margin"&&(F-=I.css(h,"border"+Ir[P]+"Width",!0,w))):(F+=I.css(h,"padding"+Ir[P],!0,w),S!=="padding"?F+=I.css(h,"border"+Ir[P]+"Width",!0,w):j+=I.css(h,"border"+Ir[P]+"Width",!0,w));return!v&&O>=0&&(F+=Math.max(0,Math.ceil(h["offset"+_[0].toUpperCase()+_.slice(1)]-O-F-j-.5))||0),F+q}function hh(h,_,S){var v=Cc(h),w=!Lt.boxSizingReliable()||S,O=w&&I.css(h,"boxSizing",!1,v)==="border-box",P=O,j=Ca(h,_,v),F="offset"+_[0].toUpperCase()+_.slice(1);if(Rc.test(j)){if(!S)return j;j="auto"}return(!Lt.boxSizingReliable()&&O||!Lt.reliableTrDimensions()&&Sn(h,"tr")||j==="auto"||!parseFloat(j)&&I.css(h,"display",!1,v)==="inline")&&h.getClientRects().length&&(O=I.css(h,"boxSizing",!1,v)==="border-box",P=F in h,P&&(j=h[F])),j=parseFloat(j)||0,j+iu(h,_,S||(O?"border":"content"),P,v,j)+"px"}I.extend({cssHooks:{opacity:{get:function(h,_){if(_){var S=Ca(h,"opacity");return S===""?"1":S}}}},cssNumber:{animationIterationCount:!0,aspectRatio:!0,borderImageSlice:!0,columnCount:!0,flexGrow:!0,flexShrink:!0,fontWeight:!0,gridArea:!0,gridColumn:!0,gridColumnEnd:!0,gridColumnStart:!0,gridRow:!0,gridRowEnd:!0,gridRowStart:!0,lineHeight:!0,opacity:!0,order:!0,orphans:!0,scale:!0,widows:!0,zIndex:!0,zoom:!0,fillOpacity:!0,floodOpacity:!0,stopOpacity:!0,strokeMiterlimit:!0,strokeOpacity:!0},cssProps:{},style:function(h,_,S,v){if(!(!h||h.nodeType===3||h.nodeType===8||!h.style)){var w,O,P,j=Bn(_),F=yo.test(_),q=h.style;if(F||(_=tu(j)),P=I.cssHooks[_]||I.cssHooks[j],S!==void 0){if(O=typeof S,O==="string"&&(w=Os.exec(S))&&w[1]&&(S=Ql(h,_,w),O="number"),S==null||S!==S)return;O==="number"&&!F&&(S+=w&&w[3]||(I.cssNumber[j]?"":"px")),!Lt.clearCloneStyle&&S===""&&_.indexOf("background")===0&&(q[_]="inherit"),(!P||!("set"in P)||(S=P.set(h,S,v))!==void 0)&&(F?q.setProperty(_,S):q[_]=S)}else return P&&"get"in P&&(w=P.get(h,!1,v))!==void 0?w:q[_]}},css:function(h,_,S,v){var w,O,P,j=Bn(_),F=yo.test(_);return F||(_=tu(j)),P=I.cssHooks[_]||I.cssHooks[j],P&&"get"in P&&(w=P.get(h,!0,S)),w===void 0&&(w=Ca(h,_,v)),w==="normal"&&_ in nu&&(w=nu[_]),S===""||S?(O=parseFloat(w),S===!0||isFinite(O)?O||0:w):w}}),I.each(["height","width"],function(h,_){I.cssHooks[_]={get:function(S,v,w){if(v)return eu.test(I.css(S,"display"))&&(!S.getClientRects().length||!S.getBoundingClientRect().width)?ah(S,u_,function(){return hh(S,_,w)}):hh(S,_,w)},set:function(S,v,w){var O,P=Cc(S),j=!Lt.scrollboxSize()&&P.position==="absolute",F=j||w,q=F&&I.css(S,"boxSizing",!1,P)==="border-box",rt=w?iu(S,_,w,q,P):0;return q&&j&&(rt-=Math.ceil(S["offset"+_[0].toUpperCase()+_.slice(1)]-parseFloat(P[_])-iu(S,_,"border",!1,P)-.5)),rt&&(O=Os.exec(v))&&(O[3]||"px")!=="px"&&(S.style[_]=v,v=I.css(S,_)),lh(S,v,rt)}}}),I.cssHooks.marginLeft=ch(Lt.reliableMarginLeft,function(h,_){if(_)return(parseFloat(Ca(h,"marginLeft"))||h.getBoundingClientRect().left-ah(h,{marginLeft:0},function(){return h.getBoundingClientRect().left}))+"px"}),I.each({margin:"",padding:"",border:"Width"},function(h,_){I.cssHooks[h+_]={expand:function(S){for(var v=0,w={},O=typeof S=="string"?S.split(" "):[S];v<4;v++)w[h+Ir[v]+_]=O[v]||O[v-2]||O[0];return w}},h!=="margin"&&(I.cssHooks[h+_].set=lh)}),I.fn.extend({css:function(h,_){return li(this,function(S,v,w){var O,P,j={},F=0;if(Array.isArray(v)){for(O=Cc(S),P=v.length;F<P;F++)j[v[F]]=I.css(S,v[F],!1,O);return j}return w!==void 0?I.style(S,v,w):I.css(S,v)},h,_,arguments.length>1)}});function Xn(h,_,S,v,w){return new Xn.prototype.init(h,_,S,v,w)}I.Tween=Xn,Xn.prototype={constructor:Xn,init:function(h,_,S,v,w,O){this.elem=h,this.prop=S,this.easing=w||I.easing._default,this.options=_,this.start=this.now=this.cur(),this.end=v,this.unit=O||(I.cssNumber[S]?"":"px")},cur:function(){var h=Xn.propHooks[this.prop];return h&&h.get?h.get(this):Xn.propHooks._default.get(this)},run:function(h){var _,S=Xn.propHooks[this.prop];return this.options.duration?this.pos=_=I.easing[this.easing](h,this.options.duration*h,0,1,this.options.duration):this.pos=_=h,this.now=(this.end-this.start)*_+this.start,this.options.step&&this.options.step.call(this.elem,this.now,this),S&&S.set?S.set(this):Xn.propHooks._default.set(this),this}},Xn.prototype.init.prototype=Xn.prototype,Xn.propHooks={_default:{get:function(h){var _;return h.elem.nodeType!==1||h.elem[h.prop]!=null&&h.elem.style[h.prop]==null?h.elem[h.prop]:(_=I.css(h.elem,h.prop,""),!_||_==="auto"?0:_)},set:function(h){I.fx.step[h.prop]?I.fx.step[h.prop](h):h.elem.nodeType===1&&(I.cssHooks[h.prop]||h.elem.style[tu(h.prop)]!=null)?I.style(h.elem,h.prop,h.now+h.unit):h.elem[h.prop]=h.now}}},Xn.propHooks.scrollTop=Xn.propHooks.scrollLeft={set:function(h){h.elem.nodeType&&h.elem.parentNode&&(h.elem[h.prop]=h.now)}},I.easing={linear:function(h){return h},swing:function(h){return .5-Math.cos(h*Math.PI)/2},_default:"swing"},I.fx=Xn.prototype.init,I.fx.step={};var Io,vc,Ze=/^(?:toggle|show|hide)$/,l_=/queueHooks$/;function yc(){vc&&(ce.hidden===!1&&gt.requestAnimationFrame?gt.requestAnimationFrame(yc):gt.setTimeout(yc,I.fx.interval),I.fx.tick())}function ru(){return gt.setTimeout(function(){Io=void 0}),Io=Date.now()}function Ic(h,_){var S,v=0,w={height:h};for(_=_?1:0;v<4;v+=2-_)S=Ir[v],w["margin"+S]=w["padding"+S]=h;return _&&(w.opacity=w.width=h),w}function ph(h,_,S){for(var v,w=(ur.tweeners[_]||[]).concat(ur.tweeners["*"]),O=0,P=w.length;O<P;O++)if(v=w[O].call(S,_,h))return v}function h_(h,_,S){var v,w,O,P,j,F,q,rt,dt="width"in _||"height"in _,$=this,St={},ie=h.style,Ce=h.nodeType&&Tc(h),Te=jt.get(h,"fxshow");S.queue||(P=I._queueHooks(h,"fx"),P.unqueued==null&&(P.unqueued=0,j=P.empty.fire,P.empty.fire=function(){P.unqueued||j()}),P.unqueued++,$.always(function(){$.always(function(){P.unqueued--,I.queue(h,"fx").length||P.empty.fire()})}));for(v in _)if(w=_[v],Ze.test(w)){if(delete _[v],O=O||w==="toggle",w===(Ce?"hide":"show"))if(w==="show"&&Te&&Te[v]!==void 0)Ce=!0;else continue;St[v]=Te&&Te[v]||I.style(h,v)}if(F=!I.isEmptyObject(_),!(!F&&I.isEmptyObject(St))){dt&&h.nodeType===1&&(S.overflow=[ie.overflow,ie.overflowX,ie.overflowY],q=Te&&Te.display,q==null&&(q=jt.get(h,"display")),rt=I.css(h,"display"),rt==="none"&&(q?rt=q:(Ns([h],!0),q=h.style.display||q,rt=I.css(h,"display"),Ns([h]))),(rt==="inline"||rt==="inline-block"&&q!=null)&&I.css(h,"float")==="none"&&(F||($.done(function(){ie.display=q}),q==null&&(rt=ie.display,q=rt==="none"?"":rt)),ie.display="inline-block")),S.overflow&&(ie.overflow="hidden",$.always(function(){ie.overflow=S.overflow[0],ie.overflowX=S.overflow[1],ie.overflowY=S.overflow[2]})),F=!1;for(v in St)F||(Te?"hidden"in Te&&(Ce=Te.hidden):Te=jt.access(h,"fxshow",{display:q}),O&&(Te.hidden=!Ce),Ce&&Ns([h],!0),$.done(function(){Ce||Ns([h]),jt.remove(h,"fxshow");for(v in St)I.style(h,v,St[v])})),F=ph(Ce?Te[v]:0,v,$),v in Te||(Te[v]=F.start,Ce&&(F.end=F.start,F.start=0))}}function p_(h,_){var S,v,w,O,P;for(S in h)if(v=Bn(S),w=_[v],O=h[S],Array.isArray(O)&&(w=O[1],O=h[S]=O[0]),S!==v&&(h[v]=O,delete h[S]),P=I.cssHooks[v],P&&"expand"in P){O=P.expand(O),delete h[v];for(S in O)S in h||(h[S]=O[S],_[S]=w)}else _[v]=w}function ur(h,_,S){var v,w,O=0,P=ur.prefilters.length,j=I.Deferred().always(function(){delete F.elem}),F=function(){if(w)return!1;for(var dt=Io||ru(),$=Math.max(0,q.startTime+q.duration-dt),St=$/q.duration||0,ie=1-St,Ce=0,Te=q.tweens.length;Ce<Te;Ce++)q.tweens[Ce].run(ie);return j.notifyWith(h,[q,ie,$]),ie<1&&Te?$:(Te||j.notifyWith(h,[q,1,0]),j.resolveWith(h,[q]),!1)},q=j.promise({elem:h,props:I.extend({},_),opts:I.extend(!0,{specialEasing:{},easing:I.easing._default},S),originalProperties:_,originalOptions:S,startTime:Io||ru(),duration:S.duration,tweens:[],createTween:function(dt,$){var St=I.Tween(h,q.opts,dt,$,q.opts.specialEasing[dt]||q.opts.easing);return q.tweens.push(St),St},stop:function(dt){var $=0,St=dt?q.tweens.length:0;if(w)return this;for(w=!0;$<St;$++)q.tweens[$].run(1);return dt?(j.notifyWith(h,[q,1,0]),j.resolveWith(h,[q,dt])):j.rejectWith(h,[q,dt]),this}}),rt=q.props;for(p_(rt,q.opts.specialEasing);O<P;O++)if(v=ur.prefilters[O].call(q,h,rt,q.opts),v)return _e(v.stop)&&(I._queueHooks(q.elem,q.opts.queue).stop=v.stop.bind(v)),v;return I.map(rt,ph,q),_e(q.opts.start)&&q.opts.start.call(h,q),q.progress(q.opts.progress).done(q.opts.done,q.opts.complete).fail(q.opts.fail).always(q.opts.always),I.fx.timer(I.extend(F,{elem:h,anim:q,queue:q.opts.queue})),q}I.Animation=I.extend(ur,{tweeners:{"*":[function(h,_){var S=this.createTween(h,_);return Ql(S.elem,h,Os.exec(_),S),S}]},tweener:function(h,_){_e(h)?(_=h,h=["*"]):h=h.match(yr);for(var S,v=0,w=h.length;v<w;v++)S=h[v],ur.tweeners[S]=ur.tweeners[S]||[],ur.tweeners[S].unshift(_)},prefilters:[h_],prefilter:function(h,_){_?ur.prefilters.unshift(h):ur.prefilters.push(h)}}),I.speed=function(h,_,S){var v=h&&typeof h=="object"?I.extend({},h):{complete:S||!S&&_||_e(h)&&h,duration:h,easing:S&&_||_&&!_e(_)&&_};return I.fx.off?v.duration=0:typeof v.duration!="number"&&(v.duration in I.fx.speeds?v.duration=I.fx.speeds[v.duration]:v.duration=I.fx.speeds._default),(v.queue==null||v.queue===!0)&&(v.queue="fx"),v.old=v.complete,v.complete=function(){_e(v.old)&&v.old.call(this),v.queue&&I.dequeue(this,v.queue)},v},I.fn.extend({fadeTo:function(h,_,S,v){return this.filter(Tc).css("opacity",0).show().end().animate({opacity:_},h,S,v)},animate:function(h,_,S,v){var w=I.isEmptyObject(h),O=I.speed(_,S,v),P=function(){var j=ur(this,I.extend({},h),O);(w||jt.get(this,"finish"))&&j.stop(!0)};return P.finish=P,w||O.queue===!1?this.each(P):this.queue(O.queue,P)},stop:function(h,_,S){var v=function(w){var O=w.stop;delete w.stop,O(S)};return typeof h!="string"&&(S=_,_=h,h=void 0),_&&this.queue(h||"fx",[]),this.each(function(){var w=!0,O=h!=null&&h+"queueHooks",P=I.timers,j=jt.get(this);if(O)j[O]&&j[O].stop&&v(j[O]);else for(O in j)j[O]&&j[O].stop&&l_.test(O)&&v(j[O]);for(O=P.length;O--;)P[O].elem===this&&(h==null||P[O].queue===h)&&(P[O].anim.stop(S),w=!1,P.splice(O,1));(w||!S)&&I.dequeue(this,h)})},finish:function(h){return h!==!1&&(h=h||"fx"),this.each(function(){var _,S=jt.get(this),v=S[h+"queue"],w=S[h+"queueHooks"],O=I.timers,P=v?v.length:0;for(S.finish=!0,I.queue(this,h,[]),w&&w.stop&&w.stop.call(this,!0),_=O.length;_--;)O[_].elem===this&&O[_].queue===h&&(O[_].anim.stop(!0),O.splice(_,1));for(_=0;_<P;_++)v[_]&&v[_].finish&&v[_].finish.call(this);delete S.finish})}}),I.each(["toggle","show","hide"],function(h,_){var S=I.fn[_];I.fn[_]=function(v,w,O){return v==null||typeof v=="boolean"?S.apply(this,arguments):this.animate(Ic(_,!0),v,w,O)}}),I.each({slideDown:Ic("show"),slideUp:Ic("hide"),slideToggle:Ic("toggle"),fadeIn:{opacity:"show"},fadeOut:{opacity:"hide"},fadeToggle:{opacity:"toggle"}},function(h,_){I.fn[h]=function(S,v,w){return this.animate(_,S,v,w)}}),I.timers=[],I.fx.tick=function(){var h,_=0,S=I.timers;for(Io=Date.now();_<S.length;_++)h=S[_],!h()&&S[_]===h&&S.splice(_--,1);S.length||I.fx.stop(),Io=void 0},I.fx.timer=function(h){I.timers.push(h),I.fx.start()},I.fx.interval=13,I.fx.start=function(){vc||(vc=!0,yc())},I.fx.stop=function(){vc=null},I.fx.speeds={slow:600,fast:200,_default:400},I.fn.delay=function(h,_){return h=I.fx&&I.fx.speeds[h]||h,_=_||"fx",this.queue(_,function(S,v){var w=gt.setTimeout(S,h);v.stop=function(){gt.clearTimeout(w)}})},function(){var h=ce.createElement("input"),_=ce.createElement("select"),S=_.appendChild(ce.createElement("option"));h.type="checkbox",Lt.checkOn=h.value!=="",Lt.optSelected=S.selected,h=ce.createElement("input"),h.value="t",h.type="radio",Lt.radioValue=h.value==="t"}();var fh,bo=I.expr.attrHandle;I.fn.extend({attr:function(h,_){return li(this,I.attr,h,_,arguments.length>1)},removeAttr:function(h){return this.each(function(){I.removeAttr(this,h)})}}),I.extend({attr:function(h,_,S){var v,w,O=h.nodeType;if(!(O===3||O===8||O===2)){if(typeof h.getAttribute=="undefined")return I.prop(h,_,S);if((O!==1||!I.isXMLDoc(h))&&(w=I.attrHooks[_.toLowerCase()]||(I.expr.match.bool.test(_)?fh:void 0)),S!==void 0){if(S===null){I.removeAttr(h,_);return}return w&&"set"in w&&(v=w.set(h,S,_))!==void 0?v:(h.setAttribute(_,S+""),S)}return w&&"get"in w&&(v=w.get(h,_))!==null?v:(v=I.find.attr(h,_),v==null?void 0:v)}},attrHooks:{type:{set:function(h,_){if(!Lt.radioValue&&_==="radio"&&Sn(h,"input")){var S=h.value;return h.setAttribute("type",_),S&&(h.value=S),_}}}},removeAttr:function(h,_){var S,v=0,w=_&&_.match(yr);if(w&&h.nodeType===1)for(;S=w[v++];)h.removeAttribute(S)}}),fh={set:function(h,_,S){return _===!1?I.removeAttr(h,S):h.setAttribute(S,S),S}},I.each(I.expr.match.bool.source.match(/\w+/g),function(h,_){var S=bo[_]||I.find.attr;bo[_]=function(v,w,O){var P,j,F=w.toLowerCase();return O||(j=bo[F],bo[F]=P,P=S(v,w,O)!=null?F:null,bo[F]=j),P}});var _h=/^(?:input|select|textarea|button)$/i,ou=/^(?:a|area)$/i;I.fn.extend({prop:function(h,_){return li(this,I.prop,h,_,arguments.length>1)},removeProp:function(h){return this.each(function(){delete this[I.propFix[h]||h]})}}),I.extend({prop:function(h,_,S){var v,w,O=h.nodeType;if(!(O===3||O===8||O===2))return(O!==1||!I.isXMLDoc(h))&&(_=I.propFix[_]||_,w=I.propHooks[_]),S!==void 0?w&&"set"in w&&(v=w.set(h,S,_))!==void 0?v:h[_]=S:w&&"get"in w&&(v=w.get(h,_))!==null?v:h[_]},propHooks:{tabIndex:{get:function(h){var _=I.find.attr(h,"tabindex");return _?parseInt(_,10):_h.test(h.nodeName)||ou.test(h.nodeName)&&h.href?0:-1}}},propFix:{for:"htmlFor",class:"className"}}),Lt.optSelected||(I.propHooks.selected={get:function(h){var _=h.parentNode;return _&&_.parentNode&&_.parentNode.selectedIndex,null},set:function(h){var _=h.parentNode;_&&(_.selectedIndex,_.parentNode&&_.parentNode.selectedIndex)}}),I.each(["tabIndex","readOnly","maxLength","cellSpacing","cellPadding","rowSpan","colSpan","useMap","frameBorder","contentEditable"],function(){I.propFix[this.toLowerCase()]=this});function ss(h){var _=h.match(yr)||[];return _.join(" ")}function to(h){return h.getAttribute&&h.getAttribute("class")||""}function su(h){return Array.isArray(h)?h:typeof h=="string"?h.match(yr)||[]:[]}I.fn.extend({addClass:function(h){var _,S,v,w,O,P;return _e(h)?this.each(function(j){I(this).addClass(h.call(this,j,to(this)))}):(_=su(h),_.length?this.each(function(){if(v=to(this),S=this.nodeType===1&&" "+ss(v)+" ",S){for(O=0;O<_.length;O++)w=_[O],S.indexOf(" "+w+" ")<0&&(S+=w+" ");P=ss(S),v!==P&&this.setAttribute("class",P)}}):this)},removeClass:function(h){var _,S,v,w,O,P;return _e(h)?this.each(function(j){I(this).removeClass(h.call(this,j,to(this)))}):arguments.length?(_=su(h),_.length?this.each(function(){if(v=to(this),S=this.nodeType===1&&" "+ss(v)+" ",S){for(O=0;O<_.length;O++)for(w=_[O];S.indexOf(" "+w+" ")>-1;)S=S.replace(" "+w+" "," ");P=ss(S),v!==P&&this.setAttribute("class",P)}}):this):this.attr("class","")},toggleClass:function(h,_){var S,v,w,O,P=typeof h,j=P==="string"||Array.isArray(h);return _e(h)?this.each(function(F){I(this).toggleClass(h.call(this,F,to(this),_),_)}):typeof _=="boolean"&&j?_?this.addClass(h):this.removeClass(h):(S=su(h),this.each(function(){if(j)for(O=I(this),w=0;w<S.length;w++)v=S[w],O.hasClass(v)?O.removeClass(v):O.addClass(v);else(h===void 0||P==="boolean")&&(v=to(this),v&&jt.set(this,"__className__",v),this.setAttribute&&this.setAttribute("class",v||h===!1?"":jt.get(this,"__className__")||""))}))},hasClass:function(h){var _,S,v=0;for(_=" "+h+" ";S=this[v++];)if(S.nodeType===1&&(" "+ss(to(S))+" ").indexOf(_)>-1)return!0;return!1}});var Eh=/\r/g;I.fn.extend({val:function(h){var _,S,v,w=this[0];return arguments.length?(v=_e(h),this.each(function(O){var P;this.nodeType===1&&(v?P=h.call(this,O,I(this).val()):P=h,P==null?P="":typeof P=="number"?P+="":Array.isArray(P)&&(P=I.map(P,function(j){return j==null?"":j+""})),_=I.valHooks[this.type]||I.valHooks[this.nodeName.toLowerCase()],(!_||!("set"in _)||_.set(this,P,"value")===void 0)&&(this.value=P))})):w?(_=I.valHooks[w.type]||I.valHooks[w.nodeName.toLowerCase()],_&&"get"in _&&(S=_.get(w,"value"))!==void 0?S:(S=w.value,typeof S=="string"?S.replace(Eh,""):S==null?"":S)):void 0}}),I.extend({valHooks:{option:{get:function(h){var _=I.find.attr(h,"value");return _!=null?_:ss(I.text(h))}},select:{get:function(h){var _,S,v,w=h.options,O=h.selectedIndex,P=h.type==="select-one",j=P?null:[],F=P?O+1:w.length;for(O<0?v=F:v=P?O:0;v<F;v++)if(S=w[v],(S.selected||v===O)&&!S.disabled&&(!S.parentNode.disabled||!Sn(S.parentNode,"optgroup"))){if(_=I(S).val(),P)return _;j.push(_)}return j},set:function(h,_){for(var S,v,w=h.options,O=I.makeArray(_),P=w.length;P--;)v=w[P],(v.selected=I.inArray(I.valHooks.option.get(v),O)>-1)&&(S=!0);return S||(h.selectedIndex=-1),O}}}}),I.each(["radio","checkbox"],function(){I.valHooks[this]={set:function(h,_){if(Array.isArray(_))return h.checked=I.inArray(I(h).val(),_)>-1}},Lt.checkOn||(I.valHooks[this].get=function(h){return h.getAttribute("value")===null?"on":h.value})});var va=gt.location,mh={guid:Date.now()},au=/\?/;I.parseXML=function(h){var _,S;if(!h||typeof h!="string")return null;try{_=new gt.DOMParser().parseFromString(h,"text/xml")}catch{}return S=_&&_.getElementsByTagName("parsererror")[0],(!_||S)&&I.error("Invalid XML: "+(S?I.map(S.childNodes,function(v){return v.textContent}).join(`
`):h)),_};var gh=/^(?:focusinfocus|focusoutblur)$/,Th=function(h){h.stopPropagation()};I.extend(I.event,{trigger:function(h,_,S,v){var w,O,P,j,F,q,rt,dt,$=[S||ce],St=Ge.call(h,"type")?h.type:h,ie=Ge.call(h,"namespace")?h.namespace.split("."):[];if(O=dt=P=S=S||ce,!(S.nodeType===3||S.nodeType===8)&&!gh.test(St+I.event.triggered)&&(St.indexOf(".")>-1&&(ie=St.split("."),St=ie.shift(),ie.sort()),F=St.indexOf(":")<0&&"on"+St,h=h[I.expando]?h:new I.Event(St,typeof h=="object"&&h),h.isTrigger=v?2:3,h.namespace=ie.join("."),h.rnamespace=h.namespace?new RegExp("(^|\\.)"+ie.join("\\.(?:.*\\.|)")+"(\\.|$)"):null,h.result=void 0,h.target||(h.target=S),_=_==null?[h]:I.makeArray(_,[h]),rt=I.event.special[St]||{},!(!v&&rt.trigger&&rt.trigger.apply(S,_)===!1))){if(!v&&!rt.noBubble&&!Zo(S)){for(j=rt.delegateType||St,gh.test(j+St)||(O=O.parentNode);O;O=O.parentNode)$.push(O),P=O;P===(S.ownerDocument||ce)&&$.push(P.defaultView||P.parentWindow||gt)}for(w=0;(O=$[w++])&&!h.isPropagationStopped();)dt=O,h.type=w>1?j:rt.bindType||St,q=(jt.get(O,"events")||Object.create(null))[h.type]&&jt.get(O,"handle"),q&&q.apply(O,_),q=F&&O[F],q&&q.apply&&ts(O)&&(h.result=q.apply(O,_),h.result===!1&&h.preventDefault());return h.type=St,!v&&!h.isDefaultPrevented()&&(!rt._default||rt._default.apply($.pop(),_)===!1)&&ts(S)&&F&&_e(S[St])&&!Zo(S)&&(P=S[F],P&&(S[F]=null),I.event.triggered=St,h.isPropagationStopped()&&dt.addEventListener(St,Th),S[St](),h.isPropagationStopped()&&dt.removeEventListener(St,Th),I.event.triggered=void 0,P&&(S[F]=P)),h.result}},simulate:function(h,_,S){var v=I.extend(new I.Event,S,{type:h,isSimulated:!0});I.event.trigger(v,null,_)}}),I.fn.extend({trigger:function(h,_){return this.each(function(){I.event.trigger(h,_,this)})},triggerHandler:function(h,_){var S=this[0];if(S)return I.event.trigger(h,_,S,!0)}});var f_=/\[\]$/,Sh=/\r?\n/g,__=/^(?:submit|button|image|reset|file)$/i,Rh=/^(?:input|select|textarea|keygen)/i;function cu(h,_,S,v){var w;if(Array.isArray(_))I.each(_,function(O,P){S||f_.test(h)?v(h,P):cu(h+"["+(typeof P=="object"&&P!=null?O:"")+"]",P,S,v)});else if(!S&&$o(_)==="object")for(w in _)cu(h+"["+w+"]",_[w],S,v);else v(h,_)}I.param=function(h,_){var S,v=[],w=function(O,P){var j=_e(P)?P():P;v[v.length]=encodeURIComponent(O)+"="+encodeURIComponent(j==null?"":j)};if(h==null)return"";if(Array.isArray(h)||h.jquery&&!I.isPlainObject(h))I.each(h,function(){w(this.name,this.value)});else for(S in h)cu(S,h[S],_,w);return v.join("&")},I.fn.extend({serialize:function(){return I.param(this.serializeArray())},serializeArray:function(){return this.map(function(){var h=I.prop(this,"elements");return h?I.makeArray(h):this}).filter(function(){var h=this.type;return this.name&&!I(this).is(":disabled")&&Rh.test(this.nodeName)&&!__.test(h)&&(this.checked||!Ra.test(h))}).map(function(h,_){var S=I(this).val();return S==null?null:Array.isArray(S)?I.map(S,function(v){return{name:_.name,value:v.replace(Sh,`\r
`)}}):{name:_.name,value:S.replace(Sh,`\r
`)}}).get()}});var E_=/%20/g,m_=/#.*$/,ya=/([?&])_=[^&]*/,g_=/^(.*?):[ \t]*([^\r\n]*)$/mg,T_=/^(?:about|app|app-storage|.+-extension|file|res|widget):$/,S_=/^(?:GET|HEAD)$/,R_=/^\/\//,du={},uu={},Ch="*/".concat("*"),lu=ce.createElement("a");lu.href=va.href;function eo(h){return function(_,S){typeof _!="string"&&(S=_,_="*");var v,w=0,O=_.toLowerCase().match(yr)||[];if(_e(S))for(;v=O[w++];)v[0]==="+"?(v=v.slice(1)||"*",(h[v]=h[v]||[]).unshift(S)):(h[v]=h[v]||[]).push(S)}}function Fi(h,_,S,v){var w={},O=h===uu;function P(j){var F;return w[j]=!0,I.each(h[j]||[],function(q,rt){var dt=rt(_,S,v);if(typeof dt=="string"&&!O&&!w[dt])return _.dataTypes.unshift(dt),P(dt),!1;if(O)return!(F=dt)}),F}return P(_.dataTypes[0])||!w["*"]&&P("*")}function bc(h,_){var S,v,w=I.ajaxSettings.flatOptions||{};for(S in _)_[S]!==void 0&&((w[S]?h:v||(v={}))[S]=_[S]);return v&&I.extend(!0,h,v),h}function C_(h,_,S){for(var v,w,O,P,j=h.contents,F=h.dataTypes;F[0]==="*";)F.shift(),v===void 0&&(v=h.mimeType||_.getResponseHeader("Content-Type"));if(v){for(w in j)if(j[w]&&j[w].test(v)){F.unshift(w);break}}if(F[0]in S)O=F[0];else{for(w in S){if(!F[0]||h.converters[w+" "+F[0]]){O=w;break}P||(P=w)}O=O||P}if(O)return O!==F[0]&&F.unshift(O),S[O]}function v_(h,_,S,v){var w,O,P,j,F,q={},rt=h.dataTypes.slice();if(rt[1])for(P in h.converters)q[P.toLowerCase()]=h.converters[P];for(O=rt.shift();O;)if(h.responseFields[O]&&(S[h.responseFields[O]]=_),!F&&v&&h.dataFilter&&(_=h.dataFilter(_,h.dataType)),F=O,O=rt.shift(),O){if(O==="*")O=F;else if(F!=="*"&&F!==O){if(P=q[F+" "+O]||q["* "+O],!P){for(w in q)if(j=w.split(" "),j[1]===O&&(P=q[F+" "+j[0]]||q["* "+j[0]],P)){P===!0?P=q[w]:q[w]!==!0&&(O=j[0],rt.unshift(j[1]));break}}if(P!==!0)if(P&&h.throws)_=P(_);else try{_=P(_)}catch(dt){return{state:"parsererror",error:P?dt:"No conversion from "+F+" to "+O}}}}return{state:"success",data:_}}I.extend({active:0,lastModified:{},etag:{},ajaxSettings:{url:va.href,type:"GET",isLocal:T_.test(va.protocol),global:!0,processData:!0,async:!0,contentType:"application/x-www-form-urlencoded; charset=UTF-8",accepts:{"*":Ch,text:"text/plain",html:"text/html",xml:"application/xml, text/xml",json:"application/json, text/javascript"},contents:{xml:/\bxml\b/,html:/\bhtml/,json:/\bjson\b/},responseFields:{xml:"responseXML",text:"responseText",json:"responseJSON"},converters:{"* text":String,"text html":!0,"text json":JSON.parse,"text xml":I.parseXML},flatOptions:{url:!0,context:!0}},ajaxSetup:function(h,_){return _?bc(bc(h,I.ajaxSettings),_):bc(I.ajaxSettings,h)},ajaxPrefilter:eo(du),ajaxTransport:eo(uu),ajax:function(h,_){typeof h=="object"&&(_=h,h=void 0),_=_||{};var S,v,w,O,P,j,F,q,rt,dt,$=I.ajaxSetup({},_),St=$.context||$,ie=$.context&&(St.nodeType||St.jquery)?I(St):I.event,Ce=I.Deferred(),Te=I.Callbacks("once memory"),Pn=$.statusCode||{},Wn={},Ar={},$t="canceled",Le={readyState:0,getResponseHeader:function(xe){var Ln;if(F){if(!O)for(O={};Ln=g_.exec(w);)O[Ln[1].toLowerCase()+" "]=(O[Ln[1].toLowerCase()+" "]||[]).concat(Ln[2]);Ln=O[xe.toLowerCase()+" "]}return Ln==null?null:Ln.join(", ")},getAllResponseHeaders:function(){return F?w:null},setRequestHeader:function(xe,Ln){return F==null&&(xe=Ar[xe.toLowerCase()]=Ar[xe.toLowerCase()]||xe,Wn[xe]=Ln),this},overrideMimeType:function(xe){return F==null&&($.mimeType=xe),this},statusCode:function(xe){var Ln;if(xe)if(F)Le.always(xe[Le.status]);else for(Ln in xe)Pn[Ln]=[Pn[Ln],xe[Ln]];return this},abort:function(xe){var Ln=xe||$t;return S&&S.abort(Ln),as(0,Ln),this}};if(Ce.promise(Le),$.url=((h||$.url||va.href)+"").replace(R_,va.protocol+"//"),$.type=_.method||_.type||$.method||$.type,$.dataTypes=($.dataType||"*").toLowerCase().match(yr)||[""],$.crossDomain==null){j=ce.createElement("a");try{j.href=$.url,j.href=j.href,$.crossDomain=lu.protocol+"//"+lu.host!=j.protocol+"//"+j.host}catch{$.crossDomain=!0}}if($.data&&$.processData&&typeof $.data!="string"&&($.data=I.param($.data,$.traditional)),Fi(du,$,_,Le),F)return Le;q=I.event&&$.global,q&&I.active++===0&&I.event.trigger("ajaxStart"),$.type=$.type.toUpperCase(),$.hasContent=!S_.test($.type),v=$.url.replace(m_,""),$.hasContent?$.data&&$.processData&&($.contentType||"").indexOf("application/x-www-form-urlencoded")===0&&($.data=$.data.replace(E_,"+")):(dt=$.url.slice(v.length),$.data&&($.processData||typeof $.data=="string")&&(v+=(au.test(v)?"&":"?")+$.data,delete $.data),$.cache===!1&&(v=v.replace(ya,"$1"),dt=(au.test(v)?"&":"?")+"_="+mh.guid+++dt),$.url=v+dt),$.ifModified&&(I.lastModified[v]&&Le.setRequestHeader("If-Modified-Since",I.lastModified[v]),I.etag[v]&&Le.setRequestHeader("If-None-Match",I.etag[v])),($.data&&$.hasContent&&$.contentType!==!1||_.contentType)&&Le.setRequestHeader("Content-Type",$.contentType),Le.setRequestHeader("Accept",$.dataTypes[0]&&$.accepts[$.dataTypes[0]]?$.accepts[$.dataTypes[0]]+($.dataTypes[0]!=="*"?", "+Ch+"; q=0.01":""):$.accepts["*"]);for(rt in $.headers)Le.setRequestHeader(rt,$.headers[rt]);if($.beforeSend&&($.beforeSend.call(St,Le,$)===!1||F))return Le.abort();if($t="abort",Te.add($.complete),Le.done($.success),Le.fail($.error),S=Fi(uu,$,_,Le),!S)as(-1,"No Transport");else{if(Le.readyState=1,q&&ie.trigger("ajaxSend",[Le,$]),F)return Le;$.async&&$.timeout>0&&(P=gt.setTimeout(function(){Le.abort("timeout")},$.timeout));try{F=!1,S.send(Wn,as)}catch(xe){if(F)throw xe;as(-1,xe)}}function as(xe,Ln,cs,pu){var wr,Ia,zi,Ao,wo,ji=Ln;F||(F=!0,P&&gt.clearTimeout(P),S=void 0,w=pu||"",Le.readyState=xe>0?4:0,wr=xe>=200&&xe<300||xe===304,cs&&(Ao=C_($,Le,cs)),!wr&&I.inArray("script",$.dataTypes)>-1&&I.inArray("json",$.dataTypes)<0&&($.converters["text script"]=function(){}),Ao=v_($,Ao,Le,wr),wr?($.ifModified&&(wo=Le.getResponseHeader("Last-Modified"),wo&&(I.lastModified[v]=wo),wo=Le.getResponseHeader("etag"),wo&&(I.etag[v]=wo)),xe===204||$.type==="HEAD"?ji="nocontent":xe===304?ji="notmodified":(ji=Ao.state,Ia=Ao.data,zi=Ao.error,wr=!zi)):(zi=ji,(xe||!ji)&&(ji="error",xe<0&&(xe=0))),Le.status=xe,Le.statusText=(Ln||ji)+"",wr?Ce.resolveWith(St,[Ia,ji,Le]):Ce.rejectWith(St,[Le,ji,zi]),Le.statusCode(Pn),Pn=void 0,q&&ie.trigger(wr?"ajaxSuccess":"ajaxError",[Le,$,wr?Ia:zi]),Te.fireWith(St,[Le,ji]),q&&(ie.trigger("ajaxComplete",[Le,$]),--I.active||I.event.trigger("ajaxStop")))}return Le},getJSON:function(h,_,S){return I.get(h,_,S,"json")},getScript:function(h,_){return I.get(h,void 0,_,"script")}}),I.each(["get","post"],function(h,_){I[_]=function(S,v,w,O){return _e(v)&&(O=O||w,w=v,v=void 0),I.ajax(I.extend({url:S,type:_,dataType:O,data:v,success:w},I.isPlainObject(S)&&S))}}),I.ajaxPrefilter(function(h){var _;for(_ in h.headers)_.toLowerCase()==="content-type"&&(h.contentType=h.headers[_]||"")}),I._evalUrl=function(h,_,S){return I.ajax({url:h,type:"GET",dataType:"script",cache:!0,async:!1,global:!1,converters:{"text script":function(){}},dataFilter:function(v){I.globalEval(v,_,S)}})},I.fn.extend({wrapAll:function(h){var _;return this[0]&&(_e(h)&&(h=h.call(this[0])),_=I(h,this[0].ownerDocument).eq(0).clone(!0),this[0].parentNode&&_.insertBefore(this[0]),_.map(function(){for(var S=this;S.firstElementChild;)S=S.firstElementChild;return S}).append(this)),this},wrapInner:function(h){return _e(h)?this.each(function(_){I(this).wrapInner(h.call(this,_))}):this.each(function(){var _=I(this),S=_.contents();S.length?S.wrapAll(h):_.append(h)})},wrap:function(h){var _=_e(h);return this.each(function(S){I(this).wrapAll(_?h.call(this,S):h)})},unwrap:function(h){return this.parent(h).not("body").each(function(){I(this).replaceWith(this.childNodes)}),this}}),I.expr.pseudos.hidden=function(h){return!I.expr.pseudos.visible(h)},I.expr.pseudos.visible=function(h){return!!(h.offsetWidth||h.offsetHeight||h.getClientRects().length)},I.ajaxSettings.xhr=function(){try{return new gt.XMLHttpRequest}catch{}};var y_={0:200,1223:204},Gn=I.ajaxSettings.xhr();Lt.cors=!!Gn&&"withCredentials"in Gn,Lt.ajax=Gn=!!Gn,I.ajaxTransport(function(h){var _,S;if(Lt.cors||Gn&&!h.crossDomain)return{send:function(v,w){var O,P=h.xhr();if(P.open(h.type,h.url,h.async,h.username,h.password),h.xhrFields)for(O in h.xhrFields)P[O]=h.xhrFields[O];h.mimeType&&P.overrideMimeType&&P.overrideMimeType(h.mimeType),!h.crossDomain&&!v["X-Requested-With"]&&(v["X-Requested-With"]="XMLHttpRequest");for(O in v)P.setRequestHeader(O,v[O]);_=function(j){return function(){_&&(_=S=P.onload=P.onerror=P.onabort=P.ontimeout=P.onreadystatechange=null,j==="abort"?P.abort():j==="error"?typeof P.status!="number"?w(0,"error"):w(P.status,P.statusText):w(y_[P.status]||P.status,P.statusText,(P.responseType||"text")!=="text"||typeof P.responseText!="string"?{binary:P.response}:{text:P.responseText},P.getAllResponseHeaders()))}},P.onload=_(),S=P.onerror=P.ontimeout=_("error"),P.onabort!==void 0?P.onabort=S:P.onreadystatechange=function(){P.readyState===4&&gt.setTimeout(function(){_&&S()})},_=_("abort");try{P.send(h.hasContent&&h.data||null)}catch(j){if(_)throw j}},abort:function(){_&&_()}}}),I.ajaxPrefilter(function(h){h.crossDomain&&(h.contents.script=!1)}),I.ajaxSetup({accepts:{script:"text/javascript, application/javascript, application/ecmascript, application/x-ecmascript"},contents:{script:/\b(?:java|ecma)script\b/},converters:{"text script":function(h){return I.globalEval(h),h}}}),I.ajaxPrefilter("script",function(h){h.cache===void 0&&(h.cache=!1),h.crossDomain&&(h.type="GET")}),I.ajaxTransport("script",function(h){if(h.crossDomain||h.scriptAttrs){var _,S;return{send:function(v,w){_=I("<script>").attr(h.scriptAttrs||{}).prop({charset:h.scriptCharset,src:h.url}).on("load error",S=function(O){_.remove(),S=null,O&&w(O.type==="error"?404:200,O.type)}),ce.head.appendChild(_[0])},abort:function(){S&&S()}}}});var vh=[],hu=/(=)\?(?=&|$)|\?\?/;I.ajaxSetup({jsonp:"callback",jsonpCallback:function(){var h=vh.pop()||I.expando+"_"+mh.guid++;return this[h]=!0,h}}),I.ajaxPrefilter("json jsonp",function(h,_,S){var v,w,O,P=h.jsonp!==!1&&(hu.test(h.url)?"url":typeof h.data=="string"&&(h.contentType||"").indexOf("application/x-www-form-urlencoded")===0&&hu.test(h.data)&&"data");if(P||h.dataTypes[0]==="jsonp")return v=h.jsonpCallback=_e(h.jsonpCallback)?h.jsonpCallback():h.jsonpCallback,P?h[P]=h[P].replace(hu,"$1"+v):h.jsonp!==!1&&(h.url+=(au.test(h.url)?"&":"?")+h.jsonp+"="+v),h.converters["script json"]=function(){return O||I.error(v+" was not called"),O[0]},h.dataTypes[0]="json",w=gt[v],gt[v]=function(){O=arguments},S.always(function(){w===void 0?I(gt).removeProp(v):gt[v]=w,h[v]&&(h.jsonpCallback=_.jsonpCallback,vh.push(v)),O&&_e(w)&&w(O[0]),O=w=void 0}),"script"}),Lt.createHTMLDocument=function(){var h=ce.implementation.createHTMLDocument("").body;return h.innerHTML="<form></form><form></form>",h.childNodes.length===2}(),I.parseHTML=function(h,_,S){if(typeof h!="string")return[];typeof _=="boolean"&&(S=_,_=!1);var v,w,O;return _||(Lt.createHTMLDocument?(_=ce.implementation.createHTMLDocument(""),v=_.createElement("base"),v.href=ce.location.href,_.head.appendChild(v)):_=ce),w=qd.exec(h),O=!S&&[],w?[_.createElement(w[1])]:(w=eh([h],_,O),O&&O.length&&I(O).remove(),I.merge([],w.childNodes))},I.fn.load=function(h,_,S){var v,w,O,P=this,j=h.indexOf(" ");return j>-1&&(v=ss(h.slice(j)),h=h.slice(0,j)),_e(_)?(S=_,_=void 0):_&&typeof _=="object"&&(w="POST"),P.length>0&&I.ajax({url:h,type:w||"GET",dataType:"html",data:_}).done(function(F){O=arguments,P.html(v?I("<div>").append(I.parseHTML(F)).find(v):F)}).always(S&&function(F,q){P.each(function(){S.apply(this,O||[F.responseText,q,F])})}),this},I.expr.pseudos.animated=function(h){return I.grep(I.timers,function(_){return h===_.elem}).length},I.offset={setOffset:function(h,_,S){var v,w,O,P,j,F,q,rt=I.css(h,"position"),dt=I(h),$={};rt==="static"&&(h.style.position="relative"),j=dt.offset(),O=I.css(h,"top"),F=I.css(h,"left"),q=(rt==="absolute"||rt==="fixed")&&(O+F).indexOf("auto")>-1,q?(v=dt.position(),P=v.top,w=v.left):(P=parseFloat(O)||0,w=parseFloat(F)||0),_e(_)&&(_=_.call(h,S,I.extend({},j))),_.top!=null&&($.top=_.top-j.top+P),_.left!=null&&($.left=_.left-j.left+w),"using"in _?_.using.call(h,$):dt.css($)}},I.fn.extend({offset:function(h){if(arguments.length)return h===void 0?this:this.each(function(w){I.offset.setOffset(this,h,w)});var _,S,v=this[0];if(!!v)return v.getClientRects().length?(_=v.getBoundingClientRect(),S=v.ownerDocument.defaultView,{top:_.top+S.pageYOffset,left:_.left+S.pageXOffset}):{top:0,left:0}},position:function(){if(!!this[0]){var h,_,S,v=this[0],w={top:0,left:0};if(I.css(v,"position")==="fixed")_=v.getBoundingClientRect();else{for(_=this.offset(),S=v.ownerDocument,h=v.offsetParent||S.documentElement;h&&(h===S.body||h===S.documentElement)&&I.css(h,"position")==="static";)h=h.parentNode;h&&h!==v&&h.nodeType===1&&(w=I(h).offset(),w.top+=I.css(h,"borderTopWidth",!0),w.left+=I.css(h,"borderLeftWidth",!0))}return{top:_.top-w.top-I.css(v,"marginTop",!0),left:_.left-w.left-I.css(v,"marginLeft",!0)}}},offsetParent:function(){return this.map(function(){for(var h=this.offsetParent;h&&I.css(h,"position")==="static";)h=h.offsetParent;return h||Co})}}),I.each({scrollLeft:"pageXOffset",scrollTop:"pageYOffset"},function(h,_){var S=_==="pageYOffset";I.fn[h]=function(v){return li(this,function(w,O,P){var j;if(Zo(w)?j=w:w.nodeType===9&&(j=w.defaultView),P===void 0)return j?j[_]:w[O];j?j.scrollTo(S?j.pageXOffset:P,S?P:j.pageYOffset):w[O]=P},h,v,arguments.length)}}),I.each(["top","left"],function(h,_){I.cssHooks[_]=ch(Lt.pixelPosition,function(S,v){if(v)return v=Ca(S,_),Rc.test(v)?I(S).position()[_]+"px":v})}),I.each({Height:"height",Width:"width"},function(h,_){I.each({padding:"inner"+h,content:_,"":"outer"+h},function(S,v){I.fn[v]=function(w,O){var P=arguments.length&&(S||typeof w!="boolean"),j=S||(w===!0||O===!0?"margin":"border");return li(this,function(F,q,rt){var dt;return Zo(F)?v.indexOf("outer")===0?F["inner"+h]:F.document.documentElement["client"+h]:F.nodeType===9?(dt=F.documentElement,Math.max(F.body["scroll"+h],dt["scroll"+h],F.body["offset"+h],dt["offset"+h],dt["client"+h])):rt===void 0?I.css(F,q,j):I.style(F,q,rt,j)},_,P?w:void 0,P)}})}),I.each(["ajaxStart","ajaxStop","ajaxComplete","ajaxError","ajaxSuccess","ajaxSend"],function(h,_){I.fn[_]=function(S){return this.on(_,S)}}),I.fn.extend({bind:function(h,_,S){return this.on(h,null,_,S)},unbind:function(h,_){return this.off(h,null,_)},delegate:function(h,_,S,v){return this.on(_,h,S,v)},undelegate:function(h,_,S){return arguments.length===1?this.off(h,"**"):this.off(_,h||"**",S)},hover:function(h,_){return this.on("mouseenter",h).on("mouseleave",_||h)}}),I.each("blur focus focusin focusout resize scroll click dblclick mousedown mouseup mousemove mouseover mouseout mouseenter mouseleave change select submit keydown keypress keyup contextmenu".split(" "),function(h,_){I.fn[_]=function(S,v){return arguments.length>0?this.on(_,null,S,v):this.trigger(_)}});var I_=/^[\s\uFEFF\xA0]+|([^\s\uFEFF\xA0])[\s\uFEFF\xA0]+$/g;I.proxy=function(h,_){var S,v,w;if(typeof _=="string"&&(S=h[_],_=h,h=S),!!_e(h))return v=Pt.call(arguments,2),w=function(){return h.apply(_||this,v.concat(Pt.call(arguments)))},w.guid=h.guid=h.guid||I.guid++,w},I.holdReady=function(h){h?I.readyWait++:I.ready(!0)},I.isArray=Array.isArray,I.parseJSON=JSON.parse,I.nodeName=Sn,I.isFunction=_e,I.isWindow=Zo,I.camelCase=Bn,I.type=$o,I.now=Date.now,I.isNumeric=function(h){var _=I.type(h);return(_==="number"||_==="string")&&!isNaN(h-parseFloat(h))},I.trim=function(h){return h==null?"":(h+"").replace(I_,"$1")};var Ac=gt.jQuery,yh=gt.$;return I.noConflict=function(h){return gt.$===I&&(gt.$=yh),h&&gt.jQuery===I&&(gt.jQuery=Ac),I},typeof ge=="undefined"&&(gt.jQuery=gt.$=I),I})})(uP);var aS=uP.exports;window.jQuery=window.$=aS;var So,Ea,Gl=null,Wl=null,Gd;class q3{constructor(){rS(this,"_events",{});rS(this,"addListener",this.on)}getListeners(gt){return this._events[gt]?this._events[gt].map(ge=>ge.listener):[]}on(gt,ge){this._events[gt]||(this._events[gt]=[]);const Ut=this._events[gt];this._indexOfListener(Ut,ge)===-1&&Ut.push({listener:ge,once:!1})}once(gt,ge){this._events[gt]||(this._events[gt]=[]);const Ut=this._events[gt];this._indexOfListener(Ut,ge)===-1&&Ut.push({listener:ge,once:!0})}off(gt,ge){if(!this._events[gt])return;const Ut=this._events[gt],Dt=this._indexOfListener(Ut,ge);Dt!==-1&&Ut.splice(Dt,1),this._events[gt].length===0&&delete this._events[gt]}removeAllListeners(gt){if(!gt){this._events={};return}delete this._events[gt]}emit(gt,...ge){this._events[gt]||(this._events[gt]=[]);const Ut=this._events[gt].map(Dt=>Dt);for(let Dt=0;Dt<Ut.length;Dt+=1){const Pt=Ut[Dt];Pt.once&&this.off(gt,Pt.listener),Pt.listener.apply(this,ge||[])}}safeEmit(gt,...ge){[...this._events[gt]||[]].forEach(Dt=>{Dt.once&&this.off(gt,Dt.listener);try{Dt.listener.apply(this,ge)}catch(Pt){console.error(`[webapp] safeEmit event:${gt} error ${Pt==null?void 0:Pt.toString()}`)}})}_indexOfListener(gt,ge){let Ut=gt.length;for(;Ut--;)if(gt[Ut].listener===ge)return Ut;return-1}}window.__TrackEventListener=new q3;class Y3 extends RTCPeerConnection{constructor(...gt){super(...gt),gt.length>=2&&gt[1].optional[0].googDscp==!0?this.__agora=!0:this.__agora=!1,this.addEventListener("track",ge=>{"__TrackEventListener"in self&&self.__TrackEventListener.emit("track",this,ge)})}}window.RTCPeerConnection=Y3;__TrackEventListener.on("track",(Qt,gt)=>{if(Qt.__agora){console.log("[webapp]: skip agora PC ...");return}gt.track.kind=="audio"?Z3(gt.track):gt.track.kind=="video"&&$3(gt.track)});aS(document).ready(async function(){let Qt=new URL(document.location).searchParams;if(!Qt.get("url")){console.error("[webapp] url not specified"),console.debug("WebappMagic=WhiteLoginError");return}let gt=Qt.get("url");if(console.log("[webapp] url=",gt),!Qt.get("timeout"))Gd=60;else{let ge=parseInt(Qt.get("timeout"));ge!=NaN?Gd=Math.max(0,Math.min(ge,60)):Gd=60}console.log("[webapp] timeout=",Gd),await Q3(),Ea=new TXLivePlayer,Ea.setPlayListener({onPlayStats:z3,onPlayEvent:J3,onPlayReport:X3}),Ea.setPlayerView("video-box"),Ea.setConfig({showLog:!0,connectRetryCount:65535}),Ea.setControls(!1),Ea.startPlay(decodeURIComponent(gt)),Ea.setMute(!1),Ea.setVolume(100),setInterval(nH,500)});var lP=Date.now()/1e3;function z3(Qt){lP=Date.now()/1e3}function J3(Qt){}function X3(Qt){}async function Q3(){So=sS.createClient({mode:"live",codec:"vp8"}),So.on({event:"exception",listener:tH});let Qt=new URL(document.location).searchParams;if(!Qt.get("appid")){console.error("[webapp] appid not specified"),console.debug("WebappMagic=WhiteLoginError");return}if(!Qt.get("cname")){console.error("[webapp] cname not specified"),console.debug("WebappMagic=WhiteLoginError");return}Qt.get("uid")||console.log("[webapp] uid not specified"),Qt.get("token")||console.log("[webapp] token not specified");let gt=Qt.get("appid"),ge=Qt.get("cname"),Ut=Qt.get("uid");if(Ut=Ut==""?null:Ut,Ut!=null){let wi=parseInt(Ut);wi!=NaN&&(Ut=wi)}let Dt=Qt.get("token");Dt=Dt==""?null:Dt,So.setClientRole("host");let Pt;try{Pt=await So.join(gt,ge,Dt||null,Ut||null)}catch(wi){console.error("[webapp] join() failed, reason: "+wi),console.debug("WebappMagic=WhiteLoginError");return}console.log("[webapp] join channel with uid="+Pt+" ("+typeof Pt+")")}function Z3(Qt){console.log("[webapp] new audio track is added ...",JSON.stringify(Qt)),Gl=sS.createCustomAudioTrack({mediaStreamTrack:Qt.clone()})}function $3(Qt){console.log("[webapp] new video track is added ...",JSON.stringify(Qt)),Wl=sS.createCustomVideoTrack({mediaStreamTrack:Qt.clone(),optimizationMode:"motion"})}function tH(Qt){console.log("[webapp] exception:",Qt)}var xl=null,Vl=null,oS=0,oP=Date.now()/1e3,eH=Date.now()/1e3,sP=!1;async function nH(){oS++;let Qt=Date.now()/1e3;aS("#video-box video").length>0&&Qt-lP<3&&(typeof window.navigator.notifyReady=="function"&&!sP&&(console.log("[webapp] notifyReady(): video player is ready"),window.navigator.notifyReady(),sP=!0),oP=Qt);let gt=Qt-oP;gt>5&&oS%10==0&&console.warn("[webapp] stream pull downtime exceeds "+gt.toString()+" sec"),gt>Gd&&console.debug("WebappMagic=WhiteDisconnected"),So._p2pChannel.connection&&So._p2pChannel.connection.peerConnection&&So._p2pChannel.connection.peerConnection.connectionState=="connected"&&(lastPublising=Qt);let ge=Qt-eH;if(ge>5&&oS%10==0&&console.warn("[webapp] stream push downtime exceeds "+ge.toString()+" sec"),ge>Gd&&console.debug("WebappMagic=WhiteDisconnected"),xl!=Gl){if(xl!=null){console.log("[webapp] unpublish audio track ...",JSON.stringify(xl));try{await So.unpublish(xl)}catch(Ut){console.error("[webapp] unpublish exception:",Ut.toString())}}console.log("[webapp] publish audio track ...",JSON.stringify(Gl));try{await So.publish(Gl)}catch(Ut){console.error("[webapp] publish exception",Ut.toString())}xl=Gl}if(Vl!=Wl){if(Vl!=null){console.log("[webapp] unpublish video track ...",JSON.stringify(Vl));try{await So.unpublish(Vl)}catch(Ut){console.error("[webapp] unpublish exception:",Ut.toString())}}console.log("[webapp] publish video track ...",JSON.stringify(Wl));try{await So.publish(Wl)}catch(Ut){console.error("[webapp] publish exception",Ut.toString())}Vl=Wl}}
