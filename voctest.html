<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>è¯æ±‡ç»ƒä¹  - æ–‡ä»¶ä¸Šä¼ éšæœºæµ‹è¯•</title>
  <style>
    :root {
      --bg: #0f172a;
      --panel: #111827;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --accent: #3b82f6;
      --green: #43a047;
      --red: #e53935;
      --border: #1f2937;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      background: linear-gradient(135deg, #0f172a 0%, #0b1220 60%, #10213a 100%);
      color: var(--text);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Ubuntu, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
      line-height: 1.6;
    }
    header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
      background: #0b1220;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    header h1 { margin: 0; font-size: 18px; font-weight: 600; }
    main {
      max-width: 900px;
      margin: 24px auto;
      padding: 0 16px;
      min-height: calc(100vh - 80px);
    }
    
    /* é¡µé¢å®¹å™¨æ ·å¼ */
    .page {
      display: none;
      width: 100%;
      height: 100%;
    }
    .page.active {
      display: block;
    }

    .card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
    }
    .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
    label { color: var(--muted); font-size: 14px; }
    input[type="file"] {
      padding: 10px;
      background: #0f1628;
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
    }
    .hint { color: var(--muted); font-size: 13px; margin-top: 8px; }
    .dropzone {
      margin-top: 10px;
      padding: 16px;
      border: 2px dashed var(--border);
      border-radius: 12px;
      text-align: center;
      color: var(--muted);
      background: #0f1628;
    }
    .dropzone.dragover {
      border-color: var(--accent);
      background: rgba(59,130,246,0.12);
      color: var(--text);
    }

    /* URL åˆ—è¡¨æ ·å¼ */
    .url-card h3 { margin: 0 0 8px; font-size: 16px; }
    .url-editor { margin-top: 10px; }
    .url-editor textarea {
      width: 100%;
      min-height: 96px;
      background: #0f1628;
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      padding: 10px;
      font-family: ui-monospace, Menlo, Monaco, Consolas, "Courier New", monospace;
    }
    .url-actions { margin-top: 8px; display: flex; gap: 8px; }
    .url-list { margin-top: 12px; display: flex; flex-wrap: wrap; gap: 8px; }
    .chip {
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #0f1628;
      color: var(--text);
      cursor: pointer;
      font-size: 14px;
    }
    .chip:hover { filter: brightness(1.1); }

    .info { display: flex; gap: 16px; align-items: center; color: var(--muted); font-size: 14px; }
    .info .badge { background: #0f1628; border: 1px solid var(--border); padding: 4px 8px; border-radius: 6px; color: var(--text); }

    .term {
      margin: 28px 0;
      font-size: 56px;
      font-weight: 800;
      text-align: center;
      letter-spacing: 0.5px;
      min-height: 72px;
    }

    .actions { display: flex; justify-content: center; gap: 14px; }
    .btn {
      padding: 12px 18px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #0f1628;
      color: var(--text);
      cursor: pointer;
      font-size: 18px;
      transition: transform .05s ease, filter .15s ease;
    }
    .btn:active { transform: scale(0.98); }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-wrong { background: var(--red); color: white; border-color: #c62828; }
    .btn-right { background: var(--green); color: white; border-color: #2e7d32; }
    .btn-accent { background: var(--accent); color: white; border-color: #2563eb; }

    .feedback {
      text-align: center;
      min-height: 28px;
      color: #ffd54f;
      font-size: 20px;
      font-weight: 700;
    }

    .results { margin-top: 24px; }
    .summary { display: flex; flex-wrap: wrap; gap: 14px; margin: 12px 0 18px; }
    .summary .item { background: #0f1628; border: 1px solid var(--border); padding: 8px 12px; border-radius: 8px; }

    table { width: 100%; border-collapse: collapse; }
    th, td { border-bottom: 1px solid var(--border); padding: 10px 8px; text-align: left; }
    th { color: var(--muted); font-weight: 600; }
    tbody tr:hover { background: #0f1628; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    tr.wrong { background: rgba(229,57,53,0.12); }
    
    /* é¡µé¢åˆ‡æ¢åŠ¨ç”» */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .page.active {
      animation: fadeIn 0.3s ease-out;
    }
  </style>
  <script>
    let items = [];
    let remaining = [];
    let currentIndex = null;
    let startTime = null;
    let total = 0;
    let mistakes = 0;
    let perStats = new Map();

    const el = (id) => document.getElementById(id);
    const defaultUrls = [
        'https://coin0.github.io/eng/grade1a_starter.txt',
        'https://coin0.github.io/eng/grade1a_unit1.txt',
        'https://coin0.github.io/eng/grade1a_unit2.txt',
        'https://coin0.github.io/eng/grade1a_unit3.txt',
        'https://coin0.github.io/eng/grade1a_unit4.txt',
        'https://coin0.github.io/eng/grade1a_unit5.txt',
        'https://coin0.github.io/eng/grade1a_unit6.txt',
        'https://coin0.github.io/eng/grade1a_unit7.txt',
        'https://coin0.github.io/eng/grade1a_unit8.txt',
        'https://coin0.github.io/eng/grade1a_unit9.txt',
        'https://coin0.github.io/eng/nce3a.txt',
        'https://coin0.github.io/eng/nce3b.txt',
        'https://coin0.github.io/eng/nce3c.txt',
        'https://coin0.github.io/eng/nce3d.txt',
        'https://coin0.github.io/eng/nce4a.txt',
        'https://coin0.github.io/eng/nce4b.txt',
        'https://coin0.github.io/eng/nce4c.txt',
        'https://coin0.github.io/eng/nce4d.txt',
        'https://coin0.github.io/eng/nce4e.txt',
    ];
    
    // é¡µé¢åˆ‡æ¢å‡½æ•°
    function showPage(pageId) {
      // éšè—æ‰€æœ‰é¡µé¢
      document.querySelectorAll('.page').forEach(page => {
        page.classList.remove('active');
      });
      // æ˜¾ç¤ºæŒ‡å®šé¡µé¢
      const page = el(pageId);
      if (page) {
        page.classList.add('active');
      }
    }

    function resetAll() {
      items = [];
      remaining = [];
      currentIndex = null;
      startTime = null;
      total = 0;
      mistakes = 0;
      perStats = new Map();
      el('term').textContent = '';
      el('progress').textContent = 'è¿›åº¦ï¼š0/0';
      el('mistakes').textContent = 'é”™è¯¯ï¼š0';
      el('fileName').textContent = '';
      el('btnWrong').disabled = true;
      el('btnRight').disabled = true;
      el('btnEnd').disabled = true;
      if (el('fileInput')) el('fileInput').value = '';
    }

    function parseLines(text) {
      return text
        .split(/\r?\n/)
        .map(l => l.trim())
        .filter(l => l.length > 0);
    }

    function startQuiz(data, fileLabel) {
      items = data.slice();
      total = items.length;
      remaining = Array.from({ length: total }, (_, i) => i);
      mistakes = 0;
      perStats = new Map();
      el('fileName').textContent = fileLabel ? `æ–‡ä»¶ï¼š${fileLabel}` : '';
      el('progress').textContent = `è¿›åº¦ï¼š0/${total}`;
      el('mistakes').textContent = `é”™è¯¯ï¼š0`;
      
      // åˆ‡æ¢åˆ°æµ‹è¯•é¡µé¢
      showPage('quizPage');
      
      el('btnEnd').disabled = false;
      showNext();
    }

    function pickRandomRemainingIndex() {
      const idx = Math.floor(Math.random() * remaining.length);
      return remaining[idx];
    }

    function showNext() {
      if (remaining.length === 0) {
        finishQuiz();
        return;
      }
      const next = pickRandomRemainingIndex();
      currentIndex = next;
      el('term').textContent = items[currentIndex];
      el('btnWrong').disabled = false;
      el('btnRight').disabled = false;
      startTime = performance.now();
    }

    function answer(correct) {
      if (currentIndex === null || startTime === null) return;
      const durationMs = performance.now() - startTime;
      const text = items[currentIndex];
      const stat = perStats.get(text) || { count: 0, mistakes: 0, totalTimeMs: 0 };
      stat.count += 1;
      if (!correct) { stat.mistakes += 1; mistakes += 1; }
      stat.totalTimeMs += durationMs;
      perStats.set(text, stat);

      const pos = remaining.indexOf(currentIndex);
      if (pos !== -1) remaining.splice(pos, 1);

      el('progress').textContent = `è¿›åº¦ï¼š${total - remaining.length}/${total}`;
      el('mistakes').textContent = `é”™è¯¯ï¼š${mistakes}`;

      currentIndex = null;
      startTime = null;
      showFeedback(correct, durationMs);

      if (remaining.length > 0) {
        showNext();
      } else {
        finishQuiz();
      }
    }

    function showFeedback(correct, ms) {
      const fb = el('feedback');
      if (!fb) return;
      fb.textContent = correct ? `å¤ªæ£’äº†ï¼ğŸ‘ (${(ms/1000).toFixed(2)}s)` : `æ²¡å…³ç³»ï¼Œå†è¯•è¯•ï¼ğŸ’ª (${(ms/1000).toFixed(2)}s)`;
      fb.style.opacity = '1';
      setTimeout(() => { fb.style.opacity = '0'; }, 800);
    }

    function finishQuiz() {
      el('btnWrong').disabled = true;
      el('btnRight').disabled = true;
      el('btnEnd').disabled = true;
      renderResults();
      
      // åˆ‡æ¢åˆ°ç»“æœé¡µé¢
      showPage('resultsPage');
    }

    function endQuizNow() {
      // æå‰ç»“æŸï¼šä¸å†ç»§ç»­å‰©ä½™é¢˜ç›®ï¼Œç›´æ¥å‡ºç»“æœ
      el('btnWrong').disabled = true;
      el('btnRight').disabled = true;
      el('btnEnd').disabled = true;
      remaining = [];
      renderResults();
      
      // åˆ‡æ¢åˆ°ç»“æœé¡µé¢
      showPage('resultsPage');
    }

    function renderResults() {
      const answeredCount = total - remaining.length;
      const totalAnswers = answeredCount;
      const errorRate = totalAnswers === 0 ? 0 : (mistakes / totalAnswers) * 100;
      const score = Math.max(0, Math.round(100 - errorRate));
      el('summaryTotal').textContent = `æ€»é¢˜æ•°ï¼š${totalAnswers}`;
      el('summaryMistakes').textContent = `é”™è¯¯æ•°ï¼š${mistakes}`;
      el('summaryErrorRate').textContent = `é”™è¯¯ç‡ï¼š${errorRate.toFixed(2)}%`;
      const scoreEl = el('summaryScore');
      if (scoreEl) scoreEl.textContent = `å¾—åˆ†ï¼š${score}/100`;

      const tbody = el('resultBody');
      tbody.innerHTML = '';
      const rows = [];
      for (const [text, stat] of perStats.entries()) {
        const avgSec = stat.count ? (stat.totalTimeMs / stat.count) / 1000 : 0;
        rows.push({ text, avgSec, count: stat.count, mistakes: stat.mistakes });
      }
      rows.sort((a, b) => {
        const wrongA = a.mistakes > 0 ? 1 : 0;
        const wrongB = b.mistakes > 0 ? 1 : 0;
        if (wrongA !== wrongB) return wrongB - wrongA; // é”™é¢˜ç½®é¡¶
        if (a.mistakes !== b.mistakes) return b.mistakes - a.mistakes; // é”™è¯¯æ¬¡æ•°å¤šçš„æ›´é å‰
        return a.text.localeCompare(b.text);
      });
      for (const r of rows) {
        const tr = document.createElement('tr');
        if (r.mistakes > 0) tr.classList.add('wrong');
        const tdText = document.createElement('td');
        tdText.textContent = r.text;
        tdText.className = 'mono';
        const tdAvg = document.createElement('td');
        tdAvg.textContent = r.avgSec.toFixed(3);
        const tdCnt = document.createElement('td');
        tdCnt.textContent = r.count;
        const tdMis = document.createElement('td');
        tdMis.textContent = r.mistakes;
        tr.appendChild(tdText);
        tr.appendChild(tdAvg);
        tr.appendChild(tdCnt);
        tr.appendChild(tdMis);
        tbody.appendChild(tr);
      }
    }

    window.addEventListener('DOMContentLoaded', () => {
      // åˆå§‹æ˜¾ç¤ºé€‰æ‹©é¡µé¢
      showPage('uploadPage');
      resetAll();
      
      const fileInput = el('fileInput');
      fileInput.addEventListener('change', async (e) => {
        const file = e.target.files && e.target.files[0];
        if (!file) return;
        await handleFile(file);
      });

      const dropzone = el('dropzone');
      const uploadCard = el('uploadPage');
      const prevent = (ev) => { ev.preventDefault(); ev.stopPropagation(); };
      ['dragenter','dragover'].forEach(evName => {
        uploadCard.addEventListener(evName, (ev) => { prevent(ev); dropzone.classList.add('dragover'); });
        dropzone.addEventListener(evName, (ev) => { prevent(ev); dropzone.classList.add('dragover'); });
      });
      ['dragleave','drop'].forEach(evName => {
        uploadCard.addEventListener(evName, (ev) => { prevent(ev); dropzone.classList.remove('dragover'); });
        dropzone.addEventListener(evName, (ev) => { prevent(ev); dropzone.classList.remove('dragover'); });
      });
      dropzone.addEventListener('drop', async (ev) => {
        const file = ev.dataTransfer && ev.dataTransfer.files && ev.dataTransfer.files[0];
        if (!file) return;
        await handleFile(file);
      });

      async function handleFile(file) {
        resetAll();
        try {
          const text = await file.text();
          const lines = parseLines(text);
          if (lines.length === 0) {
            alert('æ–‡ä»¶å†…å®¹ä¸ºç©ºæˆ–åªæœ‰ç©ºè¡Œï¼Œè¯·é‡è¯•ã€‚');
            return;
          }
          startQuiz(lines, file.name);
        } catch (err) {
          alert('è¯»å–æ–‡ä»¶å¤±è´¥ï¼Œè¯·é‡è¯•ã€‚');
          console.error(err);
        }
      }

      // åˆå§‹åŒ–ä¸æ¸²æŸ“ URL åˆ—è¡¨
      const urlInput = el('urlListInput');
      const urlSaveBtn = el('urlListSave');
      const urlList = el('urlList');
      if (urlInput) urlInput.value = defaultUrls.join('\n');

      function getUrlsFromTextarea() {
        return urlInput.value
          .split(/\r?\n/)
          .map(s => s.trim())
          .filter(s => s.length > 0);
      }

      function renderUrlList() {
        const urls = getUrlsFromTextarea();
        urlList.innerHTML = '';
        urls.forEach(url => {
          const chip = document.createElement('button');
          chip.className = 'chip';
          chip.textContent = url;
          chip.title = 'ç‚¹å‡»ä»æ­¤URLè¯»å–å¹¶å¼€å§‹æµ‹è¯•';
          chip.addEventListener('click', () => loadUrl(url));
          urlList.appendChild(chip);
        });
      }

      async function loadUrl(url) {
        resetAll();
        try {
          const resp = await fetch(url);
          if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
          const text = await resp.text();
          const lines = parseLines(text);
          if (lines.length === 0) {
            alert('URLå†…å®¹ä¸ºç©ºæˆ–åªæœ‰ç©ºè¡Œï¼Œè¯·æ£€æŸ¥æ–‡ä»¶ã€‚');
            return;
          }
          startQuiz(lines, url);
        } catch (err) {
          alert('ä»URLè¯»å–å¤±è´¥ï¼Œè¯·ç¡®è®¤åœ°å€å¯è®¿é—®ä¸”å…è®¸è·¨åŸŸã€‚');
          console.error(err);
        }
      }

      if (urlSaveBtn) urlSaveBtn.addEventListener('click', renderUrlList);
      renderUrlList();

      el('btnWrong').addEventListener('click', () => answer(false));
      el('btnRight').addEventListener('click', () => answer(true));

      document.addEventListener('keydown', (e) => {
        // åªæœ‰åœ¨æµ‹è¯•é¡µé¢æ—¶æ‰å“åº”å¿«æ·é”®
        if (!el('quizPage').classList.contains('active')) return;
        if (remaining.length === 0) return;
        if (e.key === 'ArrowLeft') answer(false);
        if (e.key === 'ArrowRight' || e.key === ' ') answer(true);
        if (e.key === 'Escape') endQuizNow();
      });

      el('restartBtn').addEventListener('click', () => {
        resetAll();
        // è¿”å›é€‰æ‹©é¡µé¢
        showPage('uploadPage');
      });
      
      el('btnEnd').addEventListener('click', () => endQuizNow());
      
      // æ·»åŠ è¿”å›é€‰æ‹©é¡µé¢çš„æŒ‰é’®äº‹ä»¶
      el('backToSelect').addEventListener('click', () => {
        resetAll();
        showPage('uploadPage');
      });
    });
  </script>
</head>
<body>
  <header>
    <h1>è¯æ±‡ç»ƒä¹  ğŸ¶ğŸ”¤ï¼ˆä¸Šä¼ æ–‡ä»¶ï¼Œæ¯è¡Œä¸€ä¸ªè¯/å¥ï¼‰</h1>
  </header>
  <main>
    <!-- é€‰æ‹©é¡µé¢ -->
    <section class="page active" id="uploadPage">
      <div class="card">
        <div class="row">
          <label for="fileInput">ä¸Šä¼ æ–‡æœ¬æ–‡ä»¶ï¼ˆ.txt/.csvï¼‰ï¼Œè¯»å–åè‡ªåŠ¨å¼€å§‹</label>
          <input type="file" id="fileInput" accept=".txt,.csv" />
        </div>
        <p class="hint">æ¯ä¸€è¡Œä½œä¸ºä¸€ä¸ªè¯æ¡ï¼Œç©ºè¡Œä¼šè¢«å¿½ç•¥ã€‚</p>
        <div id="dropzone" class="dropzone">å°†æ–‡ä»¶æ‹–æ‹½åˆ°è¿™é‡Œå¼€å§‹æµ‹è¯• ğŸ“¥</div>
        <div class="url-card">
          <h3>ä»URLè¯»å–ï¼ˆç‚¹å‡»ä¸‹æ–¹é“¾æ¥å¼€å§‹ï¼‰</h3>
          <div class="url-editor">
            <textarea id="urlListInput" placeholder="æ¯è¡Œä¸€ä¸ªURLï¼Œä¾‹å¦‚:\nhttps://localhost/unit1.txt\nhttps://localhost/unit2.txt"></textarea>
            <div class="url-actions">
              <button id="urlListSave" class="btn">ä¿å­˜å¹¶åˆ·æ–°åˆ—è¡¨</button>
            </div>
          </div>
          <div id="urlList" class="url-list"></div>
          <p class="hint">æç¤ºï¼šURLéœ€å¯ç›´æ¥è®¿é—®æ–‡æœ¬æ–‡ä»¶ï¼Œå†…å®¹æŒ‰è¡Œè¯»å–ã€‚</p>
        </div>
      </div>
    </section>

    <!-- æµ‹è¯•é¡µé¢ -->
    <section class="page" id="quizPage">
      <div class="card">
        <div class="info">
          <span class="badge" id="fileName"></span>
          <span id="progress">è¿›åº¦ï¼š0/0</span>
          <span id="mistakes">é”™è¯¯ï¼š0</span>
        </div>
        <div class="term" id="term"></div>
        <div class="feedback" id="feedback"></div>
        <div class="actions">
          <button id="btnWrong" class="btn btn-wrong" disabled>å¿˜è®°äº†</button>
          <button id="btnRight" class="btn btn-right" disabled>æŒæ¡äº†</button>
          <button id="btnEnd" class="btn btn-accent" disabled>ç»“æŸæµ‹è¯•</button>
        </div>
        <p class="hint" style="text-align:center;margin-top:8px;">å¿«æ·é”®ï¼šâ† å¿˜è®°äº†ï¼Œâ†’ æˆ–ç©ºæ ¼ æŒæ¡äº†ï¼ŒEsc ç»“æŸæµ‹è¯•</p>
      </div>
    </section>

    <!-- ç»“æœé¡µé¢ -->
    <section class="page" id="resultsPage">
      <div class="card results">
        <h2>æµ‹è¯•ç»“æœ</h2>
        <div class="summary">
          <span class="item" id="summaryTotal"></span>
          <span class="item" id="summaryMistakes"></span>
          <span class="item" id="summaryErrorRate"></span>
          <span class="item" id="summaryScore"></span>
        </div>
        <table>
          <thead>
            <tr>
              <th>è¯æ¡</th>
              <th>å¹³å‡å›ç­”æ—¶é—´ï¼ˆç§’ï¼‰</th>
              <th>å‡ºç°æ¬¡æ•°</th>
              <th>é”™è¯¯æ¬¡æ•°</th>
            </tr>
          </thead>
          <tbody id="resultBody"></tbody>
        </table>
        <div style="margin-top: 12px; display: flex; gap: 10px;">
          <button id="restartBtn" class="btn">é‡æ–°å¼€å§‹</button>
          <button id="backToSelect" class="btn btn-accent">è¿”å›é€‰æ‹©æ–‡ä»¶</button>
        </div>
      </div>
    </section>
  </main>
</body>
</html>